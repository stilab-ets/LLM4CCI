Id,OwnerName,Title,ChangedFiles,Description,Unnamed: 5,LLM,Label,Heuristic,files_diff_dict,GeminiWithoutDiff
21048,RaphaÃ«l Moll,Add unit test to SdkUiLib UpdaterData.installArchives.,"['sdkmanager/libs/sdklib/tests/com/android/sdklib/mock/MockLog.java', 'sdkmanager/libs/sdkuilib/src/Android.mk', 'sdkmanager/libs/sdkuilib/tests/com/android/sdkuilib/internal/repository/UpdaterDataTest.java', 'sdkmanager/app/tests/com/android/sdkmanager/AvdManagerTest.java', 'sdkmanager/libs/sdkuilib/.project', 'sdkmanager/libs/sdkuilib/.classpath', 'sdkmanager/libs/sdkuilib/src/com/android/sdkuilib/internal/repository/UpdaterData.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/internal/repository/Package.java', 'sdkmanager/app/tests/com/android/sdkmanager/MainTest.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/internal/repository/Archive.java', 'sdkmanager/libs/sdklib/tests/com/android/sdklib/internal/repository/MockEmptySdkManager.java']","Add unit test to SdkUiLib UpdaterData.installArchives.

This adds or changes no functionality.
It just exhibits the bug from issue 14393 which will
ne fixed in the next CL.

Change-Id: Icff2023120014b422c002efde8f20175ff52e266",https://android-review.googlesource.com/c/21048,"test
",test,Bug;Test;,"{""AvdManagerTest.java"": ""@@ -23,6 +23,7 @@ import com.android.sdklib.SdkManager;\n import com.android.sdklib.internal.avd.AvdManager;\n import com.android.sdklib.internal.project.ProjectProperties;\n import com.android.sdklib.io.FileWrapper;\n+import com.android.sdklib.mock.MockLog;\n \n import java.io.File;\n import java.util.Map;\n"", ""MainTest.java"": ""@@ -22,6 +22,7 @@ import static java.io.File.createTempFile;\n import com.android.sdklib.IAndroidTarget;\n import com.android.sdklib.SdkManager;\n import com.android.sdklib.internal.avd.AvdManager;\n+import com.android.sdklib.mock.MockLog;\n \n import java.io.File;\n \n"", ""Archive.java"": ""@@ -16,6 +16,9 @@\n \r\n package com.android.sdklib.internal.repository;\r\n \r\n+import com.android.annotations.VisibleForTesting;\r\n+import com.android.annotations.VisibleForTesting.Visibility;\r\n+\r\n import java.io.File;\r\n import java.security.MessageDigest;\r\n import java.security.NoSuchAlgorithmException;\r\n@@ -200,7 +203,8 @@ public class Archive implements IDescription, Comparable<Archive> {\n      * Creates a new local archive.\r\n      * Uses the properties from props first, if possible. Props can be null.\r\n      */\r\n-    Archive(Package pkg, Properties props, Os os, Arch arch, String localOsPath) {\r\n+    @VisibleForTesting(visibility=Visibility.PACKAGE)\r\n+    protected Archive(Package pkg, Properties props, Os os, Arch arch, String localOsPath) {\r\n         mPackage = pkg;\r\n \r\n         mOs   = props == null ? os   : Os.valueOf(  props.getProperty(PROP_OS,   os.toString()));\r\n"", ""Package.java"": ""@@ -16,6 +16,8 @@\n \r\n package com.android.sdklib.internal.repository;\r\n \r\n+import com.android.annotations.VisibleForTesting;\r\n+import com.android.annotations.VisibleForTesting.Visibility;\r\n import com.android.sdklib.AndroidVersion;\r\n import com.android.sdklib.SdkManager;\r\n import com.android.sdklib.internal.repository.Archive.Arch;\r\n@@ -150,7 +152,16 @@ public abstract class Package implements IDescription, Comparable<Package> {\n         mSource = source;\r\n \r\n         mArchives = new Archive[1];\r\n-        mArchives[0] = new Archive(this,\r\n+        mArchives[0] = createLocalArchive(props, archiveOs, archiveArch, archiveOsPath);\r\n+    }\r\n+\r\n+    @VisibleForTesting(visibility=Visibility.PRIVATE)\r\n+    protected Archive createLocalArchive(\r\n+            Properties props,\r\n+            Os archiveOs,\r\n+            Arch archiveArch,\r\n+            String archiveOsPath) {\r\n+        return new Archive(this,\r\n                 props,\r\n                 archiveOs,\r\n                 archiveArch,\r\n"", ""MockEmptySdkManager.java"": ""@@ -22,7 +22,7 @@ import com.android.sdklib.SdkManager;\n /**\r\n  * An invalid SDK Manager, just good enough to avoid passing a null reference.\r\n  */\r\n-class MockEmptySdkManager extends SdkManager {\r\n+public class MockEmptySdkManager extends SdkManager {\r\n     public MockEmptySdkManager(String osSdkPath) {\r\n         super(osSdkPath);\r\n         setTargets(new IAndroidTarget[0]);\r\n"", ""MockLog.java"": ""@@ -14,13 +14,18 @@\n  * limitations under the License.\n  */\n \n-package com.android.sdkmanager;\n+package com.android.sdklib.mock;\n \n import com.android.sdklib.ISdkLog;\n \n import java.util.ArrayList;\n import java.util.Formatter;\n \n+/**\n+ * An instance of {@link ISdkLog} that captures all messages to an internal list.\n+ * Messages can be retrieved later using {@link #toString()}.\n+ * Useful for unit-tests.\n+ */\n public class MockLog implements ISdkLog {\n     private ArrayList<String> mMessages = new ArrayList<String>();\n \n"", "".classpath"": ""@@ -1,11 +1,12 @@\n-<?xml version=\""1.0\"" encoding=\""UTF-8\""?>\r\n-<classpath>\r\n-\t<classpathentry kind=\""src\"" path=\""src\""/>\r\n-\t<classpathentry kind=\""src\"" path=\""tests\""/>\r\n-\t<classpathentry kind=\""con\"" path=\""org.eclipse.jdt.launching.JRE_CONTAINER\""/>\r\n-\t<classpathentry exported=\""true\"" kind=\""con\"" path=\""org.eclipse.jdt.USER_LIBRARY/ANDROID_SWT\""/>\r\n-\t<classpathentry combineaccessrules=\""false\"" kind=\""src\"" path=\""/SdkLib\""/>\r\n-\t<classpathentry combineaccessrules=\""false\"" kind=\""src\"" path=\""/AndroidPrefs\""/>\r\n-\t<classpathentry kind=\""con\"" path=\""org.eclipse.jdt.junit.JUNIT_CONTAINER/3\""/>\r\n-\t<classpathentry kind=\""output\"" path=\""bin\""/>\r\n-</classpath>\r\n+<?xml version=\""1.0\"" encoding=\""UTF-8\""?>\n+<classpath>\n+\t<classpathentry kind=\""src\"" path=\""src\""/>\n+\t<classpathentry kind=\""src\"" path=\""tests\""/>\n+\t<classpathentry kind=\""con\"" path=\""org.eclipse.jdt.launching.JRE_CONTAINER\""/>\n+\t<classpathentry exported=\""true\"" kind=\""con\"" path=\""org.eclipse.jdt.USER_LIBRARY/ANDROID_SWT\""/>\n+\t<classpathentry combineaccessrules=\""false\"" kind=\""src\"" path=\""/SdkLib\""/>\n+\t<classpathentry combineaccessrules=\""false\"" kind=\""src\"" path=\""/AndroidPrefs\""/>\n+\t<classpathentry kind=\""con\"" path=\""org.eclipse.jdt.junit.JUNIT_CONTAINER/3\""/>\n+\t<classpathentry combineaccessrules=\""false\"" kind=\""src\"" path=\""/common\""/>\n+\t<classpathentry kind=\""output\"" path=\""bin\""/>\n+</classpath>\n"", "".project"": ""@@ -1,17 +1,18 @@\n-<?xml version=\""1.0\"" encoding=\""UTF-8\""?>\n-<projectDescription>\n-\t<name>SdkUiLib</name>\n-\t<comment></comment>\n-\t<projects>\n-\t</projects>\n-\t<buildSpec>\n-\t\t<buildCommand>\n-\t\t\t<name>org.eclipse.jdt.core.javabuilder</name>\n-\t\t\t<arguments>\n-\t\t\t</arguments>\n-\t\t</buildCommand>\n-\t</buildSpec>\n-\t<natures>\n-\t\t<nature>org.eclipse.jdt.core.javanature</nature>\n-\t</natures>\n-</projectDescription>\n+<?xml version=\""1.0\"" encoding=\""UTF-8\""?>\r\n+<projectDescription>\r\n+\t<name>SdkUiLib</name>\r\n+\t<comment></comment>\r\n+\t<projects>\r\n+\t\t<project>common</project>\r\n+\t</projects>\r\n+\t<buildSpec>\r\n+\t\t<buildCommand>\r\n+\t\t\t<name>org.eclipse.jdt.core.javabuilder</name>\r\n+\t\t\t<arguments>\r\n+\t\t\t</arguments>\r\n+\t\t</buildCommand>\r\n+\t</buildSpec>\r\n+\t<natures>\r\n+\t\t<nature>org.eclipse.jdt.core.javanature</nature>\r\n+\t</natures>\r\n+</projectDescription>\r\n"", ""Android.mk"": ""@@ -8,6 +8,7 @@ LOCAL_JAVA_RESOURCE_DIRS := .\n \n LOCAL_JAVA_LIBRARIES := \\\n \tsdklib \\\n+\tcommon \\\n \tandroidprefs \\\n \tswt \\\n \torg.eclipse.jface_3.4.2.M20090107-0800 \\\n"", ""UpdaterData.java"": ""@@ -16,6 +16,8 @@\n \r\n package com.android.sdkuilib.internal.repository;\r\n \r\n+import com.android.annotations.VisibleForTesting;\r\n+import com.android.annotations.VisibleForTesting.Visibility;\r\n import com.android.prefs.AndroidLocation.AndroidLocationException;\r\n import com.android.sdklib.ISdkLog;\r\n import com.android.sdklib.SdkConstants;\r\n@@ -226,8 +228,9 @@ class UpdaterData implements IUpdaterData {\n     /**\r\n      * Initializes the {@link SdkManager} and the {@link AvdManager}.\r\n      */\r\n-    private void initSdk() {\r\n-        mSdkManager = SdkManager.createManager(mOsSdkRoot, mSdkLog);\r\n+    @VisibleForTesting(visibility=Visibility.PRIVATE)\r\n+    protected void initSdk() {\r\n+        setSdkManager(SdkManager.createManager(mOsSdkRoot, mSdkLog));\r\n         try {\r\n             mAvdManager = null; // remove the old one if needed.\r\n             mAvdManager = new AvdManager(mSdkManager, mSdkLog);\r\n@@ -247,6 +250,11 @@ class UpdaterData implements IUpdaterData {\n         broadcastOnSdkReload();\r\n     }\r\n \r\n+    @VisibleForTesting(visibility=Visibility.PRIVATE)\r\n+    protected void setSdkManager(SdkManager sdkManager) {\r\n+        mSdkManager = sdkManager;\r\n+    }\r\n+\r\n     /**\r\n      * Reloads the SDK content (targets).\r\n      * <p/>\r\n@@ -372,9 +380,10 @@ class UpdaterData implements IUpdaterData {\n      * Install the list of given {@link Archive}s. This is invoked by the user selecting some\r\n      * packages in the remote page and then clicking \""install selected\"".\r\n      *\r\n-     * @param result The archives to install. Incompatible ones will be skipped.\r\n+     * @param archives The archives to install. Incompatible ones will be skipped.\r\n      */\r\n-    public void installArchives(final Collection<ArchiveInfo> result) {\r\n+    @VisibleForTesting(visibility=Visibility.PRIVATE)\r\n+    protected void installArchives(final Collection<ArchiveInfo> archives) {\r\n         if (mTaskFactory == null) {\r\n             throw new IllegalArgumentException(\""Task Factory is null\"");\r\n         }\r\n@@ -385,7 +394,7 @@ class UpdaterData implements IUpdaterData {\n             public void run(ITaskMonitor monitor) {\r\n \r\n                 final int progressPerArchive = 2 * ArchiveInstaller.NUM_MONITOR_INC;\r\n-                monitor.setProgressMax(result.size() * progressPerArchive);\r\n+                monitor.setProgressMax(archives.size() * progressPerArchive);\r\n                 monitor.setDescription(\""Preparing to install archives\"");\r\n \r\n                 boolean installedAddon = false;\r\n@@ -402,7 +411,7 @@ class UpdaterData implements IUpdaterData {\n                 }\r\n \r\n                 int numInstalled = 0;\r\n-                nextArchive: for (ArchiveInfo ai : result) {\r\n+                nextArchive: for (ArchiveInfo ai : archives) {\r\n                     Archive archive = ai.getNewArchive();\r\n                     if (archive == null) {\r\n                         // This is not supposed to happen.\r\n@@ -443,7 +452,7 @@ class UpdaterData implements IUpdaterData {\n                             broadcastPreInstallHook();\r\n                         }\r\n \r\n-                        ArchiveInstaller installer = new ArchiveInstaller();\r\n+                        ArchiveInstaller installer = createArchiveInstaler();\r\n                         if (installer.install(archive,\r\n                                               mOsSdkRoot,\r\n                                               forceHttp,\r\n@@ -978,4 +987,13 @@ class UpdaterData implements IUpdaterData {\n         }\r\n     }\r\n \r\n+    /**\r\n+     * Internal helper to return a new {@link ArchiveInstaller}.\r\n+     * This allows us to override the installer for unit-testing.\r\n+     */\r\n+    @VisibleForTesting(visibility=Visibility.PRIVATE)\r\n+    protected ArchiveInstaller createArchiveInstaler() {\r\n+        return new ArchiveInstaller();\r\n+    }\r\n+\r\n }\r\n"", ""UpdaterDataTest.java"": ""@@ -0,0 +1,256 @@\n+/*\n+ * Copyright (C) 2011 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.android.sdkuilib.internal.repository;\n+\n+import com.android.sdklib.SdkManager;\n+import com.android.sdklib.internal.repository.Archive;\n+import com.android.sdklib.internal.repository.ArchiveInstaller;\n+import com.android.sdklib.internal.repository.ITask;\n+import com.android.sdklib.internal.repository.ITaskFactory;\n+import com.android.sdklib.internal.repository.ITaskMonitor;\n+import com.android.sdklib.internal.repository.MockEmptySdkManager;\n+import com.android.sdklib.internal.repository.Package;\n+import com.android.sdklib.internal.repository.SdkSource;\n+import com.android.sdklib.internal.repository.Archive.Arch;\n+import com.android.sdklib.internal.repository.Archive.Os;\n+import com.android.sdklib.mock.MockLog;\n+\n+import java.io.File;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Properties;\n+\n+import junit.framework.TestCase;\n+\n+public class UpdaterDataTest extends TestCase {\n+\n+    private MockUpdaterData m;\n+\n+    @Override\n+    protected void setUp() throws Exception {\n+        super.setUp();\n+        m = new MockUpdaterData();\n+        assertEquals(\""[]\"", Arrays.toString(m.getInstalled()));\n+    }\n+\n+    @Override\n+    protected void tearDown() throws Exception {\n+        super.tearDown();\n+    }\n+\n+    /**\n+     * Tests the case where we have nothing to install.\n+     */\n+    public void testInstallArchives_None() {\n+        m._installArchives(new ArrayList<ArchiveInfo>());\n+        assertEquals(\""[]\"", Arrays.toString(m.getInstalled()));\n+    }\n+\n+\n+    /**\n+     * Tests the case where there's a simple dependency, in the right order\n+     * (e.g. install A1 then A2 that depends on A1).\n+     */\n+    public void testInstallArchives_SimpleDependency() {\n+\n+        ArrayList<ArchiveInfo> archives = new ArrayList<ArchiveInfo>();\n+\n+        Archive a1 = new MockEmptyPackage(\""a1\"").getLocalArchive();\n+        ArchiveInfo ai1 = new ArchiveInfo(a1, null, null);\n+\n+        Archive a2 = new MockEmptyPackage(\""a2\"").getLocalArchive();\n+        ArchiveInfo ai2 = new ArchiveInfo(a2, null, new ArchiveInfo[] { ai1 } );\n+\n+        archives.add(ai1);\n+        archives.add(ai2);\n+\n+        m._installArchives(archives);\n+        assertEquals(\""[a1, a2]\"", Arrays.toString(m.getInstalled()));\n+    }\n+\n+    /**\n+     * Tests the case where there's a simple dependency, in the wrong order\n+     * (e.g. install A2 then A1 which A2 depends on)\n+     */\n+    public void testInstallArchives_ReverseDependency() {\n+\n+        ArrayList<ArchiveInfo> archives = new ArrayList<ArchiveInfo>();\n+\n+        Archive a1 = new MockEmptyPackage(\""a1\"").getLocalArchive();\n+        ArchiveInfo ai1 = new ArchiveInfo(a1, null, null);\n+\n+        Archive a2 = new MockEmptyPackage(\""a2\"").getLocalArchive();\n+        ArchiveInfo ai2 = new ArchiveInfo(a2, null, new ArchiveInfo[] { ai1 } );\n+\n+        archives.add(ai2);\n+        archives.add(ai1);\n+\n+        m._installArchives(archives);\n+        // TODO fix bug 14393: a2 is not installed because a1 has not been installed yet.\n+        assertEquals(\""[a1]\"", Arrays.toString(m.getInstalled()));\n+    }\n+\n+    // ---\n+\n+\n+    /** A mock UpdaterData that simply records what would have been installed. */\n+    private static class MockUpdaterData extends UpdaterData {\n+\n+        private final List<Archive> mInstalled = new ArrayList<Archive>();\n+\n+        public MockUpdaterData() {\n+            super(\""/tmp/SDK\"", new MockLog());\n+\n+            setTaskFactory(new MockTaskFactory());\n+        }\n+\n+        /** Gives access to the internal {@link #installArchives(Collection)}. */\n+        public void _installArchives(Collection<ArchiveInfo> result) {\n+            installArchives(result);\n+        }\n+\n+        public Archive[] getInstalled() {\n+            return mInstalled.toArray(new Archive[mInstalled.size()]);\n+        }\n+\n+        @Override\n+        protected void initSdk() {\n+            setSdkManager(new MockEmptySdkManager(\""/tmp/SDK\""));\n+        }\n+\n+        @Override\n+        public void reloadSdk() {\n+            // bypass original implementation\n+        }\n+\n+        /** Returns a mock installer that simply records what would have been installed. */\n+        @Override\n+        protected ArchiveInstaller createArchiveInstaler() {\n+            return new ArchiveInstaller() {\n+                @Override\n+                public boolean install(\n+                        Archive archive,\n+                        String osSdkRoot,\n+                        boolean forceHttp,\n+                        SdkManager sdkManager,\n+                        ITaskMonitor monitor) {\n+                    mInstalled.add(archive);\n+                    return true;\n+                }\n+            };\n+        }\n+    }\n+\n+    private static class MockTaskFactory implements ITaskFactory {\n+        public void start(String title, ITask task) {\n+            new MockTask(task);\n+        }\n+    }\n+\n+    private static class MockTask implements ITaskMonitor {\n+        public MockTask(ITask task) {\n+            task.run(this);\n+        }\n+\n+        public ITaskMonitor createSubMonitor(int tickCount) {\n+            return this;\n+        }\n+\n+        public boolean displayPrompt(String title, String message) {\n+            return false;\n+        }\n+\n+        public int getProgress() {\n+            return 0;\n+        }\n+\n+        public void incProgress(int delta) {\n+            // ignore\n+        }\n+\n+        public boolean isCancelRequested() {\n+            return false;\n+        }\n+\n+        public void setDescription(String descriptionFormat, Object... args) {\n+            // ignore\n+        }\n+\n+        public void setProgressMax(int max) {\n+            // ignore\n+        }\n+\n+        public void setResult(String resultFormat, Object... args) {\n+            // ignore\n+        }\n+    }\n+\n+    private static class MockEmptyPackage extends Package {\n+        private final String mTestHandle;\n+\n+        public MockEmptyPackage(String testHandle) {\n+            super(\n+                null /*source*/,\n+                null /*props*/,\n+                0 /*revision*/,\n+                null /*license*/,\n+                null /*description*/,\n+                null /*descUrl*/,\n+                Os.ANY /*archiveOs*/,\n+                Arch.ANY /*archiveArch*/,\n+                null /*archiveOsPath*/\n+                );\n+            mTestHandle = testHandle;\n+        }\n+\n+        @Override\n+        protected Archive createLocalArchive(\n+                Properties props,\n+                Os archiveOs,\n+                Arch archiveArch,\n+                String archiveOsPath) {\n+            return new Archive(this, props, archiveOs, archiveArch, archiveOsPath) {\n+                @Override\n+                public String toString() {\n+                    return mTestHandle;\n+                }\n+            };\n+        }\n+\n+        public Archive getLocalArchive() {\n+            return getArchives()[0];\n+        }\n+\n+        @Override\n+        public File getInstallFolder(String osSdkRoot, SdkManager sdkManager) {\n+            return null;\n+        }\n+\n+        @Override\n+        public String getShortDescription() {\n+            return this.getClass().getSimpleName();\n+        }\n+\n+        @Override\n+        public boolean sameItemAs(Package pkg) {\n+            return false;\n+        }\n+\n+    }\n+}\n""}","test 
"
22345,David Turner,ndk: Add missing update arm C library for android-9 platform.,['ndk/platforms/android-9/arch-arm/lib/libc.so'],"ndk: Add missing update arm C library for android-9 platform.

The C library was updated in Gingerbread to support. The corresponding
headers were updated, but the change was missing an updated library,
used for proper linking of new functions (e.g. pthread_rwlock_init).

Fix for http://code.google.com/p/android/issues/detail?id=12990

Change-Id: Ic30921582f143adfc4bcfe3f70a6293530fe0202",https://android-review.googlesource.com/c/22345,"bug, resource 
",bug;resource,Bug;Resource;,"{""libc.so"": ""Binary files /dev/null and b/ndk/platforms/android-9/arch-arm/lib/libc.so differ\n""}","bug, refactor 
"
21527,Brian Muramatsu,Suppress VideoVideoTest#testOnKeyDown,['tests/expectations/knownfailures.txt'],"Suppress VideoVideoTest#testOnKeyDown

Bug 3486016

The test fails when it is run with testGetDuration. Even though the test
tears down the activity there seems to be some state within VideoView
that causes testOnKeyDown to fail. Update the expectations for now
and rename the expectations file.

Change-Id: Ifce6e83813d3f3abdb555e88a8361af7d6225e7a",https://android-review.googlesource.com/c/21527,"bug, test 
",test;bug,Bug;Resource;Test;,"{""knownfailures.txt"": ""@@ -6,6 +6,11 @@\n { name: \""android.webkit.cts.WebSettingsTest#testSetAppCacheEnabled\"" },\n { name: \""android.net.cts.SSLCertificateSocketFactoryTest\"" },\n \n+{\n+  description: \""testGetDuration causes testOnKeyDown to fail for some reason\"",\n+  name: \""android.widget.cts.VideoViewTest#testOnKeyDown\""\n+},\n+\n /* These tests pass when executed individually but fail when running CTS as a whole on GRH78. */\n {\n   name: \""org.apache.harmony.luni.tests.internal.net.www.protocol.https.HttpsURLConnectionTest#testProxyConnection\"",\n""}","test 
"
14746,Christian Mehlmauer,"Removed some Warnings, Added Type arguments","['src/com/android/calendar/CalendarView.java', 'src/com/android/calendar/IcsImportActivity.java', 'src/com/android/calendar/AlertReceiver.java', 'src/com/android/calendar/CalendarApplication.java', 'src/com/android/calendar/MonthActivity.java', 'src/com/android/calendar/AlertActivity.java', 'src/com/android/calendar/Event.java', 'src/com/android/calendar/EditEvent.java', 'src/com/android/calendar/GoogleCalendarUriIntentFilter.java', 'src/com/android/calendar/EventInfoActivity.java', 'src/com/android/calendar/AgendaByDayAdapter.java', 'src/com/android/calendar/LaunchActivity.java', 'src/com/android/calendar/MonthView.java']","Removed some Warnings, Added Type arguments, replaced finally block by simple return statement

Change-Id: Ie52eecf14773768c97e23ae7f96a80df1d067ade",https://android-review.googlesource.com/c/14746,"refactor
","bug,refactor",Deprecat;,"{""AgendaByDayAdapter.java"": ""@@ -189,7 +189,6 @@ public class AgendaByDayAdapter extends BaseAdapter {\n         mTodayJulianDay = Time.getJulianDay(now, time.gmtoff);\n         LinkedList<MultipleDayInfo> multipleDayList = new LinkedList<MultipleDayInfo>();\n         for (int position = 0; cursor.moveToNext(); position++) {\n-            boolean allDay = cursor.getInt(AgendaWindowAdapter.INDEX_ALL_DAY) != 0;\n             int startDay = cursor.getInt(AgendaWindowAdapter.INDEX_START_DAY);\n \n             // Skip over the days outside of the adapter's range\n"", ""AlertActivity.java"": ""@@ -179,7 +179,7 @@ public class AlertActivity extends Activity {\n \n     private OnItemClickListener mViewListener = new OnItemClickListener() {\n \n-        public void onItemClick(AdapterView parent, View view, int position,\n+        public void onItemClick(AdapterView<?> parent, View view, int position,\n                 long i) {\n             AlertActivity alertActivity = AlertActivity.this;\n             Cursor cursor = alertActivity.getItemForView(view);\n"", ""AlertReceiver.java"": ""@@ -22,7 +22,6 @@ import android.app.PendingIntent;\n import android.app.Service;\n import android.content.BroadcastReceiver;\n import android.content.ContentResolver;\n-import android.content.ContentValues;\n import android.content.Context;\n import android.content.Intent;\n import android.content.SharedPreferences;\n"", ""CalendarApplication.java"": ""@@ -18,7 +18,6 @@ package com.android.calendar;\n \n import android.app.Application;\n import android.preference.PreferenceManager;\n-import android.util.Log;\n \n public class CalendarApplication extends Application {\n \n"", ""CalendarView.java"": ""@@ -2341,7 +2341,6 @@ public class CalendarView extends View\n     void doSingleTapUp(MotionEvent ev) {\n         int x = (int) ev.getX();\n         int y = (int) ev.getY();\n-        Event selectedEvent = mSelectedEvent;\n         int selectedDay = mSelectionDay;\n         int selectedHour = mSelectionHour;\n \n"", ""EditEvent.java"": ""@@ -581,13 +581,8 @@ public class EditEvent extends Activity implements View.OnClickListener,\n                 Log.w(TAG, \""Ignoring unexpected exception\"", e);\n             } catch (AuthenticatorException e) {\n                 Log.w(TAG, \""Ignoring unexpected exception\"", e);\n-            } finally {\n-                if (primaryCalendarPosition != -1) {\n-                    return primaryCalendarPosition;\n-                } else {\n-                    return 0;\n-                }\n             }\n+            return (primaryCalendarPosition >= 0) ? primaryCalendarPosition : 0;\n         }\n     }\n \n"", ""Event.java"": ""@@ -35,7 +35,7 @@ import java.util.Iterator;\n import java.util.concurrent.atomic.AtomicInteger;\n \n // TODO: should Event be Parcelable so it can be passed via Intents?\n-public class Event implements Comparable, Cloneable {\n+public class Event implements Comparable<Event>, Cloneable {\n \n     private static final boolean PROFILE = false;\n \n@@ -117,8 +117,6 @@ public class Event implements Comparable, Cloneable {\n     public Event nextUp;\n     public Event nextDown;\n \n-    private static final int MIDNIGHT_IN_MINUTES = 24 * 60;\n-\n     @Override\n     public final Object clone() throws CloneNotSupportedException {\n         super.clone();\n@@ -187,32 +185,30 @@ public class Event implements Comparable, Cloneable {\n      * Compares this event to the given event.  This is just used for checking\n      * if two events differ.  It's not used for sorting anymore.\n      */\n-    public final int compareTo(Object obj) {\n-        Event e = (Event) obj;\n-\n+    public final int compareTo(Event obj) {\n         // The earlier start day and time comes first\n-        if (startDay < e.startDay) return -1;\n-        if (startDay > e.startDay) return 1;\n-        if (startTime < e.startTime) return -1;\n-        if (startTime > e.startTime) return 1;\n+        if (startDay < obj.startDay) return -1;\n+        if (startDay > obj.startDay) return 1;\n+        if (startTime < obj.startTime) return -1;\n+        if (startTime > obj.startTime) return 1;\n \n         // The later end time comes first (in order to put long strips on\n         // the left).\n-        if (endDay < e.endDay) return 1;\n-        if (endDay > e.endDay) return -1;\n-        if (endTime < e.endTime) return 1;\n-        if (endTime > e.endTime) return -1;\n+        if (endDay < obj.endDay) return 1;\n+        if (endDay > obj.endDay) return -1;\n+        if (endTime < obj.endTime) return 1;\n+        if (endTime > obj.endTime) return -1;\n \n         // Sort all-day events before normal events.\n-        if (allDay && !e.allDay) return -1;\n-        if (!allDay && e.allDay) return 1;\n+        if (allDay && !obj.allDay) return -1;\n+        if (!allDay && obj.allDay) return 1;\n \n-        if (guestsCanModify && !e.guestsCanModify) return -1;\n-        if (!guestsCanModify && e.guestsCanModify) return 1;\n+        if (guestsCanModify && !obj.guestsCanModify) return -1;\n+        if (!guestsCanModify && obj.guestsCanModify) return 1;\n \n         // If two events have the same time range, then sort them in\n         // alphabetical order based on their titles.\n-        int cmp = compareStrings(title, e.title);\n+        int cmp = compareStrings(title, obj.title);\n         if (cmp != 0) {\n             return cmp;\n         }\n@@ -220,12 +216,12 @@ public class Event implements Comparable, Cloneable {\n         // If the titles are the same then compare the other fields\n         // so that we can use this function to check for differences\n         // between events.\n-        cmp = compareStrings(location, e.location);\n+        cmp = compareStrings(location, obj.location);\n         if (cmp != 0) {\n             return cmp;\n         }\n \n-        cmp = compareStrings(organizer, e.organizer);\n+        cmp = compareStrings(organizer, obj.organizer);\n         if (cmp != 0) {\n             return cmp;\n         }\n"", ""EventInfoActivity.java"": ""@@ -901,7 +901,6 @@ public class EventInfoActivity extends Activity implements View.OnClickListener,\n             return;\n         }\n \n-        ContentResolver cr = getContentResolver();\n         // Yes/No/Maybe Title\n         View titleView = mLayoutInflater.inflate(R.layout.contact_item, null);\n         titleView.findViewById(R.id.badge).setVisibility(View.GONE);\n@@ -958,11 +957,9 @@ public class EventInfoActivity extends Activity implements View.OnClickListener,\n \n     private class PresenceQueryHandler extends AsyncQueryHandler {\n         Context mContext;\n-        ContentResolver mContentResolver;\n \n         public PresenceQueryHandler(Context context, ContentResolver cr) {\n             super(cr);\n-            mContentResolver = cr;\n             mContext = context;\n         }\n \n"", ""GoogleCalendarUriIntentFilter.java"": ""@@ -27,7 +27,6 @@ import static android.provider.Calendar.AttendeesColumns.ATTENDEE_STATUS_TENTATI\n \n import android.app.Activity;\n import android.content.ActivityNotFoundException;\n-import android.content.ContentResolver;\n import android.content.ContentUris;\n import android.content.Intent;\n import android.database.Cursor;\n@@ -56,7 +55,6 @@ public class GoogleCalendarUriIntentFilter extends Activity {\n             if (uri != null) {\n                 String eid = uri.getQueryParameter(\""eid\"");\n                 if (eid != null) {\n-                    ContentResolver cr = getContentResolver();\n                     String selection = Events.HTML_URI + \"" LIKE \\\""%eid=\"" + eid + \""%\\\""\"";\n \n                     Cursor eventCursor = managedQuery(Events.CONTENT_URI, EVENT_PROJECTION,\n"", ""IcsImportActivity.java"": ""@@ -30,7 +30,6 @@ import android.util.Log;\n import android.view.View;\n import android.widget.ArrayAdapter;\n import android.widget.Button;\n-import android.widget.ImageView;\n import android.widget.Spinner;\n import android.widget.TextView;\n \n"", ""LaunchActivity.java"": ""@@ -32,7 +32,6 @@ import android.os.Bundle;\n import android.preference.PreferenceManager;\n import android.provider.Calendar.Calendars;\n import android.provider.Gmail;\n-import android.util.Log;\n \n import com.google.android.googlelogin.GoogleLoginServiceConstants;\n \n"", ""MonthActivity.java"": ""@@ -32,7 +32,6 @@ import android.preference.PreferenceManager;\n import android.provider.Calendar.Events;\n import android.text.format.DateUtils;\n import android.text.format.Time;\n-import android.view.KeyEvent;\n import android.view.Menu;\n import android.view.MenuItem;\n import android.view.View;\n"", ""MonthView.java"": ""@@ -706,8 +706,6 @@ public class MonthView extends View implements View.OnCreateContextMenuListener\n \n         // Draw the cell contents (excluding monthDay number)\n         if (!withinCurrentMonth) {\n-            boolean firstDayOfNextmonth = isFirstDayOfNextMonth(row, column);\n-\n             // Adjust cell boundaries to compensate for the different border\n             // style.\n             r.top--;\n""}","refactor 
"
22313,Amit Feller,adding error handling for Xerrors on EGl linux implementation (EglLinuxApi.cpp),"['tools/emulator/opengl/host/libs/Translator/EGL/EglImp.cpp', 'tools/emulator/opengl/host/libs/Translator/EGL/EglLinuxApi.cpp', 'tools/emulator/opengl/host/libs/Translator/EGL/EglOsApi.h']","adding error handling for Xerrors on EGl linux implementation (EglLinuxApi.cpp)

Change-Id: Ib8535e2c25c7de67c8d7830a644643b52742ceaa",https://android-review.googlesource.com/c/22313,"bug
",bug,Feature;,"{""EglImp.cpp"": ""@@ -420,7 +420,7 @@ EGLAPI EGLSurface EGLAPIENTRY eglCreateWindowSurface(EGLDisplay display, EGLConf\n     if(!(cfg->surfaceType() & EGL_WINDOW_BIT)) {\n         RETURN_ERROR(EGL_NO_SURFACE,EGL_BAD_MATCH);\n     }\n-    if(!EglOS::validNativeWin(win)) {\n+    if(!EglOS::validNativeWin(dpy->nativeType(),win)) {\n         RETURN_ERROR(EGL_NO_SURFACE,EGL_BAD_NATIVE_WINDOW);\n     }\n     if(!EglValidate::noAttribs(attrib_list)) {\n@@ -671,19 +671,22 @@ EGLAPI EGLBoolean EGLAPIENTRY eglMakeCurrent(EGLDisplay display, EGLSurface draw\n             RETURN_ERROR(EGL_FALSE,EGL_BAD_MATCH);\n         }\n \n+         EGLNativeDisplayType nativeDisplay = dpy->nativeType();\n+         void* nativeRead = newReadPtr->native();\n+         void* nativeDraw = newDrawPtr->native();\n         //checking native window validity\n-        if(newReadPtr->type() == EglSurface::WINDOW && !EglOS::validNativeWin(reinterpret_cast<EGLNativeWindowType>(newReadPtr->native()))) {\n+        if(newReadPtr->type() == EglSurface::WINDOW && !EglOS::validNativeWin(nativeDisplay,reinterpret_cast<EGLNativeWindowType>(nativeRead))) {\n             RETURN_ERROR(EGL_FALSE,EGL_BAD_NATIVE_WINDOW);\n         }\n-        if(newDrawPtr->type() == EglSurface::WINDOW && !EglOS::validNativeWin(reinterpret_cast<EGLNativeWindowType>(newDrawPtr->native()))) {\n+        if(newDrawPtr->type() == EglSurface::WINDOW && !EglOS::validNativeWin(nativeDisplay,reinterpret_cast<EGLNativeWindowType>(nativeDraw))) {\n             RETURN_ERROR(EGL_FALSE,EGL_BAD_NATIVE_WINDOW);\n         }\n \n         //checking native pixmap validity\n-        if(newReadPtr->type() == EglSurface::PIXMAP && !EglOS::validNativePixmap(reinterpret_cast<EGLNativePixmapType>(newReadPtr->native()))) {\n+        if(newReadPtr->type() == EglSurface::PIXMAP && !EglOS::validNativePixmap(nativeDisplay,reinterpret_cast<EGLNativePixmapType>(nativeRead))) {\n             RETURN_ERROR(EGL_FALSE,EGL_BAD_NATIVE_PIXMAP);\n         }\n-        if(newDrawPtr->type() == EglSurface::PIXMAP && !EglOS::validNativePixmap(reinterpret_cast<EGLNativePixmapType>(newDrawPtr->native()))) {\n+        if(newDrawPtr->type() == EglSurface::PIXMAP && !EglOS::validNativePixmap(nativeDisplay,reinterpret_cast<EGLNativePixmapType>(nativeDraw))) {\n             RETURN_ERROR(EGL_FALSE,EGL_BAD_NATIVE_PIXMAP);\n         }\n         if(prevCtx) {\n@@ -817,27 +820,29 @@ EGLAPI EGLBoolean EGLAPIENTRY eglWaitNative(EGLint engine) {\n     }\n     ThreadInfo* thread  = getThreadInfo();\n     EglContext* currCtx = static_cast<EglContext*>(thread->eglContext);\n+    EglDisplay* dpy     = static_cast<EglDisplay*>(thread->eglDisplay);\n     if(currCtx) {\n-        EglSurface* read = currCtx->read().Ptr();\n-        EglSurface* draw = currCtx->read().Ptr();\n+        SurfacePtr read = currCtx->read();\n+        SurfacePtr draw = currCtx->draw();\n \n+        EGLNativeDisplayType nativeDisplay = dpy->nativeType();\n         if(read) {\n             if(read->type() == EglSurface::WINDOW &&\n-               !EglOS::validNativeWin(reinterpret_cast<EGLNativeWindowType>(read->native()))) {\n+               !EglOS::validNativeWin(nativeDisplay,reinterpret_cast<EGLNativeWindowType>(read->native()))) {\n                 RETURN_ERROR(EGL_FALSE,EGL_BAD_SURFACE);\n             }\n             if(read->type() == EglSurface::PIXMAP &&\n-               !EglOS::validNativePixmap(reinterpret_cast<EGLNativePixmapType>(read->native()))) {\n+               !EglOS::validNativePixmap(nativeDisplay,reinterpret_cast<EGLNativePixmapType>(read->native()))) {\n                 RETURN_ERROR(EGL_FALSE,EGL_BAD_SURFACE);\n             }\n         }\n         if(draw) {\n             if(draw->type() == EglSurface::WINDOW &&\n-               !EglOS::validNativeWin(reinterpret_cast<EGLNativeWindowType>(draw->native()))) {\n+               !EglOS::validNativeWin(nativeDisplay,reinterpret_cast<EGLNativeWindowType>(draw->native()))) {\n                 RETURN_ERROR(EGL_FALSE,EGL_BAD_SURFACE);\n             }\n             if(draw->type() == EglSurface::PIXMAP &&\n-               !EglOS::validNativePixmap(reinterpret_cast<EGLNativePixmapType>(draw->native()))) {\n+               !EglOS::validNativePixmap(nativeDisplay,reinterpret_cast<EGLNativePixmapType>(draw->native()))) {\n                 RETURN_ERROR(EGL_FALSE,EGL_BAD_SURFACE);\n             }\n         }\n@@ -911,7 +916,7 @@ EGLAPI EGLBoolean EGLAPIENTRY eglCopyBuffers(EGLDisplay display, EGLSurface surf\n               EGLNativePixmapType target) {\n     VALIDATE_DISPLAY(display);\n     VALIDATE_SURFACE(surface,srfc);\n-    if(!EglOS::validNativePixmap(target)) {\n+    if(!EglOS::validNativePixmap(dpy->nativeType(),target)) {\n         RETURN_ERROR(EGL_FALSE,EGL_BAD_NATIVE_PIXMAP);\n     }\n \n"", ""EglLinuxApi.cpp"": ""@@ -15,9 +15,48 @@\n */\n #include \""EglOsApi.h\""\n #include <string.h>\n+#include <X11/Xlib.h>\n #include <GL/glx.h>\n+#include <utils/threads.h>\n \n \n+class ErrorHandler{\n+public:\n+ErrorHandler(EGLNativeDisplayType dpy);\n+~ErrorHandler();\n+int getLastError(){ return s_lastErrorCode;};\n+\n+private:\n+static int s_lastErrorCode;\n+int (*m_oldErrorHandler) (Display *, XErrorEvent *);\n+static android::Mutex s_lock;\n+static int errorHandlerProc(EGLNativeDisplayType dpy,XErrorEvent* event);\n+\n+};\n+\n+\n+int ErrorHandler::s_lastErrorCode = 0;\n+android::Mutex ErrorHandler::s_lock;\n+\n+ErrorHandler::ErrorHandler(EGLNativeDisplayType dpy){\n+   s_lock.lock();\n+   XSync(dpy,False);\n+   s_lastErrorCode = 0;\n+   m_oldErrorHandler = XSetErrorHandler(errorHandlerProc);\n+}\n+\n+ErrorHandler::~ErrorHandler(){\n+   XSetErrorHandler(m_oldErrorHandler);\n+   s_lastErrorCode = 0;\n+   s_lock.unlock();\n+}\n+\n+int ErrorHandler::errorHandlerProc(EGLNativeDisplayType dpy,XErrorEvent* event){\n+    android::Mutex::Autolock mutex(s_lock);\n+    s_lastErrorCode = event->error_code;\n+    return 0;\n+}\n+\n #define IS_SUCCESS(a) \\\n         if(a != Success) return false;\n \n@@ -109,14 +148,22 @@ void queryConfigs(EGLNativeDisplayType dpy,ConfigsList& listOut) {\n     XFree(frmtList);\n }\n \n-bool validNativeWin(EGLNativeWindowType win) {\n-  //TODO: use XGetgeometry to check validity\n-   return true;\n+bool validNativeWin(EGLNativeDisplayType dpy,EGLNativeWindowType win) {\n+   Window root;\n+   int tmp;\n+   unsigned int utmp;\n+   ErrorHandler handler(dpy);\n+   if(!XGetGeometry(dpy,win,&root,&tmp,&tmp,&utmp,&utmp,&utmp,&utmp)) return false;\n+   return handler.getLastError() == 0;\n }\n \n-bool validNativePixmap(EGLNativePixmapType pix) {\n-  //TODO: use XGetgeometry to check validity\n-   return true;\n+bool validNativePixmap(EGLNativeDisplayType dpy,EGLNativePixmapType pix) {\n+   Window root;\n+   int tmp;\n+   unsigned int utmp;\n+   ErrorHandler handler(dpy);\n+   if(!XGetGeometry(dpy,pix,&root,&tmp,&tmp,&utmp,&utmp,&utmp,&utmp)) return false;\n+   return handler.getLastError() == 0;\n }\n \n bool checkWindowPixelFormatMatch(EGLNativeDisplayType dpy,EGLNativeWindowType win,EglConfig* cfg,unsigned int* width,unsigned int* height) {\n@@ -164,7 +211,9 @@ bool releasePbuffer(EGLNativeDisplayType dis,EGLNativePbufferType pb) {\n }\n \n EGLNativeContextType createContext(EGLNativeDisplayType dpy,EglConfig* cfg,EGLNativeContextType sharedContext) {\n- return glXCreateNewContext(dpy,cfg->nativeConfig(),GLX_RGBA_TYPE,sharedContext,true);\n+ ErrorHandler handler(dpy);\n+ EGLNativeContextType retVal = glXCreateNewContext(dpy,cfg->nativeConfig(),GLX_RGBA_TYPE,sharedContext,true);\n+ return handler.getLastError() == 0 ? retVal : NULL;\n }\n \n bool destroyContext(EGLNativeDisplayType dpy,EGLNativeContextType ctx) {\n@@ -188,8 +237,9 @@ GLXDrawable convertSurface(EglSurface* srfc) {\n \n bool makeCurrent(EGLNativeDisplayType dpy,EglSurface* read,EglSurface* draw,EGLNativeContextType ctx){\n \n-\n-return glXMakeContextCurrent(dpy,convertSurface(draw),convertSurface(read),ctx);\n+    ErrorHandler handler(dpy);\n+    bool retval = glXMakeContextCurrent(dpy,convertSurface(draw),convertSurface(read),ctx);\n+    return (handler.getLastError() == 0) && retval;\n }\n \n void swapBuffers(EGLNativeDisplayType dpy,EGLNativeWindowType win) {\n"", ""EglOsApi.h"": ""@@ -32,8 +32,8 @@ namespace EglOS{\n     bool releasePbuffer(EGLNativeDisplayType dis,EGLNativePbufferType pb);\n     bool destroyContext(EGLNativeDisplayType dpy,EGLNativeContextType ctx);\n     bool releaseDisplay(EGLNativeDisplayType dpy);\n-    bool validNativeWin(EGLNativeWindowType win);\n-    bool validNativePixmap(EGLNativePixmapType pix);\n+    bool validNativeWin(EGLNativeDisplayType dpy,EGLNativeWindowType win);\n+    bool validNativePixmap(EGLNativeDisplayType dpy,EGLNativePixmapType pix);\n     bool checkWindowPixelFormatMatch(EGLNativeDisplayType dpy,EGLNativeWindowType win,EglConfig* cfg,unsigned int* width,unsigned int* height);\n     bool checkPixmapPixelFormatMatch(EGLNativeDisplayType dpy,EGLNativePixmapType pix,EglConfig* cfg,unsigned int* width,unsigned int* height);\n     bool makeCurrent(EGLNativeDisplayType dpy,EglSurface* read,EglSurface* draw,EGLNativeContextType);\n""}","bug, feature 
"
14395,Mike Chan,[ARM] omap: resource: Make free_user() static,['arch/arm/plat-omap/resource.c'],"[ARM] omap: resource: Make free_user() static

Only resource framework calls free_user(), ensure it is this way.

Change-Id: Iea543a009126216b6d3b607595d0b799bf0ef2e9
Signed-off-by: Mike Chan <mike@android.com>",https://android-review.googlesource.com/c/14395,"refactor 
",refactor,Others;,"{""resource.c"": ""@@ -190,7 +190,7 @@ static struct users_list *get_user(void)\n  * dynamically allocated, and if its from the static pool, marks it unused.\n  * No return value.\n  */\n-void free_user(struct users_list *user)\n+static void free_user(struct users_list *user)\n {\n \tif (user->usage == DYNAMIC_ALLOC) {\n \t\tkfree(user);\n""}","resource, refactor 
"
18698,Brian Muramatsu,Fix opcode tests for sput_short,"['tools/vm-tests/src/dot/junit/opcodes/sput_short/d/T_sput_short_15.java', 'tools/vm-tests/src/dot/junit/opcodes/sput_short/d/T_sput_short_17.java', 'tools/vm-tests/src/dot/junit/opcodes/sput_short/d/T_sput_short_10.java', 'tools/vm-tests/src/dot/junit/opcodes/sput_short/d/T_sput_short_9.java', 'tools/vm-tests/src/dot/junit/opcodes/sput_short/d/T_sput_short_8.java', 'tools/vm-tests/src/dot/junit/opcodes/sput_short/d/T_sput_short_7.java', 'tools/vm-tests/src/dot/junit/opcodes/sput_short/Test_sput_short.java']","Fix opcode tests for sput_short

Bug 3147582

Change-Id: Icde18c91b5d34557fdb4fdf7e388c3c28f6eb82c",https://android-review.googlesource.com/c/18698,"bug, test 
","test,bug",Bug;Test;,"{""Test_sput_short.java"": ""@@ -19,10 +19,16 @@ package dot.junit.opcodes.sput_short;\n import dot.junit.DxTestCase;\n import dot.junit.DxUtil;\n import dot.junit.opcodes.sput_short.d.T_sput_short_1;\n+import dot.junit.opcodes.sput_short.d.T_sput_short_10;\n import dot.junit.opcodes.sput_short.d.T_sput_short_11;\n import dot.junit.opcodes.sput_short.d.T_sput_short_12;\n import dot.junit.opcodes.sput_short.d.T_sput_short_13;\n import dot.junit.opcodes.sput_short.d.T_sput_short_14;\n+import dot.junit.opcodes.sput_short.d.T_sput_short_15;\n+import dot.junit.opcodes.sput_short.d.T_sput_short_17;\n+import dot.junit.opcodes.sput_short.d.T_sput_short_7;\n+import dot.junit.opcodes.sput_short.d.T_sput_short_8;\n+import dot.junit.opcodes.sput_short.d.T_sput_short_9;\n \n public class Test_sput_short extends DxTestCase {\n     /**\n@@ -35,7 +41,7 @@ public class Test_sput_short extends DxTestCase {\n         assertEquals(77, T_sput_short_1.st_i1);\n     }\n \n- \n+\n     /**\n      * @title modification of final field\n      */\n@@ -73,7 +79,7 @@ public class Test_sput_short extends DxTestCase {\n     }\n \n     /**\n-     * @constraint A12 \n+     * @constraint A12\n      * @title constant pool index\n      */\n     public void testVFE1() {\n@@ -86,8 +92,8 @@ public class Test_sput_short extends DxTestCase {\n     }\n \n     /**\n-     * \n-     * @constraint A23 \n+     *\n+     * @constraint A23\n      * @title number of registers\n      */\n     public void testVFE2() {\n@@ -101,23 +107,22 @@ public class Test_sput_short extends DxTestCase {\n \n \n     /**\n-     * \n-     * @constraint B13 \n-     * @title put short into long field - only field with same name but \n+     *\n+     * @constraint B13\n+     * @title put short into long field - only field with same name but\n      * different type exists\n      */\n     public void testVFE5() {\n         try {\n-            Class.forName(\""dot.junit.opcodes.sput_short.d.T_sput_short_17\"");\n-            fail(\""expected a verification exception\"");\n-        } catch (Throwable t) {\n-            DxUtil.checkVerifyException(t);\n+            new T_sput_short_17().run();\n+            fail(\""expected NoSuchFieldError\"");\n+        } catch (NoSuchFieldError t) {\n         }\n     }\n-    \n+\n     /**\n-     * \n-     * @constraint B13 \n+     *\n+     * @constraint B13\n      * @title put value '66000' into byte field\n      */\n     public void testVFE6() {\n@@ -130,9 +135,9 @@ public class Test_sput_short extends DxTestCase {\n     }\n \n     /**\n-     * \n-     * @constraint B13 \n-     * @title type of field doesn't match opcode - attempt to modify double \n+     *\n+     * @constraint B13\n+     * @title type of field doesn't match opcode - attempt to modify double\n      * field with single-width register\n      */\n     public void testVFE7() {\n@@ -143,87 +148,77 @@ public class Test_sput_short extends DxTestCase {\n             DxUtil.checkVerifyException(t);\n         }\n     }\n-    \n+\n     /**\n-     * \n-     * @constraint A12 \n-     * @title Attempt to set non-static field. Java throws IncompatibleClassChangeError \n-     * on first access but Dalvik throws VerifyError on class loading.\n+     *\n+     * @constraint A12\n+     * @title Attempt to set non-static field.\n      */\n     public void testVFE8() {\n          try {\n-             Class.forName(\""dot.junit.opcodes.sput_short.d.T_sput_short_7\"");\n-             fail(\""expected a verification exception\"");\n-         } catch (Throwable t) {\n-             DxUtil.checkVerifyException(t);\n+             new T_sput_short_7().run();\n+             fail(\""expected IncompatibleClassChangeError\"");\n+         } catch (IncompatibleClassChangeError t) {\n          }\n     }\n-    \n+\n     /**\n      * @constraint n/a\n-     * @title Attempt to modify inaccessible field. Java throws IllegalAccessError \n-     * on first access but Dalvik throws VerifyError on class loading.\n+     * @title Attempt to modify inaccessible field.\n      */\n     public void testVFE9() {\n         //@uses dot.junit.opcodes.sput_short.TestStubs\n         //@uses dot.junit.opcodes.sput_short.d.T_sput_short_8\n         try {\n-            Class.forName(\""dot.junit.opcodes.sput_short.d.T_sput_short_8\"");\n-            fail(\""expected a verification exception\"");\n-        } catch (Throwable t) {\n-            DxUtil.checkVerifyException(t);\n+            new T_sput_short_8().run();\n+            fail(\""expected IllegalAccessError\"");\n+        } catch (IllegalAccessError t) {\n         }\n     }\n \n     /**\n      * @constraint n/a\n-     * @title Attempt to modify field of undefined class. Java throws NoClassDefFoundError \n-     * on first access but Dalvik throws VerifyError on class loading.\n+     * @title Attempt to modify field of undefined class.\n      */\n     public void testVFE10() {\n         try {\n-            Class.forName(\""dot.junit.opcodes.sput_short.d.T_sput_short_9\"");\n-            fail(\""expected a verification exception\"");\n-        } catch (Throwable t) {\n-            DxUtil.checkVerifyException(t);\n+            new T_sput_short_9().run();\n+            fail(\""expected NoClassDefFoundError\"");\n+        } catch (NoClassDefFoundError t) {\n         }\n     }\n \n     /**\n      * @constraint n/a\n-     * @title Attempt to modify undefined field. Java throws NoSuchFieldError \n-     * on first access but Dalvik throws VerifyError on class loading.\n+     * @title Attempt to modify undefined field.\n      */\n     public void testVFE11() {\n         try {\n-            Class.forName(\""dot.junit.opcodes.sput_short.d.T_sput_short_10\"");\n-            fail(\""expected a verification exception\"");\n-        } catch (Throwable t) {\n-            DxUtil.checkVerifyException(t);\n+            new T_sput_short_10().run();\n+            fail(\""expected NoSuchFieldError\"");\n+        } catch (NoSuchFieldError t) {\n         }\n     }\n-    \n-    \n-    \n+\n+\n+\n     /**\n      * @constraint n/a\n-     * @title Attempt to modify superclass' private field from subclass. Java \n-     * throws IllegalAccessError on first access but Dalvik throws VerifyError on class loading.\n+     * @title Attempt to modify superclass' private field from subclass.\n      */\n     public void testVFE12() {\n         //@uses dot.junit.opcodes.sput_short.d.T_sput_short_1\n         //@uses dot.junit.opcodes.sput_short.d.T_sput_short_15\n         try {\n-            Class.forName(\""dot.junit.opcodes.sput_short.d.T_sput_short_15\"");\n-            fail(\""expected a verification exception\"");\n-        } catch (Throwable t) {\n-            DxUtil.checkVerifyException(t);\n+            new T_sput_short_15().run();\n+            fail(\""expected IllegalAccessError\"");\n+        } catch (IllegalAccessError t) {\n         }\n     }\n-    \n-    \n+\n+\n     /**\n-     * @constraint B1 \n+     * @constraint B1\n      * @title sput-short shall not work for wide numbers\n      */\n     public void testVFE13() {\n@@ -234,10 +229,10 @@ public class Test_sput_short extends DxTestCase {\n             DxUtil.checkVerifyException(t);\n         }\n     }\n-    \n+\n     /**\n-     * \n-     * @constraint B1 \n+     *\n+     * @constraint B1\n      * @title sput-short shall not work for reference fields\n      */\n     public void testVFE14() {\n@@ -248,10 +243,10 @@ public class Test_sput_short extends DxTestCase {\n             DxUtil.checkVerifyException(t);\n         }\n     }\n-    \n+\n     /**\n-     * \n-     * @constraint B1 \n+     *\n+     * @constraint B1\n      * @title sput-short shall not work for char fields\n      */\n     public void testVFE15() {\n@@ -262,10 +257,10 @@ public class Test_sput_short extends DxTestCase {\n             DxUtil.checkVerifyException(t);\n         }\n     }\n-    \n+\n     /**\n-     * \n-     * @constraint B1 \n+     *\n+     * @constraint B1\n      * @title sput-short shall not work for int fields\n      */\n     public void testVFE16() {\n@@ -276,10 +271,10 @@ public class Test_sput_short extends DxTestCase {\n             DxUtil.checkVerifyException(t);\n         }\n     }\n-    \n+\n     /**\n-     * \n-     * @constraint B1 \n+     *\n+     * @constraint B1\n      * @title sput-short shall not work for byte fields\n      */\n     public void testVFE17() {\n@@ -290,10 +285,10 @@ public class Test_sput_short extends DxTestCase {\n             DxUtil.checkVerifyException(t);\n         }\n     }\n-    \n+\n     /**\n-     * \n-     * @constraint B1 \n+     *\n+     * @constraint B1\n      * @title sput-short shall not work for boolean fields\n      */\n     public void testVFE18() {\n@@ -313,10 +308,9 @@ public class Test_sput_short extends DxTestCase {\n         //@uses dot.junit.opcodes.sput_short.TestStubs\n         //@uses dot.junit.opcodes.sput_short.d.T_sput_short_11\n     \ttry {\n-            Class.forName(\""dot.junit.opcodes.sput_short.d.T_sput_short_11\"");\n-            fail(\""expected a verification exception\"");\n-        } catch (Throwable t) {\n-            DxUtil.checkVerifyException(t);\n+            new T_sput_short_11().run();\n+            fail(\""expected IllegalAccessError\"");\n+        } catch (IllegalAccessError t) {\n         }\n     }\n }\n"", ""T_sput_short_10.java"": ""@@ -0,0 +1,22 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package dot.junit.opcodes.sput_short.d;\n+\n+public class T_sput_short_10 {\n+    public void run() {\n+    }\n+}\n"", ""T_sput_short_15.java"": ""@@ -0,0 +1,22 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package dot.junit.opcodes.sput_short.d;\n+\n+public class T_sput_short_15 {\n+    public void run() {\n+    }\n+}\n"", ""T_sput_short_17.java"": ""@@ -0,0 +1,22 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package dot.junit.opcodes.sput_short.d;\n+\n+public class T_sput_short_17 {\n+    public void run() {\n+    }\n+}\n"", ""T_sput_short_7.java"": ""@@ -0,0 +1,22 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package dot.junit.opcodes.sput_short.d;\n+\n+public class T_sput_short_7 {\n+    public void run() {\n+    }\n+}\n"", ""T_sput_short_8.java"": ""@@ -0,0 +1,22 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package dot.junit.opcodes.sput_short.d;\n+\n+public class T_sput_short_8 {\n+    public void run() {\n+    }\n+}\n"", ""T_sput_short_9.java"": ""@@ -0,0 +1,22 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package dot.junit.opcodes.sput_short.d;\n+\n+public class T_sput_short_9 {\n+    public void run() {\n+    }\n+}\n""}","test 
"
21505,David Turner,Remove un-needed -clock unix core option.,"['android/main.c', 'qemu-timer.c']","Remove un-needed -clock unix core option.

Remove the '-clock unix' used to start the core on Linux.
We do that by moving the problematic 'dynticks' clock to the
end of the list in qemu-timer.c.

The effect is that the unix clock will become the default
for normal usage. You can still use the dynticks one for
experimentation with -qemu -clock dynticks though.

Change-Id: Ia7a8b2b262c62e8b80a82d6dbadec25964774b57",https://android-review.googlesource.com/c/21505,"bug, refactor 
","bug,refactor",Deprecat;,"{""main.c"": ""@@ -804,15 +804,6 @@ int main(int argc, char **argv)\n \n     /* physical memory is now in hw->hw_ramSize */\n \n-    /* on Linux, the 'dynticks' clock sometimes doesn't work\n-     * properly. this results in the UI freezing while emulation\n-     * continues, for several seconds...\n-     */\n-#ifdef __linux__\n-    args[n++] = \""-clock\"";\n-    args[n++] = \""unix\"";\n-#endif\n-\n     args[n++] = \""-android-avdname\"";\n     args[n++] = (char*) avdInfo_getName(avd);\n \n"", ""qemu-timer.c"": ""@@ -394,14 +394,20 @@ int64_t qemu_icount_round(int64_t count)\n static struct qemu_alarm_timer alarm_timers[] = {\n #ifndef _WIN32\n #ifdef __linux__\n-    {\""dynticks\"", dynticks_start_timer,\n-     dynticks_stop_timer, dynticks_rearm_timer, NULL},\n     /* HPET - if available - is preferred */\n     {\""hpet\"", hpet_start_timer, hpet_stop_timer, NULL, NULL},\n     /* ...otherwise try RTC */\n     {\""rtc\"", rtc_start_timer, rtc_stop_timer, NULL, NULL},\n #endif\n     {\""unix\"", unix_start_timer, unix_stop_timer, NULL, NULL},\n+#ifdef __linux__\n+    /* on Linux, the 'dynticks' clock sometimes doesn't work\n+     * properly. this results in the UI freezing while emulation\n+     * continues, for several seconds... So move it to the end\n+     * of the list. */\n+    {\""dynticks\"", dynticks_start_timer,\n+     dynticks_stop_timer, dynticks_rearm_timer, NULL},\n+#endif\n #else\n     {\""dynticks\"", win32_start_timer,\n      win32_stop_timer, win32_rearm_timer, &alarm_win32_data},\n""}","bug, refactor 
"
15404,Brian Muramatsu,CTS Eclipse Classpath File Generator,"['development/ide/eclipse/.classpath', 'development/ide/eclipse/genclasspath.sh']","CTS Eclipse Classpath File Generator

Add a script that combine the classpath under development/ide/eclipse
with a .classpath file under cts/development/ide/eclipse that has
the CTS packages. Run the following in your ANDROID_BUILD_TOP to
generate a classpath for Eclipse that has the CTS packages:

./cts/development/ide/eclipse/genclasspath.sh > .classpath

Change-Id: I0cd0cecdf594d99e52b1b78d8c50f80bbf855d0f",https://android-review.googlesource.com/c/15404,"resource
",resource,Feature;,"{"".classpath"": ""@@ -0,0 +1,61 @@\n+<?xml version=\""1.0\"" encoding=\""UTF-8\""?>\n+<classpath>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/ApiDemosReferenceTest/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/ProcessTest/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/ProcessTest/NoShareUidApp/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/ProcessTest/ShareUidApp/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/SignatureTest/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/SignatureTest/tests/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/accessibilityservice/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/appsecurity-tests/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/core/runner/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/accessibilityservice/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/accounts/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/app/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/bluetooth/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/content/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/database/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/dpi/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/dpi2/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/example/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/gesture/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/graphics/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/hardware/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/jni/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/location/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/media/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/net/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/os/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/performance/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/performance2/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/performance3/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/performance4/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/performance5/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/permission/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/permission2/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/provider/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/speech/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/telephony/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/text/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/util/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/view/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/webkit/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tests/tests/widget/src\""/>\n+        <classpathentry kind=\""src\"" path=\""cts/tools/annotation-helper/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tools/cts-reference-app-lib/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tools/dasm/src\""/>\n+        <classpathentry kind=\""src\"" path=\""cts/tools/device-setup/TestDeviceSetup/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tools/dex-tools/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tools/dx-tests/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tools/host/src\""/>\n+\t<classpathentry kind=\""src\"" path=\""cts/tools/host/test\""/>\n+        <classpathentry kind=\""src\"" path=\""cts/tools/signature-tools/src\""/>\n+        <classpathentry kind=\""src\"" path=\""cts/tools/signature-tools/test\""/>\n+        <classpathentry kind=\""src\"" path=\""cts/tools/spec-progress/src\""/>\n+        <classpathentry kind=\""src\"" path=\""cts/tools/test-progress-new/src\""/>\n+        <classpathentry kind=\""src\"" path=\""cts/tools/utils\""/>\n+        <classpathentry kind=\""src\"" path=\""cts/tools/vm-tests/src\""/>\n+        <classpathentry kind=\""src\"" path=\""out/target/common/obj/APPS/CtsTestStubs_intermediates/src/src\""/>\n+        <classpathentry kind=\""src\"" path=\""out/target/common/obj/APPS/CtsAccessibilityServiceTestCases_intermediates/src/src\""/>\n+</classpath>\n"", ""genclasspath.sh"": ""@@ -0,0 +1,18 @@\n+#!/bin/bash\n+\n+# Outputs a classpath file containing classpaths from development/ide/eclipse\n+# and additional classpaths from cts/development/ide/eclipse.\n+#\n+# From your $ANDROID_BUILD_TOP directory:\n+# ./cts/development/ide/eclipse/genclasspath.sh > .classpath\n+\n+if [[ -z $ANDROID_BUILD_TOP ]]; then\n+  echo \""Run 'lunch' to set \\$ANDROID_BUILD_TOP\"" >&2\n+  exit 1\n+fi\n+\n+echo '<?xml version=\""1.0\"" encoding=\""UTF-8\""?>'\n+echo '<classpath>'\n+cat $ANDROID_BUILD_TOP/cts/development/ide/eclipse/.classpath | grep classpathentry\n+cat $ANDROID_BUILD_TOP/development/ide/eclipse/.classpath | grep classpathentry\n+echo '</classpath>'\n""}","refactor 
"
15367,RaphaÃ«l Moll,ADT GLE2: drag'n'drop in RelativeLayout.,"['eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/editors/layout/gscripts/IDragElement.java', 'eclipse/plugins/com.android.ide.eclipse.adt/gscripts/android.widget.LinearLayout.groovy', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/editors/layout/gscripts/INode.java', 'eclipse/plugins/com.android.ide.eclipse.adt/gscripts/android.widget.RelativeLayout.groovy', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/editors/layout/gscripts/IViewRule.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/SimpleAttribute.java', 'eclipse/plugins/com.android.ide.eclipse.adt/gscripts/BaseView.groovy', 'eclipse/plugins/com.android.ide.eclipse.adt/gscripts/android.widget.AbsoluteLayout.groovy', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gre/NodeProxy.java', 'eclipse/plugins/com.android.ide.eclipse.adt/gscripts/BaseLayout.groovy', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/editors/layout/gscripts/DropFeedback.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gre/RulesEngine.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/CanvasDropListener.java']","ADT GLE2: drag'n'drop in RelativeLayout.

First pass. There are some details to take care of later.

Change-Id: Ic9ac3d34ce4061ed2a8c257ce6bd40ea30497eb8",https://android-review.googlesource.com/c/15367,"feature
",feature,Others;,"{""BaseLayout.groovy"": ""@@ -28,6 +28,34 @@ public class BaseLayout extends BaseView {\n \n     // ==== Utility methods used by derived layouts ====\n \n+    // TODO revisit.\n+    protected String[] getLayoutAttrFilter() {\n+        return [\n+            // from AbsoluteLayout\n+            \""layout_x\"",\n+            \""layout_y\"",\n+\n+            // from RelativeLayout\n+            \""layout_above\"",\n+            \""layout_below\"",\n+            \""layout_toLeftOf\"",\n+            \""layout_toRightOf\"",\n+            \""layout_alignBaseline\"",\n+            \""layout_alignTop\"",\n+            \""layout_alignBottom\"",\n+            \""layout_alignLeft\"",\n+            \""layout_alignRight\"",\n+            \""layout_alignParentTop\"",\n+            \""layout_alignParentBottom\"",\n+            \""layout_alignParentLeft\"",\n+            \""layout_alignParentRight\"",\n+            \""layout_alignWithParentMissing\"",\n+            \""layout_centerHorizontal\"",\n+            \""layout_centerInParent\"",\n+            \""layout_centerVertical\"",\n+        ];\n+    }\n+\n     /**\n      * Draws the bounds of the given elements and all its children elements\n      * in the canvas with the specified offet.\n@@ -61,7 +89,7 @@ public class BaseLayout extends BaseView {\n         def idMap = [:];\n \n         if (createNewIds) {\n-            collectIds(targetNode, idMap, elements);\n+            collectIds(idMap, elements);\n             // Need to remap ids if necessary\n             idMap = remapIds(targetNode, idMap);\n         }\n@@ -77,7 +105,7 @@ public class BaseLayout extends BaseView {\n      *\n      * @see #getDropIdMap\n      */\n-    protected void collectIds(INode targetNode, Map idMap, IDragElement[] elements) {\n+    protected Map collectIds(Map idMap, IDragElement[] elements) {\n         for (element in elements) {\n             def attr = element.getAttribute(ANDROID_URI, \""id\"");\n             if (attr != null) {\n@@ -87,8 +115,10 @@ public class BaseLayout extends BaseView {\n                 }\n             }\n \n-            collectIds(targetNode, idMap, element.getInnerElements());\n+            collectIds(idMap, element.getInnerElements());\n         }\n+\n+        return idMap;\n     }\n \n     /**\n"", ""BaseView.groovy"": ""@@ -114,8 +114,7 @@ public class BaseView implements IViewRule {\n         // ignore\n     }\n \n-    void onDropped(INode targetNode, IDragElement[] elements, DropFeedback feedback,\n-                   Point p, boolean isCopy, boolean sameCanvas) {\n+    void onDropped(INode targetNode, IDragElement[] elements, DropFeedback feedback, Point p) {\n         // ignore\n     }\n \n"", ""android.widget.AbsoluteLayout.groovy"": ""@@ -104,9 +104,7 @@ public class AndroidWidgetAbsoluteLayoutRule extends BaseLayout {\n     void onDropped(INode targetNode,\n                    IDragElement[] elements,\n                    DropFeedback feedback,\n-                   Point p,\n-                   boolean isCopy,\n-                   boolean sameCanvas) {\n+                   Point p) {\n \n         Rect b = targetNode.getBounds();\n         if (!b.isValid()) {\n@@ -118,7 +116,7 @@ public class AndroidWidgetAbsoluteLayoutRule extends BaseLayout {\n \n         // Collect IDs from dropped elements and remap them to new IDs\n         // if this is a copy or from a different canvas.\n-        def id_map = getDropIdMap(targetNode, elements, isCopy || !sameCanvas);\n+        def id_map = getDropIdMap(targetNode, elements, feedback.isCopy || !feedback.sameCanvas);\n \n         targetNode.editXml(\""Add elements to AbsoluteLayout\"") {\n \n"", ""android.widget.LinearLayout.groovy"": ""@@ -61,9 +61,9 @@ public class AndroidWidgetLinearLayoutRule extends BaseLayout {\n         return new DropFeedback(\n           [ \""isVertical\"": isVertical,   // boolean: True if vertical linear layout\n             \""indexes\"": indexes,         // list(tuple(0:int, 1:int)): insert points (pixels + index)\n-            \""curr_x\"": null,             // int: Current marker X position\n-            \""curr_y\"": null,             // int: Current marker Y position\n-            \""insert_pos\"": -1            // int: Current drop insert index (-1 for \""at the end\"")\n+            \""currX\"": null,              // int: Current marker X position\n+            \""currY\"": null,              // int: Current marker Y position\n+            \""insertPos\"": -1             // int: Current drop insert index (-1 for \""at the end\"")\n           ],\n           {\n             gc, node, feedback ->\n@@ -106,12 +106,12 @@ public class AndroidWidgetLinearLayoutRule extends BaseLayout {\n             }\n         }\n \n-        def curr_x = feedback.userData.curr_x;\n-        def curr_y = feedback.userData.curr_y;\n+        def currX = feedback.userData.currX;\n+        def currY = feedback.userData.currY;\n \n-        if (curr_x != null && curr_y != null) {\n-            int x = curr_x;\n-            int y = curr_y;\n+        if (currX != null && currY != null) {\n+            int x = currX;\n+            int y = currY;\n \n             // Draw a mark at the drop point.\n             gc.setLineStyle(IGraphics.LineStyle.LINE_SOLID);\n@@ -121,8 +121,6 @@ public class AndroidWidgetLinearLayoutRule extends BaseLayout {\n             gc.drawLine(x + 10, y - 10, x - 10, y + 10);\n             gc.drawOval(x - 10, y - 10, x + 10, y + 10);\n \n-            gc.setLineWidth(1);\n-\n             Rect be = elements[0].getBounds();\n \n             if (be.isValid()) {\n@@ -143,8 +141,8 @@ public class AndroidWidgetLinearLayoutRule extends BaseLayout {\n                     }\n                 }\n \n-                elements.each {\n-                    drawElement(gc, it, offsetX, offsetY);\n+                for (element in elements) {\n+                    drawElement(gc, element, offsetX, offsetY);\n                 }\n             }\n         }\n@@ -181,20 +179,20 @@ public class AndroidWidgetLinearLayoutRule extends BaseLayout {\n         }\n \n         if (bestIndex != Integer.MIN_VALUE) {\n-            def old_x = data.curr_x;\n-            def old_y = data.curr_y;\n+            def old_x = data.currX;\n+            def old_y = data.currY;\n \n             if (isVertical) {\n-                data.curr_x = b.x + b.w / 2;\n-                data.curr_y = bestIndex;\n+                data.currX = b.x + b.w / 2;\n+                data.currY = bestIndex;\n             } else {\n-                data.curr_x = bestIndex;\n-                data.curr_y = b.y + b.h / 2;\n+                data.currX = bestIndex;\n+                data.currY = b.y + b.h / 2;\n             }\n \n-            data.insert_pos = bestPos;\n+            data.insertPos = bestPos;\n \n-            feedback.requestPaint = (old_x != data.curr_x) || (old_y != data.curr_y);\n+            feedback.requestPaint = (old_x != data.currX) || (old_y != data.currY);\n         }\n \n         return feedback;\n@@ -207,33 +205,31 @@ public class AndroidWidgetLinearLayoutRule extends BaseLayout {\n     void onDropped(INode targetNode,\n                    IDragElement[] elements,\n                    DropFeedback feedback,\n-                   Point p,\n-                   boolean isCopy,\n-                   boolean sameCanvas) {\n+                   Point p) {\n \n-        int insert_pos = feedback.userData.insert_pos;\n+        int insertPos = feedback.userData.insertPos;\n \n         // Collect IDs from dropped elements and remap them to new IDs\n         // if this is a copy or from a different canvas.\n-        def id_map = getDropIdMap(targetNode, elements, isCopy || !sameCanvas);\n+        def idMap = getDropIdMap(targetNode, elements, feedback.isCopy || !feedback.sameCanvas);\n \n         targetNode.editXml(\""Add elements to LinearLayout\"") {\n \n             // Now write the new elements.\n-            elements.each { element ->\n+            for (element in elements) {\n                 String fqcn = element.getFqcn();\n                 Rect be = element.getBounds();\n \n-                INode newChild = targetNode.insertChildAt(fqcn, insert_pos);\n+                INode newChild = targetNode.insertChildAt(fqcn, insertPos);\n \n-                // insert_pos==-1 means to insert at the end. Otherwise\n+                // insertPos==-1 means to insert at the end. Otherwise\n                 // increment the insertion position.\n-                if (insert_pos >= 0) {\n-                    insert_pos++;\n+                if (insertPos >= 0) {\n+                    insertPos++;\n                 }\n \n                 // Copy all the attributes, modifying them as needed.\n-                addAttributes(newChild, element, id_map) {\n+                addAttributes(newChild, element, idMap) {\n                     uri, name, value ->\n                     // TODO exclude original parent attributes\n                     if (name == \""layout_x\"" || name == \""layout_y\"") {\n@@ -243,7 +239,7 @@ public class AndroidWidgetLinearLayoutRule extends BaseLayout {\n                     }\n                 };\n \n-                addInnerElements(newChild, element, id_map);\n+                addInnerElements(newChild, element, idMap);\n             }\n         }\n \n"", ""android.widget.RelativeLayout.groovy"": ""@@ -49,7 +49,7 @@ public class AndroidWidgetRelativeLayoutRule extends BaseLayout {\n         def infos = [];\n \n         def addAttr = {\n-            def a = childNode.getStringAttr(\""layout_${it}\"");\n+            def a = childNode.getStringAttr(ANDROID_URI, \""layout_${it}\"");\n             if (a) {\n                 infos += \""${it}: ${a}\"";\n             }\n@@ -88,28 +88,40 @@ public class AndroidWidgetRelativeLayoutRule extends BaseLayout {\n \n     // ==== Drag'n'drop support ====\n \n-    DropFeedback onDropEnter(INode targetNode, String fqcn) {\n+    DropFeedback onDropEnter(INode targetNode, IDragElement[] elements) {\n+\n+        if (elements.length == 0) {\n+            return null;\n+        }\n \n         def bn = targetNode.getBounds();\n         if (!bn.isValid()) {\n             return;\n         }\n \n+        // Collect the ids of the elements being dragged\n+        def movedIds = collectIds([:], elements).keySet().asList();\n+\n         // Prepare the drop feedback\n         return new DropFeedback(\n                 [ \""child\"": null,    // INode: Current child under cursor\n                   \""index\"": 0,       // int: Index of child in the parent children list\n                   \""zones\"": null,    // Valid \""anchor\"" zones for the current child\n                                     // of type list(map(rect:Rect, attr:[String]))\n-                  \""curr\"":  null,     // map: Current zone\n+                  \""curr\"":  null,    // map: Current zone\n+                  \""movedIds\"": movedIds,\n+                  \""cachedLinkIds\"": [:]\n                 ],\n                 { gc, node, feedback ->\n                     // Paint closure for the RelativeLayout just defers to the method below\n-                    drawRelativeDropFeedback(gc, node, feedback);\n+                    drawRelativeDropFeedback(gc, node, elements, feedback);\n                 });\n     }\n \n-    DropFeedback onDropMove(INode layoutNode, String fqcn, DropFeedback feedback, Point p) {\n+    DropFeedback onDropMove(INode targetNode,\n+                            IDragElement[] elements,\n+                            DropFeedback feedback,\n+                            Point p) {\n \n         def  data = feedback.userData;\n         Rect area = feedback.captureArea;\n@@ -123,9 +135,35 @@ public class AndroidWidgetRelativeLayoutRule extends BaseLayout {\n             // Find the current direct children under the cursor\n             def childNode = null;\n             def childIndex = -1;\n-            for(child in layoutNode.getChildren()) {\n+            nextChild: for(child in targetNode.getChildren()) {\n                 childIndex++;\n-                if (child.getBounds().contains(p)) {\n+                def bc = child.getBounds();\n+                if (bc.contains(p)) {\n+\n+                    // TODO visually indicate this target node has been rejected,\n+                    // e.g. by drawing a semi-transp rect on it or drawing a red cross at\n+                    // the cursor point.\n+\n+                    // If we're doing a move operation within the same canvas, we can't\n+                    // attach the moved object to one belonging to the selection since\n+                    // it will disappear after the move.\n+                    if (feedback.sameCanvas && !feedback.isCopy) {\n+                        for (element in elements) {\n+                            if (bc == element.getBounds()) {\n+                                continue nextChild;\n+                            }\n+                        }\n+                    }\n+\n+                    // One more limitation: if we're moving one or more elements, we can't\n+                    // drop them on a child which relative position is expressed directly or\n+                    // indirectly based on the element being moved.\n+                    if (!feedback.isCopy) {\n+                        if (searchRelativeIds(child, data.movedIds, data.cachedLinkIds)) {\n+                            continue nextChild;\n+                        }\n+                    }\n+\n                     childNode = child;\n                     break;\n                 }\n@@ -151,7 +189,7 @@ public class AndroidWidgetRelativeLayoutRule extends BaseLayout {\n                 data.index = -1;\n                 data.curr  = null;\n \n-                def zone = computeBorderDropZone(layoutNode.getBounds(), p);\n+                def zone = computeBorderDropZone(targetNode.getBounds(), p);\n \n                 if (zone == null) {\n                     data.zones = null;\n@@ -183,6 +221,71 @@ public class AndroidWidgetRelativeLayoutRule extends BaseLayout {\n         return feedback;\n     }\n \n+    /**\n+     * Returns true if the child has any attribute of Format.REFERENCE which\n+     * value matches one of the ids in movedIds.\n+     */\n+    def searchRelativeIds(INode node, List movedIds, Map cachedLinkIds) {\n+        def ids = getLinkedIds(node, cachedLinkIds);\n+\n+        for (id in ids) {\n+            if (id in movedIds) {\n+                return true;\n+            }\n+        }\n+\n+        return false;\n+    }\n+\n+    def getLinkedIds(INode node, Map cachedLinkIds) {\n+        def ids = cachedLinkIds[node];\n+\n+        if (ids != null) {\n+            return ids;\n+        }\n+\n+        // we don't have cached data on this child, so create a list of\n+        // all the linked id it is referencing.\n+        ids = [];\n+        cachedLinkIds[node] = ids;\n+        for (attr in node.getAttributes()) {\n+            def attrInfo = node.getAttributeInfo(attr.getUri(), attr.getName());\n+            if (attrInfo == null) {\n+                continue;\n+            }\n+            def formats = attrInfo.getFormats();\n+            if (formats == null || !(IAttributeInfo.Format.REFERENCE in formats)) {\n+                continue;\n+            }\n+            def id = attr.getValue();\n+            id = normalizeId(id);\n+            if (id in ids) {\n+                continue;\n+            }\n+            ids.add(id);\n+\n+            // Find the sibling with that id\n+            def p = node.getParent();\n+            if (p == null) {\n+                continue;\n+            }\n+            for (child in p.getChildren()) {\n+                if (child == node) {\n+                    continue;\n+                }\n+                def childId = child.getStringAttr(ANDROID_URI, \""id\"");\n+                childId = normalizeId(childId);\n+                if (id == childId) {\n+                    def linkedIds = getLinkedIds(child, cachedLinkIds);\n+                    ids.addAll(linkedIds);\n+                    break;\n+                }\n+            }\n+        }\n+\n+        return ids;\n+    }\n+\n     def computeBorderDropZone(Rect bounds, Point p) {\n \n         int x = p.x;\n@@ -320,8 +423,11 @@ public class AndroidWidgetRelativeLayoutRule extends BaseLayout {\n         return [ bounds, zones ];\n     }\n \n-    void drawRelativeDropFeedback(IGraphics gc, INode layoutNode, DropFeedback feedback) {\n-        Rect b = layoutNode.getBounds();\n+    void drawRelativeDropFeedback(IGraphics gc,\n+                                  INode targetNode,\n+                                  IDragElement[] elements,\n+                                  DropFeedback feedback) {\n+        Rect b = targetNode.getBounds();\n         if (!b.isValid()) {\n             return;\n         }\n@@ -356,7 +462,7 @@ public class AndroidWidgetRelativeLayoutRule extends BaseLayout {\n             int h = gc.getFontHeight();\n             String id = null;\n             if (data.child) {\n-                id = data.child.getStringAttr(\""id\"");\n+                id = data.child.getStringAttr(ANDROID_URI, \""id\"");\n             }\n             data.curr.attr.each {\n                 String s = it;\n@@ -376,41 +482,87 @@ public class AndroidWidgetRelativeLayoutRule extends BaseLayout {\n                 y = mark.y;\n                 gc.drawLine(x - 10, y - 10, x + 10, y + 10);\n                 gc.drawLine(x + 10, y - 10, x - 10, y + 10);\n-                gc.drawRect(x - 10, y - 10, x + 10, y + 10);\n-            }\n+                gc.drawOval(x - 10, y - 10, x + 10, y + 10);\n+\n+                Rect be = elements[0].getBounds();\n+\n+                if (be.isValid()) {\n+                    // At least the first element has a bound. Draw rectangles\n+                    // for all dropped elements with valid bounds, offset at\n+                    // the drop point.\n+\n+                    int offsetX = x - be.x;\n+                    int offsetY = y - be.y;\n+\n+                    gc.setForeground(gc.registerColor(0x00FFFF00));\n \n+                    for (element in elements) {\n+                        drawElement(gc, element, offsetX, offsetY);\n+                    }\n+                }\n+            }\n         }\n     }\n \n-    void onDropLeave(INode targetNode, String fqcn, DropFeedback feedback) {\n+    void onDropLeave(INode targetNode, IDragElement[] elements, DropFeedback feedback) {\n         // Free the last captured rect, if any\n         feedback.captureArea = null;\n     }\n \n-    void onDropped(INode targetNode, String fqcn, DropFeedback feedback, Point p) {\n+    void onDropped(INode targetNode,\n+                   IDragElement[] elements,\n+                   DropFeedback feedback,\n+                   Point p) {\n         def data = feedback.userData;\n         if (!data.curr) {\n             return;\n         }\n \n         def index = data.index;\n+        def insertPos = data.insertPos;\n \n-        targetNode.debugPrintf(\""Relative.drop: add ${fqcn} after index ${index}\"");\n+        // Collect IDs from dropped elements and remap them to new IDs\n+        // if this is a copy or from a different canvas.\n+        def idMap = getDropIdMap(targetNode, elements, feedback.isCopy || !feedback.sameCanvas);\n \n-        // Get the last component of the FQCN (e.g. \""android.view.Button\"" => \""Button\"")\n-        String name = fqcn;\n-        name = name[name.lastIndexOf(\"".\"")+1 .. name.length()-1];\n+        targetNode.editXml(\""Add elements to RelativeLayout\"") {\n \n-        targetNode.editXml(\""Add ${name} to RelativeLayout\"") {\n-            INode e = targetNode.insertChildAt(fqcn, index + 1);\n+            // Now write the new elements.\n+            for (element in elements) {\n+                String fqcn = element.getFqcn();\n+                Rect be = element.getBounds();\n \n-            String id = null;\n-            if (data.child) {\n-                id = data.child.getStringAttr(\""id\"");\n-            }\n+                // index==-1 means to insert at the end.\n+                // Otherwise increment the insertion position.\n+                if (index >= 0) {\n+                    index++;\n+                }\n \n-            data.curr.attr.each {\n-                e.setAttribute(\""layout_${it}\"", id ? id : \""true\"");\n+                INode newChild = targetNode.insertChildAt(fqcn, index);\n+\n+                // Copy all the attributes, modifying them as needed.\n+                def attrFilter = getLayoutAttrFilter();\n+                addAttributes(newChild, element, idMap) {\n+                    uri, name, value ->\n+                    // TODO need a better way to exclude other layout attributes dynamically\n+                    if (uri == ANDROID_URI && name in attrFilter) {\n+                        return false; // don't set these attributes\n+                    } else {\n+                        return value;\n+                    }\n+                };\n+\n+// TODO... seems totally wrong. REVISIT or EXPLAIN\n+                String id = null;\n+                if (data.child) {\n+                    id = data.child.getStringAttr(ANDROID_URI, \""id\"");\n+                }\n+\n+                data.curr.attr.each {\n+                    newChild.setAttribute(ANDROID_URI, \""layout_${it}\"", id ? id : \""true\"");\n+                }\n+\n+                addInnerElements(newChild, element, idMap);\n             }\n         }\n     }\n"", ""DropFeedback.java"": ""@@ -51,6 +51,19 @@ public class DropFeedback {\n      */\n     public Rect captureArea;\n \n+    /**\n+     * Set to true by the drag'n'drop engine when the current drag operation is a copy.\n+     * When false the operation is a move and <em>after</em> a successful drop the source\n+     * elements will be deleted.\n+     */\n+    public boolean isCopy;\n+\n+    /**\n+     * Set to true when the drag'n'drop starts and ends in the same canvas of the\n+     * same Eclipse instance.\n+     */\n+    public boolean sameCanvas;\n+\n     /**\n      * Initializes the drop feedback with the given user data and paint closure.\n      * A paint is requested if the paint closure is non-null.\n"", ""IDragElement.java"": ""@@ -72,10 +72,18 @@ public interface IDragElement {\n \n     /**\n      * An XML attribute in the {@link IDragElement}.\n+     * <p/>\n+     * The attribute is always represented by a namespace URI, a name and a value.\n+     * The name cannot be empty.\n+     * The namespace URI can be empty for an attribute without a namespace but is never null.\n+     * The value can be empty but cannot be null.\n      */\n     public interface IDragAttribute {\n \n-        /** Returns the namespace URI of the attribute. Cannot be null nor empty. */\n+        /**\n+         * Returns the namespace URI of the attribute.\n+         * Can be empty for an attribute without a namespace but is never null.\n+         */\n         public abstract String getUri();\n \n         /** Returns the XML local name of the attribute. Cannot be null nor empty. */\n"", ""INode.java"": ""@@ -17,6 +17,8 @@\n \n package com.android.ide.eclipse.adt.editors.layout.gscripts;\n \n+import com.android.ide.eclipse.adt.editors.layout.gscripts.IDragElement.IDragAttribute;\n+\n import groovy.lang.Closure;\n \n \n@@ -168,10 +170,35 @@ public interface INode {\n      */\n     public IAttributeInfo getAttributeInfo(String uri, String attrName);\n \n+\n+    /**\n+     * Returns the list of all attributes defined in the XML for this node.\n+     * <p/>\n+     * This looks up an attribute in the <em>current</em> XML source, not the in-memory model.\n+     * That means that if called in the context of {@link #editXml(String, Closure)}, the value\n+     * returned here is not affected by {@link #setAttribute(String, String, String)} until\n+     * the editXml closure is completed and the actual XML is updated.\n+     *\n+     * @return A non-null possible-empty list of {@link IAttribute}.\n+     */\n+    public IAttribute[] getAttributes();\n+\n     // -----------\n \n     /** TODO: this is a hack. Shouldn't be here but instead part of some kind of helper\n      *  given to IViewRule implementations.\n      */\n     void debugPrintf(String msg, Object...params);\n+\n+    // -----------\n+\n+    /**\n+     * An XML attribute in an {@link INode}.\n+     * <p/>\n+     * The attribute is always represented by a namespace URI, a name and a value.\n+     * The name cannot be empty.\n+     * The namespace URI can be empty for an attribute without a namespace but is never null.\n+     * The value can be empty but cannot be null.\n+     */\n+    public static interface IAttribute extends IDragAttribute { }\n }\n"", ""IViewRule.java"": ""@@ -170,8 +170,6 @@ public interface IViewRule {\n     void onDropped(INode targetNode,\n             IDragElement[] elements,\n             DropFeedback feedback,\n-            Point where,\n-            boolean isCopy,\n-            boolean sameCanvas);\n+            Point where);\n \n }\n"", ""CanvasDropListener.java"": ""@@ -209,6 +209,8 @@ import java.util.Arrays;\n     public void dropAccept(DropTargetEvent event) {\n         AdtPlugin.printErrorToConsole(\""DEBUG\"", \""drop accept\"");\n \n+        checkDataType(event);\n+\n         // If we have a valid target node and it matches the one we saved in\n         // dragLeave then we restore the DropFeedback that we saved in dragLeave.\n         if (mLeaveTargetNode != null) {\n@@ -216,17 +218,14 @@ import java.util.Arrays;\n             mFeedback = mLeaveFeedback;\n             mCurrentView = mLeaveView;\n         }\n-        mLeaveTargetNode = null;\n-        mLeaveFeedback = null;\n-        mLeaveView = null;\n-\n-        checkDataType(event);\n \n-        if (event.detail != DND.DROP_NONE) {\n-            processDropEvent(event);\n-        } else {\n+        if (mLeaveTargetNode == null || event.detail == DND.DROP_NONE) {\n             clearDropInfo();\n         }\n+\n+        mLeaveTargetNode = null;\n+        mLeaveFeedback = null;\n+        mLeaveView = null;\n     }\n \n     /*\n@@ -263,20 +262,31 @@ import java.util.Arrays;\n \n         Point where = mCanvas.displayToCanvasPoint(event.x, event.y);\n \n-        boolean isCopy = event.detail == DND.DROP_COPY;\n-        boolean sameCanvas = mCanvas == mGlobalDragInfo.getSourceCanvas();\n-\n+        updateDropFeedback(mFeedback, event);\n         mCanvas.getRulesEngine().callOnDropped(mTargetNode,\n                 elements,\n                 mFeedback,\n-                where,\n-                isCopy,\n-                sameCanvas);\n+                where);\n \n         clearDropInfo();\n         mCanvas.redraw();\n     }\n \n+    /**\n+     * Updates the {@link DropFeedback#isCopy} and {@link DropFeedback#sameCanvas} fields\n+     * of the given {@link DropFeedback}. This is generally called right before invoking\n+     * one of the callOnXyz methods of GRE to refresh the fields.\n+     *\n+     * @param df The current {@link DropFeedback}.\n+     * @param event An optional event to determine if the current operaiton is copy or move.\n+     */\n+    private void updateDropFeedback(DropFeedback df, DropTargetEvent event) {\n+        if (event != null) {\n+            df.isCopy = event.detail == DND.DROP_COPY;\n+        }\n+        df.sameCanvas = mCanvas == mGlobalDragInfo.getSourceCanvas();\n+    }\n+\n     /**\n      * Invoked by the canvas to refresh the display.\n      * @param gCWrapper The GC wrapper, never null.\n@@ -371,37 +381,46 @@ import java.util.Arrays;\n \n             } else {\n                 // vi is a new current view.\n-                // Query GRE for onDropEnter on the view till we find one that returns a non-null\n-                // object.\n+                // Query GRE for onDropEnter on the ViewInfo hierarchy, starting from the child\n+                // towards its parent, till we find one that returns a non-null drop feedback.\n \n                 DropFeedback df = null;\n                 NodeProxy targetNode = null;\n-                boolean invalidTarget = false;\n-\n-                if (mCanvas == mGlobalDragInfo.getSourceCanvas()) {\n-                    // If we're drag'n'drop in the same canvas, none of the objects being\n-                    // dragged should be considered as valid targets.\n-                    CanvasSelection[] selection = mGlobalDragInfo.getCurrentSelection();\n-                    if (selection != null) {\n-                        for (CanvasSelection cs : selection) {\n-                            if (cs.getViewInfo() == vi) {\n-                                invalidTarget = true;\n-                                break;\n+\n+                for (CanvasViewInfo targetVi = vi;\n+                     targetVi != null && df == null;\n+                     targetVi = targetVi.getParent()) {\n+                    targetNode = mCanvas.getNodeFactory().create(targetVi);\n+                    df = mCanvas.getRulesEngine().callOnDropEnter(targetNode,\n+                                                                  mCurrentDragElements);\n+\n+                    if (df != null &&\n+                            event.detail == DND.DROP_MOVE &&\n+                            mCanvas == mGlobalDragInfo.getSourceCanvas()) {\n+                        // You can't move an object into itself in the same canvas.\n+                        // E.g. case of moving a layout and the node under the mouse is the\n+                        // layout itself: a copy would be ok but not a move operation of the\n+                        // layout into himself.\n+\n+                        CanvasSelection[] selection = mGlobalDragInfo.getCurrentSelection();\n+                        if (selection != null) {\n+                            for (CanvasSelection cs : selection) {\n+                                if (cs.getViewInfo() == targetVi) {\n+                                    // The node that responded is one of the selection roots.\n+                                    // Simply invalidate the drop feedback and move on the\n+                                    // parent in the ViewInfo chain.\n+\n+                                    updateDropFeedback(df, event);\n+                                    mCanvas.getRulesEngine().callOnDropLeave(\n+                                            targetNode, mCurrentDragElements, df);\n+                                    df = null;\n+                                    targetNode = null;\n+                                }\n                             }\n                         }\n                     }\n                 }\n \n-                if (!invalidTarget) {\n-                    for (CanvasViewInfo targetVi = vi;\n-                            targetVi != null && df == null;\n-                            targetVi = targetVi.getParent()) {\n-                        targetNode = mCanvas.getNodeFactory().create(targetVi);\n-                        df = mCanvas.getRulesEngine().callOnDropEnter(targetNode,\n-                                                                      mCurrentDragElements);\n-                    }\n-                }\n-\n                 if (df != null && targetNode != mTargetNode) {\n                     // We found a new target node for the drag'n'drop.\n                     // Release the previous one, if any.\n@@ -435,11 +454,14 @@ import java.util.Arrays;\n             // this is a move inside the same view\n             com.android.ide.eclipse.adt.editors.layout.gscripts.Point p2 =\n                 new com.android.ide.eclipse.adt.editors.layout.gscripts.Point(x, y);\n+            updateDropFeedback(mFeedback, event);\n             DropFeedback df = mCanvas.getRulesEngine().callOnDropMove(\n                     mTargetNode, mCurrentDragElements, mFeedback, p2);\n             if (df == null) {\n                 // The target is no longer interested in the drop move.\n                 callDropLeave();\n+            } else if (df != mFeedback) {\n+                mFeedback = df;\n             }\n         }\n \n@@ -454,6 +476,7 @@ import java.util.Arrays;\n      */\n     private void callDropLeave() {\n         if (mTargetNode != null && mFeedback != null) {\n+            updateDropFeedback(mFeedback, null);\n             mCanvas.getRulesEngine().callOnDropLeave(mTargetNode, mCurrentDragElements, mFeedback);\n         }\n \n"", ""SimpleAttribute.java"": ""@@ -17,6 +17,7 @@\n package com.android.ide.eclipse.adt.internal.editors.layout.gle2;\n \n import com.android.ide.eclipse.adt.editors.layout.gscripts.IDragElement.IDragAttribute;\n+import com.android.ide.eclipse.adt.editors.layout.gscripts.INode.IAttribute;\n \n import java.util.regex.Matcher;\n import java.util.regex.Pattern;\n@@ -24,31 +25,39 @@ import java.util.regex.Pattern;\n /**\n  * Represents one XML attribute in a {@link SimpleElement}.\n  * <p/>\n- * The attribute is always represented by a namespace URI, a name and a value, none of which\n- * can be null. The name and URI cannot be empty.\n+ * The attribute is always represented by a namespace URI, a name and a value.\n+ * The name cannot be empty.\n+ * The namespace URI can be empty for an attribute without a namespace but is never null.\n+ * The value can be empty but cannot be null.\n  * <p/>\n  * For a more detailed explanation of the purpose of this class,\n  * please see {@link SimpleXmlTransfer}.\n  */\n-public class SimpleAttribute implements IDragAttribute {\n+public class SimpleAttribute implements IDragAttribute, IAttribute {\n     private final String mName;\n     private final String mValue;\n     private final String mUri;\n \n     /**\n      * Creates a new {@link SimpleAttribute}.\n+     * <p/>\n+     * Any null value will be converted to an empty non-null string.\n+     * However it is a semantic error to use an empty name -- no assertion is done though.\n      *\n-     * @param uri The URI of the attribute. Cannot be null nor empty.\n-     * @param name The XML local name of the attribute. Cannot be null nor empty.\n-     * @param value The value of the attribute. Can be empty but not null.\n+     * @param uri The URI of the attribute.\n+     * @param name The XML local name of the attribute.\n+     * @param value The value of the attribute.\n      */\n     public SimpleAttribute(String uri, String name, String value) {\n-        mUri = uri;\n-        mName = name;\n-        mValue = value;\n+        mUri = uri == null ? \""\"" : uri;\n+        mName = name == null ? \""\"" : name;\n+        mValue = value == null ? \""\"" : value;\n     }\n \n-    /** Returns the namespace URI of the attribute. Cannot be null nor empty. */\n+    /**\n+     * Returns the namespace URI of the attribute.\n+     * Can be empty for an attribute without a namespace but is never null.\n+     */\n     public String getUri() {\n         return mUri;\n     }\n@@ -67,11 +76,14 @@ public class SimpleAttribute implements IDragAttribute {\n \n     @Override\n     public String toString() {\n-        return String.format(\""@%s:%s=%s\\n\"", mName, mUri, mValue);    //$NON-NLS-1$\n+        return String.format(\""@%s:%s=%s\\n\"", //$NON-NLS-1$\n+                mName,\n+                mUri,\n+                mValue);\n     }\n \n     private static final Pattern REGEXP =\n-        Pattern.compile(\""[^@]*@([^:]+):([^=]+)=([^\\n]*)\\n*\"");       //$NON-NLS-1$\n+        Pattern.compile(\""[^@]*@([^:]+):([^=]*)=([^\\n]*)\\n*\"");       //$NON-NLS-1$\n \n     static SimpleAttribute parseString(String value) {\n         Matcher m = REGEXP.matcher(value);\n"", ""NodeProxy.java"": ""@@ -28,6 +28,7 @@ import com.android.ide.eclipse.adt.internal.editors.descriptors.ElementDescripto\n import com.android.ide.eclipse.adt.internal.editors.layout.LayoutEditor;\n import com.android.ide.eclipse.adt.internal.editors.layout.descriptors.LayoutDescriptors;\n import com.android.ide.eclipse.adt.internal.editors.layout.descriptors.ViewElementDescriptor;\n+import com.android.ide.eclipse.adt.internal.editors.layout.gle2.SimpleAttribute;\n import com.android.ide.eclipse.adt.internal.editors.layout.uimodel.UiViewElementNode;\n import com.android.ide.eclipse.adt.internal.editors.uimodel.UiAttributeNode;\n import com.android.ide.eclipse.adt.internal.editors.uimodel.UiDocumentNode;\n@@ -317,6 +318,33 @@ public class NodeProxy implements INode {\n         return null;\n     }\n \n+    public IAttribute[] getAttributes() {\n+        UiElementNode uiNode = mNode;\n+\n+        if (uiNode.getXmlNode() != null) {\n+            Node xmlNode = uiNode.getXmlNode();\n+            if (xmlNode != null) {\n+                NamedNodeMap nodeAttributes = xmlNode.getAttributes();\n+                if (nodeAttributes != null) {\n+\n+                    int n = nodeAttributes.getLength();\n+                    IAttribute[] result = new IAttribute[n];\n+                    for (int i = 0; i < n; i++) {\n+                        Node attr = nodeAttributes.item(i);\n+                        String uri = attr.getNamespaceURI();\n+                        String name = attr.getLocalName();\n+                        String value = attr.getNodeValue();\n+\n+                        result[i] = new SimpleAttribute(uri, name, value);\n+                    }\n+                    return result;\n+                }\n+            }\n+        }\n+        return null;\n+\n+    }\n+\n \n     // --- internal helpers ---\n \n"", ""RulesEngine.java"": ""@@ -294,15 +294,13 @@ public class RulesEngine {\n     public void callOnDropped(NodeProxy targetNode,\n             IDragElement[] elements,\n             DropFeedback feedback,\n-            Point where,\n-            boolean isCopy,\n-            boolean sameCanvas) {\n+            Point where) {\n         // try to find a rule for this element's FQCN\n         IViewRule rule = loadRule(targetNode.getNode());\n \n         if (rule != null) {\n             try {\n-                rule.onDropped(targetNode, elements, feedback, where, isCopy, sameCanvas);\n+                rule.onDropped(targetNode, elements, feedback, where);\n \n             } catch (Exception e) {\n                 logError(\""%s.onDropped() failed: %s\"",\n""}","feature
"
23554,Brian Muramatsu,location provider fixes: test the provider without assuming presence of any particular provider on the device,['tests/tests/location/src/android/location/cts/LocationProviderTest.java'],"location provider fixes: test the provider without assuming presence of any particular provider on the device

Change-Id: Ibac21f9f29f8ab5583cadae8e4a6dded209ebe67",https://android-review.googlesource.com/c/23554,"test
",test,Bug;Test;,"{""LocationProviderTest.java"": ""@@ -28,6 +28,8 @@ import android.test.AndroidTestCase;\n \n @TestTargetClass(LocationProvider.class)\n public class LocationProviderTest extends AndroidTestCase {\n+    private static final String PROVIDER_NAME = \""location_provider_test\"";\n+\n     private LocationManager mLocationManager;\n \n     @Override\n@@ -35,6 +37,31 @@ public class LocationProviderTest extends AndroidTestCase {\n         super.setUp();\n         mLocationManager =\n             (LocationManager) getContext().getSystemService(Context.LOCATION_SERVICE);\n+        addTestProvider(PROVIDER_NAME);\n+    }\n+\n+    @Override\n+    protected void tearDown() throws Exception {\n+        mLocationManager.removeTestProvider(PROVIDER_NAME);\n+        super.tearDown();\n+    }\n+\n+    /**\n+     * Adds a test provider with the given name.\n+     */\n+    private void addTestProvider(String providerName) {\n+        mLocationManager.addTestProvider(\n+                providerName,\n+                true,  // requiresNetwork,\n+                false, // requiresSatellite,\n+                false, // requiresCell,\n+                false, // hasMonetaryCost,\n+                true,  // supportsAltitude,\n+                false, // supportsSpeed,\n+                true,  // supportsBearing,\n+                Criteria.POWER_MEDIUM,   // powerRequirement,\n+                Criteria.ACCURACY_FINE); // accuracy\n+        mLocationManager.setTestProviderEnabled(providerName, true);\n     }\n \n     @TestTargetNew(\n@@ -43,9 +70,8 @@ public class LocationProviderTest extends AndroidTestCase {\n         args = {}\n     )\n     public void testGetName() {\n-        String name = \""gps\"";\n-        LocationProvider locationProvider = mLocationManager.getProvider(name);\n-        assertEquals(name, locationProvider.getName());\n+        LocationProvider locationProvider = mLocationManager.getProvider(PROVIDER_NAME);\n+        assertEquals(PROVIDER_NAME, locationProvider.getName());\n     }\n \n     @TestTargetNew(\n@@ -54,7 +80,7 @@ public class LocationProviderTest extends AndroidTestCase {\n         args = {android.location.Criteria.class}\n     )\n     public void testMeetsCriteria() {\n-        LocationProvider locationProvider = mLocationManager.getProvider(\""gps\"");\n+        LocationProvider locationProvider = mLocationManager.getProvider(PROVIDER_NAME);\n \n         Criteria criteria = new Criteria();\n         criteria.setAltitudeRequired(true);\n""}","test 
"
11817,npelly,Bluetooth: Fix kernel panic while disconnecting RFCOMM,['net/bluetooth/rfcomm/core.c'],"Bluetooth: Fix kernel panic while disconnecting RFCOMM

rfcomm_session_del() was being called after session entry removed from list.

Signed-off-by: Nick Pelly <npelly@google.com>
",https://android-review.googlesource.com/c/11817,"bug
",bug,Bug;Deprecat;,"{""core.c"": ""@@ -1795,6 +1795,8 @@ static inline void rfcomm_process_rx(struct rfcomm_session *s)\n \n \tBT_DBG(\""session %p state %ld qlen %d\"", s, s->state, skb_queue_len(&sk->sk_receive_queue));\n \n+\trfcomm_session_hold(s);\n+\n \t/* Get data directly from socket receive queue without copying it. */\n \twhile ((skb = skb_dequeue(&sk->sk_receive_queue))) {\n \t\tskb_orphan(skb);\n@@ -1807,6 +1809,8 @@ static inline void rfcomm_process_rx(struct rfcomm_session *s)\n \n \t\trfcomm_session_close(s, sk->sk_err);\n \t}\n+\n+\trfcomm_session_put(s);\n }\n \n static inline void rfcomm_accept_connection(struct rfcomm_session *s)\n""}","bug 
"
23810,Howard M. Harte,net: wireless: bcmdhd: Fix get_customized_country_code() for older kernels.,['drivers/net/wireless/bcmdhd/dhd_custom_gpio.c'],"net: wireless: bcmdhd: Fix get_customized_country_code() for older kernels.

Change-Id: I8d4f5f9b73b3a4dc9c31e627a422f7fc180414c6
Signed-off-by: Howard M. Harte <hharte@broadcom.com>",https://android-review.googlesource.com/c/23810,"bug
",bug,Bug;,"{""dhd_custom_gpio.c"": ""@@ -41,7 +41,7 @@\n extern  void bcm_wlan_power_off(int);\n extern  void bcm_wlan_power_on(int);\n #endif /* CUSTOMER_HW */\n-#if  defined(CUSTOMER_HW2)\n+#if defined(CUSTOMER_HW2)\n #ifdef CONFIG_WIFI_CONTROL_FUNC\n int wifi_set_carddetect(int on);\n int wifi_set_power(int on, unsigned long msec);\n@@ -54,8 +54,8 @@ int wifi_set_power(int on, unsigned long msec) { return -1; }\n int wifi_get_irq_number(unsigned long *irq_flags_ptr) { return -1; }\n int wifi_get_mac_addr(unsigned char *buf) { return -1; }\n void *wifi_get_country_code(char *ccode) { return NULL; }\n-#endif\n-#endif\n+#endif /* CONFIG_WIFI_CONTROL_FUNC */\n+#endif /* CUSTOMER_HW2 */\n \n #if defined(OOB_INTR_ONLY)\n \n@@ -253,7 +253,7 @@ const struct cntry_locales_custom translate_custom_table[] = {\n */\n void get_customized_country_code(char *country_iso_code, wl_country_t *cspec)\n {\n-#ifdef CUSTOMER_HW2\n+#if defined(CUSTOMER_HW2) && (LINUX_VERSION_CODE >= KERNEL_VERSION(2, 6, 39))\n \tstruct cntry_locales_custom *cloc_ptr;\n \n \tif (!cspec)\n@@ -290,5 +290,5 @@ void get_customized_country_code(char *country_iso_code, wl_country_t *cspec)\n \tcspec->rev = translate_custom_table[0].custom_locale_rev;\n #endif /* EXMAPLE_TABLE */\n \treturn;\n-#endif\n+#endif /* defined(CUSTOMER_HW2) && (LINUX_VERSION_CODE >= KERNEL_VERSION(2, 6, 39)) */\n }\n""}","bug 
"
22071,Bruce Beare,x86: define __ANDROID__ and set correct CFLAGS variable,['toolchains/x86-4.4.3/setup.mk'],"x86: define __ANDROID__ and set correct CFLAGS variable

Change-Id: Ic3539c6c4c06662d2304ee9f4dc00080adb77ab3
Signed-off-by: Bruce Beare <bruce.j.beare@intel.com>",https://android-review.googlesource.com/c/22071,"bug, refactor 
",reource;bug,Bug;Deprecat;Resource;,"{""setup.mk"": ""@@ -26,7 +26,8 @@\n TOOLCHAIN_NAME   := x86-4.4.3\n TOOLCHAIN_PREFIX := $(TOOLCHAIN_PREBUILT_ROOT)/bin/i686-android-linux-\n \n-TARGET_CFLAGS.common := \\\n+TARGET_CFLAGS := \\\n+    -D__ANDROID__ \\\n     -mbionic \\\n     -I$(SYSROOT)/usr/include \\\n     -march=atom -mstackrealign -DUSE_SSSE3 -DUSE_SSE2 -mfpmath=sse \\\n""}","bug 
"
23670,Xavier Ducrohet,CherryPick aef49b24 from master to r12. do not merge.,['files/proguard.cfg'],"CherryPick aef49b24 from master to r12. do not merge.

Fix proguard template to avoid shrinking XML-only references

See 16384: ProGuard template generated by the ADT is flawed

Change-Id: Ibf4510cc4ad9aafec2712326053e80d80599add4",https://android-review.googlesource.com/c/23670,"bug, merge 
","bug,merge",Bug;Resource;,"{""proguard.cfg"": ""@@ -18,14 +18,18 @@\n     native <methods>;\n }\n \n--keepclasseswithmembernames class * {\n+-keepclasseswithmembers class * {\n     public <init>(android.content.Context, android.util.AttributeSet);\n }\n \n--keepclasseswithmembernames class * {\n+-keepclasseswithmembers class * {\n     public <init>(android.content.Context, android.util.AttributeSet, int);\n }\n \n+-keepclassmembers class * extends android.app.Activity {\n+   public void *(android.view.View);\n+}\n+\n -keepclassmembers enum * {\n     public static **[] values();\n     public static ** valueOf(java.lang.String);\n""}","merge 
"
16931,Colin Cross,[ARM] tegra: suspend: preserve timer configuration across suspend,"['arch/arm/mach-tegra/include/mach/suspend.h', 'arch/arm/mach-tegra/suspend.c']","[ARM] tegra: suspend: preserve timer configuration across suspend

Change-Id: Ia1509d5dfad42dcbdab4c7cf54fa52ec9b918128
Signed-off-by: Colin Cross <ccross@google.com>",https://android-review.googlesource.com/c/16931,"Categories: **feature** 
",feature,Resource;,"{""suspend.h"": ""@@ -55,12 +55,14 @@ void tegra_irq_suspend(void);\n void tegra_gpio_suspend(void);\n void tegra_clk_suspend(void);\n void tegra_dma_suspend(void);\n+void tegra_timer_suspend(void);\n \n void tegra_pinmux_resume(void);\n void tegra_irq_resume(void);\n void tegra_gpio_resume(void);\n void tegra_clk_resume(void);\n void tegra_dma_resume(void);\n+void tegra_timer_resume(void);\n \n int tegra_irq_to_wake(int irq);\n int tegra_wake_to_irq(int wake);\n"", ""suspend.c"": ""@@ -479,6 +479,7 @@ static int tegra_suspend_enter(suspend_state_t state)\n \t\ttegra_dma_suspend();\n \t\ttegra_debug_uart_suspend();\n \t\ttegra_pinmux_suspend();\n+\t\ttegra_timer_suspend();\n \t\ttegra_gpio_suspend();\n \t\ttegra_clk_suspend();\n \n@@ -514,6 +515,7 @@ static int tegra_suspend_enter(suspend_state_t state)\n \n \t\ttegra_clk_resume();\n \t\ttegra_gpio_resume();\n+\t\ttegra_timer_resume();\n \t\ttegra_pinmux_resume();\n \t\ttegra_debug_uart_resume();\n \t\ttegra_dma_resume();\n""}","bug, feature 
"
15977,Rebecca Zavin,[ARM] tegra: Fix tegra_fiq_debugger include path to legacy_irq.h,['arch/arm/mach-tegra/tegra_fiq_debugger.c'],"[ARM] tegra: Fix tegra_fiq_debugger include path to legacy_irq.h

Change-Id: I44e4084dd0f6b9901da0dd691b7f52e6f4b8d29e
Signed-off-by: Rebecca Schultz Zavin <rebecca@android.com>",https://android-review.googlesource.com/c/15977,"bug 
",bug,Bug;,"{""tegra_fiq_debugger.c"": ""@@ -30,7 +30,7 @@\n \n #include <linux/uaccess.h>\n \n-#include \""legacy_irq.h\""\n+#include <mach/legacy_irq.h>\n \n #define UART_THR_DLAB\t0x00\n #define UART_IER_DLAB\t0x04\n""}","bug 
"
16302,Brian Muramatsu,Fix Dpi2 Test Cases Makefile,['tests/tests/dpi2/Android.mk'],"Fix Dpi2 Test Cases Makefile

It was being put into /system/apps rather than /data/apps
like the other test cases.

Change-Id: Iab279e3bd1bf63d2ac4ef87d8b81b77a12af9443",https://android-review.googlesource.com/c/16302,"bug, test 
",bug;test,Bug;Resource;Test;,"{""Android.mk"": ""@@ -27,6 +27,8 @@ LOCAL_PACKAGE_NAME := CtsDpiTestCases2\n \n LOCAL_MODULE_TAGS := optional\n \n+LOCAL_MODULE_PATH := $(TARGET_OUT_DATA_APPS)\n+\n # We would set LOCAL_SDK_VERSION := 3 here, but the build system\n # doesn't currently support setting LOCAL_SDK_VERSION to anything but\n # current.\n""}","test 
"
18726,Brett Chabot,Fix opcode tests for const-class and filled-new-array,"['tools/vm-tests/src/dot/junit/opcodes/const_class/d/T_const_class_7.d', 'tools/vm-tests/src/dot/junit/opcodes/filled_new_array/d/T_filled_new_array_11.d', 'tools/vm-tests/src/dot/junit/opcodes/filled_new_array/TestStubs.java', 'tools/vm-tests/src/dot/junit/opcodes/const_class/TestStubs.java', 'tools/vm-tests/src/dot/junit/opcodes/filled_new_array/Test_filled_new_array.java', 'tools/vm-tests/src/dot/junit/opcodes/const_class/Test_const_class.java', 'tools/vm-tests/src/dot/junit/opcodes/filled_new_array/d/T_filled_new_array_10.java', 'tools/vm-tests/src/dot/junit/opcodes/filled_new_array/d/T_filled_new_array_11.java']","Fix opcode tests for const-class and filled-new-array

Bug 3147582

Change-Id: Ib74bd8b9d72c834251b9f073fe138985b86dfacf",https://android-review.googlesource.com/c/18726,"bug, test 
","bug,test",Bug;Test;,"{""TestStubs.java"": ""@@ -16,9 +16,6 @@\n \n package dot.junit.opcodes.filled_new_array;\n \n-public class TestStubs {\n-    @SuppressWarnings(\""unused\"")\n-    private class TestStub{\n-        // used by T_filled_new_array_11\n-    }\n+// used by T_filled_new_array_11\n+class TestStubs {\n }\n"", ""Test_const_class.java"": ""@@ -61,16 +61,14 @@ public class Test_const_class extends DxTestCase {\n      * @title Class is not accessible\n      */\n     public void testE2() {\n-        //@uses dot.junit.opcodes.const_class.TestStubs$TestStub\n+        //@uses dot.junit.opcodes.const_class.TestStubs\n         //@uses dot.junit.opcodes.const_class.d.T_const_class_7\n         try {\n             T_const_class_7 t = new T_const_class_7();\n             t.run();\n-            fail(\""expected a verification exception\"");\n+            fail(\""expected a IllegalAccessError exception\"");\n         } catch (IllegalAccessError e) {\n             // expected\n-        } catch(VerifyError e) {\n-            // expected\n         }\n     }\n     \n"", ""T_const_class_7.d"": ""@@ -27,7 +27,7 @@\n .method public run()Ljava/lang/Class;\n .limit regs 255\n \n-       const-class v254, dot/junit/opcodes/const_class/TestStubs$TestStub\n+       const-class v254, dot/junit/opcodes/const_class/TestStubs\n        return-object v254\n .end method\n \n"", ""Test_filled_new_array.java"": ""@@ -19,8 +19,9 @@ package dot.junit.opcodes.filled_new_array;\n import dot.junit.DxTestCase;\n import dot.junit.DxUtil;\n import dot.junit.opcodes.filled_new_array.d.T_filled_new_array_1;\n+import dot.junit.opcodes.filled_new_array.d.T_filled_new_array_10;\n+import dot.junit.opcodes.filled_new_array.d.T_filled_new_array_11;\n import dot.junit.opcodes.filled_new_array.d.T_filled_new_array_2;\n-import dot.junit.opcodes.filled_new_array.d.T_filled_new_array_9;\n \n public class Test_filled_new_array extends DxTestCase {\n     /**\n@@ -145,11 +146,13 @@ public class Test_filled_new_array extends DxTestCase {\n      * @title attempt to instantiate array of non-existent class\n      */\n     public void testVFE8() {\n+        //@uses dot.junit.opcodes.filled_new_array.d.T_filled_new_array_10\n         try {\n-            Class.forName(\""dot.junit.opcodes.filled_new_array.d.T_filled_new_array_10\"");\n-            fail(\""expected a verification exception\"");\n-        } catch(Throwable t) {\n-            DxUtil.checkVerifyException(t);    \n+            T_filled_new_array_10 T = new T_filled_new_array_10();\n+            T.run();\n+            fail(\""expected a NoClassDefFoundError exception\"");\n+        } catch(NoClassDefFoundError t) {\n+            // expected\n         }\n     }\n     \n@@ -161,10 +164,11 @@ public class Test_filled_new_array extends DxTestCase {\n         //@uses dot.junit.opcodes.filled_new_array.d.T_filled_new_array_11\n         //@uses dot.junit.opcodes.filled_new_array.TestStubs\n         try {\n-            Class.forName(\""dot.junit.opcodes.filled_new_array.d.T_filled_new_array_11\"");\n-            fail(\""expected a verification exception\"");\n-        } catch(Throwable t) {\n-            DxUtil.checkVerifyException(t);    \n+            T_filled_new_array_11 T = new T_filled_new_array_11();\n+            T.run();\n+            fail(\""expected a IllegalAccessError exception\"");\n+        } catch(IllegalAccessError t) {\n+            // expected\n         }\n     }\n     \n"", ""T_filled_new_array_10.java"": ""@@ -0,0 +1,23 @@\n+/*\n+ * Copyright (C) 2008 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package dot.junit.opcodes.filled_new_array.d;\n+\n+public class T_filled_new_array_10 {\n+    public Object[] run() {\n+        return null;\n+    }\n+}\n"", ""T_filled_new_array_11.d"": ""@@ -27,7 +27,7 @@\n .method public run()[Ljava/lang/Object;\n .limit regs 10\n     const v9, 0\n-    filled-new-array {v9}, [Ldot/junit/opcodes/filled_new_array/TestStubs$TestStub;\n+    filled-new-array {v9}, [Ldot/junit/opcodes/filled_new_array/TestStubs;\n     move-result-object v0\n     return-object v0\n .end method\n"", ""T_filled_new_array_11.java"": ""@@ -0,0 +1,23 @@\n+/*\n+ * Copyright (C) 2008 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package dot.junit.opcodes.filled_new_array.d;\n+\n+public class T_filled_new_array_11 {\n+    public Object[] run() {\n+        return null;\n+    }\n+}\n""}","test 
"
20238,Tor Norbye,Fix copyright and clarify silent logger,"['eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/RenderLogger.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/PaletteControl.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/GraphicalEditorPart.java']","Fix copyright and clarify silent logger

Fix missing header in previous checkin.

Also remove the silent logger from the render() method, and create the
silent logger in the palette preview drag where it's more obvious why
the rendering is quiet.

Change-Id: I80d2be0c40d00589182988262f1d0f2e64ee4dd4",https://android-review.googlesource.com/c/20238,"bug, refactor
","refactor,bug",Bug;Deprecat;,"{""GraphicalEditorPart.java"": ""@@ -1198,10 +1198,12 @@ public class GraphicalEditorPart extends EditorPart\n      * @param transparentBackground If true, the rendering will <b>not</b> paint the\n      *            normal background requested by the theme, and it will instead paint the\n      *            background using a fully transparent background color\n+     * @param logger a logger where rendering errors are reported\n      * @return the resulting rendered image wrapped in an {@link RenderSession}\n      */\n     public RenderSession render(UiDocumentNode model, int width, int height,\n-            Set<UiElementNode> explodeNodes, boolean transparentBackground) {\n+            Set<UiElementNode> explodeNodes, boolean transparentBackground,\n+            LayoutLog logger) {\n         if (!ensureFileValid()) {\n             return null;\n         }\n@@ -1212,7 +1214,7 @@ public class GraphicalEditorPart extends EditorPart\n \n         IProject iProject = mEditedFile.getProject();\n         return renderWithBridge(iProject, model, layoutLib, width, height, explodeNodes,\n-                transparentBackground, new LayoutLog());\n+                transparentBackground, logger);\n     }\n \n     /**\n"", ""PaletteControl.java"": ""@@ -24,11 +24,12 @@ import static com.android.ide.common.layout.LayoutConstants.VALUE_WRAP_CONTENT;\n \n import com.android.ide.common.api.InsertType;\n import com.android.ide.common.api.Rect;\n-import com.android.ide.eclipse.adt.internal.editors.IconFactory;\n import com.android.ide.common.rendering.LayoutLibrary;\n import com.android.ide.common.rendering.api.Capability;\n+import com.android.ide.common.rendering.api.LayoutLog;\n import com.android.ide.common.rendering.api.RenderSession;\n import com.android.ide.common.rendering.api.ViewInfo;\n+import com.android.ide.eclipse.adt.internal.editors.IconFactory;\n import com.android.ide.eclipse.adt.internal.editors.descriptors.DescriptorsUtils;\n import com.android.ide.eclipse.adt.internal.editors.descriptors.DocumentDescriptor;\n import com.android.ide.eclipse.adt.internal.editors.descriptors.ElementDescriptor;\n@@ -770,9 +771,9 @@ public class PaletteControl extends Composite {\n                 org.eclipse.draw2d.geometry.Rectangle screenBounds = editor.getScreenBounds();\n                 int renderWidth = Math.min(screenBounds.width, MAX_RENDER_WIDTH);\n                 int renderHeight = Math.min(screenBounds.height, MAX_RENDER_HEIGHT);\n-\n+                LayoutLog silentLogger = new LayoutLog();\n                 session = editor.render(model, renderWidth, renderHeight,\n-                    null /* explodeNodes */, hasTransparency);\n+                    null /* explodeNodes */, hasTransparency, silentLogger);\n             } catch (Throwable t) {\n                 // Previews can fail for a variety of reasons -- let's not bug\n                 // the user with it\n"", ""RenderLogger.java"": ""@@ -1,3 +1,18 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Eclipse Public License, Version 1.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.eclipse.org/org/documents/epl-v10.php\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n \n package com.android.ide.eclipse.adt.internal.editors.layout.gle2;\n \n""}","bug, refactor 
"
11512,Garret Pick,Remove code inside PV_PLAY_FROM_FILE_SUPPORT and PV_RECORD_TO_FILE_SUPPORT,"['engines/2way/src/pv_2way_preview_datapath.h', 'engines/2way/src/pv_2way_rec_datapath.h', 'engines/player/src/pv_player_sdkinfo.h', 'engines/2way/src/pv_2way_engine.h', 'engines/author/src/pv_author_sdkinfo.h', 'engines/2way/src/pv_2way_rec_datapath.cpp', 'engines/2way/src/pv_2way_data_channel_datapath.cpp', 'engines/2way/src/pv_2way_preview_datapath.cpp', 'engines/2way/Android.mk', 'engines/2way/src/pv_2way_engine.cpp', 'engines/2way/src/pv_2way_sdkinfo.h', 'engines/2way/build/make/local.mk']","Remove code inside PV_PLAY_FROM_FILE_SUPPORT and PV_RECORD_TO_FILE_SUPPORT
",https://android-review.googlesource.com/c/11512,"refactor,deprecate 
",deprecat:,Deprecat;,,"bug, refactor 
"
15690,Bruce Beare,Fix undefined reference to dl_iterate_phdr for x86,['libc/Android.mk'],"Fix undefined reference to dl_iterate_phdr for x86

Change-Id: I22410b27939e8f54da932d7a1104102550c4685f
Signed-off-by: Bruce Beare <brucex.j.beare@intel.com>",https://android-review.googlesource.com/c/15690,"bug 
",bug,Bug;Resource;,"{""Android.mk"": ""@@ -640,6 +640,7 @@ LOCAL_MODULE:= libc_malloc_debug_leak\n LOCAL_SHARED_LIBRARIES := libc\n LOCAL_WHOLE_STATIC_LIBRARIES := libc_common\n LOCAL_SYSTEM_SHARED_LIBRARIES :=\n+LOCAL_ALLOW_UNDEFINED_SYMBOLS := true\n # Don't prelink\n LOCAL_PRELINK_MODULE := false\n # Don't install on release build\n""}","bug 
"
13772,Colin Cross,[ARM] tegra: harmony: Add highmem and framebuffer to defconfig,['arch/arm/configs/harmony_defconfig'],"[ARM] tegra: harmony: Add highmem and framebuffer to defconfig

Change-Id: I10c833525cbd533654fde2770c12920a89bc36f7
Signed-off-by: Colin Cross <ccross@android.com>",https://android-review.googlesource.com/c/13772,"feature 
",resource,Resource;,"{""harmony_defconfig"": ""@@ -1,7 +1,7 @@\n #\n # Automatically generated make config: don't edit\n # Linux kernel version: 2.6.33-rc8\n-# Thu Feb 25 15:49:25 2010\n+# Fri Feb 26 18:32:26 2010\n #\n CONFIG_ARM=y\n CONFIG_SYS_SUPPORTS_APM_EMULATION=y\n@@ -306,7 +306,8 @@ CONFIG_AEABI=y\n # CONFIG_OABI_COMPAT is not set\n # CONFIG_ARCH_SPARSEMEM_DEFAULT is not set\n # CONFIG_ARCH_SELECT_MEMORY_MODEL is not set\n-# CONFIG_HIGHMEM is not set\n+CONFIG_HIGHMEM=y\n+# CONFIG_HIGHPTE is not set\n CONFIG_SELECT_MEMORY_MODEL=y\n CONFIG_FLATMEM_MANUAL=y\n # CONFIG_DISCONTIGMEM_MANUAL is not set\n@@ -317,6 +318,7 @@ CONFIG_PAGEFLAGS_EXTENDED=y\n CONFIG_SPLIT_PTLOCK_CPUS=4\n # CONFIG_PHYS_ADDR_T_64BIT is not set\n CONFIG_ZONE_DMA_FLAG=0\n+CONFIG_BOUNCE=y\n CONFIG_VIRT_TO_BUS=y\n # CONFIG_KSM is not set\n CONFIG_DEFAULT_MMAP_MIN_ADDR=4096\n@@ -1003,9 +1005,9 @@ CONFIG_FB=y\n # CONFIG_FIRMWARE_EDID is not set\n # CONFIG_FB_DDC is not set\n # CONFIG_FB_BOOT_VESA_SUPPORT is not set\n-# CONFIG_FB_CFB_FILLRECT is not set\n-# CONFIG_FB_CFB_COPYAREA is not set\n-# CONFIG_FB_CFB_IMAGEBLIT is not set\n+CONFIG_FB_CFB_FILLRECT=y\n+CONFIG_FB_CFB_COPYAREA=y\n+CONFIG_FB_CFB_IMAGEBLIT=y\n # CONFIG_FB_CFB_REV_PIXELS_IN_BYTE is not set\n # CONFIG_FB_SYS_FILLRECT is not set\n # CONFIG_FB_SYS_COPYAREA is not set\n@@ -1022,6 +1024,7 @@ CONFIG_FB=y\n # Frame buffer hardware drivers\n #\n # CONFIG_FB_S1D13XXX is not set\n+CONFIG_FB_TEGRA=y\n # CONFIG_FB_VIRTUAL is not set\n # CONFIG_FB_METRONOME is not set\n # CONFIG_FB_MB862XX is not set\n@@ -1433,6 +1436,7 @@ CONFIG_DEBUG_MUTEXES=y\n CONFIG_DEBUG_SPINLOCK_SLEEP=y\n # CONFIG_DEBUG_LOCKING_API_SELFTESTS is not set\n # CONFIG_DEBUG_KOBJECT is not set\n+# CONFIG_DEBUG_HIGHMEM is not set\n CONFIG_DEBUG_BUGVERBOSE=y\n CONFIG_DEBUG_INFO=y\n CONFIG_DEBUG_VM=y\n""}","resource 
"
12770,PacketVideo CM,RIO-7480: Removed parsing support for WMF AMR tracks from MP4 file parser.,"['fileformats/mp4/parser/include/isucceedfail.h', 'engines/player/src/pv_player_sdkinfo.h', 'nodes/pvmp4ffparsernode/src/pvmf_mp4ffparser_node.cpp', 'engines/author/src/pv_author_sdkinfo.h', 'nodes/pvmp4ffparsernode/include/pvmf_mp4ffparser_events.h', 'fileformats/mp4/parser/src/impeg4file.cpp', 'fileformats/mp4/parser/src/decoderconfigdescriptor.cpp', 'fileformats/mp4/parser/src/sampletableatom.cpp', 'fileformats/mp4/parser/src/sampledescriptionatom.cpp', 'fileformats/mp4/parser/src/mpeg4file.cpp', 'engines/2way/src/pv_2way_sdkinfo.h', 'fileformats/mp4/parser/utils/mp4recognizer/include/atomdefs.h']",RIO-7480: Removed parsing support for WMF AMR tracks from MP4 file parser.,https://android-review.googlesource.com/c/12770,"bug, refactor 
","deprecat,bug",Deprecat;,"{""pv_2way_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PV2WAY_ENGINE_SDKINFO_LABEL \""1107411\""\n+#define PV2WAY_ENGINE_SDKINFO_LABEL \""1107482\""\n #define PV2WAY_ENGINE_SDKINFO_DATE 0x20091124\n \n #endif //PV_2WAY_SDKINFO_H_INCLUDED\n"", ""pv_author_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""1107411\""\n+#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""1107482\""\n #define PVAUTHOR_ENGINE_SDKINFO_DATE 0x20091124\n \n #endif //PV_AUTHOR_SDKINFO_H_INCLUDED\n"", ""pv_player_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVPLAYER_ENGINE_SDKINFO_LABEL \""1107411\""\n+#define PVPLAYER_ENGINE_SDKINFO_LABEL \""1107482\""\n #define PVPLAYER_ENGINE_SDKINFO_DATE 0x20091124\n \n #endif //PV_PLAYER_SDKINFO_H_INCLUDED\n"", ""isucceedfail.h"": ""@@ -117,8 +117,6 @@ typedef enum {  READ_FAILED = -1,\n                 READ_DOWNLOAD_ATOM_FAILED = 72,\n                 READ_TRACK_INFO_ATOM_FAILED = 73,\n                 READ_REQUIREMENTS_ATOM_FAILED = 74,\n-                READ_WMF_SET_MEDIA_ATOM_FAILED = 75,\n-                READ_WMF_SET_SESSION_ATOM_FAILED = 76,\n                 READ_PV_USER_DATA_ATOM_FAILED = 77,\n                 READ_VIDEO_INFORMATION_ATOM_FAILED = 78,\n                 READ_RANDOM_ACCESS_ATOM_FAILED = 79,\n"", ""decoderconfigdescriptor.cpp"": ""@@ -79,10 +79,6 @@ DecoderConfigDescriptor::DecoderConfigDescriptor(MP4_FF_FILE *fp)\n                     {\n                         PV_MP4_FF_NEW(fp->auditCB, H263DecoderSpecificInfo, (fp), _pdecSpecificInfo);\n                     }\n-                    else if (_objectTypeIndication == AMR_AUDIO)\n-                    {\n-                        PV_MP4_FF_NEW(fp->auditCB, AMRDecoderSpecificInfo, (fp), _pdecSpecificInfo);\n-                    }\n                     else if (_objectTypeIndication == QCELP_MP4)\n                     {\n                         PV_MP4_FF_NEW(fp->auditCB, DecoderSpecificInfo, (fp), _pdecSpecificInfo);\n"", ""impeg4file.cpp"": ""@@ -189,7 +189,6 @@ IMpeg4File::IsXXXable(OSCL_wString& filename,\n             else if (majorBrand == BRAND_ISOM)  *pMajorBrand = EISOM;\n             else if (majorBrand == BRAND_MP41)  *pMajorBrand = EMP41;\n             else if (majorBrand == BRAND_MP42)  *pMajorBrand = EMP42;\n-            else if (majorBrand == WMF_BRAND)   *pMajorBrand = EWMF;\n             // else .. set to ENoFileType above\n \n             Oscl_Vector<uint32, OsclMemAllocator> *compatibleBrandArray =\n@@ -209,7 +208,6 @@ IMpeg4File::IsXXXable(OSCL_wString& filename,\n                     else if (compatibleBrand == BRAND_ISOM)     *pCompatibleBrands |= EISOM;\n                     else if (compatibleBrand == BRAND_MP41)     *pCompatibleBrands |= EMP41;\n                     else if (compatibleBrand == BRAND_MP42)     *pCompatibleBrands |= EMP42;\n-                    else if (compatibleBrand == WMF_BRAND)      *pCompatibleBrands |= EWMF;\n                 }\n             }\n         }//end of get file type\n@@ -365,7 +363,6 @@ IMpeg4File::IsXXXable(MP4_FF_FILE_REFERENCE fileRef,\n             else if (majorBrand == BRAND_ISOM)  *pMajorBrand = EISOM;\n             else if (majorBrand == BRAND_MP41)  *pMajorBrand = EMP41;\n             else if (majorBrand == BRAND_MP42)  *pMajorBrand = EMP42;\n-            else if (majorBrand == WMF_BRAND)   *pMajorBrand = EWMF;\n \n \n             Oscl_Vector<uint32, OsclMemAllocator> *compatibleBrandArray =\n@@ -386,7 +383,6 @@ IMpeg4File::IsXXXable(MP4_FF_FILE_REFERENCE fileRef,\n                     else if (compatibleBrand == BRAND_ISOM)     *pCompatibleBrands |= EISOM;\n                     else if (compatibleBrand == BRAND_MP41)     *pCompatibleBrands |= EMP41;\n                     else if (compatibleBrand == BRAND_MP42)     *pCompatibleBrands |= EMP42;\n-                    else if (compatibleBrand == WMF_BRAND)      *pCompatibleBrands |= EWMF;\n                 }\n             }\n         }//end of get file type\n"", ""mpeg4file.cpp"": ""@@ -265,10 +265,6 @@ Mpeg4File::Mpeg4File(MP4_FF_FILE *fp,\n \n                 switch (majorBrand)\n                 {\n-                    case WMF_BRAND:\n-                        majorBrandInfo |= EWMF;\n-                        break;\n-\n                     case BRAND_3GPP4:\n                         majorBrandInfo |= E3GP4;\n                         break;\n@@ -309,10 +305,6 @@ Mpeg4File::Mpeg4File(MP4_FF_FILE *fp,\n \n                         switch (compatibleBrand)\n                         {\n-                            case WMF_BRAND:\n-                                compatibleBrandInfo |= EWMF;\n-                                break;\n-\n                             case BRAND_3GPP4:\n                                 compatibleBrandInfo |= E3GP4;\n                                 break;\n"", ""sampledescriptionatom.cpp"": ""@@ -871,12 +871,8 @@ void SampleDescriptionAtom::getMIMEType(OSCL_String& aMimeType)\n \n     OSCL_HeapString<OsclMemAllocator> mimeType;\n     mimeType.set(PVMF_MIME_FORMAT_UNKNOWN, oscl_strlen(PVMF_MIME_FORMAT_UNKNOWN));\n-    if (objectType == AMR_AUDIO)\n-    {   //The OTI type 0xd0(AMR_AUDIO) is unique to WMF standard, which is a defunct spec.\n-        //Complete cleanup will be done later. Disable the WMF AMR track for now.\n-        //mimeType.set(PVMF_MIME_AMR, oscl_strlen(PVMF_MIME_AMR));\n-    }\n-    else if (objectType == AMR_AUDIO_3GPP)\n+\n+    if (objectType == AMR_AUDIO_3GPP)\n     {\n         mimeType.set(PVMF_MIME_AMR_IETF, oscl_strlen(PVMF_MIME_AMR_IETF));\n     }\n"", ""sampletableatom.cpp"": ""@@ -243,14 +243,7 @@ SampleTableAtom::SampleTableAtom(MP4_FF_FILE *fp,\n                     }\n                     else\n                     {\n-                        if (_psampleDescriptionAtom->getObjectTypeIndication() == AMR_AUDIO)\n-                        {\n-                            _numAMRFramesPerSample = 1;\n-                        }\n-                        else\n-                        {\n-                            _numAMRFramesPerSample = 0;\n-                        }\n+                        _numAMRFramesPerSample = 0;\n                     }\n                 }\n                 else\n@@ -2627,30 +2620,7 @@ SampleTableAtom::getNextNSamples(uint32 startSampleNum,\n                 return (_mp4ErrorCode);\n             }\n \n-#ifdef OUTPUT_AMR_TOC\n-            uint8 objectType = getObjectTypeIndication();\n-            if (objectType == AMR_AUDIO)\n-            {\n-                AMRDecoderSpecificInfo *pinfo =\n-                    (AMRDecoderSpecificInfo *)(getDecoderSpecificInfoForSDI(SDIndex));\n-\n-                if (pgau->info[s].sample_info != pinfo->getFrameType())\n-                {\n-                    pgau->info[s].sample_info = pinfo->getFrameType();\n-                }\n-                else\n-                {\n-                    pgau->info[s].sample_info = pinfo->getFrameType();\n-                }\n-\n-            }\n-            else\n-            {\n-                pgau->info[s].sample_info = SDIndex;\n-            }\n-#else\n             pgau->info[s].sample_info = SDIndex;\n-#endif\n \n             pgau->info[s].ts_delta = tsDelta;\n \n"", ""atomdefs.h"": ""@@ -218,7 +218,6 @@ const uint32    MPEG4_EXTENSION_DESCRIPTORS_BOX = FourCharConstToUint32('m', '4'\n const uint32  PIXELASPECTRATIO_BOX = FourCharConstToUint32('p', 'a', 's', 'p');\n \n \n-const uint32    WMF_BRAND = FourCharConstToUint32('w', 'm', 'f', ' ');\n const uint32    BRAND_3GPP4 = FourCharConstToUint32('3', 'g', 'p', '4');\n const uint32    MOBILE_MP4 = FourCharConstToUint32('m', 'm', 'p', '4');\n const uint32    BRAND_3GPP5 = FourCharConstToUint32('3', 'g', 'p', '5');\n@@ -415,7 +414,6 @@ typedef enum\n     EMP41         = 0x0020,\n     EMP42         = 0x0040,\n     EMMP4         = 0x0100,\n-    EWMF          = 0x0200,\n     EUNKNOWN_TYPE = 0x8000\n } FILE_TYPE_MASKS;\n \n@@ -436,7 +434,6 @@ typedef enum\n \n typedef enum\n {\n-    AMR_AUDIO   = 0xd0,\n     QCELP_MP4   = 0xE1,\n     MPEG4_AUDIO = 0x40,\n     MPEG2_AUDIO_LC = 0x67,\n@@ -505,3 +502,4 @@ typedef enum\n #define MAX_GENRE_ID_IN_ID3_TABLE 147\n \n #endif //ATOMDEFS_H_INCLUDED\n+\n"", ""pvmf_mp4ffparser_events.h"": ""@@ -278,16 +278,6 @@ typedef enum\n     **/\n     PVMFMP4FFParserErrRequirementsAtomReadFailed,\n \n-    /**\n-     When MP4 FF reports error READ_WMF_SET_MEDIA_ATOM_FAILED\n-    **/\n-    PVMFMP4FFParserErrWMFSetMediaAtomReadFailed,\n-\n-    /**\n-     When MP4 FF reports error READ_WMF_SET_SESSION_ATOM_FAILED\n-    **/\n-    PVMFMP4FFParserErrWMFSetSessionAtomReadFailed,\n-\n     /**\n      When MP4 FF reports error READ_PV_CONTENT_TYPE_ATOM_FAILED\n     **/\n"", ""pvmf_mp4ffparser_node.cpp"": ""@@ -5886,14 +5886,6 @@ bool PVMFMP4FFParserNode::MapMP4ErrorCodeToEventCode(int32 aMP4ErrCode, PVUuid&\n             aEventCode = PVMFMP4FFParserErrRequirementsAtomReadFailed;\n             break;\n \n-        case READ_WMF_SET_MEDIA_ATOM_FAILED:\n-            aEventCode = PVMFMP4FFParserErrWMFSetMediaAtomReadFailed;\n-            break;\n-\n-        case READ_WMF_SET_SESSION_ATOM_FAILED:\n-            aEventCode = PVMFMP4FFParserErrWMFSetSessionAtomReadFailed;\n-            break;\n-\n         case READ_PV_USER_DATA_ATOM_FAILED:\n             aEventCode = PVMFMP4FFParserErrPVUserDataAtomReadFailed;\n             break;\n""}","deprecate, refactor 
"
24098,Dmitry Shmidt,net: wireless: bcmdhd: Fix memory poisoning in wl_free_wdev(),['drivers/net/wireless/bcmdhd/wl_cfg80211.c'],"net: wireless: bcmdhd: Fix memory poisoning in wl_free_wdev()

Signed-off-by: Dmitry Shmidt <dimitrysh@google.com>
",https://android-review.googlesource.com/c/24098,"bug
",bug,Bug;,"{""wl_cfg80211.c"": ""@@ -3446,7 +3446,6 @@ static void wl_free_wdev(struct wl_priv *wl)\n \twiphy_unregister(wdev->wiphy);\n \twiphy_free(wdev->wiphy);\n \tkfree(wdev);\n-\twl_to_wdev(wl) = NULL;\n }\n \n static s32 wl_inform_bss(struct wl_priv *wl)\n""}","bug 
"
20854,Xavier Ducrohet,Add Renderscript support to the ADT builders.,"['sdkmanager/libs/sdklib/src/com/android/sdklib/PlatformTarget.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/build/GeneratorDeltaVisitor.java', 'eclipse/plugins/com.android.ide.eclipse.adt/plugin.xml', 'anttasks/src/com/android/ant/SetupTask.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/IAndroidTarget.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/build/builders/PreCompilerDeltaVisitor.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/SdkConstants.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/AndroidConstants.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/manager/FolderTypeRelationship.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/build/JavaGenerator.java', 'anttasks/src/com/android/ant/RenderScriptTask.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/build/builders/PreCompilerBuilder.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/manager/ResourceFolderType.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/build/NonJavaFileBundle.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/build/RenderScriptGenerator.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/build/AidlGenerator.java']","Add Renderscript support to the ADT builders.

This uses the new JavaGenerator mechanism so that all that's needed
is to run llvm-rs-cc on a given list and parsing the dependency file
that's created.

Change-Id: Ib4928c980422dfe1944bc720c77bf6ae5be4c34a",https://android-review.googlesource.com/c/20854,"feature
",feature,Feature;,"{""RenderScriptTask.java"": ""@@ -45,7 +45,7 @@ import java.util.List;\n public class RenderScriptTask extends Task {\n \n     private String mExecutable;\n-    private String mFramework;\n+    private Path mFramework;\n     private String mGenFolder;\n     private String mResFolder;\n     private final List<Path> mPaths = new ArrayList<Path>();\n@@ -59,7 +59,7 @@ public class RenderScriptTask extends Task {\n     }\n \n     public void setFramework(Path value) {\n-        mFramework = TaskHelper.checkSinglePath(\""framework\"", value);\n+        mFramework = value;\n     }\n \n     public void setGenFolder(Path value) {\n@@ -127,8 +127,15 @@ public class RenderScriptTask extends Task {\n                 task.setExecutable(mExecutable);\n                 task.setFailonerror(true);\n \n-                task.createArg().setValue(\""-I\"");\n-                task.createArg().setValue(mFramework);\n+                for (String path : mFramework.list()) {\n+                    // This may not exists, and aapt doesn't like it, so we check first.\n+                    File res = new File(path);\n+                    if (res.isDirectory()) {\n+                        task.createArg().setValue(\""-I\"");\n+                        task.createArg().setValue(path);\n+                    }\n+                }\n+\n                 task.createArg().setValue(\""-p\"");\n                 task.createArg().setValue(mGenFolder);\n                 task.createArg().setValue(\""-o\"");\n"", ""SetupTask.java"": ""@@ -199,15 +199,19 @@ public final class SetupTask extends ImportTask {\n         String androidAidl = androidTarget.getPath(IAndroidTarget.ANDROID_AIDL);\n         antProject.setProperty(AntConstants.PROP_ANDROID_AIDL, androidAidl);\n \n-        String androidRS = androidTarget.getPath(IAndroidTarget.ANDROID_RS);\n-        antProject.setProperty(AntConstants.PROP_ANDROID_RENDERSCRIPT, androidRS);\n+        Path includePath = new Path(antProject);\n+        PathElement element = includePath.createPathElement();\n+        element.setPath(androidTarget.getPath(IAndroidTarget.ANDROID_RS));\n+        element = includePath.createPathElement();\n+        element.setPath(androidTarget.getPath(IAndroidTarget.ANDROID_RS_CLANG));\n+        antProject.setProperty(AntConstants.PROP_ANDROID_RENDERSCRIPT, includePath.toString());\n \n         antProject.setProperty(AntConstants.PROP_AAPT, androidTarget.getPath(IAndroidTarget.AAPT));\n         antProject.setProperty(AntConstants.PROP_AIDL, androidTarget.getPath(IAndroidTarget.AIDL));\n         antProject.setProperty(AntConstants.PROP_DX, androidTarget.getPath(IAndroidTarget.DX));\n         antProject.setProperty(AntConstants.PROP_RENDERSCRIPT,\n                 sdkOsPath + SdkConstants.OS_SDK_PLATFORM_TOOLS_FOLDER +\n-                    SdkConstants.FN_RENDERSCRIPT);\n+                SdkConstants.FN_RENDERSCRIPT);\n \n         // sets up the boot classpath\n \n@@ -215,7 +219,7 @@ public final class SetupTask extends ImportTask {\n         Path bootclasspath = new Path(antProject);\n \n         // create a PathElement for the framework jar\n-        PathElement element = bootclasspath.createPathElement();\n+        element = bootclasspath.createPathElement();\n         element.setPath(androidJar);\n \n         // create PathElement for each optional library.\n"", ""plugin.xml"": ""@@ -33,6 +33,14 @@\n       <super type=\""org.eclipse.core.resources.textmarker\""/>\n       <persistent value=\""true\""/>\n    </extension>\n+   <extension\n+         id=\""com.android.ide.eclipse.common.rsProblem\""\n+         name=\""Android RenderScript Problem\""\n+         point=\""org.eclipse.core.resources.markers\"">\n+      <super type=\""org.eclipse.core.resources.problemmarker\""/>\n+      <super type=\""org.eclipse.core.resources.textmarker\""/>\n+      <persistent value=\""true\""/>\n+   </extension>\n    <extension\n         id=\""com.android.ide.eclipse.common.androidProblem\""\n         name=\""Android XML Content Problem\""\n"", ""AndroidConstants.java"": ""@@ -74,6 +74,8 @@ public class AndroidConstants {\n     public final static String EXT_AIDL = \""aidl\""; //$NON-NLS-1$\n     /** Extension of Renderscript files, i.e. \""rs\"" */\n     public final static String EXT_RS = \""rs\""; //$NON-NLS-1$\n+    /** Extension of dependency files, i.e. \""d\"" */\n+    public final static String EXT_DEP = \""d\""; //$NON-NLS-1$\n     /** Extension of native libraries, i.e. \""so\"" */\n     public final static String EXT_NATIVE_LIB = \""so\""; //$NON-NLS-1$\n     /** Extension of dex files, i.e. \""dex\"" */\n@@ -95,6 +97,10 @@ public class AndroidConstants {\n     public final static String DOT_JAR = DOT + EXT_JAR;\n     /** Dot-Extension of aidl files, i.e. \"".aidl\"" */\n     public final static String DOT_AIDL = DOT + EXT_AIDL;\n+    /** Dot-Extension of renderscript files, i.e. \"".rs\"" */\n+    public final static String DOT_RS = DOT + EXT_RS;\n+    /** Dot-Extension of dependency files, i.e. \"".d\"" */\n+    public final static String DOT_DEP = DOT + EXT_DEP;\n     /** Dot-Extension of dex files, i.e. \"".dex\"" */\n     public final static String DOT_DEX = DOT + EXT_DEX;\n     /** Dot-Extension for temporary resource files, ie \""ap_ */\n@@ -151,9 +157,11 @@ public class AndroidConstants {\n \n     public final static String RE_DOT = \""\\\\.\""; //$NON-NLS-1$\n     /** Regexp for java extension, i.e. \""\\.java$\"" */\n-    public final static String RE_JAVA_EXT = \""\\\\.java$\""; //$NON-NLS-1$\n+    public final static String RE_JAVA_EXT = \""\\\\\"" + DOT_JAVA + \""$\""; //$NON-NLS-1$ //$NON-NLS-2$\n     /** Regexp for aidl extension, i.e. \""\\.aidl$\"" */\n-    public final static String RE_AIDL_EXT = \""\\\\.aidl$\""; //$NON-NLS-1$\n+    public final static String RE_AIDL_EXT = \""\\\\\"" + DOT_AIDL + \""$\""; //$NON-NLS-1$ //$NON-NLS-2$\n+    /** Regexp for rs extension, i.e. \""\\.rs$\"" */\n+    public final static String RE_RS_EXT = \""\\\\\"" + DOT_RS + \""$\""; //$NON-NLS-1$ //$NON-NLS-2$\n \n     /**\n      * Namespace pattern for the custom resource XML, i.e. \""http://schemas.android.com/apk/res/%s\""\n@@ -196,6 +204,9 @@ public class AndroidConstants {\n     /** aidl marker error, only to be used in {@link PreCompilerBuilder} */\n     public final static String MARKER_AIDL = LEGACY_PLUGIN_ID + \"".aidlProblem\""; //$NON-NLS-1$\n \n+    /** renderscript marker error, only to be used in {@link PreCompilerBuilder} */\n+    public final static String MARKER_RENDERSCRIPT = LEGACY_PLUGIN_ID + \"".rsProblem\""; //$NON-NLS-1$\n+\n     /** android marker error, only to be used in the Manifest parsing\n      * from the {@link PreCompilerBuilder} */\n     public final static String MARKER_ANDROID = LEGACY_PLUGIN_ID + \"".androidProblem\""; //$NON-NLS-1$\n"", ""AidlGenerator.java"": ""@@ -89,6 +89,11 @@ public class AidlGenerator extends JavaGenerator {\n         return PROPERTY_COMPILE_AIDL;\n     }\n \n+    @Override\n+    protected int getCompileStatus() {\n+        return COMPILE_STATUS_CODE;\n+    }\n+\n     @Override\n     protected void doCompileFiles(List<IFile> sources, BaseBuilder builder,\n             IProject project, IAndroidTarget projectTarget,\n@@ -108,9 +113,11 @@ public class AidlGenerator extends JavaGenerator {\n             command[index++] = \""-I\"" + f.getLocation().toOSString(); //$NON-NLS-1$\n         }\n \n+        boolean verbose = AdtPrefs.getPrefs().getBuildVerbosity() == BuildVerbosity.VERBOSE;\n+\n         // loop until we've compile them all\n         for (IFile sourceFile : sources) {\n-            if (AdtPrefs.getPrefs().getBuildVerbosity() == BuildVerbosity.VERBOSE) {\n+            if (verbose) {\n                 String name = sourceFile.getName();\n                 IPath sourceFolderPath = getSourceFolderFor(sourceFile);\n                 if (sourceFolderPath != null) {\n@@ -141,7 +148,7 @@ public class AidlGenerator extends JavaGenerator {\n             command[index + 1] = bundle.getOutput().getLocation().toOSString();\n \n             // launch the process\n-            if (execAidl(builder, project, command, sourceFile) == false) {\n+            if (execAidl(builder, project, command, sourceFile, verbose) == false) {\n                 // aidl failed. File should be marked. We add the file to the list\n                 // of file that will need compilation again.\n                 notCompiledOut.add(sourceFile);\n@@ -149,23 +156,6 @@ public class AidlGenerator extends JavaGenerator {\n         }\n     }\n \n-    @Override\n-    protected void doRemoveFiles(List<IFile> sources, IProgressMonitor monitor)\n-            throws CoreException {\n-        for (IFile sourceFile : sources) {\n-            // look if we already know the output\n-            NonJavaFileBundle bundle = getBundle(sourceFile);\n-            if (bundle != null) {\n-                IFile outputFile = bundle.getOutput();\n-                if (outputFile != null && outputFile.exists()) {\n-                    // This confirms the java file was generated by the builder,\n-                    // we can delete the aidlFile.\n-                    outputFile.getLocation().toFile().delete();\n-                }\n-            }\n-        }\n-    }\n-\n     @Override\n     protected void loadOutputAndDependencies() {\n         IProgressMonitor monitor = new NullProgressMonitor();\n@@ -189,12 +179,13 @@ public class AidlGenerator extends JavaGenerator {\n      * @param command the String array containing the command line to execute.\n      * @param file The IFile object representing the aidl file being\n      *      compiled.\n+     * @param verbose the build verbosity\n      * @return false if the exec failed, and build needs to be aborted.\n      */\n-    private boolean execAidl(BaseBuilder builder, IProject project, String[] command, IFile file) {\n+    private boolean execAidl(BaseBuilder builder, IProject project, String[] command, IFile file,\n+            boolean verbose) {\n         // do the exec\n         try {\n-            boolean verbose = AdtPrefs.getPrefs().getBuildVerbosity() == BuildVerbosity.VERBOSE;\n             if (verbose) {\n                 StringBuilder sb = new StringBuilder();\n                 for (String c : command) {\n@@ -224,13 +215,13 @@ public class AidlGenerator extends JavaGenerator {\n                     // display the message in the console.\n                     if (error) {\n                         AdtPlugin.printErrorToConsole(project, results.toArray());\n+\n+                        // mark the project\n+                        BaseProjectHelper.markResource(project, AndroidConstants.MARKER_ADT,\n+                                Messages.Unparsed_AIDL_Errors, IMarker.SEVERITY_ERROR);\n                     } else {\n                         AdtPlugin.printToConsole(project, results.toArray());\n                     }\n-\n-                    // mark the project and exit\n-                    BaseProjectHelper.markResource(project, AndroidConstants.MARKER_ADT,\n-                            Messages.Unparsed_AIDL_Errors, IMarker.SEVERITY_ERROR);\n                 }\n                 return false;\n             }\n@@ -343,29 +334,6 @@ public class AidlGenerator extends JavaGenerator {\n         return null;\n     }\n \n-    private IPath getSourceFolderFor(IFile file) {\n-        // find the source folder for the class so that we can infer the package from the\n-        // difference between the file and its source folder.\n-        List<IPath> sourceFolders = BaseProjectHelper.getSourceClasspaths(getJavaProject());\n-        IWorkspaceRoot root = ResourcesPlugin.getWorkspace().getRoot();\n-\n-        for (IPath sourceFolderPath : sourceFolders) {\n-            IFolder sourceFolder = root.getFolder(sourceFolderPath);\n-            // we don't look in the 'gen' source folder as there will be no source in there.\n-            if (sourceFolder.exists() && sourceFolder.equals(getGenFolder()) == false) {\n-                // look for the source file parent, until we find this source folder.\n-                IResource parent = file;\n-                while ((parent = parent.getParent()) != null) {\n-                    if (parent.equals(sourceFolder)) {\n-                        return sourceFolderPath;\n-                    }\n-                }\n-            }\n-        }\n-\n-        return null;\n-    }\n-\n     /**\n      * Creates the destination folder. Because\n      * {@link IFolder#create(boolean, boolean, IProgressMonitor)} only works if the parent folder\n"", ""GeneratorDeltaVisitor.java"": ""@@ -81,7 +81,12 @@ public class GeneratorDeltaVisitor {\n         }\n     }\n \n-    protected boolean filterResourceFolder(IContainer parent) {\n+    /**\n+     * Called to restrict {@link #handleResourceFile(IFile, int)} on selected resource folders.\n+     * @param folder\n+     * @return\n+     */\n+    protected boolean filterResourceFolder(IContainer folder) {\n         return false;\n     }\n \n"", ""JavaGenerator.java"": ""@@ -51,6 +51,10 @@ import java.util.Set;\n  */\n public abstract class JavaGenerator {\n \n+    public final static int COMPILE_STATUS_NONE = 0;\n+    public final static int COMPILE_STATUS_CODE = 0x1;\n+    public final static int COMPILE_STATUS_RES = 0x2;\n+\n     /** List of all source files, their dependencies, and their output. */\n     private final Map<IFile, NonJavaFileBundle> mFiles = new HashMap<IFile, NonJavaFileBundle>();\n \n@@ -187,12 +191,12 @@ public abstract class JavaGenerator {\n \n     protected abstract String getSavePropertyName();\n \n-    public final boolean compileFiles(BaseBuilder builder,\n+    public final int compileFiles(BaseBuilder builder,\n             IProject project, IAndroidTarget projectTarget,\n             List<IPath> sourceFolders, IProgressMonitor monitor) throws CoreException {\n \n         if (mToCompile.size() == 0 && mRemoved.size() == 0) {\n-            return false;\n+            return COMPILE_STATUS_NONE;\n         }\n \n         // if a source file is being removed before we managed to compile it, it'll be in\n@@ -214,7 +218,13 @@ public abstract class JavaGenerator {\n         mToCompile.addAll(stillNeedCompilation);\n \n         // Remove the files created from source files that have been removed.\n-        doRemoveFiles(mRemoved, monitor);\n+        for (IFile sourceFile : mRemoved) {\n+            // look if we already know the output\n+            NonJavaFileBundle bundle = getBundle(sourceFile);\n+            if (bundle != null) {\n+                doRemoveFiles(bundle);\n+            }\n+        }\n \n         // remove the associated bundles.\n         for (IFile removedFile : mRemoved) {\n@@ -228,7 +238,7 @@ public abstract class JavaGenerator {\n         // before the project is closed/re-opened.)\n         saveState(project);\n \n-        return true;\n+        return getCompileStatus();\n     }\n \n     protected abstract void doCompileFiles(\n@@ -237,8 +247,16 @@ public abstract class JavaGenerator {\n             List<IPath> sourceFolders, List<IFile> notCompiledOut, IProgressMonitor monitor)\n             throws CoreException;\n \n-    protected abstract void doRemoveFiles(List<IFile> sources, IProgressMonitor monitor)\n-            throws CoreException;\n+    protected abstract int getCompileStatus();\n+\n+    protected void doRemoveFiles(NonJavaFileBundle bundle) throws CoreException {\n+        List<IFile> outputFiles = bundle.getOutputFiles();\n+        for (IFile outputFile : outputFiles) {\n+            if (outputFile.exists()) {\n+                outputFile.getLocation().toFile().delete();\n+            }\n+        }\n+    }\n \n     public final boolean loadState(IProject project) {\n         return ProjectHelper.loadBooleanProperty(project, getSavePropertyName(),\n@@ -253,13 +271,37 @@ public abstract class JavaGenerator {\n \n     protected abstract void loadOutputAndDependencies();\n \n+\n+    protected IPath getSourceFolderFor(IFile file) {\n+        // find the source folder for the class so that we can infer the package from the\n+        // difference between the file and its source folder.\n+        List<IPath> sourceFolders = BaseProjectHelper.getSourceClasspaths(getJavaProject());\n+        IWorkspaceRoot root = ResourcesPlugin.getWorkspace().getRoot();\n+\n+        for (IPath sourceFolderPath : sourceFolders) {\n+            IFolder sourceFolder = root.getFolder(sourceFolderPath);\n+            // we don't look in the 'gen' source folder as there will be no source in there.\n+            if (sourceFolder.exists() && sourceFolder.equals(getGenFolder()) == false) {\n+                // look for the source file parent, until we find this source folder.\n+                IResource parent = file;\n+                while ((parent = parent.getParent()) != null) {\n+                    if (parent.equals(sourceFolder)) {\n+                        return sourceFolderPath;\n+                    }\n+                }\n+            }\n+        }\n+\n+        return null;\n+    }\n+\n     /**\n      * Goes through the build paths and fills the list of files to compile.\n      *\n      * @param project The project.\n      * @param sourceFolderPathList The list of source folder paths.\n      */\n-    protected void buildSourceFileList() {\n+    private final void buildSourceFileList() {\n         mFiles.clear();\n \n         IWorkspaceRoot root = ResourcesPlugin.getWorkspace().getRoot();\n"", ""NonJavaFileBundle.java"": ""@@ -81,6 +81,17 @@ public class NonJavaFileBundle {\n         }\n     }\n \n+    public void setDependencyFiles(List<IFile> depFiles) {\n+        mDependencyFiles.clear();\n+        if (depFiles != null) {\n+            mDependencyFiles.addAll(depFiles);\n+        }\n+    }\n+\n+    public List<IFile> getDependencyFiles() {\n+        return mDependencyFiles;\n+    }\n+\n     /**\n      * Shortcut access to the first output file. This is useful for generator that only output\n      * one file.\n"", ""RenderScriptGenerator.java"": ""@@ -0,0 +1,423 @@\n+/*\n+ * Copyright (C) 2011 The Android Open Source Project\n+ *\n+ * Licensed under the Eclipse Public License, Version 1.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.eclipse.org/org/documents/epl-v10.php\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.android.ide.eclipse.adt.internal.build;\n+\n+import com.android.ide.eclipse.adt.AdtPlugin;\n+import com.android.ide.eclipse.adt.AndroidConstants;\n+import com.android.ide.eclipse.adt.internal.build.builders.BaseBuilder;\n+import com.android.ide.eclipse.adt.internal.preferences.AdtPrefs;\n+import com.android.ide.eclipse.adt.internal.preferences.AdtPrefs.BuildVerbosity;\n+import com.android.ide.eclipse.adt.internal.project.BaseProjectHelper;\n+import com.android.ide.eclipse.adt.internal.resources.manager.ResourceFolderType;\n+import com.android.ide.eclipse.adt.internal.sdk.Sdk;\n+import com.android.sdklib.IAndroidTarget;\n+import com.android.sdklib.SdkConstants;\n+\n+import org.eclipse.core.resources.IContainer;\n+import org.eclipse.core.resources.IFile;\n+import org.eclipse.core.resources.IFolder;\n+import org.eclipse.core.resources.IMarker;\n+import org.eclipse.core.resources.IProject;\n+import org.eclipse.core.resources.IResource;\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IPath;\n+import org.eclipse.core.runtime.IProgressMonitor;\n+import org.eclipse.core.runtime.Path;\n+import org.eclipse.jdt.core.IJavaProject;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+/**\n+ * A {@link JavaGenerator} for RenderScript files.\n+ *\n+ */\n+\n+public class RenderScriptGenerator extends JavaGenerator {\n+\n+    private static final String PROPERTY_COMPILE_RS = \""compileRenderScript\""; //$NON-NLS-1$\n+\n+    /**\n+     * Single line llvm-rs-cc error<br>\n+     * \""&lt;path&gt;:&lt;line&gt;:&lt;col&gt;: &lt;error&gt;\""\n+     */\n+    private static Pattern sLlvmPattern1 = Pattern.compile(\""^(.+?):(\\\\d+):(\\\\d+):\\\\s(.+)$\""); //$NON-NLS-1$\n+\n+    private static class RSDeltaVisitor extends GeneratorDeltaVisitor {\n+\n+        @Override\n+        protected boolean filterResourceFolder(IContainer folder) {\n+            return ResourceFolderType.RAW.getName().equals(folder.getName());\n+        }\n+    }\n+\n+    public RenderScriptGenerator(IJavaProject javaProject, IFolder genFolder) {\n+        super(javaProject, genFolder, new RSDeltaVisitor());\n+    }\n+\n+    @Override\n+    protected String getExtension() {\n+        return AndroidConstants.EXT_RS;\n+    }\n+\n+    @Override\n+    protected String getSavePropertyName() {\n+        return PROPERTY_COMPILE_RS;\n+    }\n+\n+    @Override\n+    protected int getCompileStatus() {\n+        return COMPILE_STATUS_CODE | COMPILE_STATUS_RES;\n+    }\n+\n+    @Override\n+    protected void doCompileFiles(List<IFile> sources, BaseBuilder builder,\n+            IProject project, IAndroidTarget projectTarget, List<IPath> sourceFolders,\n+            List<IFile> notCompiledOut, IProgressMonitor monitor) throws CoreException {\n+\n+        String sdkOsPath = Sdk.getCurrent().getSdkLocation();\n+\n+        IFolder genFolder = getGenFolder();\n+\n+        IFolder rawFolder = project.getFolder(\n+                new Path(SdkConstants.FD_RES).append(SdkConstants.FD_RAW));\n+\n+        // create the command line\n+        String[] command = new String[13];\n+        int index = 0;\n+        command[index++] = sdkOsPath + SdkConstants.OS_SDK_PLATFORM_TOOLS_FOLDER\n+                + SdkConstants.FN_RENDERSCRIPT;\n+        command[index++] = \""-I\"";\n+        command[index++] = projectTarget.getPath(IAndroidTarget.ANDROID_RS_CLANG);\n+        command[index++] = \""-I\"";\n+        command[index++] = projectTarget.getPath(IAndroidTarget.ANDROID_RS);\n+        command[index++] = \""-p\"";\n+        command[index++] = genFolder.getLocation().toOSString();\n+        command[index++] = \""-o\"";\n+        command[index++] = rawFolder.getLocation().toOSString();\n+\n+        command[index++] = \""-d\"";\n+        command[index++] = getDependencyFolder().getLocation().toOSString();\n+        command[index++] = \""-MD\"";\n+\n+        boolean verbose = AdtPrefs.getPrefs().getBuildVerbosity() == BuildVerbosity.VERBOSE;\n+        boolean someSuccess = false;\n+\n+        // loop until we've compile them all\n+        for (IFile sourceFile : sources) {\n+            if (verbose) {\n+                String name = sourceFile.getName();\n+                IPath sourceFolderPath = getSourceFolderFor(sourceFile);\n+                if (sourceFolderPath != null) {\n+                    // make a path to the source file relative to the source folder.\n+                    IPath relative = sourceFile.getFullPath().makeRelativeTo(sourceFolderPath);\n+                    name = relative.toString();\n+                }\n+                AdtPlugin.printToConsole(project, \""RenderScript: \"" + name);\n+            }\n+\n+            // Remove the RS error markers from the source file and the dependencies\n+            builder.removeMarkersFromFile(sourceFile, AndroidConstants.MARKER_RENDERSCRIPT);\n+            NonJavaFileBundle bundle = getBundle(sourceFile);\n+            if (bundle != null) {\n+                for (IFile dep : bundle.getDependencyFiles()) {\n+                    builder.removeMarkersFromFile(dep, AndroidConstants.MARKER_RENDERSCRIPT);\n+                }\n+            }\n+\n+            // get the path of the source file.\n+            IPath sourcePath = sourceFile.getLocation();\n+            String osSourcePath = sourcePath.toOSString();\n+\n+            // finish to set the command line.\n+            command[index] = osSourcePath;\n+\n+            // launch the process\n+            if (execLlvmRsCc(builder, project, command, sourceFile, verbose) == false) {\n+                // llvm-rs-cc failed. File should be marked. We add the file to the list\n+                // of file that will need compilation again.\n+                notCompiledOut.add(sourceFile);\n+            } else {\n+                // need to parse the .d file to figure out the dependencies and the generated file\n+                parseDependencyFileFor(sourceFile);\n+                someSuccess = true;\n+            }\n+        }\n+\n+        if (someSuccess) {\n+            rawFolder.refreshLocal(IResource.DEPTH_ONE, monitor);\n+        }\n+    }\n+\n+    private boolean execLlvmRsCc(BaseBuilder builder, IProject project, String[] command,\n+            IFile sourceFile, boolean verbose) {\n+        // do the exec\n+        try {\n+            if (verbose) {\n+                StringBuilder sb = new StringBuilder();\n+                for (String c : command) {\n+                    sb.append(c);\n+                    sb.append(' ');\n+                }\n+                String cmd_line = sb.toString();\n+                AdtPlugin.printToConsole(project, cmd_line);\n+            }\n+\n+            Process p = Runtime.getRuntime().exec(command);\n+\n+            // list to store each line of stderr\n+            ArrayList<String> results = new ArrayList<String>();\n+\n+            // get the output and return code from the process\n+            int result = BuildHelper.grabProcessOutput(project, p, results);\n+\n+            // attempt to parse the error output\n+            boolean error = parseLlvmOutput(results);\n+\n+            // If the process failed and we couldn't parse the output\n+            // we print a message, mark the project and exit\n+            if (result != 0) {\n+\n+                if (error || verbose) {\n+                    // display the message in the console.\n+                    if (error) {\n+                        AdtPlugin.printErrorToConsole(project, results.toArray());\n+\n+                        // mark the project\n+                        BaseProjectHelper.markResource(project, AndroidConstants.MARKER_ADT,\n+                                \""Unparsed Renderscript error! Check the console for output.\"",\n+                                IMarker.SEVERITY_ERROR);\n+                    } else {\n+                        AdtPlugin.printToConsole(project, results.toArray());\n+                    }\n+                }\n+                return false;\n+            }\n+        } catch (IOException e) {\n+            // mark the project and exit\n+            String msg = String.format(\n+                    \""Error executing Renderscript. Please check llvm-rs-cc is present at %1$s\"",\n+                    command[0]);\n+            BaseProjectHelper.markResource(project, AndroidConstants.MARKER_ADT, msg,\n+                    IMarker.SEVERITY_ERROR);\n+            return false;\n+        } catch (InterruptedException e) {\n+            // mark the project and exit\n+            String msg = String.format(\n+                    \""Error executing Renderscript. Please check llvm-rs-cc is present at %1$s\"",\n+                    command[0]);\n+            BaseProjectHelper.markResource(project, AndroidConstants.MARKER_ADT, msg,\n+                    IMarker.SEVERITY_ERROR);\n+            return false;\n+        }\n+\n+        return true;\n+    }\n+\n+    /**\n+     * Parse the output of aidl and mark the file with any errors.\n+     * @param lines The output to parse.\n+     * @param file The file to mark with error.\n+     * @return true if the parsing failed, false if success.\n+     */\n+    private boolean parseLlvmOutput(ArrayList<String> lines) {\n+        // nothing to parse? just return false;\n+        if (lines.size() == 0) {\n+            return false;\n+        }\n+\n+        // get the root folder for the project as we're going to ignore everything that's\n+        // not in the project\n+        IProject project = getJavaProject().getProject();\n+        String rootPath = project.getLocation().toOSString();\n+        int rootPathLength = rootPath.length();\n+\n+        Matcher m;\n+\n+        boolean parsing = false;\n+\n+        for (int i = 0; i < lines.size(); i++) {\n+            String p = lines.get(i);\n+\n+            m = sLlvmPattern1.matcher(p);\n+            if (m.matches()) {\n+                // get the file path. This may, or may not be the main file being compiled.\n+                String filePath = m.group(1);\n+                if (filePath.startsWith(rootPath) == false) {\n+                    // looks like the error in a non-project file. Keep parsing, but\n+                    // we'll return true\n+                    parsing = true;\n+                    continue;\n+                }\n+\n+                // get the actual file.\n+                filePath = filePath.substring(rootPathLength);\n+                // remove starting separator since we want the path to be relative\n+                if (filePath.startsWith(File.separator)) {\n+                    filePath = filePath.substring(1);\n+                }\n+\n+                // get the file\n+                IFile f = project.getFile(new Path(filePath));\n+\n+                String lineStr = m.group(2);\n+                // ignore group 3 for now, this is the col number\n+                String msg = m.group(4);\n+\n+                // get the line number\n+                int line = 0;\n+                try {\n+                    line = Integer.parseInt(lineStr);\n+                } catch (NumberFormatException e) {\n+                    // looks like the string we extracted wasn't a valid\n+                    // file number. Parsing failed and we return true\n+                    return true;\n+                }\n+\n+                // mark the file\n+                BaseProjectHelper.markResource(f, AndroidConstants.MARKER_RENDERSCRIPT, msg, line,\n+                        IMarker.SEVERITY_ERROR);\n+\n+                // success, go to the next line\n+                continue;\n+            }\n+\n+            // invalid line format, flag as error, and keep going\n+            parsing = true;\n+        }\n+\n+        return parsing;\n+    }\n+\n+\n+    @Override\n+    protected void doRemoveFiles(NonJavaFileBundle bundle) throws CoreException {\n+        // call the super implementation will remove the output files\n+        super.doRemoveFiles(bundle);\n+\n+        // now remove the dependency file.\n+        IFile depFile = getDependencyFileFor(bundle.getSourceFile());\n+        if (depFile.exists()) {\n+            depFile.getLocation().toFile().delete();\n+        }\n+    }\n+\n+    @Override\n+    protected void loadOutputAndDependencies() {\n+        Collection<NonJavaFileBundle> bundles = getBundles();\n+        for (NonJavaFileBundle bundle : bundles) {\n+            parseDependencyFileFor(bundle.getSourceFile());\n+        }\n+    }\n+\n+    private void parseDependencyFileFor(IFile sourceFile) {\n+        IFile depFile = getDependencyFileFor(sourceFile);\n+        File f = depFile.getLocation().toFile();\n+        if (f.exists()) {\n+            NonJavaFileBundle bundle = getBundle(sourceFile);\n+            if (bundle == null) {\n+                bundle = new NonJavaFileBundle(sourceFile);\n+                addBundle(bundle);\n+            }\n+            parseDependencyFile(bundle, f);\n+        }\n+    }\n+\n+    private IFolder getDependencyFolder() {\n+        return getJavaProject().getProject().getFolder(SdkConstants.FD_OUTPUT);\n+    }\n+\n+    private IFile getDependencyFileFor(IFile sourceFile) {\n+        IFolder depFolder = getDependencyFolder();\n+        return depFolder.getFile(sourceFile.getName().replaceAll(AndroidConstants.RE_RS_EXT,\n+                AndroidConstants.DOT_DEP));\n+    }\n+\n+    /**\n+     * Parses the given dependency file and fills the given {@link NonJavaFileBundle} with it.\n+     *\n+     * @param bundle the bundle to fill.\n+     * @param file the dependency file\n+     */\n+    private void parseDependencyFile(NonJavaFileBundle bundle, File dependencyFile) {\n+        //contents = file.getContents();\n+        String content = AdtPlugin.readFile(dependencyFile);\n+\n+        // we're going to be pretty brutal here.\n+        // The format is something like:\n+        // output1 output2 [...]: dep1 dep2 [...]\n+        // expect it's likely split on several lines. So let's move it back on a single line\n+        // first\n+        String[] lines = content.split(\""\\n\"");\n+        StringBuilder sb = new StringBuilder();\n+        for (String line : lines) {\n+            line = line.trim();\n+            if (line.endsWith(\""\\\\\"")) {\n+                line = line.substring(0, line.length() - 1);\n+            }\n+\n+            sb.append(line);\n+        }\n+\n+        // split the left and right part\n+        String[] files = sb.toString().split(\"":\"");\n+\n+        // get the output files:\n+        String[] outputs = files[0].trim().split(\"" \"");\n+\n+        // and the dependency files:\n+        String[] dependencies = files[1].trim().split(\"" \"");\n+\n+        List<IFile> outputFiles = new ArrayList<IFile>();\n+        List<IFile> dependencyFiles = new ArrayList<IFile>();\n+\n+        fillList(outputs, outputFiles);\n+        fillList(dependencies, dependencyFiles);\n+\n+        bundle.setOutputFiles(outputFiles);\n+        bundle.setDependencyFiles(dependencyFiles);\n+    }\n+\n+    private void fillList(String[] paths, List<IFile> list) {\n+        // get the root folder for the project as we're going to ignore everything that's\n+        // not in the project\n+        IProject project = getJavaProject().getProject();\n+        String rootPath = project.getLocation().toOSString();\n+        int rootPathLength = rootPath.length();\n+\n+        // all those should really be in the project\n+        for (String p : paths) {\n+\n+            if (p.startsWith(rootPath)) {\n+                p = p.substring(rootPathLength);\n+                // remove starting separator since we want the path to be relative\n+                if (p.startsWith(File.separator)) {\n+                    p = p.substring(1);\n+                }\n+\n+                // get the file\n+                IFile f = project.getFile(new Path(p));\n+                list.add(f);\n+            }\n+        }\n+    }\n+}\n"", ""PreCompilerBuilder.java"": ""@@ -22,6 +22,7 @@ import com.android.ide.eclipse.adt.internal.build.AaptParser;\n import com.android.ide.eclipse.adt.internal.build.AidlGenerator;\n import com.android.ide.eclipse.adt.internal.build.JavaGenerator;\n import com.android.ide.eclipse.adt.internal.build.Messages;\n+import com.android.ide.eclipse.adt.internal.build.RenderScriptGenerator;\n import com.android.ide.eclipse.adt.internal.preferences.AdtPrefs;\n import com.android.ide.eclipse.adt.internal.preferences.AdtPrefs.BuildVerbosity;\n import com.android.ide.eclipse.adt.internal.project.AndroidManifestHelper;\n@@ -467,18 +468,33 @@ public class PreCompilerBuilder extends BaseBuilder {\n                 saveProjectBooleanProperty(PROPERTY_COMPILE_RESOURCES , mMustCompileResources);\n             }\n \n-            if (mMustCompileResources) {\n-                handleResources(project, javaPackage, projectTarget, manifestFile, libProjects);\n-            }\n-\n             // run the Java generators\n-            boolean generatorStatus = false;\n+            int generatorStatus = JavaGenerator.COMPILE_STATUS_NONE;\n             for (JavaGenerator generator : mGeneratorList) {\n-                generatorStatus |= generator.compileFiles(this,\n-                        project, projectTarget, sourceFolderPathList, monitor);\n+                try {\n+                    generatorStatus |= generator.compileFiles(this,\n+                            project, projectTarget, sourceFolderPathList, monitor);\n+                } catch (Throwable t) {\n+                }\n+            }\n+\n+            // if a generator created some resources file, force recompilation of the resources.\n+            if ((generatorStatus & JavaGenerator.COMPILE_STATUS_RES) != 0) {\n+                mMustCompileResources = true;\n+                // save the current state before attempting the compilation\n+                saveProjectBooleanProperty(PROPERTY_COMPILE_RESOURCES , mMustCompileResources);\n+            }\n+\n+            // handle the resources, after the java generators are run since some (renderscript)\n+            // generate resources.\n+            boolean compiledTheResources = mMustCompileResources;\n+            if (mMustCompileResources) {\n+                handleResources(project, javaPackage, projectTarget, manifestFile, libProjects);\n+                saveProjectBooleanProperty(PROPERTY_COMPILE_RESOURCES , false);\n             }\n \n-            if (generatorStatus == false && mMustCompileResources == false) {\n+            if (generatorStatus == JavaGenerator.COMPILE_STATUS_NONE &&\n+                    compiledTheResources == false) {\n                 AdtPlugin.printBuildToConsole(BuildVerbosity.VERBOSE, project,\n                         Messages.Nothing_To_Compile);\n             }\n@@ -539,6 +555,8 @@ public class PreCompilerBuilder extends BaseBuilder {\n         // load the java generators\n         JavaGenerator aidlGenerator = new AidlGenerator(javaProject, mGenFolder);\n         mGeneratorList.add(aidlGenerator);\n+        JavaGenerator renderScriptGenerator = new RenderScriptGenerator(javaProject, mGenFolder);\n+        mGeneratorList.add(renderScriptGenerator);\n \n         mDerivedProgressMonitor = new DerivedProgressMonitor(mGenFolder);\n     }\n"", ""PreCompilerDeltaVisitor.java"": ""@@ -55,9 +55,7 @@ import java.util.List;\n  * <li>Any modification to aidl files.</li>\n  *\n  */\n-class PreCompilerDeltaVisitor extends BaseDeltaVisitor implements\n-        IResourceDeltaVisitor {\n-\n+class PreCompilerDeltaVisitor extends BaseDeltaVisitor implements IResourceDeltaVisitor {\n \n     // Result fields.\n     /**\n@@ -346,6 +344,10 @@ class PreCompilerDeltaVisitor extends BaseDeltaVisitor implements\n                         mBuilder.getProject(), message);\n             }\n \n+            for (GeneratorDeltaVisitor dv : mGeneratorDeltaVisitors) {\n+                dv.handleResourceFile((IFile)resource, kind);\n+            }\n+\n             if (AndroidConstants.EXT_XML.equalsIgnoreCase(ext)) {\n                 if (kind != IResourceDelta.REMOVED) {\n                     // check xml Validity\n"", ""FolderTypeRelationship.java"": ""@@ -62,6 +62,7 @@ public final class FolderTypeRelationship {\n                 folderToTypeMap);\n         add(ResourceType.LAYOUT, ResourceFolderType.LAYOUT, typeToFolderMap, folderToTypeMap);\n         add(ResourceType.MENU, ResourceFolderType.MENU, typeToFolderMap, folderToTypeMap);\n+        add(ResourceType.MIPMAP, ResourceFolderType.MIPMAP, typeToFolderMap, folderToTypeMap);\n         add(ResourceType.PLURALS, ResourceFolderType.VALUES, typeToFolderMap, folderToTypeMap);\n         add(ResourceType.PUBLIC, ResourceFolderType.VALUES, typeToFolderMap, folderToTypeMap);\n         add(ResourceType.RAW, ResourceFolderType.RAW, typeToFolderMap, folderToTypeMap);\n"", ""ResourceFolderType.java"": ""@@ -30,6 +30,7 @@ public enum ResourceFolderType {\n     INTERPOLATOR(SdkConstants.FD_INTERPOLATOR),\n     LAYOUT(SdkConstants.FD_LAYOUT),\n     MENU(SdkConstants.FD_MENU),\n+    MIPMAP(SdkConstants.FD_MIPMAP),\n     RAW(SdkConstants.FD_RAW),\n     VALUES(SdkConstants.FD_VALUES),\n     XML(SdkConstants.FD_XML);\n"", ""IAndroidTarget.java"": ""@@ -79,6 +79,8 @@ public interface IAndroidTarget extends Comparable<IAndroidTarget> {\n     public final static int ANT                 = 24;\n     /** OS Path to the Renderscript include folder. */\n     public final static int ANDROID_RS          = 25;\n+    /** OS Path to the Renderscript(clang) include folder. */\n+    public final static int ANDROID_RS_CLANG    = 26;\n \n     /**\n      * Return value for {@link #getUsbVendorId()} meaning no USB vendor IDs are defined by the\n"", ""PlatformTarget.java"": ""@@ -16,9 +16,10 @@\n \n package com.android.sdklib;\n \n+import com.android.sdklib.util.SparseArray;\n+\n import java.io.File;\n import java.util.Collections;\n-import java.util.HashMap;\n import java.util.Map;\n \n /**\n@@ -40,7 +41,7 @@ final class PlatformTarget implements IAndroidTarget {\n     private final String mVersionName;\n     private final int mRevision;\n     private final Map<String, String> mProperties;\n-    private final Map<Integer, String> mPaths = new HashMap<Integer, String>();\n+    private final SparseArray<String> mPaths = new SparseArray<String>();\n     private String[] mSkins;\n \n \n@@ -77,6 +78,7 @@ final class PlatformTarget implements IAndroidTarget {\n         mPaths.put(SOURCES, mRootFolderOsPath + SdkConstants.FD_ANDROID_SOURCES);\n         mPaths.put(ANDROID_AIDL, mRootFolderOsPath + SdkConstants.FN_FRAMEWORK_AIDL);\n         mPaths.put(ANDROID_RS, mRootFolderOsPath + SdkConstants.OS_FRAMEWORK_RS);\n+        mPaths.put(ANDROID_RS_CLANG, mRootFolderOsPath + SdkConstants.OS_FRAMEWORK_RS_CLANG);\n         mPaths.put(IMAGES, mRootFolderOsPath + SdkConstants.OS_IMAGES_FOLDER);\n         mPaths.put(SAMPLES, mRootFolderOsPath + SdkConstants.OS_PLATFORM_SAMPLES_FOLDER);\n         mPaths.put(SKINS, mRootFolderOsPath + SdkConstants.OS_SKINS_FOLDER);\n"", ""SdkConstants.java"": ""@@ -66,6 +66,8 @@ public final class SdkConstants {\n     public static final String FN_FRAMEWORK_RENDERSCRIPT = \""renderscript\"";\n     /** framework include folder */\n     public static final String FN_FRAMEWORK_INCLUDE = \""include\"";\n+    /** framework include (clang) folder */\n+    public static final String FN_FRAMEWORK_INCLUDE_CLANG = \""clang-include\"";\n     /** layoutlib.jar file */\n     public static final String FN_LAYOUTLIB_JAR = \""layoutlib.jar\"";\n     /** widget list file */\n@@ -192,6 +194,8 @@ public final class SdkConstants {\n     public final static String FD_LAYOUT = \""layout\""; //$NON-NLS-1$\n     /** Default menu resource folder name, i.e. \""menu\"" */\n     public final static String FD_MENU = \""menu\""; //$NON-NLS-1$\n+    /** Default menu resource folder name, i.e. \""mipmap\"" */\n+    public final static String FD_MIPMAP = \""mipmap\""; //$NON-NLS-1$\n     /** Default values resource folder name, i.e. \""values\"" */\n     public final static String FD_VALUES = \""values\""; //$NON-NLS-1$\n     /** Default xml resource folder name, i.e. \""xml\"" */\n@@ -343,6 +347,9 @@ public final class SdkConstants {\n     /** Path of the renderscript include folder relative to a platform folder. */\n     public final static String OS_FRAMEWORK_RS =\n             FN_FRAMEWORK_RENDERSCRIPT + File.separator + FN_FRAMEWORK_INCLUDE;\n+    /** Path of the renderscript (clang) include folder relative to a platform folder. */\n+    public final static String OS_FRAMEWORK_RS_CLANG =\n+            FN_FRAMEWORK_RENDERSCRIPT + File.separator + FN_FRAMEWORK_INCLUDE_CLANG;\n \n     /* Folder paths relative to a addon folder */\n \n""}","feature 
"
16937,Jean-Baptiste Queru,"Revert ""Fixed problem with keymap files copied to target""","['emulator/keymaps/qwerty2.kcm', 'emulator/keymaps/qwerty.kcm', 'emulator/keymaps/Android.mk', 'emulator/keymaps/qwerty.kl']","Revert ""Fixed problem with keymap files copied to target""

This reverts commit 1fc95cae8ec2ccfe134ff279ed9082311ad0d877.",https://android-review.googlesource.com/c/16937,"bug 
",bug,Resource;,"{""Android.mk"": ""@@ -1,4 +1,16 @@\n LOCAL_PATH:= $(call my-dir)\n+include $(CLEAR_VARS)\n+LOCAL_SRC_FILES := qwerty.kcm\n+include $(BUILD_KEY_CHAR_MAP)\n+\n+include $(CLEAR_VARS)\n+LOCAL_SRC_FILES := qwerty2.kcm\n+include $(BUILD_KEY_CHAR_MAP)\n+\n+file := $(TARGET_OUT_KEYLAYOUT)/qwerty.kl\n+ALL_PREBUILT += $(file)\n+$(file): $(LOCAL_PATH)/qwerty.kl | $(ACP)\n+\t$(transform-prebuilt-to-target)\n \n file := $(TARGET_OUT_KEYLAYOUT)/AVRCP.kl\n ALL_PREBUILT += $(file)\n"", ""qwerty.kcm"": ""@@ -0,0 +1,64 @@\n+[type=QWERTY]                                           \n+                                                        \n+# keycode       display number  base    caps    fn      caps_fn\n+                                                        \n+A               'A'     '2'     'a'     'A'     '#'     0x00\n+B               'B'     '2'     'b'     'B'     '<'     0x00\n+C               'C'     '2'     'c'     'C'     '9'     0x00E7\n+D               'D'     '3'     'd'     'D'     '5'     0x00\n+E               'E'     '3'     'e'     'E'     '2'     0x0301\n+F               'F'     '3'     'f'     'F'     '6'     0x00A5\n+G               'G'     '4'     'g'     'G'     '-'     '_'\n+H               'H'     '4'     'h'     'H'     '['     '{'\n+I               'I'     '4'     'i'     'I'     '$'     0x0302\n+J               'J'     '5'     'j'     'J'     ']'     '}'\n+K               'K'     '5'     'k'     'K'     '\""'     '~'\n+L               'L'     '5'     'l'     'L'     '''     '`'\n+M               'M'     '6'     'm'     'M'     '!'     0x00\n+N               'N'     '6'     'n'     'N'     '>'     0x0303\n+O               'O'     '6'     'o'     'O'     '('     0x00\n+P               'P'     '7'     'p'     'P'     ')'     0x00\n+Q               'Q'     '7'     'q'     'Q'     '*'     0x0300\n+R               'R'     '7'     'r'     'R'     '3'     0x20AC\n+S               'S'     '7'     's'     'S'     '4'     0x00DF\n+T               'T'     '8'     't'     'T'     '+'     0x00A3\n+U               'U'     '8'     'u'     'U'     '&'     0x0308\n+V               'V'     '8'     'v'     'V'     '='     '^'\n+W               'W'     '9'     'w'     'W'     '1'     0x00\n+X               'X'     '9'     'x'     'X'     '8'     0xEF00\n+Y               'Y'     '9'     'y'     'Y'     '%'     0x00A1\n+Z               'Z'     '9'     'z'     'Z'     '7'     0x00\n+                                                        \n+# on pc keyboards\n+COMMA           ','     ','     ','     ';'     ';'     '|'\n+PERIOD          '.'     '.'     '.'     ':'     ':'     0x2026\n+AT              '@'     '0'     '@'     '0'     '0'     0x2022\n+SLASH           '/'     '/'     '/'     '?'     '?'     '\\'\n+                                                        \n+SPACE           0x20    0x20    0x20    0x20    0xEF01  0xEF01\n+ENTER         0xa     0xa     0xa     0xa     0xa     0xa\n+                                                        \n+TAB             0x9     0x9     0x9     0x9     0x9     0x9\n+0               '0'     '0'     '0'     ')'     ')'     ')'\n+1               '1'     '1'     '1'     '!'     '!'     '!'\n+2               '2'     '2'     '2'     '@'     '@'     '@'\n+3               '3'     '3'     '3'     '#'     '#'     '#'\n+4               '4'     '4'     '4'     '$'     '$'     '$'\n+5               '5'     '5'     '5'     '%'     '%'     '%'\n+6               '6'     '6'     '6'     '^'     '^'     '^'\n+7               '7'     '7'     '7'     '&'     '&'     '&'\n+8               '8'     '8'     '8'     '*'     '*'     '*'\n+9               '9'     '9'     '9'     '('     '('     '('\n+                                                        \n+GRAVE           '`'     '`'     '`'     '~'     '`'     '~'\n+MINUS           '-'     '-'     '-'     '_'     '-'     '_'\n+EQUALS          '='     '='     '='     '+'     '='     '+'\n+LEFT_BRACKET    '['     '['     '['     '{'     '['     '{'\n+RIGHT_BRACKET   ']'     ']'     ']'     '}'     ']'     '}'\n+BACKSLASH       '\\'     '\\'     '\\'     '|'     '\\'     '|'\n+SEMICOLON       ';'     ';'     ';'     ':'     ';'     ':'\n+APOSTROPHE      '''     '''     '''     '\""'     '''     '\""'\n+STAR            '*'     '*'     '*'     '*'     '*'     '*'\n+POUND           '#'     '#'     '#'     '#'     '#'     '#'\n+PLUS            '+'     '+'     '+'     '+'     '+'     '+'\n+                                                        \n"", ""qwerty.kl"": ""@@ -0,0 +1,91 @@\n+key 399   GRAVE\n+key 2     1\n+key 3     2\n+key 4     3\n+key 5     4\n+key 6     5\n+key 7     6\n+key 8     7\n+key 9     8\n+key 10    9\n+key 11    0\n+key 158   BACK              WAKE_DROPPED\n+key 230   SOFT_RIGHT        WAKE\n+key 60    SOFT_RIGHT        WAKE\n+key 107   ENDCALL           WAKE_DROPPED\n+key 62    ENDCALL           WAKE_DROPPED\n+key 229   MENU              WAKE_DROPPED\n+key 139   MENU              WAKE_DROPPED\n+key 59    MENU              WAKE_DROPPED\n+key 127   SEARCH            WAKE_DROPPED\n+key 217   SEARCH            WAKE_DROPPED\n+key 228   POUND\n+key 227   STAR\n+key 231   CALL              WAKE_DROPPED\n+key 61    CALL              WAKE_DROPPED\n+key 232   DPAD_CENTER       WAKE_DROPPED\n+key 108   DPAD_DOWN         WAKE_DROPPED\n+key 103   DPAD_UP           WAKE_DROPPED\n+key 102   HOME              WAKE\n+key 105   DPAD_LEFT         WAKE_DROPPED\n+key 106   DPAD_RIGHT        WAKE_DROPPED\n+key 115   VOLUME_UP\n+key 114   VOLUME_DOWN\n+key 116   POWER             WAKE\n+key 212   CAMERA\n+\n+key 16    Q\n+key 17    W\n+key 18    E\n+key 19    R\n+key 20    T\n+key 21    Y\n+key 22    U\n+key 23    I\n+key 24    O\n+key 25    P\n+key 26    LEFT_BRACKET\n+key 27    RIGHT_BRACKET\n+key 43    BACKSLASH\n+\n+key 30    A\n+key 31    S\n+key 32    D\n+key 33    F\n+key 34    G\n+key 35    H\n+key 36    J\n+key 37    K\n+key 38    L\n+key 39    SEMICOLON\n+key 40    APOSTROPHE\n+key 14    DEL\n+        \n+key 44    Z\n+key 45    X\n+key 46    C\n+key 47    V\n+key 48    B\n+key 49    N\n+key 50    M\n+key 51    COMMA\n+key 52    PERIOD\n+key 53    SLASH\n+key 28    ENTER\n+        \n+key 56    ALT_LEFT\n+key 100   ALT_RIGHT\n+key 42    SHIFT_LEFT\n+key 54    SHIFT_RIGHT\n+key 15    TAB\n+key 57    SPACE\n+key 150   EXPLORER\n+key 155   ENVELOPE        \n+\n+key 12    MINUS\n+key 13    EQUALS\n+key 215   AT\n+\n+# On an AT keyboard: ESC, F10\n+key 1     BACK              WAKE_DROPPED\n+key 68    MENU              WAKE_DROPPED\n"", ""qwerty2.kcm"": ""@@ -0,0 +1,81 @@\n+[type=QWERTY]                                           \n+                                                        \n+# this keymap is to be used in the emulator only. note\n+# that I have liberally modified certain key strokes to\n+# make it more usable in this context. the main differences\n+# with the reference keyboard image are:\n+#\n+#  - cap-2 produces '@', and not '\""', without that, typing\n+#    email addresses becomes a major pain with a qwerty\n+#    keyboard. note that you can type '\""' with fn-E anyway.\n+#\n+#  - cap-COMMA and cap-PERIOD return '<' and '>', instead\n+#    of nothing.\n+#\n+#\n+                                                        \n+# keycode       display  number base    caps    fn      caps_fn\n+                                                        \n+A               'A'     '2'     'a'     'A'     'a'     'A'\n+B               'B'     '2'     'b'     'B'     'b'     'B'\n+C               'C'     '2'     'c'     'C'     0x00e7  0x00E7\n+D               'D'     '3'     'd'     'D'     '''     '''\n+E               'E'     '3'     'e'     'E'     '\""'     0x0301\n+F               'F'     '3'     'f'     'F'     '['     '['\n+G               'G'     '4'     'g'     'G'     ']'     ']'\n+H               'H'     '4'     'h'     'H'     '<'     '<'\n+I               'I'     '4'     'i'     'I'     '-'     0x0302\n+J               'J'     '5'     'j'     'J'     '>'     '>'\n+K               'K'     '5'     'k'     'K'     ';'     '~'\n+L               'L'     '5'     'l'     'L'     ':'     '`'\n+M               'M'     '6'     'm'     'M'     '%'     0x00\n+N               'N'     '6'     'n'     'N'     0x00    0x0303\n+O               'O'     '6'     'o'     'O'     '+'     '+'\n+P               'P'     '7'     'p'     'P'     '='     0x00A5\n+Q               'Q'     '7'     'q'     'Q'     '|'     0x0300\n+R               'R'     '7'     'r'     'R'     '`'     0x20AC\n+S               'S'     '7'     's'     'S'     '\\'     0x00DF\n+T               'T'     '8'     't'     'T'     '{'     0x00A3\n+U               'U'     '8'     'u'     'U'     '_'     0x0308\n+V               'V'     '8'     'v'     'V'     'v'     'V'\n+W               'W'     '9'     'w'     'W'     '~'     '~'\n+X               'X'     '9'     'x'     'X'     'x'     0xEF00\n+Y               'Y'     '9'     'y'     'Y'     '}'     0x00A1\n+Z               'Z'     '9'     'z'     'Z'     'z'     'Z'\n+                                                        \n+COMMA           ','     ','     ','     '<'     ','     ','\n+PERIOD          '.'     '.'     '.'     '>'     '.'     0x2026\n+AT              '@'     '@'     '@'     '@'     '@'     0x2022\n+SLASH           '/'     '/'     '/'     '?'     '?'     '?'\n+                                                        \n+SPACE           0x20    0x20    0x20    0x20    0xEF01  0xEF01\n+ENTER         0xa     0xa     0xa     0xa     0xa     0xa\n+                                                        \n+0               '0'     '0'     '0'     ')'     ')'     ')'\n+1               '1'     '1'     '1'     '!'     '!'     '!'\n+2               '2'     '2'     '2'     '@'     '@'     '@'\n+3               '3'     '3'     '3'     '#'     '#'     '#'\n+4               '4'     '4'     '4'     '$'     '$'     '$'\n+5               '5'     '5'     '5'     '%'     '%'     '%'\n+6               '6'     '6'     '6'     '^'     '^'     '^'\n+7               '7'     '7'     '7'     '&'     '&'     '&'\n+8               '8'     '8'     '8'     '*'     '*'     '*'\n+9               '9'     '9'     '9'     '('     '('     '('\n+                                                        \n+# the rest is for a qwerty keyboard\n+#\n+TAB             0x9     0x9     0x9     0x9     0x9     0x9\n+GRAVE           '`'     '`'     '`'     '~'     '`'     '~'\n+MINUS           '-'     '-'     '-'     '_'     '-'     '_'\n+EQUALS          '='     '='     '='     '+'     '='     '+'\n+LEFT_BRACKET    '['     '['     '['     '{'     '['     '{'\n+RIGHT_BRACKET   ']'     ']'     ']'     '}'     ']'     '}'\n+BACKSLASH       '\\'     '\\'     '\\'     '|'     '\\'     '|'\n+SEMICOLON       ';'     ';'     ';'     ':'     ';'     ':'\n+APOSTROPHE      '''     '''     '''     '\""'     '''     '\""'\n+STAR            '*'     '*'     '*'     '*'     '*'     '*'\n+POUND           '#'     '#'     '#'     '#'     '#'     '#'\n+PLUS            '+'     '+'     '+'     '+'     '+'     '+'\n+                                                        \n+                                                        \n+                                                        \n""}","bug 
"
18362,Xavier Ducrohet,Project property cleanup.,"['sdkmanager/libs/sdklib/src/com/android/sdklib/internal/project/ProjectPropertiesWorkingCopy.java', 'anttasks/src/com/android/ant/TaskHelper.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/internal/project/ProjectProperties.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/internal/project/ProjectCreator.java']","Project property cleanup.

Remove obsolete sdk-location on project update, don't
use it as backup location anymore (main_rules.xml won't work with
it anyway).

Remove the old application.package properties since older platforms
will use the new rules anyway.

Change-Id: I5a5ec3d1289cf793dd0f98fb778bd84086976c52",https://android-review.googlesource.com/c/18362,"refactor,deprecate
",deprecat,Deprecat;,"{""TaskHelper.java"": ""@@ -37,13 +37,7 @@ final class TaskHelper {\n \n         // check if it's valid and exists\n         if (sdkOsPath == null || sdkOsPath.length() == 0) {\n-            // LEGACY support: project created with 1.6 or before may be using a different\n-            // property to declare the location of the SDK. At this point, we cannot\n-            // yet check which target is running so we check both always.\n-            sdkOsPath = antProject.getProperty(ProjectProperties.PROPERTY_SDK_LEGACY);\n-            if (sdkOsPath == null || sdkOsPath.length() == 0) {\n-                throw new BuildException(\""SDK Location is not set.\"");\n-            }\n+            throw new BuildException(\""SDK Location is not set.\"");\n         }\n \n         // Make sure the OS sdk path ends with a directory separator\n"", ""ProjectCreator.java"": ""@@ -170,7 +170,6 @@ public class ProjectCreator {\n      * @param pathToMainProject if non-null the project will be setup to test a main project\n      * located at the given path.\n      */\n-    @SuppressWarnings(\""deprecation\"")\n     public void createProject(String folderPath, String projectName,\n             String packageName, String activityEntry, IAndroidTarget target, boolean library,\n             String pathToMainProject) {\n@@ -205,12 +204,6 @@ public class ProjectCreator {\n             ProjectPropertiesWorkingCopy buildProperties = ProjectProperties.create(folderPath,\n                     PropertyType.BUILD);\n \n-            // only put application.package for older target where the rules file didn't.\n-            // grab it through xpath\n-            if (target.getVersion().getApiLevel() < 4) {\n-                buildProperties.setProperty(ProjectProperties.PROPERTY_APP_PACKAGE, packageName);\n-            }\n-\n             if (isTestProject) {\n                 buildProperties.setProperty(ProjectProperties.PROPERTY_TESTED_PROJECT,\n                         pathToMainProject);\n"", ""ProjectProperties.java"": ""@@ -63,11 +63,8 @@ public class ProjectProperties {\n     public final static String PROPERTY_PROGUARD_CONFIG = \""proguard.config\"";\n \n     public final static String PROPERTY_SDK = \""sdk.dir\"";\n-    // LEGACY - compatibility with 1.6 and before\n-    public final static String PROPERTY_SDK_LEGACY = \""sdk-location\"";\n-\n-    @Deprecated //This is not needed by the new Ant rules\n-    public final static String PROPERTY_APP_PACKAGE = \""application.package\"";\n+    // LEGACY - Kept so that we can actually remove it from default.properties.\n+    private final static String PROPERTY_SDK_LEGACY = \""sdk-location\"";\n \n     public final static String PROPERTY_SPLIT_BY_DENSITY = \""split.density\"";\n     public final static String PROPERTY_SPLIT_BY_ABI = \""split.abi\"";\n@@ -87,29 +84,39 @@ public class ProjectProperties {\n     public static enum PropertyType {\n         BUILD(SdkConstants.FN_BUILD_PROPERTIES, BUILD_HEADER, new String[] {\n                 PROPERTY_BUILD_SOURCE_DIR, PROPERTY_BUILD_OUT_DIR\n-            }),\n+            }, null),\n         DEFAULT(SdkConstants.FN_DEFAULT_PROPERTIES, DEFAULT_HEADER, new String[] {\n                 PROPERTY_TARGET, PROPERTY_LIBRARY, PROPERTY_LIB_REF_REGEX,\n                 PROPERTY_KEY_STORE, PROPERTY_KEY_ALIAS, PROPERTY_PROGUARD_CONFIG\n-            }),\n+            }, null),\n         LOCAL(SdkConstants.FN_LOCAL_PROPERTIES, LOCAL_HEADER, new String[] {\n                 PROPERTY_SDK\n-            }),\n+            },\n+            new String[] { PROPERTY_SDK_LEGACY }),\n         EXPORT(SdkConstants.FN_EXPORT_PROPERTIES, EXPORT_HEADER, new String[] {\n                 PROPERTY_PACKAGE, PROPERTY_VERSIONCODE, PROPERTY_PROJECTS,\n                 PROPERTY_KEY_STORE, PROPERTY_KEY_ALIAS\n-            });\n+            }, null);\n \n         private final String mFilename;\n         private final String mHeader;\n         private final Set<String> mKnownProps;\n+        private final Set<String> mRemovedProps;\n \n-        PropertyType(String filename, String header, String[] validProps) {\n+        PropertyType(String filename, String header, String[] validProps, String[] removedProps) {\n             mFilename = filename;\n             mHeader = header;\n             HashSet<String> s = new HashSet<String>();\n-            s.addAll(Arrays.asList(validProps));\n+            if (validProps != null) {\n+                s.addAll(Arrays.asList(validProps));\n+            }\n             mKnownProps = Collections.unmodifiableSet(s);\n+            s.clear();\n+            if (removedProps != null) {\n+                s.addAll(Arrays.asList(removedProps));\n+            }\n+            mRemovedProps = Collections.unmodifiableSet(s);\n+\n         }\n \n         public String getFilename() {\n@@ -132,6 +139,19 @@ public class ProjectProperties {\n \n             return false;\n         }\n+\n+        /**\n+         * Returns whether a given property should be removed for the property type.\n+         */\n+        public boolean isRemovedProperty(String name) {\n+            for (String propRegex : mRemovedProps) {\n+                if (propRegex.equals(name) || Pattern.matches(propRegex, name)) {\n+                    return true;\n+                }\n+            }\n+\n+            return false;\n+        }\n     }\n \n     private final static String LOCAL_HEADER =\n"", ""ProjectPropertiesWorkingCopy.java"": ""@@ -42,7 +42,6 @@ import java.util.regex.Matcher;\n  * To get access to an instance, use {@link ProjectProperties#makeWorkingCopy()} or\n  * {@link ProjectProperties#create(IAbstractFolder, PropertyType)}.\n  */\n-@SuppressWarnings(\""deprecation\"")\n public class ProjectPropertiesWorkingCopy extends ProjectProperties {\n \n     private final static Map<String, String> COMMENT_MAP = new HashMap<String, String>();\n@@ -56,9 +55,6 @@ public class ProjectPropertiesWorkingCopy extends ProjectProperties {\n                 \""# location of the SDK. This is only used by Ant\\n\"" +\n                 \""# For customization when using a Version Control System, please read the\\n\"" +\n                 \""# header note.\\n\"");\n-        COMMENT_MAP.put(PROPERTY_APP_PACKAGE,\n-                \""# The name of your application package as defined in the manifest.\\n\"" +\n-                \""# Used by the 'uninstall' rule.\\n\"");\n         COMMENT_MAP.put(PROPERTY_PACKAGE,\n                 \""# Package of the application being exported\\n\"");\n         COMMENT_MAP.put(PROPERTY_VERSIONCODE,\n@@ -159,8 +155,10 @@ public class ProjectPropertiesWorkingCopy extends ProjectProperties {\n                         // record the prop\n                         visitedProps.add(key);\n \n-                        // check if the property still exists.\n-                        if (mProperties.containsKey(key)) {\n+                        // check if this property must be removed.\n+                        if (mType.isRemovedProperty(key)) {\n+                            value = null;\n+                        } else if (mProperties.containsKey(key)) { // if the property still exists.\n                             // put the new value.\n                             value = mProperties.get(key);\n                         } else {\n""}","refactor, resource 
"
24210,Miguel Vadillo,omap: rpres: adding constraints API,"['arch/arm/plat-omap/include/plat/rpres.h', 'drivers/remoteproc/rpres.c', 'drivers/remoteproc/rpres_dev.c']","omap: rpres: adding constraints fwk

Adding PM constraints to rpres driver:
- scale_dev: request a change in the opp of the
  device or the domain the device is part of.
- set_lat: request a latency constraint on the
  device or the domain the device is part of.
- set_bw: set the minimum bus troughput for this
  device.

Change-Id: I711fc5c68d2cab812c399764f429d1ada37ced2b
Signed-off-by: Miguel Vadillo <vadillo@ti.com>
Signed-off-by: Fernando Guzman Lugo <fernando.lugo@ti.com>",https://android-review.googlesource.com/c/24210,"feature 
",feature,Feature;,"{""rpres.h"": ""@@ -14,6 +14,10 @@\n #ifndef _PLAT_OMAP_RPRES_H\n #define _PLAT_OMAP_RPRES_H\n \n+#define RPRES_SCALE\t0\n+#define RPRES_LAT\t1\n+#define RPRES_BW\t2\n+\n enum {\n \tRPRES_INACTIVE,\n \tRPRES_ACTIVE,\n@@ -22,9 +26,9 @@ enum {\n struct rpres_ops {\n \tint (*start)(struct platform_device *pdev);\n \tint (*stop)(struct platform_device *pdev);\n-\t/* no PM for the momment */\n-\t//int (*set_constraint)(struct device *dev, void *arg);\n-\t//int (*remove_constraint)(struct device *dev);\n+\tint (*set_lat)(struct platform_device *pdev, long v);\n+\tint (*set_bw)(struct platform_device *pdev, long v);\n+\tint (*scale_dev)(struct platform_device *pdev, long v);\n };\n \n struct rpres_platform_data {\n@@ -46,4 +50,5 @@ struct rpres {\n \n struct rpres *rpres_get(const char *);\n void rpres_put(struct rpres *);\n+int rpres_set_cstrs(struct rpres *, u32 type, long val);\n #endif /* _PLAT_OMAP_RPRES_H */\n"", ""rpres.c"": ""@@ -75,6 +75,46 @@ void rpres_put(struct rpres *obj)\n }\n EXPORT_SYMBOL(rpres_put);\n \n+int rpres_set_cstrs(struct rpres *obj, u32 type, long val)\n+{\n+\tint ret;\n+\tstruct rpres_platform_data *pdata = obj->pdev->dev.platform_data;\n+\tstruct platform_device *pdev = obj->pdev;\n+\tchar *cstr_name[] = {\""scale\"", \""latency\"", \""bandwidth\""};\n+\tint (*func)(struct platform_device *, long);\n+\n+\tswitch (type) {\n+\tcase RPRES_SCALE:\n+\t\tfunc = pdata->ops->scale_dev;\n+\t\tbreak;\n+\tcase RPRES_LAT:\n+\t\tfunc = pdata->ops->set_lat;\n+\t\tbreak;\n+\tcase RPRES_BW:\n+\t\tfunc = pdata->ops->set_bw;\n+\t\tbreak;\n+\tdefault:\n+\t\tdev_err(&pdev->dev, \""Invalid constraint\\n\"");\n+\t\treturn -EINVAL;\n+\t}\n+\n+\tmutex_lock(&obj->lock);\n+\tif (obj->state == RPRES_INACTIVE) {\n+\t\tmutex_unlock(&obj->lock);\n+\t\tpr_err(\""%s: resource inactive\\n\"", __func__);\n+\t\treturn -EPERM;\n+\t}\n+\n+\tdev_dbg(&pdev->dev, \""Set %s constraint %ld\\n\"", cstr_name[type], val);\n+\tret = func(pdev, val);\n+\tif (ret)\n+\t\tdev_err(&pdev->dev, \""Error %s constraint\\n\"", cstr_name[type]);\n+\tmutex_unlock(&obj->lock);\n+\n+\treturn ret;\n+}\n+EXPORT_SYMBOL(rpres_set_cstrs);\n+\n static int rpres_probe(struct platform_device *pdev)\n {\n \tstruct device *dev = &pdev->dev;\n"", ""rpres_dev.c"": ""@@ -19,6 +19,10 @@\n #include <plat/omap_hwmod.h>\n #include <plat/clock.h>\n #include <plat/rpres.h>\n+#include <linux/pm_qos_params.h>\n+#include <plat/common.h>\n+#include <plat/omap-pm.h>\n+#include \""../../arch/arm/mach-omap2/dvfs.h\""\n \n static void _enable_optional_clocks(struct omap_hwmod *oh)\n {\n@@ -68,9 +72,49 @@ static int rpres_iss_shutdown(struct platform_device *pdev)\n \treturn ret;\n }\n \n+static int rpres_scale_core(struct platform_device *pdev, long val)\n+{\n+\tstruct device *l3_dev = omap2_get_l3_device();\n+\treturn omap_device_scale(&pdev->dev, l3_dev, val);\n+}\n+\n+static int rpres_scale_ivahd(struct platform_device *pdev, long val)\n+{\n+\treturn omap_device_scale(&pdev->dev, &pdev->dev, val);\n+}\n+\n+static int rpres_set_dev_lat(struct platform_device *pdev, long val)\n+{\n+\treturn omap_pm_set_max_dev_wakeup_lat(&pdev->dev, &pdev->dev, val);\n+}\n+\n+static int rpres_set_l3_bw(struct platform_device *pdev, long val)\n+{\n+\treturn omap_pm_set_min_bus_tput(&pdev->dev, OCP_INITIATOR_AGENT, val);\n+}\n+\n static struct rpres_ops iss_ops = {\n \t.start = rpres_iss_enable,\n \t.stop = rpres_iss_shutdown,\n+\t.set_lat = rpres_set_dev_lat,\n+\t.set_bw = rpres_set_l3_bw,\n+\t.scale_dev = rpres_scale_core,\n+};\n+\n+static struct rpres_ops ivahd_ops = {\n+\t.start = omap_device_enable,\n+\t.stop = omap_device_shutdown,\n+\t.set_lat = rpres_set_dev_lat,\n+\t.set_bw = rpres_set_l3_bw,\n+\t.scale_dev = rpres_scale_ivahd,\n+};\n+\n+static struct rpres_ops fdif_ops = {\n+\t.start = omap_device_enable,\n+\t.stop = omap_device_shutdown,\n+\t.set_lat = rpres_set_dev_lat,\n+\t.set_bw = rpres_set_l3_bw,\n+\t.scale_dev = rpres_scale_core,\n };\n \n static struct rpres_ops gen_ops = {\n@@ -90,7 +134,7 @@ static struct rpres_platform_data rpres_data[] = {\n \t{\n \t\t.name = \""rpres_iva\"",\n \t\t.oh_name = \""iva\"",\n-\t\t.ops = &gen_ops,\n+\t\t.ops = &ivahd_ops,\n \t},\n \t{\n \t\t.name = \""rpres_iva_seq0\"",\n@@ -111,7 +155,7 @@ static struct rpres_platform_data rpres_data[] = {\n \t{\n \t\t.name = \""rpres_fdif\"",\n \t\t.oh_name = \""fdif\"",\n-\t\t.ops = &gen_ops,\n+\t\t.ops = &fdif_ops,\n \t},\n \t{\n \t\t.name = \""rpres_sl2if\"",\n""}","bug, refactor 
"
12211,PacketVideo CM,RIO-7680: Fileformat parser changes to support some specific mp4 content.,"['engines/2way/src/pv_2way_sdkinfo.h', 'engines/player/src/pv_player_sdkinfo.h', 'fileformats/mp4/parser/src/assetinfoatoms.cpp', 'engines/author/src/pv_author_sdkinfo.h']",RIO-7680: Fileformat parser changes to support some specific mp4 content.,https://android-review.googlesource.com/c/12211,"Categories: bug, feature 
","bug,feature",Feature;,"{""pv_2way_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PV2WAY_ENGINE_SDKINFO_LABEL \""1006249\""\n+#define PV2WAY_ENGINE_SDKINFO_LABEL \""1006943\""\n #define PV2WAY_ENGINE_SDKINFO_DATE 0x20091007\n \n #endif //PV_2WAY_SDKINFO_H_INCLUDED\n"", ""pv_author_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""1006249\""\n+#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""1006943\""\n #define PVAUTHOR_ENGINE_SDKINFO_DATE 0x20091007\n \n #endif //PV_AUTHOR_SDKINFO_H_INCLUDED\n"", ""pv_player_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVPLAYER_ENGINE_SDKINFO_LABEL \""1006249\""\n+#define PVPLAYER_ENGINE_SDKINFO_LABEL \""1006943\""\n #define PVPLAYER_ENGINE_SDKINFO_DATE 0x20091007\n \n #endif //PV_PLAYER_SDKINFO_H_INCLUDED\n"", ""assetinfoatoms.cpp"": ""@@ -589,12 +589,14 @@ AssetInfoLocationAtom::AssetInfoLocationAtom(MP4_FF_FILE *fp, uint32 size, uint3\n         {\n             _charType = ORIGINAL_CHAR_TYPE_UTF8;\n             // Check to see if the string is actually null-terminated\n+            int32 currPos1 = AtomUtils::getCurrentFilePosition(fp);\n             if (!AtomUtils::readNullTerminatedString(fp, _defaultNotice))\n             {\n                 _success = false;\n                 return;\n             }\n-            count -= _defaultNotice.get_size() + 1;\n+            int32 currPos2 = AtomUtils::getCurrentFilePosition(fp);\n+            count -= (currPos2 - currPos1);\n         }\n \n         PV_MP4_FF_ARRAY_NEW(NULL, oscl_wchar, _defaultNotice.get_size() + 1, _pLocationStruct->_location_name);\n@@ -676,12 +678,14 @@ AssetInfoLocationAtom::AssetInfoLocationAtom(MP4_FF_FILE *fp, uint32 size, uint3\n         {\n             _charType = ORIGINAL_CHAR_TYPE_UTF8;\n             // Check to see if the string is actually null-terminated\n+            int32 currPos1 = AtomUtils::getCurrentFilePosition(fp);\n             if (!AtomUtils::readNullTerminatedString(fp, _astronomical_body))\n             {\n                 _success = false;\n                 return;\n             }\n-            count -= _astronomical_body.get_size() + 1;\n+            int32 currPos2 = AtomUtils::getCurrentFilePosition(fp);\n+            count -= (currPos2 - currPos1);\n         }\n         PV_MP4_FF_ARRAY_NEW(NULL, oscl_wchar, _astronomical_body.get_size() + 1, _pLocationStruct->_astronomical_body);\n         oscl_strncpy(_pLocationStruct->_astronomical_body, _astronomical_body.get_str(), _astronomical_body.get_size());\n@@ -722,12 +726,14 @@ AssetInfoLocationAtom::AssetInfoLocationAtom(MP4_FF_FILE *fp, uint32 size, uint3\n         {\n             _charType = ORIGINAL_CHAR_TYPE_UTF8;\n             // Check to see if the string is actually null-terminated\n+            int32 currPos1 = AtomUtils::getCurrentFilePosition(fp);\n             if (!AtomUtils::readNullTerminatedString(fp, _additional_notes))\n             {\n                 _success = false;\n                 return;\n             }\n-            count -= _additional_notes.get_size() + 1;\n+            int32 currPos2 = AtomUtils::getCurrentFilePosition(fp);\n+            count -= (currPos2 - currPos1);\n         }\n         PV_MP4_FF_ARRAY_NEW(NULL, oscl_wchar, _additional_notes.get_size() + 1, _pLocationStruct->_additional_notes);\n         oscl_strncpy(_pLocationStruct->_additional_notes, _additional_notes.get_str(), _additional_notes.get_size());\n@@ -809,12 +815,14 @@ AssetInfoAlbumAtom::AssetInfoAlbumAtom(MP4_FF_FILE *fp, uint32 size, uint32 type\n         {\n             _charType = ORIGINAL_CHAR_TYPE_UTF8;\n             // Check to see if the string is actually null-terminated\n+            int32 currPos1 = AtomUtils::getCurrentFilePosition(fp);\n             if (!AtomUtils::readNullTerminatedString(fp, _defaultNotice))\n             {\n                 _success = false;\n                 return;\n             }\n-            count -= _defaultNotice.get_size() + 1;\n+            int32 currPos2 = AtomUtils::getCurrentFilePosition(fp);\n+            count -= (currPos2 - currPos1);\n         }\n         if (_defaultNotice.get_size() > size)\n         {\n""}","feature 
"
20170,Tor Norbye,Fix NON-NLS tokens,"['ddms/libs/ddmuilib/src/com/android/ddmuilib/logcat/EditFilterDialog.java', 'traceview/src/com/android/traceview/TimeLineView.java', 'ddms/libs/ddmlib/src/com/android/ddmlib/SyncService.java', 'ddms/app/src/com/android/ddms/StaticPortEditDialog.java', 'ddms/libs/ddmlib/src/com/android/ddmlib/DeviceMonitor.java', 'ddms/libs/ddmuilib/src/com/android/ddmuilib/HeapPanel.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/AndroidConstants.java', 'ddms/libs/ddmlib/src/com/android/ddmlib/HandleNativeHeap.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/manifest/pages/OverviewLinksPart.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/SelectionItem.java', 'eclipse/plugins/com.android.ide.eclipse.ddms/src/com/android/ide/eclipse/ddms/views/NativeHeapView.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/export/ExportLinksPart.java', 'eclipse/plugins/com.android.ide.eclipse.ddms/src/com/android/ide/eclipse/ddms/DdmsPlugin.java', 'eclipse/plugins/com.android.ide.eclipse.ddms/src/com/android/ide/eclipse/ddms/views/ThreadView.java', 'sdkstats/src/com/android/sdkstats/SdkStatsService.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/xml/AndroidManifestParser.java', 'ddms/libs/ddmlib/src/com/android/ddmlib/ClientData.java', 'ddms/app/src/com/android/ddms/AboutDialog.java', 'traceview/src/com/android/traceview/DmTraceReader.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/resources/descriptors/ResourcesDescriptors.java', 'eclipse/plugins/com.android.ide.eclipse.ddms/src/com/android/ide/eclipse/ddms/views/LogCatView.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/AndroidTextEditor.java', 'ddms/libs/ddmuilib/src/com/android/ddmuilib/log/event/EventDisplayOptions.java', 'ddms/libs/ddmuilib/src/com/android/ddmuilib/logcat/LogFilter.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/ProjectCallback.java', 'ddms/libs/ddmuilib/src/com/android/ddmuilib/EmulatorControlPanel.java', 'ddms/libs/ddmlib/src/com/android/ddmlib/Debugger.java', 'eclipse/plugins/com.android.ide.eclipse.ddms/src/com/android/ide/eclipse/ddms/views/EventLogView.java']","Fix NON-NLS tokens

There were a number of // $NON-NLS-1$ references in the codebase.
Eclipse's ""Externalize Strings"" functionality will not handle these
correctly; there must not be a space between the ""//"" and the ""$NON""
tokens.

(I left AndroidXmlEditor.xml alone; it is the file I discovered
the problem in but I fixed those references as part of another
pending checkin.)

Change-Id: If185c88a667273af614f0bee5959fd2618756c05",https://android-review.googlesource.com/c/20170,"bug,resource 
",bug,Bug;,,"bug
"
22675,David Turner,opengl emulator - handle shader string decoding,"['tools/emulator/opengl/host/libs/GLESv2_dec/GL2Decoder.h', 'tools/emulator/opengl/system/GLESv2_enc/gl2.in', 'tools/emulator/opengl/host/libs/GLESv2_dec/GL2Decoder.cpp', 'tools/emulator/opengl/system/GLESv2_enc/gl2.attrib']","opengl emulator - handle shader string decoding

Shader strings are sent over the wire protocal as one concatenated
string. a special api call - glShaderString is used to handle the
encoding and decoding of this string.

Change-Id: Id682763f35e9fcc6215559931db2112a4fa981a9",https://android-review.googlesource.com/c/22675,"feature 
",feature,Others;,"{""GL2Decoder.cpp"": ""@@ -57,7 +57,7 @@ int GL2Decoder::initGL(get_proc_func_t getProcFunc, void *getProcFuncData)\n \n     set_glDrawElementsOffset(s_glDrawElementsOffset);\n     set_glDrawElementsData(s_glDrawElementsData);\n-\n+    set_glShaderString(s_glShaderString);\n     return 0;\n \n }\n@@ -108,3 +108,8 @@ void GL2Decoder::s_glDrawElementsOffset(void *self, GLenum mode, GLsizei count,\n     ctx->glDrawElements(mode, count, type, (void *)offset);\n }\n \n+void GL2Decoder::s_glShaderString(void *self, GLuint shader, GLstr string, GLsizei len)\n+{\n+    GL2Decoder *ctx = (GL2Decoder *)self;\n+    ctx->glShaderSource(shader, 1, &string, NULL);\n+}\n"", ""GL2Decoder.h"": ""@@ -30,8 +30,6 @@ private:\n \n     static void s_glDrawElementsOffset(void *self, GLenum mode, GLsizei count, GLenum type, GLuint offset);\n     static void s_glDrawElementsData(void *self, GLenum mode, GLsizei count, GLenum type, void * data, GLuint datalen);\n-\n-\n-\n+    static void s_glShaderString(void *self, GLuint shader, GLstr string, GLsizei len);\n };\n #endif\n"", ""gl2.attrib"": ""@@ -538,3 +538,8 @@ glGetCompressedTextureFormats\n \tdir formats out\n \tlen formats (count * sizeof(GLint))\n \tflag custom_decoder\n+\n+#GL_ENTRY(void, glShaderString, GLuint shader, GLchar *string, GLsizei len)\n+glShaderString\n+\tlen string len\n+\tflag custom_decoder\n"", ""gl2.in"": ""@@ -211,5 +211,6 @@ GL_ENTRY(void, glVertexAttribPointerOffset, GLuint indx, GLint size, GLenum type\n GL_ENTRY(void, glDrawElementsOffset, GLenum mode, GLsizei count, GLenum type, GLuint offset)\n GL_ENTRY(void, glDrawElementsData, GLenum mode, GLsizei count, GLenum type, void *data, GLuint datalen)\n GL_ENTRY(void, glGetCompressedTextureFormats, int count, GLint *formats)\n+GL_ENTRY(void, glShaderString, GLuint shader, GLstr string, GLsizei len)\n \n \n""}","bug, refactor 
"
18597,Erik Gilling,video: tegra: allow setting output mode without changing fb geometry,['drivers/video/tegra/fb.c'],"video: tegra: allow setting output mode without changing fb geometry

Change-Id: I0a723b4e68c99d2727e12d2c26f1506b1f634f8a
Signed-off-by: Erik Gilling <konkers@android.com>",https://android-review.googlesource.com/c/18597,"feature 
",feature,Others;,"{""fb.c"": ""@@ -120,36 +120,35 @@ static int tegra_fb_set_par(struct fb_info *info)\n \tstruct tegra_fb_info *tegra_fb = info->par;\n \tstruct fb_var_screeninfo *var = &info->var;\n \n-\t/* we only support RGB ordering for now */\n-\tswitch (var->bits_per_pixel) {\n-\tcase 32:\n-\tcase 24:\n-\t\tvar->red.offset = 0;\n-\t\tvar->red.length = 8;\n-\t\tvar->green.offset = 8;\n-\t\tvar->green.length = 8;\n-\t\tvar->blue.offset = 16;\n-\t\tvar->blue.length = 8;\n-\t\ttegra_fb->win->fmt = TEGRA_WIN_FMT_R8G8B8A8;\n-\t\tbreak;\n-\tcase 16:\n-\t\tvar->red.offset = 11;\n-\t\tvar->red.length = 5;\n-\t\tvar->green.offset = 5;\n-\t\tvar->green.length = 6;\n-\t\tvar->blue.offset = 0;\n-\t\tvar->blue.length = 5;\n-\t\ttegra_fb->win->fmt = TEGRA_WIN_FMT_B5G6R5;\n-\t\tbreak;\n-\n-\tcase 0:\n-\t\tbreak;\n-\n-\tdefault:\n-\t\treturn -EINVAL;\n+\tif (var->bits_per_pixel) {\n+\t\t/* we only support RGB ordering for now */\n+\t\tswitch (var->bits_per_pixel) {\n+\t\tcase 32:\n+\t\tcase 24:\n+\t\t\tvar->red.offset = 0;\n+\t\t\tvar->red.length = 8;\n+\t\t\tvar->green.offset = 8;\n+\t\t\tvar->green.length = 8;\n+\t\t\tvar->blue.offset = 16;\n+\t\t\tvar->blue.length = 8;\n+\t\t\ttegra_fb->win->fmt = TEGRA_WIN_FMT_R8G8B8A8;\n+\t\t\tbreak;\n+\t\tcase 16:\n+\t\t\tvar->red.offset = 11;\n+\t\t\tvar->red.length = 5;\n+\t\t\tvar->green.offset = 5;\n+\t\t\tvar->green.length = 6;\n+\t\t\tvar->blue.offset = 0;\n+\t\t\tvar->blue.length = 5;\n+\t\t\ttegra_fb->win->fmt = TEGRA_WIN_FMT_B5G6R5;\n+\t\t\tbreak;\n+\n+\t\tdefault:\n+\t\t\treturn -EINVAL;\n+\t\t}\n+\t\tinfo->fix.line_length = var->xres * var->bits_per_pixel / 8;\n+\t\ttegra_fb->win->stride = info->fix.line_length;\n \t}\n-\tinfo->fix.line_length = var->xres * var->bits_per_pixel / 8;\n-\ttegra_fb->win->stride = info->fix.line_length;\n \n \tif (var->pixclock) {\n \t\tstruct tegra_dc_mode mode;\n""}","feature, bug 
"
8657,Team Android CDMA,Extend ANDROID with CDMA mobile technology support . Feature Complete - Review Comment Fixes,"['core/api/1.xml', 'core/api/current.xml']","Extend ANDROID with CDMA mobile technology support . Feature Complete

This contribution is final functional step of the first release of the CDMA extension of the
Android telephony layers.
It contains changes in the phone related applications, the application
framework telephony packages and in the RIL daemon library space.
The implementation of the CDMA support requires architectural changes in the
telephony package and extensions of the RIL interface.
The application interface (SDK interface) will be extended to provide
CDMA specific features/information to the phone related application and other
applications.
Where ever possible the actual used radio technology is transparent for the
application using mobile connections.

This increment is tested on the Android emulator with a RIL simulator tool and
also tested on a reference HW platform.
The CDMA extension of the telephony stack can be used for Android phones
supporting either CDMA mobile technology only
or world mode including GSM/WCDMA and CDMA.
The following CDMA technologies are considered: IS-95, CDMA2000 1xRTT, CDMA2000
1x EVDO.

This contribution implements the following functionality:

- start up,
- access the CDMA subscription and other information from memory of from the
  card (either SIM, USIM or RUIM),
- register to the network,
- provides registration status to the application for displaying
- be able to handle incoming and outgoing voice calls,
- provide phone and call settings in the settings application
- provide supplementary services in the settings application
- provide supplementary services by in-call menues
- handles TTY and enhance voice privacy
- supports automatic radio technology change for a world mode phone from
  CDMA to GSM/UMTS or vice versa
- send and receive SMS
- configure and receive Broadcast SMS
- receive WAP Push SMS

Signed-off by : Saverio Labella,    saverio.labella@teleca.com
                Sigmar Lingner,     sigmar.lingner@teleca.com",https://android-review.googlesource.com/c/8657,"feature 
",feature,Bug;Feature;Resource;Test;,,"feature 
"
10873,Moiz Sonasath,I2C: OMAP3: Better noise suppression for fast/standard modes,['drivers/i2c/busses/i2c-omap.c'],"I2C: OMAP3: Better noise suppression for fast/standard modes

Use longer noise filter period for fast and standard mode.

Ported from L-O tree, commit: 84bf2c868f3ca996e5bbd3beb2ef502f457140f3

Signed-off-by: Moiz Sonasath <m-sonasath@ti.com>
Signed-off-by: Aaro Koskinen <aaro.koskinen@nokia.com>",https://android-review.googlesource.com/c/10873,"**bug,feature** 
",bug,Others;,"{""i2c-omap.c"": ""@@ -349,8 +349,19 @@ static int omap_i2c_init(struct omap_i2c_dev *dev)\n \n \tif (cpu_is_omap2430() || cpu_is_omap34xx()) {\n \n-\t\t/* HSI2C controller internal clk rate should be 19.2 Mhz */\n-\t\tinternal_clk = 19200;\n+\t\t/*\n+\t\t * HSI2C controller internal clk rate should be 19.2 Mhz for\n+\t\t * HS and for all modes on 2430. On 34xx we can use lower rate\n+\t\t * to get longer filter period for better noise suppression.\n+\t\t * The filter is iclk (fclk for HS) period.\n+\t\t */\n+\t\tif (dev->speed > 400 || cpu_is_omap2430())\n+\t\t\tinternal_clk = 19200;\n+\t\telse if (dev->speed > 100)\n+\t\t\tinternal_clk = 9600;\n+\t\telse\n+\t\t\tinternal_clk = 4000;\n+\n \t\tfclk_rate = clk_get_rate(dev->fclk) / 1000;\n \n \t\t/* Compute prescaler divisor */\n""}","bug 
"
23611,vchtchetkine,"Fix cmdline parsing, and some comments.","['sources/host-tools/ndk-stack/ndk-stack-parser.h', 'sources/host-tools/ndk-stack/ndk-stack.c']","Fix cmdline parsing, and some comments.

Change-Id: I51efd2049d9a12a1ce009bef86f5f1da574d2f79",https://android-review.googlesource.com/c/23611,"bug
",bug,Bug;,"{""ndk-stack-parser.h"": ""@@ -14,7 +14,7 @@\n #define NDK_CRASH_PARSER_H_\n \n /*\n- * Contains declaration of a structures and routines that are used to parse ADB\n+ * Contains declaration of structures and routines that are used to parse ADB\n  * log output, filtering out and printing references related to the crash dump.\n  */\n \n@@ -52,7 +52,7 @@ void DestroyNdkCrashParser(NdkCrashParser* parser);\n  *  0 If the line has been part of the crash dump.\n  *  1 If the line has not been part of the crash dump.\n  *  -1 If there was an error when parsing the line.\n- *  \n+ *\n */\n int ParseLine(NdkCrashParser* parser, const char* line);\n \n"", ""ndk-stack.c"": ""@@ -11,8 +11,7 @@\n */\n \n /*\n- * Contains implementation of a class DumpFile of routines that implements\n- * access to a log file.\n+ * Contains implementation of main routine for ndk-stack utility.\n  */\n \n #include <stdio.h>\n@@ -36,7 +35,7 @@ int main(int argc, char **argv, char **envp)\n \n     /* Parse command line. */\n     {\n-        for (int n; n < argc; n++) {\n+        for (int n = 1; n < argc; n++) {\n             if (!strcmp(argv[n], \""-dump\"")) {\n                 n++;\n                 if (n < argc) {\n""}","feature 
"
12479,PacketVideo CM,"RIO-6026: Unit test framework for OMXEncTestApp. Bugs fixed on MP4 composer layer, OMXEncPort, MIO FileInput.","['codecs_v2/omx/omx_testapp_enc/include/omxenctest.h', 'codecs_v2/omx/omx_testapp_enc/src/omxtest_eosmissing_enc.cpp', 'fileformats/mp4/composer/src/mpeg4file.cpp', 'codecs_v2/omx/omx_testapp_enc/src/omxtest_buffer_busy_enc.cpp', 'pvmi/media_io/pvmi_mio_fileinput/src/pvmi_mio_fileinput.cpp', 'engines/player/src/pv_player_sdkinfo.h', 'codecs_v2/omx/omx_testapp_enc/src/omxtest_usebuffer_enc.cpp', 'codecs_v2/omx/omx_testapp_enc/src/omxtest_partialframe_enc.cpp', 'engines/author/src/pv_author_sdkinfo.h', 'codecs_v2/omx/omx_testapp_enc/src/omxtest_param_negotiation_enc.cpp', 'nodes/pvomxencnode/src/pvmf_omx_enc_port.cpp', 'codecs_v2/omx/omx_testapp_enc/include/omxenctestbase.h', 'codecs_v2/omx/omx_testapp_enc/src/omxtest_extra_partialframes_enc.cpp', 'engines/author/test/src/pvaetest.cpp', 'codecs_v2/omx/omx_h264enc/src/omx_avcenc_component.cpp', 'engines/2way/src/pv_2way_sdkinfo.h', 'codecs_v2/omx/omx_testapp_enc/src/omxenctestbase.cpp', 'codecs_v2/omx/omx_testapp_enc/src/omxtest_pause_resume_enc.cpp', 'codecs_v2/omx/omx_testapp_enc/src/omxtest_get_role_enc.cpp', 'codecs_v2/omx/omx_testapp_enc/src/omxenctest.cpp', 'codecs_v2/omx/omx_testapp_enc/src/omxtest_without_marker_enc.cpp']","RIO-6026: Unit test framework for OMXEncTestApp. Bugs fixed on MP4 composer layer, OMXEncPort, MIO FileInput.",https://android-review.googlesource.com/c/12479,"bug,test 
",Bug;Test;,Bug;Test;,,"test 
"
19496,Tor Norbye,Remove some actions before milestone,"['eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/LayoutCanvas.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/SelectionOverlay.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/DynamicContextMenu.java', 'eclipse/dictionary.txt']","Remove some actions before milestone

The Show Include facility doesn't work properly until we backport
layoutlib to all the 2.x SDK layoutlibs.  The Play Animation test
isn't yet productized.

Change-Id: Ib4cd0f0cff029fe23ffaca72a96561a0d748f86f",https://android-review.googlesource.com/c/19496,"**feature**, **refactor** 
",deprecat,Deprecat;Test;,"{""dictionary.txt"": ""@@ -14,6 +14,7 @@ app\n apps\n avd\n avds\n+backport\n basename\n basenames\n bitmask\n"", ""DynamicContextMenu.java"": ""@@ -208,7 +208,9 @@ import java.util.regex.Pattern;\n             }\n         }\n \n-        insertShowIncludedMenu(endId);\n+        // Not yet enabled because we need to backport layoutlib changes to Android 2.0, 2.1, 2.2\n+        // first:\n+        //insertShowIncludedMenu(endId);\n     }\n \n     /**\n"", ""LayoutCanvas.java"": ""@@ -32,8 +32,6 @@ import com.android.ide.eclipse.adt.internal.editors.uimodel.UiDocumentNode;\n import com.android.ide.eclipse.adt.internal.editors.uimodel.UiElementNode;\n import com.android.ide.eclipse.adt.internal.sdk.Sdk;\n import com.android.layoutlib.api.LayoutScene;\n-import com.android.layoutlib.api.SceneResult;\n-import com.android.layoutlib.api.LayoutScene.IAnimationListener;\n import com.android.sdklib.SdkConstants;\n \n import org.eclipse.core.filesystem.EFS;\n@@ -1049,62 +1047,63 @@ class LayoutCanvas extends Canvas {\n         // Add test action\n         // Don't add it at the top above (by the cut action) because the\n         // dynamic context menu makes some assumptions about where things are\n-        // FIXME remove test.\n-        manager.add(new Action(\""Play anim test\"", IAction.AS_PUSH_BUTTON) {\n-            @Override\n-            public void run() {\n-                List<SelectionItem> selection = mSelectionManager.getSelections();\n-                SelectionItem canvasSelection = selection.get(0);\n-                CanvasViewInfo info = canvasSelection.getViewInfo();\n-\n-                Object viewObject = info.getViewObject();\n-                if (viewObject != null) {\n-                    LayoutScene scene = mViewHierarchy.getScene();\n-\n-                    scene.animate(viewObject, \""testanim\"", false /*isFrameworkAnimation*/,\n-                            new IAnimationListener() {\n-                                private int mCount = 0;\n-                                private boolean mPendingDrawing = false;\n-                                public void onNewFrame(LayoutScene scene) {\n-                                    mCount++;\n-                                    mImageOverlay.setImage(scene.getImage());\n-                                    synchronized (this) {\n-                                        if (mPendingDrawing == false) {\n-                                            getDisplay().asyncExec(new Runnable() {\n-                                                public void run() {\n-                                                    drawImage();\n-                                                }\n-                                            });\n-\n-                                            mPendingDrawing = true;\n-                                        }\n-                                    }\n-                                }\n-\n-                                public boolean isCanceled() {\n-                                    return false;\n-                                }\n-\n-                                public void done(SceneResult result) {\n-                                    System.out.println(\""Animation count: \"" + mCount);\n-                                }\n-\n-                                /**\n-                                 * this is called from the UI thread from the asyncRunnable.\n-                                 */\n-                                public void drawImage() {\n-                                    // get last image\n-                                    synchronized (this) {\n-                                        mPendingDrawing = false;\n-                                    }\n-\n-                                    redraw();\n-                                }\n-                            });\n-                }\n-            }\n-        });\n-\n+        //// FIXME remove test.\n+        //import com.android.layoutlib.api.SceneResult;\n+        //import com.android.layoutlib.api.LayoutScene.IAnimationListener;\n+        //manager.add(new Action(\""Play anim test\"", IAction.AS_PUSH_BUTTON) {\n+        //    @Override\n+        //    public void run() {\n+        //        List<SelectionItem> selection = mSelectionManager.getSelections();\n+        //        SelectionItem canvasSelection = selection.get(0);\n+        //        CanvasViewInfo info = canvasSelection.getViewInfo();\n+        //\n+        //        Object viewObject = info.getViewObject();\n+        //        if (viewObject != null) {\n+        //            LayoutScene scene = mViewHierarchy.getScene();\n+        //\n+        //            scene.animate(viewObject, \""testanim\"", false /*isFrameworkAnimation*/,\n+        //                    new IAnimationListener() {\n+        //                        private int mCount = 0;\n+        //                        private boolean mPendingDrawing = false;\n+        //                        public void onNewFrame(LayoutScene scene) {\n+        //                            mCount++;\n+        //                            mImageOverlay.setImage(scene.getImage());\n+        //                            synchronized (this) {\n+        //                                if (mPendingDrawing == false) {\n+        //                                    getDisplay().asyncExec(new Runnable() {\n+        //                                        public void run() {\n+        //                                            drawImage();\n+        //                                        }\n+        //                                    });\n+        //\n+        //                                    mPendingDrawing = true;\n+        //                                }\n+        //                            }\n+        //                        }\n+        //\n+        //                        public boolean isCanceled() {\n+        //                            return false;\n+        //                        }\n+        //\n+        //                        public void done(SceneResult result) {\n+        //                            System.out.println(\""Animation count: \"" + mCount);\n+        //                        }\n+        //\n+        //                        /**\n+        //                         * this is called from the UI thread from the asyncRunnable.\n+        //                         */\n+        //                        public void drawImage() {\n+        //                            // get last image\n+        //                            synchronized (this) {\n+        //                                mPendingDrawing = false;\n+        //                            }\n+        //\n+        //                            redraw();\n+        //                        }\n+        //                    });\n+        //        }\n+        //    }\n+        //});\n \n         manager.add(new Separator());\n \n"", ""SelectionOverlay.java"": ""@@ -23,7 +23,6 @@ import com.android.ide.common.api.Rect;\n import com.android.ide.eclipse.adt.internal.editors.layout.gre.NodeProxy;\n import com.android.ide.eclipse.adt.internal.editors.layout.gre.RulesEngine;\n \n-import java.util.Collections;\n import java.util.List;\n \n /**\n@@ -114,6 +113,7 @@ public class SelectionOverlay extends Overlay {\n         gc.fillRect(r);\n         gc.drawRect(r);\n \n+        /* Label hidden pending selection visual design\n         if (displayName == null || isMultipleSelection) {\n             return;\n         }\n@@ -125,5 +125,6 @@ public class SelectionOverlay extends Overlay {\n         }\n         gc.useStyle(DrawingStyle.HELP);\n         gc.drawBoxedStrings(xs, ys, Collections.singletonList(displayName));\n+        */\n     }\n }\n""}","bug, refactor 
"
22348,David Turner,Revert 776bd3e46c2fb5c003ecec4fee99f01943876644,"['tools/emulator/system/qemu-props/Android.mk', 'tools/emulator/system/sensors/Android.mk', 'tools/emulator/system/qemud/Android.mk', 'tools/emulator/system/gps/Android.mk']","Revert 776bd3e46c2fb5c003ecec4fee99f01943876644

Unfortunately, we need to keep duplicate libraries under sdk/emulator/
to avoid breaking a few internal branches.

    commit 776bd3e46c2fb5c003ecec4fee99f01943876644
    Author: David 'Digit' Turner <digit@android.com>
    Date:   Thu Apr 7 10:58:07 2011 +0200

    emulator: Remove the global Make variable trick for emulator-specific system modules.

    Remove a sad trick that was used to smoothly move the platform-specific emulator
    modules from sdk/emulator/ to development/tools/emulator/system without creating
    build conflicts.

    Now that the sdk/ modules have been removed, we can get rid of the guard variable.

Change-Id: Id5c44a4160191d8ac9afcbbeeef7de0b9a5b0f6f",https://android-review.googlesource.com/c/22348,"bug,refactor 
","bug,refactor",resource,"{""Android.mk"": ""@@ -12,6 +12,14 @@\n # See the License for the specific language governing permissions and\n # limitations under the License.\n \n+\n+# We're moving the emulator-specific platform libs to\n+# development.git/tools/emulator/. The following test is to ensure\n+# smooth builds even if the tree contains both versions.\n+#\n+ifndef BUILD_EMULATOR_SENSORS_MODULE\n+BUILD_EMULATOR_SENSORS_MODULE := true\n+\n LOCAL_PATH := $(call my-dir)\n \n ifneq ($(TARGET_PRODUCT),sim)\n@@ -26,3 +34,5 @@ LOCAL_MODULE := sensors.goldfish\n LOCAL_MODULE_TAGS := debug\n include $(BUILD_SHARED_LIBRARY)\n endif\n+\n+endif # BUILD_EMULATOR_SENSORS_MODULE\n""}","Categories: bug 
"
13540,Mike Lockwood,Make adb pull use . as the target file directory if you don't supply one.,['adb/commandline.c'],"Make adb pull use . as the target file directory if you don't supply one.
",https://android-review.googlesource.com/c/13540,"feature,test 
",feature,Others;,"{""commandline.c"": ""@@ -110,7 +110,7 @@ void help()\n         \""\\n\""\n         \""device commands:\\n\""\n         \""  adb push <local> <remote>    - copy file/dir to device\\n\""\n-        \""  adb pull <remote> <local>    - copy file/dir from device\\n\""\n+        \""  adb pull <remote> [<local>]  - copy file/dir from device\\n\""\n         \""  adb sync [ <directory> ]     - copy host->device only if changed\\n\""\n         \""                                 (see 'adb help all')\\n\""\n         \""  adb shell                    - run remote shell interactively\\n\""\n@@ -1022,8 +1022,13 @@ top:\n     }\n \n     if(!strcmp(argv[0], \""pull\"")) {\n-        if(argc != 3) return usage();\n-        return do_sync_pull(argv[1], argv[2]);\n+        if (argc == 2) {\n+            return do_sync_pull(argv[1], \"".\"");\n+        } else if (argc == 3) {\n+            return do_sync_pull(argv[1], argv[2]);\n+        } else {\n+            return usage();\n+        }\n     }\n \n     if(!strcmp(argv[0], \""install\"")) {\n""}","feature 
"
23091,Tor Norbye,NPE safeguard,['eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/MarqueeGesture.java'],"NPE safeguard

Change-Id: I3f55c21f79ad66bed1329a2f5882deb94e93be62",https://android-review.googlesource.com/c/23091,"bug
",bug,Others;,"{""MarqueeGesture.java"": ""@@ -65,6 +65,10 @@ public class MarqueeGesture extends Gesture {\n \n     @Override\n     public void update(ControlPoint pos) {\n+        if (mOverlay == null) {\n+            return;\n+        }\n+\n         int x = Math.min(pos.x, mStart.x);\n         int y = Math.min(pos.y, mStart.y);\n         int w = Math.abs(pos.x - mStart.x);\n""}","bug 
"
15742,Brian Muramatsu,Add/Remove Some @KnownFailure Annotations,"['libcore/nio_char/src/test/java/tests/api/java/nio/charset/CharsetProviderTest.java', 'libcore/luni/src/test/java/tests/api/java/lang/reflect/ParameterizedTypeTest.java', 'libcore/luni/src/test/java/tests/api/java/net/MulticastSocketTest.java', 'libcore/sql/src/test/java/org/apache/harmony/sql/tests/java/sql/DriverManagerTest.java']","Add/Remove Some @KnownFailure Annotations

Bug 2639444 2564250 2639393

Remove the @KnownFailure annotations form tests now passing in
Froyo for Nexus One using the CTS test runner. Put on
@KnownFailure annotations for those that are failing but passing
with the run-core-tests test runner.

MultiSocketTest is an exception that doesn't seem to make sense,
and fails in both runners.

Change-Id: Id8eb6b5d6f2b04b77434411f2b04c56cd61acf85",https://android-review.googlesource.com/c/15742,"test,bug 
","test,bug",Bug;Deprecat;Test;,"{""ParameterizedTypeTest.java"": ""@@ -55,6 +55,7 @@ public class ParameterizedTypeTest extends GenericReflectionTestsBase {\n             args = {}\n         )\n     })\n+    @KnownFailure(\""Fails in CTS but passes under run-core-tests\"")\n     public void testStringParameterizedSuperClass() {\n         Class<? extends B> clazz = B.class;\n         Type genericSuperclass = clazz.getGenericSuperclass();\n@@ -91,6 +92,7 @@ public class ParameterizedTypeTest extends GenericReflectionTestsBase {\n             args = {}\n         )\n     })\n+    @KnownFailure(\""Fails in CTS but passes under run-core-tests\"")\n     public void testTypeParameterizedSuperClass() {\n         Class<? extends D> clazz = D.class;\n         Type genericSuperclass = clazz.getGenericSuperclass();\n"", ""MulticastSocketTest.java"": ""@@ -163,6 +163,7 @@ public class MulticastSocketTest extends SocketTestCase {\n \t/**\n \t * @tests java.net.MulticastSocket#getInterface()\n \t */\n+        @KnownFailure(\""Matching getter/setter pairs should be used.\"")\n \tpublic void test_getInterface() throws Exception {\n \t\t// Test for method java.net.InetAddress\n \t\t// java.net.MulticastSocket.getInterface()\n@@ -352,7 +353,6 @@ public class MulticastSocketTest extends SocketTestCase {\n \t * @throws InterruptedException \n \t * @tests java.net.MulticastSocket#joinGroup(java.net.SocketAddress,java.net.NetworkInterface)\n \t */\n-    @KnownFailure(\""Fails in CTS but passes under run-core-tests\"")\n \tpublic void test_joinGroupLjava_net_SocketAddressLjava_net_NetworkInterface() throws IOException, InterruptedException {\n \t\t// security manager that allows us to check that we only return the\n \t\t// addresses that we should\n"", ""CharsetProviderTest.java"": ""@@ -140,7 +140,6 @@ public class CharsetProviderTest extends TestCase {\n     )\n     @AndroidOnly(\""Looks like RI doesn't use current thread's context class \""+\n     \""loader to lookup charset providers\"")\n-    @KnownFailure(\""Fails in CTS but passes under run-core-tests\"")\n     public void testIsSupported_And_ForName_NormalProvider() throws Exception {\n         try {\n             assertFalse(Charset.isSupported(\""mockCharset10\""));\n@@ -267,6 +266,7 @@ public class CharsetProviderTest extends TestCase {\n         method = \""charsetForName\"",\n         args = {String.class}\n     )\n+    @KnownFailure(\""Fails in CTS but passes under run-core-tests\"")\n     public void testIsSupported_InsufficientPrivilege() throws Exception {\n         SecurityManager oldMan = System.getSecurityManager();\n         System.setSecurityManager(new MockSecurityManager());\n"", ""DriverManagerTest.java"": ""@@ -372,7 +372,7 @@ public class DriverManagerTest extends TestCase {\n         method = \""getDrivers\"",\n         args = {}\n     )\n-    @KnownFailure(\""We're working out issues with built-in SQL drivers\"")\n+    // We're working out issues with built-in SQL drivers\n     public void testGetDrivers() {\n         // Load a driver manager\n         Enumeration<Driver> driverList = DriverManager.getDrivers();\n@@ -761,5 +761,3 @@ public class DriverManagerTest extends TestCase {\n     }\n \n } // end class DriverManagerTest\n-\n-\n""}","test, bug 
"
19277,Ying Wang,"Put cts-test-coverage report to the dist dir if ""cts"" is in the make goals.",['CtsTestCoverage.mk'],"Put cts-test-coverage report to the dist dir if ""cts"" is in the make
goals.

Bug: 3245588
Change-Id: I7cad15622e1c33e6789e8cd305606554ca07af85",https://android-review.googlesource.com/c/19277,"test, bug 
","test,resource,bug",Resource;Test;,"{""CtsTestCoverage.mk"": ""@@ -19,13 +19,24 @@\n \n include cts/CtsTestCaseList.mk\n \n-CTS_API_COVERAGE_DEPENDENCIES := cts-api-coverage dexdeps $(ACP)\n+CTS_API_COVERAGE_EXE := $(HOST_OUT_EXECUTABLES)/cts-api-coverage\n \n-.PHONY: cts-test-coverage\n-cts-test-coverage: $(CTS_COVERAGE_TEST_CASE_LIST) $(CTS_API_COVERAGE_DEPENDENCIES)\n+CTS_API_COVERAGE_DEPENDENCIES := $(CTS_API_COVERAGE_EXE) dexdeps $(ACP)\n+\n+cts-test-coverage-report := $(HOST_OUT)/cts/test-coverage/api-coverage.xml\n+\n+$(cts-test-coverage-report) : $(CTS_COVERAGE_TEST_CASE_LIST) $(CTS_API_COVERAGE_DEPENDENCIES)\n \t$(call generate-coverage-report,\""CTS Tests API Coverage Report\"",\\\n \t\t\t$(CTS_COVERAGE_TEST_CASE_LIST),xml,$(HOST_OUT)/cts/test-coverage,api-coverage.xml)\n \n+.PHONY: cts-test-coverage\n+cts-test-coverage : $(cts-test-coverage-report)\n+\n+# Put the test coverage report in the dist dir if \""cts\"" is among the build goals.\n+ifneq ($(filter cts, $(MAKECMDGOALS)),)\n+  $(call dist-for-goals, cts, $(cts-test-coverage-report):cts-test-coverage-report.xml)\n+endif\n+\n .PHONY: cts-verifier-coverage\n cts-verifier-coverage: CtsVerifier $(CTS_API_COVERAGE_DEPENDENCIES)\n \t$(call generate-coverage-report,\""CTS Verifier API Coverage Report\"",\\\n@@ -43,7 +54,7 @@ define generate-coverage-report\n \t$(hide) $(ACP) cts/tools/cts-api-coverage/res/* $(4)\n \n \t$(foreach testcase,$(2),$(eval $(call add-testcase-apk,$(testcase))))\n-\t$(hide) cts-api-coverage -f $(3) -o $(4)/$(5) $(TEST_APKS)\n+\t$(hide) $(CTS_API_COVERAGE_EXE) -f $(3) -o $(4)/$(5) $(TEST_APKS)\n \n \t@echo $(1): file://$(ANDROID_BUILD_TOP)/$(4)/$(5)\n endef\n""}","test 
"
16299,Deleted User,[ARM] tegra: save CP14 registers in CPU context suspend,"['arch/arm/mach-tegra/tegra2_save.S', 'arch/arm/mach-tegra/cortex-a9.S', 'arch/arm/mach-tegra/power.h', 'arch/arm/mach-tegra/platsmp.c']","[ARM] tegra: save CP14 registers in CPU context suspend

The CP14 (debug interface) registers were not being saved as part of
the CPU suspend context. This can cause attached JTAG debuggers to
lose their mind after CPU hotplug or suspend.

Original Author: Scott Williams <scwilliams@nvidia.com>
Signed-off-by: Gary King <gking@nvidia.com>
Change-Id: Ib6c087a39050be26f19744981e5c6d8dd5ccc61f",https://android-review.googlesource.com/c/16299,"bug 
",bug,Bug;,"{""cortex-a9.S"": ""@@ -37,11 +37,8 @@\n \n #define TTB_FLAGS 0x6A\t@ IRGN_WBWA, OC_RGN_WBWA, S, NOS\n \n-#define CONTEXT_SIZE_WORDS_SHIFT 7\n-#define CONTEXT_SIZE_WORDS (1<<CONTEXT_SIZE_WORDS_SHIFT)\n-\n /*\n- * spooled CPU context is 512B / CPU\n+ * spooled CPU context is 1KB / CPU\n  */\n #define CTX_SP\t\t0\n #define CTX_CPSR\t4\n@@ -108,13 +105,34 @@\n #define CTX_VFP_REGS\t256\n #define CTX_VFP_SIZE\t(32 * 8)\n \n+#define CTX_CP14_REGS\t512\n+#define CTS_CP14_DSCR\t512\n+#define CTX_CP14_WFAR\t516\n+#define CTX_CP14_VCR\t520\n+#define CTX_CP14_CLAIM\t524\n+\n+/* Each of the folowing is 2 32-bit registers */\n+#define CTS_CP14_BKPT_0\t528\n+#define CTS_CP14_BKPT_1\t536\n+#define CTS_CP14_BKPT_2\t544\n+#define CTS_CP14_BKPT_3\t552\n+#define CTS_CP14_BKPT_4\t560\n+#define CTS_CP14_BKPT_5\t568\n+\n+/* Each of the folowing is 2 32-bit registers */\n+#define CTS_CP14_WPT_0\t576\n+#define CTS_CP14_WPT_1\t584\n+#define CTS_CP14_WPT_2\t592\n+#define CTS_CP14_WPT_3\t600\n+\n+#include \""power.h\""\n #include \""power-macros.S\""\n \n .macro\tctx_ptr, rd, tmp\n \tcpu_id\t\\tmp\n \tmov32\t\\rd, tegra_context_area\n \tldr\t\\rd, [\\rd]\n-\tadd\t\\rd, \\rd, \\tmp, lsl #(CONTEXT_SIZE_WORDS_SHIFT+2)\n+\tadd\t\\rd, \\rd, \\tmp, lsl #(CONTEXT_SIZE_BYTES_SHIFT)\n .endm\n \n .macro\ttranslate, pa, va, tmp\n@@ -163,7 +181,7 @@ ENTRY(__cortex_a9_save)\n \n \t/* zero-out context area */\n \tmov\tr9, r8\n-\tadd\tr10, r8, #(CONTEXT_SIZE_WORDS*4)\n+\tadd\tr10, r8, #(CONTEXT_SIZE_BYTES)\n \tmov\tr0, #0\n \tmov\tr1, #0\n \tmov\tr2, #0\n@@ -251,6 +269,48 @@ ENTRY(__cortex_a9_save)\n \tcps\t0x13\t\t\t@ back to SVC\n \tmov\tr8, r0\n \n+\t/* Save CP14 debug controller context */\n+\tadd\tr9, r8, #CTX_CP14_REGS\n+\tmrc     p14, 0, r0, c0, c1, 0\t@ DSCR\n+\tmrc\tp14, 0, r1, c0, c6, 0\t@ WFAR\n+\tmrc\tp14, 0, r2, c0, c7, 0\t@ VCR\n+\tmrc\tp14, 0, r3, c7, c9, 6\t@ CLAIM\n+\tstmia\tr9, {r0-r3}\n+\n+\tadd\tr9, r8, #CTS_CP14_BKPT_0\n+\tmrc\tp14, 0, r2, c0, c0, 4\n+\tmrc\tp14, 0, r3, c0, c0, 5\n+\tstmia\tr9!, {r2-r3}     \t@ BRKPT_0\n+\tmrc\tp14, 0, r2, c0, c1, 4\n+\tmrc\tp14, 0, r3, c0, c1, 5\n+\tstmia\tr9!, {r2-r3}     \t@ BRKPT_0\n+\tmrc\tp14, 0, r2, c0, c2, 4\n+\tmrc\tp14, 0, r3, c0, c2, 5\n+\tstmia\tr9!, {r2-r3}     \t@ BRKPT_0\n+\tmrc\tp14, 0, r2, c0, c3, 4\n+\tmrc\tp14, 0, r3, c0, c3, 5\n+\tstmia\tr9!, {r2-r3}     \t@ BRKPT_0\n+\tmrc\tp14, 0, r2, c0, c4, 4\n+\tmrc\tp14, 0, r3, c0, c4, 5\n+\tstmia\tr9!, {r2-r3}     \t@ BRKPT_0\n+\tmrc\tp14, 0, r2, c0, c5, 4\n+\tmrc\tp14, 0, r3, c0, c5, 5\n+\tstmia\tr9!, {r2-r3}     \t@ BRKPT_0\n+\n+\tadd\tr9, r8, #CTS_CP14_WPT_0\n+\tmrc\tp14, 0, r2, c0, c0, 6\n+\tmrc\tp14, 0, r3, c0, c0, 7\n+\tstmia\tr9!, {r2-r3}     \t@ WPT_0\n+\tmrc\tp14, 0, r2, c0, c1, 6\n+\tmrc\tp14, 0, r3, c0, c1, 7\n+\tstmia\tr9!, {r2-r3}     \t@ WPT_0\n+\tmrc\tp14, 0, r2, c0, c2, 6\n+\tmrc\tp14, 0, r3, c0, c2, 7\n+\tstmia\tr9!, {r2-r3}     \t@ WPT_0\n+\tmrc\tp14, 0, r2, c0, c3, 6\n+\tmrc\tp14, 0, r3, c0, c3, 7\n+\tstmia\tr9!, {r2-r3}     \t@ WPT_0\n+\n #ifdef CONFIG_CACHE_L2X0\n \tcpu_id\tr4\n \tcmp\tr4, #0\n@@ -268,7 +328,7 @@ ENTRY(__cortex_a9_save)\n \n __cortex_a9_save_clean_cache:\n \tmov\tr10, r8\n-\tadd\tr9, r10, #(CONTEXT_SIZE_WORDS*4)\n+\tadd\tr9, r10, #(CONTEXT_SIZE_BYTES)\n \tadd\tr9, r9, #(L1_CACHE_BYTES-1)\n \tbic\tr10, r10, #(L1_CACHE_BYTES-1)\n \tbic\tr9, r9, #(L1_CACHE_BYTES-1)\n@@ -389,6 +449,50 @@ ENTRY(__cortex_a9_restore)\n \tmsr\tcpsr_cxsf, r6\n \tmsr\tspsr_cxsf, r7\n \n+\t/* Restore CP14 debug controller context */\n+\tadd\tr9, r8, #CTX_CP14_REGS\n+\tldmia\tr9, {r0-r3}\n+\tmcr\tp14, 0, r1, c0, c6, 0\t@ WFAR\n+\tmcr\tp14, 0, r2, c0, c7, 0\t@ VCR\n+\tmcr\tp14, 0, r3, c7, c8, 6\t@ CLAIM\n+\n+\tadd\tr9, r8, #CTS_CP14_BKPT_0\n+\tldmia\tr9!, {r2-r3}\t\t@ BRKPT_0\n+\tmcr\tp14, 0, r2, c0, c0, 4\n+\tmcr\tp14, 0, r3, c0, c0, 5\n+\tldmia\tr9!, {r2-r3}\t\t@ BRKPT_0\n+\tmcr\tp14, 0, r2, c0, c1, 4\n+\tmcr\tp14, 0, r3, c0, c1, 5\n+\tldmia\tr9!, {r2-r3}\t\t@ BRKPT_0\n+\tmcr\tp14, 0, r2, c0, c2, 4\n+\tmcr\tp14, 0, r3, c0, c2, 5\n+\tldmia\tr9!, {r2-r3}\t\t@ BRKPT_0\n+\tmcr\tp14, 0, r2, c0, c3, 4\n+\tmcr\tp14, 0, r3, c0, c3, 5\n+\tldmia\tr9!, {r2-r3}\t\t@ BRKPT_0\n+\tmcr\tp14, 0, r2, c0, c4, 4\n+\tmcr\tp14, 0, r3, c0, c4, 5\n+\tldmia\tr9!, {r2-r3}\t\t@ BRKPT_0\n+\tmcr\tp14, 0, r2, c0, c5, 4\n+\tmcr\tp14, 0, r3, c0, c5, 5\n+\n+\tadd\tr9, r8, #CTS_CP14_WPT_0\n+\tldmia\tr9!, {r2-r3}\t\t@ WPT_0\n+\tmcr\tp14, 0, r2, c0, c0, 6\n+\tmcr\tp14, 0, r3, c0, c0, 7\n+\tldmia\tr9!, {r2-r3}\t\t@ WPT_0\n+\tmcr\tp14, 0, r2, c0, c1, 6\n+\tmcr\tp14, 0, r3, c0, c1, 7\n+\tldmia\tr9!, {r2-r3}\t\t@ WPT_0\n+\tmcr\tp14, 0, r2, c0, c2, 6\n+\tmcr\tp14, 0, r3, c0, c2, 7\n+\tldmia\tr9!, {r2-r3}\t\t@ WPT_0\n+\tmcr\tp14, 0, r2, c0, c3, 6\n+\tmcr\tp14, 0, r3, c0, c3, 7\n+\tisb\n+\tmcr\tp14, 0, r0, c0, c2, 2\t@ DSCR\n+\tisb\n+\n #ifdef CONFIG_VFPv3\n \torr\tr4, lr, #0xF00000\n \tmcr\tp15, 0, r4, c1, c0, 2\t@ enable coproc access\n"", ""platsmp.c"": ""@@ -219,7 +219,7 @@ void __init smp_prepare_cpus(unsigned int max_cpus)\n \tif (max_cpus > ncores)\n \t\tmax_cpus = ncores;\n \n-\ttegra_context_area = kzalloc(512 * ncores, GFP_KERNEL);\n+\ttegra_context_area = kzalloc(CONTEXT_SIZE_BYTES * ncores, GFP_KERNEL);\n \n \tif (tegra_context_area && create_suspend_pgtable()) {\n \t\tkfree(tegra_context_area);\n"", ""power.h"": ""@@ -38,6 +38,10 @@\n #define TEGRA_POWER_PMC_SHIFT\t\t8\n #define TEGRA_POWER_PMC_MASK\t\t0x1ff\n \n+/* CPU Context area (1KB per CPU) */\n+#define CONTEXT_SIZE_BYTES_SHIFT 10\n+#define CONTEXT_SIZE_BYTES (1<<CONTEXT_SIZE_BYTES_SHIFT)\n+\n /* layout of IRAM used for LP1 save & restore */\n #define TEGRA_IRAM_CODE_AREA\t\tTEGRA_IRAM_BASE + SZ_4K\n #define TEGRA_IRAM_CODE_SIZE\t\tSZ_4K\n"", ""tegra2_save.S"": ""@@ -40,10 +40,6 @@\n \n #define TTB_FLAGS 0x6A\t@ IRGN_WBWA, OC_RGN_WBWA, S, NOS\n \n-#define CONTEXT_SIZE_WORDS_SHIFT 7\n-#define CONTEXT_SIZE_WORDS (1<<CONTEXT_SIZE_WORDS_SHIFT)\n-\n-\n #define EMC_CFG\t\t\t\t0xc\n #define EMC_ADR_CFG\t\t\t0x10\n #define EMC_REFRESH\t\t\t0x70\n@@ -99,7 +95,7 @@ __tear_down_master:\n \ttst\tsp, #TEGRA_POWER_EFFECT_LP0\n \tbne\t__l2_clean_done\n \tmov32\tr0, (TEGRA_ARM_PL310_BASE-IO_CPU_PHYS+IO_CPU_VIRT)\n-\tadd\tr3, r8, #(CONTEXT_SIZE_WORDS*4)\n+\tadd\tr3, r8, #(CONTEXT_SIZE_BYTES)\n \tbic\tr8, r8, #0x1f\n \tadd\tr3, r3, #0x1f\n 11:\tstr\tr8, [r0, #L2X0_CLEAN_LINE_PA]\n""}","bug, feature 
"
22639,Brian Carlstrom,Tracking change to dns proxy protocol,['libc/netbsd/net/getnameinfo.c'],"Tracking change to dns proxy protocol

The gethostbyaddr code in system/netd now expects a string address
from inet_ntop, not raw bytes, in order to properly pass addresses
containing null and probably spaces and newlines characeters as well.

Bug: 4344448
Change-Id: I8ec0eab94d5b1d38e9269ba3afb2825e946f8df3",https://android-review.googlesource.com/c/22639,"bug,
",bug;,Bug;Feature;,"{""getnameinfo.c"": ""@@ -135,7 +135,7 @@ int getnameinfo(const struct sockaddr* sa, socklen_t salen, char* host, size_t h\n  * the address. On failure -1 is returned in which case\n  * normal execution flow shall continue. */\n static int\n-android_gethostbyaddr_proxy(struct hostent* hp, const char *addr, socklen_t addrLen, int addrFamily) {\n+android_gethostbyaddr_proxy(struct hostent* hp, const void *addr, socklen_t addrLen, int addrFamily) {\n \n \tint sock;\n \tconst int one = 1;\n@@ -170,7 +170,7 @@ android_gethostbyaddr_proxy(struct hostent* hp, const char *addr, socklen_t addr\n \tproxy_addr.sun_family = AF_UNIX;\n \tstrlcpy(proxy_addr.sun_path, \""/dev/socket/dnsproxyd\"",\n \t\t\tsizeof(proxy_addr.sun_path));\n-\tif (TEMP_FAILURE_RETRY(connect(sock, (const struct sockaddr*) &proxy_addr,\n+\tif (TEMP_FAILURE_RETRY(connect(sock, (const struct sockaddr*) (void*) &proxy_addr,\n \t\t\t\t\t\t\tsizeof(proxy_addr))) != 0) {\n \t\tclose(sock);\n \t\treturn -1;\n@@ -182,7 +182,12 @@ android_gethostbyaddr_proxy(struct hostent* hp, const char *addr, socklen_t addr\n \t\tgoto exit;\n \t}\n \n-\tif (fprintf(proxy, \""gethostbyaddr %s %d %d\"", addr, addrLen, addrFamily) < 0) {\n+\tchar buf[INET6_ADDRSTRLEN]; // big enough for IPv4 and IPv6\n+\tconst char* addrStr = inet_ntop(addrFamily, addr, &buf, sizeof(buf));\n+\tif (addrStr == NULL) {\n+\t\tgoto exit;\n+\t}\n+\tif (fprintf(proxy, \""gethostbyaddr %s %d %d\"", addrStr, addrLen, addrFamily) < 0) {\n \t\tgoto exit;\n \t}\n \n""}","bug 
"
15975,Chih-Wei Huang,Move the atom optimization flags into TARGET_linux-x86.mk.,['libc/Android.mk'],"enable atom optimization only if TARGET_ARCH_VARIANT is x86-atom

If a target wants to enable the atom optimization,
it has to set TARGET_ARCH_VARIANT := x86-atom.",https://android-review.googlesource.com/c/15975,"refactor 
",refactor,Resource;,"{""Android.mk"": ""@@ -447,9 +447,11 @@ else # !arm\n   ifeq ($(TARGET_ARCH),x86)\n     libc_crt_target_cflags := -m32\n \n+  ifeq ($(TARGET_ARCH_VARIANT),x86-atom)\n     # Enable recent IA friendly memory routines (such as for Atom)\n     # These will not work on the earlier x86 machines\n     libc_common_cflags += -mtune=i686 -DUSE_SSSE3 -DUSE_SSE2\n+  endif # atom\n   endif # x86\n endif # !arm\n \n""}","**refactor** 
"
12353,Adrian Taylor,Fixes to allow release-1.0 to build under Ubuntu 9.04.,"['tools/atree/files.cpp', 'tools/atree/fs.cpp']","Fixes to allow release-1.0 to build under Ubuntu 9.04.

This commit contains fixes to allow the release-1.0 branch to build under Ubuntu 9.04 x86-64.

I have not tested the build on other platforms. It's quite possible that this breaks the build on other platforms. It therefore seems a bad idea to approve this change at code-review time unless you can convince yourself the other platforms will be fine.

But even if it doesn't get approved, it is still worth uploading for the benefit of others who wish to get release-1.0 to build under Ubuntu 9.04.

This is the first of three commits in different packages.",https://android-review.googlesource.com/c/12353,"bug
",bug,Bug;Test;,"{""files.cpp"": ""@@ -5,6 +5,8 @@\n #include <unistd.h>\n #include <dirent.h>\n #include <fnmatch.h>\n+#include <string.h>\n+#include <stdlib.h>\n \n static bool\n is_comment_line(const char* p)\n"", ""fs.cpp"": ""@@ -7,6 +7,7 @@\n #include <vector>\n #include <stdio.h>\n #include <errno.h>\n+#include <string.h>\n #include <sys/stat.h>\n #include <unistd.h>\n #include <host/CopyFile.h>\n""}","feature 
"
21414,RaphaÃ«l Moll,Add min-platform-tools-rev to the tools source.properties,['files/tools_source.properties'],"Add min-platform-tools-rev to the tools source.properties

We need that info to generate the repository.xml since it's
a mandatory attribute in the XSD.

Change-Id: Ic341687f07f8d91182d680cd1d3b35e431c38670",https://android-review.googlesource.com/c/21414,"resource 
",resource,Resource;,"{""tools_source.properties"": ""@@ -1,2 +1,3 @@\n Pkg.UserSrc=false\n Pkg.Revision=11\n+Platform.MinPlatformToolsRev=3\n""}","resource 
"
21660,Xavier Ducrohet,Merge ee5c6227 from master. DO NOT MERGE.,"['eclipse/features/com.android.ide.eclipse.adt/feature.xml', 'eclipse/sites/internal/.gitignore', 'eclipse/features/com.android.ide.eclipse.hierarchyviewer/feature.xml', 'eclipse/features/com.android.ide.eclipse.ddms/feature.xml', 'eclipse/features/com.android.ide.eclipse.traceview/feature.xml']","Merge ee5c6227 from master. DO NOT MERGE.

Make the feature require Eclipse 3.5

Change-Id: Idf6d8f74d0fe09c19f963db5d2e2b75aeb24c2a7",https://android-review.googlesource.com/c/21660,"merge 
",merge;resource,Merge;Resource;,"{""feature.xml"": ""@@ -223,8 +223,8 @@\n    </url>\n \n    <requires>\n-      <import plugin=\""org.eclipse.ui\""/>\n-      <import plugin=\""org.eclipse.core.runtime\""/>\n+      <import plugin=\""org.eclipse.ui\"" version=\""3.5\"" match=\""greaterOrEqual\""/>\n+      <import plugin=\""org.eclipse.core.runtime\"" version=\""3.5\"" match=\""greaterOrEqual\""/>\n       <import plugin=\""org.eclipse.ui.ide\""/>\n       <import plugin=\""com.android.ide.eclipse.ddms\"" version=\""10.0.0\"" match=\""greaterOrEqual\""/>\n       <import plugin=\""org.eclipse.core.filesystem\""/>\n"", "".gitignore"": ""@@ -0,0 +1,2 @@\n+*.jar\n+*/*.jar\n\\ No newline at end of file\n""}","merge 
"
8697,Arve HjÃ¸nnevÃ¥g,lowmemorykiller: Don't count free space unless it meets the specified limit by itself,['drivers/misc/lowmemorykiller.c'],"lowmemorykiller: Don't count free space unless it meets the specified limit by itself

This allows processes to be killed when the kernel evict cache pages in
an attempt to get more contiguous free memory.

Signed-off-by: Arve HjÃ¸nnevÃ¥g <arve@android.com>
",https://android-review.googlesource.com/c/8697,"bug
",bug,Others;,"{""lowmemorykiller.c"": ""@@ -58,19 +58,21 @@ static int lowmem_shrink(int nr_to_scan, gfp_t gfp_mask)\n \tint min_adj = OOM_ADJUST_MAX + 1;\n \tint selected_tasksize = 0;\n \tint array_size = ARRAY_SIZE(lowmem_adj);\n-\tint other_free = global_page_state(NR_FREE_PAGES) + global_page_state(NR_FILE_PAGES);\n+\tint other_free = global_page_state(NR_FREE_PAGES);\n+\tint other_file = global_page_state(NR_FILE_PAGES);\n \tif(lowmem_adj_size < array_size)\n \t\tarray_size = lowmem_adj_size;\n \tif(lowmem_minfree_size < array_size)\n \t\tarray_size = lowmem_minfree_size;\n \tfor(i = 0; i < array_size; i++) {\n-\t\tif(other_free < lowmem_minfree[i]) {\n+\t\tif (other_free < lowmem_minfree[i] &&\n+\t\t    other_file < lowmem_minfree[i]) {\n \t\t\tmin_adj = lowmem_adj[i];\n \t\t\tbreak;\n \t\t}\n \t}\n \tif(nr_to_scan > 0)\n-\t\tlowmem_print(3, \""lowmem_shrink %d, %x, ofree %d, ma %d\\n\"", nr_to_scan, gfp_mask, other_free, min_adj);\n+\t\tlowmem_print(3, \""lowmem_shrink %d, %x, ofree %d %d, ma %d\\n\"", nr_to_scan, gfp_mask, other_free, other_file, min_adj);\n \trem = global_page_state(NR_ACTIVE) + global_page_state(NR_INACTIVE);\n \tif (nr_to_scan <= 0 || min_adj == OOM_ADJUST_MAX + 1) {\n \t\tlowmem_print(5, \""lowmem_shrink %d, %x, return %d\\n\"", nr_to_scan, gfp_mask, rem);\n""}","bug, refactor 
"
17542,Ot ten Thije,Control state snapshots from Android console.,"['monitor.h', 'outputchannel.c', 'sysemu.h', 'android/console.c', 'outputchannel.h', 'monitor.c', 'savevm.c', 'Makefile.android']","Control state snapshots from Android console.

This patch exposes Qemu's save, load, delete and list commands for
state snapshots on the Android console. A level of indirection is
added by means of the OutputChannel construct. This allows us to show
the output of the Qemu commands on the console rather than on the
monitor, while minimizing the differences with the upstream codebase.

The new commands are exposed only when the configuration constant
CONFIG_ANDROID_SNAPSHOTS is not 0.

Change-Id: I558d5cd505d321fe2da5835713d341d151f60534",https://android-review.googlesource.com/c/17542,"feature 
",feature,Deprecat;Resource;,"{""Makefile.android"": ""@@ -639,6 +639,7 @@ CORE_MISC_SOURCES = vl-android.c \\\n                     monitor.c \\\n                     readline.c \\\n                     qemu-char-android.c \\\n+                    outputchannel.c \\\n                     qemu-error.c \\\n                     qerror.c \\\n                     disas.c \\\n"", ""console.c"": ""@@ -36,6 +36,7 @@\n #include \""android/utils/bufprint.h\""\n #include \""android/utils/debug.h\""\n #include \""android/utils/stralloc.h\""\n+#include \""android/config/config.h\""\n #include \""tcpdump.h\""\n #include \""net.h\""\n #include \""monitor.h\""\n@@ -251,18 +252,25 @@ static void  control_control_write( ControlClient  client, const char*  buff, in\n     }\n }\n \n-static void  control_write( ControlClient  client, const char*  format, ... )\n+static int  control_vwrite( ControlClient  client, const char*  format, va_list args )\n {\n     static char  temp[1024];\n-    va_list      args;\n+    int ret = vsnprintf( temp, sizeof(temp), format, args );\n+    temp[ sizeof(temp)-1 ] = 0;\n+    control_control_write( client, temp, -1 );\n+\n+    return ret;\n+}\n \n+static int  control_write( ControlClient  client, const char*  format, ... )\n+{\n+    int ret;\n+    va_list      args;\n     va_start(args, format);\n-    vsnprintf( temp, sizeof(temp), format, args );\n+    ret = control_vwrite(client, format, args);\n     va_end(args);\n \n-    temp[ sizeof(temp)-1 ] = 0;\n-\n-    control_control_write( client, temp, -1 );\n+    return ret;\n }\n \n \n@@ -1905,6 +1913,108 @@ static const CommandDefRec  vm_commands[] =\n     { NULL, NULL, NULL, NULL, NULL, NULL }\n };\n \n+#if CONFIG_ANDROID_SNAPSHOTS\n+\n+/********************************************************************************************/\n+/********************************************************************************************/\n+/*****                                                                                 ******/\n+/*****                         S T A T E   C O M M A N D S                             ******/\n+/*****                                                                                 ******/\n+/********************************************************************************************/\n+/********************************************************************************************/\n+\n+static int\n+control_write_out_cb(void* opaque, const char* fmt, va_list ap)\n+{\n+    ControlClient client = opaque;\n+    int ret = control_vwrite(client, fmt, ap);\n+    return ret;\n+}\n+\n+static int\n+control_write_err_cb(void* opaque, const char* fmt, va_list ap)\n+{\n+    int ret = 0;\n+    ControlClient client = opaque;\n+    ret += control_write(client, \""KO: \"");\n+    ret += control_vwrite(client, fmt, ap);\n+    return ret;\n+}\n+\n+static int\n+do_state_list( ControlClient  client, char*  args )\n+{\n+    int ret;\n+    OutputChannel *out = output_channel_alloc(client, control_write_out_cb);\n+    OutputChannel *err = output_channel_alloc(client, control_write_err_cb);\n+    do_info_snapshots_oc(out, err);\n+    ret = output_channel_written(err);\n+    output_channel_free(out);\n+    output_channel_free(err);\n+\n+    return ret > 0;\n+}\n+\n+static int\n+do_state_save( ControlClient  client, char*  args )\n+{\n+    int ret;\n+    OutputChannel *err = output_channel_alloc(client, control_write_err_cb);\n+    do_savevm_oc(err, args);\n+    ret = output_channel_written(err);\n+    output_channel_free(err);\n+\n+    return ret > 0; // no output on error channel indicates success\n+}\n+\n+static int\n+do_state_load( ControlClient  client, char*  args )\n+{\n+    int ret;\n+    OutputChannel *err = output_channel_alloc(client, control_write_err_cb);\n+    do_loadvm_oc(err, args);\n+    ret = output_channel_written(err);\n+    output_channel_free(err);\n+\n+    return ret > 0;\n+}\n+\n+static int\n+do_state_del( ControlClient  client, char*  args )\n+{\n+    int ret;\n+    OutputChannel *err = output_channel_alloc(client, control_write_err_cb);\n+    do_delvm_oc(err, args);\n+    ret = output_channel_written(err);\n+    output_channel_free(err);\n+\n+    return ret > 0;\n+}\n+\n+static const CommandDefRec  state_commands[] =\n+{\n+    { \""list\"", \""list available state snapshots\"",\n+    \""'state list' will show a list of all state snapshots that can be loaded\\r\\n\"",\n+    NULL, do_state_list, NULL },\n+\n+    { \""save\"", \""save state snapshot\"",\n+    \""'state save <name>' will save the current (run-time) state to a snapshot with the given name\\r\\n\"",\n+    NULL, do_state_save, NULL },\n+\n+    { \""load\"", \""load state snapshot\"",\n+    \""'state load <name>' will load the state snapshot of the given name\\r\\n\"",\n+    NULL, do_state_load, NULL },\n+\n+    { \""del\"", \""delete state snapshot\"",\n+    \""'state del <name>' will delete the state snapshot with the given name\\r\\n\"",\n+    NULL, do_state_del, NULL },\n+\n+    { NULL, NULL, NULL, NULL, NULL, NULL }\n+};\n+\n+\n+#endif\n+\n /********************************************************************************************/\n /********************************************************************************************/\n /*****                                                                                 ******/\n@@ -2219,8 +2329,8 @@ static const CommandDefRec   main_commands[] =\n       \""allows you to simulate an inbound SMS\\r\\n\"", NULL,\n       NULL, sms_commands },\n \n-    { \""avd\"", \""manager virtual device state\"",\n-    \""allows to change (e.g. start/stop) the virtual device state\\r\\n\"", NULL,\n+    { \""avd\"", \""control virtual device execution\"",\n+    \""allows you to control (e.g. start/stop) the execution of the virtual device\\r\\n\"", NULL,\n     NULL, vm_commands },\n \n     { \""window\"", \""manage emulator window\"",\n@@ -2231,6 +2341,12 @@ static const CommandDefRec   main_commands[] =\n     \""allows to connect to the QEMU virtual machine monitor\\r\\n\"", NULL,\n     NULL, qemu_commands },\n \n+#if CONFIG_ANDROID_SNAPSHOTS\n+    { \""state\"", \""state snapshot commands\"",\n+    \""allows you to save and restore the virtual device state in snapshots\\r\\n\"", NULL,\n+    NULL, state_commands },\n+#endif\n+\n     { NULL, NULL, NULL, NULL, NULL, NULL }\n };\n \n"", ""monitor.c"": ""@@ -165,11 +165,13 @@ static void monitor_puts(Monitor *mon, const char *str)\n     }\n }\n \n-void monitor_vprintf(Monitor *mon, const char *fmt, va_list ap)\n+int monitor_vprintf(Monitor *mon, const char *fmt, va_list ap)\n {\n     char buf[4096];\n-    vsnprintf(buf, sizeof(buf), fmt, ap);\n+    int ret = vsnprintf(buf, sizeof(buf), fmt, ap);\n     monitor_puts(mon, buf);\n+\n+    return ret;\n }\n \n void monitor_printf(Monitor *mon, const char *fmt, ...)\n"", ""monitor.h"": ""@@ -53,7 +53,7 @@ int monitor_read_bdrv_key_start(Monitor *mon, BlockDriverState *bs,\n \n int monitor_get_fd(Monitor *mon, const char *fdname);\n \n-void monitor_vprintf(Monitor *mon, const char *fmt, va_list ap);\n+int monitor_vprintf(Monitor *mon, const char *fmt, va_list ap);\n void monitor_printf(Monitor *mon, const char *fmt, ...)\n     __attribute__ ((__format__ (__printf__, 2, 3)));\n void monitor_print_filename(Monitor *mon, const char *filename);\n"", ""outputchannel.c"": ""@@ -0,0 +1,56 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+\n+#include \""outputchannel.h\""\n+#include \""qemu-common.h\""\n+\n+struct OutputChannel {\n+    void*               opaque;   /* caller-specific information */\n+    OutputChannelPrintf printf;   /* callback function to do the printing */\n+    unsigned int        written;  /* number of bytes written to the channel */\n+};\n+\n+OutputChannel* output_channel_alloc(void* opaque, OutputChannelPrintf cb)\n+{\n+    OutputChannel* oc = qemu_mallocz(sizeof(oc));\n+    oc->printf  = cb;\n+    oc->opaque  = opaque;\n+    oc->written = 0;\n+\n+    return oc;\n+}\n+\n+void output_channel_printf(OutputChannel* oc, const char* fmt, ...)\n+{\n+    int ret;\n+    va_list ap;\n+    va_start(ap, fmt);\n+    ret = oc->printf(oc->opaque, fmt, ap);\n+    va_end(ap);\n+\n+    oc->written += ret;\n+}\n+\n+void output_channel_free(OutputChannel* oc)\n+{\n+    free(oc);\n+}\n+\n+unsigned int output_channel_written(OutputChannel* oc)\n+{\n+    return oc->written;\n+}\n"", ""outputchannel.h"": ""@@ -0,0 +1,38 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+#ifndef _OUTPUTCHANNEL_H\n+#define _OUTPUTCHANNEL_H\n+\n+#include <stdarg.h>\n+\n+/* Callback function to print a printf-formatted string to a channel */\n+typedef int (*OutputChannelPrintf) (void* opaque, const char* fmt, va_list ap);\n+\n+typedef struct OutputChannel OutputChannel;\n+\n+/* Allocates a new output channel */\n+OutputChannel* output_channel_alloc(void* opaque, OutputChannelPrintf cb);\n+\n+/* Prints a printf-formatted string to the output channel */\n+void output_channel_printf(OutputChannel* oc, const char* fmt, ...);\n+\n+/* Frees an output channel */\n+void output_channel_free(OutputChannel* oc);\n+\n+/* Returns the number of bytes written to the channel */\n+unsigned int output_channel_written(OutputChannel* oc);\n+\n+#endif /* _OUTPUTCHANNEL_H */\n"", ""savevm.c"": ""@@ -86,6 +86,7 @@\n #include \""sysemu.h\""\n #include \""qemu-timer.h\""\n #include \""qemu-char.h\""\n+#include \""outputchannel.h\""\n #include \""block.h\""\n #include \""audio/audio.h\""\n #include \""migration.h\""\n@@ -1162,7 +1163,21 @@ static int bdrv_snapshot_find(BlockDriverState *bs, QEMUSnapshotInfo *sn_info,\n     return ret;\n }\n \n+static int\n+monitor_output_channel_cb(void* opaque, const char* fmt, va_list ap)\n+{\n+    return monitor_vprintf((Monitor*) opaque, fmt, ap);\n+}\n+\n+\n void do_savevm(Monitor *mon, const char *name)\n+{\n+    OutputChannel *oc = output_channel_alloc(mon, monitor_output_channel_cb);\n+    do_savevm_oc(oc, name);\n+    output_channel_free(oc);\n+}\n+\n+void do_savevm_oc(OutputChannel *err, const char *name)\n {\n     BlockDriverState *bs, *bs1;\n     QEMUSnapshotInfo sn1, *sn = &sn1, old_sn1, *old_sn = &old_sn1;\n@@ -1179,7 +1194,7 @@ void do_savevm(Monitor *mon, const char *name)\n \n     bs = get_bs_snapshots();\n     if (!bs) {\n-        monitor_printf(mon, \""No block device can accept snapshots\\n\"");\n+        output_channel_printf(err, \""No block device can accept snapshots\\n\"");\n         return;\n     }\n \n@@ -1218,22 +1233,22 @@ void do_savevm(Monitor *mon, const char *name)\n     sn->vm_clock_nsec = qemu_get_clock(vm_clock);\n \n     if (bdrv_get_info(bs, bdi) < 0 || bdi->vm_state_offset <= 0) {\n-        monitor_printf(mon, \""Device %s does not support VM state snapshots\\n\"",\n-                       bdrv_get_device_name(bs));\n+        output_channel_printf(err, \""Device %s does not support VM state snapshots\\n\"",\n+                              bdrv_get_device_name(bs));\n         goto the_end;\n     }\n \n     /* save the VM state */\n     f = qemu_fopen_bdrv(bs, bdi->vm_state_offset, 1);\n     if (!f) {\n-        monitor_printf(mon, \""Could not open VM state file\\n\"");\n+        output_channel_printf(err, \""Could not open VM state file\\n\"");\n         goto the_end;\n     }\n     ret = qemu_savevm_state(f);\n     vm_state_size = qemu_ftell(f);\n     qemu_fclose(f);\n     if (ret < 0) {\n-        monitor_printf(mon, \""Error %d while writing VM\\n\"", ret);\n+        output_channel_printf(err, \""Error %d while writing VM\\n\"", ret);\n         goto the_end;\n     }\n \n@@ -1245,17 +1260,17 @@ void do_savevm(Monitor *mon, const char *name)\n             if (must_delete) {\n                 ret = bdrv_snapshot_delete(bs1, old_sn->id_str);\n                 if (ret < 0) {\n-                    monitor_printf(mon,\n-                                   \""Error while deleting snapshot on '%s'\\n\"",\n-                                   bdrv_get_device_name(bs1));\n+                    output_channel_printf(err,\n+                                          \""Error while deleting snapshot on '%s'\\n\"",\n+                                          bdrv_get_device_name(bs1));\n                 }\n             }\n             /* Write VM state size only to the image that contains the state */\n             sn->vm_state_size = (bs == bs1 ? vm_state_size : 0);\n             ret = bdrv_snapshot_create(bs1, sn);\n             if (ret < 0) {\n-                monitor_printf(mon, \""Error while creating snapshot on '%s'\\n\"",\n-                               bdrv_get_device_name(bs1));\n+                output_channel_printf(err, \""Error while creating snapshot on '%s'\\n\"",\n+                                      bdrv_get_device_name(bs1));\n             }\n         }\n     }\n@@ -1266,6 +1281,13 @@ void do_savevm(Monitor *mon, const char *name)\n }\n \n void do_loadvm(Monitor *mon, const char *name)\n+{\n+    OutputChannel *oc = output_channel_alloc(mon, monitor_output_channel_cb);\n+    do_loadvm_oc(oc, name);\n+    output_channel_free(oc);\n+}\n+\n+void do_loadvm_oc(OutputChannel *err, const char *name)\n {\n     BlockDriverState *bs, *bs1;\n     BlockDriverInfo bdi1, *bdi = &bdi1;\n@@ -1276,7 +1298,7 @@ void do_loadvm(Monitor *mon, const char *name)\n \n     bs = get_bs_snapshots();\n     if (!bs) {\n-        monitor_printf(mon, \""No block device supports snapshots\\n\"");\n+        output_channel_printf(err, \""No block device supports snapshots\\n\"");\n         return;\n     }\n \n@@ -1292,20 +1314,20 @@ void do_loadvm(Monitor *mon, const char *name)\n             ret = bdrv_snapshot_goto(bs1, name);\n             if (ret < 0) {\n                 if (bs != bs1)\n-                    monitor_printf(mon, \""Warning: \"");\n+                    output_channel_printf(err, \""Warning: \"");\n                 switch(ret) {\n                 case -ENOTSUP:\n-                    monitor_printf(mon,\n+                    output_channel_printf(err,\n                                    \""Snapshots not supported on device '%s'\\n\"",\n                                    bdrv_get_device_name(bs1));\n                     break;\n                 case -ENOENT:\n-                    monitor_printf(mon, \""Could not find snapshot '%s' on \""\n+                    output_channel_printf(err, \""Could not find snapshot '%s' on \""\n                                    \""device '%s'\\n\"",\n                                    name, bdrv_get_device_name(bs1));\n                     break;\n                 default:\n-                    monitor_printf(mon, \""Error %d while activating snapshot on\""\n+                    output_channel_printf(err, \""Error %d while activating snapshot on\""\n                                    \"" '%s'\\n\"", ret, bdrv_get_device_name(bs1));\n                     break;\n                 }\n@@ -1317,7 +1339,7 @@ void do_loadvm(Monitor *mon, const char *name)\n     }\n \n     if (bdrv_get_info(bs, bdi) < 0 || bdi->vm_state_offset <= 0) {\n-        monitor_printf(mon, \""Device %s does not support VM state snapshots\\n\"",\n+        output_channel_printf(err, \""Device %s does not support VM state snapshots\\n\"",\n                        bdrv_get_device_name(bs));\n         return;\n     }\n@@ -1330,13 +1352,13 @@ void do_loadvm(Monitor *mon, const char *name)\n     /* restore the VM state */\n     f = qemu_fopen_bdrv(bs, bdi->vm_state_offset, 0);\n     if (!f) {\n-        monitor_printf(mon, \""Could not open VM state file\\n\"");\n+        output_channel_printf(err, \""Could not open VM state file\\n\"");\n         goto the_end;\n     }\n     ret = qemu_loadvm_state(f);\n     qemu_fclose(f);\n     if (ret < 0) {\n-        monitor_printf(mon, \""Error %d while loading VM state\\n\"", ret);\n+        output_channel_printf(err, \""Error %d while loading VM state\\n\"", ret);\n     }\n  the_end:\n     if (saved_vm_running)\n@@ -1344,13 +1366,19 @@ void do_loadvm(Monitor *mon, const char *name)\n }\n \n void do_delvm(Monitor *mon, const char *name)\n+{\n+    OutputChannel *oc = output_channel_alloc(mon, monitor_output_channel_cb);\n+    do_delvm_oc(oc, name);\n+    output_channel_free(oc);\n+}\n+void do_delvm_oc(OutputChannel *err, const char *name)\n {\n     BlockDriverState *bs, *bs1;\n     int i, ret;\n \n     bs = get_bs_snapshots();\n     if (!bs) {\n-        monitor_printf(mon, \""No block device supports snapshots\\n\"");\n+        output_channel_printf(err, \""No block device supports snapshots\\n\"");\n         return;\n     }\n \n@@ -1360,18 +1388,25 @@ void do_delvm(Monitor *mon, const char *name)\n             ret = bdrv_snapshot_delete(bs1, name);\n             if (ret < 0) {\n                 if (ret == -ENOTSUP)\n-                    monitor_printf(mon,\n-                                   \""Snapshots not supported on device '%s'\\n\"",\n-                                   bdrv_get_device_name(bs1));\n+                    output_channel_printf(err,\n+                                          \""Snapshots not supported on device '%s'\\n\"",\n+                                          bdrv_get_device_name(bs1));\n                 else\n-                    monitor_printf(mon, \""Error %d while deleting snapshot on \""\n-                                   \""'%s'\\n\"", ret, bdrv_get_device_name(bs1));\n+                    output_channel_printf(err, \""Error %d while deleting snapshot on \""\n+                                          \""'%s'\\n\"", ret, bdrv_get_device_name(bs1));\n             }\n         }\n     }\n }\n \n void do_info_snapshots(Monitor *mon)\n+{\n+    OutputChannel *oc = output_channel_alloc(mon, monitor_output_channel_cb);\n+    do_info_snapshots_oc(oc, oc);\n+    output_channel_free(oc);\n+}\n+\n+void do_info_snapshots_oc(OutputChannel *out, OutputChannel *err)\n {\n     BlockDriverState *bs, *bs1;\n     QEMUSnapshotInfo *sn_tab, *sn;\n@@ -1380,30 +1415,30 @@ void do_info_snapshots(Monitor *mon)\n \n     bs = get_bs_snapshots();\n     if (!bs) {\n-        monitor_printf(mon, \""No available block device supports snapshots\\n\"");\n+        output_channel_printf(err, \""No available block device supports snapshots\\n\"");\n         return;\n     }\n-    monitor_printf(mon, \""Snapshot devices:\"");\n+    output_channel_printf(out, \""Snapshot devices:\"");\n     for(i = 0; i <= nb_drives; i++) {\n         bs1 = drives_table[i].bdrv;\n         if (bdrv_has_snapshot(bs1)) {\n             if (bs == bs1)\n-                monitor_printf(mon, \"" %s\"", bdrv_get_device_name(bs1));\n+                output_channel_printf(out, \"" %s\"", bdrv_get_device_name(bs1));\n         }\n     }\n-    monitor_printf(mon, \""\\n\"");\n+    output_channel_printf(out, \""\\n\"");\n \n     nb_sns = bdrv_snapshot_list(bs, &sn_tab);\n     if (nb_sns < 0) {\n-        monitor_printf(mon, \""bdrv_snapshot_list: error %d\\n\"", nb_sns);\n+        output_channel_printf(err, \""bdrv_snapshot_list: error %d\\n\"", nb_sns);\n         return;\n     }\n-    monitor_printf(mon, \""Snapshot list (from %s):\\n\"",\n+    output_channel_printf(out, \""Snapshot list (from %s):\\n\"",\n                    bdrv_get_device_name(bs));\n-    monitor_printf(mon, \""%s\\n\"", bdrv_snapshot_dump(buf, sizeof(buf), NULL));\n+    output_channel_printf(out, \""%s\\n\"", bdrv_snapshot_dump(buf, sizeof(buf), NULL));\n     for(i = 0; i < nb_sns; i++) {\n         sn = &sn_tab[i];\n-        monitor_printf(mon, \""%s\\n\"", bdrv_snapshot_dump(buf, sizeof(buf), sn));\n+        output_channel_printf(out, \""%s\\n\"", bdrv_snapshot_dump(buf, sizeof(buf), sn));\n     }\n     qemu_free(sn_tab);\n }\n"", ""sysemu.h"": ""@@ -8,6 +8,7 @@\n #include \""qemu-timer.h\""\n #include \""qdict.h\""\n #include \""qerror.h\""\n+#include \""outputchannel.h\""\n \n #ifdef _WIN32\n #include <windows.h>\n@@ -61,9 +62,13 @@ void qemu_system_powerdown(void);\n void qemu_system_reset(void);\n \n void do_savevm(Monitor *mon, const char *name);\n+void do_savevm_oc(OutputChannel *err, const char *name);\n void do_loadvm(Monitor *mon, const char *name);\n+void do_loadvm_oc(OutputChannel *err, const char *name);\n void do_delvm(Monitor *mon, const char *name);\n+void do_delvm_oc(OutputChannel *err, const char *name);\n void do_info_snapshots(Monitor *mon);\n+void do_info_snapshots_oc(OutputChannel *out, OutputChannel *err);\n \n void qemu_announce_self(void);\n \n""}","feature 
"
21685,Tor Norbye,Add drop-support for include tags,"['eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/SlidingDrawerRule.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/refactoring/WrapInWizard.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/TabHostRule.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/PaletteControl.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/WebViewRule.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/api/IClientRulesEngine.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/api/INode.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/ImageButtonRule.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/IncludeFinder.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/ImageViewRule.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/RadioGroupRule.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gre/RulesEngine.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/ZoomButtonRule.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/ScrollViewRule.java', 'eclipse/plugins/com.android.ide.eclipse.tests/unittests/com/android/ide/common/layout/LayoutTestBase.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/api/InsertType.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/BaseViewRule.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gre/NodeProxy.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/DialerFilterRule.java', 'eclipse/plugins/com.android.ide.eclipse.tests/unittests/com/android/ide/eclipse/adt/internal/editors/layout/gre/ViewMetadataRepositoryTest.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/IncludeRule.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/HorizontalScrollViewRule.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gre/extra-view-metadata.xml', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/ui/ResourceChooser.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/PropertySettingNodeHandler.java', 'eclipse/plugins/com.android.ide.eclipse.tests/unittests/com/android/ide/common/layout/TestNode.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/refactoring/ChangeLayoutWizard.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/MapViewRule.java']","Add drop-support for include tags

Add the include tag back into the palette, and add special drop
support for it such that when it is drop, a resource chooser pops up
and asks you which layout to include. A new validator prevents any
layouts from being chosen that would result in a cyclic
dependency.

This requires some infrastructure changes: First, drop handlers must
distinguish between a view getting created as part of a previewing
operation and getting created interactively. Second, in order to
support cancel removing an inserted include if the user decides not to
set an include, the node wrappers need to support removing an element.
Also, use the metadata originally intended for the preview icon
factory to also bypass palette drag previews for widgets that don't
have UI.

Change-Id: I1bdd1766ca4cfa2fdbca25b77c50c74e9c332cbd",https://android-review.googlesource.com/c/21685,"**feature** 
",feature,Feature;,"{""IClientRulesEngine.java"": ""@@ -133,5 +133,15 @@ public interface IClientRulesEngine {\n      *         right, top and bottom margins respectively\n      */\n     String[] displayMarginInput(String all, String left, String right, String top, String bottom);\n+\n+    /**\n+     * Displays an input dialog tailored for inputing the source of an {@code <include>}\n+     * layout tag. This is similar to {@link #displayResourceInput} for resource type\n+     * \""layout\"", but should also attempt to filter out layout resources that cannot be\n+     * included from the current context (because it would result in a cyclic dependency).\n+     *\n+     * @return the layout resource to include\n+     */\n+    String displayIncludeSourceInput();\n }\n \n"", ""INode.java"": ""@@ -127,6 +127,15 @@ public interface INode {\n      */\n     INode insertChildAt(String viewFqcn, int index);\n \n+    /**\n+     * Removes the given XML element child from this node's list of children.\n+     * <p/>\n+     * This call must be done in the context of editXml().\n+     *\n+     * @param node The child to be deleted.\n+     */\n+    void removeChild(INode node);\n+\n     /**\n      * Sets an attribute for the underlying XML element.\n      * Attributes are not written immediately -- instead the XML editor batches edits and\n"", ""InsertType.java"": ""@@ -24,6 +24,12 @@ public enum InsertType {\n     /** The view is newly created (by for example a palette drag) */\n     CREATE,\n \n+    /**\n+     * Same as {@link #CREATE} but when the views are constructed for previewing, for\n+     * example as part of a palette drag.\n+     */\n+    CREATE_PREVIEW,\n+\n     /** The view is being inserted here because it was moved from somewhere else */\n     MOVE,\n \n@@ -32,4 +38,15 @@ public enum InsertType {\n      * (including drags, but not from the palette)\n      */\n     PASTE;\n+\n+    /**\n+     * Returns true if this insert type is for a newly created view (for example a by\n+     * palette drag). Note that this includes both normal create events as well as well as\n+     * views created as part of previewing operations.\n+     *\n+     * @return true if this {@link InsertType} is for a newly created view\n+     */\n+    public boolean isCreate() {\n+        return this == CREATE || this == CREATE_PREVIEW;\n+    }\n }\n"", ""BaseViewRule.java"": ""@@ -674,21 +674,4 @@ public class BaseViewRule implements IViewRule {\n         }\n         return value;\n     }\n-\n-    private static class PropertySettingNodeHandler implements INodeHandler {\n-        private final String mNamespaceUri;\n-        private final String mAttribute;\n-        private final String mValue;\n-\n-        public PropertySettingNodeHandler(String namespaceUri, String attribute, String value) {\n-            super();\n-            mNamespaceUri = namespaceUri;\n-            mAttribute = attribute;\n-            mValue = value;\n-        }\n-\n-        public void handle(INode node) {\n-            node.setAttribute(mNamespaceUri, mAttribute, mValue);\n-        }\n-    }\n }\n"", ""DialerFilterRule.java"": ""@@ -37,7 +37,7 @@ public class DialerFilterRule extends BaseViewRule {\n         super.onCreate(node, parent, insertType);\n \n         // A DialerFilter requires a couple of nested EditTexts with fixed ids:\n-        if (insertType == InsertType.CREATE) {\n+        if (insertType.isCreate()) {\n             String fillParent = getFillParentValueName();\n             INode hint = node.appendChild(FQCN_EDIT_TEXT);\n             hint.setAttribute(ANDROID_URI, ATTR_TEXT, \""Hint\"");\n"", ""HorizontalScrollViewRule.java"": ""@@ -46,7 +46,7 @@ public class HorizontalScrollViewRule extends FrameLayoutRule {\n     public void onCreate(INode node, INode parent, InsertType insertType) {\n         super.onCreate(node, parent, insertType);\n \n-        if (insertType == InsertType.CREATE) {\n+        if (insertType.isCreate()) {\n             // Insert a horizontal linear layout which is commonly used with horizontal scrollbars\n             // as described by the documentation for HorizontalScrollbars.\n             INode linearLayout = node.appendChild(FQCN_LINEAR_LAYOUT);\n"", ""ImageButtonRule.java"": ""@@ -32,7 +32,7 @@ public class ImageButtonRule extends BaseViewRule {\n     public void onCreate(INode node, INode parent, InsertType insertType) {\n         super.onCreate(node, parent, insertType);\n \n-        if (insertType == InsertType.CREATE) {\n+        if (insertType.isCreate()) {\n             node.setAttribute(ANDROID_URI, ATTR_SRC, getSampleImageSrc());\n         }\n     }\n"", ""ImageViewRule.java"": ""@@ -32,7 +32,7 @@ public class ImageViewRule extends BaseViewRule {\n     public void onCreate(INode node, INode parent, InsertType insertType) {\n         super.onCreate(node, parent, insertType);\n \n-        if (insertType == InsertType.CREATE) {\n+        if (insertType.isCreate()) {\n             node.setAttribute(ANDROID_URI, ATTR_SRC, getSampleImageSrc());\n         }\n     }\n"", ""IncludeRule.java"": ""@@ -0,0 +1,43 @@\n+/*\n+ * Copyright (C) 2011 The Android Open Source Project\n+ *\n+ * Licensed under the Eclipse Public License, Version 1.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.eclipse.org/org/documents/epl-v10.php\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.android.ide.common.layout;\n+\n+import static com.android.ide.eclipse.adt.internal.editors.layout.descriptors.LayoutDescriptors.ATTR_LAYOUT;\n+\n+import com.android.ide.common.api.INode;\n+import com.android.ide.common.api.IViewRule;\n+import com.android.ide.common.api.InsertType;\n+\n+/**\n+ * An {@link IViewRule} for the special XML {@code <include>} tag.\n+ */\n+public class IncludeRule extends BaseViewRule {\n+    @Override\n+    public void onCreate(INode node, INode parent, InsertType insertType) {\n+        // When dropping an include tag, ask the user which layout to include.\n+        if (insertType == InsertType.CREATE) { // NOT InsertType.CREATE_PREVIEW\n+            String include = mRulesEngine.displayIncludeSourceInput();\n+            if (include != null) {\n+                node.editXml(\""Include Layout\"",\n+                    // Note -- the layout attribute is NOT in the Android namespace!\n+                    new PropertySettingNodeHandler(null, ATTR_LAYOUT, include));\n+            } else {\n+                // Remove the view; the insertion was canceled\n+                parent.removeChild(node);\n+            }\n+        }\n+    }\n+}\n"", ""MapViewRule.java"": ""@@ -34,7 +34,7 @@ public class MapViewRule extends BaseViewRule {\n     public void onCreate(INode node, INode parent, InsertType insertType) {\n         super.onCreate(node, parent, insertType);\n \n-        if (insertType == InsertType.CREATE) {\n+        if (insertType.isCreate()) {\n             node.setAttribute(ANDROID_URI, \""android:apiKey\"",  //$NON-NLS-1$\n                    \""Your API key: see \"" + //$NON-NLS-1$\n                    \""http://code.google.com/android/add-ons/google-apis/mapkey.html\""); //$NON-NLS-1$\n"", ""PropertySettingNodeHandler.java"": ""@@ -0,0 +1,40 @@\n+/*\n+ * Copyright (C) 2011 The Android Open Source Project\n+ *\n+ * Licensed under the Eclipse Public License, Version 1.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.eclipse.org/org/documents/epl-v10.php\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.android.ide.common.layout;\n+\n+import com.android.ide.common.api.INode;\n+import com.android.ide.common.api.INodeHandler;\n+\n+/**\n+ * A convenience implementation of {@link INodeHandler} for setting a given attribute to a\n+ * given value on a particular node.\n+ */\n+class PropertySettingNodeHandler implements INodeHandler {\n+    private final String mNamespaceUri;\n+    private final String mAttribute;\n+    private final String mValue;\n+\n+    PropertySettingNodeHandler(String namespaceUri, String attribute, String value) {\n+        super();\n+        mNamespaceUri = namespaceUri;\n+        mAttribute = attribute;\n+        mValue = value;\n+    }\n+\n+    public void handle(INode node) {\n+        node.setAttribute(mNamespaceUri, mAttribute, mValue);\n+    }\n+}\n\\ No newline at end of file\n"", ""RadioGroupRule.java"": ""@@ -33,7 +33,7 @@ public class RadioGroupRule extends LinearLayoutRule {\n     public void onCreate(INode node, INode parent, InsertType insertType) {\n         super.onCreate(node, parent, insertType);\n \n-        if (insertType == InsertType.CREATE) {\n+        if (insertType.isCreate()) {\n             for (int i = 0; i < 3; i++) {\n                 INode handle = node.appendChild(LayoutConstants.FQCN_RADIO_BUTTON);\n                 handle.setAttribute(ANDROID_URI, ATTR_ID, String.format(\""@+id/radio%d\"", i));\n"", ""ScrollViewRule.java"": ""@@ -44,7 +44,7 @@ public class ScrollViewRule extends FrameLayoutRule {\n     public void onCreate(INode node, INode parent, InsertType insertType) {\n         super.onCreate(node, parent, insertType);\n \n-        if (insertType == InsertType.CREATE) {\n+        if (insertType.isCreate()) {\n             // Insert a default linear layout (which will in turn be registered as\n             // a child of this node and the create child method above will set its\n             // fill parent attributes, its id, etc.\n"", ""SlidingDrawerRule.java"": ""@@ -37,7 +37,7 @@ public class SlidingDrawerRule extends BaseLayoutRule {\n     public void onCreate(INode node, INode parent, InsertType insertType) {\n         super.onCreate(node, parent, insertType);\n \n-        if (insertType == InsertType.CREATE) {\n+        if (insertType.isCreate()) {\n             String matchParent = getFillParentValueName();\n             node.setAttribute(ANDROID_URI, ATTR_LAYOUT_WIDTH, matchParent);\n             node.setAttribute(ANDROID_URI, ATTR_LAYOUT_HEIGHT, matchParent);\n"", ""TabHostRule.java"": ""@@ -43,7 +43,7 @@ public class TabHostRule extends IgnoredLayoutRule {\n     public void onCreate(INode node, INode parent, InsertType insertType) {\n         super.onCreate(node, parent, insertType);\n \n-        if (insertType == InsertType.CREATE) {\n+        if (insertType.isCreate()) {\n             String fillParent = getFillParentValueName();\n \n             // Configure default Table setup as described in the Table tutorial\n"", ""WebViewRule.java"": ""@@ -35,7 +35,7 @@ public class WebViewRule extends IgnoredLayoutRule {\n     public void onCreate(INode node, INode parent, InsertType insertType) {\n         super.onCreate(node, parent, insertType);\n \n-        if (insertType == InsertType.CREATE) {\n+        if (insertType.isCreate()) {\n             String matchParent = getFillParentValueName();\n             node.setAttribute(ANDROID_URI, ATTR_LAYOUT_WIDTH, matchParent);\n             node.setAttribute(ANDROID_URI, ATTR_LAYOUT_HEIGHT, matchParent);\n"", ""ZoomButtonRule.java"": ""@@ -26,7 +26,7 @@ public class ZoomButtonRule extends BaseViewRule {\n     public void onCreate(INode node, INode parent, InsertType insertType) {\n         super.onCreate(node, parent, insertType);\n \n-        if (insertType == InsertType.CREATE) {\n+        if (insertType.isCreate()) {\n             node.setAttribute(ANDROID_URI, ATTR_SRC, \""@android:drawable/btn_plus\""); //$NON-NLS-1$\n         }\n     }\n"", ""IncludeFinder.java"": ""@@ -21,7 +21,6 @@ import static com.android.ide.eclipse.adt.AdtConstants.EXT_XML;\n import static com.android.ide.eclipse.adt.AdtConstants.WS_LAYOUTS;\n import static com.android.ide.eclipse.adt.AdtConstants.WS_SEP;\n import static com.android.resources.ResourceType.LAYOUT;\n-\n import static org.eclipse.core.resources.IResourceDelta.ADDED;\n import static org.eclipse.core.resources.IResourceDelta.CHANGED;\n import static org.eclipse.core.resources.IResourceDelta.CONTENT;\n@@ -67,6 +66,7 @@ import java.util.Collection;\n import java.util.Collections;\n import java.util.HashMap;\n import java.util.HashSet;\n+import java.util.LinkedList;\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n@@ -186,7 +186,6 @@ public class IncludeFinder {\n         }\n     }\n \n-    /** For test suite only -- do not call */\n     @VisibleForTesting\n     /* package */ List<String> getIncludedBy(String included) {\n         ensureInitialized();\n@@ -1001,5 +1000,71 @@ public class IncludeFinder {\n         public static Reference create(IFile file) {\n             return new Reference(file.getProject(), getMapKey(file));\n         }\n+\n+        /**\n+         * Returns the resource name of this layout, such as {@code @layout/foo}.\n+         *\n+         * @return the resource name\n+         */\n+        public String getResourceName() {\n+            return '@' + FD_RES_LAYOUT + '/' + getName();\n+        }\n+    }\n+\n+    /**\n+     * Returns a collection of layouts (expressed as resource names, such as\n+     * {@code @layout/foo} which would be invalid includes in the given layout\n+     * (because it would introduce a cycle)\n+     *\n+     * @param layout the layout file to check for cyclic dependencies from\n+     * @return a collection of layout resources which cannot be included from\n+     *         the given layout, never null\n+     */\n+    public Collection<String> getInvalidIncludes(IFile layout) {\n+        IProject project = layout.getProject();\n+        Reference self = Reference.create(layout);\n+\n+        // Add anyone who transitively can reach this file via includes.\n+        LinkedList<Reference> queue = new LinkedList<Reference>();\n+        List<Reference> invalid = new ArrayList<Reference>();\n+        queue.add(self);\n+        invalid.add(self);\n+        Set<String> seen = new HashSet<String>();\n+        seen.add(self.getId());\n+        while (!queue.isEmpty()) {\n+            Reference reference = queue.removeFirst();\n+            String refId = reference.getId();\n+\n+            // Look up both configuration specific includes as well as includes in the\n+            // base versions\n+            List<String> included = getIncludedBy(refId);\n+            if (refId.indexOf('/') != -1) {\n+                List<String> baseIncluded = getIncludedBy(reference.getName());\n+                if (included == null) {\n+                    included = baseIncluded;\n+                } else if (baseIncluded != null) {\n+                    included = new ArrayList<String>(included);\n+                    included.addAll(baseIncluded);\n+                }\n+            }\n+\n+            if (included != null && included.size() > 0) {\n+                for (String id : included) {\n+                    if (!seen.contains(id)) {\n+                        seen.add(id);\n+                        Reference ref = new Reference(project, id);\n+                        invalid.add(ref);\n+                        queue.addLast(ref);\n+                    }\n+                }\n+            }\n+        }\n+\n+        List<String> result = new ArrayList<String>();\n+        for (Reference reference : invalid) {\n+            result.add(reference.getResourceName());\n+        }\n+\n+        return result;\n     }\n }\n"", ""PaletteControl.java"": ""@@ -42,6 +42,7 @@ import com.android.ide.eclipse.adt.internal.editors.layout.gre.NodeFactory;\n import com.android.ide.eclipse.adt.internal.editors.layout.gre.NodeProxy;\n import com.android.ide.eclipse.adt.internal.editors.layout.gre.PaletteMetadataDescriptor;\n import com.android.ide.eclipse.adt.internal.editors.layout.gre.ViewMetadataRepository;\n+import com.android.ide.eclipse.adt.internal.editors.layout.gre.ViewMetadataRepository.RenderMode;\n import com.android.ide.eclipse.adt.internal.editors.layout.uimodel.UiViewElementNode;\n import com.android.ide.eclipse.adt.internal.editors.ui.DecorComposite;\n import com.android.ide.eclipse.adt.internal.editors.ui.IDecorContent;\n@@ -770,6 +771,12 @@ public class PaletteControl extends Composite {\n \n         /** Performs the actual rendering of the descriptor into an image */\n         private Image renderPreview() {\n+            ViewMetadataRepository repository = ViewMetadataRepository.get();\n+            RenderMode renderMode = repository.getRenderMode(mDesc.getFullClassName());\n+            if (renderMode == RenderMode.SKIP) {\n+                return null;\n+            }\n+\n             // Create blank XML document\n             Document document = null;\n             DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n@@ -836,7 +843,7 @@ public class PaletteControl extends Composite {\n                 UiViewElementNode childUiNode = (UiViewElementNode) child;\n                 NodeProxy childNode = nodeFactory.create(childUiNode);\n                 canvas.getRulesEngine().callCreateHooks(layoutEditor,\n-                        null, childNode, InsertType.CREATE);\n+                        null, childNode, InsertType.CREATE_PREVIEW);\n             }\n \n             Integer overrideBgColor = null;\n"", ""NodeProxy.java"": ""@@ -203,6 +203,12 @@ public class NodeProxy implements INode {\n         return insertOrAppend(viewFqcn, index);\n     }\n \n+    public void removeChild(INode node) {\n+        checkEditOK();\n+\n+        ((NodeProxy) node).mNode.deleteXmlNode();\n+    }\n+\n     private INode insertOrAppend(String viewFqcn, int index) {\n         checkEditOK();\n \n"", ""RulesEngine.java"": ""@@ -36,6 +36,7 @@ import com.android.ide.eclipse.adt.internal.editors.AndroidXmlEditor;\n import com.android.ide.eclipse.adt.internal.editors.descriptors.ElementDescriptor;\n import com.android.ide.eclipse.adt.internal.editors.layout.descriptors.ViewElementDescriptor;\n import com.android.ide.eclipse.adt.internal.editors.layout.gle2.GraphicalEditorPart;\n+import com.android.ide.eclipse.adt.internal.editors.layout.gle2.IncludeFinder;\n import com.android.ide.eclipse.adt.internal.editors.layout.gle2.SimpleElement;\n import com.android.ide.eclipse.adt.internal.editors.layout.uimodel.UiViewElementNode;\n import com.android.ide.eclipse.adt.internal.resources.manager.ResourceManager;\n@@ -63,6 +64,7 @@ import java.net.MalformedURLException;\n import java.net.URL;\n import java.net.URLClassLoader;\n import java.util.ArrayList;\n+import java.util.Collection;\n import java.util.HashMap;\n import java.util.HashSet;\n import java.util.List;\n@@ -874,6 +876,11 @@ public class RulesEngine {\n         }\n \n         public String displayResourceInput(String resourceTypeName, String currentValue) {\n+            return displayResourceInput(resourceTypeName, currentValue, null);\n+        }\n+\n+        private String displayResourceInput(String resourceTypeName, String currentValue,\n+                IInputValidator validator) {\n             AndroidXmlEditor editor = mEditor.getLayoutEditor();\n             IProject project = editor.getProject();\n             ResourceType type = ResourceType.getEnum(resourceTypeName);\n@@ -893,6 +900,12 @@ public class RulesEngine {\n                 ResourceChooser dlg = new ResourceChooser(project, type, projectRepository,\n                         systemRepository, shell);\n \n+                if (validator != null) {\n+                    // Ensure wide enough to accommodate validator error message\n+                    dlg.setSize(70, 10);\n+                    dlg.setInputValidator(validator);\n+                }\n+\n                 dlg.setCurrentResource(currentValue);\n \n                 if (dlg.open() == Window.OK) {\n@@ -922,5 +935,29 @@ public class RulesEngine {\n \n             return null;\n         }\n+\n+        public String displayIncludeSourceInput() {\n+            AndroidXmlEditor editor = mEditor.getLayoutEditor();\n+            IProject project = editor.getProject();\n+            if (project != null) {\n+                IncludeFinder includeFinder = IncludeFinder.get(project);\n+                final Collection<String> invalid =\n+                    includeFinder.getInvalidIncludes(editor.getInputFile());\n+                IInputValidator validator = new IInputValidator() {\n+                    public String isValid(String newText) {\n+                        if (invalid.contains(newText)) {\n+                            return String.format(\n+                                    \""Cyclic include, not valid\"",\n+                                    newText);\n+                        }\n+                        return null;\n+                    }\n+                };\n+\n+                return displayResourceInput(ResourceType.LAYOUT.getName(), null, validator);\n+            }\n+\n+            return null;\n+        }\n     }\n }\n"", ""extra-view-metadata.xml"": ""@@ -155,6 +155,10 @@\n             class=\""android.widget.FrameLayout\""\n             fill=\""opposite\""\n             render=\""skip\"" />\n+        <view\n+            class=\""include\""\n+            name=\""Include Other Layout\""\n+            render=\""skip\"" />\n         <view\n             class=\""android.widget.TableLayout\""\n             fill=\""opposite\""\n@@ -309,10 +313,6 @@\n             relatedTo=\""Button\"" />\n         <view\n             class=\""android.widget.ZoomControls\"" />\n-        <view\n-            class=\""include\""\n-            skip=\""true\""\n-            render=\""skip\"" />\n         <view\n             class=\""merge\""\n             skip=\""true\""\n"", ""ChangeLayoutWizard.java"": ""@@ -18,6 +18,7 @@ package com.android.ide.eclipse.adt.internal.editors.layout.refactoring;\n \n import static com.android.ide.common.layout.LayoutConstants.FQCN_RELATIVE_LAYOUT;\n import static com.android.ide.common.layout.LayoutConstants.RELATIVE_LAYOUT;\n+import static com.android.ide.eclipse.adt.internal.editors.layout.descriptors.LayoutDescriptors.VIEW_INCLUDE;\n \n import com.android.ide.eclipse.adt.internal.editors.layout.LayoutEditor;\n \n@@ -33,7 +34,9 @@ import org.eclipse.swt.widgets.Combo;\n import org.eclipse.swt.widgets.Composite;\n import org.eclipse.swt.widgets.Label;\n \n+import java.util.HashSet;\n import java.util.List;\n+import java.util.Set;\n \n class ChangeLayoutWizard extends VisualRefactoringWizard {\n \n@@ -100,9 +103,12 @@ class ChangeLayoutWizard extends VisualRefactoringWizard {\n             // We don't exclude RelativeLayout even if the current layout is RelativeLayout,\n             // in case you are trying to flatten the hierarchy for a hierarchy that has a\n             // RelativeLayout at the root.\n+            Set<String> exclude = new HashSet<String>();\n+            exclude.add(VIEW_INCLUDE);\n             boolean oldIsRelativeLayout = mOldType.equals(FQCN_RELATIVE_LAYOUT);\n-            String exclude = oldIsRelativeLayout ? null : mOldType;\n-\n+            if (oldIsRelativeLayout) {\n+                exclude.add(mOldType);\n+            }\n             mClassNames = WrapInWizard.addLayouts(mProject, mOldType, mTypeCombo, exclude, false);\n \n             mTypeCombo.select(0);\n"", ""WrapInWizard.java"": ""@@ -21,6 +21,7 @@ import static com.android.ide.common.layout.LayoutConstants.FQCN_LINEAR_LAYOUT;\n import static com.android.ide.common.layout.LayoutConstants.FQCN_RADIO_BUTTON;\n import static com.android.ide.common.layout.LayoutConstants.GESTURE_OVERLAY_VIEW;\n import static com.android.ide.common.layout.LayoutConstants.RADIO_GROUP;\n+import static com.android.ide.eclipse.adt.internal.editors.layout.descriptors.LayoutDescriptors.VIEW_INCLUDE;\n import static com.android.sdklib.SdkConstants.CLASS_VIEW;\n import static com.android.sdklib.SdkConstants.CLASS_VIEWGROUP;\n import static com.android.sdklib.SdkConstants.FN_FRAMEWORK_LIBRARY;\n@@ -68,7 +69,9 @@ import org.eclipse.swt.widgets.Label;\n import org.eclipse.swt.widgets.Text;\n \n import java.util.ArrayList;\n+import java.util.Collections;\n import java.util.List;\n+import java.util.Set;\n \n @SuppressWarnings(\""restriction\"") // JDT model access for custom-view class lookup\n class WrapInWizard extends VisualRefactoringWizard {\n@@ -139,7 +142,8 @@ class WrapInWizard extends VisualRefactoringWizard {\n             mUpdateReferences.setText(\""Update layout references\"");\n             mUpdateReferences.addSelectionListener(selectionListener);\n \n-            mClassNames = addLayouts(mProject, mOldType, mTypeCombo, null, true);\n+            Set<String> exclude = Collections.singleton(VIEW_INCLUDE);\n+            mClassNames = addLayouts(mProject, mOldType, mTypeCombo, exclude, true);\n             mTypeCombo.select(0);\n \n             setControl(composite);\n@@ -194,8 +198,8 @@ class WrapInWizard extends VisualRefactoringWizard {\n         }\n     }\n \n-    static List<String> addLayouts(IProject project, String oldType, Combo combo, String exclude,\n-            boolean addGestureOverlay) {\n+    static List<String> addLayouts(IProject project, String oldType, Combo combo,\n+            Set<String> exclude, boolean addGestureOverlay) {\n         List<String> classNames = new ArrayList<String>();\n \n         if (oldType.equals(FQCN_RADIO_BUTTON)) {\n@@ -245,7 +249,7 @@ class WrapInWizard extends VisualRefactoringWizard {\n                     if (layoutDescriptors != null) {\n                         for (ViewElementDescriptor d : layoutDescriptors) {\n                             String className = d.getFullClassName();\n-                            if (exclude == null || !exclude.equals(className)) {\n+                            if (exclude == null || !exclude.contains(className)) {\n                                 combo.add(d.getUiName());\n                                 classNames.add(className);\n                             }\n"", ""ResourceChooser.java"": ""@@ -42,6 +42,7 @@ import org.eclipse.core.runtime.IStatus;\n import org.eclipse.core.runtime.Path;\n import org.eclipse.core.runtime.Status;\n import org.eclipse.jface.dialogs.IDialogConstants;\n+import org.eclipse.jface.dialogs.IInputValidator;\n import org.eclipse.jface.window.Window;\n import org.eclipse.ltk.ui.refactoring.RefactoringWizard;\n import org.eclipse.ltk.ui.refactoring.RefactoringWizardOpenOperation;\n@@ -77,6 +78,7 @@ import java.io.InputStream;\n import java.io.UnsupportedEncodingException;\n import java.util.Arrays;\n import java.util.Collection;\n+import java.util.Collections;\n import java.util.regex.Matcher;\n import java.util.regex.Pattern;\n \n@@ -96,6 +98,7 @@ public class ResourceChooser extends AbstractElementListSelectionDialog {\n     private Button mNewButton;\n     private String mCurrentResource;\n     private final IProject mProject;\n+    private IInputValidator mInputValidator;\n \n     /**\n      * Creates a Resource Chooser dialog.\n@@ -135,6 +138,10 @@ public class ResourceChooser extends AbstractElementListSelectionDialog {\n         return mCurrentResource;\n     }\n \n+    public void setInputValidator(IInputValidator inputValidator) {\n+        mInputValidator = inputValidator;\n+    }\n+\n     @Override\n     protected void computeResult() {\n         Object[] elements = getSelectedElements();\n@@ -143,6 +150,10 @@ public class ResourceChooser extends AbstractElementListSelectionDialog {\n \n             mCurrentResource = ResourceHelper.getXmlString(mResourceType, item,\n                     mSystemButton.getSelection());\n+\n+            if (mInputValidator != null && mInputValidator.isValid(mCurrentResource) != null) {\n+                mCurrentResource = null;\n+            }\n         }\n     }\n \n@@ -229,6 +240,27 @@ public class ResourceChooser extends AbstractElementListSelectionDialog {\n         });\n     }\n \n+    @Override\n+    protected void handleSelectionChanged() {\n+        super.handleSelectionChanged();\n+        if (mInputValidator != null) {\n+            Object[] elements = getSelectedElements();\n+            if (elements.length == 1 && elements[0] instanceof ResourceItem) {\n+                ResourceItem item = (ResourceItem)elements[0];\n+                String current = ResourceHelper.getXmlString(mResourceType, item,\n+                        mSystemButton.getSelection());\n+                String error = mInputValidator.isValid(current);\n+                IStatus status;\n+                if (error != null) {\n+                    status = new Status(IStatus.ERROR, AdtPlugin.PLUGIN_ID, error);\n+                } else {\n+                    status = new Status(IStatus.OK, AdtPlugin.PLUGIN_ID, null);\n+                }\n+                updateStatus(status);\n+            }\n+        }\n+    }\n+\n     private String createNewValue(ResourceType type) {\n         // Show a name/value dialog entering the key name and the value\n         Shell shell = AdtPlugin.getDisplay().getActiveShell();\n@@ -376,6 +408,10 @@ public class ResourceChooser extends AbstractElementListSelectionDialog {\n             items = mFrameworkResources.getResourceItemsOfType(mResourceType);\n         }\n \n+        if (items == null) {\n+            items = Collections.emptyList();\n+        }\n+\n         ResourceItem[] arrayItems = items.toArray(new ResourceItem[items.size()]);\n \n         // sort the array\n@@ -410,19 +446,21 @@ public class ResourceChooser extends AbstractElementListSelectionDialog {\n         boolean isSystem = false;\n         String itemName = null;\n \n-        // Is this a system resource?\n-        // If not a system resource or if they are not available, this will be a project res.\n-        Matcher m = mSystemResourcePattern.matcher(resourceString);\n-        if (m.matches()) {\n-            itemName = m.group(1);\n-            isSystem = true;\n-        }\n-\n-        if (!isSystem && itemName == null) {\n-            // Try to match project resource name\n-            m = mProjectResourcePattern.matcher(resourceString);\n+        if (resourceString != null) {\n+            // Is this a system resource?\n+            // If not a system resource or if they are not available, this will be a project res.\n+            Matcher m = mSystemResourcePattern.matcher(resourceString);\n             if (m.matches()) {\n                 itemName = m.group(1);\n+                isSystem = true;\n+            }\n+\n+            if (!isSystem && itemName == null) {\n+                // Try to match project resource name\n+                m = mProjectResourcePattern.matcher(resourceString);\n+                if (m.matches()) {\n+                    itemName = m.group(1);\n+                }\n             }\n         }\n \n"", ""LayoutTestBase.java"": ""@@ -244,6 +244,11 @@ public class LayoutTestBase extends TestCase {\n             fail(\""Not supported in tests yet\"");\n             return null;\n         }\n+\n+        public String displayIncludeSourceInput() {\n+            fail(\""Not supported in tests yet\"");\n+            return null;\n+        }\n     }\n \n     public void testDummy() {\n"", ""TestNode.java"": ""@@ -154,6 +154,13 @@ public class TestNode implements INode {\n         return child;\n     }\n \n+    public void removeChild(INode node) {\n+        int index = mChildren.indexOf(node);\n+        if (index != -1) {\n+            removeChild(index);\n+        }\n+    }\n+\n     public boolean setAttribute(String uri, String localName, String value) {\n         mAttributes.put(uri + localName, new TestAttribute(uri, localName, value));\n         return true;\n@@ -164,4 +171,5 @@ public class TestNode implements INode {\n         return \""TestNode [fqn=\"" + mFqcn + \"", infos=\"" + mAttributeInfos\n                 + \"", attributes=\"" + mAttributes + \"", bounds=\"" + mBounds + \""]\"";\n     }\n+\n }\n\\ No newline at end of file\n"", ""ViewMetadataRepositoryTest.java"": ""@@ -50,7 +50,7 @@ public class ViewMetadataRepositoryTest extends TestCase {\n \n     public void testSkip() throws Exception {\n         ViewMetadataRepository repository = ViewMetadataRepository.get();\n-        assertTrue(repository.getSkip(\""include\""));\n+        assertTrue(repository.getSkip(\""merge\""));\n         assertFalse(repository.getSkip(\""android.widget.Button\""));\n     }\n \n""}","feature, refactor, deprecate 
"
31451,Ying Wang,Remove non-existent AlarmProvider to fix SDK build.,"['target/product/large_emu_hw.mk', 'target/product/generic_no_telephony.mk']","Remove non-existent AlarmProvider to fix SDK build.

Change-Id: Ifcd087b9022f29b4b7065a72cafbbc6b3704860b",https://android-review.googlesource.com/c/31451,"bug
",bug,Bug;Deprecat;Resource;,"{""generic_no_telephony.mk"": ""@@ -21,7 +21,6 @@ PRODUCT_POLICY := android.policy_phone\n \n PRODUCT_PACKAGES := \\\n     DeskClock \\\n-    AlarmProvider \\\n     Bluetooth \\\n     Calculator \\\n     Calendar \\\n"", ""large_emu_hw.mk"": ""@@ -22,7 +22,6 @@ PRODUCT_POLICY := android.policy_mid\n PRODUCT_PACKAGES := \\\n     CarHome \\\n     DeskClock \\\n-    AlarmProvider \\\n     Bluetooth \\\n     Calculator \\\n     Calendar \\\n""}","resource 
"
8313,Evan JIANG,"Fix ""make modules"" script bug under Mac OS X.",['core/main.mk'],"Fix ""make modules"" script bug under Mac OS X.

For Mac OS uses BSD sed, it doesn't support ""\n"". Then, ""make modules""
command cannot work correctly under Mac OS. Using tr command to replace
sed command, it has the same behavior under both Mac OS and Linux.
",https://android-review.googlesource.com/c/8313,"bug 
",bug,Bug;Resource;,"{""main.mk"": ""@@ -679,7 +679,7 @@ installclean: dataclean\n modules:\n \t@echo \""Available sub-modules:\""\n \t@echo \""$(call module-names-for-tag-list,$(ALL_MODULE_TAGS))\"" | \\\n-\t      sed -e 's/  */\\n/g' | sort -u | $(COLUMN)\n+\t      tr \""  *\"" \""\\n\"" | sort -u | $(COLUMN)\n \n .PHONY: showcommands\n showcommands:\n""}","feature 
"
22491,Bernhard Reutner-Fischer,Fix typo in informational text,['apps/SpareParts/res/values/strings.xml'],"Fix typo in informational text

Change-Id: I43958dea3a6c89523f5d4b914effdc7eb602ae8b
Signed-off-by: Bernhard Reutner-Fischer <rep.dot.nop@gmail.com>",https://android-review.googlesource.com/c/22491,"bug, resource 
","bug,resource",Bug;Resource;,"{""strings.xml"": ""@@ -62,7 +62,7 @@\n     <!-- Sound & display settings screen, compatibility mode check box label -->\n     <string name=\""compatibility_mode_title\"">Compatibility Mode</string>\n     <!-- Sound & display settings screen, compatibility mode option summary text when check box is selected -->\n-    <string name=\""compatibility_mode_summary_on\"">Run older apps in Compatibility mode. This require rebooting. </string>\n+    <string name=\""compatibility_mode_summary_on\"">Run older apps in Compatibility mode. This requires rebooting. </string>\n     <!-- Sound & display settings screen, compatibility mode option summary text when check box is clear -->\n-    <string name=\""compatibility_mode_summary_off\"">Run older apps in Compatibility mode. This require rebooting. </string>\n+    <string name=\""compatibility_mode_summary_off\"">Run older apps in Compatibility mode. This requires rebooting. </string>\n </resources>\n""}","resource 
"
15079,Chris Pearson,Silenced compiler warning seen only in debug builds.,['modules/gralloc/gralloc.cpp'],"Silenced compiler warning seen only in debug builds.

Change-Id: I831ec3a75e6acdfddae95665f6b931b6d731f69e
Signed-off-by: Chris Pearson <christopherx.c.pearson@intel.com>",https://android-review.googlesource.com/c/15079,"bug
",bug,Bug;,"{""gralloc.cpp"": ""@@ -425,7 +425,7 @@ static int gralloc_free(alloc_device_t* dev,\n                 struct pmem_region sub = { hnd->offset, hnd->size };\n                 int err = ioctl(hnd->fd, PMEM_UNMAP, &sub);\n                 LOGE_IF(err<0, \""PMEM_UNMAP failed (%s), \""\n-                        \""fd=%d, sub.offset=%lu, sub.size=%lu\"",\n+                        \""fd=%d, sub.offset=%d, sub.size=%d\"",\n                         strerror(errno), hnd->fd, hnd->offset, hnd->size);\n                 if (err == 0) {\n                     // we can't deallocate the memory in case of UNMAP failure\n""}","bug 
"
20956,Brian Muramatsu,Update Screen Configuration Tests,['tests/tests/dpi/src/android/dpi/cts/ConfigurationTest.java'],"Update Screen Configuration Tests

Bug 2715720

Update ConfigurationTest to be flexible in regards to the new CDD
policies regarding screen sizes and resolutions by getting rid
of the static list of allowed resolutions and replacing it with
some looser checks.

Change-Id: If01457d7dd33bc58e32f1ef77552916006bb5cdf",https://android-review.googlesource.com/c/20956,"Categories: test, bug 
","test,bug",Bug;Resource;Test;,"{""ConfigurationTest.java"": ""@@ -17,235 +17,35 @@\n package android.dpi.cts;\n \n import android.content.Context;\n-import android.content.res.Configuration;\n import android.test.AndroidTestCase;\n+import android.util.DisplayMetrics;\n import android.view.Display;\n import android.view.WindowManager;\n-import android.util.DisplayMetrics;\n-\n-import java.lang.Integer;\n-import java.util.EnumSet;\n \n /**\n- * This is verifying that the device under test is running a supported\n- * resolution, and is being classified as the right Screen Layout\n- * Size.\n+ * Test for verifying a device's screen configuration.\n  */\n public class ConfigurationTest extends AndroidTestCase {\n \n-    private enum Density {\n-        // It is important to keep these sorted\n-        INVALID_LOW(Integer.MIN_VALUE, 99),\n-        LOW (100, 140),\n-        MEDIUM (141, 190),\n-        HIGH (191, 250),\n-        INVALID_HIGH(251, Integer.MAX_VALUE);\n-\n-        private int low;\n-        private int high;\n-\n-        Density(int low, int high) {\n-            this.low = low;\n-            this.high = high;\n-        }\n-\n-        public static Density findDensity(int value) {\n-            Density density = INVALID_LOW;\n-            for (Density d : EnumSet.range(Density.INVALID_LOW, Density.INVALID_HIGH)) {\n-                if (value >= d.low && value <= d.high) {\n-                    density = d;\n-                    break;\n-                }\n-            }\n-            return density;\n-        }\n-    };\n-\n-    /**\n-     * Holds information on the current active screen's configuration.\n-     */\n-    private static class ActiveScreenConfiguration {\n-        private final int width;\n-        private final int height;\n-        private final Density density;\n-\n-        /**\n-         * Create a new ActiveScreenConfiguration.\n-         *\n-         * @param width the width of the screen\n-         * @param height the height of the screen\n-         * @param density the scaling factor for DIP from standard\n-         * density (160.0)\n-         */\n-        public ActiveScreenConfiguration(int width,\n-                                         int height,\n-                                         float density) {\n-            // 160 DIP is the \""standard\"" density\n-            this(width, height, Density.findDensity((int) (160.0f * density)));\n-        }\n-\n-        protected ActiveScreenConfiguration(int width,\n-                                            int height,\n-                                            Density density) {\n-            this.width = width;\n-            this.height = height;\n-            this.density = density;\n-        }\n-\n-        public Density getDensity() {\n-            return density;\n-        }\n-\n-        public int getWidth() {\n-            return width;\n-        }\n-\n-        public int getHeight() {\n-            return height;\n-        }\n-    }\n-\n-    private static class ScreenConfiguration extends ActiveScreenConfiguration {\n-        private final int screenLayout;\n-        private final boolean isWide;\n-\n-        public ScreenConfiguration(int width,\n-                                   int height,\n-                                   Density density,\n-                                   int screenLayout,\n-                                   boolean isWide) {\n-            super(width, height, density);\n-            this.screenLayout = screenLayout;\n-            this.isWide = isWide;\n-        }\n-\n-        public ScreenConfiguration(int width,\n-                                   int height,\n-                                   Density density,\n-                                   int screenLayout) {\n-            this(width, height, density, screenLayout, false);\n-        }\n-\n-        public int getScreenLayout() {\n-            return screenLayout;\n-        }\n-\n-        public boolean isWide() {\n-            return isWide;\n-        }\n-    };\n-\n-    private static boolean areConfigsEqual(ActiveScreenConfiguration active,\n-                                           ScreenConfiguration screenConfig) {\n-        if (screenConfig.isWide()) {\n-            // For widescreen configs, the height is fixed but the\n-            // width only specifies a minimum.  But since the device\n-            // can be both landscape and portrait, we have to search\n-            // for which way it is.\n-            if (active.getHeight() == screenConfig.getHeight()) {\n-                // active height matches config height.  Make sure\n-                // that the active width is at least the config width.\n-                return active.getWidth() >= screenConfig.getWidth();\n-            } else if (active.getWidth() == screenConfig.getHeight()) {\n-                // directions are swapped\n-                return active.getHeight() >= screenConfig.getWidth();\n-            } else {\n-                return false;\n-            }\n-        } else {\n-            if (active.getWidth() == screenConfig.getWidth() &&\n-                active.getHeight() == screenConfig.getHeight() &&\n-                active.getDensity().equals(screenConfig.getDensity())) {\n-                return true;\n-            }\n-            // It is also possible that the device is in landscape\n-            // mode, which flips the active w/h.\n-            if (active.getHeight() == screenConfig.getWidth() &&\n-                active.getWidth() == screenConfig.getHeight() &&\n-                active.getDensity().equals(screenConfig.getDensity())) {\n-                return true;\n-            }\n-            // nope.\n-            return false;\n-        }\n-    }\n-\n-    /**\n-     * Here's the current configuration table:\n-     *\n-     * Resoluion | Density          | Size\n-     * QVGA      | low (100-140)    | small\n-     * WQVGA     | low (100-140)    | normal\n-     * HVGA      | medium (141-190) | normal\n-     * WVGA      | high (191-250)   | normal\n-     * FWVGA     | high (191-250)   | normal\n-     * WSVGA     | high (191-250)   | large\n-\n-     * VGA       | medium (141-190) | large\n-     * WVGA      | medium (141-190) | large\n-     * FWVGA     | medium (141-190) | large\n-     *\n-     * Any changes to allow additional resolutions will need to update this table\n-     */\n-\n-    private static final ScreenConfiguration[] SUPPORTED_SCREEN_CONFIGS = {\n-        // QVGA      | low (100-140)    | small\n-        new ScreenConfiguration(240, 320, Density.LOW, Configuration.SCREENLAYOUT_SIZE_SMALL),\n-        // WQVGA     | low (100-140)    | normal\n-        new ScreenConfiguration(240, 400, Density.LOW, Configuration.SCREENLAYOUT_SIZE_NORMAL),\n-        // HVGA      | medium (141-190) | normal\n-        new ScreenConfiguration(480, 320, Density.MEDIUM, Configuration.SCREENLAYOUT_SIZE_NORMAL),\n-        new ScreenConfiguration(640, 240, Density.MEDIUM, Configuration.SCREENLAYOUT_SIZE_NORMAL),\n-        // WVGA      | high (191-250)   | normal\n-        new ScreenConfiguration(640, 480, Density.HIGH, Configuration.SCREENLAYOUT_SIZE_NORMAL, true),\n-        // FWVGA     | high (191-250)   | normal\n-        new ScreenConfiguration(864, 480, Density.HIGH, Configuration.SCREENLAYOUT_SIZE_NORMAL),\n-        // WSVGA     | high (191-250)   | large\n-        new ScreenConfiguration(1024, 600, Density.HIGH, Configuration.SCREENLAYOUT_SIZE_LARGE),\n-\n-        // VGA       | medium (141-190) | large\n-        new ScreenConfiguration(640, 480, Density.MEDIUM, Configuration.SCREENLAYOUT_SIZE_LARGE),\n-        // WVGA      | medium (141-190) | large\n-        new ScreenConfiguration(640, 480, Density.MEDIUM, Configuration.SCREENLAYOUT_SIZE_LARGE, true),\n-        // FWVGA     | medium (141-190) | large\n-        new ScreenConfiguration(864, 480, Density.MEDIUM, Configuration.SCREENLAYOUT_SIZE_LARGE),\n-\n-    };\n-\n-    private ActiveScreenConfiguration getCurrentScreenConfig() {\n-        WindowManager wm = (WindowManager) getContext().getSystemService(Context.WINDOW_SERVICE);\n-        Display display = wm.getDefaultDisplay();\n-        DisplayMetrics dm = new DisplayMetrics();\n-        display.getMetrics(dm);\n-        return new ActiveScreenConfiguration(display.getWidth(),\n-                                             display.getHeight(),\n-                                             dm.density);\n-    }\n-\n-    /**\n-     * Get the current screen configuration, make sure it is a\n-     * supported screen configuration and that the screenlayout size\n-     * is being set correctly according to the compatibility\n-     * definition.\n-     */\n-    public void testScreenLayoutSize() {\n-        ActiveScreenConfiguration currentScreenConfig = getCurrentScreenConfig();\n-        // Make sure we have a valid density for the current screent.\n-        assertFalse(Density.INVALID_LOW.equals(currentScreenConfig.getDensity()));\n-        assertFalse(Density.INVALID_HIGH.equals(currentScreenConfig.getDensity()));\n-\n-        // Look up the ScreenConfig in the supported table and make\n-        // sure we find a match.\n-        for (ScreenConfiguration screenConfig: SUPPORTED_SCREEN_CONFIGS) {\n-            if (areConfigsEqual(currentScreenConfig, screenConfig)) {\n-                Configuration config = getContext().getResources().getConfiguration();\n-                int size = config.screenLayout & Configuration.SCREENLAYOUT_SIZE_MASK;\n-                if (screenConfig.getScreenLayout() == size) {\n-                    // we have a match, this is a supported device.\n-                    return;\n-                }\n-            }\n-        }\n-        fail(\""Current screen configuration is not supported.\"");\n+    public void testScreenConfiguration() {\n+        WindowManager windowManager =\n+            (WindowManager) getContext().getSystemService(Context.WINDOW_SERVICE);\n+        Display display = windowManager.getDefaultDisplay();\n+        DisplayMetrics metrics = new DisplayMetrics();\n+        display.getMetrics(metrics);\n+\n+        double xInches = (double) metrics.widthPixels / metrics.xdpi;\n+        double yInches = (double) metrics.heightPixels / metrics.ydpi;\n+        double diagonalInches = Math.sqrt(Math.pow(xInches, 2) + Math.pow(yInches, 2));\n+        assertTrue(\""Screen diagonal must be at least 2.5 inches: \"" + diagonalInches,\n+                diagonalInches >= 2.5d);\n+\n+        double density = 160.0d * metrics.density;\n+        assertTrue(\""Screen density must be at least 100 dpi: \"" + density, density >= 100.0d);\n+\n+        double aspectRatio = (double) Math.max(metrics.widthPixels, metrics.heightPixels)\n+                / (double) Math.min(metrics.widthPixels, metrics.heightPixels);\n+        assertTrue(\""Aspect ratio should be between 1.333 (4:3) and 1.779 (16:9): \"" + aspectRatio,\n+                aspectRatio >= 1.333d && aspectRatio <= 1.779d);\n     }\n }\n""}","test 
"
22039,Chih-Wei Huang,x86 libc: fix the wrong return value of syscall,['libc/arch-x86/bionic/syscall.S'],"x86 libc: fix the wrong return value of syscall

According to Intel ABI spec, there is no need to save %eax, %ecx, %edx
on the stack. Worse, popping %eax will wipe out the return value.

Change-Id: Ida536c3b98174b8deef88f8f3b9352eaaeb7c0c0",https://android-review.googlesource.com/c/22039,"bug 
",bug,Bug;Resource;,"{""syscall.S"": ""@@ -20,18 +20,15 @@\n     .align 4\n \n syscall:\n-    push    %eax\n     push    %ebx\n-    push    %ecx\n-    push    %edx\n     push    %esi\n     push    %edi\n-    mov     28(%esp),%eax\n-    mov     32(%esp),%ebx\n-    mov     36(%esp),%ecx\n-    mov     40(%esp),%edx\n-    mov     44(%esp),%esi\n-    mov     48(%esp),%edi\n+    mov     16(%esp),%eax\n+    mov     20(%esp),%ebx\n+    mov     24(%esp),%ecx\n+    mov     28(%esp),%edx\n+    mov     32(%esp),%esi\n+    mov     36(%esp),%edi\n \n     int     $0x80\n \n@@ -45,8 +42,5 @@ syscall:\n 1:\n     pop    %edi\n     pop    %esi\n-    pop    %edx\n-    pop    %ecx\n     pop    %ebx\n-    pop    %eax\n     ret\n""}","bug 
"
20848,Brian Muramatsu,Fix Broken MediaRecorderTest#testSetCamera,['tests/tests/media/src/android/media/cts/MediaRecorderTest.java'],"Fix Broken MediaRecorderTest#testSetCamera

Bug 3188260

The test needs to unlock the camera before passing it to the
MediaRecorder. This is apparently normal as seen in
VideoCamera.java in the Camera project.

Change-Id: Iecc55a2e39929c3637ff5eed805a75fcf5568ca1",https://android-review.googlesource.com/c/20848,"bug, test 
","bug,test",Bug;Test;,"{""MediaRecorderTest.java"": ""@@ -15,7 +15,6 @@\n  */\n package android.media.cts;\n \n-import dalvik.annotation.BrokenTest;\n import dalvik.annotation.TestLevel;\n import dalvik.annotation.TestTargetClass;\n import dalvik.annotation.TestTargetNew;\n@@ -27,6 +26,7 @@ import android.media.MediaRecorder.OnErrorListener;\n import android.media.MediaRecorder.OnInfoListener;\n import android.os.Environment;\n import android.test.ActivityInstrumentationTestCase2;\n+import android.test.UiThreadTest;\n import android.view.Surface;\n \n import java.io.File;\n@@ -89,6 +89,7 @@ public class MediaRecorderTest extends ActivityInstrumentationTestCase2<MediaStu\n         }\n         if (mCamera != null)  {\n             mCamera.release();\n+            mCamera = null;\n         }\n         super.tearDown();\n     }\n@@ -159,10 +160,10 @@ public class MediaRecorderTest extends ActivityInstrumentationTestCase2<MediaStu\n         method = \""setCamera\"",\n         args = {Camera.class}\n     )\n-    @BrokenTest(value=\""No longer works in Donut. CameraService reports: \"" +\n-            \""Attempt to use locked camera from different process\"")\n+    @UiThreadTest\n     public void testSetCamera() throws Exception {\n         mCamera = Camera.open();\n+        mCamera.unlock();\n         mMediaRecorder.setCamera(mCamera);\n         mMediaRecorder.setVideoSource(MediaRecorder.VideoSource.CAMERA);\n         mMediaRecorder.setOutputFormat(MediaRecorder.OutputFormat.DEFAULT);\n""}","bug, test 
"
20563,Xavier Ducrohet,Move SDK Tools and ADT version to 10.,"['eclipse/plugins/com.android.ide.eclipse.hierarchyviewer/META-INF/MANIFEST.MF', 'eclipse/features/com.android.ide.eclipse.pdt/feature.xml', 'eclipse/plugins/com.android.ide.eclipse.pdt/META-INF/MANIFEST.MF', 'eclipse/features/com.android.ide.eclipse.adt/feature.xml', 'eclipse/sites/external/site.xml', 'files/tools_source.properties', 'eclipse/plugins/com.android.ide.eclipse.adt/META-INF/MANIFEST.MF', 'eclipse/features/com.android.ide.eclipse.hierarchyviewer/feature.xml', 'eclipse/sites/internal/site.xml', 'eclipse/plugins/com.android.ide.eclipse.tests/META-INF/MANIFEST.MF', 'eclipse/plugins/com.android.ide.eclipse.ddms/META-INF/MANIFEST.MF', 'eclipse/features/com.android.ide.eclipse.tests/feature.xml', 'eclipse/features/com.android.ide.eclipse.ddms/feature.xml']","Move SDK Tools and ADT version to 10.

Change-Id: I6cfde67f2d0a0da2f94124d19e152e99df349820",https://android-review.googlesource.com/c/20563,"resource 
",resource,Resource;,"{""feature.xml"": ""@@ -2,7 +2,7 @@\n <feature\n       id=\""com.android.ide.eclipse.tests\""\n       label=\""ADT Tests\""\n-      version=\""9.0.0.qualifier\""\n+      version=\""10.0.0.qualifier\""\n       provider-name=\""The Android Open Source Project\"">\n \n    <copyright>\n"", ""MANIFEST.MF"": ""@@ -2,7 +2,7 @@ Manifest-Version: 1.0\n Bundle-ManifestVersion: 2\n Bundle-Name: Android Plugin Tests\n Bundle-SymbolicName: com.android.ide.eclipse.tests\n-Bundle-Version: 9.0.0.qualifier\n+Bundle-Version: 10.0.0.qualifier\n Bundle-Vendor: The Android Open Source Project\n Fragment-Host: com.android.ide.eclipse.adt;bundle-version=\""9.0.0\""\n Require-Bundle: org.junit\n"", ""site.xml"": ""@@ -3,21 +3,21 @@\n    <description url=\""https://android.corp.google.com/adt/\"">\n       Update Site for Android Development Toolkit\n    </description>\n-   <feature url=\""features/com.android.ide.eclipse.adt_9.0.0.qualifier.jar\"" id=\""com.android.ide.eclipse.adt\"" version=\""9.0.0.qualifier\"">\n+   <feature url=\""features/com.android.ide.eclipse.adt_10.0.0.qualifier.jar\"" id=\""com.android.ide.eclipse.adt\"" version=\""10.0.0.qualifier\"">\n       <category name=\""developer\""/>\n    </feature>\n-   <feature url=\""features/com.android.ide.eclipse.ddms_9.0.0.qualifier.jar\"" id=\""com.android.ide.eclipse.ddms\"" version=\""9.0.0.qualifier\"">\n+   <feature url=\""features/com.android.ide.eclipse.ddms_10.0.0.qualifier.jar\"" id=\""com.android.ide.eclipse.ddms\"" version=\""10.0.0.qualifier\"">\n       <category name=\""developer\""/>\n       <category name=\""platform\""/>\n    </feature>\n-   <feature url=\""features/com.android.ide.eclipse.hierarchyviewer_9.0.0.qualifier.jar\"" id=\""com.android.ide.eclipse.hierarchyviewer\"" version=\""9.0.0.qualifier\"">\n+   <feature url=\""features/com.android.ide.eclipse.hierarchyviewer_10.0.0.qualifier.jar\"" id=\""com.android.ide.eclipse.hierarchyviewer\"" version=\""10.0.0.qualifier\"">\n       <category name=\""developer\""/>\n       <category name=\""platform\""/>\n    </feature>\n-   <feature url=\""features/com.android.ide.eclipse.tests_9.0.0.qualifier.jar\"" id=\""com.android.ide.eclipse.tests\"" version=\""9.0.0.qualifier\"">\n+   <feature url=\""features/com.android.ide.eclipse.tests_10.0.0.qualifier.jar\"" id=\""com.android.ide.eclipse.tests\"" version=\""10.0.0.qualifier\"">\n       <category name=\""test\""/>\n    </feature>\n-   <feature url=\""features/com.android.ide.eclipse.pdt_9.0.0.qualifier.jar\"" id=\""com.android.ide.eclipse.pdt\"" version=\""9.0.0.qualifier\"">\n+   <feature url=\""features/com.android.ide.eclipse.pdt_10.0.0.qualifier.jar\"" id=\""com.android.ide.eclipse.pdt\"" version=\""10.0.0.qualifier\"">\n       <category name=\""platform\""/>\n    </feature>\n    <category-def name=\""developer\"" label=\""Application Developer Tools\"">\n"", ""tools_source.properties"": ""@@ -1,2 +1,2 @@\n Pkg.UserSrc=false\n-Pkg.Revision=9\n+Pkg.Revision=10\n""}","resource
"
20861,Arve HjÃ¸nnevÃ¥g,ARM: etm: Configure data tracing,"['arch/arm/kernel/etm.c', 'arch/arm/include/asm/hardware/coresight.h']","ARM: etm: Configure data tracing

The old code enabled data tracing, but did not configure the
range. We now configure it to trace all data addresses by default,
and add a trace_data_range attribute to change the range or disable
data tracing.

Change-Id: I9d04e3e1ea0d0b4d4d5bcb93b1b042938ad738b2
Signed-off-by: Arve HjÃ¸nnevÃ¥g <arve@android.com>",https://android-review.googlesource.com/c/20861,"feature 
",feature,Deprecat;Resource;,"{""coresight.h"": ""@@ -17,9 +17,11 @@\n #define TRACER_ACCESSED_BIT\t0\n #define TRACER_RUNNING_BIT\t1\n #define TRACER_CYCLE_ACC_BIT\t2\n+#define TRACER_TRACE_DATA_BIT\t3\n #define TRACER_ACCESSED\t\tBIT(TRACER_ACCESSED_BIT)\n #define TRACER_RUNNING\t\tBIT(TRACER_RUNNING_BIT)\n #define TRACER_CYCLE_ACC\tBIT(TRACER_CYCLE_ACC_BIT)\n+#define TRACER_TRACE_DATA\tBIT(TRACER_TRACE_DATA_BIT)\n \n #define TRACER_TIMEOUT 10000\n \n@@ -113,8 +115,14 @@\n #define ETMR_TRACEENCTRL\t0x24\n #define ETMTE_INCLEXCL\t\t(1 << 24)\n #define ETMR_TRACEENEVT\t\t0x20\n+\n+#define ETMR_VIEWDATAEVT\t0x30\n+#define ETMR_VIEWDATACTRL1\t0x34\n+#define ETMR_VIEWDATACTRL2\t0x38\n+#define ETMR_VIEWDATACTRL3\t0x3c\n+#define ETMVDC3_EXCLONLY\t(1 << 16)\n+\n #define ETMCTRL_OPTS\t\t(ETMCTRL_DO_CPRT | \\\n-\t\t\t\tETMCTRL_DATA_DO_ADDR | \\\n \t\t\t\tETMCTRL_BRANCH_OUTPUT | \\\n \t\t\t\tETMCTRL_DO_CONTEXTID)\n \n"", ""etm.c"": ""@@ -42,6 +42,8 @@ struct tracectx {\n \tint\t\tetm_portsz;\n \tunsigned long\trange_start;\n \tunsigned long\trange_end;\n+\tunsigned long\tdata_range_start;\n+\tunsigned long\tdata_range_end;\n \tstruct device\t*dev;\n \tstruct clk\t*emu_clk;\n \tstruct mutex\tmutex;\n@@ -83,8 +85,15 @@ static int etm_setup_address_range(struct tracectx *t, int n,\n \tetm_writel(t, flags, ETMR_COMP_ACC_TYPE(n * 2 + 1));\n \tetm_writel(t, end, ETMR_COMP_VAL(n * 2 + 1));\n \n-\tflags = exclude ? ETMTE_INCLEXCL : 0;\n-\tetm_writel(t, flags | (1 << n), ETMR_TRACEENCTRL);\n+\tif (data) {\n+\t\tflags = exclude ? ETMVDC3_EXCLONLY : 0;\n+\t\tif (exclude)\n+\t\t\tn += 8;\n+\t\tetm_writel(t, flags | BIT(n), ETMR_VIEWDATACTRL3);\n+\t} else {\n+\t\tflags = exclude ? ETMTE_INCLEXCL : 0;\n+\t\tetm_writel(t, flags | (1 << n), ETMR_TRACEENCTRL);\n+\t}\n \n \treturn 0;\n }\n@@ -107,6 +116,9 @@ static int trace_start(struct tracectx *t)\n \tif (t->flags & TRACER_CYCLE_ACC)\n \t\tv |= ETMCTRL_CYCLEACCURATE;\n \n+\tif (t->flags & TRACER_TRACE_DATA)\n+\t\tv |= ETMCTRL_DATA_DO_ADDR;\n+\n \tetm_unlock(t);\n \n \tetm_writel(t, v, ETMR_CTRL);\n@@ -129,6 +141,17 @@ static int trace_start(struct tracectx *t)\n \tetm_writel(t, 0, ETMR_TRACESSCTRL);\n \tetm_writel(t, 0x6f, ETMR_TRACEENEVT);\n \n+\tetm_writel(t, 0, ETMR_VIEWDATACTRL1);\n+\tetm_writel(t, 0, ETMR_VIEWDATACTRL2);\n+\n+\tif (t->data_range_start || t->data_range_end)\n+\t\tetm_setup_address_range(t, 2, t->data_range_start,\n+\t\t\t\t\tt->data_range_end, 0, 1);\n+\telse\n+\t\tetm_writel(t, ETMVDC3_EXCLONLY, ETMR_VIEWDATACTRL3);\n+\n+\tetm_writel(t, 0x6f, ETMR_VIEWDATAEVT);\n+\n \tv &= ~ETMCTRL_PROGRAM;\n \tv |= ETMCTRL_PORTSEL;\n \n@@ -569,6 +592,48 @@ static ssize_t trace_range_store(struct kobject *kobj,\n static struct kobj_attribute trace_range_attr =\n \t__ATTR(trace_range, 0644, trace_range_show, trace_range_store);\n \n+static ssize_t trace_data_range_show(struct kobject *kobj,\n+\t\t\t\t  struct kobj_attribute *attr,\n+\t\t\t\t  char *buf)\n+{\n+\tunsigned long range_start;\n+\tu64 range_end;\n+\tmutex_lock(&tracer.mutex);\n+\trange_start = tracer.data_range_start;\n+\trange_end = tracer.data_range_end;\n+\tif (!range_end && (tracer.flags & TRACER_TRACE_DATA))\n+\t\trange_end = 0x100000000ULL;\n+\tmutex_unlock(&tracer.mutex);\n+\treturn sprintf(buf, \""%08lx %08llx\\n\"", range_start, range_end);\n+}\n+\n+static ssize_t trace_data_range_store(struct kobject *kobj,\n+\t\t\t\t   struct kobj_attribute *attr,\n+\t\t\t\t   const char *buf, size_t n)\n+{\n+\tunsigned long range_start;\n+\tu64 range_end;\n+\n+\tif (sscanf(buf, \""%lx %llx\"", &range_start, &range_end) != 2)\n+\t\treturn -EINVAL;\n+\n+\tmutex_lock(&tracer.mutex);\n+\ttracer.data_range_start = range_start;\n+\ttracer.data_range_end = (unsigned long)range_end;\n+\tif (range_end)\n+\t\ttracer.flags |= TRACER_TRACE_DATA;\n+\telse\n+\t\ttracer.flags &= ~TRACER_TRACE_DATA;\n+\tmutex_unlock(&tracer.mutex);\n+\n+\treturn n;\n+}\n+\n+\n+static struct kobj_attribute trace_data_range_attr =\n+\t__ATTR(trace_data_range, 0644,\n+\t\ttrace_data_range_show, trace_data_range_store);\n+\n static int __init etm_probe(struct amba_device *dev, struct amba_id *id)\n {\n \tstruct tracectx *t = &tracer;\n@@ -594,7 +659,7 @@ static int __init etm_probe(struct amba_device *dev, struct amba_id *id)\n \n \tmutex_init(&t->mutex);\n \tt->dev = &dev->dev;\n-\tt->flags = TRACER_CYCLE_ACC;\n+\tt->flags = TRACER_CYCLE_ACC | TRACER_TRACE_DATA;\n \tt->etm_portsz = 1;\n \n \tetm_unlock(t);\n@@ -622,6 +687,11 @@ static int __init etm_probe(struct amba_device *dev, struct amba_id *id)\n \tif (ret)\n \t\tdev_dbg(&dev->dev, \""Failed to create trace_range in sysfs\\n\"");\n \n+\tret = sysfs_create_file(&dev->dev.kobj, &trace_data_range_attr.attr);\n+\tif (ret)\n+\t\tdev_dbg(&dev->dev,\n+\t\t\t\""Failed to create trace_data_range in sysfs\\n\"");\n+\n \tdev_dbg(t->dev, \""ETM AMBA driver initialized.\\n\"");\n \n out:\n""}","feature 
"
20881,Bruce Beare,build-gcc: add the initfini-array configure flag,['build/tools/build-gcc.sh'],"build-gcc: add the initfini-array configure flag

Change-Id: Id59b6db55c63779985cc75f22b3b241f9d38e3c6
Signed-off-by: Bruce Beare <bruce.j.beare@intel.com>",https://android-review.googlesource.com/c/20881,"feature 
",resource,Resource;,"{""build-gcc.sh"": ""@@ -173,6 +173,7 @@ export CFLAGS=\""-Wno-error\""\n #export LDFLAGS=\""$HOST_LDFLAGS\""\n mkdir -p $BUILD_OUT && cd $BUILD_OUT && run \\\n $BUILD_SRCDIR/configure --target=$ABI_CONFIGURE_TARGET \\\n+                        --enable-initfini-array \\\n                         --host=$ABI_CONFIGURE_HOST \\\n                         --build=$ABI_CONFIGURE_BUILD \\\n                         --disable-nls \\\n""}","feature 
"
21607,Jun Nakajima,x86: Enable KVM mode for Android x86 emulator (update/rebase),"['hw/goldfish_nand.c', 'hw/goldfish_tty.c', 'kvm-all.c', 'Makefile.target', 'kvm.h', 'vl-android.c', 'android/config/linux-x86/config-host.h', 'hw/goldfish_device.c', 'disas.c']","x86: Enable KVM mode for Android x86 emulator (update/rebase)

This patch enables KVM mode on x86 Linux to boost performance of x86 emulaiton
if the hardware-based virtualization feature is present on the host machine.

Change-Id: I4b24474b3ec115a3b9a7bf017801f4f610253b09
Signed-off-by: Xiaohui Xin <xiaohui.xin@intel.com>
Signed-off-by: Yunhong Jiang <yunhong.jiang@intel.com>
Signed-off-by: Jun Nakajima <jun.nakajima@intel.com>",https://android-review.googlesource.com/c/21607,"feature 
",feature,Feature;,"{""Makefile.target"": ""@@ -170,6 +170,15 @@ LOCAL_SRC_FILES += \\\n LOCAL_SRC_FILES += fpu/softfloat-native.c\n endif\n \n+# compile KVM only if target is x86 on x86 Linux\n+ifeq ($(QEMU_HOST_TAG)-$(EMULATOR_TARGET_ARCH),linux-x86-x86)\n+# the following is to include linux/kvm.h\n+LOCAL_CFLAGS += -I /usr/include\n+LOCAL_SRC_FILES += \\\n+    target-i386/kvm.c \\\n+    kvm-all.c\n+endif\n+\n ##############################################################################\n # Memory-access checking support.\n # Memory access checker uses information collected by instrumented code in\n"", ""config-host.h"": ""@@ -12,6 +12,7 @@\n #define QEMU_VERSION    \""0.10.50\""\n #define QEMU_PKGVERSION \""Android\""\n #define HOST_I386    1\n+#define CONFIG_KVM   1\n #define CONFIG_IOVEC 1\n #define CONFIG_LINUX   1\n #define CONFIG_ANDROID       1\n"", ""disas.c"": ""@@ -8,6 +8,10 @@\n #include \""exec-all.h\""\n #include \""disas.h\""\n \n+#ifdef TARGET_I386\n+#include \""kvm.h\""\n+#endif\n+\n /* Filled in by elfload.c.  Simplistic, but will do for now. */\n struct syminfo *syminfos = NULL;\n \n@@ -33,6 +37,10 @@ target_read_memory (bfd_vma memaddr,\n                     int length,\n                     struct disassemble_info *info)\n {\n+#ifdef TARGET_I386\n+    if (kvm_enabled())\n+        cpu_synchronize_state(cpu_single_env, 0);\n+#endif\n     cpu_memory_rw_debug(cpu_single_env, memaddr, myaddr, length, 0);\n     return 0;\n }\n"", ""goldfish_device.c"": ""@@ -12,6 +12,9 @@\n #include \""qemu_file.h\""\n #include \""arm_pic.h\""\n #include \""goldfish_device.h\""\n+#ifdef TARGET_I386\n+#include \""kvm.h\""\n+#endif\n \n #define PDEV_BUS_OP_DONE        (0x00)\n #define PDEV_BUS_OP_REMOVE_DEV  (0x04)\n@@ -148,8 +151,13 @@ static void goldfish_bus_write(void *opaque, target_phys_addr_t offset, uint32_t\n             };\n             break;\n         case PDEV_BUS_GET_NAME:\n-            if(s->current)\n+            if(s->current) {\n+#ifdef TARGET_I386\n+                if(kvm_enabled())\n+                    cpu_synchronize_state(cpu_single_env, 0);\n+#endif\n                 cpu_memory_rw_debug(cpu_single_env, value, (void*)s->current->name, strlen(s->current->name), 1);\n+            }\n             break;\n         default:\n             cpu_abort (cpu_single_env, \""goldfish_bus_write: Bad offset %x\\n\"", offset);\n"", ""goldfish_nand.c"": ""@@ -16,6 +16,10 @@\n #include \""qemu_debug.h\""\n #include \""android/android.h\""\n \n+#ifdef TARGET_I386\n+#include \""kvm.h\""\n+#endif\n+\n #define  DEBUG  1\n #if DEBUG\n #  define  D(...)    VERBOSE_PRINT(init,__VA_ARGS__)\n@@ -374,6 +378,10 @@ static uint32_t nand_dev_read_file(nand_dev *dev, uint32_t data, uint64_t addr,\n         if(!eof) {\n             read_len = do_read(dev->fd, dev->data, read_len);\n         }\n+#ifdef TARGET_I386\n+        if (kvm_enabled())\n+            cpu_synchronize_state(cpu_single_env, 0);\n+#endif\n         cpu_memory_rw_debug(cpu_single_env, data, dev->data, read_len, 1);\n         data += read_len;\n         len -= read_len;\n@@ -393,6 +401,10 @@ static uint32_t nand_dev_write_file(nand_dev *dev, uint32_t data, uint64_t addr,\n     while(len > 0) {\n         if(len < write_len)\n             write_len = len;\n+#ifdef TARGET_I386\n+        if (kvm_enabled())\n+                cpu_synchronize_state(cpu_single_env, 0);\n+#endif\n         cpu_memory_rw_debug(cpu_single_env, data, dev->data, write_len, 0);\n         ret = do_write(dev->fd, dev->data, write_len);\n         if(ret < write_len) {\n@@ -455,6 +467,10 @@ uint32_t nand_dev_do_cmd(nand_dev_controller_state *s, uint32_t cmd)\n     case NAND_CMD_GET_DEV_NAME:\n         if(size > dev->devname_len)\n             size = dev->devname_len;\n+#ifdef TARGET_I386\n+        if (kvm_enabled())\n+                cpu_synchronize_state(cpu_single_env, 0);\n+#endif\n         cpu_memory_rw_debug(cpu_single_env, s->data, (uint8_t*)dev->devname, size, 1);\n         return size;\n     case NAND_CMD_READ:\n@@ -464,6 +480,10 @@ uint32_t nand_dev_do_cmd(nand_dev_controller_state *s, uint32_t cmd)\n             size = dev->max_size - addr;\n         if(dev->fd >= 0)\n             return nand_dev_read_file(dev, s->data, addr, size);\n+#ifdef TARGET_I386\n+        if (kvm_enabled())\n+                cpu_synchronize_state(cpu_single_env, 0);\n+#endif\n         cpu_memory_rw_debug(cpu_single_env,s->data, &dev->data[addr], size, 1);\n         return size;\n     case NAND_CMD_WRITE:\n@@ -475,6 +495,10 @@ uint32_t nand_dev_do_cmd(nand_dev_controller_state *s, uint32_t cmd)\n             size = dev->max_size - addr;\n         if(dev->fd >= 0)\n             return nand_dev_write_file(dev, s->data, addr, size);\n+#ifdef TARGET_I386\n+        if (kvm_enabled())\n+                cpu_synchronize_state(cpu_single_env, 0);\n+#endif\n         cpu_memory_rw_debug(cpu_single_env,s->data, &dev->data[addr], size, 0);\n         return size;\n     case NAND_CMD_ERASE:\n"", ""goldfish_tty.c"": ""@@ -13,6 +13,10 @@\n #include \""qemu-char.h\""\n #include \""goldfish_device.h\""\n \n+#ifdef TARGET_I386\n+#include \""kvm.h\""\n+#endif\n+\n enum {\n     TTY_PUT_CHAR       = 0x00,\n     TTY_BYTES_READY    = 0x04,\n@@ -126,6 +130,10 @@ static void goldfish_tty_write(void *opaque, target_phys_addr_t offset, uint32_t\n                             if (to_write > len)\n                                 to_write = len;\n \n+#ifdef TARGET_I386\n+                            if (kvm_enabled())\n+                                cpu_synchronize_state(cpu_single_env, 0);\n+#endif\n                             cpu_memory_rw_debug(cpu_single_env, buf, (uint8_t*)temp, to_write, 0);\n                             qemu_chr_write(s->cs, (const uint8_t*)temp, to_write);\n                             buf += to_write;\n@@ -138,6 +146,10 @@ static void goldfish_tty_write(void *opaque, target_phys_addr_t offset, uint32_t\n                 case TTY_CMD_READ_BUFFER:\n                     if(s->ptr_len > s->data_count)\n                         cpu_abort (cpu_single_env, \""goldfish_tty_write: reading more data than available %d %d\\n\"", s->ptr_len, s->data_count);\n+#ifdef TARGET_I386\n+                    if (kvm_enabled())\n+                        cpu_synchronize_state(cpu_single_env, 0);\n+#endif\n                     cpu_memory_rw_debug(cpu_single_env,s->ptr, s->data, s->ptr_len,1);\n                     //printf(\""goldfish_tty_write: read %d bytes to %x\\n\"", s->ptr_len, s->ptr);\n                     if(s->data_count > s->ptr_len)\n"", ""kvm-all.c"": ""@@ -0,0 +1,1039 @@\n+/*\n+ * QEMU KVM support\n+ *\n+ * Copyright IBM, Corp. 2008\n+ *           Red Hat, Inc. 2008\n+ *\n+ * Authors:\n+ *  Anthony Liguori   <aliguori@us.ibm.com>\n+ *  Glauber Costa     <gcosta@redhat.com>\n+ *\n+ * This work is licensed under the terms of the GNU GPL, version 2 or later.\n+ * See the COPYING file in the top-level directory.\n+ *\n+ */\n+\n+#include <sys/types.h>\n+#include <sys/ioctl.h>\n+#include <sys/mman.h>\n+#include <stdarg.h>\n+\n+#include <linux/kvm.h>\n+\n+#include \""qemu-common.h\""\n+#include \""sysemu.h\""\n+#include \""hw/hw.h\""\n+#include \""gdbstub.h\""\n+#include \""kvm.h\""\n+\n+/* KVM uses PAGE_SIZE in it's definition of COALESCED_MMIO_MAX */\n+#define PAGE_SIZE TARGET_PAGE_SIZE\n+\n+//#define DEBUG_KVM\n+\n+#ifdef DEBUG_KVM\n+#define dprintf(fmt, ...) \\\n+    do { fprintf(stderr, fmt, ## __VA_ARGS__); } while (0)\n+#else\n+#define dprintf(fmt, ...) \\\n+    do { } while (0)\n+#endif\n+\n+typedef struct KVMSlot\n+{\n+    target_phys_addr_t start_addr;\n+    ram_addr_t memory_size;\n+    ram_addr_t phys_offset;\n+    int slot;\n+    int flags;\n+} KVMSlot;\n+\n+typedef struct kvm_dirty_log KVMDirtyLog;\n+\n+int kvm_allowed = 0;\n+\n+struct KVMState\n+{\n+    KVMSlot slots[32];\n+    int fd;\n+    int vmfd;\n+    int coalesced_mmio;\n+    int broken_set_mem_region;\n+    int migration_log;\n+#ifdef KVM_CAP_SET_GUEST_DEBUG\n+    struct kvm_sw_breakpoint_head kvm_sw_breakpoints;\n+#endif\n+};\n+\n+static KVMState *kvm_state;\n+\n+static KVMSlot *kvm_alloc_slot(KVMState *s)\n+{\n+    int i;\n+\n+    for (i = 0; i < ARRAY_SIZE(s->slots); i++) {\n+        /* KVM private memory slots */\n+        if (i >= 8 && i < 12)\n+            continue;\n+        if (s->slots[i].memory_size == 0)\n+            return &s->slots[i];\n+    }\n+\n+    fprintf(stderr, \""%s: no free slot available\\n\"", __func__);\n+    abort();\n+}\n+\n+static KVMSlot *kvm_lookup_matching_slot(KVMState *s,\n+                                         target_phys_addr_t start_addr,\n+                                         target_phys_addr_t end_addr)\n+{\n+    int i;\n+\n+    for (i = 0; i < ARRAY_SIZE(s->slots); i++) {\n+        KVMSlot *mem = &s->slots[i];\n+\n+        if (start_addr == mem->start_addr &&\n+            end_addr == mem->start_addr + mem->memory_size) {\n+            return mem;\n+        }\n+    }\n+\n+    return NULL;\n+}\n+\n+/*\n+ * Find overlapping slot with lowest start address\n+ */\n+static KVMSlot *kvm_lookup_overlapping_slot(KVMState *s,\n+                                            target_phys_addr_t start_addr,\n+                                            target_phys_addr_t end_addr)\n+{\n+    KVMSlot *found = NULL;\n+    int i;\n+\n+    for (i = 0; i < ARRAY_SIZE(s->slots); i++) {\n+        KVMSlot *mem = &s->slots[i];\n+\n+        if (mem->memory_size == 0 ||\n+            (found && found->start_addr < mem->start_addr)) {\n+            continue;\n+        }\n+\n+        if (end_addr > mem->start_addr &&\n+            start_addr < mem->start_addr + mem->memory_size) {\n+            found = mem;\n+        }\n+    }\n+\n+    return found;\n+}\n+\n+static int kvm_set_user_memory_region(KVMState *s, KVMSlot *slot)\n+{\n+    struct kvm_userspace_memory_region mem;\n+\n+    mem.slot = slot->slot;\n+    mem.guest_phys_addr = slot->start_addr;\n+    mem.memory_size = slot->memory_size;\n+    mem.userspace_addr = (unsigned long)qemu_get_ram_ptr(slot->phys_offset);\n+    mem.flags = slot->flags;\n+    if (s->migration_log) {\n+        mem.flags |= KVM_MEM_LOG_DIRTY_PAGES;\n+    }\n+    return kvm_vm_ioctl(s, KVM_SET_USER_MEMORY_REGION, &mem);\n+}\n+\n+\n+int kvm_init_vcpu(CPUState *env)\n+{\n+    KVMState *s = kvm_state;\n+    long mmap_size;\n+    int ret;\n+\n+    dprintf(\""kvm_init_vcpu\\n\"");\n+\n+    ret = kvm_vm_ioctl(s, KVM_CREATE_VCPU, env->cpu_index);\n+    if (ret < 0) {\n+        dprintf(\""kvm_create_vcpu failed\\n\"");\n+        goto err;\n+    }\n+\n+    env->kvm_fd = ret;\n+    env->kvm_state = s;\n+\n+    mmap_size = kvm_ioctl(s, KVM_GET_VCPU_MMAP_SIZE, 0);\n+    if (mmap_size < 0) {\n+        dprintf(\""KVM_GET_VCPU_MMAP_SIZE failed\\n\"");\n+        goto err;\n+    }\n+\n+    env->kvm_run = mmap(NULL, mmap_size, PROT_READ | PROT_WRITE, MAP_SHARED,\n+                        env->kvm_fd, 0);\n+    if (env->kvm_run == MAP_FAILED) {\n+        ret = -errno;\n+        dprintf(\""mmap'ing vcpu state failed\\n\"");\n+        goto err;\n+    }\n+\n+    ret = kvm_arch_init_vcpu(env);\n+\n+err:\n+    return ret;\n+}\n+\n+int kvm_put_mp_state(CPUState *env)\n+{\n+    struct kvm_mp_state mp_state = { .mp_state = env->mp_state };\n+\n+    return kvm_vcpu_ioctl(env, KVM_SET_MP_STATE, &mp_state);\n+}\n+\n+int kvm_get_mp_state(CPUState *env)\n+{\n+    struct kvm_mp_state mp_state;\n+    int ret;\n+\n+    ret = kvm_vcpu_ioctl(env, KVM_GET_MP_STATE, &mp_state);\n+    if (ret < 0) {\n+        return ret;\n+    }\n+    env->mp_state = mp_state.mp_state;\n+    return 0;\n+}\n+\n+int kvm_sync_vcpus(void)\n+{\n+    CPUState *env;\n+\n+    for (env = first_cpu; env != NULL; env = env->next_cpu) {\n+        int ret;\n+\n+        ret = kvm_arch_put_registers(env);\n+        if (ret)\n+            return ret;\n+    }\n+\n+    return 0;\n+}\n+\n+/*\n+ * dirty pages logging control\n+ */\n+static int kvm_dirty_pages_log_change(target_phys_addr_t phys_addr,\n+                                      ram_addr_t size, int flags, int mask)\n+{\n+    KVMState *s = kvm_state;\n+    KVMSlot *mem = kvm_lookup_matching_slot(s, phys_addr, phys_addr + size);\n+    int old_flags;\n+\n+    if (mem == NULL)  {\n+            fprintf(stderr, \""BUG: %s: invalid parameters \"" TARGET_FMT_plx \""-\""\n+                    TARGET_FMT_plx \""\\n\"", __func__, phys_addr,\n+                    phys_addr + size - 1);\n+            return -EINVAL;\n+    }\n+\n+    old_flags = mem->flags;\n+\n+    flags = (mem->flags & ~mask) | flags;\n+    mem->flags = flags;\n+\n+    /* If nothing changed effectively, no need to issue ioctl */\n+    if (s->migration_log) {\n+        flags |= KVM_MEM_LOG_DIRTY_PAGES;\n+    }\n+    if (flags == old_flags) {\n+            return 0;\n+    }\n+\n+    return kvm_set_user_memory_region(s, mem);\n+}\n+\n+int kvm_log_start(target_phys_addr_t phys_addr, ram_addr_t size)\n+{\n+        return kvm_dirty_pages_log_change(phys_addr, size,\n+                                          KVM_MEM_LOG_DIRTY_PAGES,\n+                                          KVM_MEM_LOG_DIRTY_PAGES);\n+}\n+\n+int kvm_log_stop(target_phys_addr_t phys_addr, ram_addr_t size)\n+{\n+        return kvm_dirty_pages_log_change(phys_addr, size,\n+                                          0,\n+                                          KVM_MEM_LOG_DIRTY_PAGES);\n+}\n+\n+int kvm_set_migration_log(int enable)\n+{\n+    KVMState *s = kvm_state;\n+    KVMSlot *mem;\n+    int i, err;\n+\n+    s->migration_log = enable;\n+\n+    for (i = 0; i < ARRAY_SIZE(s->slots); i++) {\n+        mem = &s->slots[i];\n+\n+        if (!!(mem->flags & KVM_MEM_LOG_DIRTY_PAGES) == enable) {\n+            continue;\n+        }\n+        err = kvm_set_user_memory_region(s, mem);\n+        if (err) {\n+            return err;\n+        }\n+    }\n+    return 0;\n+}\n+\n+/**\n+ * kvm_physical_sync_dirty_bitmap - Grab dirty bitmap from kernel space\n+ * This function updates qemu's dirty bitmap using cpu_physical_memory_set_dirty().\n+ * This means all bits are set to dirty.\n+ *\n+ * @start_add: start of logged region.\n+ * @end_addr: end of logged region.\n+ */\n+int kvm_physical_sync_dirty_bitmap(target_phys_addr_t start_addr,\n+                                   target_phys_addr_t end_addr)\n+{\n+    KVMState *s = kvm_state;\n+    unsigned long size, allocated_size = 0;\n+    target_phys_addr_t phys_addr;\n+    ram_addr_t addr;\n+    KVMDirtyLog d;\n+    KVMSlot *mem;\n+    int ret = 0;\n+\n+    d.dirty_bitmap = NULL;\n+    while (start_addr < end_addr) {\n+        mem = kvm_lookup_overlapping_slot(s, start_addr, end_addr);\n+        if (mem == NULL) {\n+            break;\n+        }\n+\n+        size = ((mem->memory_size >> TARGET_PAGE_BITS) + 7) / 8;\n+        if (!d.dirty_bitmap) {\n+            d.dirty_bitmap = qemu_malloc(size);\n+        } else if (size > allocated_size) {\n+            d.dirty_bitmap = qemu_realloc(d.dirty_bitmap, size);\n+        }\n+        allocated_size = size;\n+        memset(d.dirty_bitmap, 0, allocated_size);\n+\n+        d.slot = mem->slot;\n+\n+        if (kvm_vm_ioctl(s, KVM_GET_DIRTY_LOG, &d) == -1) {\n+            dprintf(\""ioctl failed %d\\n\"", errno);\n+            ret = -1;\n+            break;\n+        }\n+\n+        for (phys_addr = mem->start_addr, addr = mem->phys_offset;\n+             phys_addr < mem->start_addr + mem->memory_size;\n+             phys_addr += TARGET_PAGE_SIZE, addr += TARGET_PAGE_SIZE) {\n+            unsigned long *bitmap = (unsigned long *)d.dirty_bitmap;\n+            unsigned nr = (phys_addr - mem->start_addr) >> TARGET_PAGE_BITS;\n+            unsigned word = nr / (sizeof(*bitmap) * 8);\n+            unsigned bit = nr % (sizeof(*bitmap) * 8);\n+\n+            if ((bitmap[word] >> bit) & 1) {\n+                cpu_physical_memory_set_dirty(addr);\n+            }\n+        }\n+        start_addr = phys_addr;\n+    }\n+    qemu_free(d.dirty_bitmap);\n+\n+    return ret;\n+}\n+\n+int kvm_coalesce_mmio_region(target_phys_addr_t start, ram_addr_t size)\n+{\n+    int ret = -ENOSYS;\n+#ifdef KVM_CAP_COALESCED_MMIO\n+    KVMState *s = kvm_state;\n+\n+    if (s->coalesced_mmio) {\n+        struct kvm_coalesced_mmio_zone zone;\n+\n+        zone.addr = start;\n+        zone.size = size;\n+\n+        ret = kvm_vm_ioctl(s, KVM_REGISTER_COALESCED_MMIO, &zone);\n+    }\n+#endif\n+\n+    return ret;\n+}\n+\n+int kvm_uncoalesce_mmio_region(target_phys_addr_t start, ram_addr_t size)\n+{\n+    int ret = -ENOSYS;\n+#ifdef KVM_CAP_COALESCED_MMIO\n+    KVMState *s = kvm_state;\n+\n+    if (s->coalesced_mmio) {\n+        struct kvm_coalesced_mmio_zone zone;\n+\n+        zone.addr = start;\n+        zone.size = size;\n+\n+        ret = kvm_vm_ioctl(s, KVM_UNREGISTER_COALESCED_MMIO, &zone);\n+    }\n+#endif\n+\n+    return ret;\n+}\n+\n+int kvm_check_extension(KVMState *s, unsigned int extension)\n+{\n+    int ret;\n+\n+    ret = kvm_ioctl(s, KVM_CHECK_EXTENSION, extension);\n+    if (ret < 0) {\n+        ret = 0;\n+    }\n+\n+    return ret;\n+}\n+\n+static void kvm_reset_vcpus(void *opaque)\n+{\n+    kvm_sync_vcpus();\n+}\n+\n+int kvm_init(int smp_cpus)\n+{\n+    static const char upgrade_note[] =\n+        \""Please upgrade to at least kernel 2.6.29 or recent kvm-kmod\\n\""\n+        \""(see http://sourceforge.net/projects/kvm).\\n\"";\n+    KVMState *s;\n+    int ret;\n+    int i;\n+\n+    if (smp_cpus > 1) {\n+        fprintf(stderr, \""No SMP KVM support, use '-smp 1'\\n\"");\n+        return -EINVAL;\n+    }\n+\n+    s = qemu_mallocz(sizeof(KVMState));\n+\n+#ifdef KVM_CAP_SET_GUEST_DEBUG\n+    QTAILQ_INIT(&s->kvm_sw_breakpoints);\n+#endif\n+    for (i = 0; i < ARRAY_SIZE(s->slots); i++)\n+        s->slots[i].slot = i;\n+\n+    s->vmfd = -1;\n+    s->fd = open(\""/dev/kvm\"", O_RDWR);\n+    if (s->fd == -1) {\n+        fprintf(stderr, \""Could not access KVM kernel module: %m\\n\"");\n+        ret = -errno;\n+        goto err;\n+    }\n+\n+    ret = kvm_ioctl(s, KVM_GET_API_VERSION, 0);\n+    if (ret < KVM_API_VERSION) {\n+        if (ret > 0)\n+            ret = -EINVAL;\n+        fprintf(stderr, \""kvm version too old\\n\"");\n+        goto err;\n+    }\n+\n+    if (ret > KVM_API_VERSION) {\n+        ret = -EINVAL;\n+        fprintf(stderr, \""kvm version not supported\\n\"");\n+        goto err;\n+    }\n+\n+    s->vmfd = kvm_ioctl(s, KVM_CREATE_VM, 0);\n+    if (s->vmfd < 0)\n+        goto err;\n+\n+    /* initially, KVM allocated its own memory and we had to jump through\n+     * hooks to make phys_ram_base point to this.  Modern versions of KVM\n+     * just use a user allocated buffer so we can use regular pages\n+     * unmodified.  Make sure we have a sufficiently modern version of KVM.\n+     */\n+    if (!kvm_check_extension(s, KVM_CAP_USER_MEMORY)) {\n+        ret = -EINVAL;\n+        fprintf(stderr, \""kvm does not support KVM_CAP_USER_MEMORY\\n%s\"",\n+                upgrade_note);\n+        goto err;\n+    }\n+\n+    /* There was a nasty bug in < kvm-80 that prevents memory slots from being\n+     * destroyed properly.  Since we rely on this capability, refuse to work\n+     * with any kernel without this capability. */\n+    if (!kvm_check_extension(s, KVM_CAP_DESTROY_MEMORY_REGION_WORKS)) {\n+        ret = -EINVAL;\n+\n+        fprintf(stderr,\n+                \""KVM kernel module broken (DESTROY_MEMORY_REGION).\\n%s\"",\n+                upgrade_note);\n+        goto err;\n+    }\n+\n+#ifdef KVM_CAP_COALESCED_MMIO\n+    s->coalesced_mmio = kvm_check_extension(s, KVM_CAP_COALESCED_MMIO);\n+#else\n+    s->coalesced_mmio = 0;\n+#endif\n+\n+    s->broken_set_mem_region = 1;\n+#ifdef KVM_CAP_JOIN_MEMORY_REGIONS_WORKS\n+    ret = kvm_ioctl(s, KVM_CHECK_EXTENSION, KVM_CAP_JOIN_MEMORY_REGIONS_WORKS);\n+    if (ret > 0) {\n+        s->broken_set_mem_region = 0;\n+    }\n+#endif\n+\n+    ret = kvm_arch_init(s, smp_cpus);\n+    if (ret < 0)\n+        goto err;\n+\n+    qemu_register_reset(kvm_reset_vcpus, INT_MAX, NULL);\n+\n+    kvm_state = s;\n+\n+    return 0;\n+\n+err:\n+    if (s) {\n+        if (s->vmfd != -1)\n+            close(s->vmfd);\n+        if (s->fd != -1)\n+            close(s->fd);\n+    }\n+    qemu_free(s);\n+\n+    return ret;\n+}\n+\n+static int kvm_handle_io(CPUState *env, uint16_t port, void *data,\n+                         int direction, int size, uint32_t count)\n+{\n+    int i;\n+    uint8_t *ptr = data;\n+\n+    for (i = 0; i < count; i++) {\n+        if (direction == KVM_EXIT_IO_IN) {\n+            switch (size) {\n+            case 1:\n+                stb_p(ptr, cpu_inb(port));\n+                break;\n+            case 2:\n+                stw_p(ptr, cpu_inw(port));\n+                break;\n+            case 4:\n+                stl_p(ptr, cpu_inl(port));\n+                break;\n+            }\n+        } else {\n+            switch (size) {\n+            case 1:\n+                cpu_outb(port, ldub_p(ptr));\n+                break;\n+            case 2:\n+                cpu_outw(port, lduw_p(ptr));\n+                break;\n+            case 4:\n+                cpu_outl(port, ldl_p(ptr));\n+                break;\n+            }\n+        }\n+\n+        ptr += size;\n+    }\n+\n+    return 1;\n+}\n+\n+static void kvm_run_coalesced_mmio(CPUState *env, struct kvm_run *run)\n+{\n+#ifdef KVM_CAP_COALESCED_MMIO\n+    KVMState *s = kvm_state;\n+    if (s->coalesced_mmio) {\n+        struct kvm_coalesced_mmio_ring *ring;\n+\n+        ring = (void *)run + (s->coalesced_mmio * TARGET_PAGE_SIZE);\n+        while (ring->first != ring->last) {\n+            struct kvm_coalesced_mmio *ent;\n+\n+            ent = &ring->coalesced_mmio[ring->first];\n+\n+            cpu_physical_memory_write(ent->phys_addr, ent->data, ent->len);\n+            /* FIXME smp_wmb() */\n+            ring->first = (ring->first + 1) % KVM_COALESCED_MMIO_MAX;\n+        }\n+    }\n+#endif\n+}\n+\n+int kvm_cpu_exec(CPUState *env)\n+{\n+    struct kvm_run *run = env->kvm_run;\n+    int ret;\n+\n+    dprintf(\""kvm_cpu_exec()\\n\"");\n+\n+    do {\n+        if (env->exit_request) {\n+            dprintf(\""interrupt exit requested\\n\"");\n+            ret = 0;\n+            break;\n+        }\n+\n+        kvm_arch_pre_run(env, run);\n+        ret = kvm_vcpu_ioctl(env, KVM_RUN, 0);\n+        kvm_arch_post_run(env, run);\n+\n+        if (ret == -EINTR || ret == -EAGAIN) {\n+            dprintf(\""io window exit\\n\"");\n+            ret = 0;\n+            break;\n+        }\n+\n+        if (ret < 0) {\n+            dprintf(\""kvm run failed %s\\n\"", strerror(-ret));\n+            abort();\n+        }\n+\n+        kvm_run_coalesced_mmio(env, run);\n+\n+        ret = 0; /* exit loop */\n+        switch (run->exit_reason) {\n+        case KVM_EXIT_IO:\n+            dprintf(\""handle_io\\n\"");\n+            ret = kvm_handle_io(env, run->io.port,\n+                                (uint8_t *)run + run->io.data_offset,\n+                                run->io.direction,\n+                                run->io.size,\n+                                run->io.count);\n+            break;\n+        case KVM_EXIT_MMIO:\n+            dprintf(\""handle_mmio\\n\"");\n+            cpu_physical_memory_rw(run->mmio.phys_addr,\n+                                   run->mmio.data,\n+                                   run->mmio.len,\n+                                   run->mmio.is_write);\n+            ret = 1;\n+            break;\n+        case KVM_EXIT_IRQ_WINDOW_OPEN:\n+            dprintf(\""irq_window_open\\n\"");\n+            break;\n+        case KVM_EXIT_SHUTDOWN:\n+            dprintf(\""shutdown\\n\"");\n+            qemu_system_reset_request();\n+            ret = 1;\n+            break;\n+        case KVM_EXIT_UNKNOWN:\n+            dprintf(\""kvm_exit_unknown\\n\"");\n+            break;\n+        case KVM_EXIT_FAIL_ENTRY:\n+            dprintf(\""kvm_exit_fail_entry\\n\"");\n+            break;\n+        case KVM_EXIT_EXCEPTION:\n+            dprintf(\""kvm_exit_exception\\n\"");\n+            break;\n+        case KVM_EXIT_DEBUG:\n+            dprintf(\""kvm_exit_debug\\n\"");\n+#ifdef KVM_CAP_SET_GUEST_DEBUG\n+            if (kvm_arch_debug(&run->debug.arch)) {\n+                gdb_set_stop_cpu(env);\n+                vm_stop(EXCP_DEBUG);\n+                env->exception_index = EXCP_DEBUG;\n+                return 0;\n+            }\n+            /* re-enter, this exception was guest-internal */\n+            ret = 1;\n+#endif /* KVM_CAP_SET_GUEST_DEBUG */\n+            break;\n+        default:\n+            dprintf(\""kvm_arch_handle_exit\\n\"");\n+            ret = kvm_arch_handle_exit(env, run);\n+            break;\n+        }\n+    } while (ret > 0);\n+\n+    if (env->exit_request) {\n+        env->exit_request = 0;\n+        env->exception_index = EXCP_INTERRUPT;\n+    }\n+\n+    return ret;\n+}\n+\n+void kvm_set_phys_mem(target_phys_addr_t start_addr,\n+                      ram_addr_t size,\n+                      ram_addr_t phys_offset)\n+{\n+    KVMState *s = kvm_state;\n+    ram_addr_t flags = phys_offset & ~TARGET_PAGE_MASK;\n+    KVMSlot *mem, old;\n+    int err;\n+\n+    if (start_addr & ~TARGET_PAGE_MASK) {\n+        if (flags >= IO_MEM_UNASSIGNED) {\n+            if (!kvm_lookup_overlapping_slot(s, start_addr,\n+                                             start_addr + size)) {\n+                return;\n+            }\n+            fprintf(stderr, \""Unaligned split of a KVM memory slot\\n\"");\n+        } else {\n+            fprintf(stderr, \""Only page-aligned memory slots supported\\n\"");\n+        }\n+        abort();\n+    }\n+\n+    /* KVM does not support read-only slots */\n+    phys_offset &= ~IO_MEM_ROM;\n+\n+    while (1) {\n+        mem = kvm_lookup_overlapping_slot(s, start_addr, start_addr + size);\n+        if (!mem) {\n+            break;\n+        }\n+\n+        if (flags < IO_MEM_UNASSIGNED && start_addr >= mem->start_addr &&\n+            (start_addr + size <= mem->start_addr + mem->memory_size) &&\n+            (phys_offset - start_addr == mem->phys_offset - mem->start_addr)) {\n+            /* The new slot fits into the existing one and comes with\n+             * identical parameters - nothing to be done. */\n+            return;\n+        }\n+\n+        old = *mem;\n+\n+        /* unregister the overlapping slot */\n+        mem->memory_size = 0;\n+        err = kvm_set_user_memory_region(s, mem);\n+        if (err) {\n+            fprintf(stderr, \""%s: error unregistering overlapping slot: %s\\n\"",\n+                    __func__, strerror(-err));\n+            abort();\n+        }\n+\n+        /* Workaround for older KVM versions: we can't join slots, even not by\n+         * unregistering the previous ones and then registering the larger\n+         * slot. We have to maintain the existing fragmentation. Sigh.\n+         *\n+         * This workaround assumes that the new slot starts at the same\n+         * address as the first existing one. If not or if some overlapping\n+         * slot comes around later, we will fail (not seen in practice so far)\n+         * - and actually require a recent KVM version. */\n+        if (s->broken_set_mem_region &&\n+            old.start_addr == start_addr && old.memory_size < size &&\n+            flags < IO_MEM_UNASSIGNED) {\n+            mem = kvm_alloc_slot(s);\n+            mem->memory_size = old.memory_size;\n+            mem->start_addr = old.start_addr;\n+            mem->phys_offset = old.phys_offset;\n+            mem->flags = 0;\n+\n+            err = kvm_set_user_memory_region(s, mem);\n+            if (err) {\n+                fprintf(stderr, \""%s: error updating slot: %s\\n\"", __func__,\n+                        strerror(-err));\n+                abort();\n+            }\n+\n+            start_addr += old.memory_size;\n+            phys_offset += old.memory_size;\n+            size -= old.memory_size;\n+            continue;\n+        }\n+\n+        /* register prefix slot */\n+        if (old.start_addr < start_addr) {\n+            mem = kvm_alloc_slot(s);\n+            mem->memory_size = start_addr - old.start_addr;\n+            mem->start_addr = old.start_addr;\n+            mem->phys_offset = old.phys_offset;\n+            mem->flags = 0;\n+\n+            err = kvm_set_user_memory_region(s, mem);\n+            if (err) {\n+                fprintf(stderr, \""%s: error registering prefix slot: %s\\n\"",\n+                        __func__, strerror(-err));\n+                abort();\n+            }\n+        }\n+\n+        /* register suffix slot */\n+        if (old.start_addr + old.memory_size > start_addr + size) {\n+            ram_addr_t size_delta;\n+\n+            mem = kvm_alloc_slot(s);\n+            mem->start_addr = start_addr + size;\n+            size_delta = mem->start_addr - old.start_addr;\n+            mem->memory_size = old.memory_size - size_delta;\n+            mem->phys_offset = old.phys_offset + size_delta;\n+            mem->flags = 0;\n+\n+            err = kvm_set_user_memory_region(s, mem);\n+            if (err) {\n+                fprintf(stderr, \""%s: error registering suffix slot: %s\\n\"",\n+                        __func__, strerror(-err));\n+                abort();\n+            }\n+        }\n+    }\n+\n+    /* in case the KVM bug workaround already \""consumed\"" the new slot */\n+    if (!size)\n+        return;\n+\n+    /* KVM does not need to know about this memory */\n+    if (flags >= IO_MEM_UNASSIGNED)\n+        return;\n+\n+    mem = kvm_alloc_slot(s);\n+    mem->memory_size = size;\n+    mem->start_addr = start_addr;\n+    mem->phys_offset = phys_offset;\n+    mem->flags = 0;\n+\n+    err = kvm_set_user_memory_region(s, mem);\n+    if (err) {\n+        fprintf(stderr, \""%s: error registering slot: %s\\n\"", __func__,\n+                strerror(-err));\n+        abort();\n+    }\n+}\n+\n+int kvm_ioctl(KVMState *s, int type, ...)\n+{\n+    int ret;\n+    void *arg;\n+    va_list ap;\n+\n+    va_start(ap, type);\n+    arg = va_arg(ap, void *);\n+    va_end(ap);\n+\n+    ret = ioctl(s->fd, type, arg);\n+    if (ret == -1)\n+        ret = -errno;\n+\n+    return ret;\n+}\n+\n+int kvm_vm_ioctl(KVMState *s, int type, ...)\n+{\n+    int ret;\n+    void *arg;\n+    va_list ap;\n+\n+    va_start(ap, type);\n+    arg = va_arg(ap, void *);\n+    va_end(ap);\n+\n+    ret = ioctl(s->vmfd, type, arg);\n+    if (ret == -1)\n+        ret = -errno;\n+\n+    return ret;\n+}\n+\n+int kvm_vcpu_ioctl(CPUState *env, int type, ...)\n+{\n+    int ret;\n+    void *arg;\n+    va_list ap;\n+\n+    va_start(ap, type);\n+    arg = va_arg(ap, void *);\n+    va_end(ap);\n+\n+    ret = ioctl(env->kvm_fd, type, arg);\n+    if (ret == -1)\n+        ret = -errno;\n+\n+    return ret;\n+}\n+\n+int kvm_has_sync_mmu(void)\n+{\n+#ifdef KVM_CAP_SYNC_MMU\n+    KVMState *s = kvm_state;\n+\n+    return kvm_check_extension(s, KVM_CAP_SYNC_MMU);\n+#else\n+    return 0;\n+#endif\n+}\n+\n+void kvm_setup_guest_memory(void *start, size_t size)\n+{\n+    if (!kvm_has_sync_mmu()) {\n+#ifdef MADV_DONTFORK\n+        int ret = madvise(start, size, MADV_DONTFORK);\n+\n+        if (ret) {\n+            perror(\""madvice\"");\n+            exit(1);\n+        }\n+#else\n+        fprintf(stderr,\n+                \""Need MADV_DONTFORK in absence of synchronous KVM MMU\\n\"");\n+        exit(1);\n+#endif\n+    }\n+}\n+\n+#ifdef KVM_CAP_SET_GUEST_DEBUG\n+struct kvm_sw_breakpoint *kvm_find_sw_breakpoint(CPUState *env,\n+                                                 target_ulong pc)\n+{\n+    struct kvm_sw_breakpoint *bp;\n+\n+    QTAILQ_FOREACH(bp, &env->kvm_state->kvm_sw_breakpoints, entry) {\n+        if (bp->pc == pc)\n+            return bp;\n+    }\n+    return NULL;\n+}\n+\n+int kvm_sw_breakpoints_active(CPUState *env)\n+{\n+    return !QTAILQ_EMPTY(&env->kvm_state->kvm_sw_breakpoints);\n+}\n+\n+int kvm_update_guest_debug(CPUState *env, unsigned long reinject_trap)\n+{\n+    struct kvm_guest_debug dbg;\n+\n+    dbg.control = 0;\n+    if (env->singlestep_enabled)\n+        dbg.control = KVM_GUESTDBG_ENABLE | KVM_GUESTDBG_SINGLESTEP;\n+\n+    kvm_arch_update_guest_debug(env, &dbg);\n+    dbg.control |= reinject_trap;\n+\n+    return kvm_vcpu_ioctl(env, KVM_SET_GUEST_DEBUG, &dbg);\n+}\n+\n+int kvm_insert_breakpoint(CPUState *current_env, target_ulong addr,\n+                          target_ulong len, int type)\n+{\n+    struct kvm_sw_breakpoint *bp;\n+    CPUState *env;\n+    int err;\n+\n+    if (type == GDB_BREAKPOINT_SW) {\n+        bp = kvm_find_sw_breakpoint(current_env, addr);\n+        if (bp) {\n+            bp->use_count++;\n+            return 0;\n+        }\n+\n+        bp = qemu_malloc(sizeof(struct kvm_sw_breakpoint));\n+        if (!bp)\n+            return -ENOMEM;\n+\n+        bp->pc = addr;\n+        bp->use_count = 1;\n+        err = kvm_arch_insert_sw_breakpoint(current_env, bp);\n+        if (err) {\n+            free(bp);\n+            return err;\n+        }\n+\n+        QTAILQ_INSERT_HEAD(&current_env->kvm_state->kvm_sw_breakpoints,\n+                          bp, entry);\n+    } else {\n+        err = kvm_arch_insert_hw_breakpoint(addr, len, type);\n+        if (err)\n+            return err;\n+    }\n+\n+    for (env = first_cpu; env != NULL; env = env->next_cpu) {\n+        err = kvm_update_guest_debug(env, 0);\n+        if (err)\n+            return err;\n+    }\n+    return 0;\n+}\n+\n+int kvm_remove_breakpoint(CPUState *current_env, target_ulong addr,\n+                          target_ulong len, int type)\n+{\n+    struct kvm_sw_breakpoint *bp;\n+    CPUState *env;\n+    int err;\n+\n+    if (type == GDB_BREAKPOINT_SW) {\n+        bp = kvm_find_sw_breakpoint(current_env, addr);\n+        if (!bp)\n+            return -ENOENT;\n+\n+        if (bp->use_count > 1) {\n+            bp->use_count--;\n+            return 0;\n+        }\n+\n+        err = kvm_arch_remove_sw_breakpoint(current_env, bp);\n+        if (err)\n+            return err;\n+\n+        QTAILQ_REMOVE(&current_env->kvm_state->kvm_sw_breakpoints, bp, entry);\n+        qemu_free(bp);\n+    } else {\n+        err = kvm_arch_remove_hw_breakpoint(addr, len, type);\n+        if (err)\n+            return err;\n+    }\n+\n+    for (env = first_cpu; env != NULL; env = env->next_cpu) {\n+        err = kvm_update_guest_debug(env, 0);\n+        if (err)\n+            return err;\n+    }\n+    return 0;\n+}\n+\n+void kvm_remove_all_breakpoints(CPUState *current_env)\n+{\n+    struct kvm_sw_breakpoint *bp, *next;\n+    KVMState *s = current_env->kvm_state;\n+    CPUState *env;\n+\n+    QTAILQ_FOREACH_SAFE(bp, &s->kvm_sw_breakpoints, entry, next) {\n+        if (kvm_arch_remove_sw_breakpoint(current_env, bp) != 0) {\n+            /* Try harder to find a CPU that currently sees the breakpoint. */\n+            for (env = first_cpu; env != NULL; env = env->next_cpu) {\n+                if (kvm_arch_remove_sw_breakpoint(env, bp) == 0)\n+                    break;\n+            }\n+        }\n+    }\n+    kvm_arch_remove_all_hw_breakpoints();\n+\n+    for (env = first_cpu; env != NULL; env = env->next_cpu)\n+        kvm_update_guest_debug(env, 0);\n+}\n+\n+#else /* !KVM_CAP_SET_GUEST_DEBUG */\n+\n+int kvm_update_guest_debug(CPUState *env, unsigned long reinject_trap)\n+{\n+    return -EINVAL;\n+}\n+\n+int kvm_insert_breakpoint(CPUState *current_env, target_ulong addr,\n+                          target_ulong len, int type)\n+{\n+    return -EINVAL;\n+}\n+\n+int kvm_remove_breakpoint(CPUState *current_env, target_ulong addr,\n+                          target_ulong len, int type)\n+{\n+    return -EINVAL;\n+}\n+\n+void kvm_remove_all_breakpoints(CPUState *current_env)\n+{\n+}\n+#endif /* !KVM_CAP_SET_GUEST_DEBUG */\n"", ""kvm.h"": ""@@ -18,6 +18,8 @@\n #include \""qemu-queue.h\""\n \n #ifdef CONFIG_KVM\n+\n+#ifdef TARGET_I386\n extern int kvm_allowed;\n \n #define kvm_enabled() (kvm_allowed)\n@@ -25,6 +27,10 @@ extern int kvm_allowed;\n #define kvm_enabled() (0)\n #endif\n \n+#else\n+#define kvm_enabled() (0)\n+#endif\n+\n struct kvm_run;\n \n /* external API */\n"", ""vl-android.c"": ""@@ -4520,6 +4520,7 @@ int main(int argc, char **argv, char **envp)\n                 kqemu_allowed = 2;\n                 break;\n #endif\n+#ifdef TARGET_I386\n #ifdef CONFIG_KVM\n             case QEMU_OPTION_enable_kvm:\n                 kvm_allowed = 1;\n@@ -4528,6 +4529,7 @@ int main(int argc, char **argv, char **envp)\n #endif\n                 break;\n #endif\n+#endif  /* TARGET_I386 */\n             case QEMU_OPTION_usb:\n                 usb_enabled = 1;\n                 break;\n""}","feature 
"
22764,Zhihong GUO,add source code to test if the data sms sent on port can be received correctly.,['tests/tests/telephony/src/android/telephony/cts/SmsManagerTest.java'],"add source code to test if the data sms sent on port can be received correctly.

add a receiver on port 19989 to get the data sms and verify if the content can be decode correclty.

Signed-off-by: gzhhong <gzhhong@gmail.com>

	modified:   tests/tests/telephony/src/android/telephony/cts/SmsManagerTest.java

Change-Id: I3f609ad58d4e1d6207a853e4ad0221f975af0e26",https://android-review.googlesource.com/c/22764,"test 
",test,Test;,"{""SmsManagerTest.java"": ""@@ -31,6 +31,8 @@ import android.os.SystemClock;\n import android.telephony.SmsManager;\n import android.telephony.TelephonyManager;\n import android.test.AndroidTestCase;\n+import android.telephony.SmsMessage;\n+import android.os.Bundle;\n \n import java.util.ArrayList;\n import java.util.Arrays;\n@@ -54,6 +56,7 @@ public class SmsManagerTest extends AndroidTestCase {\n \n     private static final String SMS_SEND_ACTION = \""CTS_SMS_SEND_ACTION\"";\n     private static final String SMS_DELIVERY_ACTION = \""CTS_SMS_DELIVERY_ACTION\"";\n+    private static final String DATA_SMS_RECEIVED_ACTION = \""android.intent.action.DATA_SMS_RECEIVED\"";\n \n     // List of network operators that don't support SMS delivery report\n     private static final List<String> NO_DELIVERY_REPORTS =\n@@ -97,11 +100,15 @@ public class SmsManagerTest extends AndroidTestCase {\n     private String mText;\n     private SmsBroadcastReceiver mSendReceiver;\n     private SmsBroadcastReceiver mDeliveryReceiver;\n+    private SmsBroadcastReceiver mDataSmsReceiver;\n     private PendingIntent mSentIntent;\n     private PendingIntent mDeliveredIntent;\n     private Intent mSendIntent;\n     private Intent mDeliveryIntent;\n+    private Intent mDataSmsReceiveIntent;\n     private boolean mDeliveryReportSupported;\n+    private boolean mReceivedDataSms;\n+    private String mReceivedText;\n \n     private static final int TIME_OUT = 1000 * 60 * 5;\n \n@@ -168,15 +175,22 @@ public class SmsManagerTest extends AndroidTestCase {\n \n         mSendIntent = new Intent(SMS_SEND_ACTION);\n         mDeliveryIntent = new Intent(SMS_DELIVERY_ACTION);\n+        mReceivedDataSms = false;\n+        mDataSmsReceiveIntent = new Intent(DATA_SMS_RECEIVED_ACTION);\n \n         IntentFilter sendIntentFilter = new IntentFilter(SMS_SEND_ACTION);\n         IntentFilter deliveryIntentFilter = new IntentFilter(SMS_DELIVERY_ACTION);\n+        IntentFilter dataSmsReceivedIntentFilter = new IntentFilter(DATA_SMS_RECEIVED_ACTION);\n+        dataSmsReceivedIntentFilter.addDataScheme(\""sms\"");\n+        dataSmsReceivedIntentFilter.addDataAuthority(\""localhost\"", \""19989\"");\n \n         mSendReceiver = new SmsBroadcastReceiver(SMS_SEND_ACTION);\n         mDeliveryReceiver = new SmsBroadcastReceiver(SMS_DELIVERY_ACTION);\n+        mDataSmsReceiver = new SmsBroadcastReceiver(DATA_SMS_RECEIVED_ACTION);\n \n         getContext().registerReceiver(mSendReceiver, sendIntentFilter);\n         getContext().registerReceiver(mDeliveryReceiver, deliveryIntentFilter);\n+        getContext().registerReceiver(mDataSmsReceiver, dataSmsReceivedIntentFilter);\n \n         // send single text sms\n         init();\n@@ -202,6 +216,9 @@ public class SmsManagerTest extends AndroidTestCase {\n             if (mDeliveryReportSupported) {\n                 assertTrue(mDeliveryReceiver.waitForCalls(1, TIME_OUT));\n             }\n+            mDataSmsReceiver.waitForCalls(1, TIME_OUT);\n+            assertTrue(mReceivedDataSms);\n+            assertEquals(mReceivedText, mText);\n         } else {\n             // This GSM network doesn't support Data(binary) SMS message.\n             // Skip the test.\n@@ -232,6 +249,7 @@ public class SmsManagerTest extends AndroidTestCase {\n     private void init() {\n         mSendReceiver.reset();\n         mDeliveryReceiver.reset();\n+        mDataSmsReceiver.reset();\n         mSentIntent = PendingIntent.getBroadcast(getContext(), 0, mSendIntent,\n                 PendingIntent.FLAG_ONE_SHOT);\n         mDeliveredIntent = PendingIntent.getBroadcast(getContext(), 0, mDeliveryIntent,\n@@ -287,6 +305,23 @@ public class SmsManagerTest extends AndroidTestCase {\n \n         @Override\n         public void onReceive(Context context, Intent intent) {\n+            if(mAction.equals(DATA_SMS_RECEIVED_ACTION)){\n+                StringBuilder sb = new StringBuilder();\n+                Bundle bundle = intent.getExtras();\n+                if (bundle != null) {\n+                    Object[] obj = (Object[]) bundle.get(\""pdus\"");\n+                    SmsMessage[] message = new SmsMessage[obj.length];\n+                    for (int i = 0; i < obj.length; i++) {\n+                        message[i] = SmsMessage.createFromPdu((byte[]) obj[i]);\n+                    }\n+\n+                    for (SmsMessage currentMessage : message) {\n+                        sb.append(currentMessage.getDisplayMessageBody());\n+                    }\n+                }\n+                mReceivedDataSms = true;\n+                mReceivedText=sb.toString();\n+            }\n             if (intent.getAction().equals(mAction)) {\n                 synchronized (mLock) {\n                     mCalls += 1;\n""}","test 
"
16730,Erik Gilling,video: tegra: add hdmi output support,"['drivers/video/tegra/dc/edid.c', 'drivers/video/tegra/dc/hdmi.c', 'drivers/video/tegra/dc/Makefile', 'drivers/video/tegra/dc/dc.c', 'drivers/video/tegra/dc/hdmi_reg.h', 'drivers/video/tegra/dc/edid.h', 'arch/arm/mach-tegra/include/mach/dc.h']","video: tegra: add hdmi output support

Signed-off-by: Erik Gilling <konkers@android.com>
",https://android-review.googlesource.com/c/16730,"feature 
",feature,Feature;,"{""dc.h"": ""@@ -53,6 +53,7 @@ struct tegra_dc_mode {\n \n enum {\n \tTEGRA_DC_OUT_RGB,\n+\tTEGRA_DC_OUT_HDMI,\n };\n \n struct tegra_dc_out {\n"", ""Makefile"": ""@@ -1,2 +1,4 @@\n obj-y += dc.o\n-obj-y += rgb.o\n\\ No newline at end of file\n+obj-y += rgb.o\n+obj-y += hdmi.o\n+obj-y += edid.o\n\\ No newline at end of file\n"", ""dc.c"": ""@@ -487,7 +487,24 @@ EXPORT_SYMBOL(tegra_dc_set_blending);\n \n void tegra_dc_setup_clk(struct tegra_dc *dc, struct clk *clk)\n {\n-\t/* clock setup for DSI/HDMI to go here */\n+\tif (dc->out->type == TEGRA_DC_OUT_HDMI) {\n+\t\tunsigned long rate;\n+\t\tstruct clk *pll_d_out0_clk =\n+\t\t\tclk_get_sys(NULL, \""pll_d_out0\"");\n+\t\tstruct clk *pll_d_clk =\n+\t\t\tclk_get_sys(NULL, \""pll_d\"");\n+\n+\t\tif (dc->mode.pclk > 70000)\n+\t\t\trate = 594000000;\n+\t\telse\n+\t\t\trate = 216000000;\n+\n+\t\tif (rate != clk_get_rate(pll_d_clk))\n+\t\t    clk_set_rate(pll_d_clk, rate);\n+\n+\t\tif (clk_get_parent(clk) != pll_d_out0_clk)\n+\t\t\tclk_set_parent(clk, pll_d_out0_clk);\n+\t}\n }\n \n static int tegra_dc_program_mode(struct tegra_dc *dc, struct tegra_dc_mode *mode)\n@@ -570,6 +587,10 @@ static void tegra_dc_set_out(struct tegra_dc *dc, struct tegra_dc_out *out)\n \t\tdc->out_ops = &tegra_dc_rgb_ops;\n \t\tbreak;\n \n+\tcase TEGRA_DC_OUT_HDMI:\n+\t\tdc->out_ops = &tegra_dc_hdmi_ops;\n+\t\tbreak;\n+\n \tdefault:\n \t\tdc->out_ops = NULL;\n \t\tbreak;\n"", ""edid.c"": ""@@ -0,0 +1,109 @@\n+/*\n+ * drivers/video/tegra/dc/edid.c\n+ *\n+ * Copyright (C) 2010 Google, Inc.\n+ * Author: Erik Gilling <konkers@android.com>\n+ *\n+ * This software is licensed under the terms of the GNU General Public\n+ * License version 2, as published by the Free Software Foundation, and\n+ * may be copied, distributed, and modified under those terms.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ */\n+\n+#include <linux/i2c.h>\n+#include <linux/fb.h>\n+\n+#include \""edid.h\""\n+\n+int tegra_edid_get_monspecs(struct tegra_edid *edid, struct fb_monspecs *specs)\n+{\n+\tu8 data[256];\n+\tint i;\n+\tint ret;\n+\n+\tfor (i = 0; i < 256; i++) {\n+\t\tret = i2c_smbus_read_byte_data(edid->client, i);\n+\t\tif (ret < 0)\n+\t\t\tbreak;\n+\n+\t\tdata[i] = ret;\n+\t}\n+\n+\tif (i != 128 && i != 256)\n+\t\treturn ret;\n+\n+\tfb_edid_to_monspecs(data, specs);\n+\tif (i == 256)\n+\t\tfb_edid_add_monspecs(data + 128, specs);\n+\n+\treturn 0;\n+}\n+\n+struct tegra_edid *tegra_edid_create(int bus)\n+{\n+\tstruct tegra_edid *edid;\n+\tstruct i2c_adapter *adapter;\n+\n+\tedid = kzalloc(sizeof(struct tegra_edid), GFP_KERNEL);\n+\tif (!edid)\n+\t\treturn ERR_PTR(-ENOMEM);\n+\n+\tstrlcpy(edid->info.type, \""tegra_edid\"", sizeof(edid->info.type));\n+\tedid->info.addr = 0x50;\n+\tedid->info.platform_data = edid;\n+\tinit_waitqueue_head(&edid->wq);\n+\n+\tadapter = i2c_get_adapter(bus);\n+\tif (!adapter) {\n+\t\tpr_err(\""can't get adpater for bus %d\\n\"", bus);\n+\t\treturn NULL;\n+\t}\n+\tedid->client = i2c_new_device(adapter, &edid->info);\n+\n+\ti2c_put_adapter(adapter);\n+\n+\tif (!edid->client) {\n+\t\tpr_err(\""can't create new device\\n\"");\n+\t\treturn NULL;\n+\t}\n+\n+\treturn edid;\n+}\n+\n+void tegra_edid_destroy(struct tegra_edid *edid)\n+{\n+\ti2c_release_client(edid->client);\n+\tkfree(edid);\n+}\n+\n+static const struct i2c_device_id tegra_edid_id[] = {\n+        { \""tegra_edid\"", 0 },\n+        { }\n+};\n+\n+MODULE_DEVICE_TABLE(i2c, tegra_edid_id);\n+\n+static struct i2c_driver tegra_edid_driver = {\n+        .id_table = tegra_edid_id,\n+        .driver = {\n+                .name = \""tegra_edid\"",\n+        },\n+};\n+\n+static int __init tegra_edid_init(void)\n+{\n+        return i2c_add_driver(&tegra_edid_driver);\n+}\n+\n+static void __exit tegra_edid_exit(void)\n+{\n+        i2c_del_driver(&tegra_edid_driver);\n+}\n+\n+module_init(tegra_edid_init);\n+module_exit(tegra_edid_exit);\n"", ""edid.h"": ""@@ -0,0 +1,37 @@\n+/*\n+ * drivers/video/tegra/dc/edid.h\n+ *\n+ * Copyright (C) 2010 Google, Inc.\n+ * Author: Erik Gilling <konkers@android.com>\n+ *\n+ * This software is licensed under the terms of the GNU General Public\n+ * License version 2, as published by the Free Software Foundation, and\n+ * may be copied, distributed, and modified under those terms.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ */\n+\n+#ifndef __DRIVERS_VIDEO_TEGRA_DC_EDID_H\n+#define __DRIVERS_VIDEO_TEGRA_DC_EDID_H\n+\n+#include <linux/i2c.h>\n+#include <linux/wait.h>\n+\n+struct tegra_edid {\n+\tstruct i2c_client\t*client;\n+\tstruct i2c_board_info\tinfo;\n+\n+\tint\t\t\tprobed;\n+\twait_queue_head_t\twq;\n+};\n+\n+struct tegra_edid *tegra_edid_create(int bus);\n+void tegra_edid_destroy(struct tegra_edid *edid);\n+\n+int tegra_edid_get_monspecs(struct tegra_edid *edid, struct fb_monspecs *specs);\n+\n+#endif\n"", ""hdmi.c"": ""@@ -0,0 +1,723 @@\n+/*\n+ * drivers/video/tegra/dc/hdmi.c\n+ *\n+ * Copyright (C) 2010 Google, Inc.\n+ * Author: Erik Gilling <konkers@android.com>\n+ *\n+ * This software is licensed under the terms of the GNU General Public\n+ * License version 2, as published by the Free Software Foundation, and\n+ * may be copied, distributed, and modified under those terms.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ */\n+\n+#include <linux/clk.h>\n+#include <linux/delay.h>\n+#include <linux/err.h>\n+#include <linux/fb.h>\n+#include <linux/gpio.h>\n+#include <linux/interrupt.h>\n+#include <linux/kernel.h>\n+#include <linux/nvhost_bus.h>\n+#include <linux/slab.h>\n+#include <linux/workqueue.h>\n+\n+#include <mach/clk.h>\n+#include <mach/dc.h>\n+#include <mach/fb.h>\n+\n+#include \""dc_reg.h\""\n+#include \""dc_priv.h\""\n+#include \""hdmi_reg.h\""\n+#include \""edid.h\""\n+\n+struct tegra_dc_hdmi_data {\n+\tstruct tegra_dc\t\t\t*dc;\n+\tstruct tegra_edid\t\t*edid;\n+\tstruct delayed_work\t\twork;\n+\n+\tstruct resource\t\t\t*base_res;\n+\tvoid __iomem\t\t\t*base;\n+\tstruct clk\t\t\t*clk;\n+};\n+\n+const struct fb_videomode tegra_dc_hdmi_supported_modes[] = {\n+\t/* 1280x720p 60hz: EIA/CEA-861-B Format 4 */\n+\t{\n+\t\t.xres =\t\t1280,\n+\t\t.yres =\t\t720,\n+\t\t.pixclock =\tKHZ2PICOS(74250),\n+\t\t.hsync_len =\t40,\t/* h_sync_width */\n+\t\t.vsync_len =\t5,\t/* v_sync_width */\n+\t\t.left_margin =\t220,\t/* h_back_porch */\n+\t\t.upper_margin =\t20,\t/* v_back_porch */\n+\t\t.right_margin =\t110,\t/* h_front_porch */\n+\t\t.lower_margin =\t5,\t/* v_front_porch */\n+\t\t.vmode =\tFB_VMODE_NONINTERLACED,\n+\t\t.sync = FB_SYNC_HOR_HIGH_ACT | FB_SYNC_VERT_HIGH_ACT,\n+\t},\n+\n+\t/* 720x480p 59.94hz: EIA/CEA-861-B Formats 2 & 3 */\n+\t{\n+\t\t.xres =\t\t720,\n+\t\t.yres =\t\t480,\n+\t\t.pixclock =\tKHZ2PICOS(27000),\n+\t\t.hsync_len =\t62,\t/* h_sync_width */\n+\t\t.vsync_len =\t6,\t/* v_sync_width */\n+\t\t.left_margin =\t60,\t/* h_back_porch */\n+\t\t.upper_margin =\t30,\t/* v_back_porch */\n+\t\t.right_margin =\t16,\t/* h_front_porch */\n+\t\t.lower_margin =\t9,\t/* v_front_porch */\n+\t\t.vmode =\tFB_VMODE_NONINTERLACED,\n+\t\t.sync = FB_SYNC_HOR_HIGH_ACT | FB_SYNC_VERT_HIGH_ACT,\n+\t},\n+\n+\t/* 640x480p 60hz: EIA/CEA-861-B Format 1 */\n+\t{\n+\t\t.xres =\t\t640,\n+\t\t.yres =\t\t480,\n+\t\t.pixclock =\tKHZ2PICOS(25200),\n+\t\t.hsync_len =\t96,\t/* h_sync_width */\n+\t\t.vsync_len =\t2,\t/* v_sync_width */\n+\t\t.left_margin =\t48,\t/* h_back_porch */\n+\t\t.upper_margin =\t33,\t/* v_back_porch */\n+\t\t.right_margin =\t16,\t/* h_front_porch */\n+\t\t.lower_margin =\t10,\t/* v_front_porch */\n+\t\t.vmode =\tFB_VMODE_NONINTERLACED,\n+\t\t.sync = FB_SYNC_HOR_HIGH_ACT | FB_SYNC_VERT_HIGH_ACT,\n+\t},\n+\n+\t/* 720x576p 50hz EIA/CEA-861-B Formats 17 & 18 */\n+\t{\n+\t\t.xres =\t\t720,\n+\t\t.yres =\t\t576,\n+\t\t.pixclock =\tKHZ2PICOS(27000),\n+\t\t.hsync_len =\t64,\t/* h_sync_width */\n+\t\t.vsync_len =\t5,\t/* v_sync_width */\n+\t\t.left_margin =\t68,\t/* h_back_porch */\n+\t\t.upper_margin =\t39,\t/* v_back_porch */\n+\t\t.right_margin =\t12,\t/* h_front_porch */\n+\t\t.lower_margin =\t5,\t/* v_front_porch */\n+\t\t.vmode =\tFB_VMODE_NONINTERLACED,\n+\t\t.sync = FB_SYNC_HOR_HIGH_ACT | FB_SYNC_VERT_HIGH_ACT,\n+\t},\n+\n+\t/* 1920x1080p 59.94/60hz EIA/CEA-861-B Format 16 */\n+\t{\n+\t\t.xres =\t\t1920,\n+\t\t.yres =\t\t1080,\n+\t\t.pixclock =\tKHZ2PICOS(148500),\n+\t\t.hsync_len =\t44,\t/* h_sync_width */\n+\t\t.vsync_len =\t5,\t/* v_sync_width */\n+\t\t.left_margin =\t148,\t/* h_back_porch */\n+\t\t.upper_margin =\t36,\t/* v_back_porch */\n+\t\t.right_margin =\t88,\t/* h_front_porch */\n+\t\t.lower_margin =\t4,\t/* v_front_porch */\n+\t\t.vmode =\tFB_VMODE_NONINTERLACED,\n+\t\t.sync = FB_SYNC_HOR_HIGH_ACT | FB_SYNC_VERT_HIGH_ACT,\n+\t},\n+};\n+\n+static inline unsigned long tegra_hdmi_readl(struct tegra_dc_hdmi_data *hdmi,\n+\t\t\t\t\t     unsigned long reg)\n+{\n+\treturn readl(hdmi->base + reg * 4);\n+}\n+\n+static inline void tegra_hdmi_writel(struct tegra_dc_hdmi_data *hdmi,\n+\t\t\t\t     unsigned long val, unsigned long reg)\n+{\n+\twritel(val, hdmi->base + reg * 4);\n+}\n+\n+static inline void tegra_hdmi_clrsetbits(struct tegra_dc_hdmi_data *hdmi,\n+\t\t\t\t\t unsigned long reg, unsigned long clr,\n+\t\t\t\t\t unsigned long set)\n+{\n+\tunsigned long val = tegra_hdmi_readl(hdmi, reg);\n+\tval &= ~clr;\n+\tval |= set;\n+\ttegra_hdmi_writel(hdmi, val, reg);\n+}\n+\n+#define DUMP_REG(a) do {\t\t\t\t\t\t\\\n+\t\tprintk(\""HDMI %-32s\\t%03x\\t%08lx\\n\"",\t\t\t\\\n+\t\t       #a, a, tegra_hdmi_readl(hdmi, a));\t\t\\\n+\t} while (0)\n+\n+#ifdef DEBUG\n+static void hdmi_dumpregs(struct tegra_dc_hdmi_data *hdmi)\n+{\n+\tDUMP_REG(HDMI_CTXSW);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_STATE0);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_STATE1);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_STATE2);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_AN_MSB);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_AN_LSB);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_CN_MSB);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_CN_LSB);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_AKSV_MSB);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_AKSV_LSB);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_BKSV_MSB);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_BKSV_LSB);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_CKSV_MSB);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_CKSV_LSB);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_DKSV_MSB);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_DKSV_LSB);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_CTRL);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_CMODE);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_MPRIME_MSB);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_MPRIME_LSB);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_SPRIME_MSB);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_SPRIME_LSB2);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_SPRIME_LSB1);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_RI);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_CS_MSB);\n+\tDUMP_REG(HDMI_NV_PDISP_RG_HDCP_CS_LSB);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_AUDIO_EMU0);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_AUDIO_EMU_RDATA0);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_AUDIO_EMU1);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_AUDIO_EMU2);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_CTRL);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_STATUS);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_HEADER);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_SUBPACK0_LOW);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_SUBPACK0_HIGH);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_CTRL);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_STATUS);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_HEADER);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_SUBPACK0_LOW);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_SUBPACK0_HIGH);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_SUBPACK1_LOW);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_SUBPACK1_HIGH);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_CTRL);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_STATUS);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_HEADER);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK0_LOW);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK0_HIGH);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK1_LOW);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK1_HIGH);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK2_LOW);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK2_HIGH);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK3_LOW);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK3_HIGH);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_CTRL);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0320_SUBPACK_LOW);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0320_SUBPACK_HIGH);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0441_SUBPACK_LOW);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0441_SUBPACK_HIGH);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0882_SUBPACK_LOW);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0882_SUBPACK_HIGH);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_1764_SUBPACK_LOW);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_1764_SUBPACK_HIGH);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0480_SUBPACK_LOW);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0480_SUBPACK_HIGH);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0960_SUBPACK_LOW);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_0960_SUBPACK_HIGH);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_1920_SUBPACK_LOW);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_ACR_1920_SUBPACK_HIGH);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_CTRL);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_VSYNC_KEEPOUT);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_VSYNC_WINDOW);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_GCP_CTRL);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_GCP_STATUS);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_GCP_SUBPACK);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_CHANNEL_STATUS1);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_CHANNEL_STATUS2);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_EMU0);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_EMU1);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_EMU1_RDATA);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_SPARE);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_SPDIF_CHN_STATUS1);\n+\tDUMP_REG(HDMI_NV_PDISP_HDMI_SPDIF_CHN_STATUS2);\n+\tDUMP_REG(HDMI_NV_PDISP_HDCPRIF_ROM_CTRL);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_CAP);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_PWR);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_TEST);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_PLL0);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_PLL1);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_PLL2);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_CSTM);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_LVDS);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_CRCA);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_CRCB);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_BLANK);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_CTL);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST0);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST1);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST2);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST3);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST4);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST5);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST6);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST7);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST8);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INST9);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INSTA);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INSTB);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INSTC);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INSTD);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INSTE);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_SEQ_INSTF);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_VCRCA0);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_VCRCA1);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_CCRCA0);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_CCRCA1);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_EDATAA0);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_EDATAA1);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_COUNTA0);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_COUNTA1);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_DEBUGA0);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_DEBUGA1);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_TRIG);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_MSCHECK);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_LANE_DRIVE_CURRENT);\n+\tDUMP_REG(HDMI_NV_PDISP_AUDIO_DEBUG0);\n+\tDUMP_REG(HDMI_NV_PDISP_AUDIO_DEBUG1);\n+\tDUMP_REG(HDMI_NV_PDISP_AUDIO_DEBUG2);\n+\tDUMP_REG(HDMI_NV_PDISP_AUDIO_FS1);\n+\tDUMP_REG(HDMI_NV_PDISP_AUDIO_FS2);\n+\tDUMP_REG(HDMI_NV_PDISP_AUDIO_FS3);\n+\tDUMP_REG(HDMI_NV_PDISP_AUDIO_FS4);\n+\tDUMP_REG(HDMI_NV_PDISP_AUDIO_FS5);\n+\tDUMP_REG(HDMI_NV_PDISP_AUDIO_FS6);\n+\tDUMP_REG(HDMI_NV_PDISP_AUDIO_FS7);\n+\tDUMP_REG(HDMI_NV_PDISP_AUDIO_PULSE_WIDTH);\n+\tDUMP_REG(HDMI_NV_PDISP_AUDIO_THRESHOLD);\n+\tDUMP_REG(HDMI_NV_PDISP_AUDIO_CNTRL0);\n+\tDUMP_REG(HDMI_NV_PDISP_AUDIO_N);\n+\tDUMP_REG(HDMI_NV_PDISP_HDCPRIF_ROM_TIMING);\n+\tDUMP_REG(HDMI_NV_PDISP_SOR_REFCLK);\n+\tDUMP_REG(HDMI_NV_PDISP_CRC_CONTROL);\n+\tDUMP_REG(HDMI_NV_PDISP_INPUT_CONTROL);\n+\tDUMP_REG(HDMI_NV_PDISP_SCRATCH);\n+\tDUMP_REG(HDMI_NV_PDISP_PE_CURRENT);\n+\tDUMP_REG(HDMI_NV_PDISP_KEY_CTRL);\n+\tDUMP_REG(HDMI_NV_PDISP_KEY_DEBUG0);\n+\tDUMP_REG(HDMI_NV_PDISP_KEY_DEBUG1);\n+\tDUMP_REG(HDMI_NV_PDISP_KEY_DEBUG2);\n+\tDUMP_REG(HDMI_NV_PDISP_KEY_HDCP_KEY_0);\n+\tDUMP_REG(HDMI_NV_PDISP_KEY_HDCP_KEY_1);\n+\tDUMP_REG(HDMI_NV_PDISP_KEY_HDCP_KEY_2);\n+\tDUMP_REG(HDMI_NV_PDISP_KEY_HDCP_KEY_3);\n+\tDUMP_REG(HDMI_NV_PDISP_KEY_HDCP_KEY_TRIG);\n+\tDUMP_REG(HDMI_NV_PDISP_KEY_SKEY_INDEX);\n+}\n+#endif\n+\n+#define PIXCLOCK_TOLERANCE\t200\n+\n+static bool tegra_dc_hdmi_mode_equal(const struct fb_videomode *mode1,\n+\t\t\t\t\tconst struct fb_videomode *mode2)\n+{\n+\tint diff = (s64)mode1->pixclock - (s64)mode2->pixclock;\n+\n+\treturn mode1->xres\t== mode2->xres &&\n+\t\tmode1->yres\t== mode2->yres &&\n+\t\tdiff\t\t< PIXCLOCK_TOLERANCE &&\n+\t\tdiff\t\t> -PIXCLOCK_TOLERANCE &&\n+\t\tmode1->vmode\t== mode2->vmode;\n+}\n+\n+static bool tegra_dc_hdmi_mode_filter(struct fb_videomode *mode)\n+{\n+\tint i;\n+\n+\tfor (i = 0; i < ARRAY_SIZE(tegra_dc_hdmi_supported_modes); i++) {\n+\t\tif (tegra_dc_hdmi_mode_equal(&tegra_dc_hdmi_supported_modes[i],\n+\t\t\t\t\t     mode))\n+\t\t\treturn true;\n+\t}\n+\n+\treturn false;\n+}\n+\n+\n+static bool tegra_dc_hdmi_hpd(struct tegra_dc *dc)\n+{\n+\tint sense;\n+\tint level;\n+\n+\tlevel = gpio_get_value(dc->out->hotplug_gpio);\n+\n+\tsense = dc->out->flags & TEGRA_DC_OUT_HOTPLUG_MASK;\n+\n+\treturn (sense == TEGRA_DC_OUT_HOTPLUG_HIGH && level) ||\n+\t\t(sense == TEGRA_DC_OUT_HOTPLUG_LOW && !level);\n+}\n+\n+static bool tegra_dc_hdmi_detect(struct tegra_dc *dc)\n+{\n+\tstruct tegra_dc_hdmi_data *hdmi = tegra_dc_get_outdata(dc);\n+\tstruct fb_monspecs specs;\n+\tint err;\n+\n+\tif (!tegra_dc_hdmi_hpd(dc))\n+\t\treturn false;\n+\n+\terr = tegra_edid_get_monspecs(hdmi->edid, &specs);\n+\tif (err < 0) {\n+\t\tdev_err(&dc->ndev->dev, \""error reading edid\\n\"");\n+\t\treturn false;\n+\t}\n+\n+\ttegra_fb_update_monspecs(dc->fb, &specs, tegra_dc_hdmi_mode_filter);\n+\tdev_info(&dc->ndev->dev, \""display detected\\n\"");\n+\treturn true;\n+}\n+\n+\n+static void tegra_dc_hdmi_detect_worker(struct work_struct *work)\n+{\n+\tstruct tegra_dc_hdmi_data *hdmi =\n+\t\tcontainer_of(to_delayed_work(work), struct tegra_dc_hdmi_data, work);\n+\tstruct tegra_dc *dc = hdmi->dc;\n+\n+\tif (tegra_dc_hdmi_hpd(dc))\n+\t\ttegra_dc_hdmi_detect(dc);\n+}\n+\n+static irqreturn_t tegra_dc_hdmi_irq(int irq, void *ptr)\n+{\n+\tstruct tegra_dc *dc = ptr;\n+\tstruct tegra_dc_hdmi_data *hdmi = tegra_dc_get_outdata(dc);\n+\n+\tif (tegra_dc_hdmi_hpd(dc))\n+\t\tschedule_delayed_work(&hdmi->work, msecs_to_jiffies(2000));\n+\n+\treturn IRQ_HANDLED;\n+}\n+\n+static int tegra_dc_hdmi_init(struct tegra_dc *dc)\n+{\n+\tstruct tegra_dc_hdmi_data *hdmi;\n+\tstruct resource *res;\n+\tstruct resource *base_res;\n+\tvoid __iomem *base;\n+\tstruct clk *clk;\n+\tint err;\n+\n+\thdmi = kzalloc(sizeof(*hdmi), GFP_KERNEL);\n+\tif (!hdmi)\n+\t\treturn -ENOMEM;\n+\n+\tres = nvhost_get_resource_byname(dc->ndev, IORESOURCE_MEM, \""hdmi_regs\"");\n+\tif (!res) {\n+\t\tdev_err(&dc->ndev->dev, \""hdmi: no mem resource\\n\"");\n+\t\terr = -ENOENT;\n+\t\tgoto err_free_hdmi;\n+\t}\n+\n+\tbase_res = request_mem_region(res->start, resource_size(res), dc->ndev->name);\n+\tif (!base_res) {\n+\t\tdev_err(&dc->ndev->dev, \""hdmi: request_mem_region failed\\n\"");\n+\t\terr = -EBUSY;\n+\t\tgoto err_free_hdmi;\n+\t}\n+\n+\tbase = ioremap(res->start, resource_size(res));\n+\tif (!base) {\n+\t\tdev_err(&dc->ndev->dev, \""hdmi: registers can't be mapped\\n\"");\n+\t\terr = -EBUSY;\n+\t\tgoto err_release_resource_reg;\n+\t}\n+\n+\tclk = clk_get(&dc->ndev->dev, \""hdmi\"");\n+\tif (IS_ERR_OR_NULL(clk)) {\n+\t\tdev_err(&dc->ndev->dev, \""hdmi: can't get clock\\n\"");\n+\t\terr = -ENOENT;\n+\t\tgoto err_iounmap_reg;\n+\t}\n+\n+\t/* TODO: support non-hotplug */\n+\tif (request_irq(gpio_to_irq(dc->out->hotplug_gpio), tegra_dc_hdmi_irq,\n+\t\t\tIRQF_DISABLED | IRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\n+\t\t\tdev_name(&dc->ndev->dev), dc)) {\n+\t\tdev_err(&dc->ndev->dev, \""hdmi: request_irq %d failed\\n\"",\n+\t\t\tgpio_to_irq(dc->out->hotplug_gpio));\n+\t\terr = -EBUSY;\n+\t\tgoto err_put_clock;\n+\t}\n+\n+\thdmi->edid = tegra_edid_create(dc->out->dcc_bus);\n+\tif (IS_ERR_OR_NULL(hdmi->edid)) {\n+\t\tdev_err(&dc->ndev->dev, \""hdmi: can't create edid\\n\"");\n+\t\terr = PTR_ERR(hdmi->edid);\n+\t\tgoto err_free_irq;\n+\t}\n+\n+\tINIT_DELAYED_WORK(&hdmi->work, tegra_dc_hdmi_detect_worker);\n+\n+\thdmi->dc = dc;\n+\thdmi->base = base;\n+\thdmi->base_res = base_res;\n+\thdmi->clk = clk;\n+\n+\ttegra_dc_set_outdata(dc, hdmi);\n+\n+\treturn 0;\n+\n+err_free_irq:\n+\tfree_irq(gpio_to_irq(dc->out->hotplug_gpio), dc);\n+err_put_clock:\n+\tclk_put(clk);\n+err_iounmap_reg:\n+\tiounmap(base);\n+err_release_resource_reg:\n+\trelease_resource(base_res);\n+err_free_hdmi:\n+\tkfree(hdmi);\n+\treturn err;\n+}\n+\n+static void tegra_dc_hdmi_destroy(struct tegra_dc *dc)\n+{\n+\tstruct tegra_dc_hdmi_data *hdmi = tegra_dc_get_outdata(dc);\n+\n+\tfree_irq(gpio_to_irq(dc->out->hotplug_gpio), dc);\n+\tcancel_delayed_work_sync(&hdmi->work);\n+\tiounmap(hdmi->base);\n+\trelease_resource(hdmi->base_res);\n+\tclk_put(hdmi->clk);\n+\ttegra_edid_destroy(hdmi->edid);\n+\n+\tkfree(hdmi);\n+\n+}\n+\n+static void tegra_dc_hdmi_enable(struct tegra_dc *dc)\n+{\n+\tstruct tegra_dc_hdmi_data *hdmi = tegra_dc_get_outdata(dc);\n+\tint pulse_start;\n+\tint dispclk_div_8_2;\n+\tint pll0;\n+\tint pll1;\n+\tint ds;\n+\tint retries;\n+\tunsigned long val;\n+\n+\t/* enbale power, clocks, resets, etc. */\n+\ttegra_dc_setup_clk(dc, hdmi->clk);\n+\tclk_set_rate(hdmi->clk, dc->mode.pclk);\n+\n+\tclk_enable(hdmi->clk);\n+\ttegra_periph_reset_assert(hdmi->clk);\n+\tmdelay(1);\n+\ttegra_periph_reset_deassert(hdmi->clk);\n+\n+\t/* TODO: copy HDCP keys from KFUSE to HDMI */\n+\n+\t/* Program display timing registers: handled by dc */\n+\n+\t/* program HDMI registers and SOR sequencer */\n+\n+\ttegra_dc_writel(dc, VSYNC_H_POSITION(1), DC_DISP_DISP_TIMING_OPTIONS);\n+\ttegra_dc_writel(dc, DITHER_CONTROL_DISABLE | BASE_COLOR_SIZE888,\n+\t\t\tDC_DISP_DISP_COLOR_CONTROL);\n+\n+\t/* video_preamble uses h_pulse2 */\n+\tpulse_start = dc->mode.h_ref_to_sync + dc->mode.h_sync_width +\n+\t\tdc->mode.h_back_porch - 10;\n+\ttegra_dc_writel(dc, H_PULSE_2_ENABLE, DC_DISP_DISP_SIGNAL_OPTIONS0);\n+\ttegra_dc_writel(dc,\n+\t\t\tPULSE_MODE_NORMAL |\n+\t\t\tPULSE_POLARITY_HIGH |\n+\t\t\tPULSE_QUAL_VACTIVE |\n+\t\t\tPULSE_LAST_END_A,\n+\t\t\tDC_DISP_H_PULSE2_CONTROL);\n+\ttegra_dc_writel(dc, PULSE_START(pulse_start) | PULSE_END(pulse_start + 8),\n+\t\t  DC_DISP_H_PULSE2_POSITION_A);\n+\n+\ttegra_hdmi_writel(hdmi,\n+\t\t\t  VSYNC_WINDOW_END(0x210) |\n+\t\t\t  VSYNC_WINDOW_START(0x200) |\n+\t\t\t  VSYNC_WINDOW_ENABLE,\n+\t\t\t  HDMI_NV_PDISP_HDMI_VSYNC_WINDOW);\n+\n+\t/* TODO: scale output to 16-235 */\n+\n+\ttegra_hdmi_writel(hdmi,\n+\t\t\t  (dc->ndev->id ? HDMI_SRC_DISPLAYB : HDMI_SRC_DISPLAYA) |\n+\t\t\t  ARM_VIDEO_RANGE_LIMITED,\n+\t\t\t  HDMI_NV_PDISP_INPUT_CONTROL);\n+\n+\tdispclk_div_8_2 = clk_get_rate(hdmi->clk) / 1000000 * 4;\n+\ttegra_hdmi_writel(hdmi,\n+\t\t\t  SOR_REFCLK_DIV_INT(dispclk_div_8_2 >> 2) |\n+\t\t\t  SOR_REFCLK_DIV_FRAC(dispclk_div_8_2),\n+\t\t\t  HDMI_NV_PDISP_SOR_REFCLK);\n+\n+\t/* TODO: setup audio */\n+\n+\t/* values from harmony board.  Will be replaced when\n+\t * audio and avi are supported */\n+\ttegra_hdmi_writel(hdmi, 0x00000001, 0x1e);\n+\ttegra_hdmi_writel(hdmi, 0x00000000, 0x20);\n+\ttegra_hdmi_writel(hdmi, 0x000000aa, 0x21);\n+\ttegra_hdmi_writel(hdmi, 0x00000001, 0x23);\n+\ttegra_hdmi_writel(hdmi, 0x00000001, 0x24);\n+\ttegra_hdmi_writel(hdmi, 0x00000000, 0x25);\n+\ttegra_hdmi_writel(hdmi, 0x000445eb, 0x26);\n+\ttegra_hdmi_writel(hdmi, 0x00000004, 0x27);\n+\ttegra_hdmi_writel(hdmi, 0x00002710, 0x2a);\n+\ttegra_hdmi_writel(hdmi, 0x00000000, 0x35);\n+\ttegra_hdmi_writel(hdmi, 0x0015bc10, 0x38);\n+\ttegra_hdmi_writel(hdmi, 0x04c4bb58, 0x39);\n+\ttegra_hdmi_writel(hdmi, 0x0263b9b6, 0x44);\n+\ttegra_hdmi_writel(hdmi, 0x00002713, 0x4f);\n+\ttegra_hdmi_writel(hdmi, 0x01e85426, 0x57);\n+\ttegra_hdmi_writel(hdmi, 0x001136c2, 0x89);\n+\ttegra_hdmi_writel(hdmi, 0x00000730, 0x8a);\n+\ttegra_hdmi_writel(hdmi, 0x0001875b, 0x8c);\n+\ttegra_hdmi_writel(hdmi, 0x00000000, 0x9d);\n+\n+\ttegra_hdmi_writel(hdmi, 0x40090038, HDMI_NV_PDISP_HDMI_CTRL);\n+\ttegra_hdmi_writel(hdmi, 0x0, HDMI_NV_PDISP_HDMI_GENERIC_CTRL);\n+\n+\t/* TMDS CONFIG */\n+\tpll0 = 0x200033f;\n+\tpll1 = 0;\n+\n+\tpll0 &= ~SOR_PLL_PWR & ~SOR_PLL_VCOPD & ~SOR_PLL_PDBG & ~SOR_PLL_PDPORT & ~SOR_PLL_PULLDOWN &\n+\t\t~SOR_PLL_VCOCAP(~0) & ~SOR_PLL_ICHPMP(~0);\n+\tpll0 |= SOR_PLL_RESISTORSEL;\n+\n+\tif (dc->mode.pclk <= 27000000)\n+\t\tpll0 |= SOR_PLL_VCOCAP(0);\n+\telse if (dc->mode.pclk <= 74250000)\n+\t\tpll0 |= SOR_PLL_VCOCAP(1);\n+\telse\n+\t\tpll0 |= SOR_PLL_VCOCAP(3);\n+\n+\tif (dc->mode.h_active == 1080) {\n+\t\tpll0 |= SOR_PLL_ICHPMP(1) | SOR_PLL_TX_REG_LOAD(3) |\n+\t\t\tSOR_PLL_TX_REG_LOAD(3) | SOR_PLL_BG_V17_S(3);\n+\t\tpll1 |= SOR_PLL_TMDS_TERM_ENABLE | SOR_PLL_PE_EN;\n+\t} else {\n+\t\tpll0 |= SOR_PLL_ICHPMP(2);\n+\t}\n+\n+\ttegra_hdmi_writel(hdmi, pll0, HDMI_NV_PDISP_SOR_PLL0);\n+\ttegra_hdmi_writel(hdmi, pll1, HDMI_NV_PDISP_SOR_PLL1);\n+\n+\tif (pll1 & SOR_PLL_PE_EN) {\n+\t\ttegra_hdmi_writel(hdmi,\n+\t\t\t\t  PE_CURRENT0(0xf) |\n+\t\t\t\t  PE_CURRENT1(0xf) |\n+\t\t\t\t  PE_CURRENT2(0xf) |\n+\t\t\t\t  PE_CURRENT3(0xf),\n+\t\t\t\t  HDMI_NV_PDISP_PE_CURRENT);\n+\t}\n+\n+\t/* enable SOR */\n+\tif (dc->mode.h_active == 1080)\n+\t\tds = DRIVE_CURRENT_13_500_mA;\n+\telse\n+\t\tds = DRIVE_CURRENT_5_250_mA;\n+\n+\ttegra_hdmi_writel(hdmi,\n+\t\t\t  DRIVE_CURRENT_LANE0(ds) |\n+\t\t\t  DRIVE_CURRENT_LANE1(ds) |\n+\t\t\t  DRIVE_CURRENT_LANE2(ds) |\n+\t\t\t  DRIVE_CURRENT_LANE3(ds) |\n+\t\t\t  DRIVE_CURRENT_FUSE_OVERRIDE,\n+\t\t\t  HDMI_NV_PDISP_SOR_LANE_DRIVE_CURRENT);\n+\n+\ttegra_hdmi_writel(hdmi,\n+\t\t\t  SOR_SEQ_CTL_PU_PC(0) |\n+\t\t\t  SOR_SEQ_PU_PC_ALT(0) |\n+\t\t\t  SOR_SEQ_PD_PC(8) |\n+\t\t\t  SOR_SEQ_PD_PC_ALT(8),\n+\t\t\t  HDMI_NV_PDISP_SOR_SEQ_CTL);\n+\n+\tval = SOR_SEQ_INST_WAIT_TIME(1) |\n+\t\tSOR_SEQ_INST_WAIT_UNITS_VSYNC |\n+\t\tSOR_SEQ_INST_HALT |\n+\t\tSOR_SEQ_INST_PIN_A_LOW |\n+\t\tSOR_SEQ_INST_PIN_B_LOW |\n+\t\tSOR_SEQ_INST_DRIVE_PWM_OUT_LO;\n+\n+\ttegra_hdmi_writel(hdmi, val, HDMI_NV_PDISP_SOR_SEQ_INST0);\n+\ttegra_hdmi_writel(hdmi, val, HDMI_NV_PDISP_SOR_SEQ_INST8);\n+\n+\tval = 0x1c800;\n+\tval &= ~SOR_CSTM_ROTCLK(~0);\n+\tval |= SOR_CSTM_ROTCLK(2);\n+\ttegra_hdmi_writel(hdmi, val, HDMI_NV_PDISP_SOR_CSTM);\n+\n+\n+\ttegra_dc_writel(dc, DISP_CTRL_MODE_STOP, DC_CMD_DISPLAY_COMMAND);\n+\ttegra_dc_writel(dc, GENERAL_ACT_REQ << 8, DC_CMD_STATE_CONTROL);\n+\ttegra_dc_writel(dc, GENERAL_ACT_REQ, DC_CMD_STATE_CONTROL);\n+\n+\n+\t/* start SOR */\n+\ttegra_hdmi_writel(hdmi,\n+\t\t\t  SOR_PWR_NORMAL_STATE_PU |\n+\t\t\t  SOR_PWR_NORMAL_START_NORMAL |\n+\t\t\t  SOR_PWR_SAFE_STATE_PD |\n+\t\t\t  SOR_PWR_SETTING_NEW_TRIGGER,\n+\t\t\t  HDMI_NV_PDISP_SOR_PWR);\n+\ttegra_hdmi_writel(hdmi,\n+\t\t\t  SOR_PWR_NORMAL_STATE_PU |\n+\t\t\t  SOR_PWR_NORMAL_START_NORMAL |\n+\t\t\t  SOR_PWR_SAFE_STATE_PD |\n+\t\t\t  SOR_PWR_SETTING_NEW_DONE,\n+\t\t\t  HDMI_NV_PDISP_SOR_PWR);\n+\n+\tretries = 1000;\n+\tdo {\n+\t\tBUG_ON(--retries < 0);\n+\t\tval = tegra_hdmi_readl(hdmi, HDMI_NV_PDISP_SOR_PWR);\n+\t} while (val & SOR_PWR_SETTING_NEW_PENDING);\n+\n+\ttegra_hdmi_writel(hdmi,\n+\t\t\t  SOR_STATE_ASY_CRCMODE_COMPLETE |\n+\t\t\t  SOR_STATE_ASY_OWNER_HEAD0 |\n+\t\t\t  SOR_STATE_ASY_SUBOWNER_BOTH |\n+\t\t\t  SOR_STATE_ASY_PROTOCOL_SINGLE_TMDS_A |\n+\t\t\t  /* TODO: to look at hsync polarity */\n+\t\t\t  SOR_STATE_ASY_HSYNCPOL_POS |\n+\t\t\t  SOR_STATE_ASY_VSYNCPOL_POS |\n+\t\t\t  SOR_STATE_ASY_DEPOL_POS,\n+\t\t\t  HDMI_NV_PDISP_SOR_STATE2);\n+\n+\tval = SOR_STATE_ASY_HEAD_OPMODE_AWAKE | SOR_STATE_ASY_ORMODE_NORMAL;\n+\ttegra_hdmi_writel(hdmi, val, HDMI_NV_PDISP_SOR_STATE1);\n+\n+\ttegra_hdmi_writel(hdmi, 0, HDMI_NV_PDISP_SOR_STATE0);\n+\ttegra_hdmi_writel(hdmi, SOR_STATE_UPDATE, HDMI_NV_PDISP_SOR_STATE0);\n+\ttegra_hdmi_writel(hdmi, val | SOR_STATE_ATTACHED,\n+\t\t\t  HDMI_NV_PDISP_SOR_STATE1);\n+\ttegra_hdmi_writel(hdmi, 0, HDMI_NV_PDISP_SOR_STATE0);\n+\n+\ttegra_dc_writel(dc, HDMI_ENABLE, DC_DISP_DISP_WIN_OPTIONS);\n+\n+\ttegra_dc_writel(dc, PW0_ENABLE | PW1_ENABLE | PW2_ENABLE | PW3_ENABLE |\n+\t\t\tPW4_ENABLE | PM0_ENABLE | PM1_ENABLE,\n+\t\t\tDC_CMD_DISPLAY_POWER_CONTROL);\n+\n+\ttegra_dc_writel(dc, DISP_CTRL_MODE_C_DISPLAY, DC_CMD_DISPLAY_COMMAND);\n+\ttegra_dc_writel(dc, GENERAL_ACT_REQ << 8, DC_CMD_STATE_CONTROL);\n+\ttegra_dc_writel(dc, GENERAL_ACT_REQ, DC_CMD_STATE_CONTROL);\n+}\n+\n+static void tegra_dc_hdmi_disable(struct tegra_dc *dc)\n+{\n+\tstruct tegra_dc_hdmi_data *hdmi = tegra_dc_get_outdata(dc);\n+\n+\ttegra_periph_reset_assert(hdmi->clk);\n+\tclk_disable(hdmi->clk);\n+}\n+struct tegra_dc_out_ops tegra_dc_hdmi_ops = {\n+\t.init = tegra_dc_hdmi_init,\n+\t.destroy = tegra_dc_hdmi_destroy,\n+\t.enable = tegra_dc_hdmi_enable,\n+\t.disable = tegra_dc_hdmi_disable,\n+\t.detect = tegra_dc_hdmi_detect,\n+};\n+\n"", ""hdmi_reg.h"": ""@@ -0,0 +1,378 @@\n+/*\n+ * drivers/video/tegra/dc/hdmi_reg.h\n+ *\n+ * Copyright (C) 2010 Google, Inc.\n+ * Author: Erik Gilling <konkers@android.com>\n+ *\n+ * This software is licensed under the terms of the GNU General Public\n+ * License version 2, as published by the Free Software Foundation, and\n+ * may be copied, distributed, and modified under those terms.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ */\n+\n+#ifndef __DRIVERS_VIDEO_TEGRA_DC_HDMI_REG_H\n+#define __DRIVERS_VIDEO_TEGRA_DC_HDMI_REG_H\n+\n+#define HDMI_CTXSW\t\t\t\t\t\t0x00\n+#define HDMI_NV_PDISP_SOR_STATE0\t\t\t\t0x01\n+#define  SOR_STATE_UPDATE\t\t\t(1 << 0)\n+\n+#define HDMI_NV_PDISP_SOR_STATE1\t\t\t\t0x02\n+#define  SOR_STATE_ASY_HEAD_OPMODE_SLEEP\t(0 << 0)\n+#define  SOR_STATE_ASY_HEAD_OPMODE_SNOOSE\t(1 << 0)\n+#define  SOR_STATE_ASY_HEAD_OPMODE_AWAKE\t(2 << 0)\n+#define  SOR_STATE_ASY_ORMODE_SAFE\t\t(0 << 2)\n+#define  SOR_STATE_ASY_ORMODE_NORMAL\t\t(1 << 2)\n+#define  SOR_STATE_ATTACHED\t\t\t(1 << 3)\n+#define  SOR_STATE_ARM_SHOW_VGA\t\t\t(1 << 4)\n+\n+#define HDMI_NV_PDISP_SOR_STATE2\t\t\t\t0x03\n+#define  SOR_STATE_ASY_OWNER_NONE\t\t(0 << 0)\n+#define  SOR_STATE_ASY_OWNER_HEAD0\t\t(1 << 0)\n+#define  SOR_STATE_ASY_SUBOWNER_NONE\t\t(0 << 4)\n+#define  SOR_STATE_ASY_SUBOWNER_SUBHEAD0\t(1 << 4)\n+#define  SOR_STATE_ASY_SUBOWNER_SUBHEAD1\t(2 << 4)\n+#define  SOR_STATE_ASY_SUBOWNER_BOTH\t\t(3 << 4)\n+#define  SOR_STATE_ASY_CRCMODE_ACTIVE\t\t(0 << 6)\n+#define  SOR_STATE_ASY_CRCMODE_COMPLETE\t\t(1 << 6)\n+#define  SOR_STATE_ASY_CRCMODE_NON_ACTIVE\t(2 << 6)\n+#define  SOR_STATE_ASY_PROTOCOL_SINGLE_TMDS_A\t(1 << 8)\n+#define  SOR_STATE_ASY_PROTOCOL_CUSTOM\t\t(15 << 8)\n+#define  SOR_STATE_ASY_HSYNCPOL_POS\t\t(0 << 12)\n+#define  SOR_STATE_ASY_HSYNCPOL_NEG\t\t(1 << 12)\n+#define  SOR_STATE_ASY_VSYNCPOL_POS\t\t(0 << 13)\n+#define  SOR_STATE_ASY_VSYNCPOL_NEG\t\t(1 << 13)\n+#define  SOR_STATE_ASY_DEPOL_POS\t\t(0 << 14)\n+#define  SOR_STATE_ASY_DEPOL_NEG\t\t(1 << 14)\n+\n+#define HDMI_NV_PDISP_RG_HDCP_AN_MSB\t\t\t\t0x04\n+#define HDMI_NV_PDISP_RG_HDCP_AN_LSB\t\t\t\t0x05\n+#define HDMI_NV_PDISP_RG_HDCP_CN_MSB\t\t\t\t0x06\n+#define HDMI_NV_PDISP_RG_HDCP_CN_LSB\t\t\t\t0x07\n+#define HDMI_NV_PDISP_RG_HDCP_AKSV_MSB\t\t\t\t0x08\n+#define HDMI_NV_PDISP_RG_HDCP_AKSV_LSB\t\t\t\t0x09\n+#define HDMI_NV_PDISP_RG_HDCP_BKSV_MSB\t\t\t\t0x0a\n+#define HDMI_NV_PDISP_RG_HDCP_BKSV_LSB\t\t\t\t0x0b\n+#define HDMI_NV_PDISP_RG_HDCP_CKSV_MSB\t\t\t\t0x0c\n+#define HDMI_NV_PDISP_RG_HDCP_CKSV_LSB\t\t\t\t0x0d\n+#define HDMI_NV_PDISP_RG_HDCP_DKSV_MSB\t\t\t\t0x0e\n+#define HDMI_NV_PDISP_RG_HDCP_DKSV_LSB\t\t\t\t0x0f\n+#define HDMI_NV_PDISP_RG_HDCP_CTRL\t\t\t\t0x10\n+#define HDMI_NV_PDISP_RG_HDCP_CMODE\t\t\t\t0x11\n+#define HDMI_NV_PDISP_RG_HDCP_MPRIME_MSB\t\t\t0x12\n+#define HDMI_NV_PDISP_RG_HDCP_MPRIME_LSB\t\t\t0x13\n+#define HDMI_NV_PDISP_RG_HDCP_SPRIME_MSB\t\t\t0x14\n+#define HDMI_NV_PDISP_RG_HDCP_SPRIME_LSB2\t\t\t0x15\n+#define HDMI_NV_PDISP_RG_HDCP_SPRIME_LSB1\t\t\t0x16\n+#define HDMI_NV_PDISP_RG_HDCP_RI\t\t\t\t0x17\n+#define HDMI_NV_PDISP_RG_HDCP_CS_MSB\t\t\t\t0x18\n+#define HDMI_NV_PDISP_RG_HDCP_CS_LSB\t\t\t\t0x19\n+#define HDMI_NV_PDISP_HDMI_AUDIO_EMU0\t\t\t\t0x1a\n+#define HDMI_NV_PDISP_HDMI_AUDIO_EMU_RDATA0\t\t\t0x1b\n+#define HDMI_NV_PDISP_HDMI_AUDIO_EMU1\t\t\t\t0x1c\n+#define HDMI_NV_PDISP_HDMI_AUDIO_EMU2\t\t\t\t0x1d\n+#define HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_CTRL\t\t\t0x1e\n+#define HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_STATUS\t\t0x1f\n+#define HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_HEADER\t\t0x20\n+#define HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_SUBPACK0_LOW\t\t0x21\n+#define HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_SUBPACK0_HIGH\t0x22\n+#define HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_CTRL\t\t\t0x23\n+#define HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_STATUS\t\t\t0x24\n+#define HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_HEADER\t\t\t0x25\n+#define HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_SUBPACK0_LOW\t\t0x26\n+#define HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_SUBPACK0_HIGH\t\t0x27\n+#define HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_SUBPACK1_LOW\t\t0x28\n+#define HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_SUBPACK1_HIGH\t\t0x29\n+#define HDMI_NV_PDISP_HDMI_GENERIC_CTRL\t\t\t\t0x2a\n+#define HDMI_NV_PDISP_HDMI_GENERIC_STATUS\t\t\t0x2b\n+#define HDMI_NV_PDISP_HDMI_GENERIC_HEADER\t\t\t0x2c\n+#define HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK0_LOW\t\t\t0x2d\n+#define HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK0_HIGH\t\t0x2e\n+#define HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK1_LOW\t\t\t0x2f\n+#define HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK1_HIGH\t\t0x30\n+#define HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK2_LOW\t\t\t0x31\n+#define HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK2_HIGH\t\t0x32\n+#define HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK3_LOW\t\t\t0x33\n+#define HDMI_NV_PDISP_HDMI_GENERIC_SUBPACK3_HIGH\t\t0x34\n+#define HDMI_NV_PDISP_HDMI_ACR_CTRL\t\t\t\t0x35\n+#define HDMI_NV_PDISP_HDMI_ACR_0320_SUBPACK_LOW\t\t\t0x36\n+#define HDMI_NV_PDISP_HDMI_ACR_0320_SUBPACK_HIGH\t\t0x37\n+#define HDMI_NV_PDISP_HDMI_ACR_0441_SUBPACK_LOW\t\t\t0x38\n+#define HDMI_NV_PDISP_HDMI_ACR_0441_SUBPACK_HIGH\t\t0x39\n+#define HDMI_NV_PDISP_HDMI_ACR_0882_SUBPACK_LOW\t\t\t0x3a\n+#define HDMI_NV_PDISP_HDMI_ACR_0882_SUBPACK_HIGH\t\t0x3b\n+#define HDMI_NV_PDISP_HDMI_ACR_1764_SUBPACK_LOW\t\t\t0x3c\n+#define HDMI_NV_PDISP_HDMI_ACR_1764_SUBPACK_HIGH\t\t0x3d\n+#define HDMI_NV_PDISP_HDMI_ACR_0480_SUBPACK_LOW\t\t\t0x3e\n+#define HDMI_NV_PDISP_HDMI_ACR_0480_SUBPACK_HIGH\t\t0x3f\n+#define HDMI_NV_PDISP_HDMI_ACR_0960_SUBPACK_LOW\t\t\t0x40\n+#define HDMI_NV_PDISP_HDMI_ACR_0960_SUBPACK_HIGH\t\t0x41\n+#define HDMI_NV_PDISP_HDMI_ACR_1920_SUBPACK_LOW\t\t\t0x42\n+#define HDMI_NV_PDISP_HDMI_ACR_1920_SUBPACK_HIGH\t\t0x43\n+#define HDMI_NV_PDISP_HDMI_CTRL\t\t\t\t\t0x44\n+#define  HDMI_CTRL_REKEY(x)\t\t\t(((x) & 0x7f) << 0)\n+#define  HDMI_CTRL_AUDIO_LAYOUT\t\t\t(1 << 8)\n+#define  HDMI_CTRL_SAMPLE_FLAT\t\t\t(1 << 12)\n+#define  HDMI_CTRL_MAX_AC_PACKET(x)\t\t(((x) & 0x1f) << 16)\n+#define  HDMI_CTRL_ENABLE\t\t\t(1 << 30)\n+\n+#define HDMI_NV_PDISP_HDMI_VSYNC_KEEPOUT\t\t\t0x45\n+#define HDMI_NV_PDISP_HDMI_VSYNC_WINDOW\t\t\t\t0x46\n+#define  VSYNC_WINDOW_END(x)\t\t\t(((x) & 0x3ff) << 0)\n+#define  VSYNC_WINDOW_START(x)\t\t\t(((x) & 0x3ff) << 16)\n+#define  VSYNC_WINDOW_ENABLE\t\t\t(1 << 31)\n+\n+#define HDMI_NV_PDISP_HDMI_GCP_CTRL\t\t\t\t0x47\n+#define HDMI_NV_PDISP_HDMI_GCP_STATUS\t\t\t\t0x48\n+#define HDMI_NV_PDISP_HDMI_GCP_SUBPACK\t\t\t\t0x49\n+#define HDMI_NV_PDISP_HDMI_CHANNEL_STATUS1\t\t\t0x4a\n+#define HDMI_NV_PDISP_HDMI_CHANNEL_STATUS2\t\t\t0x4b\n+#define HDMI_NV_PDISP_HDMI_EMU0\t\t\t\t\t0x4c\n+#define HDMI_NV_PDISP_HDMI_EMU1\t\t\t\t\t0x4d\n+#define HDMI_NV_PDISP_HDMI_EMU1_RDATA\t\t\t\t0x4e\n+#define HDMI_NV_PDISP_HDMI_SPARE\t\t\t\t0x4f\n+#define HDMI_NV_PDISP_HDMI_SPDIF_CHN_STATUS1\t\t\t0x50\n+#define HDMI_NV_PDISP_HDMI_SPDIF_CHN_STATUS2\t\t\t0x51\n+#define HDMI_NV_PDISP_HDCPRIF_ROM_CTRL\t\t\t\t0x53\n+#define HDMI_NV_PDISP_SOR_CAP\t\t\t\t\t0x54\n+#define HDMI_NV_PDISP_SOR_PWR\t\t\t\t\t0x55\n+#define  SOR_PWR_NORMAL_STATE_PD\t\t(0 << 0)\n+#define  SOR_PWR_NORMAL_STATE_PU\t\t(1 << 0)\n+#define  SOR_PWR_NORMAL_START_NORMAL\t\t(0 << 1)\n+#define  SOR_PWR_NORMAL_START_ALT\t\t(1 << 1)\n+#define  SOR_PWR_SAFE_STATE_PD\t\t\t(0 << 16)\n+#define  SOR_PWR_SAFE_STATE_PU\t\t\t(1 << 16)\n+#define  SOR_PWR_SAFE_START_NORMAL\t\t(0 << 17)\n+#define  SOR_PWR_SAFE_START_ALT\t\t\t(1 << 17)\n+#define  SOR_PWR_HALT_DELAY\t\t\t(1 << 24)\n+#define  SOR_PWR_MODE\t\t\t\t(1 << 28)\n+#define  SOR_PWR_SETTING_NEW_DONE\t\t(0 << 31)\n+#define  SOR_PWR_SETTING_NEW_PENDING\t\t(1 << 31)\n+#define  SOR_PWR_SETTING_NEW_TRIGGER\t\t(1 << 31)\n+\n+#define HDMI_NV_PDISP_SOR_TEST\t\t\t\t\t0x56\n+#define HDMI_NV_PDISP_SOR_PLL0\t\t\t\t\t0x57\n+#define  SOR_PLL_PWR\t\t\t\t(1 << 0)\n+#define  SOR_PLL_PDBG\t\t\t\t(1 << 1)\n+#define  SOR_PLL_VCOPD\t\t\t\t(1 << 2)\n+#define  SOR_PLL_PDPORT\t\t\t\t(1 << 3)\n+#define  SOR_PLL_RESISTORSEL\t\t\t(1 << 4)\n+#define  SOR_PLL_PULLDOWN\t\t\t(1 << 5)\n+#define  SOR_PLL_VCOCAP(x)\t\t\t(((x) & 0xf) << 8)\n+#define  SOR_PLL_BG_V17_S(x)\t\t\t(((x) & 0xf) << 12)\n+#define  SOR_PLL_FILTER(x)\t\t\t(((x) & 0xf) << 16)\n+#define  SOR_PLL_ICHPMP(x)\t\t\t(((x) & 0xf) << 24)\n+#define  SOR_PLL_TX_REG_LOAD(x)\t\t\t(((x) & 0x3) << 28)\n+\n+#define HDMI_NV_PDISP_SOR_PLL1\t\t\t\t\t0x58\n+#define  SOR_PLL_TMDS_TERM_ENABLE\t\t(1 << 8)\n+#define  SOR_PLL_TMDS_TERMADJ(x)\t\t(((x) & 0xf) << 9)\n+#define  SOR_PLL_LOADADJ(x)\t\t\t(((x) & 0xf) << 20)\n+#define  SOR_PLL_PE_EN\t\t\t\t(1 << 28)\n+#define  SOR_PLL_HALF_FULL_PE\t\t\t(1 << 29)\n+#define  SOR_PLL_S_D_PIN_PE\t\t\t(1 << 30)\n+\n+#define HDMI_NV_PDISP_SOR_PLL2\t\t\t\t\t0x59\n+#define HDMI_NV_PDISP_SOR_CSTM\t\t\t\t\t0x5a\n+#define  SOR_CSTM_PD_TXDA_0\t\t\t(1 << 0)\n+#define  SOR_CSTM_PD_TXDA_1\t\t\t(1 << 1)\n+#define  SOR_CSTM_PD_TXDA_2\t\t\t(1 << 2)\n+#define  SOR_CSTM_PD_TXDA_3\t\t\t(1 << 3)\n+#define  SOR_CSTM_PD_TXDB_0\t\t\t(1 << 4)\n+#define  SOR_CSTM_PD_TXDB_1\t\t\t(1 << 5)\n+#define  SOR_CSTM_PD_TXDB_2\t\t\t(1 << 6)\n+#define  SOR_CSTM_PD_TXDB_3\t\t\t(1 << 7)\n+#define  SOR_CSTM_PD_TXCA\t\t\t(1 << 8)\n+#define  SOR_CSTM_PD_TXCB\t\t\t(1 << 9)\n+#define  SOR_CSTM_UPPER\t\t\t\t(1 << 11)\n+#define  SOR_CSTM_MODE(x)\t\t\t(((x) & 0x3) << 12)\n+#define  SOR_CSTM_LINKACTA\t\t\t(1 << 14)\n+#define  SOR_CSTM_LINKACTB\t\t\t(1 << 15)\n+#define  SOR_CSTM_LVDS_EN\t\t\t(1 << 16)\n+#define  SOR_CSTM_DUP_SYNC\t\t\t(1 << 17)\n+#define  SOR_CSTM_NEW_MODE\t\t\t(1 << 18)\n+#define  SOR_CSTM_BALANCED\t\t\t(1 << 19)\n+#define  SOR_CSTM_PLLDIV\t\t\t(1 << 21)\n+#define  SOR_CSTM_ROTCLK(x)\t\t\t(((x) & 0xf) << 24)\n+#define  SOR_CSTM_ROTDAT(x)\t\t\t(((x) & 0x7) << 28)\n+\n+#define HDMI_NV_PDISP_SOR_LVDS\t\t\t\t\t0x5b\n+#define HDMI_NV_PDISP_SOR_CRCA\t\t\t\t\t0x5c\n+#define HDMI_NV_PDISP_SOR_CRCB\t\t\t\t\t0x5d\n+#define HDMI_NV_PDISP_SOR_BLANK\t\t\t\t\t0x5e\n+#define HDMI_NV_PDISP_SOR_SEQ_CTL\t\t\t\t0x5f\n+#define  SOR_SEQ_CTL_PU_PC(x)\t\t\t(((x) & 0xf) << 0)\n+#define  SOR_SEQ_PU_PC_ALT(x)\t\t\t(((x) & 0xf) << 4)\n+#define  SOR_SEQ_PD_PC(x)\t\t\t(((x) & 0xf) << 8)\n+#define  SOR_SEQ_PD_PC_ALT(x)\t\t\t(((x) & 0xf) << 12)\n+#define  SOR_SEQ_PC(x)\t\t\t\t(((x) & 0xf) << 16)\n+#define  SOR_SEQ_STATUS\t\t\t\t(1 << 28)\n+#define  SOR_SEQ_SWITCH\t\t\t\t(1 << 30)\n+\n+#define HDMI_NV_PDISP_SOR_SEQ_INST0\t\t\t\t0x60\n+#define HDMI_NV_PDISP_SOR_SEQ_INST1\t\t\t\t0x61\n+#define HDMI_NV_PDISP_SOR_SEQ_INST2\t\t\t\t0x62\n+#define HDMI_NV_PDISP_SOR_SEQ_INST3\t\t\t\t0x63\n+#define HDMI_NV_PDISP_SOR_SEQ_INST4\t\t\t\t0x64\n+#define HDMI_NV_PDISP_SOR_SEQ_INST5\t\t\t\t0x65\n+#define HDMI_NV_PDISP_SOR_SEQ_INST6\t\t\t\t0x66\n+#define HDMI_NV_PDISP_SOR_SEQ_INST7\t\t\t\t0x67\n+#define HDMI_NV_PDISP_SOR_SEQ_INST8\t\t\t\t0x68\n+#define HDMI_NV_PDISP_SOR_SEQ_INST9\t\t\t\t0x69\n+#define HDMI_NV_PDISP_SOR_SEQ_INSTA\t\t\t\t0x6a\n+#define HDMI_NV_PDISP_SOR_SEQ_INSTB\t\t\t\t0x6b\n+#define HDMI_NV_PDISP_SOR_SEQ_INSTC\t\t\t\t0x6c\n+#define HDMI_NV_PDISP_SOR_SEQ_INSTD\t\t\t\t0x6d\n+#define HDMI_NV_PDISP_SOR_SEQ_INSTE\t\t\t\t0x6e\n+#define HDMI_NV_PDISP_SOR_SEQ_INSTF\t\t\t\t0x6f\n+#define  SOR_SEQ_INST_WAIT_TIME(x)\t\t(((x) & 0x3ff) << 0)\n+#define  SOR_SEQ_INST_WAIT_UNITS_US\t\t(0 << 12)\n+#define  SOR_SEQ_INST_WAIT_UNITS_MS\t\t(1 << 12)\n+#define  SOR_SEQ_INST_WAIT_UNITS_VSYNC\t\t(2 << 12)\n+#define  SOR_SEQ_INST_HALT\t\t\t(1 << 15)\n+#define  SOR_SEQ_INST_PIN_A_LOW\t\t\t(0 << 21)\n+#define  SOR_SEQ_INST_PIN_A_HIGH\t\t(1 << 21)\n+#define  SOR_SEQ_INST_PIN_B_LOW\t\t\t(0 << 22)\n+#define  SOR_SEQ_INST_PIN_B_HIGH\t\t(1 << 22)\n+#define  SOR_SEQ_INST_DRIVE_PWM_OUT_LO\t\t(1 << 23)\n+#define  SOR_SEQ_INST_TRISTATE_IOS\t\t(1 << 24)\n+#define  SOR_SEQ_INST_SOR_SEQ_INST_BLACK_DATA\t(1 << 25)\n+#define  SOR_SEQ_INST_BLANK_DE\t\t\t(1 << 26)\n+#define  SOR_SEQ_INST_BLANK_H\t\t\t(1 << 27)\n+#define  SOR_SEQ_INST_BLANK_V\t\t\t(1 << 28)\n+#define  SOR_SEQ_INST_ASSERT_PLL_RESETV\t\t(1 << 29)\n+#define  SOR_SEQ_INST_POWERDOWN_MACRO\t\t(1 << 30)\n+#define  SOR_SEQ_INST_PLL_PULLDOWN\t\t(1 << 31)\n+\n+#define HDMI_NV_PDISP_SOR_VCRCA0\t\t\t\t0x72\n+#define HDMI_NV_PDISP_SOR_VCRCA1\t\t\t\t0x73\n+#define HDMI_NV_PDISP_SOR_CCRCA0\t\t\t\t0x74\n+#define HDMI_NV_PDISP_SOR_CCRCA1\t\t\t\t0x75\n+#define HDMI_NV_PDISP_SOR_EDATAA0\t\t\t\t0x76\n+#define HDMI_NV_PDISP_SOR_EDATAA1\t\t\t\t0x77\n+#define HDMI_NV_PDISP_SOR_COUNTA0\t\t\t\t0x78\n+#define HDMI_NV_PDISP_SOR_COUNTA1\t\t\t\t0x79\n+#define HDMI_NV_PDISP_SOR_DEBUGA0\t\t\t\t0x7a\n+#define HDMI_NV_PDISP_SOR_DEBUGA1\t\t\t\t0x7b\n+#define HDMI_NV_PDISP_SOR_TRIG\t\t\t\t\t0x7c\n+#define HDMI_NV_PDISP_SOR_MSCHECK\t\t\t\t0x7d\n+#define HDMI_NV_PDISP_SOR_LANE_DRIVE_CURRENT\t\t\t0x7e\n+#define  DRIVE_CURRENT_LANE0(x)\t\t\t(((x) & 0x3f) << 0)\n+#define  DRIVE_CURRENT_LANE1(x)\t\t\t(((x) & 0x3f) << 8)\n+#define  DRIVE_CURRENT_LANE2(x)\t\t\t(((x) & 0x3f) << 16)\n+#define  DRIVE_CURRENT_LANE3(x)\t\t\t(((x) & 0x3f) << 24)\n+#define  DRIVE_CURRENT_FUSE_OVERRIDE\t\t(1 << 31)\n+#define  DRIVE_CURRENT_1_500_mA\t\t\t0x00\n+#define  DRIVE_CURRENT_1_875_mA\t\t\t0x01\n+#define  DRIVE_CURRENT_2_250_mA\t\t\t0x02\n+#define  DRIVE_CURRENT_2_625_mA\t\t\t0x03\n+#define  DRIVE_CURRENT_3_000_mA\t\t\t0x04\n+#define  DRIVE_CURRENT_3_375_mA\t\t\t0x05\n+#define  DRIVE_CURRENT_3_750_mA\t\t\t0x06\n+#define  DRIVE_CURRENT_4_125_mA\t\t\t0x07\n+#define  DRIVE_CURRENT_4_500_mA\t\t\t0x08\n+#define  DRIVE_CURRENT_4_875_mA\t\t\t0x09\n+#define  DRIVE_CURRENT_5_250_mA\t\t\t0x0a\n+#define  DRIVE_CURRENT_5_625_mA\t\t\t0x0b\n+#define  DRIVE_CURRENT_6_000_mA\t\t\t0x0c\n+#define  DRIVE_CURRENT_6_375_mA\t\t\t0x0d\n+#define  DRIVE_CURRENT_6_750_mA\t\t\t0x0e\n+#define  DRIVE_CURRENT_7_125_mA\t\t\t0x0f\n+#define  DRIVE_CURRENT_7_500_mA\t\t\t0x10\n+#define  DRIVE_CURRENT_7_875_mA\t\t\t0x11\n+#define  DRIVE_CURRENT_8_250_mA\t\t\t0x12\n+#define  DRIVE_CURRENT_8_625_mA\t\t\t0x13\n+#define  DRIVE_CURRENT_9_000_mA\t\t\t0x14\n+#define  DRIVE_CURRENT_9_375_mA\t\t\t0x15\n+#define  DRIVE_CURRENT_9_750_mA\t\t\t0x16\n+#define  DRIVE_CURRENT_10_125_mA\t\t0x17\n+#define  DRIVE_CURRENT_10_500_mA\t\t0x18\n+#define  DRIVE_CURRENT_10_875_mA\t\t0x19\n+#define  DRIVE_CURRENT_11_250_mA\t\t0x1a\n+#define  DRIVE_CURRENT_11_625_mA\t\t0x1b\n+#define  DRIVE_CURRENT_12_000_mA\t\t0x1c\n+#define  DRIVE_CURRENT_12_375_mA\t\t0x1d\n+#define  DRIVE_CURRENT_12_750_mA\t\t0x1e\n+#define  DRIVE_CURRENT_13_125_mA\t\t0x1f\n+#define  DRIVE_CURRENT_13_500_mA\t\t0x20\n+#define  DRIVE_CURRENT_13_875_mA\t\t0x21\n+#define  DRIVE_CURRENT_14_250_mA\t\t0x22\n+#define  DRIVE_CURRENT_14_625_mA\t\t0x23\n+#define  DRIVE_CURRENT_15_000_mA\t\t0x24\n+#define  DRIVE_CURRENT_15_375_mA\t\t0x25\n+#define  DRIVE_CURRENT_15_750_mA\t\t0x26\n+#define  DRIVE_CURRENT_16_125_mA\t\t0x27\n+#define  DRIVE_CURRENT_16_500_mA\t\t0x28\n+#define  DRIVE_CURRENT_16_875_mA\t\t0x29\n+#define  DRIVE_CURRENT_17_250_mA\t\t0x2a\n+#define  DRIVE_CURRENT_17_625_mA\t\t0x2b\n+#define  DRIVE_CURRENT_18_000_mA\t\t0x2c\n+#define  DRIVE_CURRENT_18_375_mA\t\t0x2d\n+#define  DRIVE_CURRENT_18_750_mA\t\t0x2e\n+#define  DRIVE_CURRENT_19_125_mA\t\t0x2f\n+#define  DRIVE_CURRENT_19_500_mA\t\t0x30\n+#define  DRIVE_CURRENT_19_875_mA\t\t0x31\n+#define  DRIVE_CURRENT_20_250_mA\t\t0x32\n+#define  DRIVE_CURRENT_20_625_mA\t\t0x33\n+#define  DRIVE_CURRENT_21_000_mA\t\t0x34\n+#define  DRIVE_CURRENT_21_375_mA\t\t0x35\n+#define  DRIVE_CURRENT_21_750_mA\t\t0x36\n+#define  DRIVE_CURRENT_22_125_mA\t\t0x37\n+#define  DRIVE_CURRENT_22_500_mA\t\t0x38\n+#define  DRIVE_CURRENT_22_875_mA\t\t0x39\n+#define  DRIVE_CURRENT_23_250_mA\t\t0x3a\n+#define  DRIVE_CURRENT_23_625_mA\t\t0x3b\n+#define  DRIVE_CURRENT_24_000_mA\t\t0x3c\n+#define  DRIVE_CURRENT_24_375_mA\t\t0x3d\n+#define  DRIVE_CURRENT_24_750_mA\t\t0x3e\n+\n+#define HDMI_NV_PDISP_AUDIO_DEBUG0\t\t\t\t0x7f\n+#define HDMI_NV_PDISP_AUDIO_DEBUG1\t\t\t\t0x80\n+#define HDMI_NV_PDISP_AUDIO_DEBUG2\t\t\t\t0x81\n+#define HDMI_NV_PDISP_AUDIO_FS1\t\t\t\t\t0x82\n+#define HDMI_NV_PDISP_AUDIO_FS2\t\t\t\t\t0x83\n+#define HDMI_NV_PDISP_AUDIO_FS3\t\t\t\t\t0x84\n+#define HDMI_NV_PDISP_AUDIO_FS4\t\t\t\t\t0x85\n+#define HDMI_NV_PDISP_AUDIO_FS5\t\t\t\t\t0x86\n+#define HDMI_NV_PDISP_AUDIO_FS6\t\t\t\t\t0x87\n+#define HDMI_NV_PDISP_AUDIO_FS7\t\t\t\t\t0x88\n+#define HDMI_NV_PDISP_AUDIO_PULSE_WIDTH\t\t\t\t0x89\n+#define HDMI_NV_PDISP_AUDIO_THRESHOLD\t\t\t\t0x8a\n+#define HDMI_NV_PDISP_AUDIO_CNTRL0\t\t\t\t0x8b\n+#define HDMI_NV_PDISP_AUDIO_N\t\t\t\t\t0x8c\n+#define HDMI_NV_PDISP_HDCPRIF_ROM_TIMING\t\t\t0x94\n+#define HDMI_NV_PDISP_SOR_REFCLK\t\t\t\t0x95\n+#define  SOR_REFCLK_DIV_INT(x)\t\t\t(((x) & 0xff) << 8)\n+#define  SOR_REFCLK_DIV_FRAC(x)\t\t\t(((x) & 0x3) << 6)\n+\n+#define HDMI_NV_PDISP_CRC_CONTROL\t\t\t\t0x96\n+#define HDMI_NV_PDISP_INPUT_CONTROL\t\t\t\t0x97\n+#define  HDMI_SRC_DISPLAYA\t\t\t(0 << 0)\n+#define  HDMI_SRC_DISPLAYB\t\t\t(1 << 0)\n+#define  ARM_VIDEO_RANGE_FULL\t\t\t(0 << 1)\n+#define  ARM_VIDEO_RANGE_LIMITED\t\t(1 << 1)\n+\n+#define HDMI_NV_PDISP_SCRATCH\t\t\t\t\t0x98\n+#define HDMI_NV_PDISP_PE_CURRENT\t\t\t\t0x99\n+#define  PE_CURRENT0(x)\t\t\t\t(((x) & 0xf) << 0)\n+#define  PE_CURRENT1(x)\t\t\t\t(((x) & 0xf) << 8)\n+#define  PE_CURRENT2(x)\t\t\t\t(((x) & 0xf) << 16)\n+#define  PE_CURRENT3(x)\t\t\t\t(((x) & 0xf) << 24)\n+\n+#define HDMI_NV_PDISP_KEY_CTRL\t\t\t\t\t0x9a\n+#define HDMI_NV_PDISP_KEY_DEBUG0\t\t\t\t0x9b\n+#define HDMI_NV_PDISP_KEY_DEBUG1\t\t\t\t0x9c\n+#define HDMI_NV_PDISP_KEY_DEBUG2\t\t\t\t0x9d\n+#define HDMI_NV_PDISP_KEY_HDCP_KEY_0\t\t\t\t0x9e\n+#define HDMI_NV_PDISP_KEY_HDCP_KEY_1\t\t\t\t0x9f\n+#define HDMI_NV_PDISP_KEY_HDCP_KEY_2\t\t\t\t0xa0\n+#define HDMI_NV_PDISP_KEY_HDCP_KEY_3\t\t\t\t0xa1\n+#define HDMI_NV_PDISP_KEY_HDCP_KEY_TRIG\t\t\t\t0xa2\n+#define HDMI_NV_PDISP_KEY_SKEY_INDEX\t\t\t\t0xa3\n+\n+#endif\n""}","feature 
"
23746,Jean-Baptiste Queru,"Use https for repo, mention md5sum",['src/source/downloading.md'],"Use https for repo, mention md5sum

Change-Id: I67c2e2f14157a353e285cdf365ed5a228ab5d38e",https://android-review.googlesource.com/c/23746,"resource 
",resource,Resource;,"{""downloading.md"": ""@@ -29,9 +29,10 @@ To install, initialize, and configure Repo, follow these steps:\n \n  - Download the Repo script and ensure it is executable:\n \n-        $ curl http://android.git.kernel.org/repo > ~/bin/repo\n+        $ curl https://android.git.kernel.org/repo > ~/bin/repo\n         $ chmod a+x ~/bin/repo\n \n+ - The MD5 checksum for repo is bbf05a064c4d184550d71595a662e098\n \n ## Initializing a Repo client ##\n \n""}","feature 
"
16850,Xavier Ducrohet,Misc fix in HierarchyViewer plugin.,"['eclipse/plugins/com.android.ide.eclipse.hierarchyviewer/META-INF/MANIFEST.MF', 'eclipse/sites/external/site.xml', 'eclipse/plugins/com.android.ide.eclipse.hierarchyviewer/.classpath', 'eclipse/sites/internal/site.xml', 'eclipse/scripts/create_hierarchyviewer_symlinks.sh']","Misc fix in HierarchyViewer plugin.

- Add plug-in to the update sites
- Remove ddm(ui)lib from the plugin as it accesses the ddms plug-in

Change-Id: I524180688443e0a72443a04fc3f00300e8ddc165",https://android-review.googlesource.com/c/16850,"bug, refactor
","bug,refactor",Bug;Deprecat;,"{"".classpath"": ""@@ -4,7 +4,7 @@\n \t<classpathentry kind=\""con\"" path=\""org.eclipse.pde.core.requiredPlugins\""/>\n \t<classpathentry kind=\""src\"" path=\""src\""/>\n \t<classpathentry kind=\""lib\"" path=\""libs/hierarchyviewerlib.jar\"" sourcepath=\""/hierarchyviewerlib\""/>\n-\t<classpathentry kind=\""lib\"" path=\""libs/ddmlib.jar\"" sourcepath=\""/ddmlib\""/>\n-\t<classpathentry kind=\""lib\"" path=\""libs/ddmuilib.jar\""/>\n+\t<classpathentry combineaccessrules=\""false\"" kind=\""src\"" path=\""/ddmlib\""/>\n+\t<classpathentry combineaccessrules=\""false\"" kind=\""src\"" path=\""/ddmuilib\""/>\n \t<classpathentry kind=\""output\"" path=\""bin\""/>\n </classpath>\n"", ""MANIFEST.MF"": ""@@ -12,7 +12,5 @@ Require-Bundle: org.eclipse.ui,\n  org.eclipse.ui.console,\n  com.android.ide.eclipse.ddms\n Bundle-ClassPath: .,\n- libs/hierarchyviewerlib.jar,\n- libs/ddmlib.jar,\n- libs/ddmuilib.jar\n+ libs/hierarchyviewerlib.jar\n Export-Package: com.android.ide.eclipse.hierarchyviewer\n"", ""create_hierarchyviewer_symlinks.sh"": ""@@ -60,7 +60,7 @@ DEST=$BASE/libs\n \n mkdir -p $DEST\n \n-LIBS=\""ddmlib ddmuilib hierarchyviewerlib \""\n+LIBS=\""hierarchyviewerlib \""\n echo \""make java libs ...\""\n make -j3 showcommands $LIBS || die \""Hierarchy Viewer: Fail to build one of $LIBS.\""\n \n"", ""site.xml"": ""@@ -9,6 +9,9 @@\n    <feature url=\""features/com.android.ide.eclipse.ddms_0.9.8.qualifier.jar\"" id=\""com.android.ide.eclipse.ddms\"" version=\""0.9.8.qualifier\"">\n       <category name=\""developer\""/>\n    </feature>\n+   <feature url=\""features/com.android.ide.eclipse.hierarchyviewer_0.9.8.qualifier.jar\"" id=\""com.android.ide.eclipse.hierarchyviewer\"" version=\""0.9.8.qualifier\"">\n+      <category name=\""developer\""/>\n+   </feature>\n    <feature url=\""features/com.android.ide.eclipse.tests_0.9.8.qualifier.jar\"" id=\""com.android.ide.eclipse.tests\"" version=\""0.9.8.qualifier\"">\n       <category name=\""test\""/>\n    </feature>\n""}","feature, resource 
"
13604,Colin Cross,[ARM] tegra: nand: Rename clock to match tegra2_clocks,['drivers/mtd/devices/tegra_nand.c'],"[ARM] tegra: nand: Rename clock to match tegra2_clocks

Change-Id: I820eaf6cae15583b77d3eceafce54bb7ad42299e
Signed-off-by: Colin Cross <ccross@android.com>",https://android-review.googlesource.com/c/13604,"**bug** 
",bug,Others;,"{""tegra_nand.c"": ""@@ -1442,7 +1442,7 @@ tegra_nand_probe(struct platform_device *pdev)\n \t}\n \n \t/* TODO: configure pinmux here?? */\n-\tinfo->clk = clk_get(&pdev->dev, \""clk\"");\n+\tinfo->clk = clk_get(&pdev->dev, NULL);\n \tclk_set_rate(info->clk, 108000000);\n \n \tcfg_hwstatus_mon(info);\n""}","bug 
"
21991,RaphaÃ«l Moll,Merge 2ff496b8a14f3f2c68cd5a4d71d3f50a892b4811: 'Build SDK repository.' Do not merge.,"['build/tools/windows_sdk.mk', 'build/tools/sdk_repo.mk']","Merge 2ff496b8a14f3f2c68cd5a4d71d3f50a892b4811: 'Build SDK repository.' Do not merge.

When the build is invoked with the fake target ""sdk_repo"" and
a main target of sdk, win_sdk or sdk_addon, we now create
packages in DIST_DIR that can directly be used to populate the
SDK Repository.
This is quite close to how we actually distribute the SDK.

Change-Id: I1c4a120616697383792d7fb1b328cfcefac0b2f5",https://android-review.googlesource.com/c/21991,"feature 
",feature,Merge;Resource;,"{""sdk_repo.mk"": ""@@ -0,0 +1,106 @@\n+# Makefile to build the SDK repository packages.\n+\n+.PHONY: sdk_repo\n+\n+# Define the name of a package zip file to generate\n+# $1=OS (e.g. linux-x86, windows, etc)\n+# $2=sdk zip (e.g. out/host/linux.../android-eng-sdk.zip)\n+# $3=package to create (e.g. tools, docs, etc.)\n+#\n+define sdk-repo-pkg-zip\n+$(dir $(2))/sdk-repo-$(1)-$(3).zip\n+endef\n+\n+# Defines the rule to build an SDK repository package by zipping all\n+# the content of the given directory.\n+# E.g. given a folder out/host/linux.../sdk/android-eng-sdk/tools\n+# this generates an sdk-repo-linux-tools that contains tools/*\n+#\n+# $1=OS (e.g. linux-x86, windows, etc)\n+# $2=sdk zip (e.g. out/host/linux.../android-eng-sdk.zip)\n+# $3=package to create (e.g. tools, docs, etc.)\n+#\n+# The rule depends on the SDK zip file, which is defined by $2.\n+#\n+define mk-sdk-repo-pkg-1\n+$(call sdk-repo-pkg-zip,$(1),$(2),$(3)): $(2)\n+\t@echo \""Building SDK repository package $(3) from $(notdir $(2))\""\n+\t$(hide) cd $(dir $(2)) && \\\n+\t\t\tzip -9rq ../$(notdir $(call sdk-repo-pkg-zip,$(1),$(2),$(3))) \\\n+\t\t\t\t\t $(basename $(2))/*\n+$(call dist-for-goals, sdk_repo, $(call sdk-repo-pkg-zip,$(1),$(2),$(3)))\n+endef\n+\n+# Defines the rule to build an SDK repository package when the\n+# package directory contains a single platform-related inner directory.\n+# E.g. given a folder out/host/linux.../sdk/android-eng-sdk/samples/android-N\n+# this generates an sdk-repo-linux-samples that contains android-N/*\n+#\n+# $1=OS (e.g. linux-x86, windows, etc)\n+# $2=sdk zip (e.g. out/host/linux.../android-eng-sdk.zip)\n+# $3=package to create (e.g. platforms, samples, etc.)\n+#\n+# The rule depends on the SDK zip file, which is defined by $2.\n+#\n+define mk-sdk-repo-pkg-2\n+$(call sdk-repo-pkg-zip,$(1),$(2),$(3)): $(2)\n+\t@echo \""Building SDK repository package $(3) from $(notdir $(2))\""\n+\t$(hide) cd $(dir $(2))/$(3) && \\\n+\t\t\tzip -9rq ../../$(notdir $(call sdk-repo-pkg-zip,$(1),$(2),$(3))) \\\n+\t\t\t\t\t $(basename $(2))/*\n+$(call dist-for-goals, sdk_repo, $(call sdk-repo-pkg-zip,$(1),$(2),$(3)))\n+endef\n+\n+\n+SDK_REPO_DEPS :=\n+\n+# Rules for win_sdk\n+\n+ifneq ($(WIN_SDK_ZIP),)\n+\n+# docs, platforms and samples have nothing OS-dependent right now.\n+$(eval $(call mk-sdk-repo-pkg-1,windows,$(WIN_SDK_ZIP),tools))\n+$(eval $(call mk-sdk-repo-pkg-1,windows,$(WIN_SDK_ZIP),platform-tools))\n+\n+SDK_REPO_DEPS += \\\n+\t\t$(call sdk-repo-pkg-zip,windows,$(WIN_SDK_ZIP),tools) \\\n+        $(call sdk-repo-pkg-zip,windows,$(WIN_SDK_ZIP),platform-tools)\n+\n+endif\n+\n+# Rules for main host sdk\n+\n+ifneq ($(filter sdk win_sdk,$(MAKECMDGOALS)),)\n+\n+$(eval $(call mk-sdk-repo-pkg-1,$(HOST_OS),$(MAIN_SDK_ZIP),tools))\n+$(eval $(call mk-sdk-repo-pkg-1,$(HOST_OS),$(MAIN_SDK_ZIP),platform-tools))\n+$(eval $(call mk-sdk-repo-pkg-1,$(HOST_OS),$(MAIN_SDK_ZIP),docs))\n+$(eval $(call mk-sdk-repo-pkg-2,$(HOST_OS),$(MAIN_SDK_ZIP),platforms))\n+$(eval $(call mk-sdk-repo-pkg-2,$(HOST_OS),$(MAIN_SDK_ZIP),samples))\n+\n+SDK_REPO_DEPS += \\\n+\t\t$(call sdk-repo-pkg-zip,$(HOST_OS),$(MAIN_SDK_ZIP),tools) \\\n+\t\t$(call sdk-repo-pkg-zip,$(HOST_OS),$(MAIN_SDK_ZIP),platform-tools) \\\n+\t\t$(call sdk-repo-pkg-zip,$(HOST_OS),$(MAIN_SDK_ZIP),docs) \\\n+\t\t$(call sdk-repo-pkg-zip,$(HOST_OS),$(MAIN_SDK_ZIP),platforms) \\\n+\t\t$(call sdk-repo-pkg-zip,$(HOST_OS),$(MAIN_SDK_ZIP),samples) \\\n+\n+endif\n+\n+# Rules for sdk addon\n+\n+ifneq ($(ADDON_SDK_ZIP),)\n+\n+# ADDON_SDK_ZIP is defined in build/core/tasks/sdk-addon.sh and is\n+# already packaged correctly. All we have to do is dist it with\n+# a different destination name.\n+\n+$(call dist-for-goals, sdk_repo, \\\n+\t$(ADDON_SDK_ZIP):$(notdir $(call sdk-repo-pkg-zip,$(HOST_OS),$(ADDON_SDK_ZIP),addon)))\n+\n+endif\n+\n+\n+sdk_repo: $(SDK_REPO_DEPS)\n+\t@echo \""Packing of SDK repository done\""\n+\n"", ""windows_sdk.mk"": ""@@ -36,9 +36,9 @@ WIN_TARGETS := \\\n \t$(WIN_SDK_TARGETS)\n \n # LINUX_SDK_NAME/DIR is set in build/core/Makefile\n-WIN_SDK_NAME  := $(subst $(HOST_OS)-$(HOST_ARCH),windows,$(LINUX_SDK_NAME))\n-WIN_SDK_DIR   := $(subst $(HOST_OS)-$(HOST_ARCH),windows,$(LINUX_SDK_DIR))\n-WIN_SDK_ZIP   := $(WIN_SDK_DIR)/$(WIN_SDK_NAME).zip\n+WIN_SDK_NAME := $(subst $(HOST_OS)-$(HOST_ARCH),windows,$(MAIN_SDK_NAME))\n+WIN_SDK_DIR  := $(subst $(HOST_OS)-$(HOST_ARCH),windows,$(MAIN_SDK_DIR))\n+WIN_SDK_ZIP  := $(WIN_SDK_DIR)/$(WIN_SDK_NAME).zip\n \n $(call dist-for-goals, win_sdk, $(WIN_SDK_ZIP))\n \n@@ -51,10 +51,10 @@ $(info )\n endef\n \n define winsdk-info\n-$(info LINUX_SDK_NAME: $(LINUX_SDK_NAME))\n-$(info WIN_SDK_NAME  : $(WIN_SDK_NAME))\n-$(info WIN_SDK_DIR   : $(WIN_SDK_DIR))\n-$(info WIN_SDK_ZIP   : $(WIN_SDK_ZIP))\n+$(info MAIN_SDK_NAME: $(MAIN_SDK_NAME))\n+$(info WIN_SDK_NAME : $(WIN_SDK_NAME))\n+$(info WIN_SDK_DIR  : $(WIN_SDK_DIR))\n+$(info WIN_SDK_ZIP  : $(WIN_SDK_ZIP))\n endef\n \n win_sdk: $(WIN_SDK_ZIP)\n@@ -69,7 +69,7 @@ $(WIN_SDK_ZIP): winsdk-tools sdk\n \t$(call winsdk-info)\n \t$(hide) rm -rf $(WIN_SDK_DIR)\n \t$(hide) mkdir -p $(WIN_SDK_DIR)\n-\t$(hide) cp -rf $(LINUX_SDK_DIR)/$(LINUX_SDK_NAME) $(WIN_SDK_DIR)/$(WIN_SDK_NAME)\n+\t$(hide) cp -rf $(MAIN_SDK_DIR)/$(MAIN_SDK_NAME) $(WIN_SDK_DIR)/$(WIN_SDK_NAME)\n \t$(hide) USB_DRIVER_HOOK=$(USB_DRIVER_HOOK) \\\n \t\t$(TOPDIR)development/build/tools/patch_windows_sdk.sh $(subst @,-q,$(hide)) \\\n \t\t$(WIN_SDK_DIR)/$(WIN_SDK_NAME) $(OUT_DIR) $(TOPDIR)\n""}","merge 
"
18879,Jaikumar Ganesh,Bluetooth: Add BT_POWER L2CAP socket option.,"['net/bluetooth/hci_conn.c', 'include/net/bluetooth/bluetooth.h', 'include/net/bluetooth/hci_core.h', 'net/bluetooth/l2cap.c', 'net/bluetooth/hci_core.c', 'include/net/bluetooth/l2cap.h']","Bluetooth: Add BT_POWER L2CAP socket option.

Add BT_POWER socket option used to control the power
characteristics of the underlying ACL link. When the remote end
has put the link in sniff mode and the host stack wants to send
data we need need to explicitly exit sniff mode to work well with
certain devices (For example, A2DP on Plantronics Voyager 855).
This causes problems with HID devices.

Hence, moving into active mode when sending data, irrespective
of who set the sniff mode has been made as a socket option. By
default, we will move into active mode. HID devices can set the
L2CAP socket option to prevent this from happening.

Currently, this has been implemented for L2CAP sockets. This has been
tested with incoming and outgoing L2CAP sockets for HID and A2DP.

Based on discussions on linux-bluetooth and patches submitted by
Andrei Emeltchenko.

Signed-off-by: Jaikumar Ganesh <jaikumar@google.com>",https://android-review.googlesource.com/c/18879,"feature 
",feature,Feature;Test;,"{""bluetooth.h"": ""@@ -64,6 +64,11 @@ struct bt_security {\n \n #define BT_DEFER_SETUP\t7\n \n+#define BT_POWER\t8\n+struct bt_power {\n+\t__u8 force_active;\n+};\n+\n #define BT_INFO(fmt, arg...) printk(KERN_INFO \""Bluetooth: \"" fmt \""\\n\"" , ## arg)\n #define BT_ERR(fmt, arg...)  printk(KERN_ERR \""%s: \"" fmt \""\\n\"" , __func__ , ## arg)\n #define BT_DBG(fmt, arg...)  pr_debug(\""%s: \"" fmt \""\\n\"" , __func__ , ## arg)\n@@ -142,6 +147,7 @@ struct bt_skb_cb {\n \t__u8 tx_seq;\n \t__u8 retries;\n \t__u8 sar;\n+\t__u8 force_active;\n };\n #define bt_cb(skb) ((struct bt_skb_cb *)((skb)->cb))\n \n"", ""hci_core.h"": ""@@ -353,7 +353,7 @@ int hci_conn_security(struct hci_conn *conn, __u8 sec_level, __u8 auth_type);\n int hci_conn_change_link_key(struct hci_conn *conn);\n int hci_conn_switch_role(struct hci_conn *conn, __u8 role);\n \n-void hci_conn_enter_active_mode(struct hci_conn *conn);\n+void hci_conn_enter_active_mode(struct hci_conn *conn, __u8 force_active);\n void hci_conn_enter_sniff_mode(struct hci_conn *conn);\n \n void hci_conn_hold_device(struct hci_conn *conn);\n"", ""l2cap.h"": ""@@ -329,6 +329,7 @@ struct l2cap_pinfo {\n \t__u8\t\trole_switch;\n \t__u8\t\tforce_reliable;\n \t__u8\t\tflushable;\n+\t__u8\t\tforce_active;\n \n \t__u8\t\tconf_req[64];\n \t__u8\t\tconf_len;\n"", ""hci_conn.c"": ""@@ -415,7 +415,8 @@ struct hci_conn *hci_connect(struct hci_dev *hdev, int type,\n \tif (acl->state == BT_CONNECTED &&\n \t\t\t(sco->state == BT_OPEN || sco->state == BT_CLOSED)) {\n \t\tacl->power_save = 1;\n-\t\thci_conn_enter_active_mode(acl);\n+\n+\t\thci_conn_enter_active_mode(acl, 1);\n \n \t\tif (test_bit(HCI_CONN_MODE_CHANGE_PEND, &acl->pend)) {\n \t\t\t/* defer SCO setup until mode change completed */\n@@ -531,7 +532,7 @@ int hci_conn_switch_role(struct hci_conn *conn, __u8 role)\n EXPORT_SYMBOL(hci_conn_switch_role);\n \n /* Enter active mode */\n-void hci_conn_enter_active_mode(struct hci_conn *conn)\n+void hci_conn_enter_active_mode(struct hci_conn *conn, __u8 force_active)\n {\n \tstruct hci_dev *hdev = conn->hdev;\n \n@@ -540,8 +541,12 @@ void hci_conn_enter_active_mode(struct hci_conn *conn)\n \tif (test_bit(HCI_RAW, &hdev->flags))\n \t\treturn;\n \n-\tif (conn->mode != HCI_CM_SNIFF /* || !conn->power_save */)\n+\tif (conn->mode != HCI_CM_SNIFF)\n+\t\tgoto timer;\n+\n+\tif (!conn->power_save && !force_active) {\n \t\tgoto timer;\n+\t}\n \n \tif (!test_and_set_bit(HCI_CONN_MODE_CHANGE_PEND, &conn->pend)) {\n \t\tstruct hci_cp_exit_sniff_mode cp;\n"", ""hci_core.c"": ""@@ -1507,7 +1507,7 @@ static inline void hci_sched_acl(struct hci_dev *hdev)\n \t\twhile (quote-- && (skb = skb_dequeue(&conn->data_q))) {\n \t\t\tBT_DBG(\""skb %p len %d\"", skb, skb->len);\n \n-\t\t\thci_conn_enter_active_mode(conn);\n+\t\t\thci_conn_enter_active_mode(conn, bt_cb(skb)->force_active);\n \n \t\t\thci_send_frame(skb);\n \t\t\thdev->acl_last_tx = jiffies;\n@@ -1609,7 +1609,7 @@ static inline void hci_acldata_packet(struct hci_dev *hdev, struct sk_buff *skb)\n \tif (conn) {\n \t\tregister struct hci_proto *hp;\n \n-\t\thci_conn_enter_active_mode(conn);\n+\t\thci_conn_enter_active_mode(conn, 1);\n \n \t\t/* Send to upper protocol */\n \t\tif ((hp = hci_proto[HCI_PROTO_L2CAP]) && hp->recv_acldata) {\n"", ""l2cap.c"": ""@@ -366,6 +366,8 @@ static inline void l2cap_send_cmd(struct l2cap_conn *conn, u8 ident, u8 code, u1\n \telse\n \t\tflags = ACL_START;\n \n+\tbt_cb(skb)->force_active = 1;\n+\n \thci_send_acl(conn->hcon, skb, flags);\n }\n \n@@ -412,6 +414,8 @@ static inline void l2cap_send_sframe(struct l2cap_pinfo *pi, u16 control)\n \t\tput_unaligned_le16(fcs, skb_put(skb, 2));\n \t}\n \n+\tbt_cb(skb)->force_active = l2cap_pi(sk)->force_active;\n+\n \thci_send_acl(pi->conn->hcon, skb, 0);\n }\n \n@@ -908,6 +912,7 @@ static void l2cap_sock_init(struct sock *sk, struct sock *parent)\n \t\tpi->role_switch = l2cap_pi(parent)->role_switch;\n \t\tpi->force_reliable = l2cap_pi(parent)->force_reliable;\n \t\tpi->flushable = l2cap_pi(parent)->flushable;\n+\t\tpi->force_active = l2cap_pi(parent)->force_active;\n \t} else {\n \t\tpi->imtu = L2CAP_DEFAULT_MTU;\n \t\tpi->omtu = 0;\n@@ -924,6 +929,7 @@ static void l2cap_sock_init(struct sock *sk, struct sock *parent)\n \t\tpi->role_switch = 0;\n \t\tpi->force_reliable = 0;\n \t\tpi->flushable = 0;\n+\t\tpi->force_active = 1;\n \t}\n \n \t/* Default config options */\n@@ -1452,6 +1458,7 @@ static inline void l2cap_do_send(struct sock *sk, struct sk_buff *skb)\n \telse\n \t\tflags = ACL_START;\n \n+\tbt_cb(skb)->force_active = 1;\n \thci_send_acl(hcon, skb, flags);\n }\n \n@@ -2043,6 +2050,7 @@ static int l2cap_sock_setsockopt(struct socket *sock, int level, int optname, ch\n {\n \tstruct sock *sk = sock->sk;\n \tstruct bt_security sec;\n+\tstruct bt_power pwr;\n \tint len, err = 0;\n \tu32 opt;\n \n@@ -2095,6 +2103,23 @@ static int l2cap_sock_setsockopt(struct socket *sock, int level, int optname, ch\n \t\tbt_sk(sk)->defer_setup = opt;\n \t\tbreak;\n \n+\tcase BT_POWER:\n+\t\tif (sk->sk_type != SOCK_SEQPACKET && sk->sk_type != SOCK_STREAM\n+\t\t\t\t&& sk->sk_type != SOCK_RAW) {\n+\t\t\terr = -EINVAL;\n+\t\t\tbreak;\n+\t\t}\n+\n+\t\tpwr.force_active = 1;\n+\n+\t\tlen = min_t(unsigned int, sizeof(pwr), optlen);\n+\t\tif (copy_from_user((char *) &pwr, optval, len)) {\n+\t\t\terr = -EFAULT;\n+\t\t\tbreak;\n+\t\t}\n+\t\tl2cap_pi(sk)->force_active = pwr.force_active;\n+\t\tbreak;\n+\n \tdefault:\n \t\terr = -ENOPROTOOPT;\n \t\tbreak;\n@@ -2195,6 +2220,7 @@ static int l2cap_sock_getsockopt(struct socket *sock, int level, int optname, ch\n {\n \tstruct sock *sk = sock->sk;\n \tstruct bt_security sec;\n+\tstruct bt_power pwr;\n \tint len, err = 0;\n \n \tBT_DBG(\""sk %p\"", sk);\n@@ -2237,6 +2263,20 @@ static int l2cap_sock_getsockopt(struct socket *sock, int level, int optname, ch\n \n \t\tbreak;\n \n+\tcase BT_POWER:\n+\t\tif (sk->sk_type != SOCK_SEQPACKET && sk->sk_type != SOCK_STREAM\n+\t\t\t\t&& sk->sk_type != SOCK_RAW) {\n+\t\t\terr = -EINVAL;\n+\t\t\tbreak;\n+\t\t}\n+\n+\t\tpwr.force_active = l2cap_pi(sk)->force_active;\n+\n+\t\tlen = min_t(unsigned int, len, sizeof(pwr));\n+\t\tif (copy_to_user(optval, (char *) &pwr, len))\n+\t\t\terr = -EFAULT;\n+\n+\t\tbreak;\n \tdefault:\n \t\terr = -ENOPROTOOPT;\n \t\tbreak;\n""}","feature, bug 
"
22228,Christopher Orr,Fix incomplete reference to Settings.ACTION_NETWORK_OPERATOR_SETTINGS.,['AndroidManifest.xml'],"Fix incomplete reference to Settings.ACTION_NETWORK_OPERATOR_SETTINGS.

Change-Id: I6c30262503a0302246d0fb035d2061fdaad1b69a",https://android-review.googlesource.com/c/22228,"bug
",bug,Bug;Resource;,"{""AndroidManifest.xml"": ""@@ -258,7 +258,7 @@\n             android:configChanges=\""orientation|keyboardHidden\"">\n             <intent-filter>\n                 <action android:name=\""android.intent.action.MAIN\"" />\n-                <action android:name=\""android.settings.NETWORK_OPERATOR_\"" />\n+                <action android:name=\""android.settings.NETWORK_OPERATOR_SETTINGS\"" />\n             </intent-filter>\n         </activity>\n \n""}","bug 
"
20855,Arve HjÃ¸nnevÃ¥g,ARM: 6292/1: coresight: add ETM management registers,"['arch/arm/kernel/etm.c', 'arch/arm/include/asm/hardware/coresight.h']","ARM: 6292/1: coresight: add ETM management registers

Add notion of ETM OS lock, save and restore registers.

Cc: linux-arm-kernel@lists.infradead.org
Cc: linux-kernel@vger.kernel.org
Signed-off-by: Alexander Shishkin <virtuoso@slind.org>
Signed-off-by: Russell King <rmk+kernel@arm.linux.org.uk>",https://android-review.googlesource.com/c/20855,"feature 
",feature,Feature;,"{""coresight.h"": ""@@ -48,8 +48,6 @@ struct tracectx {\n /* CoreSight Component Registers */\n #define CSCR_CLASS\t0xff4\n \n-#define CSCR_PRSR\t0x314\n-\n #define UNLOCK_MAGIC\t0xc5acce55\n \n /* ETM control register, \""ETM Architecture\"", 3.3.1 */\n@@ -132,6 +130,12 @@ struct tracectx {\n \t\t\t\tETMCTRL_BRANCH_OUTPUT | \\\n \t\t\t\tETMCTRL_DO_CONTEXTID)\n \n+/* ETM management registers, \""ETM Architecture\"", 3.5.24 */\n+#define ETMMR_OSLAR\t0x300\n+#define ETMMR_OSLSR\t0x304\n+#define ETMMR_OSSRR\t0x308\n+#define ETMMR_PDSR\t0x314\n+\n /* ETB registers, \""CoreSight Components TRM\"", 9.3 */\n #define ETBR_DEPTH\t\t0x04\n #define ETBR_STATUS\t\t0x0c\n"", ""etm.c"": ""@@ -543,7 +543,7 @@ static int __init etm_probe(struct amba_device *dev, struct amba_id *id)\n \tt->etm_portsz = 1;\n \n \tetm_unlock(t);\n-\tret = etm_readl(t, CSCR_PRSR);\n+\tret = etm_readl(t, ETMMR_PDSR);\n \n \tt->ncmppairs = etm_readl(t, ETMR_CONFCODE) & 0xf;\n \tetm_writel(t, 0x440, ETMR_CTRL);\n""}","feature 
"
16709,Xavier Ducrohet,SDK Launcher: add win32 app manifest,"['sdklauncher/sdklauncher.exe.manifest', 'sdklauncher/Android.mk', 'sdklauncher/images/android_icon.rc', 'sdklauncher/.gitignore']","SDK Launcher: add win32 app manifest

Merged from master to tools_r7

Change-Id: Ic9b8d265868b0e062fce067312c9e9fa89bba3c7",https://android-review.googlesource.com/c/16709,"resource
",merge;resource,Merge;,"{"".gitignore"": ""@@ -1 +1 @@\n-images/android_icon.o\n+images/sdklauncher_icon.o\n"", ""Android.mk"": ""@@ -28,20 +28,21 @@ ifneq ($(USE_MINGW),)\n endif\n \n # Link the Windows icon file as well into the executable, based on the technique\n-# used in external/qemu/Makefile.android.\n+# used in external/qemu/Makefile.android.  The variables need to have different\n+# names to not interfere with the ones from qemu/Makefile.android.\n #\n INTERMEDIATE     := $(call intermediates-dir-for,EXECUTABLES,$(LOCAL_MODULE),true)\n-ANDROID_ICON_OBJ := android_icon.o\n-ANDROID_ICON_PATH := $(LOCAL_PATH)/images\n-$(ANDROID_ICON_PATH)/$(ANDROID_ICON_OBJ): $(ANDROID_ICON_PATH)/android_icon.rc\n-\t$(WINDRES) $< -I $(ANDROID_ICON_PATH) -o $@\n+SDKLAUNCHER_ICON_OBJ := sdklauncher_icon.o\n+SDKLAUNCHER_ICON_PATH := $(LOCAL_PATH)/images\n+$(SDKLAUNCHER_ICON_PATH)/$(SDKLAUNCHER_ICON_OBJ): $(SDKLAUNCHER_ICON_PATH)/android_icon.rc\n+\t$(WINDRES) $< -I $(SDKLAUNCHER_ICON_PATH) -o $@\n \n # seems to be the only way to add an object file that was not generated from\n # a C/C++/Java source file to our build system. and very unfortunately,\n # $(TOPDIR)/$(LOCALPATH) will always be prepended to this value, which forces\n # us to put the object file in the source directory...\n #\n-LOCAL_PREBUILT_OBJ_FILES += images/$(ANDROID_ICON_OBJ)\n+LOCAL_PREBUILT_OBJ_FILES += images/$(SDKLAUNCHER_ICON_OBJ)\n \n include $(BUILD_HOST_EXECUTABLE)\n \n"", ""android_icon.rc"": ""@@ -1,3 +1,2 @@\n 1 ICON \""../images/android_icon.ico\""\r\n-\r\n-\r\n+1 RT_MANIFEST \""../sdklauncher.exe.manifest\""\r\n"", ""sdklauncher.exe.manifest"": ""@@ -0,0 +1,33 @@\n+<?xml version=\""1.0\"" encoding=\""UTF-8\"" standalone=\""yes\""?>\r\n+\r\n+<!--\r\n+  For details on the Assembly Manifest, please look here:\r\n+  http://msdn.microsoft.com/en-us/library/aa374191(VS.85).aspx\r\n+-->\r\n+\r\n+<assembly xmlns=\""urn:schemas-microsoft-com:asm.v1\"" manifestVersion=\""1.0\""> \r\n+\r\n+    <application>\r\n+        <!--The ID below indicates application support for Windows Vista -->\r\n+        <supportedOS Id=\""{e2011457-1546-43c5-a5fe-008deee3d3f0}\"" />\r\n+        <!--The ID below indicates application support for Windows 7 -->\r\n+        <supportedOS Id=\""{35138b9a-5d96-4fbd-8e2d-a2440225f93a}\"" />\r\n+    </application>\r\n+  \r\n+    <assemblyIdentity version=\""1.0.0.0\""\r\n+        processorArchitecture=\""x86\""\r\n+        name=\""Android.SDK.Launcher\""\r\n+        type=\""win32\""\r\n+        /> \r\n+\r\n+    <description>Launches the Android SDK Manager to download Android SDK packages.</description> \r\n+\r\n+    <!-- Identify the application security requirements. -->\r\n+    <trustInfo xmlns=\""urn:schemas-microsoft-com:asm.v2\"">\r\n+        <security>\r\n+            <requestedPrivileges>\r\n+                <requestedExecutionLevel level=\""asInvoker\"" uiAccess=\""false\"" />\r\n+            </requestedPrivileges>\r\n+        </security>\r\n+    </trustInfo>\r\n+</assembly>\r\n""}","resource, merge 
"
24261,RaphaÃ«l Moll,SdkManager2: fixes for asynchronous sources UI.,"['sdkmanager/libs/sdkuilib/src/com/android/sdkuilib/internal/repository/PackagesPage.java', 'sdkmanager/libs/sdkuilib/src/com/android/sdkuilib/internal/repository/PackageLoader.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/internal/repository/AddonsListFetcher.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/internal/repository/Package.java']","SdkManager2: fixes for asynchronous sources UI.

- Properly refresh display list when installing/deleting
  a package.
- Gray install/delete buttons during an install/delete
  to avoid nesting operations.

Change-Id: I72fdca1252c447b046040afb70e67dfae77188e4",https://android-review.googlesource.com/c/24261,"bug, feature
","bug,feature",Bug;Deprecat;,"{""AddonsListFetcher.java"": ""@@ -32,6 +32,7 @@ import java.io.FileNotFoundException;\n import java.io.IOException;\r\n import java.io.InputStream;\r\n import java.net.URL;\r\n+import java.net.UnknownHostException;\r\n import java.util.ArrayList;\r\n import java.util.regex.Matcher;\r\n import java.util.regex.Pattern;\r\n@@ -132,6 +133,10 @@ public class AddonsListFetcher {\n             if (exception[0] instanceof FileNotFoundException) {\r\n                 // FNF has no useful getMessage, so we need to special handle it.\r\n                 reason = \""File not found\"";\r\n+            } else if (exception[0] instanceof UnknownHostException &&\r\n+                    exception[0].getMessage() != null) {\r\n+                // This has no useful getMessage yet could really use one\r\n+                reason = String.format(\""Unknown Host %1$s\"", exception[0].getMessage());\r\n             } else if (exception[0] instanceof SSLKeyException) {\r\n                 // That's a common error and we have a pref for it.\r\n                 reason = \""HTTPS SSL error. You might want to force download through HTTP in the settings.\"";\r\n"", ""Package.java"": ""@@ -241,6 +241,7 @@ public abstract class Package implements IDescription, Comparable<Package> {\n \r\n     /**\r\n      * Parses an XML node to process the <archives> element.\r\n+     * Always return a non-null array. The array may be empty.\r\n      */\r\n     private Archive[] parseArchives(Node archivesNode) {\r\n         ArrayList<Archive> archives = new ArrayList<Archive>();\r\n@@ -351,6 +352,19 @@ public abstract class Package implements IDescription, Comparable<Package> {\n         return mArchives;\r\n     }\r\n \r\n+    /**\r\n+     * Returns true if this package contains the exact given archive.\r\n+     * Important: This compares object references, not object equality.\r\n+     */\r\n+    public boolean hasArchive(Archive archive) {\r\n+        for (Archive a : mArchives) {\r\n+            if (a == archive) {\r\n+                return true;\r\n+            }\r\n+        }\r\n+        return false;\r\n+    }\r\n+\r\n     /**\r\n      * Returns whether the {@link Package} has at least one {@link Archive} compatible with\r\n      * the host platform.\r\n@@ -539,7 +553,6 @@ public abstract class Package implements IDescription, Comparable<Package> {\n         return UpdateInfo.NOT_UPDATE;\r\n     }\r\n \r\n-\r\n     /**\r\n      * Returns an ordering like this: <br/>\r\n      * - Tools <br/>\r\n"", ""PackageLoader.java"": ""@@ -45,10 +45,10 @@ class PackageLoader {\n      * Interface for the callback called by\n      * {@link PackageLoader#loadPackages(ISourceLoadedCallback)}.\n      * <p/>\n-     * After processing each source, the package loader calls {@link #onSouceLoaded(List)}\n+     * After processing each source, the package loader calls {@link #onSourceLoaded(List)}\n      * with the list of package items found in that source. The client should process that\n      * list as it want, typically by accumulating the package items in a list of its own.\n-     * By returning true from {@link #onSouceLoaded(List)}, the client tells the loader to\n+     * By returning true from {@link #onSourceLoaded(List)}, the client tells the loader to\n      * continue and process the next source. By returning false, it tells to stop loading.\n      * <p/>\n      * The {@link #onLoadCompleted()} method is guaranteed to be called at the end, no\n@@ -60,7 +60,7 @@ class PackageLoader {\n          * After processing each source, the package loader calls this method with the\n          * list of package items found in that source. The client should process that\n          * list as it want, typically by accumulating the package items in a list of its own.\n-         * By returning true from {@link #onSouceLoaded(List)}, the client tells the loader to\n+         * By returning true from {@link #onSourceLoaded(List)}, the client tells the loader to\n          * continue and process the next source. By returning false, it tells to stop loading.\n          * <p/>\n          * <em>Important</em>: This method is called from a sub-thread, so clients who try\n@@ -71,7 +71,7 @@ class PackageLoader {\n          *  This is a copy and the client can hold to this list or modify it in any way.\n          * @return True if the load operation should continue, false if it should stop.\n          */\n-        public boolean onSouceLoaded(List<PkgItem> pkgItems);\n+        public boolean onSourceLoaded(List<PkgItem> pkgItems);\n \n         /**\n          * This method is guaranteed to be called at the end, no matter how the\n@@ -147,7 +147,7 @@ class PackageLoader {\n                 // Notify the callback by giving it a copy of the current list.\n                 // (in case the callback holds to the list... we still need this list of\n                 // ourselves below).\n-                if (!sourceLoadedCallback.onSouceLoaded(new ArrayList<PkgItem>(allPkgItems))) {\n+                if (!sourceLoadedCallback.onSourceLoaded(new ArrayList<PkgItem>(allPkgItems))) {\n                     return;\n                 }\n             }\n@@ -192,7 +192,7 @@ class PackageLoader {\n \n                             // Notify the callback a new source has finished loading.\n                             // If the callback requests so, stop right away.\n-                            if (!sourceLoadedCallback.onSouceLoaded(sourcePkgItems)) {\n+                            if (!sourceLoadedCallback.onSourceLoaded(sourcePkgItems)) {\n                                 return;\n                             }\n                         }\n@@ -260,7 +260,7 @@ class PackageLoader {\n     public void loadPackagesWithInstallTask(final IAutoInstallTask installTask) {\n \n         loadPackages(new ISourceLoadedCallback() {\n-            public boolean onSouceLoaded(List<PkgItem> pkgItems) {\n+            public boolean onSourceLoaded(List<PkgItem> pkgItems) {\n                 for (PkgItem item : pkgItems) {\n                     Package acceptedPkg = null;\n                     switch(item.getState()) {\n@@ -540,6 +540,25 @@ class PackageLoader {\n             return getPackage().compareTo(pkg.getPackage());\n         }\n \n+        /**\n+         * Returns true if this package or any of the updating packages contains\n+         * the exact given archive.\n+         * Important: This compares object references, not object equality.\n+         */\n+        public boolean hasArchive(Archive archive) {\n+            if (mPkg.hasArchive(archive)) {\n+                return true;\n+            }\n+            if (mUpdatePkgs != null && !mUpdatePkgs.isEmpty()) {\n+                for (Package p : mUpdatePkgs) {\n+                    if (p.hasArchive(archive)) {\n+                        return true;\n+                    }\n+                }\n+            }\n+            return false;\n+        }\n+\n         /** Returns a string representation of this item, useful when debugging. */\n         @Override\n         public String toString() {\n"", ""PackagesPage.java"": ""@@ -74,6 +74,7 @@ import java.util.Iterator;\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n+import java.util.TreeMap;\n import java.util.TreeSet;\n import java.util.Map.Entry;\n \n@@ -152,6 +153,7 @@ public class PackagesPage extends UpdaterPage\n     private Font mTreeFontItalic;\n     private TreeColumn mTreeColumnName;\n     private boolean mLastSortWasByApi;\n+    private boolean mOperationPending;\n \n     public PackagesPage(Composite parent, int swtStyle, UpdaterData updaterData) {\n         super(parent, swtStyle);\n@@ -507,7 +509,7 @@ public class PackagesPage extends UpdaterPage\n         // disposed yet. Otherwise hilarity ensues.\n \n         mPackageLoader.loadPackages(new ISourceLoadedCallback() {\n-            public boolean onSouceLoaded(List<PkgItem> newPkgItems) {\n+            public boolean onSourceLoaded(List<PkgItem> newPkgItems) {\n                 boolean somethingNew = false;\n \n                 synchronized(mPackages) {\n@@ -560,17 +562,6 @@ public class PackagesPage extends UpdaterPage\n         });\n     }\n \n-    private void enableUi(Composite root, boolean enabled) {\n-        root.setEnabled(enabled);\n-        for (Control child : root.getChildren()) {\n-            if (child instanceof Composite) {\n-                enableUi((Composite) child, enabled);\n-            } else {\n-                child.setEnabled(enabled);\n-            }\n-        }\n-    }\n-\n     private void sortPackages(boolean updateButtons) {\n         if (isSortByApi()) {\n             sortByApiLevel();\n@@ -923,7 +914,27 @@ public class PackagesPage extends UpdaterPage\n         }\n     }\n \n+    /**\n+     * Indicate an install/delete operation is pending.\n+     * This disable the install/delete buttons.\n+     * Use {@link #endOperationPending()} to revert.\n+     */\n+    private void beginOperationPending() {\n+        mOperationPending = true;\n+        mButtonInstall.setEnabled(false);\n+        mButtonDelete.setEnabled(false);\n+    }\n+\n+    private void endOperationPending() {\n+        mOperationPending = false;\n+        updateButtonsState();\n+    }\n+\n     private void updateButtonsState() {\n+        if (mOperationPending) {\n+            return;\n+        }\n+\n         boolean canInstall = false;\n \n         if (mDisplayArchives) {\n@@ -1039,13 +1050,28 @@ public class PackagesPage extends UpdaterPage\n \n         if (mUpdaterData != null) {\n             try {\n-                enableUi(mGroupPackages, false);\n+                beginOperationPending();\n \n                 mUpdaterData.updateOrInstallAll_WithGUI(\n                     archives,\n                     mCheckFilterObsolete.getSelection() /* includeObsoletes */);\n             } finally {\n-                enableUi(mGroupPackages, true);\n+                endOperationPending();\n+\n+                // Remove any pkg item matching anything we potentially installed\n+                // then request the package list to be updated. This will prevent\n+                // from having stale entries.\n+                synchronized(mPackages) {\n+                    for (Archive a : archives) {\n+                        for (Iterator<PkgItem> it = mPackages.iterator(); it.hasNext(); ) {\n+                            PkgItem pi = it.next();\n+                            if (pi.hasArchive(a)) {\n+                                it.remove();\n+                                break;\n+                            }\n+                        }\n+                    }\n+                }\n \n                 // The local package list has changed, make sure to refresh it\n                 mUpdaterData.getLocalSdkParser().clearPackages();\n@@ -1062,15 +1088,18 @@ public class PackagesPage extends UpdaterPage\n             return;\n         }\n \n-        String title = \""Delete SDK Package\"";\n+        final String title = \""Delete SDK Package\"";\n         String msg = \""Are you sure you want to delete:\"";\n-        final List<Archive> archives = new ArrayList<Archive>();\n+\n+        // A map of archives to deleted versus their internal PkgItem representation\n+        final Map<Archive, PkgItem> archives = new TreeMap<Archive, PkgItem>();\n \n         for (Object c : checked) {\n             if (c instanceof PkgItem) {\n-                PkgState state = ((PkgItem) c).getState();\n+                PkgItem pi = (PkgItem) c;\n+                PkgState state = pi.getState();\n                 if (state == PkgState.INSTALLED || state == PkgState.HAS_UPDATE) {\n-                    Package p = ((PkgItem) c).getPackage();\n+                    Package p = pi.getPackage();\n \n                     Archive[] as = p.getArchives();\n                     if (as.length == 1 && as[0] != null && as[0].isLocal()) {\n@@ -1080,7 +1109,7 @@ public class PackagesPage extends UpdaterPage\n                         File dir = new File(osPath);\n                         if (dir.isDirectory()) {\n                             msg += \""\\n - \"" + p.getShortDescription();\n-                            archives.add(archive);\n+                            archives.put(archive, pi);\n                         }\n                     }\n                 }\n@@ -1091,16 +1120,25 @@ public class PackagesPage extends UpdaterPage\n             msg += \""\\n\"" + \""This cannot be undone.\"";\n             if (MessageDialog.openQuestion(getShell(), title, msg)) {\n                 try {\n-                    enableUi(mGroupPackages, false);\n+                    beginOperationPending();\n \n-                    mUpdaterData.getTaskFactory().start(\""Loading Sources\"", new ITask() {\n+                    mUpdaterData.getTaskFactory().start(\""Delete Package\"", new ITask() {\n                         public void run(ITaskMonitor monitor) {\n                             monitor.setProgressMax(archives.size() + 1);\n-                            for (Archive a : archives) {\n+                            for (Entry<Archive, PkgItem> entry : archives.entrySet()) {\n+                                Archive a = entry.getKey();\n+\n                                 monitor.setDescription(\""Deleting '%1$s' (%2$s)\"",\n                                         a.getParentPackage().getShortDescription(),\n                                         a.getLocalOsPath());\n+\n+                                // Delete the actual package and its internal representation\n                                 a.deleteLocal();\n+\n+                                synchronized(mPackages) {\n+                                    mPackages.remove(entry.getValue());\n+                                }\n+\n                                 monitor.incProgress(1);\n                                 if (monitor.isCancelRequested()) {\n                                     break;\n@@ -1112,7 +1150,7 @@ public class PackagesPage extends UpdaterPage\n                         }\n                     });\n                 } finally {\n-                    enableUi(mGroupPackages, true);\n+                    endOperationPending();\n \n                     // The local package list has changed, make sure to refresh it\n                     mUpdaterData.getLocalSdkParser().clearPackages();\n""}","feature, refactor 
"
16556,David Butcher,Copyright message changed,"['libpixelflinger/col32cb16blend_neon.S', 'libpixelflinger/col32cb16blend.S']","Copyright message changed

Change requested by Android Open Source Project
",https://android-review.googlesource.com/c/16556,"resource 
",resource,Resource;,"{""col32cb16blend.S"": ""@@ -1,20 +1,19 @@\n /* libs/pixelflinger/col32cb16blend.S\n-**\n-** (C) COPYRIGHT 2009 ARM Limited.\n-**\n-** Licensed under the Apache License, Version 2.0 (the \""License\""); \n-** you may not use this file except in compliance with the License. \n-** You may obtain a copy of the License at \n-**\n-**     http://www.apache.org/licenses/LICENSE-2.0 \n-**\n-** Unless required by applicable law or agreed to in writing, software \n-** distributed under the License is distributed on an \""AS IS\"" BASIS, \n-** WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. \n-** See the License for the specific language governing permissions and \n-** limitations under the License.\n-**\n-*/\n+ *\n+ * Copyright (C) 2009 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n \n     .text\n     .align\n"", ""col32cb16blend_neon.S"": ""@@ -1,20 +1,20 @@\n /* libs/pixelflinger/col32cb16blend_neon.S\n-**\n-** (C) COPYRIGHT 2009 ARM Limited.\n-**\n-** Licensed under the Apache License, Version 2.0 (the \""License\""); \n-** you may not use this file except in compliance with the License. \n-** You may obtain a copy of the License at \n-**\n-**     http://www.apache.org/licenses/LICENSE-2.0 \n-**\n-** Unless required by applicable law or agreed to in writing, software \n-** distributed under the License is distributed on an \""AS IS\"" BASIS, \n-** WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. \n-** See the License for the specific language governing permissions and \n-** limitations under the License.\n-**\n-*/\n+ *\n+ * Copyright (C) 2009 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n \n     .text\n     .align\n""}","resource 
"
22386,David Turner,Really fix the Mac build.,"['tools/emulator/opengl/host/libs/libOpenglRender/FrameBuffer.h', 'tools/emulator/opengl/host/libs/libOpenglRender/Android.mk', 'tools/emulator/opengl/host/include/libOpenglRender/render_api.h', 'tools/emulator/opengl/tests/emulator_test_renderer/Android.mk', 'tools/emulator/opengl/host/renderer/Android.mk']","Really fix the Mac build.

Damned!

Change-Id: Ice8295fb23beefe328207112b011489276b5b278",https://android-review.googlesource.com/c/22386,"bug 
",bug,Bug;,"{""render_api.h"": ""@@ -32,7 +32,7 @@ typedef HWND    FBNativeWindowType;\n typedef Window   FBNativeWindowType;\n \n #else\n-#error \""Unsupported platform\""\n+#warning \""Unsupported platform\""\n #endif\n \n \n"", ""Android.mk"": ""@@ -1,5 +1,7 @@\n LOCAL_PATH:=$(call my-dir)\n \n+# For now, OS X is not supported\n+ifneq ($(HOST_OS),darwin)\n # test opengl renderer driver ###########################\n include $(CLEAR_VARS)\n \n@@ -31,3 +33,4 @@ LOCAL_SHARED_LIBRARIES := libOpenglRender \\\n LOCAL_STATIC_LIBRARIES += libSDL libSDLmain\n \n include $(BUILD_HOST_EXECUTABLE)\n+endif # HOST_OS != darwin\n"", ""FrameBuffer.h"": ""@@ -27,7 +27,7 @@\n \n #if defined(__linux__) || defined(_WIN32) || defined(__VC32__) && !defined(__CYGWIN__)\n #else\n-#error \""Unsupported Platform\""\n+#warning \""Unsupported Platform\""\n #endif\n \n typedef uint32_t HandleType;\n""}","**resource** 
"
14532,Jean-Baptiste Queru,Adapt to new location of libcore,"['Android.mk', 'docs/porting-guide.html']","Adapt to new location of libcore

Change-Id: Ic8106513bd8bd27ccd785f792dca5b2b48fdf9f5",https://android-review.googlesource.com/c/14532,"refactor 
",resource,Resource;,"{""Android.mk"": ""@@ -23,7 +23,6 @@ subdirs := $(addprefix $(LOCAL_PATH)/,$(addsuffix /Android.mk, \\\n \t\tdexdump \\\n \t\tdvz \\\n \t\tdx \\\n-\t\tlibcore \\\n \t\tlibnativehelper \\\n \t\ttools \\\n \t))\n"", ""porting-guide.html"": ""@@ -24,7 +24,7 @@ build system is assumed.\n <h2>Core Libraries</h2>\n \n <p>\n-The native code in the core libraries (chiefly <code>dalvik/libcore</code>,\n+The native code in the core libraries (chiefly <code>libcore</code>,\n but also <code>dalvik/vm/native</code>) is written in C/C++ and is expected\n to work without modification in a Linux environment.  Much of the code\n comes directly from the Apache Harmony project.\n""}","resource 
"
9449,Fredrik MarkstrÃ¶m,Fixes for skia to build for armv4t Since we are no longer supporting the armv4 architecture (see 9336 and 9378) but instead armv4t we should test on __ARM_ARCH_4T__ instead of __ARM_ARCH_4T__,['include/core/SkMath.h'],"Fixes for skia to build for armv4t
Since we are no longer supporting the armv4 architecture (see 9336 and
9378) but instead armv4t we should test on __ARM_ARCH_4T__ instead of
__ARM_ARCH_4T__

https://review.source.android.com/Gerrit#change,9336
https://review.source.android.com/Gerrit#change,9378",https://android-review.googlesource.com/c/9449,bug,bug,Bug;Test;,"{""SkMath.h"": ""@@ -162,7 +162,7 @@ static inline int SkNextLog2(uint32_t value) {\n     With this requirement, we can generate faster instructions on some\n     architectures.\n */\n-#if defined(__arm__) && !defined(__thumb__) && !defined(__ARM_ARCH_4__)\n+#if defined(__arm__) && !defined(__thumb__) && !defined(__ARM_ARCH_4T__)\n     static inline int32_t SkMulS16(S16CPU x, S16CPU y) {\n         SkASSERT((int16_t)x == x);\n         SkASSERT((int16_t)y == y);\n""}","bug,refactor 
"
17210,RaphaÃ«l Moll,GLE2: fix RelativeLayout insert bad attributes sometimes.,['eclipse/plugins/com.android.ide.eclipse.adt/gscripts/BaseLayout.groovy'],"GLE2: fix RelativeLayout insert bad attributes sometimes.

When RelativeLayout drops new elements, it filters the
attributes and the filter is supposed to return false to
indicate some attribute is not needed. Unfortunately the
filtering code was assigning this to a String type and
thus the false value was auto-converted to ""false"", thus
failing the test and ending up as-is in the XML.

Change-Id: Ife48ad9214a48016b7eb616950660deb3c962f6d",https://android-review.googlesource.com/c/17210,"bug
",bug,Bug;Resource;,"{""BaseLayout.groovy"": ""@@ -283,7 +283,7 @@ public class BaseLayout extends BaseView {\n         for (attr in oldElement.getAttributes()) {\n             String uri = attr.getUri();\n             String name = attr.getName();\n-            String value = attr.getValue();\n+            def value = attr.getValue();  // Note: must be typeless. See comment below in filter()\n \n             if (uri == ANDROID_URI) {\n                 if (name == ATTR_ID) {\n@@ -304,6 +304,10 @@ public class BaseLayout extends BaseView {\n             }\n \n             if (filter != null) {\n+                // Note: value must be declared as a \""def\"" because filter() might\n+                // different types, e.g. either a string, null or a boolean false.\n+                // If value is declared as a String, null or a string will work\n+                // but false would be cast to the string \""false\"".\n                 value = filter(uri, name, value);\n             }\n             if (value != null && value != false && value != \""\"") {\n""}","bug, refactor 
"
24271,RaphaÃ«l Moll,Fix SDK Manager unit tests.,"['sdkmanager/libs/sdklib/tests/src/com/android/sdklib/internal/repository/SdkRepoSourceTest.java', 'sdkmanager/libs/sdklib/tests/src/com/android/sdklib/internal/repository/SdkAddonSourceTest.java']","Fix SDK Manager unit tests.

These got broken after I've fixed the sort order
of extra packages in SDK Manager 2.

Change-Id: Ie18f3fb74f800ac855680be29a7932f8c8d9f54c",https://android-review.googlesource.com/c/24271,"test, bug 
","test,bug",Bug;Test;,"{""SdkAddonSourceTest.java"": ""@@ -205,14 +205,14 @@ public class SdkAddonSourceTest extends TestCase {\n             }\r\n         }\r\n         assertEquals(\r\n-                \""[usb_driver, extra_api_dep, extra0000005f]\"",\r\n+                \""[extra_api_dep, usb_driver, extra0000005f]\"",\r\n                 Arrays.toString(extraPaths.toArray()));\r\n         assertEquals(\r\n-                \""[g, android_vendor, vendor0000005f]\"",\r\n+                \""[android_vendor, g, vendor0000005f]\"",\r\n                 Arrays.toString(extraVendors.toArray()));\r\n         assertEquals(\r\n-                (\""[SDK/extras/g/usb_driver, \"" +\r\n-                  \""SDK/extras/android_vendor/extra_api_dep, \"" +\r\n+                (\""[SDK/extras/android_vendor/extra_api_dep, \"" +\r\n+                  \""SDK/extras/g/usb_driver, \"" +\r\n                   \""SDK/extras/vendor0000005f/extra0000005f]\"").replace('/', File.separatorChar),\r\n                 Arrays.toString(extraInstall.toArray()));\r\n     }\r\n@@ -296,14 +296,14 @@ public class SdkAddonSourceTest extends TestCase {\n             }\r\n         }\r\n         assertEquals(\r\n-                \""[usb_driver, extra_api_dep, extra0000005f]\"",\r\n+                \""[extra_api_dep, usb_driver, extra0000005f]\"",\r\n                 Arrays.toString(extraPaths.toArray()));\r\n         assertEquals(\r\n-                \""[g, android_vendor, vendor0000005f]\"",\r\n+                \""[android_vendor, g, vendor0000005f]\"",\r\n                 Arrays.toString(extraVendors.toArray()));\r\n         assertEquals(\r\n-                (\""[SDK/extras/g/usb_driver, \"" +\r\n-                  \""SDK/extras/android_vendor/extra_api_dep, \"" +\r\n+                (\""[SDK/extras/android_vendor/extra_api_dep, \"" +\r\n+                  \""SDK/extras/g/usb_driver, \"" +\r\n                   \""SDK/extras/vendor0000005f/extra0000005f]\"").replace('/', File.separatorChar),\r\n                 Arrays.toString(extraInstall.toArray()));\r\n     }\r\n"", ""SdkRepoSourceTest.java"": ""@@ -308,13 +308,13 @@ public class SdkRepoSourceTest extends TestCase {\n             }\r\n         }\r\n         assertEquals(\r\n-                \""[usb_driver, extra_api_dep]\"",\r\n+                \""[extra_api_dep, usb_driver]\"",\r\n                 Arrays.toString(extraPaths.toArray()));\r\n         assertEquals(\r\n                 \""[, ]\"",\r\n                 Arrays.toString(extraVendors.toArray()));\r\n         assertEquals(\r\n-                \""[SDK/extras/usb_driver, SDK/extras/extra_api_dep]\"".replace('/', File.separatorChar),\r\n+                \""[SDK/extras/extra_api_dep, SDK/extras/usb_driver]\"".replace('/', File.separatorChar),\r\n                 Arrays.toString(extraInstall.toArray()));\r\n     }\r\n \r\n@@ -385,13 +385,13 @@ public class SdkRepoSourceTest extends TestCase {\n             }\r\n         }\r\n         assertEquals(\r\n-                \""[usb_driver, extra_api_dep]\"",\r\n+                \""[extra_api_dep, usb_driver]\"",\r\n                 Arrays.toString(extraPaths.toArray()));\r\n         assertEquals(\r\n-                \""[a, android_vendor]\"",\r\n+                \""[android_vendor, a]\"",\r\n                 Arrays.toString(extraVendors.toArray()));\r\n         assertEquals(\r\n-                \""[SDK/extras/a/usb_driver, SDK/extras/android_vendor/extra_api_dep]\""\r\n+                \""[SDK/extras/android_vendor/extra_api_dep, SDK/extras/a/usb_driver]\""\r\n                  .replace('/', File.separatorChar),\r\n                 Arrays.toString(extraInstall.toArray()));\r\n     }\r\n@@ -487,18 +487,18 @@ public class SdkRepoSourceTest extends TestCase {\n             }\r\n         }\r\n         assertEquals(\r\n-                \""[usb_driver, extra_api_dep]\"",\r\n+                \""[extra_api_dep, usb_driver]\"",\r\n                 Arrays.toString(extraPaths.toArray()));\r\n         assertEquals(\r\n-                \""[a, android_vendor]\"",\r\n+                \""[android_vendor, a]\"",\r\n                 Arrays.toString(extraVendors.toArray()));\r\n         assertEquals(\r\n-                \""[SDK/extras/a/usb_driver, SDK/extras/android_vendor/extra_api_dep]\""\r\n+                \""[SDK/extras/android_vendor/extra_api_dep, SDK/extras/a/usb_driver]\""\r\n                  .replace('/', File.separatorChar),\r\n                 Arrays.toString(extraInstall.toArray()));\r\n         assertEquals(\r\n-                \""[[], \"" +\r\n-                \""[v8/veggies_8.jar, readme.txt, dir1/dir 2 with space/mylib.jar]]\"",\r\n+                \""[[v8/veggies_8.jar, readme.txt, dir1/dir 2 with space/mylib.jar], \"" +\r\n+                \""[]]\"",\r\n                 Arrays.toString(extraFilePaths.toArray()));\r\n     }\r\n \r\n""}","test,bug 
"
20473,Tor Norbye,Fix Extract as Include refactoring for layout attributes,"['eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/LayoutConstants.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/RelativeLayoutRule.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/ExtractIncludeAction.java']","Fix Extract as Include refactoring for layout attributes

This changeset fixes several issues with the Extract As Include
operation:

1) Transfer all the layout_ attributes to the include
   itself. Generally the layout attributes are particular to the
   inclusion context, they are not shared among the different uses of
   the include. For example, in layout1, the include may be in a
   linear layout and have a layout weight, and in another layout the
   included may need relative layout attachments.

2) Generate a new id for the included tag itself

3) For any layout references to the old extracted id, use the include
   tag id instead

4) Generate the new layout in the same folder as the source of the
   extract operation, since it may depend on properties only defined
   there

Change-Id: I515a56fe07cc0ffc1b4fcb6eec8d3a10d383915e",https://android-review.googlesource.com/c/20473,"bug, refactor
","bug,refactor",Bug;Refactoring;,"{""LayoutConstants.java"": ""@@ -46,6 +46,7 @@ public class LayoutConstants {\n     public static final String ATTR_TEXT = \""text\"";                      //$NON-NLS-1$\n     public static final String ATTR_ID = \""id\"";                          //$NON-NLS-1$\n \n+    public static final String ATTR_LAYOUT_PREFIX = \""layout_\"";          //$NON-NLS-1$\n     public static final String ATTR_LAYOUT_HEIGHT = \""layout_height\"";    //$NON-NLS-1$\n     public static final String ATTR_LAYOUT_WIDTH = \""layout_width\"";      //$NON-NLS-1$\n \n"", ""RelativeLayoutRule.java"": ""@@ -18,6 +18,7 @@ package com.android.ide.common.layout;\n \n import static com.android.ide.common.layout.LayoutConstants.ANDROID_URI;\n import static com.android.ide.common.layout.LayoutConstants.ATTR_ID;\n+import static com.android.ide.common.layout.LayoutConstants.ATTR_LAYOUT_PREFIX;\n import static com.android.ide.common.layout.LayoutConstants.VALUE_ABOVE;\n import static com.android.ide.common.layout.LayoutConstants.VALUE_ALIGN_BASELINE;\n import static com.android.ide.common.layout.LayoutConstants.VALUE_ALIGN_BOTTOM;\n@@ -92,7 +93,7 @@ public class RelativeLayoutRule extends BaseLayoutRule {\n     }\n \n     private void addAttr(String propertyName, INode childNode, List<String> infos) {\n-        String a = childNode.getStringAttr(ANDROID_URI, \""layout_\"" + propertyName); //$NON-NLS-1$\n+        String a = childNode.getStringAttr(ANDROID_URI, ATTR_LAYOUT_PREFIX + propertyName);\n         if (a != null && a.length() > 0) {\n             String s = propertyName + \"": \"" + a;\n             infos.add(s);\n@@ -640,7 +641,7 @@ public class RelativeLayoutRule extends BaseLayoutRule {\n \n                     for (String it : data.getCurr().getAttr()) {\n                         newChild.setAttribute(ANDROID_URI,\n-                             \""layout_\"" + it, id != null ? id : \""true\""); //$NON-NLS-1$ //$NON-NLS-2$\n+                             ATTR_LAYOUT_PREFIX + it, id != null ? id : \""true\""); //$NON-NLS-1$\n                     }\n \n                     addInnerElements(newChild, element, idMap);\n"", ""ExtractIncludeAction.java"": ""@@ -20,12 +20,12 @@ import static com.android.ide.common.layout.LayoutConstants.ANDROID_NS_PREFIX;\n import static com.android.ide.common.layout.LayoutConstants.ANDROID_URI;\n import static com.android.ide.common.layout.LayoutConstants.ATTR_ID;\n import static com.android.ide.common.layout.LayoutConstants.ATTR_LAYOUT_HEIGHT;\n+import static com.android.ide.common.layout.LayoutConstants.ATTR_LAYOUT_PREFIX;\n import static com.android.ide.common.layout.LayoutConstants.ATTR_LAYOUT_WIDTH;\n import static com.android.ide.common.layout.LayoutConstants.ID_PREFIX;\n import static com.android.ide.common.layout.LayoutConstants.NEW_ID_PREFIX;\n import static com.android.ide.common.layout.LayoutConstants.VALUE_WRAP_CONTENT;\n import static com.android.ide.eclipse.adt.AndroidConstants.DOT_XML;\n-import static com.android.ide.eclipse.adt.AndroidConstants.WS_LAYOUTS;\n import static com.android.ide.eclipse.adt.AndroidConstants.WS_SEP;\n import static com.android.ide.eclipse.adt.internal.editors.descriptors.XmlnsAttributeDescriptor.XMLNS;\n import static com.android.ide.eclipse.adt.internal.editors.descriptors.XmlnsAttributeDescriptor.XMLNS_COLON;\n@@ -43,9 +43,12 @@ import com.android.ide.eclipse.adt.internal.preferences.AdtPrefs;\n import com.android.ide.eclipse.adt.internal.wizards.newxmlfile.ResourceNameValidator;\n import com.android.sdklib.util.Pair;\n \n+import org.eclipse.core.resources.IContainer;\n import org.eclipse.core.resources.IFile;\n import org.eclipse.core.resources.IProject;\n import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IPath;\n+import org.eclipse.core.runtime.Path;\n import org.eclipse.core.runtime.QualifiedName;\n import org.eclipse.jface.action.Action;\n import org.eclipse.jface.action.IAction;\n@@ -59,6 +62,10 @@ import org.eclipse.ui.ide.IDE;\n import org.eclipse.wst.sse.core.internal.provisional.IStructuredModel;\n import org.eclipse.wst.sse.core.internal.provisional.IndexedRegion;\n import org.eclipse.wst.sse.core.internal.provisional.text.IStructuredDocument;\n+import org.eclipse.wst.sse.core.internal.provisional.text.IStructuredDocumentRegion;\n+import org.eclipse.wst.sse.core.internal.provisional.text.ITextRegion;\n+import org.eclipse.wst.sse.core.internal.provisional.text.ITextRegionList;\n+import org.eclipse.wst.xml.core.internal.regions.DOMRegionContext;\n import org.w3c.dom.Document;\n import org.w3c.dom.Element;\n import org.w3c.dom.NamedNodeMap;\n@@ -67,6 +74,8 @@ import org.w3c.dom.Node;\n import java.io.ByteArrayInputStream;\n import java.io.InputStream;\n import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Comparator;\n import java.util.HashSet;\n import java.util.List;\n import java.util.Set;\n@@ -218,7 +227,9 @@ public class ExtractIncludeAction extends Action {\n \n         String newFileName = newName + DOT_XML;\n         IProject project = mCanvas.getLayoutEditor().getProject();\n-        IFile file = project.getFile(WS_LAYOUTS + WS_SEP + newFileName);\n+        IContainer parent = mCanvas.getLayoutEditor().getInputFile().getParent();\n+        IPath parentPath = parent.getProjectRelativePath();\n+        IFile file = project.getFile(new Path(parentPath + WS_SEP + newFileName));\n \n         writeFile(file, sb.toString());\n \n@@ -226,13 +237,114 @@ public class ExtractIncludeAction extends Action {\n         LayoutEditor editor = mCanvas.getLayoutEditor();\n         editor.getGraphicalEditor().refreshProjectResources();\n \n+        String referenceId = getReferenceId();\n+        List<Edit> edits = new ArrayList<Edit>();\n+\n+        // Replace existing elements in the source file and insert <include>\n+        String include = computeIncludeString(newName, androidNsPrefix, referenceId);\n+        edits.add(new Edit(start, end, include));\n+\n+        // Update any layout references to the old id with the new id\n+        if (referenceId != null) {\n+            String rootId = getRootId();\n+            IStructuredModel model = editor.getModelForRead();\n+            try {\n+                IStructuredDocument doc = model.getStructuredDocument();\n+                if (doc != null) {\n+                    List<Edit> replaceIds = replaceIds(doc, start, end, rootId, referenceId);\n+                    edits.addAll(replaceIds);\n+                }\n+            } finally {\n+                model.releaseFromRead();\n+            }\n+        }\n+\n         // Open extracted file. This seems to trigger refreshing of ProjectResources\n         // such that the @layout/<newName> reference from the new <include> we're adding\n         // will work; without this we get file reference errors\n         openFile(file);\n \n-        // Replace existing elements in the source file and insert <include>\n-        replaceWithInclude(newName, start, end, androidNsPrefix);\n+        // Perform edits\n+        applyEdits(\""Extract As Include\"", edits);\n+    }\n+\n+    /** Produce a list of edits to replace references to the given id with the given new id */\n+    private List<Edit> replaceIds(IStructuredDocument doc, int skipStart, int skipEnd,\n+            String rootId, String referenceId) {\n+\n+        // We need to search for either @+id/ or @id/\n+        String match1 = rootId;\n+        String match2;\n+        if (match1.startsWith(ID_PREFIX)) {\n+            match2 = '\""' + NEW_ID_PREFIX + match1.substring(ID_PREFIX.length()) + '\""';\n+            match1 = '\""' + match1 + '\""';\n+        } else if (match1.startsWith(NEW_ID_PREFIX)) {\n+            match2 = '\""' + ID_PREFIX + match1.substring(NEW_ID_PREFIX.length()) + '\""';\n+            match1 = '\""' + match1 + '\""';\n+        } else {\n+            return Collections.emptyList();\n+        }\n+\n+        String namePrefix = ANDROID_NS_PREFIX + ':' + ATTR_LAYOUT_PREFIX;\n+        List<Edit> edits = new ArrayList<Edit>();\n+\n+        IStructuredDocumentRegion region = doc.getFirstStructuredDocumentRegion();\n+        for (; region != null; region = region.getNext()) {\n+            ITextRegionList list = region.getRegions();\n+            int regionStart = region.getStart();\n+\n+            // Look at all attribute values and look for an id reference match\n+            String attributeName = \""\""; //$NON-NLS-1$\n+            for (int j = 0; j < region.getNumberOfRegions(); j++) {\n+                ITextRegion subRegion = list.get(j);\n+                String type = subRegion.getType();\n+                if (DOMRegionContext.XML_TAG_ATTRIBUTE_NAME.equals(type)) {\n+                    attributeName = region.getText(subRegion);\n+                } else if (DOMRegionContext.XML_TAG_ATTRIBUTE_VALUE.equals(type)) {\n+                    // Only replace references in layout attributes\n+                    if (!attributeName.startsWith(namePrefix)) {\n+                        continue;\n+                    }\n+                    // Skip occurrences in the given skip range\n+                    int subRegionStart = regionStart + subRegion.getStart();\n+                    if (subRegionStart >= skipStart && subRegionStart <= skipEnd) {\n+                        continue;\n+                    }\n+\n+                    String attributeValue = region.getText(subRegion);\n+                    if (attributeValue.equals(match1) || attributeValue.equals(match2)) {\n+                        int start = subRegionStart + 1; // skip quote\n+                        int end = start + rootId.length();\n+                        edits.add(new Edit(start, end, referenceId));\n+                    }\n+                }\n+            }\n+        }\n+\n+        return edits;\n+    }\n+\n+    /** Returns the id to be used for the include tag itself (may be null) */\n+    private String getReferenceId() {\n+        String rootId = getRootId();\n+        if (rootId != null) {\n+            return rootId + \""_ref\"";\n+        }\n+\n+        return null;\n+    }\n+\n+    /** Get the id of the root selected element, if any */\n+    private String getRootId() {\n+        Element primaryNode = getPrimaryNode();\n+        if (primaryNode != null) {\n+            String oldId = primaryNode.getAttributeNS(ANDROID_URI, ATTR_ID);\n+            if (oldId.length() > 0) {\n+                return oldId;\n+            }\n+        }\n+\n+        return null;\n     }\n \n     private boolean writeFile(IFile file, String content) {\n@@ -354,36 +466,35 @@ public class ExtractIncludeAction extends Action {\n         }\n     }\n \n-    /** Replace existing elements in the source file and insert {@code <include>} */\n-    private void replaceWithInclude(final String newName, final int start, final int end,\n-            final String androidNsPrefix) {\n-        final LayoutEditor editor = mCanvas.getLayoutEditor();\n-        editor.wrapUndoEditXmlModel(\""Extract As Include\"", new Runnable() {\n-            public void run() {\n-                IStructuredDocument document = editor.getStructuredDocument();\n-                if (document != null) {\n-                    String include = computeIncludeString(newName, androidNsPrefix);\n-                    try {\n-                        document.replace(start, end - start, include);\n-                    } catch (BadLocationException e) {\n-                        AdtPlugin.log(e, \""Cannot insert <include> tag\"");\n-                        return;\n-                    }\n-                }\n-            }\n-        });\n-    }\n-\n     /**\n      * Compute the actual {@code <include>} string to be inserted in place of the old\n      * selection\n      */\n-    private String computeIncludeString(String newName, String androidNsPrefix) {\n+    private String computeIncludeString(String newName, String androidNsPrefix,\n+            String referenceId) {\n         StringBuilder sb = new StringBuilder();\n         sb.append(\""<include layout=\\\""@layout/\""); //$NON-NLS-1$\n         sb.append(newName);\n         sb.append('\""');\n \n+        // Create new id for the include itself\n+        if (referenceId != null) {\n+            sb.append(androidNsPrefix);\n+            sb.append(':');\n+            sb.append(ATTR_ID);\n+            sb.append('=').append('\""');\n+            sb.append(referenceId);\n+            sb.append('\""').append(' ');\n+        }\n+\n+        // Add id string, unless it's a <merge>, since we may need to adjust any layout\n+        // references to apply to the <include> tag instead\n+        // TODO: Use refactoring infrastructure to handle this part\n+\n+        // I should move all the layout_ attributes as well\n+        // I also need to duplicate and modify the id and then replace\n+        // everything else in the file with this new id...\n+\n         // HACK: see issue 13494: We must duplicate the width/height attributes on the\n         // <include> statement for designtime rendering only\n         Element primaryNode = getPrimaryNode();\n@@ -411,7 +522,7 @@ public class ExtractIncludeAction extends Action {\n             sb.append(':');\n             sb.append(ATTR_LAYOUT_WIDTH);\n             sb.append('=').append('\""');\n-            sb.append(width);\n+            sb.append(DescriptorsUtils.toXmlAttributeValue(width));\n             sb.append('\""');\n         }\n         if (height != null) {\n@@ -420,10 +531,34 @@ public class ExtractIncludeAction extends Action {\n             sb.append(':');\n             sb.append(ATTR_LAYOUT_HEIGHT);\n             sb.append('=').append('\""');\n-            sb.append(height);\n+            sb.append(DescriptorsUtils.toXmlAttributeValue(height));\n             sb.append('\""');\n         }\n \n+        // Duplicate all the other layout attributes as well\n+        if (primaryNode != null) {\n+            NamedNodeMap attributes = primaryNode.getAttributes();\n+            for (int i = 0, n = attributes.getLength(); i < n; i++) {\n+                Node attr = attributes.item(i);\n+                String name = attr.getLocalName();\n+                if (name.startsWith(ATTR_LAYOUT_PREFIX)\n+                        && ANDROID_URI.equals(attr.getNamespaceURI())) {\n+                    if (name.equals(ATTR_LAYOUT_WIDTH) || name.equals(ATTR_LAYOUT_HEIGHT)) {\n+                        // Already handled\n+                        continue;\n+                    }\n+\n+                    sb.append(' ');\n+                    sb.append(androidNsPrefix);\n+                    sb.append(':');\n+                    sb.append(name);\n+                    sb.append('=').append('\""');\n+                    sb.append(DescriptorsUtils.toXmlAttributeValue(attr.getNodeValue()));\n+                    sb.append('\""');\n+                }\n+            }\n+        }\n+\n         sb.append(\""/>\"");\n         return sb.toString();\n     }\n@@ -436,10 +571,11 @@ public class ExtractIncludeAction extends Action {\n         try {\n             IStructuredDocument document = editor.getStructuredDocument();\n             String xml = document.get(start, end - start);\n+            Element primaryNode = getPrimaryNode();\n+            xml = stripTopLayoutAttributes(primaryNode, start, xml);\n             xml = dedent(xml);\n \n             // Wrap siblings in <merge>?\n-            Element primaryNode = getPrimaryNode();\n             if (primaryNode == null) {\n                 StringBuilder sb = new StringBuilder();\n                 sb.append(\""<merge>\\n\""); //$NON-NLS-1$\n@@ -461,6 +597,65 @@ public class ExtractIncludeAction extends Action {\n         }\n     }\n \n+    /** Remove sections of the document that correspond to top level layout attributes;\n+     * these are placed on the include element instead */\n+    private String stripTopLayoutAttributes(Element primaryNode, int start, String xml) {\n+        if (primaryNode != null) {\n+            // List of attributes to remove\n+            //IndexedRegion attRegion = (IndexedRegion) attrs.item(i);\n+            List<IndexedRegion> skip = new ArrayList<IndexedRegion>();\n+            NamedNodeMap attributes = primaryNode.getAttributes();\n+            for (int i = 0, n = attributes.getLength(); i < n; i++) {\n+                Node attr = attributes.item(i);\n+                String name = attr.getLocalName();\n+                if (name.startsWith(ATTR_LAYOUT_PREFIX)\n+                        && ANDROID_URI.equals(attr.getNamespaceURI())) {\n+                    if (name.equals(ATTR_LAYOUT_WIDTH) || name.equals(ATTR_LAYOUT_HEIGHT)) {\n+                        // These are special and are left in\n+                        continue;\n+                    }\n+\n+                    if (attr instanceof IndexedRegion) {\n+                        skip.add((IndexedRegion) attr);\n+                    }\n+                }\n+            }\n+            if (skip.size() > 0) {\n+                Collections.sort(skip, new Comparator<IndexedRegion>() {\n+                    // Sort in start order\n+                    public int compare(IndexedRegion r1, IndexedRegion r2) {\n+                        return r1.getStartOffset() - r2.getStartOffset();\n+                    }\n+                });\n+\n+                // Successively cut out the various layout attributes\n+                // TODO remove adjacent whitespace too (but not newlines, unless they\n+                // are newly adjacent)\n+                StringBuilder sb = new StringBuilder(xml.length());\n+                int nextStart = 0;\n+\n+                // Copy out all the sections except the skip sections\n+                for (IndexedRegion r : skip) {\n+                    int regionStart = r.getStartOffset();\n+                    // Adjust to string offsets since we've copied the string out of\n+                    // the document\n+                    regionStart -= start;\n+\n+                    sb.append(xml.substring(nextStart, regionStart));\n+\n+                    nextStart = regionStart + r.getLength();\n+                }\n+                if (nextStart < xml.length()) {\n+                    sb.append(xml.substring(nextStart));\n+                }\n+\n+                return sb.toString();\n+            }\n+        }\n+\n+        return xml;\n+    }\n+\n     private static String getIndent(String line, int max) {\n         int i = 0;\n         int n = Math.min(max, line.length());\n@@ -571,4 +766,63 @@ public class ExtractIncludeAction extends Action {\n \n         return Pair.of(start, end);\n     }\n+\n+    /** Apply edits into document under an undo lock */\n+    private void applyEdits(String label, final List<Edit> edits) {\n+        // Process the edits in reverse document position order to ensure\n+        // that the offsets aren't affected by other edits\n+        Collections.sort(edits);\n+        final LayoutEditor editor = mCanvas.getLayoutEditor();\n+        editor.wrapUndoEditXmlModel(label, new Runnable() {\n+            public void run() {\n+                IStructuredDocument document = editor.getStructuredDocument();\n+                if (document != null) {\n+                    try {\n+                        for (Edit edit : edits) {\n+                            edit.apply(document);\n+                        }\n+                    } catch (BadLocationException e) {\n+                        AdtPlugin.log(e, \""Cannot insert <include> tag\"");\n+                        return;\n+                    }\n+                }\n+            }\n+        });\n+    }\n+\n+    /**\n+     * Edit operation (insert, delete, replace) at a given offset - a collection of these\n+     * can be sorted in reverse offset order such that they can be applied successively\n+     * without having to updated offsets\n+     * <p>\n+     * TODO: When rewriting this extract operation to the refactoring framework, use\n+     * refactoring framework's change list instead\n+     */\n+    private static class Edit implements Comparable<Edit> {\n+        private final int mStart;\n+        private final int mEnd;\n+        private final String mReplaceWith;\n+\n+        public Edit(int start, int end, String replaceWith) {\n+            super();\n+            mStart = start;\n+            mEnd = end;\n+            mReplaceWith = replaceWith;\n+        }\n+\n+        void apply(IStructuredDocument document) throws BadLocationException {\n+            document.replace(mStart, mEnd - mStart, mReplaceWith);\n+        }\n+\n+        public int compareTo(Edit o) {\n+            // Sort in *reverse* offset order\n+            return o.mStart - mStart;\n+        }\n+\n+        @Override\n+        public String toString() {\n+            return \""Edit [start=\"" + mStart + \"", end=\"" + mEnd + \"", replaceWith=\"" + mReplaceWith\n+                    + \""]\"";\n+        }\n+    }\n }\n""}","refactor 
"
11834,Rebecca Zavin,DSS2: Add panel width and height to timings struct and extract them into var,"['arch/arm/plat-omap/include/mach/display.h', 'drivers/video/omap2/omapfb/omapfb-main.c', 'drivers/video/omap2/dss/display.c']","DSS2: Add panel width and height to timings struct and extract them into var

Adds the panel width and height to the timing struct so they can be extracted
into the fb_var_screeninfo struct at init time.

Change-Id: I283967bcbb47d95328233e1f4a0ae23a8dbe2b14
Signed-off-by: Rebecca Schultz Zavin <rebecca@android.com>",https://android-review.googlesource.com/c/11834,"feature 
",feature,Feature;,"{""display.h"": ""@@ -228,6 +228,10 @@ struct omap_video_timings {\n \tu16 x_res;\n \t/* Unit: pixels */\n \tu16 y_res;\n+\t/* width of display in mm */\n+\tu16 w;\n+\t/* hieght of display in mm */\n+\tu16 h;\n \t/* Unit: KHz */\n \tu32 pixel_clock;\n \t/* Unit: pixel clocks */\n@@ -435,6 +439,8 @@ struct omap_dss_device {\n \n \tvoid (*get_resolution)(struct omap_dss_device *dssdev,\n \t\t\tu16 *xres, u16 *yres);\n+\tvoid (*get_size)(struct omap_dss_device *dssdev,\n+\t\t\tu16 *w, u16 *h);\n \tint (*get_recommended_bpp)(struct omap_dss_device *dssdev);\n \n \tint (*check_timings)(struct omap_dss_device *dssdev,\n"", ""display.c"": ""@@ -310,6 +310,12 @@ static void default_get_resolution(struct omap_dss_device *dssdev,\n \t*yres = dssdev->panel.timings.y_res;\n }\n \n+static void default_get_size(struct omap_dss_device *dssdev, u16 *w, u16* h)\n+{\n+\t*w = dssdev->panel.timings.w;\n+\t*h = dssdev->panel.timings.h;\n+}\n+\n void default_get_overlay_fifo_thresholds(enum omap_plane plane,\n \t\tu32 fifo_size, enum omap_burst_size *burst_size,\n \t\tu32 *fifo_low, u32 *fifo_high)\n@@ -426,6 +432,7 @@ void dss_init_device(struct platform_device *pdev,\n \t}\n \n \tdssdev->get_resolution = default_get_resolution;\n+\tdssdev->get_size = default_get_size;\n \tdssdev->get_recommended_bpp = default_get_recommended_bpp;\n \tdssdev->wait_vsync = default_wait_vsync;\n \n"", ""omapfb-main.c"": ""@@ -1617,6 +1617,10 @@ int omapfb_fb_init(struct omapfb2_device *fbdev, struct fb_info *fbi)\n \t\tu16 w, h;\n \t\tint rotation = (var->rotate + ofbi->rotation[0]) % 4;\n \n+\t\tdisplay->get_size(display, &w, &h);\n+\t\tvar->width = w;\n+\t\tvar->height = h;\n+\n \t\tdisplay->get_resolution(display, &w, &h);\n \n \t\tif (rotation == FB_ROTATE_CW ||\n""}","feature, refactor 
"
11810,PacketVideo CM,RIO-7458: Further fixes for building OpenCORE on win32 and android-x86. (minor additional change 2),"['oscl/oscl/osclutil/src/oscl_string.h', 'engines/2way/src/pv_2way_sdkinfo.h', 'engines/player/src/pv_player_sdkinfo.h', 'engines/author/src/pv_author_sdkinfo.h']",RIO-7458: Further fixes for building OpenCORE on win32 and android-x86. (minor additional change 2),https://android-review.googlesource.com/c/11810,"bug 
",bug,Bug;,"{""pv_2way_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PV2WAY_ENGINE_SDKINFO_LABEL \""959509\""\n+#define PV2WAY_ENGINE_SDKINFO_LABEL \""959553\""\n #define PV2WAY_ENGINE_SDKINFO_DATE 0x20090911\n \n #endif //PV_2WAY_SDKINFO_H_INCLUDED\n"", ""pv_author_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""959509\""\n+#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""959553\""\n #define PVAUTHOR_ENGINE_SDKINFO_DATE 0x20090911\n \n #endif //PV_AUTHOR_SDKINFO_H_INCLUDED\n"", ""pv_player_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVPLAYER_ENGINE_SDKINFO_LABEL \""959509\""\n+#define PVPLAYER_ENGINE_SDKINFO_LABEL \""959553\""\n #define PVPLAYER_ENGINE_SDKINFO_DATE 0x20090911\n \n #endif //PV_PLAYER_SDKINFO_H_INCLUDED\n"", ""oscl_string.h"": ""@@ -266,7 +266,7 @@ class OSCL_IMPORT_REF OSCL_wString\n \n         virtual const chartype* get_cstr() const = 0;\n \n-        OSCL_IMPORT_REF virtual bool is_writable() const;\n+        virtual bool is_writable() const;\n \n         virtual chartype* get_str() const = 0;\n \n""}","feature 
"
23528,Brian Muramatsu,"Revert ""Check ""Unknown Sources"" is Enabled by Default""",['tests/tests/provider/src/android/provider/cts/Settings_SecureTest.java'],"Revert ""Check ""Unknown Sources"" is Enabled by Default""

This reverts commit 594e9852cc4d34e966f2389c8be67aebb69fdc53.",https://android-review.googlesource.com/c/23528,"bug, test 
",test,Others;,"{""Settings_SecureTest.java"": ""@@ -23,7 +23,6 @@ import dalvik.annotation.TestTargets;\n \n import android.content.ContentResolver;\n import android.net.Uri;\n-import android.provider.Settings;\n import android.provider.Settings.Secure;\n import android.provider.Settings.SettingNotFoundException;\n import android.test.AndroidTestCase;\n@@ -179,9 +178,4 @@ public class Settings_SecureTest extends AndroidTestCase {\n         assertNotNull(uri);\n         assertEquals(Uri.withAppendedPath(Secure.CONTENT_URI, name), uri);\n     }\n-\n-    public void testUnknownSourcesOffByDefault() throws SettingNotFoundException {\n-        assertEquals(\""Device should not ship with 'Unknown Sources' enabled by default.\"",\n-                0, Secure.getInt(cr, Settings.Secure.INSTALL_NON_MARKET_APPS));\n-    }\n }\n""}","bug, test 
"
22721,RaphaÃ«l Moll,"Merge ""Fix ANDROID_SDK_HOME handling.""",['android/avd/util.c'],"Merge ""Fix ANDROID_SDK_HOME handling.""

A previous patch introducing the ""emulator"" launcher program
did regress the way ANDROID_SDK_HOME is parsed. Fix that by
actually trusting bufprint_config_path() to always do the right
thing :-)

 (Merged from original id: I11a13fea95727ee9c487595fd4ae5e81805986da)

Change-Id: I999de28a1cba530bc48e4219e5586ae20d80127b",https://android-review.googlesource.com/c/22721,"merge, bug 
","merge,bug",Merge;,"{""util.c"": ""@@ -100,19 +100,12 @@ path_getRootIniPath( const char*  avdName )\n char*\n path_getSdkHome(void)\n {\n-    const char* sdkHome = getenv(\""ANDROID_SDK_HOME\"");\n-\n-    if (sdkHome == NULL || *sdkHome == '\\0') {\n-        char temp[PATH_MAX], *p=temp, *end=p+sizeof(temp);\n-        p = bufprint_config_path(temp, end);\n-        if (p >= end) {\n-            APANIC(\""User path too long!: %s\\n\"", temp);\n-        }\n-        sdkHome = strdup(temp);\n-    } else {\n-        sdkHome = strdup(sdkHome);\n+    char temp[PATH_MAX], *p=temp, *end=p+sizeof(temp);\n+    p = bufprint_config_path(temp, end);\n+    if (p >= end) {\n+        APANIC(\""User path too long!: %s\\n\"", temp);\n     }\n-    return (char*)sdkHome;\n+    return strdup(temp);\n }\n \n \n""}","merge 
"
12712,PacketVideo CM,RIO-7951: Added pvlogger_empty_layout.h as an optional logger output string format that appends nothing to the output string.,"['oscl/oscl/config/shared/osclconfig_unix_common.h', 'oscl/pvlogger/build/make/local.mk', 'oscl/pvlogger/src/pvlogger_empty_layout.h', 'oscl/pvlogger/Android.mk', 'oscl/oscl/config/shared/osclconfig_check.h', 'oscl/oscl/config/shared/osclconfig_time_check.h', 'engines/player/src/pv_player_sdkinfo.h', 'oscl/oscl/config/linux/osclconfig_time.h', 'oscl/oscl/config/android/osclconfig_unix_android.h', 'engines/author/src/pv_author_sdkinfo.h', 'oscl/oscl/config/android/osclconfig_time.h', 'engines/2way/src/pv_2way_sdkinfo.h', 'oscl/oscl/config/shared/osclconfig_no_os.h']",RIO-7951: Added pvlogger_empty_layout.h as an optional logger output string format that appends nothing to the output string.,https://android-review.googlesource.com/c/12712,"feature
",feature,Feature;,"{""pv_2way_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PV2WAY_ENGINE_SDKINFO_LABEL \""1073672\""\n+#define PV2WAY_ENGINE_SDKINFO_LABEL \""1073802\""\n #define PV2WAY_ENGINE_SDKINFO_DATE 0x20091109\n \n #endif //PV_2WAY_SDKINFO_H_INCLUDED\n"", ""pv_author_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""1073672\""\n+#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""1073802\""\n #define PVAUTHOR_ENGINE_SDKINFO_DATE 0x20091109\n \n #endif //PV_AUTHOR_SDKINFO_H_INCLUDED\n"", ""pv_player_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVPLAYER_ENGINE_SDKINFO_LABEL \""1073672\""\n+#define PVPLAYER_ENGINE_SDKINFO_LABEL \""1073802\""\n #define PVPLAYER_ENGINE_SDKINFO_DATE 0x20091109\n \n #endif //PV_PLAYER_SDKINFO_H_INCLUDED\n"", ""osclconfig_time.h"": ""@@ -41,6 +41,7 @@\n \n \n #define OSCL_HAS_UNIX_TIME_FUNCS        1\n+#define OSCL_HAS_MSWIN_TIME_FUNCS       0\n \n \n typedef struct timeval OsclBasicTimeStruct;\n"", ""osclconfig_unix_android.h"": ""@@ -63,7 +63,6 @@\n \n #define OSCL_HAS_UNIX_SUPPORT               1\n #define OSCL_HAS_MSWIN_SUPPORT              0\n-#define OSCL_HAS_MSWIN_TIME_SUPPORT         0\n #define OSCL_HAS_MSWIN_PARTIAL_SUPPORT    0\n #define OSCL_HAS_SYMBIAN_SUPPORT            0\n \n"", ""osclconfig_check.h"": ""@@ -140,15 +140,6 @@ Otherwise it should be set to 0.\n #error \""ERROR: OSCL_HAS_MSWIN_SUPPORT has to be defined to either 1 or 0\""\n #endif\n \n-/**\n-\\def OSCL_HAS_MSWIN_TIME_SUPPORT macro should be set to 1 if\n-the target platform supports the WinMobile API.\n-Otherwise it should be set to 0.\n-*/\n-#ifndef OSCL_HAS_MSWIN_TIME_SUPPORT\n-#error \""ERROR: OSCL_HAS_MSWIN_TIME_SUPPORT has to be defined to either 1 or 0\""\n-#endif\n-\n /**\n \\def OSCL_HAS_MSWIN_PARTIAL_SUPPORT macro should be set to 1 if\n the target platform supports the WinMobile API.\n"", ""osclconfig_no_os.h"": ""@@ -30,7 +30,6 @@\n #define OSCL_HAS_UNIX_SUPPORT               0\n #define OSCL_HAS_MSWIN_SUPPORT              0\n #define OSCL_HAS_MSWIN_PARTIAL_SUPPORT      0\n-#define OSCL_HAS_MSWIN_TIME_SUPPORT    0\n #define OSCL_HAS_SYMBIAN_SUPPORT            0\n #define OSCL_HAS_SAVAJE_SUPPORT             0\n #define OSCL_HAS_PV_C_OS_SUPPORT            0\n@@ -45,6 +44,7 @@\n //osclconfig_time\n #define OSCL_HAS_PV_C_OS_TIME_FUNCS 0\n #define OSCL_HAS_UNIX_TIME_FUNCS    0\n+#define OSCL_HAS_MSWIN_TIME_FUNCS   0\n \n //osclconfig_util\n #define OSCL_HAS_SYMBIAN_TIMERS 0\n"", ""osclconfig_time_check.h"": ""@@ -30,6 +30,15 @@ Otherwise it should be set to 0.\n #error \""ERROR: OSCL_HAS_UNIX_TIME_FUNCS has to be defined to either 1 or 0\""\n #endif\n \n+/**\n+OSCL_HAS_MSWIN_TIME_FUNCS macro should be set to 1 if\n+the target platform supports the WinMobile API.\n+Otherwise it should be set to 0.\n+*/\n+#ifndef OSCL_HAS_MSWIN_TIME_FUNCS\n+#error \""ERROR: OSCL_HAS_MSWIN_TIME_FUNCS has to be defined to either 1 or 0\""\n+#endif\n+\n /**\n OsclBasicTimeStruct type should be defined to the platform-specific\n time of day type.\n"", ""osclconfig_unix_common.h"": ""@@ -63,7 +63,6 @@\n \n #define OSCL_HAS_UNIX_SUPPORT               1\n #define OSCL_HAS_MSWIN_SUPPORT              0\n-#define OSCL_HAS_MSWIN_TIME_SUPPORT         0\n #define OSCL_HAS_MSWIN_PARTIAL_SUPPORT    0\n #define OSCL_HAS_SYMBIAN_SUPPORT            0\n \n"", ""Android.mk"": ""@@ -26,6 +26,7 @@ LOCAL_COPY_HEADERS := \\\n  \tsrc/pvlogger_file_appender.h \\\n  \tsrc/pvlogger_mem_appender.h \\\n  \tsrc/pvlogger_stderr_appender.h \\\n- \tsrc/pvlogger_time_and_id_layout.h\n+ \tsrc/pvlogger_time_and_id_layout.h \\\n+ \tsrc/pvlogger_empty_layout.h\n \n include $(BUILD_STATIC_LIBRARY)\n"", ""local.mk"": ""@@ -18,7 +18,8 @@ HDRS := \\\n     pvlogger_file_appender.h \\\n     pvlogger_mem_appender.h \\\n     pvlogger_stderr_appender.h \\\n-    pvlogger_time_and_id_layout.h\n+    pvlogger_time_and_id_layout.h \\\n+    pvlogger_empty_layout.h\n \n \n include $(MK)/library.mk\n"", ""pvlogger_empty_layout.h"": ""@@ -0,0 +1,75 @@\n+/* ------------------------------------------------------------------\n+ * Copyright (C) 1998-2009 PacketVideo\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied.\n+ * See the License for the specific language governing permissions\n+ * and limitations under the License.\n+ * -------------------------------------------------------------------\n+ */\n+#ifndef PVLOGGER_EMPTY_LAYOUT_H_INCLUDED\n+#define PVLOGGER_EMPTY_LAYOUT_H_INCLUDED\n+\n+\n+#ifndef PVLOGGERACCESSORIES_H_INCLUDED\n+#include \""pvlogger_accessories.h\""\n+#endif\n+\n+#ifndef OSCL_SNPRINTF_H_INCLUDED\n+#include \""oscl_snprintf.h\""\n+#endif\n+\n+#ifndef OSCL_THREAD_H_INCLUDED\n+#include \""oscl_thread.h\""\n+#endif\n+\n+#define OSCLCLOCKUNIT_SEC = 2\n+/**\n+ * Class: MsgFormatter\n+ *\n+ * This class currently implements formatting of text messages. A time stamp is\n+ * appended to each meessage, prior to formatting. For message buffers, time stamp addition\n+ * is performed, but no formatting is done.\n+ *\n+ */\n+\n+class EmptyLayout : public PVLoggerLayout\n+{\n+    public:\n+        EmptyLayout() {};\n+        virtual ~EmptyLayout() {};\n+\n+        typedef PVLoggerLayout::message_id_type message_id_type;\n+\n+        int32 FormatString(char* formatBuf, int32 formatBufSize,\n+                           message_id_type msgID, const char * fmt, va_list va)\n+        {\n+            OSCL_UNUSED_ARG(msgID);\n+            return oscl_vsnprintf(formatBuf,\n+                                  formatBufSize,\n+                                  fmt, va);\n+        };\n+\n+        int32 FormatOpaqueMessage(char* formatBuf, int32 maxformatBufSize,\n+                                  message_id_type msgID, int32 numPairs, va_list va)\n+        {\n+            OSCL_UNUSED_ARG(formatBuf);\n+            OSCL_UNUSED_ARG(maxformatBufSize);\n+            OSCL_UNUSED_ARG(msgID);\n+            OSCL_UNUSED_ARG(numPairs);\n+            OSCL_UNUSED_ARG(va);\n+            return 0;\n+        }\n+};\n+\n+#endif // PVLOGGER_EMPTY_LAYOUT_H_INCLUDED\n+\n+\n""}","bug, refactor 
"
18577,Brian Muramatsu,More CTS Test Runner Fixes,"['tools/host/src/com/android/cts/TestDevice.java', 'tests/tests/database/src/android/database/cts/DatabaseCursorTest.java', 'tests/tests/permission/src/android/permission/cts/NoActivityRelatedPermissionTest.java', 'tests/tests/graphics/src/android/graphics/cts/NinePatchTest.java', 'tests/core/runner/src/android/test/InstrumentationCtsTestRunner.java']","More CTS Test Runner Fixes

Changing the initial status of tests now to error, and
making InstrumentationCtsTestRunner explicitly report
when it has omitted a test due to profile or feature
requirements only.

More background on why:

Initially, the starting test status was set to PASS.
This seemed like a bug, because tests that did not
get a result back from the test runner would automatically
pass.

I noticed this when adding the profile/feature annotations,
so I changed the test status to NOT_EXECUTED. However,
I discovered that batch test runner would rerun any tests
that were not executed, so any tests that were discarded
by the annotations would be rerun infinitely..

So then...I changed the test status to start off as OMITTED,
so that discarded tests which don't produce any output would
get flagged as OMITTED and not cause infinite retrying.

However, this uncovered a whole class of tests that were
being omitted due to test errors (previously marked PASS even
though they were failing). This is because the tests would
fail to execute as a batch and then CTS as part of its algorithm
would run them individually again. However, due to an error
of being unable to load the test class, they would be marked
as PASS (before the OMITTED change), because there would be
output from the runner...

By setting the default status to ERROR, there won't be any tests
that get away as PASS due to getting no output from the runner.
Unfortunately, this means any tests that aren't executed or
thrown out by annotations, will be flagged. There seems to be
a couple of tests marked with @Suppress that will need to be
changed to @BrokenTest. There is probably a more involved fix
to fix these things, but its probably not worth it at this time.

Change-Id: If1d561ee0e8c4919287469238d29c72c1ba0475c",https://android-review.googlesource.com/c/18577,"bug, test 
","test,bug",Bug;Test;,"{""InstrumentationCtsTestRunner.java"": ""@@ -25,6 +25,7 @@ import dalvik.annotation.SideEffect;\n import android.annotation.cts.Profile;\n import android.annotation.cts.RequiredFeatures;\n import android.annotation.cts.SupportedProfiles;\n+import android.app.Instrumentation;\n import android.app.KeyguardManager;\n import android.content.Context;\n import android.content.pm.FeatureInfo;\n@@ -68,6 +69,10 @@ public class InstrumentationCtsTestRunner extends InstrumentationTestRunner {\n \n     private static final String ARGUMENT_PROFILE = \""profile\"";\n \n+    private static final String REPORT_VALUE_ID = \""InstrumentationCtsTestRunner\"";\n+\n+    private static final int REPORT_VALUE_RESULT_OMITTED = -3;\n+\n     /** Profile of the device being tested or null to run all tests regardless of profile. */\n     private Profile mProfile;\n \n@@ -256,9 +261,42 @@ public class InstrumentationCtsTestRunner extends InstrumentationTestRunner {\n         return builderRequirements;\n     }\n \n+    /**\n+     * Send back an indication that a test was omitted. InstrumentationTestRunner won't run omitted\n+     * tests, but CTS needs to know that the test was omitted. Otherwise, it will attempt to rerun\n+     * the test thinking that ADB must have crashed or something.\n+     */\n+    private void sendOmittedStatus(TestMethod t) {\n+        Bundle bundle = new Bundle();\n+        bundle.putString(Instrumentation.REPORT_KEY_IDENTIFIER, REPORT_VALUE_ID);\n+        bundle.putInt(InstrumentationTestRunner.REPORT_KEY_NUM_TOTAL, 1);\n+        bundle.putInt(InstrumentationTestRunner.REPORT_KEY_NUM_CURRENT, 1);\n+        bundle.putString(InstrumentationTestRunner.REPORT_KEY_NAME_CLASS,\n+                t.getEnclosingClassname());\n+        bundle.putString(InstrumentationTestRunner.REPORT_KEY_NAME_TEST,\n+                t.getName());\n+\n+        // First status message causes CTS to print out the test name like \""Class#test...\""\n+        sendStatus(InstrumentationTestRunner.REPORT_VALUE_RESULT_START, bundle);\n+\n+        // Second status message causes CTS to complete the line like \""Class#test...(omitted)\""\n+        sendStatus(REPORT_VALUE_RESULT_OMITTED, bundle);\n+    }\n+\n     private Predicate<TestMethod> getProfilePredicate(final Profile specifiedProfile) {\n         return new Predicate<TestMethod>() {\n             public boolean apply(TestMethod t) {\n+                if (isValidTest(t)) {\n+                    // InstrumentationTestRunner will run the test and send back results.\n+                    return true;\n+                } else {\n+                    // InstrumentationTestRunner WON'T run the test, so send back omitted status.\n+                    sendOmittedStatus(t);\n+                    return false;\n+                }\n+            }\n+\n+            private boolean isValidTest(TestMethod t) {\n                 Set<Profile> profiles = new HashSet<Profile>();\n                 add(profiles, t.getAnnotation(SupportedProfiles.class));\n                 add(profiles, t.getEnclosingClass().getAnnotation(SupportedProfiles.class));\n@@ -290,6 +328,17 @@ public class InstrumentationCtsTestRunner extends InstrumentationTestRunner {\n     private Predicate<TestMethod> getFeaturePredicate() {\n         return new Predicate<TestMethod>() {\n             public boolean apply(TestMethod t) {\n+                if (isValidTest(t)) {\n+                    // InstrumentationTestRunner will run the test and send back results.\n+                    return true;\n+                } else {\n+                    // InstrumentationTestRunner WON'T run the test, so send back omitted status.\n+                    sendOmittedStatus(t);\n+                    return false;\n+                }\n+            }\n+\n+            private boolean isValidTest(TestMethod t) {\n                 Set<String> features = new HashSet<String>();\n                 add(features, t.getAnnotation(RequiredFeatures.class));\n                 add(features, t.getEnclosingClass().getAnnotation(RequiredFeatures.class));\n"", ""DatabaseCursorTest.java"": ""@@ -18,11 +18,6 @@ package android.database.cts;\n \n import dalvik.annotation.BrokenTest;\n \n-import java.io.File;\n-import java.util.Arrays;\n-import java.util.Random;\n-\n-import junit.framework.TestCase;\n import android.content.ContentValues;\n import android.content.Context;\n import android.database.Cursor;\n@@ -40,9 +35,12 @@ import android.test.AndroidTestCase;\n import android.test.PerformanceTestCase;\n import android.test.suitebuilder.annotation.LargeTest;\n import android.test.suitebuilder.annotation.MediumTest;\n-import android.test.suitebuilder.annotation.Suppress;\n import android.util.Log;\n \n+import java.io.File;\n+import java.util.Arrays;\n+import java.util.Random;\n+\n public class DatabaseCursorTest extends AndroidTestCase implements PerformanceTestCase {\n     private static final String sString1 = \""this is a test\"";\n     private static final String sString2 = \""and yet another test\"";\n@@ -371,7 +369,7 @@ public class DatabaseCursorTest extends AndroidTestCase implements PerformanceTe\n     }\n \n     //@Large\n-    @Suppress\n+    @BrokenTest(\""Previously suppressed...\"")\n     public void testLoadingThreadDelayRegisterData() throws Exception {\n         mDatabase.execSQL(\""CREATE TABLE test (_id INTEGER PRIMARY KEY, data INT);\"");\n \n"", ""NinePatchTest.java"": ""@@ -18,6 +18,7 @@ package android.graphics.cts;\n \n import com.android.cts.stub.R;\n \n+import dalvik.annotation.BrokenTest;\n import dalvik.annotation.TestLevel;\n import dalvik.annotation.TestTargetClass;\n import dalvik.annotation.TestTargetNew;\n@@ -34,7 +35,6 @@ import android.graphics.Rect;\n import android.graphics.RectF;\n import android.graphics.Region;\n import android.test.AndroidTestCase;\n-import android.test.suitebuilder.annotation.Suppress;\n \n @TestTargetClass(NinePatch.class)\n public class NinePatchTest extends AndroidTestCase {\n@@ -174,7 +174,7 @@ public class NinePatchTest extends AndroidTestCase {\n         method = \""hasAlpha\"",\n         args = {}\n     )\n-    @Suppress // Suppressed for current release\n+    @BrokenTest(value=\""Suppressed for current release\"")\n     public void testHasAlpha() {\n         assertFalse(mNinePatch.hasAlpha());\n         assertEquals(mNinePatch.hasAlpha(), mBitmap.hasAlpha());\n"", ""NoActivityRelatedPermissionTest.java"": ""@@ -56,7 +56,6 @@ public class NoActivityRelatedPermissionTest\n      */\n     @UiThreadTest\n     @MediumTest\n-    @Suppress\n     @BrokenTest(\""This test passes, but crashes the UI thread later on. See issues 1909470, 1910487\"")\n     public void testSystemAlertWindow() {\n         final int[] types = new int[] {\n"", ""TestDevice.java"": ""@@ -1212,6 +1212,7 @@ public class TestDevice implements DeviceObserver {\n         public final static int STATUS_PASS = 0;\n         public final static int STATUS_FAIL = -1;\n         public final static int STATUS_ERROR = -2;\n+        public final static int STATUS_OMITTED = -3;\n \n         private ArrayList<String> mResultLines;\n \n@@ -1230,7 +1231,7 @@ public class TestDevice implements DeviceObserver {\n             mResultLines = new ArrayList<String>();\n             mStackTrace = null;\n             mFailedMsg = null;\n-            mResultCode = CtsTestResult.CODE_OMITTED;\n+            mResultCode = CtsTestResult.CODE_ERROR;\n         }\n \n         /** {@inheritDoc} */\n@@ -1426,6 +1427,10 @@ public class TestDevice implements DeviceObserver {\n             case STATUS_ERROR:\n                 mResultCode = CtsTestResult.CODE_FAIL;\n                 break;\n+\n+            case STATUS_OMITTED:\n+                mResultCode = CtsTestResult.CODE_OMITTED;\n+                break;\n             }\n         }\n \n@@ -1491,6 +1496,10 @@ public class TestDevice implements DeviceObserver {\n                 case STATUS_PASS:\n                     mResultCode = CtsTestResult.CODE_PASS;\n                     break;\n+\n+                case STATUS_OMITTED:\n+                    mResultCode = CtsTestResult.CODE_OMITTED;\n+                    break;\n                 }\n                 resultLines.removeAll(resultLines);\n             }\n@@ -1542,6 +1551,10 @@ public class TestDevice implements DeviceObserver {\n                     mTest.setResult(new CtsTestResult(\n                             CtsTestResult.CODE_FAIL, mFailedMsg, mStackTrace));\n                     break;\n+\n+                case STATUS_OMITTED:\n+                    mTest.setResult(new CtsTestResult(CtsTestResult.CODE_OMITTED));\n+                    break;\n                 }\n             }\n             // report status even if no matching test was found\n""}","test,bug,refactor 
"
14311,San Mehat,proc: pagemap: Hold mmap_sem during page walk,['fs/proc/task_mmu.c'],"proc: pagemap: Hold mmap_sem during page walk

In initial design, walk_page_range() was designed just for walking page
table and it didn't require mmap_sem.  Now, find_vma() etc..  are used
in walk_page_range() and we need mmap_sem around it.

This patch adds mmap_sem around walk_page_range().

Because /proc/<pid>/pagemap's callback routine use put_user(), we have
to get rid of it to do sane fix.

Changelog: 2010/Apr/2
 - fixed start_vaddr and end overflow
Changelog: 2010/Apr/1
 - fixed start_vaddr calculation
 - removed unnecessary cast.
 - removed unnecessary change in smaps.
 - use GFP_TEMPORARY instead of GFP_KERNEL

Signed-off-by: KAMEZAWA Hiroyuki <kamezawa.hiroyu@jp.fujitsu.com>
Cc: Matt Mackall <mpm@selenic.com>
Cc: KOSAKI Motohiro <kosaki.motohiro@jp.fujitsu.com>
Cc: Brian Swetland <swetland@google.com>
Cc: Dave Hansen <haveblue@us.ibm.com>
Cc: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: San Mehat <san@google.com>
[ Fixed kmalloc failure return code as per Matt ]
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>",https://android-review.googlesource.com/c/14311,"bug, refactor 
","bug,refactor",Bug;Deprecat;,"{""task_mmu.c"": ""@@ -404,6 +404,7 @@ static int show_smap(struct seq_file *m, void *v)\n \n \tmemset(&mss, 0, sizeof mss);\n \tmss.vma = vma;\n+\t/* mmap_sem is held in m_start */\n \tif (vma->vm_mm && !is_vm_hugetlb_page(vma))\n \t\twalk_page_range(vma->vm_start, vma->vm_end, &smaps_walk);\n \n@@ -550,7 +551,8 @@ const struct file_operations proc_clear_refs_operations = {\n };\n \n struct pagemapread {\n-\tu64 __user *out, *end;\n+\tint pos, len;\n+\tu64 *buffer;\n };\n \n #define PM_ENTRY_BYTES      sizeof(u64)\n@@ -573,10 +575,8 @@ struct pagemapread {\n static int add_to_pagemap(unsigned long addr, u64 pfn,\n \t\t\t  struct pagemapread *pm)\n {\n-\tif (put_user(pfn, pm->out))\n-\t\treturn -EFAULT;\n-\tpm->out++;\n-\tif (pm->out >= pm->end)\n+\tpm->buffer[pm->pos++] = pfn;\n+\tif (pm->pos >= pm->len)\n \t\treturn PM_END_OF_BUFFER;\n \treturn 0;\n }\n@@ -674,21 +674,20 @@ static int pagemap_pte_range(pmd_t *pmd, unsigned long addr, unsigned long end,\n  * determine which areas of memory are actually mapped and llseek to\n  * skip over unmapped regions.\n  */\n+#define PAGEMAP_WALK_SIZE\t(PMD_SIZE)\n static ssize_t pagemap_read(struct file *file, char __user *buf,\n \t\t\t    size_t count, loff_t *ppos)\n {\n \tstruct task_struct *task = get_proc_task(file->f_path.dentry->d_inode);\n-\tstruct page **pages, *page;\n-\tunsigned long uaddr, uend;\n \tstruct mm_struct *mm;\n \tstruct pagemapread pm;\n-\tint pagecount;\n \tint ret = -ESRCH;\n \tstruct mm_walk pagemap_walk = {};\n \tunsigned long src;\n \tunsigned long svpfn;\n \tunsigned long start_vaddr;\n \tunsigned long end_vaddr;\n+\tint copied = 0;\n \n \tif (!task)\n \t\tgoto out;\n@@ -711,35 +710,12 @@ static ssize_t pagemap_read(struct file *file, char __user *buf,\n \tif (!mm)\n \t\tgoto out_task;\n \n-\n-\tuaddr = (unsigned long)buf & PAGE_MASK;\n-\tuend = (unsigned long)(buf + count);\n-\tpagecount = (PAGE_ALIGN(uend) - uaddr) / PAGE_SIZE;\n-\tret = 0;\n-\tif (pagecount == 0)\n-\t\tgoto out_mm;\n-\tpages = kcalloc(pagecount, sizeof(struct page *), GFP_KERNEL);\n+\tpm.len = PM_ENTRY_BYTES * (PAGEMAP_WALK_SIZE >> PAGE_SHIFT);\n+\tpm.buffer = kmalloc(pm.len, GFP_TEMPORARY);\n \tret = -ENOMEM;\n-\tif (!pages)\n+\tif (!pm.buffer)\n \t\tgoto out_mm;\n \n-\tdown_read(&current->mm->mmap_sem);\n-\tret = get_user_pages(current, current->mm, uaddr, pagecount,\n-\t\t\t     1, 0, pages, NULL);\n-\tup_read(&current->mm->mmap_sem);\n-\n-\tif (ret < 0)\n-\t\tgoto out_free;\n-\n-\tif (ret != pagecount) {\n-\t\tpagecount = ret;\n-\t\tret = -EFAULT;\n-\t\tgoto out_pages;\n-\t}\n-\n-\tpm.out = (u64 __user *)buf;\n-\tpm.end = (u64 __user *)(buf + count);\n-\n \tpagemap_walk.pmd_entry = pagemap_pte_range;\n \tpagemap_walk.pte_hole = pagemap_pte_hole;\n \tpagemap_walk.mm = mm;\n@@ -760,23 +736,36 @@ static ssize_t pagemap_read(struct file *file, char __user *buf,\n \t * user buffer is tracked in \""pm\"", and the walk\n \t * will stop when we hit the end of the buffer.\n \t */\n-\tret = walk_page_range(start_vaddr, end_vaddr, &pagemap_walk);\n-\tif (ret == PM_END_OF_BUFFER)\n-\t\tret = 0;\n-\t/* don't need mmap_sem for these, but this looks cleaner */\n-\t*ppos += (char __user *)pm.out - buf;\n-\tif (!ret)\n-\t\tret = (char __user *)pm.out - buf;\n-\n-out_pages:\n-\tfor (; pagecount; pagecount--) {\n-\t\tpage = pages[pagecount-1];\n-\t\tif (!PageReserved(page))\n-\t\t\tSetPageDirty(page);\n-\t\tpage_cache_release(page);\n+\tret = 0;\n+\twhile (count && (start_vaddr < end_vaddr)) {\n+\t\tint len;\n+\t\tunsigned long end;\n+\n+\t\tpm.pos = 0;\n+\t\tend = start_vaddr + PAGEMAP_WALK_SIZE;\n+\t\t/* overflow ? */\n+\t\tif (end < start_vaddr || end > end_vaddr)\n+\t\t\tend = end_vaddr;\n+\t\tdown_read(&mm->mmap_sem);\n+\t\tret = walk_page_range(start_vaddr, end, &pagemap_walk);\n+\t\tup_read(&mm->mmap_sem);\n+\t\tstart_vaddr = end;\n+\n+\t\tlen = min(count, PM_ENTRY_BYTES * pm.pos);\n+\t\tif (copy_to_user(buf, pm.buffer, len) < 0) {\n+\t\t\tret = -EFAULT;\n+\t\t\tgoto out_free;\n+\t\t}\n+\t\tcopied += len;\n+\t\tbuf += len;\n+\t\tcount -= len;\n \t}\n+\t*ppos += copied;\n+\tif (!ret || ret == PM_END_OF_BUFFER)\n+\t\tret = copied;\n+\n out_free:\n-\tkfree(pages);\n+\tkfree(pm.buffer);\n out_mm:\n \tmmput(mm);\n out_task:\n""}","bug 
"
24069,Fernando Lugo,RPMSG: RESMGR: miscellaneous fixes,"['drivers/rpmsg/Kconfig', 'drivers/remoteproc/Kconfig', 'drivers/rpmsg/rpmsg_resmgr.c']","RPMSG: RESMGR: miscellaneous fixes

This patch changes:
- Fixed memory leak in rprm_resource_free()
- Fixed missing mutex_unlock in rprm_resource_alloc() in case of
  failure
- Move RPMSG_RESMGR option above RPMSG samples in Kconfig (samples
  should go at the end
- Chaged to ""default y"" option in Kconfig file for RPMSG_RESMGR

Signed-off-by: Fernando Guzman Lugo <fernando.lugo@ti.com>
",https://android-review.googlesource.com/c/24069,"bug, refactor
","bug,resource ",Bug;Resource;,"{""Kconfig"": ""@@ -27,6 +27,16 @@ config RPMSG_OMX\n \n \t  If unsure, say N.\n \n+config RPMSG_RESMGR\n+\ttristate \""rpmsg resource manager\""\n+\tdefault y\n+\tdepends on RPMSG\n+\tdepends on OMAP_RPRES\n+\t---help---\n+\t  Add Framework base on RPMSG to request and release resources\n+\t  from a remote Processor.\n+\t  Say either Y or M. You know you want to.\n+\n config RPMSG_CLIENT_SAMPLE\n \ttristate \""An rpmsg client sample\""\n \tdefault m\n@@ -42,13 +52,3 @@ config RPMSG_SERVER_SAMPLE\n \t---help---\n \t  This is just a sample server driver for the rpmsg bus.\n \t  Say either Y or M. You know you want to.\n-\n-config RPMSG_RESMGR\n-\ttristate \""rpmsg resource manager\""\n-\tdefault y\n-\tdepends on RPMSG\n-\tdepends on OMAP_RPRES\n-\t---help---\n-\t  Add Framework base on RPMSG to request and release resources\n-\t  from a remote Processor.\n-\t  Say either Y or M. You know you want to.\n"", ""rpmsg_resmgr.c"": ""@@ -505,8 +505,10 @@ static int rprm_resource_free(struct rprm *rprm, u32 addr, int res_id)\n out:\n \tmutex_unlock(&rprm->lock);\n \n-\tif (!ret)\n+\tif (!ret) {\n \t\tret = _resource_free(e->handle, e->type);\n+\t\tkfree(e);\n+\t}\n \n \treturn ret;\n }\n@@ -569,7 +571,6 @@ static int rprm_resource_alloc(struct rprm *rprm, u32 addr, int *res_id,\n \n \tmutex_lock(&rprm->lock);\n \tif (!idr_find(&rprm->conn_list, addr)) {\n-\t\tmutex_unlock(&rprm->lock);\n \t\tret = -ENOTCONN;\n \t\tgoto err;\n \t}\n@@ -578,7 +579,6 @@ static int rprm_resource_alloc(struct rprm *rprm, u32 addr, int *res_id,\n \t * remote processor.\n \t */\n \tif (!idr_pre_get(&rprm->id_list, GFP_KERNEL)) {\n-\t\tmutex_unlock(&rprm->lock);\n \t\tret = -ENOMEM;\n \t\tgoto err;\n \t}\n@@ -596,6 +596,7 @@ static int rprm_resource_alloc(struct rprm *rprm, u32 addr, int *res_id,\n \n \treturn 0;\n err:\n+\tmutex_unlock(&rprm->lock);\n \tkfree(e);\n mem_err:\n \t_resource_free(handle, type);\n""}","bug, refactor 
"
14728,Colin Cross,[ARM] tegra: i2c: Fix i2c driver behavior on timeout/nack,['drivers/i2c/busses/i2c-tegra.c'],"[ARM] tegra: i2c: Fix i2c driver behavior on timeout/nack

Change-Id: Ia0968df649fa56d93cf3522d983fde16413e854d
Signed-off-by: Colin Cross <ccross@android.com>",https://android-review.googlesource.com/c/14728,"bug 
",bug,Bug;,"{""i2c-tegra.c"": ""@@ -24,8 +24,11 @@\n #include <linux/interrupt.h>\n #include <linux/delay.h>\n #include <linux/slab.h>\n+\n #include <asm/unaligned.h>\n \n+#include <mach/clk.h>\n+\n #define TEGRA_I2C_TIMEOUT (msecs_to_jiffies(1000))\n #define BYTES_PER_FIFO_WORD 4\n \n@@ -289,6 +292,11 @@ static int tegra_i2c_init(struct tegra_i2c_dev *i2c_dev)\n \tu32 val;\n \tint err = 0;\n \n+\ttegra_periph_reset_assert(i2c_dev->clk);\n+\tmsleep(1);\n+\ttegra_periph_reset_deassert(i2c_dev->clk);\n+\tmsleep(1);\n+\n \tclk_enable(i2c_dev->clk);\n \n \tdev_dbg(i2c_dev->dev, \""init\\n\"");\n@@ -435,8 +443,7 @@ static int tegra_i2c_xfer_msg(struct tegra_i2c_dev *i2c_dev,\n \tdev_dbg(i2c_dev->dev, \""after transfer: %08x fifo %02x\\n\"", i2c_readl(i2c_dev, I2C_PACKET_TRANSFER_STATUS), i2c_readl(i2c_dev, I2C_FIFO_STATUS));\n \tif (ret == 0) {\n \t\tdev_err(i2c_dev->dev, \""i2c transfer timed out\\n\"");\n-\t\tdev_err(i2c_dev->dev, \""\"");\n-\t\tBUG();\n+\n \t\ttegra_i2c_init(i2c_dev);\n \t\treturn -ETIMEDOUT;\n \t}\n@@ -445,7 +452,7 @@ static int tegra_i2c_xfer_msg(struct tegra_i2c_dev *i2c_dev,\n \n \tif (likely(i2c_dev->msg_err == I2C_ERR_NONE))\n \t\treturn 0;\n-\tBUG();\n+\n \ttegra_i2c_init(i2c_dev);\n \tif (i2c_dev->msg_err == I2C_ERR_NO_ACK) {\n \t\tif (msg->flags & I2C_M_IGNORE_NAK)\n@@ -460,13 +467,16 @@ static int tegra_i2c_xfer(struct i2c_adapter *adap, struct i2c_msg msgs[], int n\n {\n \tstruct tegra_i2c_dev *i2c_dev = i2c_get_adapdata(adap);\n \tint i;\n+\tint ret = 0;\n \tclk_enable(i2c_dev->clk);\n \tfor (i = 0; i < num; i++) {\n \t\tint stop = (i == (num - 1)) ? 1  : 0;\n-\t\ttegra_i2c_xfer_msg(i2c_dev, &msgs[i], stop);\n+\t\tret = tegra_i2c_xfer_msg(i2c_dev, &msgs[i], stop);\n+\t\tif (ret)\n+\t\t\tbreak;\n \t}\n \tclk_disable(i2c_dev->clk);\n-\treturn num;\n+\treturn i;\n }\n \n static u32 tegra_i2c_func(struct i2c_adapter *adap)\n""}","bug 
"
23372,Dmitry Shmidt,net: wireless: bcmdhd: Add spinlock initialization,['drivers/net/wireless/bcmdhd/dhd_linux.c'],"net: wireless: bcmdhd: Add spinlock initialization

Signed-off-by: Dmitry Shmidt <dimitrysh@google.com>
",https://android-review.googlesource.com/c/23372,"bug
",bug,Feature;,"{""dhd_linux.c"": ""@@ -2482,6 +2482,7 @@ dhd_attach(osl_t *osh, struct dhd_bus *bus, uint bus_hdrlen)\n \t/* Initialize the spinlocks */\n \tspin_lock_init(&dhd->sdlock);\n \tspin_lock_init(&dhd->txqlock);\n+\tspin_lock_init(&dhd->dhd_lock);\n \n \t/* Initialize Wakelock stuff */\n \tspin_lock_init(&dhd->wakelock_spinlock);\n""}","bug 
"
14807,Christian Mehlmauer,Cleaned up Samples by removing unsed imports and variables. Changed deprecated Config.LOGD to Config.DEBUG Removed unnecessary whitespaces,"['samples/ApiDemos/src/com/example/android/apis/graphics/PolyToPoly.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/SensorTest.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/Clipping.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/UnicodeChart.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/ColorFilters.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/CreateBitmap.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/GradientDrawable1.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/CubeRenderer.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/FingerPaint.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/RoundRects.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/PathEffects.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/ShapeDrawable1.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/Cube.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/Typefaces.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/DensityActivity.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/PathFillTypes.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/AnimateDrawables.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/TriangleRenderer.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/GraphicsActivity.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/Arcs.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/BitmapDecode.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/Regions.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/DrawPoints.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/Compass.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/Layers.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/TouchRotateActivity.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/AlphaBitmap.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/ScaleToFit.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/MeasureText.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/Vertices.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/BitmapPixels.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/ColorMatrixSample.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/TouchPaint.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/Xfermodes.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/Patterns.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/Sweep.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/PictureLayout.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/Pictures.java', 'samples/ApiDemos/src/com/example/android/apis/graphics/TextAlign.java']","Cleaned up Samples by removing unsed imports and variables. Changed deprecated Config.LOGD to Config.DEBUG

Change-Id: I01414dd83eb6f9a41e56762dd7fc00e7f1115039",https://android-review.googlesource.com/c/14807,"refactor, deprecate 
","refactor, deprecate 
",Bug;Deprecat;Resource;,"{""AlphaBitmap.java"": ""@@ -18,15 +18,12 @@ package com.example.android.apis.graphics;\n \n import com.example.android.apis.R;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n-import android.view.KeyEvent;\n import android.view.*;\n \n import java.io.InputStream;\n-import java.io.ByteArrayOutputStream;\n \n public class AlphaBitmap extends GraphicsActivity {\n \n"", ""AnimateDrawables.java"": ""@@ -18,14 +18,14 @@ package com.example.android.apis.graphics;\n \n import com.example.android.apis.R;\n \n-import android.app.Activity;\n import android.content.Context;\n-import android.graphics.*;\n-import android.graphics.drawable.*;\n-import android.view.animation.*;\n+import android.graphics.Canvas;\n+import android.graphics.Color;\n+import android.graphics.drawable.Drawable;\n import android.os.Bundle;\n-import android.view.KeyEvent;\n import android.view.View;\n+import android.view.animation.Animation;\n+import android.view.animation.TranslateAnimation;\n \n public class AnimateDrawables extends GraphicsActivity {\n \n@@ -55,7 +55,8 @@ public class AnimateDrawables extends GraphicsActivity {\n             an.startNow();\n         }\n         \n-        @Override protected void onDraw(Canvas canvas) {\n+        @Override\n+        protected void onDraw(Canvas canvas) {\n             canvas.drawColor(Color.WHITE);\n \n             mDrawable.draw(canvas);\n"", ""Arcs.java"": ""@@ -20,7 +20,6 @@ package com.example.android.apis.graphics;\n // class is in a sub-package.\n //import com.example.android.apis.R;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n"", ""BitmapDecode.java"": ""@@ -18,15 +18,12 @@ package com.example.android.apis.graphics;\n \n import com.example.android.apis.R;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.graphics.drawable.*;\n import android.os.Bundle;\n-import android.view.KeyEvent;\n import android.view.*;\n \n-import java.io.IOException;\n import java.io.InputStream;\n import java.io.ByteArrayOutputStream;\n \n@@ -101,7 +98,9 @@ public class BitmapDecode extends GraphicsActivity {\n             mDrawable.setBounds(150, 20, 300, 100);\n             \n             is = context.getResources().openRawResource(R.drawable.animated_gif);\n-            if (true) {\n+            //Set to false to use decodeByteArray\n+            Boolean decodeStream = true;\n+            if (decodeStream) {\n                 mMovie = Movie.decodeStream(is);\n             } else {\n                 byte[] array = streamToBytes(is);\n@@ -109,7 +108,8 @@ public class BitmapDecode extends GraphicsActivity {\n             }\n         }\n         \n-        @Override protected void onDraw(Canvas canvas) {\n+        @Override\n+        protected void onDraw(Canvas canvas) {\n             canvas.drawColor(0xFFCCCCCC);            \n             \n             Paint p = new Paint();\n@@ -140,4 +140,3 @@ public class BitmapDecode extends GraphicsActivity {\n         }\n     }\n }\n-\n"", ""BitmapPixels.java"": ""@@ -16,14 +16,9 @@\n \n package com.example.android.apis.graphics;\n \n-import com.example.android.apis.R;\n-\n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n-import android.graphics.drawable.*;\n import android.os.Bundle;\n-import android.view.KeyEvent;\n import android.view.*;\n \n import java.nio.IntBuffer;\n@@ -41,7 +36,6 @@ public class BitmapPixels extends GraphicsActivity {\n         private Bitmap mBitmap1;\n         private Bitmap mBitmap2;\n         private Bitmap mBitmap3;\n-        private Bitmap mBitmap4;\n \n         // access the red component from a premultiplied color\n         private static int getR32(int c) { return (c >>  0) & 0xFF; }\n@@ -165,4 +159,3 @@ public class BitmapPixels extends GraphicsActivity {\n         }\n     }\n }\n-\n"", ""Clipping.java"": ""@@ -16,7 +16,6 @@\n \n package com.example.android.apis.graphics;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n"", ""ColorFilters.java"": ""@@ -23,7 +23,8 @@ import android.content.Context;\n import android.graphics.*;\n import android.graphics.drawable.*;\n import android.os.Bundle;\n-import android.view.KeyEvent;\n+import android.util.Config;\n+import android.util.Log;\n import android.view.*;\n \n public class ColorFilters extends GraphicsActivity {\n@@ -160,8 +161,8 @@ public class ColorFilters extends GraphicsActivity {\n \n         @Override\n         public boolean onTouchEvent(MotionEvent event) {\n-            float x = event.getX();\n-            float y = event.getY();\n+            if (Config.DEBUG) Log.d(\""ColorFilters\"", \""X: \"" + event.getX() +\n+                    \"", Y: \"" + event.getY());\n             switch (event.getAction()) {\n                 case MotionEvent.ACTION_DOWN:\n                     break;\n@@ -181,4 +182,3 @@ public class ColorFilters extends GraphicsActivity {\n         }\n     }\n }\n-\n"", ""ColorMatrixSample.java"": ""@@ -18,11 +18,9 @@ package com.example.android.apis.graphics;\n \n import com.example.android.apis.R;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n-import android.view.KeyEvent;\n import android.view.View;\n \n public class ColorMatrixSample extends GraphicsActivity {\n@@ -35,9 +33,7 @@ public class ColorMatrixSample extends GraphicsActivity {\n     \n     private static class SampleView extends View {\n         private Paint mPaint = new Paint(Paint.ANTI_ALIAS_FLAG);\n-        private ColorMatrix mCM = new ColorMatrix();\n         private Bitmap mBitmap;\n-        private float mSaturation;\n         private float mAngle;\n         \n         public SampleView(Context context) {\n"", ""Compass.java"": ""@@ -38,7 +38,7 @@ public class Compass extends GraphicsActivity {\n     \n     private final SensorEventListener mListener = new SensorEventListener() {\n         public void onSensorChanged(SensorEvent event) {\n-            if (Config.LOGD) Log.d(TAG,\n+            if (Config.DEBUG) Log.d(TAG,\n                     \""sensorChanged (\"" + event.values[0] + \"", \"" + event.values[1] + \"", \"" + event.values[2] + \"")\"");\n             mValues = event.values;\n             if (mView != null) {\n@@ -62,7 +62,7 @@ public class Compass extends GraphicsActivity {\n     @Override\n     protected void onResume()\n     {\n-        if (Config.LOGD) Log.d(TAG, \""onResume\"");\n+        if (Config.DEBUG) Log.d(TAG, \""onResume\"");\n         super.onResume();\n \n         mSensorManager.registerListener(mListener, mSensor,\n@@ -72,7 +72,7 @@ public class Compass extends GraphicsActivity {\n     @Override\n     protected void onStop()\n     {\n-        if (Config.LOGD) Log.d(TAG, \""onStop\"");\n+        if (Config.DEBUG) Log.d(TAG, \""onStop\"");\n         mSensorManager.unregisterListener(mListener);\n         super.onStop();\n     }\n@@ -81,7 +81,6 @@ public class Compass extends GraphicsActivity {\n         private Paint   mPaint = new Paint();\n         private Path    mPath = new Path();\n         private boolean mAnimate;\n-        private long    mNextTime;\n \n         public SampleView(Context context) {\n             super(context);\n@@ -118,14 +117,15 @@ public class Compass extends GraphicsActivity {\n         @Override\n         protected void onAttachedToWindow() {\n             mAnimate = true;\n+            if (Config.DEBUG) Log.d(TAG, \""onAttachedToWindow. mAnimate=\"" + mAnimate);\n             super.onAttachedToWindow();\n         }\n         \n         @Override\n         protected void onDetachedFromWindow() {\n             mAnimate = false;\n+            if (Config.DEBUG) Log.d(TAG, \""onDetachedFromWindow. mAnimate=\"" + mAnimate);\n             super.onDetachedFromWindow();\n         }\n     }\n }\n-\n"", ""CreateBitmap.java"": ""@@ -16,13 +16,9 @@\n \n package com.example.android.apis.graphics;\n \n-import com.example.android.apis.R;\n-\n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n-import android.view.KeyEvent;\n import android.view.*;\n \n import java.io.ByteArrayOutputStream;\n"", ""Cube.java"": ""@@ -88,10 +88,10 @@ class Cube\n \n     public void draw(GL10 gl)\n     {\n-        gl.glFrontFace(gl.GL_CW);\n-        gl.glVertexPointer(3, gl.GL_FIXED, 0, mVertexBuffer);\n-        gl.glColorPointer(4, gl.GL_FIXED, 0, mColorBuffer);\n-        gl.glDrawElements(gl.GL_TRIANGLES, 36, gl.GL_UNSIGNED_BYTE, mIndexBuffer);\n+        gl.glFrontFace(GL10.GL_CW);\n+        gl.glVertexPointer(3, GL10.GL_FIXED, 0, mVertexBuffer);\n+        gl.glColorPointer(4, GL10.GL_FIXED, 0, mColorBuffer);\n+        gl.glDrawElements(GL10.GL_TRIANGLES, 36, GL10.GL_UNSIGNED_BYTE, mIndexBuffer);\n     }\n \n     private IntBuffer   mVertexBuffer;\n"", ""CubeRenderer.java"": ""@@ -16,7 +16,6 @@\n \n package com.example.android.apis.graphics;\n \n-import javax.microedition.khronos.egl.EGL10;\n import javax.microedition.khronos.egl.EGLConfig;\n import javax.microedition.khronos.opengles.GL10;\n \n"", ""DensityActivity.java"": ""@@ -21,7 +21,6 @@ package com.example.android.apis.graphics;\n import com.example.android.apis.R;\n \n import android.app.Activity;\n-import android.app.Application;\n import android.os.Bundle;\n import android.graphics.BitmapFactory;\n import android.graphics.Bitmap;\n@@ -34,8 +33,6 @@ import android.widget.ScrollView;\n import android.view.LayoutInflater;\n import android.view.View;\n import android.content.Context;\n-import android.content.pm.ApplicationInfo;\n-import android.content.pm.PackageManager;\n import android.util.DisplayMetrics;\n import android.util.Log;\n \n"", ""DrawPoints.java"": ""@@ -16,7 +16,6 @@\n \n package com.example.android.apis.graphics;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n"", ""FingerPaint.java"": ""@@ -16,7 +16,6 @@\n \n package com.example.android.apis.graphics;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n"", ""GradientDrawable1.java"": ""@@ -20,7 +20,6 @@ package com.example.android.apis.graphics;\n // class is in a sub-package.\n import com.example.android.apis.R;\n \n-import android.app.Activity;\n import android.os.Bundle;\n \n public class GradientDrawable1 extends GraphicsActivity {\n"", ""GraphicsActivity.java"": ""@@ -20,7 +20,6 @@ import android.app.Activity;\n import android.os.Bundle;\n import android.view.View;\n import android.view.ViewGroup;\n-import android.view.Window;\n \n class GraphicsActivity extends Activity {\n     @Override\n@@ -30,7 +29,9 @@ class GraphicsActivity extends Activity {\n \n     @Override\n     public void setContentView(View view) {\n-        if (false) { // set to true to test Picture\n+        // set to true to test Picture\n+        Boolean testPicture = false;\n+        if (testPicture) {\n             ViewGroup vg = new PictureLayout(this);\n             vg.addView(view);\n             view = vg;\n@@ -39,4 +40,3 @@ class GraphicsActivity extends Activity {\n         super.setContentView(view);\n     }\n }\n-\n"", ""Layers.java"": ""@@ -16,7 +16,6 @@\n \n package com.example.android.apis.graphics;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n"", ""MeasureText.java"": ""@@ -16,13 +16,9 @@\n \n package com.example.android.apis.graphics;\n \n-import com.example.android.apis.R;\n-\n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n-import android.view.KeyEvent;\n import android.view.*;\n \n public class MeasureText extends GraphicsActivity {\n@@ -114,4 +110,3 @@ public class MeasureText extends GraphicsActivity {\n         }\n     }\n }\n-\n"", ""PathEffects.java"": ""@@ -16,7 +16,6 @@\n \n package com.example.android.apis.graphics;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n"", ""PathFillTypes.java"": ""@@ -20,11 +20,9 @@ package com.example.android.apis.graphics;\n // class is in a sub-package.\n //import com.example.android.apis.R;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n-import android.view.KeyEvent;\n import android.view.View;\n \n public class PathFillTypes extends GraphicsActivity {\n"", ""Patterns.java"": ""@@ -16,11 +16,9 @@\n \n package com.example.android.apis.graphics;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n-import android.view.KeyEvent;\n import android.view.MotionEvent;\n import android.view.*;\n \n"", ""PictureLayout.java"": ""@@ -26,7 +26,6 @@ import android.view.View;\n import android.view.ViewGroup;\n import android.view.ViewParent;\n \n-\n public class PictureLayout extends ViewGroup {\n     private final Picture mPicture = new Picture();\n \n"", ""Pictures.java"": ""@@ -16,13 +16,11 @@\n \n package com.example.android.apis.graphics;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.graphics.drawable.Drawable;\n import android.graphics.drawable.PictureDrawable;\n import android.os.Bundle;\n-import android.view.KeyEvent;\n import android.view.View;\n \n import java.io.*;\n"", ""PolyToPoly.java"": ""@@ -20,7 +20,6 @@ package com.example.android.apis.graphics;\n // class is in a sub-package.\n //import com.example.android.apis.R;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n@@ -73,9 +72,8 @@ public class PolyToPoly extends GraphicsActivity {\n             mFontMetrics = mPaint.getFontMetrics();\n         }\n         \n-        @Override protected void onDraw(Canvas canvas) {\n-            Paint paint = mPaint;\n-\n+        @Override\n+        protected void onDraw(Canvas canvas) {\n             canvas.drawColor(Color.WHITE);\n \n             canvas.save();\n@@ -107,4 +105,3 @@ public class PolyToPoly extends GraphicsActivity {\n         }\n     }\n }\n-\n"", ""Regions.java"": ""@@ -16,7 +16,6 @@\n \n package com.example.android.apis.graphics;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n@@ -91,7 +90,8 @@ public class Regions extends GraphicsActivity {\n                        r.right - inset, r.bottom - inset, p);\n         }\n         \n-        @Override protected void onDraw(Canvas canvas) {\n+        @Override\n+        protected void onDraw(Canvas canvas) {\n             canvas.drawColor(Color.GRAY);            \n \n             canvas.save();\n"", ""RoundRects.java"": ""@@ -16,14 +16,10 @@\n \n package com.example.android.apis.graphics;\n \n-import com.example.android.apis.R;\n-\n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.graphics.drawable.*;\n import android.os.Bundle;\n-import android.view.KeyEvent;\n import android.view.*;\n \n public class RoundRects extends GraphicsActivity {\n@@ -112,8 +108,6 @@ public class RoundRects extends GraphicsActivity {\n             setCornerRadii(mDrawable, 0, r, 0, r);\n             mDrawable.draw(canvas);\n             canvas.restore();\n-            \n         }\n     }\n }\n-\n"", ""ScaleToFit.java"": ""@@ -16,7 +16,6 @@\n \n package com.example.android.apis.graphics;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n@@ -92,9 +91,8 @@ public class ScaleToFit extends GraphicsActivity {\n             canvas.drawRect(mDstR, mHairPaint);\n         }\n \n-        @Override protected void onDraw(Canvas canvas) {\n-            Paint paint = mPaint;\n-\n+        @Override\n+        protected void onDraw(Canvas canvas) {\n             canvas.drawColor(Color.WHITE);\n \n             canvas.translate(10, 10);\n@@ -121,4 +119,3 @@ public class ScaleToFit extends GraphicsActivity {\n         }\n     }\n }\n-\n"", ""SensorTest.java"": ""@@ -24,6 +24,7 @@ import android.hardware.SensorEventListener;\n import android.hardware.SensorManager;\n import android.os.Bundle;\n import android.util.Config;\n+import android.util.Log;\n import android.view.View;\n \n public class SensorTest extends GraphicsActivity {\n@@ -96,7 +97,7 @@ public class SensorTest extends GraphicsActivity {\n             if (show) {\n                 // only shows if we think the delta is big enough, in an attempt\n                 // to detect \""serious\"" moves left/right or up/down\n-                android.util.Log.e(TAG, \""sensorChanged \"" + event.sensor.getName() +\n+                Log.e(TAG, \""sensorChanged \"" + event.sensor.getName() +\n                         \"" (\"" + event.values[0] + \"", \"" + event.values[1] + \"", \"" +\n                         event.values[2] + \"")\"" + \"" diff(\"" + diff[0] +\n                         \"" \"" + diff[1] + \"" \"" + diff[2] + \"")\"");\n@@ -114,15 +115,15 @@ public class SensorTest extends GraphicsActivity {\n                 if ((gestX || gestY) && !(gestX && gestY)) {\n                     if (gestX) {\n                         if (x < 0) {\n-                            android.util.Log.e(\""test\"", \""<<<<<<<< LEFT <<<<<<<<<<<<\"");\n+                            Log.e(\""test\"", \""<<<<<<<< LEFT <<<<<<<<<<<<\"");\n                         } else {\n-                            android.util.Log.e(\""test\"", \"">>>>>>>>> RITE >>>>>>>>>>>\"");\n+                            Log.e(\""test\"", \"">>>>>>>>> RITE >>>>>>>>>>>\"");\n                         }\n                     } else {\n                         if (y < -2) {\n-                            android.util.Log.e(\""test\"", \""<<<<<<<< UP <<<<<<<<<<<<\"");\n+                            Log.e(\""test\"", \""<<<<<<<< UP <<<<<<<<<<<<\"");\n                         } else {\n-                            android.util.Log.e(\""test\"", \"">>>>>>>>> DOWN >>>>>>>>>>>\"");\n+                            Log.e(\""test\"", \"">>>>>>>>> DOWN >>>>>>>>>>>\"");\n                         }\n                     }\n                     mLastGestureTime = now;\n@@ -141,28 +142,27 @@ public class SensorTest extends GraphicsActivity {\n         mSensor = mSensorManager.getDefaultSensor(Sensor.TYPE_ACCELEROMETER);\n         mView = new SampleView(this);\n         setContentView(mView);\n-        if (Config.LOGD) android.util.Log.d(TAG, \""create \"" + mSensorManager);\n+        if (Config.DEBUG) Log.d(TAG, \""create \"" + mSensorManager);\n     }\n \n     @Override\n     protected void onResume() {\n         super.onResume();\n         mSensorManager.registerListener(mListener, mSensor, SensorManager.SENSOR_DELAY_FASTEST);\n-        if (Config.LOGD) android.util.Log.d(TAG, \""resume \"" + mSensorManager);\n+        if (Config.DEBUG) Log.d(TAG, \""resume \"" + mSensorManager);\n     }\n     \n     @Override\n     protected void onStop() {\n         mSensorManager.unregisterListener(mListener);\n         super.onStop();\n-        if (Config.LOGD) android.util.Log.d(TAG, \""stop \"" + mSensorManager);\n+        if (Config.DEBUG) Log.d(TAG, \""stop \"" + mSensorManager);\n     }\n \n     private class SampleView extends View {\n         private Paint   mPaint = new Paint();\n         private Path    mPath = new Path();\n         private boolean mAnimate;\n-        private long    mNextTime;\n \n         public SampleView(Context context) {\n             super(context);\n@@ -200,12 +200,14 @@ public class SensorTest extends GraphicsActivity {\n         @Override\n         protected void onAttachedToWindow() {\n             mAnimate = true;\n+            if (Config.DEBUG) Log.d(TAG, \""onAttachedToWindow. mAnimate=\""+mAnimate);\n             super.onAttachedToWindow();\n         }\n         \n         @Override\n         protected void onDetachedFromWindow() {\n             mAnimate = false;\n+            if (Config.DEBUG) Log.d(TAG, \""onAttachedToWindow. mAnimate=\""+mAnimate);\n             super.onDetachedFromWindow();\n         }\n     }\n"", ""ShapeDrawable1.java"": ""@@ -16,16 +16,12 @@\n \n package com.example.android.apis.graphics;\n \n-import com.example.android.apis.R;\n-\n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.graphics.drawable.Drawable;\n import android.graphics.drawable.ShapeDrawable;\n import android.graphics.drawable.shapes.*;\n import android.os.Bundle;\n-import android.view.KeyEvent;\n import android.view.*;\n \n public class ShapeDrawable1 extends GraphicsActivity {\n"", ""Sweep.java"": ""@@ -16,11 +16,6 @@\n \n package com.example.android.apis.graphics;\n \n-// Need the following import to get access to the app resources, since this\n-// class is in a sub-package.\n-//import com.example.android.apis.R;\n-\n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n"", ""TextAlign.java"": ""@@ -16,13 +16,9 @@\n \n package com.example.android.apis.graphics;\n \n-import com.example.android.apis.R;\n-\n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n-import android.view.KeyEvent;\n import android.view.*;\n \n public class TextAlign extends GraphicsActivity {\n"", ""TouchPaint.java"": ""@@ -16,7 +16,6 @@\n \n package com.example.android.apis.graphics;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.Bitmap;\n import android.graphics.Canvas;\n"", ""TouchRotateActivity.java"": ""@@ -16,7 +16,6 @@\n \n package com.example.android.apis.graphics;\n \n-import javax.microedition.khronos.egl.EGL10;\n import javax.microedition.khronos.egl.EGLConfig;\n import javax.microedition.khronos.opengles.GL10;\n \n"", ""TriangleRenderer.java"": ""@@ -23,7 +23,6 @@ import java.nio.ByteOrder;\n import java.nio.FloatBuffer;\n import java.nio.ShortBuffer;\n \n-import javax.microedition.khronos.egl.EGL10;\n import javax.microedition.khronos.egl.EGLConfig;\n import javax.microedition.khronos.opengles.GL10;\n \n"", ""Typefaces.java"": ""@@ -16,7 +16,6 @@\n \n package com.example.android.apis.graphics;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n"", ""UnicodeChart.java"": ""@@ -16,7 +16,6 @@\n \n package com.example.android.apis.graphics;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n import android.os.Bundle;\n@@ -64,7 +63,7 @@ public class UnicodeChart extends GraphicsActivity {\n             float[] pos = mPos;\n             int index = 0;\n             for (int col = 0; col < 16; col++) {\n-                final float x = col * 20 + 10;\n+                final float x = col * XMUL + 10;\n                 for (int row = 0; row < 16; row++) {\n                     pos[index++] = x;\n                     pos[index++] = row * YMUL + YBASE;\n@@ -73,7 +72,7 @@ public class UnicodeChart extends GraphicsActivity {\n         }\n         \n         private float computeX(int index) {\n-            return (index >> 4) * 20 + 10;\n+            return (index >> 4) * XMUL + 10;\n         }\n \n         private float computeY(int index) {\n@@ -118,4 +117,3 @@ public class UnicodeChart extends GraphicsActivity {\n         }\n     }\n }\n-\n"", ""Vertices.java"": ""@@ -18,17 +18,11 @@ package com.example.android.apis.graphics;\n \n import com.example.android.apis.R;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.*;\n-import android.graphics.drawable.*;\n import android.os.Bundle;\n-import android.view.KeyEvent;\n import android.view.*;\n \n-import java.io.IOException;\n-import java.io.InputStream;\n-\n public class Vertices extends GraphicsActivity {\n \n     @Override\n@@ -41,7 +35,6 @@ public class Vertices extends GraphicsActivity {\n         private final Paint mPaint = new Paint();\n         private final float[] mVerts = new float[10];\n         private final float[] mTexs = new float[10];\n-        private final int[] mColors = new int[10];\n         private final short[] mIndices = { 0, 1, 2, 3, 4, 1 };\n         \n         private final Matrix mMatrix = new Matrix();\n"", ""Xfermodes.java"": ""@@ -16,7 +16,6 @@\n \n package com.example.android.apis.graphics;\n \n-import android.app.Activity;\n import android.content.Context;\n import android.graphics.Bitmap;\n import android.graphics.BitmapShader;\n""}","**deprecate, refactor** 
"
23519,Deleted User,opengl translator: fix eglGetConfigAttrib,['tools/emulator/opengl/host/libs/Translator/EGL/EglConfig.cpp'],"opengl translator: fix eglGetConfigAttrib

fix renderable type parameter for eglconfig

Change-Id: Iac1d782cc37b0c7055bb90109a17583b84e6e6e3",https://android-review.googlesource.com/c/23519,"bug 
",bug,Bug;Resource;,"{""EglConfig.cpp"": ""@@ -167,6 +167,7 @@ bool EglConfig::getConfAttrib(EGLint attrib,EGLint* val) const {\n         break;\n     case EGL_RENDERABLE_TYPE:\n         *val = m_renderable_type;\n+        break;\n     case EGL_SAMPLE_BUFFERS:\n         *val = m_sample_buffers_num;\n         break;\n""}","feature 
"
15519,Colin Cross,"Add ""nol2x0"" early param to avoid initialisation of the L2 controller","['arch/arm/mm/cache-l2x0.c', 'arch/arm/mach-realview/realview_pbx.c', 'arch/arm/include/asm/hardware/cache-l2x0.h']","Add ""nol2x0"" early param to avoid initialisation of the L2 controller

Some development platforms may have issues with this controller, so
allow easy disabling from the kernel command line. The patch also adds
a check for l2x0_disabled in the realview_pbx.c code to avoid setting
additional L2x0 registers.

Change-Id: Icbbd3e054688811200a4c96bf7e0a81c9c0ab790
Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>",https://android-review.googlesource.com/c/15519,"bug,feature 
","feature,bug",Feature;,"{""cache-l2x0.h"": ""@@ -56,6 +56,7 @@\n \n #ifndef __ASSEMBLY__\n extern void __init l2x0_init(void __iomem *base, __u32 aux_val, __u32 aux_mask);\n+extern bool l2x0_disabled;\n #endif\n \n #endif\n"", ""realview_pbx.c"": ""@@ -374,7 +374,7 @@ static void __init realview_pbx_init(void)\n \tint i;\n \n #ifdef CONFIG_CACHE_L2X0\n-\tif (core_tile_pbxa9mp()) {\n+\tif (!l2x0_disabled && core_tile_pbxa9mp()) {\n \t\tvoid __iomem *l2x0_base =\n \t\t\t__io_address(REALVIEW_PBX_TILE_L220_BASE);\n \n"", ""cache-l2x0.c"": ""@@ -27,6 +27,7 @@\n \n static void __iomem *l2x0_base;\n static uint32_t l2x0_way_mask;\t/* Bitmask of active ways */\n+bool l2x0_disabled;\n \n static inline void cache_wait_always(void __iomem *reg, unsigned long mask)\n {\n@@ -240,6 +241,11 @@ void __init l2x0_init(void __iomem *base, __u32 aux_val, __u32 aux_mask)\n \tint ways;\n \tconst char *type;\n \n+\tif (l2x0_disabled) {\n+\t\tprintk(KERN_INFO \""L2X0 cache controller disabled\\n\"");\n+\t\treturn;\n+\t}\n+\n \tl2x0_base = base;\n \n \tcache_id = readl(l2x0_base + L2X0_CACHE_ID);\n@@ -294,3 +300,10 @@ void __init l2x0_init(void __iomem *base, __u32 aux_val, __u32 aux_mask)\n \tprintk(KERN_INFO \""l2x0: %d ways, CACHE_ID 0x%08x, AUX_CTRL 0x%08x\\n\"",\n \t\t\t ways, cache_id, aux);\n }\n+\n+static int __init l2x0_disable(char *unused)\n+{\n+\tl2x0_disabled = 1;\n+\treturn 0;\n+}\n+early_param(\""nol2x0\"", l2x0_disable);\n""}","bug, refactor 
"
10979,Romit Dasgupta,[ARM] omap2: Prevents MPU power domain to enter OFF/Retention in C-state C2.,['arch/arm/mach-omap2/cpuidle34xx.c'],"Prevents MPU power domain to enter OFF/Retention in C-state C2.

Signed-off-by: Romit Dasgupta <romit@ti.com>",https://android-review.googlesource.com/c/10979,"bug 
",bug,Others;,"{""cpuidle34xx.c"": ""@@ -193,7 +193,7 @@ void omap_init_power_states(void)\n \tomap3_power_states[OMAP3_STATE_C2].sleep_latency = 0;\n \tomap3_power_states[OMAP3_STATE_C2].wakeup_latency = 18;\n \tomap3_power_states[OMAP3_STATE_C2].threshold = 20;\n-\tomap3_power_states[OMAP3_STATE_C2].mpu_state = PWRDM_POWER_INACTIVE;\n+\tomap3_power_states[OMAP3_STATE_C2].mpu_state = PWRDM_POWER_ON;\n \tomap3_power_states[OMAP3_STATE_C2].core_state = PWRDM_POWER_ON;\n \tomap3_power_states[OMAP3_STATE_C2].flags = CPUIDLE_FLAG_TIME_VALID;\n \n""}","bug 
"
15095,Jack Palevich,Emit shell prompt even when in non-interactive mode.,"['sh/parser.c', 'sh/input.c', 'sh/input.h']","Emit shell prompt even when in non-interactive mode.

Change-Id: If85c509efe13e4bdb40216c79d560ea7f83ba813",https://android-review.googlesource.com/c/15095,"feature 
",feature,Others;,"{""input.c"": ""@@ -175,6 +175,9 @@ pgetc(void)\n \treturn pgetc_macro();\n }\n \n+int in_interactive_mode() {\n+    return parsefile != NULL && parsefile->fd == 0;\n+}\n \n static int\n preadfd(void)\n"", ""input.h"": ""@@ -46,6 +46,7 @@ extern int parsenleft;\t\t/* number of characters left in input buffer */\n extern char *parsenextc;\t/* next character in input buffer */\n extern int init_editline;\t/* 0 == not setup, 1 == OK, -1 == failed */\n \n+int in_interactive_mode();\n char *pfgets(char *, int);\n int pgetc(void);\n int preadbuffer(void);\n"", ""parser.c"": ""@@ -1629,9 +1629,9 @@ setprompt(int which)\n \tif (!el)\n #endif\n #ifdef WITH_LINENOISE\n-#else\n-\t\tout2str(getprompt(NULL));\n+        if (! in_interactive_mode() )\n #endif\n+\t\tout2str(getprompt(NULL));\n }\n \n /*\n""}","feature 
"
21985,RaphaÃ«l Moll,"Revert ""build/tools.atree: Move x86-specific changes to tools.x86.atree""","['build/tools.atree', 'build/tools.x86.atree']","Revert ""build/tools.atree: Move x86-specific changes to tools.x86.atree""

This reverts commit 253acabecba0d9f649f04499f6dda980fbe7bf49.",https://android-review.googlesource.com/c/21985,"refactor 
",deprecat;resource,Resource;,"{""tools.atree"": ""@@ -40,10 +40,11 @@ bin/mksdcard     tools/mksdcard\n bin/zipalign     tools/zipalign\n \n # emulator\n-# note: the following line should better to to tools.arm.atree\n-# but is kept here to avoid breaking internal branches.\n-bin/emulator  tools/emulator-arm\n+bin/emulator tools/emulator-arm\n+bin/emulator-x86   tools/emulator-x86\n sdk/emulator/snapshot/snapshots.img tools/lib/emulator/snapshots.img\n+usr/share/pc-bios/bios.bin   tools/lib/pc-bios/bios.bin\n+usr/share/pc-bios/vgabios-cirrus.bin   tools/lib/pc-bios/vgabios-cirrus.bin\n \n # Java-Based SDK Tools\n bin/ddms            tools/ddms\n"", ""tools.x86.atree"": ""@@ -1,22 +0,0 @@\n-#\n-# Copyright (C) 2011 The Android Open Source Project\n-#\n-# Licensed under the Apache License, Version 2.0 (the \""License\"");\n-# you may not use this file except in compliance with the License.\n-# You may obtain a copy of the License at\n-#\n-#      http://www.apache.org/licenses/LICENSE-2.0\n-#\n-# Unless required by applicable law or agreed to in writing, software\n-# distributed under the License is distributed on an \""AS IS\"" BASIS,\n-# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n-# See the License for the specific language governing permissions and\n-# limitations under the License.\n-#\n-\n-# Additionnal target-specific definitions for tools.atree\n-\n-# emulator\n-bin/emulator-x86                       tools/emulator-x86\n-usr/share/pc-bios/bios.bin             tools/lib/pc-bios/bios.bin\n-usr/share/pc-bios/vgabios-cirrus.bin   tools/lib/pc-bios/vgabios-cirrus.bin\n""}","merge 
"
15840,Deleted User,[ARM] tegra: harmony: add sdhci0 controller (wlan),['arch/arm/mach-tegra/board-harmony-sdhci.c'],"[ARM] tegra: harmony: add sdhci0 controller (wlan)

Change-Id: I6000b1d34e35d9291cae80e4508518d0059397f8
Signed-off-by: Gary King <gking@nvidia.com>",https://android-review.googlesource.com/c/15840,"feature 
",feature,Feature;,"{""board-harmony-sdhci.c"": ""@@ -27,6 +27,19 @@\n \n #include \""gpio-names.h\""\n \n+static struct resource sdhci_resource1[] = {\n+\t[0] = {\n+\t\t.start  = INT_SDMMC1,\n+\t\t.end    = INT_SDMMC1,\n+\t\t.flags  = IORESOURCE_IRQ,\n+\t},\n+\t[1] = {\n+\t\t.start  = TEGRA_SDMMC1_BASE,\n+\t\t.end    = TEGRA_SDMMC1_BASE + TEGRA_SDMMC1_SIZE-1,\n+\t\t.flags  = IORESOURCE_MEM,\n+\t},\n+};\n+\n static struct resource sdhci_resource2[] = {\n \t[0] = {\n \t\t.start  = INT_SDMMC2,\n@@ -53,6 +66,14 @@ static struct resource sdhci_resource4[] = {\n \t},\n };\n \n+static struct tegra_sdhci_platform_data tegra_sdhci_platform_data1 = {\n+\t.clk_id = NULL,\n+\t.force_hs = 1,\n+\t.cd_gpio = -1,\n+\t.wp_gpio = -1,\n+\t.power_gpio = -1,\n+};\n+\n static struct tegra_sdhci_platform_data tegra_sdhci_platform_data2 = {\n \t.clk_id = NULL,\n \t.force_hs = 1,\n@@ -69,6 +90,16 @@ static struct tegra_sdhci_platform_data tegra_sdhci_platform_data4 = {\n \t.power_gpio = TEGRA_GPIO_PI6,\n };\n \n+static struct platform_device tegra_sdhci_device1 = {\n+\t.name\t\t= \""sdhci-tegra\"",\n+\t.id\t\t= 0,\n+\t.resource\t= sdhci_resource1,\n+\t.num_resources\t= ARRAY_SIZE(sdhci_resource1),\n+\t.dev = {\n+\t\t.platform_data = &tegra_sdhci_platform_data1,\n+\t},\n+};\n+\n static struct platform_device tegra_sdhci_device2 = {\n \t.name\t\t= \""sdhci-tegra\"",\n \t.id\t\t= 1,\n@@ -110,6 +141,7 @@ int __init harmony_sdhci_init(void)\n \tgpio_direction_output(tegra_sdhci_platform_data2.power_gpio, 1);\n \tgpio_direction_output(tegra_sdhci_platform_data4.power_gpio, 1);\n \n+\tplatform_device_register(&tegra_sdhci_device1);\n \tplatform_device_register(&tegra_sdhci_device2);\n \tplatform_device_register(&tegra_sdhci_device4);\n \n""}","feature 
"
14110,San Mehat,[ARM] defconfig: sholes: Enable a number of internal kernel debugging options,['arch/arm/configs/sholes_defconfig'],"[ARM] defconfig: sholes: Enable a number of internal kernel debugging options

Enables the following:
- Hung task panic (BOOTPARAM_HUNG_TASK_PANIC)
- Preempt debugging (DEBUG_PREEMPT)
- RT mutex / list debugging (DEBUG_RT_MUTEXES / DEBUG_PI_LIST)
- Memory init debugging (DEBUG_MEMORY_INIT)
- Scatterlist debugging (DEBUG_SG)
- Notifier debugging (DEBUG_NOTIFIERS)
- Frame pointers (FRAME_POINTER)
- RCU stall detector (RCU_CPU_STALL_DETECTOR)

Signed-off-by: San Mehat <san@google.com>
",https://android-review.googlesource.com/c/14110,"**refactor** 
",resource,Bug;Resource;,"{""sholes_defconfig"": ""@@ -1,7 +1,7 @@\n #\n # Automatically generated make config: don't edit\n # Linux kernel version: 2.6.32.9\n-# Thu Mar 25 11:51:44 2010\n+# Thu Mar 25 20:16:13 2010\n #\n CONFIG_ARM=y\n CONFIG_SYS_SUPPORTS_APM_EMULATION=y\n@@ -83,7 +83,7 @@ CONFIG_EMBEDDED=y\n CONFIG_UID16=y\n # CONFIG_SYSCTL_SYSCALL is not set\n CONFIG_KALLSYMS=y\n-# CONFIG_KALLSYMS_ALL is not set\n+CONFIG_KALLSYMS_ALL=y\n CONFIG_KALLSYMS_EXTRA_PASS=y\n CONFIG_HOTPLUG=y\n CONFIG_PRINTK=y\n@@ -2059,8 +2059,8 @@ CONFIG_DETECT_SOFTLOCKUP=y\n # CONFIG_BOOTPARAM_SOFTLOCKUP_PANIC is not set\n CONFIG_BOOTPARAM_SOFTLOCKUP_PANIC_VALUE=0\n CONFIG_DETECT_HUNG_TASK=y\n-# CONFIG_BOOTPARAM_HUNG_TASK_PANIC is not set\n-CONFIG_BOOTPARAM_HUNG_TASK_PANIC_VALUE=0\n+CONFIG_BOOTPARAM_HUNG_TASK_PANIC=y\n+CONFIG_BOOTPARAM_HUNG_TASK_PANIC_VALUE=1\n CONFIG_SCHED_DEBUG=y\n CONFIG_SCHEDSTATS=y\n # CONFIG_TIMER_STATS is not set\n@@ -2070,8 +2070,9 @@ CONFIG_DEBUG_SLAB_LEAK=y\n CONFIG_DEBUG_KMEMLEAK=y\n CONFIG_DEBUG_KMEMLEAK_EARLY_LOG_SIZE=800\n # CONFIG_DEBUG_KMEMLEAK_TEST is not set\n-# CONFIG_DEBUG_PREEMPT is not set\n-# CONFIG_DEBUG_RT_MUTEXES is not set\n+CONFIG_DEBUG_PREEMPT=y\n+CONFIG_DEBUG_RT_MUTEXES=y\n+CONFIG_DEBUG_PI_LIST=y\n # CONFIG_RT_MUTEX_TESTER is not set\n # CONFIG_DEBUG_SPINLOCK is not set\n CONFIG_DEBUG_MUTEXES=y\n@@ -2086,14 +2087,15 @@ CONFIG_STACKTRACE=y\n CONFIG_DEBUG_INFO=y\n CONFIG_DEBUG_VM=y\n # CONFIG_DEBUG_WRITECOUNT is not set\n-# CONFIG_DEBUG_MEMORY_INIT is not set\n+CONFIG_DEBUG_MEMORY_INIT=y\n CONFIG_DEBUG_LIST=y\n-# CONFIG_DEBUG_SG is not set\n-# CONFIG_DEBUG_NOTIFIERS is not set\n+CONFIG_DEBUG_SG=y\n+CONFIG_DEBUG_NOTIFIERS=y\n # CONFIG_DEBUG_CREDENTIALS is not set\n+CONFIG_FRAME_POINTER=y\n # CONFIG_BOOT_PRINTK_DELAY is not set\n # CONFIG_RCU_TORTURE_TEST is not set\n-# CONFIG_RCU_CPU_STALL_DETECTOR is not set\n+CONFIG_RCU_CPU_STALL_DETECTOR=y\n # CONFIG_BACKTRACE_SELF_TEST is not set\n # CONFIG_DEBUG_BLOCK_EXT_DEVT is not set\n # CONFIG_DEBUG_FORCE_WEAK_PER_CPU is not set\n""}","feature 
"
22624,Deleted User,emulator opengl: typo caused the decoder to crash,['tools/emulator/opengl/shared/OpenglCodecCommon/GLDecoderContextData.h'],"emulator opengl: typo caused the decoder to crash

embarrassing :-)

Change-Id: I4da948bba0cd16b6e8289c3c79e0daefb41f90e4",https://android-review.googlesource.com/c/22624,"bug
",bug,Others;,"{""GLDecoderContextData.h"": ""@@ -44,7 +44,7 @@ public:\n     GLDecoderContextData(int nLocations = CODEC_MAX_VERTEX_ATTRIBUTES) :\n         m_nLocations(nLocations)\n     {\n-        m_pointerData = new FixedBuffer(m_nLocations);\n+        m_pointerData = new FixedBuffer[m_nLocations];\n     }\n \n     ~GLDecoderContextData() {\n""}","bug 
"
20302,Tor Norbye,Disallow Java keywords in resource names,['eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/wizards/newxmlfile/ResourceNameValidator.java'],"Disallow Java keywords in resource names

If you create a resource file that is a Java keyword, Bad Stuff
happens - it doesn't even make it into the R file.

This modifiers the resource name validator (used among other places in
the New XML File wizard) to disallow these names along with a suitable
error message.

Change-Id: Ic807bb9194d316f227bf3435509632374113563d",https://android-review.googlesource.com/c/20302,"bug,resource 
",bug,Feature;,"{""ResourceNameValidator.java"": ""@@ -26,6 +26,8 @@ import com.android.ide.eclipse.adt.internal.resources.manager.ProjectResources;\n import com.android.ide.eclipse.adt.internal.resources.manager.ResourceManager;\n \n import org.eclipse.core.resources.IProject;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.jdt.core.JavaConventions;\n import org.eclipse.jface.dialogs.IInputValidator;\n \n import java.util.HashSet;\n@@ -73,6 +75,12 @@ public class ResourceNameValidator implements IInputValidator {\n                 }\n             }\n \n+            String level = \""1.5\""; //$NON-NLS-1$\n+            IStatus validIdentifier = JavaConventions.validateIdentifier(newText, level, level);\n+            if (!validIdentifier.isOK()) {\n+                return String.format(\""%1$s is not a valid name (reserved Java keyword)\"", newText);\n+            }\n+\n             if (mExisting != null && mExisting.contains(newText)) {\n                 return String.format(\""%1$s already exists\"", newText);\n             }\n""}","bug, feature 
"
22018,Deleted User,Android emulator opengl - host side EGL wrapper,"['tools/emulator/opengl/tests/EGL_host_wrapper/egl.cpp', 'tools/emulator/opengl/tests/EGL_host_wrapper/Android.mk', 'tools/emulator/opengl/tests/EGL_host_wrapper/egl_proc.h', 'tools/emulator/opengl/tests/EGL_host_wrapper/egl_ftable.h', 'tools/emulator/opengl/tests/EGL_host_wrapper/egl_dispatch.h', 'tools/emulator/opengl/tests/EGL_host_wrapper/egl_dispatch.cpp']","Android emulator opengl - host side EGL wrapper

This adds an EGL wrapper used by the test rendering to load an EGL
implementation that matches the OpenGL ES impelmentation that it uses.
The library is a simple wrapper that direct EGL calls through a dispatch
table that is dynamically loaded from an EGL shared library implementation

Change-Id: I6379d6b156c69f9e017da0039c96699290f0f84f",https://android-review.googlesource.com/c/22018,"feature,test 
","feature,test 
",Feature;Test;,"{""Android.mk"": ""@@ -0,0 +1,19 @@\n+LOCAL_PATH := $(call my-dir)\n+\n+include $(CLEAR_VARS)\n+\n+LOCAL_SRC_FILES :=  \\\n+        egl.cpp \\\n+        egl_dispatch.cpp\n+\n+LOCAL_MODULE := libEGL_host_wrapper\n+LOCAL_MODULE_TAGS := debug\n+\n+OS_LDLIBS :=\n+ifeq ($(HOST_OS),linux)\n+    OS_LDLIBS := -ldl -lpthread\n+endif\n+\n+LOCAL_LDLIBS := $(OS_LDLIBS)\n+\n+include $(BUILD_HOST_SHARED_LIBRARY) \n"", ""egl.cpp"": ""@@ -0,0 +1,277 @@\n+/*\n+* Copyright (C) 2011 The Android Open Source Project\n+*\n+* Licensed under the Apache License, Version 2.0 (the \""License\"");\n+* you may not use this file except in compliance with the License.\n+* You may obtain a copy of the License at\n+*\n+* http://www.apache.org/licenses/LICENSE-2.0\n+*\n+* Unless required by applicable law or agreed to in writing, software\n+* distributed under the License is distributed on an \""AS IS\"" BASIS,\n+* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+* See the License for the specific language governing permissions and\n+* limitations under the License.\n+*/\n+#include <stdio.h>\n+#include <stdlib.h>\n+#include <string.h>\n+#include \""egl_dispatch.h\""\n+#include \""egl_ftable.h\""\n+#include <pthread.h>\n+\n+#define EGL_LIB \""ANDROID_EGL_LIB\""\n+\n+static struct egl_dispatch *s_dispatch = NULL;\n+static pthread_once_t eglDispatchInitialized = PTHREAD_ONCE_INIT;\n+\n+void initEglDispatch()\n+{\n+    //\n+    // Load back-end EGL implementation library\n+    //\n+    char *eglLib = (char *) \""libEGL.so\"";\n+    if (getenv(EGL_LIB) != NULL) {\n+        eglLib = getenv(EGL_LIB);\n+    }\n+\n+    s_dispatch = loadEGL(eglLib);\n+    if (!s_dispatch) {\n+        fprintf(stderr,\""FATAL ERROR: Could not load EGL lib [%s]\\n\"", eglLib);\n+        exit(-1);\n+    }\n+}\n+\n+static struct egl_dispatch *getDispatch()\n+{\n+    pthread_once(&eglDispatchInitialized, initEglDispatch);\n+    return s_dispatch;\n+}\n+\n+__eglMustCastToProperFunctionPointerType eglGetProcAddress(const char *procname)\n+{\n+     for (int i=0; i<egl_num_funcs; i++) {\n+         if (!strcmp(egl_funcs_by_name[i].name, procname)) {\n+             return (__eglMustCastToProperFunctionPointerType)egl_funcs_by_name[i].proc;\n+         }\n+     }\n+\n+     return getDispatch()->eglGetProcAddress(procname);\n+}\n+\n+////////////////  Path through functions //////////\n+\n+EGLint eglGetError()\n+{\n+     return getDispatch()->eglGetError();\n+}\n+\n+EGLDisplay eglGetDisplay(EGLNativeDisplayType display_id)\n+{\n+    return getDispatch()->eglGetDisplay(display_id);\n+}\n+\n+EGLBoolean eglInitialize(EGLDisplay dpy, EGLint *major, EGLint *minor)\n+{\n+     return getDispatch()->eglInitialize(dpy, major, minor);\n+}\n+\n+EGLBoolean eglTerminate(EGLDisplay dpy)\n+{\n+     return getDispatch()->eglTerminate(dpy);\n+}\n+\n+const char* eglQueryString(EGLDisplay dpy, EGLint name)\n+{\n+     return getDispatch()->eglQueryString(dpy, name);\n+}\n+\n+EGLBoolean eglGetConfigs(EGLDisplay dpy, EGLConfig *configs, EGLint config_size, EGLint *num_config)\n+{\n+     return getDispatch()->eglGetConfigs(dpy, configs, config_size, num_config);\n+}\n+\n+EGLBoolean eglChooseConfig(EGLDisplay dpy, const EGLint *attrib_list, EGLConfig *configs, EGLint config_size, EGLint *num_config)\n+{\n+     return getDispatch()->eglChooseConfig(dpy, attrib_list, configs, config_size, num_config);\n+}\n+\n+EGLBoolean eglGetConfigAttrib(EGLDisplay dpy, EGLConfig config, EGLint attribute, EGLint *value)\n+{\n+     return getDispatch()->eglGetConfigAttrib(dpy, config, attribute, value);\n+}\n+\n+EGLSurface eglCreateWindowSurface(EGLDisplay dpy, EGLConfig config, EGLNativeWindowType win, const EGLint *attrib_list)\n+{\n+     return getDispatch()->eglCreateWindowSurface(dpy, config, win, attrib_list);\n+}\n+\n+EGLSurface eglCreatePbufferSurface(EGLDisplay dpy, EGLConfig config, const EGLint *attrib_list)\n+{\n+     return getDispatch()->eglCreatePbufferSurface(dpy, config, attrib_list);\n+}\n+\n+EGLSurface eglCreatePixmapSurface(EGLDisplay dpy, EGLConfig config, EGLNativePixmapType pixmap, const EGLint *attrib_list)\n+{\n+     return getDispatch()->eglCreatePixmapSurface(dpy, config, pixmap, attrib_list);\n+}\n+\n+EGLBoolean eglDestroySurface(EGLDisplay dpy, EGLSurface surface)\n+{\n+     return getDispatch()->eglDestroySurface(dpy, surface);\n+}\n+\n+EGLBoolean eglQuerySurface(EGLDisplay dpy, EGLSurface surface, EGLint attribute, EGLint *value)\n+{\n+     return getDispatch()->eglQuerySurface(dpy, surface, attribute, value);\n+}\n+\n+EGLBoolean eglBindAPI(EGLenum api)\n+{\n+     return getDispatch()->eglBindAPI(api);\n+}\n+\n+EGLenum eglQueryAPI()\n+{\n+     return getDispatch()->eglQueryAPI();\n+}\n+\n+EGLBoolean eglWaitClient()\n+{\n+     return getDispatch()->eglWaitClient();\n+}\n+\n+EGLBoolean eglReleaseThread()\n+{\n+     return getDispatch()->eglReleaseThread();\n+}\n+\n+EGLSurface eglCreatePbufferFromClientBuffer(EGLDisplay dpy, EGLenum buftype, EGLClientBuffer buffer, EGLConfig config, const EGLint *attrib_list)\n+{\n+     return getDispatch()->eglCreatePbufferFromClientBuffer(dpy, buftype, buffer, config, attrib_list);\n+}\n+\n+EGLBoolean eglSurfaceAttrib(EGLDisplay dpy, EGLSurface surface, EGLint attribute, EGLint value)\n+{\n+     return getDispatch()->eglSurfaceAttrib(dpy, surface, attribute, value);\n+}\n+\n+EGLBoolean eglBindTexImage(EGLDisplay dpy, EGLSurface surface, EGLint buffer)\n+{\n+     return getDispatch()->eglBindTexImage(dpy, surface, buffer);\n+}\n+\n+EGLBoolean eglReleaseTexImage(EGLDisplay dpy, EGLSurface surface, EGLint buffer)\n+{\n+     return getDispatch()->eglReleaseTexImage(dpy, surface, buffer);\n+}\n+\n+EGLBoolean eglSwapInterval(EGLDisplay dpy, EGLint interval)\n+{\n+     return getDispatch()->eglSwapInterval(dpy, interval);\n+}\n+\n+EGLContext eglCreateContext(EGLDisplay dpy, EGLConfig config, EGLContext share_context, const EGLint *attrib_list)\n+{\n+     return getDispatch()->eglCreateContext(dpy, config, share_context, attrib_list);\n+}\n+\n+EGLBoolean eglDestroyContext(EGLDisplay dpy, EGLContext ctx)\n+{\n+     return getDispatch()->eglDestroyContext(dpy, ctx);\n+}\n+\n+EGLBoolean eglMakeCurrent(EGLDisplay dpy, EGLSurface draw, EGLSurface read, EGLContext ctx)\n+{\n+     return getDispatch()->eglMakeCurrent(dpy, draw, read, ctx);\n+}\n+\n+EGLContext eglGetCurrentContext()\n+{\n+     return getDispatch()->eglGetCurrentContext();\n+}\n+\n+EGLSurface eglGetCurrentSurface(EGLint readdraw)\n+{\n+     return getDispatch()->eglGetCurrentSurface(readdraw);\n+}\n+\n+EGLDisplay eglGetCurrentDisplay()\n+{\n+     return getDispatch()->eglGetCurrentDisplay();\n+}\n+\n+EGLBoolean eglQueryContext(EGLDisplay dpy, EGLContext ctx, EGLint attribute, EGLint *value)\n+{\n+     return getDispatch()->eglQueryContext(dpy, ctx, attribute, value);\n+}\n+\n+EGLBoolean eglWaitGL()\n+{\n+     return getDispatch()->eglWaitGL();\n+}\n+\n+EGLBoolean eglWaitNative(EGLint engine)\n+{\n+     return getDispatch()->eglWaitNative(engine);\n+}\n+\n+EGLBoolean eglSwapBuffers(EGLDisplay dpy, EGLSurface surface)\n+{\n+     return getDispatch()->eglSwapBuffers(dpy, surface);\n+}\n+\n+EGLBoolean eglCopyBuffers(EGLDisplay dpy, EGLSurface surface, EGLNativePixmapType target)\n+{\n+     return getDispatch()->eglCopyBuffers(dpy, surface, target);\n+}\n+\n+EGLBoolean eglLockSurfaceKHR(EGLDisplay display, EGLSurface surface, const EGLint *attrib_list)\n+{\n+     return getDispatch()->eglLockSurfaceKHR(display, surface, attrib_list);\n+}\n+\n+EGLBoolean eglUnlockSurfaceKHR(EGLDisplay display, EGLSurface surface)\n+{\n+     return getDispatch()->eglUnlockSurfaceKHR(display, surface);\n+}\n+\n+EGLImageKHR eglCreateImageKHR(EGLDisplay dpy, EGLContext ctx, EGLenum target, EGLClientBuffer buffer, const EGLint *attrib_list)\n+{\n+     return getDispatch()->eglCreateImageKHR(dpy, ctx, target, buffer, attrib_list);\n+}\n+\n+EGLBoolean eglDestroyImageKHR(EGLDisplay dpy, EGLImageKHR image)\n+{\n+     return getDispatch()->eglDestroyImageKHR(dpy, image);\n+}\n+\n+EGLSyncKHR eglCreateSyncKHR(EGLDisplay dpy, EGLenum type, const EGLint *attrib_list)\n+{\n+     return getDispatch()->eglCreateSyncKHR(dpy, type, attrib_list);\n+}\n+\n+EGLBoolean eglDestroySyncKHR(EGLDisplay dpy, EGLSyncKHR sync)\n+{\n+     return getDispatch()->eglDestroySyncKHR(dpy, sync);\n+}\n+\n+EGLint eglClientWaitSyncKHR(EGLDisplay dpy, EGLSyncKHR sync, EGLint flags, EGLTimeKHR timeout)\n+{\n+     return getDispatch()->eglClientWaitSyncKHR(dpy, sync, flags, timeout);\n+}\n+\n+EGLBoolean eglSignalSyncKHR(EGLDisplay dpy, EGLSyncKHR sync, EGLenum mode)\n+{\n+     return getDispatch()->eglSignalSyncKHR(dpy, sync, mode);\n+}\n+\n+EGLBoolean eglGetSyncAttribKHR(EGLDisplay dpy, EGLSyncKHR sync, EGLint attribute, EGLint *value)\n+{\n+     return getDispatch()->eglGetSyncAttribKHR(dpy, sync, attribute, value);\n+}\n+\n+EGLBoolean eglSetSwapRectangleANDROID(EGLDisplay dpy, EGLSurface draw, EGLint left, EGLint top, EGLint width, EGLint height)\n+{\n+     return getDispatch()->eglSetSwapRectangleANDROID(dpy, draw, left, top, width, height);\n+}\n"", ""egl_dispatch.cpp"": ""@@ -0,0 +1,77 @@\n+/*\n+* Copyright (C) 2011 The Android Open Source Project\n+*\n+* Licensed under the Apache License, Version 2.0 (the \""License\"");\n+* you may not use this file except in compliance with the License.\n+* You may obtain a copy of the License at\n+*\n+* http://www.apache.org/licenses/LICENSE-2.0\n+*\n+* Unless required by applicable law or agreed to in writing, software\n+* distributed under the License is distributed on an \""AS IS\"" BASIS,\n+* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+* See the License for the specific language governing permissions and\n+* limitations under the License.\n+*/\n+#include <stdio.h>\n+#include <dlfcn.h>\n+#include \""egl_dispatch.h\""\n+\n+\n+egl_dispatch *loadEGL(const char *p_eglPath)\n+{\n+    void *libEGL = dlopen(p_eglPath, RTLD_NOW);\n+    if (!libEGL) {\n+        return NULL;\n+    }\n+\n+    egl_dispatch *disp = new egl_dispatch;\n+\n+    void *ptr;\n+    ptr = dlsym(libEGL,\""eglGetError\""); disp->set_eglGetError((eglGetError_t)ptr);\n+    ptr = dlsym(libEGL,\""eglGetDisplay\""); disp->set_eglGetDisplay((eglGetDisplay_t)ptr);\n+    ptr = dlsym(libEGL,\""eglInitialize\""); disp->set_eglInitialize((eglInitialize_t)ptr);\n+    ptr = dlsym(libEGL,\""eglTerminate\""); disp->set_eglTerminate((eglTerminate_t)ptr);\n+    ptr = dlsym(libEGL,\""eglQueryString\""); disp->set_eglQueryString((eglQueryString_t)ptr);\n+    ptr = dlsym(libEGL,\""eglGetConfigs\""); disp->set_eglGetConfigs((eglGetConfigs_t)ptr);\n+    ptr = dlsym(libEGL,\""eglChooseConfig\""); disp->set_eglChooseConfig((eglChooseConfig_t)ptr);\n+    ptr = dlsym(libEGL,\""eglGetConfigAttrib\""); disp->set_eglGetConfigAttrib((eglGetConfigAttrib_t)ptr);\n+    ptr = dlsym(libEGL,\""eglCreateWindowSurface\""); disp->set_eglCreateWindowSurface((eglCreateWindowSurface_t)ptr);\n+    ptr = dlsym(libEGL,\""eglCreatePbufferSurface\""); disp->set_eglCreatePbufferSurface((eglCreatePbufferSurface_t)ptr);\n+    ptr = dlsym(libEGL,\""eglCreatePixmapSurface\""); disp->set_eglCreatePixmapSurface((eglCreatePixmapSurface_t)ptr);\n+    ptr = dlsym(libEGL,\""eglDestroySurface\""); disp->set_eglDestroySurface((eglDestroySurface_t)ptr);\n+    ptr = dlsym(libEGL,\""eglQuerySurface\""); disp->set_eglQuerySurface((eglQuerySurface_t)ptr);\n+    ptr = dlsym(libEGL,\""eglBindAPI\""); disp->set_eglBindAPI((eglBindAPI_t)ptr);\n+    ptr = dlsym(libEGL,\""eglQueryAPI\""); disp->set_eglQueryAPI((eglQueryAPI_t)ptr);\n+    ptr = dlsym(libEGL,\""eglWaitClient\""); disp->set_eglWaitClient((eglWaitClient_t)ptr);\n+    ptr = dlsym(libEGL,\""eglReleaseThread\""); disp->set_eglReleaseThread((eglReleaseThread_t)ptr);\n+    ptr = dlsym(libEGL,\""eglCreatePbufferFromClientBuffer\""); disp->set_eglCreatePbufferFromClientBuffer((eglCreatePbufferFromClientBuffer_t)ptr);\n+    ptr = dlsym(libEGL,\""eglSurfaceAttrib\""); disp->set_eglSurfaceAttrib((eglSurfaceAttrib_t)ptr);\n+    ptr = dlsym(libEGL,\""eglBindTexImage\""); disp->set_eglBindTexImage((eglBindTexImage_t)ptr);\n+    ptr = dlsym(libEGL,\""eglReleaseTexImage\""); disp->set_eglReleaseTexImage((eglReleaseTexImage_t)ptr);\n+    ptr = dlsym(libEGL,\""eglSwapInterval\""); disp->set_eglSwapInterval((eglSwapInterval_t)ptr);\n+    ptr = dlsym(libEGL,\""eglCreateContext\""); disp->set_eglCreateContext((eglCreateContext_t)ptr);\n+    ptr = dlsym(libEGL,\""eglDestroyContext\""); disp->set_eglDestroyContext((eglDestroyContext_t)ptr);\n+    ptr = dlsym(libEGL,\""eglMakeCurrent\""); disp->set_eglMakeCurrent((eglMakeCurrent_t)ptr);\n+    ptr = dlsym(libEGL,\""eglGetCurrentContext\""); disp->set_eglGetCurrentContext((eglGetCurrentContext_t)ptr);\n+    ptr = dlsym(libEGL,\""eglGetCurrentSurface\""); disp->set_eglGetCurrentSurface((eglGetCurrentSurface_t)ptr);\n+    ptr = dlsym(libEGL,\""eglGetCurrentDisplay\""); disp->set_eglGetCurrentDisplay((eglGetCurrentDisplay_t)ptr);\n+    ptr = dlsym(libEGL,\""eglQueryContext\""); disp->set_eglQueryContext((eglQueryContext_t)ptr);\n+    ptr = dlsym(libEGL,\""eglWaitGL\""); disp->set_eglWaitGL((eglWaitGL_t)ptr);\n+    ptr = dlsym(libEGL,\""eglWaitNative\""); disp->set_eglWaitNative((eglWaitNative_t)ptr);\n+    ptr = dlsym(libEGL,\""eglSwapBuffers\""); disp->set_eglSwapBuffers((eglSwapBuffers_t)ptr);\n+    ptr = dlsym(libEGL,\""eglCopyBuffers\""); disp->set_eglCopyBuffers((eglCopyBuffers_t)ptr);\n+    ptr = dlsym(libEGL,\""eglGetProcAddress\""); disp->set_eglGetProcAddress((eglGetProcAddress_t)ptr);\n+    ptr = dlsym(libEGL,\""eglLockSurfaceKHR\""); disp->set_eglLockSurfaceKHR((eglLockSurfaceKHR_t)ptr);\n+    ptr = dlsym(libEGL,\""eglUnlockSurfaceKHR\""); disp->set_eglUnlockSurfaceKHR((eglUnlockSurfaceKHR_t)ptr);\n+    ptr = dlsym(libEGL,\""eglCreateImageKHR\""); disp->set_eglCreateImageKHR((eglCreateImageKHR_t)ptr);\n+    ptr = dlsym(libEGL,\""eglDestroyImageKHR\""); disp->set_eglDestroyImageKHR((eglDestroyImageKHR_t)ptr);\n+    ptr = dlsym(libEGL,\""eglCreateSyncKHR\""); disp->set_eglCreateSyncKHR((eglCreateSyncKHR_t)ptr);\n+    ptr = dlsym(libEGL,\""eglDestroySyncKHR\""); disp->set_eglDestroySyncKHR((eglDestroySyncKHR_t)ptr);\n+    ptr = dlsym(libEGL,\""eglClientWaitSyncKHR\""); disp->set_eglClientWaitSyncKHR((eglClientWaitSyncKHR_t)ptr);\n+    ptr = dlsym(libEGL,\""eglSignalSyncKHR\""); disp->set_eglSignalSyncKHR((eglSignalSyncKHR_t)ptr);\n+    ptr = dlsym(libEGL,\""eglGetSyncAttribKHR\""); disp->set_eglGetSyncAttribKHR((eglGetSyncAttribKHR_t)ptr);\n+    ptr = dlsym(libEGL,\""eglSetSwapRectangleANDROID\""); disp->set_eglSetSwapRectangleANDROID((eglSetSwapRectangleANDROID_t)ptr);\n+\n+    return disp;\n+}\n"", ""egl_dispatch.h"": ""@@ -0,0 +1,115 @@\n+/*\n+* Copyright (C) 2011 The Android Open Source Project\n+*\n+* Licensed under the Apache License, Version 2.0 (the \""License\"");\n+* you may not use this file except in compliance with the License.\n+* You may obtain a copy of the License at\n+*\n+* http://www.apache.org/licenses/LICENSE-2.0\n+*\n+* Unless required by applicable law or agreed to in writing, software\n+* distributed under the License is distributed on an \""AS IS\"" BASIS,\n+* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+* See the License for the specific language governing permissions and\n+* limitations under the License.\n+*/\n+#ifndef _EGL_DISPATCH_H\n+#define _EGL_DISPATCH_H\n+\n+#include \""egl_proc.h\""\n+\n+struct egl_dispatch {\n+    eglGetError_t eglGetError;\n+    eglGetDisplay_t eglGetDisplay;\n+    eglInitialize_t eglInitialize;\n+    eglTerminate_t eglTerminate;\n+    eglQueryString_t eglQueryString;\n+    eglGetConfigs_t eglGetConfigs;\n+    eglChooseConfig_t eglChooseConfig;\n+    eglGetConfigAttrib_t eglGetConfigAttrib;\n+    eglCreateWindowSurface_t eglCreateWindowSurface;\n+    eglCreatePbufferSurface_t eglCreatePbufferSurface;\n+    eglCreatePixmapSurface_t eglCreatePixmapSurface;\n+    eglDestroySurface_t eglDestroySurface;\n+    eglQuerySurface_t eglQuerySurface;\n+    eglBindAPI_t eglBindAPI;\n+    eglQueryAPI_t eglQueryAPI;\n+    eglWaitClient_t eglWaitClient;\n+    eglReleaseThread_t eglReleaseThread;\n+    eglCreatePbufferFromClientBuffer_t eglCreatePbufferFromClientBuffer;\n+    eglSurfaceAttrib_t eglSurfaceAttrib;\n+    eglBindTexImage_t eglBindTexImage;\n+    eglReleaseTexImage_t eglReleaseTexImage;\n+    eglSwapInterval_t eglSwapInterval;\n+    eglCreateContext_t eglCreateContext;\n+    eglDestroyContext_t eglDestroyContext;\n+    eglMakeCurrent_t eglMakeCurrent;\n+    eglGetCurrentContext_t eglGetCurrentContext;\n+    eglGetCurrentSurface_t eglGetCurrentSurface;\n+    eglGetCurrentDisplay_t eglGetCurrentDisplay;\n+    eglQueryContext_t eglQueryContext;\n+    eglWaitGL_t eglWaitGL;\n+    eglWaitNative_t eglWaitNative;\n+    eglSwapBuffers_t eglSwapBuffers;\n+    eglCopyBuffers_t eglCopyBuffers;\n+    eglGetProcAddress_t eglGetProcAddress;\n+    eglLockSurfaceKHR_t eglLockSurfaceKHR;\n+    eglUnlockSurfaceKHR_t eglUnlockSurfaceKHR;\n+    eglCreateImageKHR_t eglCreateImageKHR;\n+    eglDestroyImageKHR_t eglDestroyImageKHR;\n+    eglCreateSyncKHR_t eglCreateSyncKHR;\n+    eglDestroySyncKHR_t eglDestroySyncKHR;\n+    eglClientWaitSyncKHR_t eglClientWaitSyncKHR;\n+    eglSignalSyncKHR_t eglSignalSyncKHR;\n+    eglGetSyncAttribKHR_t eglGetSyncAttribKHR;\n+    eglSetSwapRectangleANDROID_t eglSetSwapRectangleANDROID;\n+    //Accessors\n+    eglGetError_t set_eglGetError(eglGetError_t f) { eglGetError_t retval = eglGetError; eglGetError = f; return retval;}\n+    eglGetDisplay_t set_eglGetDisplay(eglGetDisplay_t f) { eglGetDisplay_t retval = eglGetDisplay; eglGetDisplay = f; return retval;}\n+    eglInitialize_t set_eglInitialize(eglInitialize_t f) { eglInitialize_t retval = eglInitialize; eglInitialize = f; return retval;}\n+    eglTerminate_t set_eglTerminate(eglTerminate_t f) { eglTerminate_t retval = eglTerminate; eglTerminate = f; return retval;}\n+    eglQueryString_t set_eglQueryString(eglQueryString_t f) { eglQueryString_t retval = eglQueryString; eglQueryString = f; return retval;}\n+    eglGetConfigs_t set_eglGetConfigs(eglGetConfigs_t f) { eglGetConfigs_t retval = eglGetConfigs; eglGetConfigs = f; return retval;}\n+    eglChooseConfig_t set_eglChooseConfig(eglChooseConfig_t f) { eglChooseConfig_t retval = eglChooseConfig; eglChooseConfig = f; return retval;}\n+    eglGetConfigAttrib_t set_eglGetConfigAttrib(eglGetConfigAttrib_t f) { eglGetConfigAttrib_t retval = eglGetConfigAttrib; eglGetConfigAttrib = f; return retval;}\n+    eglCreateWindowSurface_t set_eglCreateWindowSurface(eglCreateWindowSurface_t f) { eglCreateWindowSurface_t retval = eglCreateWindowSurface; eglCreateWindowSurface = f; return retval;}\n+    eglCreatePbufferSurface_t set_eglCreatePbufferSurface(eglCreatePbufferSurface_t f) { eglCreatePbufferSurface_t retval = eglCreatePbufferSurface; eglCreatePbufferSurface = f; return retval;}\n+    eglCreatePixmapSurface_t set_eglCreatePixmapSurface(eglCreatePixmapSurface_t f) { eglCreatePixmapSurface_t retval = eglCreatePixmapSurface; eglCreatePixmapSurface = f; return retval;}\n+    eglDestroySurface_t set_eglDestroySurface(eglDestroySurface_t f) { eglDestroySurface_t retval = eglDestroySurface; eglDestroySurface = f; return retval;}\n+    eglQuerySurface_t set_eglQuerySurface(eglQuerySurface_t f) { eglQuerySurface_t retval = eglQuerySurface; eglQuerySurface = f; return retval;}\n+    eglBindAPI_t set_eglBindAPI(eglBindAPI_t f) { eglBindAPI_t retval = eglBindAPI; eglBindAPI = f; return retval;}\n+    eglQueryAPI_t set_eglQueryAPI(eglQueryAPI_t f) { eglQueryAPI_t retval = eglQueryAPI; eglQueryAPI = f; return retval;}\n+    eglWaitClient_t set_eglWaitClient(eglWaitClient_t f) { eglWaitClient_t retval = eglWaitClient; eglWaitClient = f; return retval;}\n+    eglReleaseThread_t set_eglReleaseThread(eglReleaseThread_t f) { eglReleaseThread_t retval = eglReleaseThread; eglReleaseThread = f; return retval;}\n+    eglCreatePbufferFromClientBuffer_t set_eglCreatePbufferFromClientBuffer(eglCreatePbufferFromClientBuffer_t f) { eglCreatePbufferFromClientBuffer_t retval = eglCreatePbufferFromClientBuffer; eglCreatePbufferFromClientBuffer = f; return retval;}\n+    eglSurfaceAttrib_t set_eglSurfaceAttrib(eglSurfaceAttrib_t f) { eglSurfaceAttrib_t retval = eglSurfaceAttrib; eglSurfaceAttrib = f; return retval;}\n+    eglBindTexImage_t set_eglBindTexImage(eglBindTexImage_t f) { eglBindTexImage_t retval = eglBindTexImage; eglBindTexImage = f; return retval;}\n+    eglReleaseTexImage_t set_eglReleaseTexImage(eglReleaseTexImage_t f) { eglReleaseTexImage_t retval = eglReleaseTexImage; eglReleaseTexImage = f; return retval;}\n+    eglSwapInterval_t set_eglSwapInterval(eglSwapInterval_t f) { eglSwapInterval_t retval = eglSwapInterval; eglSwapInterval = f; return retval;}\n+    eglCreateContext_t set_eglCreateContext(eglCreateContext_t f) { eglCreateContext_t retval = eglCreateContext; eglCreateContext = f; return retval;}\n+    eglDestroyContext_t set_eglDestroyContext(eglDestroyContext_t f) { eglDestroyContext_t retval = eglDestroyContext; eglDestroyContext = f; return retval;}\n+    eglMakeCurrent_t set_eglMakeCurrent(eglMakeCurrent_t f) { eglMakeCurrent_t retval = eglMakeCurrent; eglMakeCurrent = f; return retval;}\n+    eglGetCurrentContext_t set_eglGetCurrentContext(eglGetCurrentContext_t f) { eglGetCurrentContext_t retval = eglGetCurrentContext; eglGetCurrentContext = f; return retval;}\n+    eglGetCurrentSurface_t set_eglGetCurrentSurface(eglGetCurrentSurface_t f) { eglGetCurrentSurface_t retval = eglGetCurrentSurface; eglGetCurrentSurface = f; return retval;}\n+    eglGetCurrentDisplay_t set_eglGetCurrentDisplay(eglGetCurrentDisplay_t f) { eglGetCurrentDisplay_t retval = eglGetCurrentDisplay; eglGetCurrentDisplay = f; return retval;}\n+    eglQueryContext_t set_eglQueryContext(eglQueryContext_t f) { eglQueryContext_t retval = eglQueryContext; eglQueryContext = f; return retval;}\n+    eglWaitGL_t set_eglWaitGL(eglWaitGL_t f) { eglWaitGL_t retval = eglWaitGL; eglWaitGL = f; return retval;}\n+    eglWaitNative_t set_eglWaitNative(eglWaitNative_t f) { eglWaitNative_t retval = eglWaitNative; eglWaitNative = f; return retval;}\n+    eglSwapBuffers_t set_eglSwapBuffers(eglSwapBuffers_t f) { eglSwapBuffers_t retval = eglSwapBuffers; eglSwapBuffers = f; return retval;}\n+    eglCopyBuffers_t set_eglCopyBuffers(eglCopyBuffers_t f) { eglCopyBuffers_t retval = eglCopyBuffers; eglCopyBuffers = f; return retval;}\n+    eglGetProcAddress_t set_eglGetProcAddress(eglGetProcAddress_t f) { eglGetProcAddress_t retval = eglGetProcAddress; eglGetProcAddress = f; return retval;}\n+    eglLockSurfaceKHR_t set_eglLockSurfaceKHR(eglLockSurfaceKHR_t f) { eglLockSurfaceKHR_t retval = eglLockSurfaceKHR; eglLockSurfaceKHR = f; return retval;}\n+    eglUnlockSurfaceKHR_t set_eglUnlockSurfaceKHR(eglUnlockSurfaceKHR_t f) { eglUnlockSurfaceKHR_t retval = eglUnlockSurfaceKHR; eglUnlockSurfaceKHR = f; return retval;}\n+    eglCreateImageKHR_t set_eglCreateImageKHR(eglCreateImageKHR_t f) { eglCreateImageKHR_t retval = eglCreateImageKHR; eglCreateImageKHR = f; return retval;}\n+    eglDestroyImageKHR_t set_eglDestroyImageKHR(eglDestroyImageKHR_t f) { eglDestroyImageKHR_t retval = eglDestroyImageKHR; eglDestroyImageKHR = f; return retval;}\n+    eglCreateSyncKHR_t set_eglCreateSyncKHR(eglCreateSyncKHR_t f) { eglCreateSyncKHR_t retval = eglCreateSyncKHR; eglCreateSyncKHR = f; return retval;}\n+    eglDestroySyncKHR_t set_eglDestroySyncKHR(eglDestroySyncKHR_t f) { eglDestroySyncKHR_t retval = eglDestroySyncKHR; eglDestroySyncKHR = f; return retval;}\n+    eglClientWaitSyncKHR_t set_eglClientWaitSyncKHR(eglClientWaitSyncKHR_t f) { eglClientWaitSyncKHR_t retval = eglClientWaitSyncKHR; eglClientWaitSyncKHR = f; return retval;}\n+    eglSignalSyncKHR_t set_eglSignalSyncKHR(eglSignalSyncKHR_t f) { eglSignalSyncKHR_t retval = eglSignalSyncKHR; eglSignalSyncKHR = f; return retval;}\n+    eglGetSyncAttribKHR_t set_eglGetSyncAttribKHR(eglGetSyncAttribKHR_t f) { eglGetSyncAttribKHR_t retval = eglGetSyncAttribKHR; eglGetSyncAttribKHR = f; return retval;}\n+    eglSetSwapRectangleANDROID_t set_eglSetSwapRectangleANDROID(eglSetSwapRectangleANDROID_t f) { eglSetSwapRectangleANDROID_t retval = eglSetSwapRectangleANDROID; eglSetSwapRectangleANDROID = f; return retval;}\n+};\n+\n+egl_dispatch *loadEGL(const char *p_eglPath);\n+\n+#endif\n"", ""egl_ftable.h"": ""@@ -0,0 +1,66 @@\n+/*\n+* Copyright (C) 2011 The Android Open Source Project\n+*\n+* Licensed under the Apache License, Version 2.0 (the \""License\"");\n+* you may not use this file except in compliance with the License.\n+* You may obtain a copy of the License at\n+*\n+* http://www.apache.org/licenses/LICENSE-2.0\n+*\n+* Unless required by applicable law or agreed to in writing, software\n+* distributed under the License is distributed on an \""AS IS\"" BASIS,\n+* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+* See the License for the specific language governing permissions and\n+* limitations under the License.\n+*/\n+static struct _egl_funcs_by_name {\n+    const char *name;\n+    void *proc;\n+} egl_funcs_by_name[] = {\n+    {\""eglGetError\"", (void *)eglGetError},\n+    {\""eglGetDisplay\"", (void *)eglGetDisplay},\n+    {\""eglInitialize\"", (void *)eglInitialize},\n+    {\""eglTerminate\"", (void *)eglTerminate},\n+    {\""eglQueryString\"", (void *)eglQueryString},\n+    {\""eglGetConfigs\"", (void *)eglGetConfigs},\n+    {\""eglChooseConfig\"", (void *)eglChooseConfig},\n+    {\""eglGetConfigAttrib\"", (void *)eglGetConfigAttrib},\n+    {\""eglCreateWindowSurface\"", (void *)eglCreateWindowSurface},\n+    {\""eglCreatePbufferSurface\"", (void *)eglCreatePbufferSurface},\n+    {\""eglCreatePixmapSurface\"", (void *)eglCreatePixmapSurface},\n+    {\""eglDestroySurface\"", (void *)eglDestroySurface},\n+    {\""eglQuerySurface\"", (void *)eglQuerySurface},\n+    {\""eglBindAPI\"", (void *)eglBindAPI},\n+    {\""eglQueryAPI\"", (void *)eglQueryAPI},\n+    {\""eglWaitClient\"", (void *)eglWaitClient},\n+    {\""eglReleaseThread\"", (void *)eglReleaseThread},\n+    {\""eglCreatePbufferFromClientBuffer\"", (void *)eglCreatePbufferFromClientBuffer},\n+    {\""eglSurfaceAttrib\"", (void *)eglSurfaceAttrib},\n+    {\""eglBindTexImage\"", (void *)eglBindTexImage},\n+    {\""eglReleaseTexImage\"", (void *)eglReleaseTexImage},\n+    {\""eglSwapInterval\"", (void *)eglSwapInterval},\n+    {\""eglCreateContext\"", (void *)eglCreateContext},\n+    {\""eglDestroyContext\"", (void *)eglDestroyContext},\n+    {\""eglMakeCurrent\"", (void *)eglMakeCurrent},\n+    {\""eglGetCurrentContext\"", (void *)eglGetCurrentContext},\n+    {\""eglGetCurrentSurface\"", (void *)eglGetCurrentSurface},\n+    {\""eglGetCurrentDisplay\"", (void *)eglGetCurrentDisplay},\n+    {\""eglQueryContext\"", (void *)eglQueryContext},\n+    {\""eglWaitGL\"", (void *)eglWaitGL},\n+    {\""eglWaitNative\"", (void *)eglWaitNative},\n+    {\""eglSwapBuffers\"", (void *)eglSwapBuffers},\n+    {\""eglCopyBuffers\"", (void *)eglCopyBuffers},\n+    {\""eglGetProcAddress\"", (void *)eglGetProcAddress},\n+    {\""eglLockSurfaceKHR\"", (void *)eglLockSurfaceKHR},\n+    {\""eglUnlockSurfaceKHR\"", (void *)eglUnlockSurfaceKHR},\n+    {\""eglCreateImageKHR\"", (void *)eglCreateImageKHR},\n+    {\""eglDestroyImageKHR\"", (void *)eglDestroyImageKHR},\n+    {\""eglCreateSyncKHR\"", (void *)eglCreateSyncKHR},\n+    {\""eglDestroySyncKHR\"", (void *)eglDestroySyncKHR},\n+    {\""eglClientWaitSyncKHR\"", (void *)eglClientWaitSyncKHR},\n+    {\""eglSignalSyncKHR\"", (void *)eglSignalSyncKHR},\n+    {\""eglGetSyncAttribKHR\"", (void *)eglGetSyncAttribKHR},\n+    {\""eglSetSwapRectangleANDROID\"", (void *)eglSetSwapRectangleANDROID}\n+};\n+\n+static int egl_num_funcs = sizeof(egl_funcs_by_name) / sizeof(struct _egl_funcs_by_name);\n"", ""egl_proc.h"": ""@@ -0,0 +1,68 @@\n+/*\n+* Copyright (C) 2011 The Android Open Source Project\n+*\n+* Licensed under the Apache License, Version 2.0 (the \""License\"");\n+* you may not use this file except in compliance with the License.\n+* You may obtain a copy of the License at\n+*\n+* http://www.apache.org/licenses/LICENSE-2.0\n+*\n+* Unless required by applicable law or agreed to in writing, software\n+* distributed under the License is distributed on an \""AS IS\"" BASIS,\n+* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+* See the License for the specific language governing permissions and\n+* limitations under the License.\n+*/\n+#ifndef _EGL_PROC_H\n+#define _EGL_PROC_H\n+\n+#include <EGL/egl.h>\n+#define EGL_EGLEXT_PROTOTYPES\n+#include <EGL/eglext.h>\n+\n+typedef EGLint (* eglGetError_t) ();\n+typedef EGLDisplay (* eglGetDisplay_t) (EGLNativeDisplayType);\n+typedef EGLBoolean (* eglInitialize_t) (EGLDisplay, EGLint*, EGLint*);\n+typedef EGLBoolean (* eglTerminate_t) (EGLDisplay);\n+typedef char* (* eglQueryString_t) (EGLDisplay, EGLint);\n+typedef EGLBoolean (* eglGetConfigs_t) (EGLDisplay, EGLConfig*, EGLint, EGLint*);\n+typedef EGLBoolean (* eglChooseConfig_t) (EGLDisplay, const EGLint*, EGLConfig*, EGLint, EGLint*);\n+typedef EGLBoolean (* eglGetConfigAttrib_t) (EGLDisplay, EGLConfig, EGLint, EGLint*);\n+typedef EGLSurface (* eglCreateWindowSurface_t) (EGLDisplay, EGLConfig, EGLNativeWindowType, const EGLint*);\n+typedef EGLSurface (* eglCreatePbufferSurface_t) (EGLDisplay, EGLConfig, const EGLint*);\n+typedef EGLSurface (* eglCreatePixmapSurface_t) (EGLDisplay, EGLConfig, EGLNativePixmapType, const EGLint*);\n+typedef EGLBoolean (* eglDestroySurface_t) (EGLDisplay, EGLSurface);\n+typedef EGLBoolean (* eglQuerySurface_t) (EGLDisplay, EGLSurface, EGLint, EGLint*);\n+typedef EGLBoolean (* eglBindAPI_t) (EGLenum);\n+typedef EGLenum (* eglQueryAPI_t) ();\n+typedef EGLBoolean (* eglWaitClient_t) ();\n+typedef EGLBoolean (* eglReleaseThread_t) ();\n+typedef EGLSurface (* eglCreatePbufferFromClientBuffer_t) (EGLDisplay, EGLenum, EGLClientBuffer, EGLConfig, const EGLint*);\n+typedef EGLBoolean (* eglSurfaceAttrib_t) (EGLDisplay, EGLSurface, EGLint, EGLint);\n+typedef EGLBoolean (* eglBindTexImage_t) (EGLDisplay, EGLSurface, EGLint);\n+typedef EGLBoolean (* eglReleaseTexImage_t) (EGLDisplay, EGLSurface, EGLint);\n+typedef EGLBoolean (* eglSwapInterval_t) (EGLDisplay, EGLint);\n+typedef EGLContext (* eglCreateContext_t) (EGLDisplay, EGLConfig, EGLContext, const EGLint*);\n+typedef EGLBoolean (* eglDestroyContext_t) (EGLDisplay, EGLContext);\n+typedef EGLBoolean (* eglMakeCurrent_t) (EGLDisplay, EGLSurface, EGLSurface, EGLContext);\n+typedef EGLContext (* eglGetCurrentContext_t) ();\n+typedef EGLSurface (* eglGetCurrentSurface_t) (EGLint);\n+typedef EGLDisplay (* eglGetCurrentDisplay_t) ();\n+typedef EGLBoolean (* eglQueryContext_t) (EGLDisplay, EGLContext, EGLint, EGLint*);\n+typedef EGLBoolean (* eglWaitGL_t) ();\n+typedef EGLBoolean (* eglWaitNative_t) (EGLint);\n+typedef EGLBoolean (* eglSwapBuffers_t) (EGLDisplay, EGLSurface);\n+typedef EGLBoolean (* eglCopyBuffers_t) (EGLDisplay, EGLSurface, EGLNativePixmapType);\n+typedef __eglMustCastToProperFunctionPointerType (* eglGetProcAddress_t) (const char*);\n+typedef EGLBoolean (* eglLockSurfaceKHR_t) (EGLDisplay, EGLSurface, const EGLint*);\n+typedef EGLBoolean (* eglUnlockSurfaceKHR_t) (EGLDisplay, EGLSurface);\n+typedef EGLImageKHR (* eglCreateImageKHR_t) (EGLDisplay, EGLContext, EGLenum, EGLClientBuffer, const EGLint*);\n+typedef EGLBoolean (* eglDestroyImageKHR_t) (EGLDisplay, EGLImageKHR image);\n+typedef EGLSyncKHR (* eglCreateSyncKHR_t) (EGLDisplay, EGLenum, const EGLint*);\n+typedef EGLBoolean (* eglDestroySyncKHR_t) (EGLDisplay, EGLSyncKHR sync);\n+typedef EGLint (* eglClientWaitSyncKHR_t) (EGLDisplay, EGLSyncKHR, EGLint, EGLTimeKHR timeout);\n+typedef EGLBoolean (* eglSignalSyncKHR_t) (EGLDisplay, EGLSyncKHR, EGLenum);\n+typedef EGLBoolean (* eglGetSyncAttribKHR_t) (EGLDisplay, EGLSyncKHR, EGLint, EGLint*);\n+typedef EGLBoolean (* eglSetSwapRectangleANDROID_t) (EGLDisplay, EGLSurface, EGLint, EGLint, EGLint, EGLint);\n+\n+#endif // of  _EGL_PROC_H\n""}","feature,test 
"
11375,Kenny Root,Don't use OpenSSL Engines in wpa_supplicant,['Android.mk'],"Don't use OpenSSL Engines in wpa_supplicant

The Android OpenSSL tree directs us to remove the engines subdir, so we
shouldn't try to use engines in wpa_supplicant.

Change-Id: I53c8381a743b4c97857d61af813d7e408e2e5ea8",https://android-review.googlesource.com/c/11375,"bug 
",bug,Deprecat;Resource;,"{""Android.mk"": ""@@ -31,7 +31,7 @@ L_CFLAGS += -mabi=aapcs-linux\n endif\n \n # To ignore possible wrong network configurations\n-L_CFLAGS += -DWPA_IGNORE_CONFIG_ERRORS\n+L_CFLAGS += -DWPA_IGNORE_CONFIG_ERRORS -DOPENSSL_NO_ENGINE\n \n INCLUDES = external/openssl/include frameworks/base/cmds/keystore\n   \n""}","feature 
"
16457,Brian Muramatsu,CtsVerifier Suid File Scanner,"['apps/CtsVerifier/src/com/android/cts/verifier/suid/SuidFilesActivity.java', 'apps/CtsVerifier/src/com/android/cts/verifier/os/FileUtils.java', 'apps/CtsVerifier/jni/com_android_cts_verifier_os_FileUtils.cpp', 'apps/CtsVerifier/res/values/strings.xml', 'apps/CtsVerifier/jni/Android.mk', 'apps/CtsVerifier/Android.mk', 'apps/CtsVerifier/jni/CtsVerifierJniOnLoad.cpp', 'apps/CtsVerifier/AndroidManifest.xml']","CtsVerifier Suid File Scanner

Bug 2732160

Create an activity for the CtsVerifier (a collection of manual tests)
that scans for suid files. This was not made into unit test, because
it is not comprehensive enough to guarantee that all suid files are
found. Furthermore, there is no way to say what the official list of
binaries should be permitted across all Android devices.

Here is a shortcut command for developing just this activity and
avoiding the welcome and manual test list screens:

mmm cts/apps &&
adb install -r out/target/product/generic/data/app/CtsVerifier.apk &&
adb shell ""am start -n com.android.cts.verifier/.suid.SuidFilesActivity""

Change-Id: I98521bea565b9315a41c8dc005d8adfd9178621b",https://android-review.googlesource.com/c/16457,"feature, test 
","bug,feature,test",Bug;Test;,"{""Android.mk"": ""@@ -0,0 +1,32 @@\n+#\n+# Copyright (C) 2010 The Android Open Source Project\n+#\n+# Licensed under the Apache License, Version 2.0 (the \""License\"");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \""AS IS\"" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+LOCAL_PATH:= $(call my-dir)\n+include $(CLEAR_VARS)\n+\n+LOCAL_MODULE := libctsverifier_jni\n+\n+LOCAL_MODULE_TAGS := optional\n+\n+LOCAL_PRELINK_MODULE := false\n+\n+LOCAL_SRC_FILES := \\\n+\t\tCtsVerifierJniOnLoad.cpp \\\n+\t\tcom_android_cts_verifier_os_FileUtils.cpp\t\n+\n+LOCAL_C_INCLUDES := $(JNI_H_INCLUDE)\n+\n+include $(BUILD_SHARED_LIBRARY)\n"", ""AndroidManifest.xml"": ""@@ -19,6 +19,8 @@\n       package=\""com.android.cts.verifier\""\n       android:versionCode=\""1\""\n       android:versionName=\""1.0\"">\n+      \n+    <uses-sdk android:minSdkVersion=\""5\"" />\n \n     <application android:label=\""@string/app_name\"">\n \n@@ -31,7 +33,9 @@\n \n         <activity android:name=\"".TestListActivity\"" android:label=\""@string/test_list_title\"" />\n \n-        <activity android:name=\"".suid.SuidBinariesActivity\"" android:label=\""@string/suid_binaries\"">\n+        <activity android:name=\"".suid.SuidFilesActivity\"" \n+                android:label=\""@string/suid_files\""\n+                android:configChanges=\""keyboardHidden|orientation\"">\n             <intent-filter>\n                 <action android:name=\""android.intent.action.MAIN\"" />\n                 <category android:name=\""android.cts.intent.category.MANUAL_TEST\"" />\n"", ""CtsVerifierJniOnLoad.cpp"": ""@@ -1,4 +1,4 @@\n-/*\n+/* \n  * Copyright (C) 2010 The Android Open Source Project\n  *\n  * Licensed under the Apache License, Version 2.0 (the \""License\"");\n@@ -14,15 +14,21 @@\n  * limitations under the License.\n  */\n \n-package com.android.cts.verifier.suid;\n+#include <jni.h>\n+#include <stdio.h>\n \n-import android.app.Activity;\n-import android.os.Bundle;\n+extern int register_com_android_cts_verifier_os_FileUtils(JNIEnv*);\n \n-public class SuidBinariesActivity extends Activity {\n+jint JNI_OnLoad(JavaVM *vm, void *reserved) {\n+    JNIEnv *env = NULL;\n \n-    @Override\n-    protected void onCreate(Bundle savedInstanceState) {\n-        super.onCreate(savedInstanceState);\n+    if (vm->GetEnv((void **) &env, JNI_VERSION_1_4) != JNI_OK) {\n+        return JNI_ERR;\n     }\n+\n+    if (register_com_android_cts_verifier_os_FileUtils(env)) {\n+        return JNI_ERR;\n+    }\n+\n+    return JNI_VERSION_1_4;\n }\n"", ""com_android_cts_verifier_os_FileUtils.cpp"": ""@@ -0,0 +1,114 @@\n+/* \n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+#include <jni.h>\n+#include <stdio.h>\n+#include <sys/types.h>\n+#include <sys/stat.h>\n+#include <grp.h>\n+#include <pwd.h>\n+\n+static jclass gFileStatusClass;\n+static jfieldID gFileStatusDevFieldID;\n+static jfieldID gFileStatusInoFieldID;\n+static jfieldID gFileStatusModeFieldID;\n+static jfieldID gFileStatusNlinkFieldID;\n+static jfieldID gFileStatusUidFieldID;\n+static jfieldID gFileStatusGidFieldID;\n+static jfieldID gFileStatusSizeFieldID;\n+static jfieldID gFileStatusBlksizeFieldID;\n+static jfieldID gFileStatusBlocksFieldID;\n+static jfieldID gFileStatusAtimeFieldID;\n+static jfieldID gFileStatusMtimeFieldID;\n+static jfieldID gFileStatusCtimeFieldID;\n+\n+/* Copied from hidden API: frameworks/base/core/jni/android_os_FileUtils.cpp */\n+jboolean com_android_cts_verifier_os_FileUtils_getFileStatus(JNIEnv* env, jobject thiz,\n+        jstring path, jobject fileStatus, jboolean statLinks)\n+{\n+    const char* pathStr = env->GetStringUTFChars(path, NULL);\n+    jboolean ret = false;\n+    struct stat s;\n+\n+    int res = statLinks == true ? lstat(pathStr, &s) : stat(pathStr, &s);\n+\n+    if (res == 0) {\n+        ret = true;\n+        if (fileStatus != NULL) {\n+            env->SetIntField(fileStatus, gFileStatusDevFieldID, s.st_dev);\n+            env->SetIntField(fileStatus, gFileStatusInoFieldID, s.st_ino);\n+            env->SetIntField(fileStatus, gFileStatusModeFieldID, s.st_mode);\n+            env->SetIntField(fileStatus, gFileStatusNlinkFieldID, s.st_nlink);\n+            env->SetIntField(fileStatus, gFileStatusUidFieldID, s.st_uid);\n+            env->SetIntField(fileStatus, gFileStatusGidFieldID, s.st_gid);\n+            env->SetLongField(fileStatus, gFileStatusSizeFieldID, s.st_size);\n+            env->SetIntField(fileStatus, gFileStatusBlksizeFieldID, s.st_blksize);\n+            env->SetLongField(fileStatus, gFileStatusBlocksFieldID, s.st_blocks);\n+            env->SetLongField(fileStatus, gFileStatusAtimeFieldID, s.st_atime);\n+            env->SetLongField(fileStatus, gFileStatusMtimeFieldID, s.st_mtime);\n+            env->SetLongField(fileStatus, gFileStatusCtimeFieldID, s.st_ctime);\n+        }\n+    }\n+\n+    env->ReleaseStringUTFChars(path, pathStr);\n+\n+    return ret;\n+}\n+\n+jstring com_android_cts_verifier_os_FileUtils_getUserName(JNIEnv* env, jobject thiz,\n+        jint uid)\n+{\n+    struct passwd *pwd = getpwuid(uid);\n+    return env->NewStringUTF(pwd->pw_name);\n+}\n+\n+jstring com_android_cts_verifier_os_FileUtils_getGroupName(JNIEnv* env, jobject thiz,\n+        jint gid)\n+{\n+    struct group *grp = getgrgid(gid);\n+    return env->NewStringUTF(grp->gr_name);\n+}\n+\n+static JNINativeMethod gMethods[] = {\n+    {  \""getFileStatus\"", \""(Ljava/lang/String;Lcom/android/cts/verifier/os/FileUtils$FileStatus;Z)Z\"",\n+            (void *) com_android_cts_verifier_os_FileUtils_getFileStatus  },\n+    {  \""getUserName\"", \""(I)Ljava/lang/String;\"",\n+            (void *) com_android_cts_verifier_os_FileUtils_getUserName  },\n+    {  \""getGroupName\"", \""(I)Ljava/lang/String;\"",\n+            (void *) com_android_cts_verifier_os_FileUtils_getGroupName  },\n+};\n+\n+int register_com_android_cts_verifier_os_FileUtils(JNIEnv* env)\n+{\n+    jclass clazz = env->FindClass(\""com/android/cts/verifier/os/FileUtils\"");\n+\n+    gFileStatusClass = env->FindClass(\""com/android/cts/verifier/os/FileUtils$FileStatus\"");\n+    gFileStatusDevFieldID = env->GetFieldID(gFileStatusClass, \""dev\"", \""I\"");\n+    gFileStatusInoFieldID = env->GetFieldID(gFileStatusClass, \""ino\"", \""I\"");\n+    gFileStatusModeFieldID = env->GetFieldID(gFileStatusClass, \""mode\"", \""I\"");\n+    gFileStatusNlinkFieldID = env->GetFieldID(gFileStatusClass, \""nlink\"", \""I\"");\n+    gFileStatusUidFieldID = env->GetFieldID(gFileStatusClass, \""uid\"", \""I\"");\n+    gFileStatusGidFieldID = env->GetFieldID(gFileStatusClass, \""gid\"", \""I\"");\n+    gFileStatusSizeFieldID = env->GetFieldID(gFileStatusClass, \""size\"", \""J\"");\n+    gFileStatusBlksizeFieldID = env->GetFieldID(gFileStatusClass, \""blksize\"", \""I\"");\n+    gFileStatusBlocksFieldID = env->GetFieldID(gFileStatusClass, \""blocks\"", \""J\"");\n+    gFileStatusAtimeFieldID = env->GetFieldID(gFileStatusClass, \""atime\"", \""J\"");\n+    gFileStatusMtimeFieldID = env->GetFieldID(gFileStatusClass, \""mtime\"", \""J\"");\n+    gFileStatusCtimeFieldID = env->GetFieldID(gFileStatusClass, \""ctime\"", \""J\"");\n+\n+    return env->RegisterNatives(clazz, gMethods, \n+            sizeof(gMethods) / sizeof(JNINativeMethod)); \n+}\n"", ""strings.xml"": ""@@ -18,5 +18,11 @@\n     <string name=\""welcome_text\"">Welcome to the CTS Verifier!</string>\n     <string name=\""continue_button_text\"">Continue</string>\n     <string name=\""test_list_title\"">Manual Test List</string>\n-    <string name=\""suid_binaries\"">SUID Binaries</string>\n+\n+    <string name=\""suid_files\"">SUID Files</string>\n+    <string name=\""starting_scan\"">Starting scan...</string>\n+    <string name=\""file_status\"">User: %s\\nGroup: %s\\nPermissions: %s\\nPath: %s</string>\n+    <string name=\""no_file_status\"">Could not stat file...</string>\n+    <string name=\""congratulations\"">Congratulations!</string>\n+    <string name=\""no_suid_files\"">No unauthorized suid files detected!</string>\n </resources>\n"", ""FileUtils.java"": ""@@ -0,0 +1,147 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.android.cts.verifier.os;\n+\n+/** Bits and pieces copied from hidden API of android.os.FileUtils. */\n+public class FileUtils {\n+\n+    private static final int S_IFSOCK = 0140000;\n+    private static final int S_IFLNK = 0120000;\n+    private static final int S_IFREG = 0100000;\n+    private static final int S_IFBLK = 0060000;\n+    private static final int S_IFDIR = 0040000;\n+    private static final int S_IFCHR = 0020000;\n+    private static final int S_IFIFO = 0010000;\n+\n+    private static final int S_ISUID = 0004000;\n+    private static final int S_ISGID = 0002000;\n+    private static final int S_ISVTX = 0001000;\n+\n+    private static final int S_IRUSR = 00400;\n+    private static final int S_IWUSR = 00200;\n+    private static final int S_IXUSR = 00100;\n+\n+    private static final int S_IRGRP = 00040;\n+    private static final int S_IWGRP = 00020;\n+    private static final int S_IXGRP = 00010;\n+\n+    private static final int S_IROTH = 00004;\n+    private static final int S_IWOTH = 00002;\n+    private static final int S_IXOTH = 00001;\n+\n+    static {\n+        System.loadLibrary(\""ctsverifier_jni\"");\n+    }\n+\n+    public static class FileStatus {\n+\n+        private int dev;\n+        private int ino;\n+        private int mode;\n+        private int nlink;\n+        private int uid;\n+        private int gid;\n+        private int rdev;\n+        private long size;\n+        private int blksize;\n+        private long blocks;\n+        private long atime;\n+        private long mtime;\n+        private long ctime;\n+\n+        public int getUid() {\n+            return uid;\n+        }\n+\n+        public int getGid() {\n+            return gid;\n+        }\n+\n+        public int getMode() {\n+            return mode;\n+        }\n+\n+        public boolean isDirectory() {\n+            return hasModeFlag(mode, S_IFDIR);\n+        }\n+\n+        public boolean isSymbolicLink() {\n+            return hasModeFlag(mode, S_IFLNK);\n+        }\n+\n+        public boolean isSetUid() {\n+            return hasModeFlag(mode, S_ISUID);\n+        }\n+\n+        public boolean isSetGid() {\n+            return hasModeFlag(mode, S_ISGID);\n+        }\n+    }\n+\n+    /**\n+     * @param path of the file to stat\n+     * @param status object to set the fields on\n+     * @param statLinks or don't stat links (lstat vs stat)\n+     * @return whether or not we were able to stat the file\n+     */\n+    public native static boolean getFileStatus(String path, FileStatus status, boolean statLinks);\n+\n+    public native static String getUserName(int uid);\n+\n+    public native static String getGroupName(int gid);\n+\n+    /** Display the file's mode like \""ls -l\"" does. */\n+    public static String getFormattedPermissions(int mode) {\n+        StringBuilder permissions = new StringBuilder(\""-rwxrwxrwx\"");\n+\n+        int[] typeMasks = {S_IFSOCK, S_IFLNK, S_IFREG, S_IFBLK, S_IFDIR, S_IFCHR, S_IFIFO};\n+        char[] typeSymbols = {'s', 'l', '-', 'b', 'd', 'c', 'p'};\n+        for (int i = 0; i < typeMasks.length; i++) {\n+            if (hasModeFlag(mode, typeMasks[i])) {\n+                permissions.setCharAt(0, typeSymbols[i]);\n+                break;\n+            }\n+        }\n+\n+        int[] masks = {S_IRUSR, S_IWUSR, S_IXUSR, S_IRGRP, S_IWGRP, S_IXGRP,\n+                S_IROTH, S_IWOTH, S_IXOTH};\n+        for (int i = 0; i < masks.length; i++) {\n+            if (!hasModeFlag(mode, masks[i])) {\n+                permissions.setCharAt(1 + i, '-');\n+            }\n+        }\n+\n+\n+        if (hasModeFlag(mode, S_ISUID)) {\n+            permissions.setCharAt(3, hasModeFlag(mode, S_IXUSR) ? 's' : 'S');\n+        }\n+\n+        if (hasModeFlag(mode, S_ISGID)) {\n+            permissions.setCharAt(6, hasModeFlag(mode, S_IXGRP) ? 's' : 'S');\n+        }\n+\n+        if (hasModeFlag(mode, S_ISVTX)) {\n+            permissions.setCharAt(9, hasModeFlag(mode, S_IXOTH) ? 't' : 'T');\n+        }\n+\n+        return permissions.toString();\n+    }\n+\n+    private static boolean hasModeFlag(int mode, int flag) {\n+        return (mode & flag) == flag;\n+    }\n+}\n"", ""SuidFilesActivity.java"": ""@@ -0,0 +1,242 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.android.cts.verifier.suid;\n+\n+import com.android.cts.verifier.R;\n+import com.android.cts.verifier.os.FileUtils;\n+import com.android.cts.verifier.os.FileUtils.FileStatus;\n+\n+import android.app.Activity;\n+import android.app.AlertDialog;\n+import android.app.ListActivity;\n+import android.app.ProgressDialog;\n+import android.content.DialogInterface;\n+import android.content.DialogInterface.OnCancelListener;\n+import android.os.AsyncTask;\n+import android.os.Bundle;\n+import android.util.Log;\n+import android.view.View;\n+import android.view.ViewGroup;\n+import android.widget.ArrayAdapter;\n+import android.widget.ListView;\n+import android.widget.TextView;\n+\n+import java.io.File;\n+import java.io.FileFilter;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/** {@link Activity} that tries to find suid files. */\n+public class SuidFilesActivity extends ListActivity {\n+\n+    private static final String TAG = SuidFilesActivity.class.getSimpleName();\n+\n+    /** These programs are expected suid binaries. */\n+    private static final Set<String> WHITELIST = new HashSet<String>(Arrays.asList(\n+            \""run-as\""\n+    ));\n+\n+    private ProgressDialog mProgressDialog;\n+\n+    private SuidFilesAdapter mAdapter;\n+\n+    private SuidFilesTask mFindSuidFilesTask;\n+\n+    @Override\n+    protected void onCreate(Bundle savedInstanceState) {\n+        super.onCreate(savedInstanceState);\n+\n+        mAdapter = new SuidFilesAdapter();\n+        setListAdapter(mAdapter);\n+\n+        mProgressDialog = new ProgressDialog(this);\n+        mProgressDialog.setMessage(getString(R.string.starting_scan));\n+        mProgressDialog.setOnCancelListener(new OnCancelListener() {\n+            public void onCancel(DialogInterface dialog) {\n+                // If the scanning dialog is cancelled, then stop the task and finish the activity\n+                // to prevet the user from just seeing a blank listview.\n+                if (mFindSuidFilesTask != null) {\n+                    mFindSuidFilesTask.cancel(true);\n+                }\n+                finish();\n+            }\n+        });\n+\n+        // Start searching for suid files using a background thread.\n+        mFindSuidFilesTask = new SuidFilesTask();\n+        mFindSuidFilesTask.execute(new File(\""/\""));\n+    }\n+\n+    @Override\n+    protected void onListItemClick(ListView listView, View view, int position, long id) {\n+        super.onListItemClick(listView, view, position, id);\n+        File file = mAdapter.getItem(position);\n+        String message = getMessage(file);\n+        new AlertDialog.Builder(this)\n+                .setTitle(file.getName())\n+                .setMessage(message)\n+                .show();\n+    }\n+\n+    private String getMessage(File file) {\n+        FileStatus status = new FileStatus();\n+        if (FileUtils.getFileStatus(file.getAbsolutePath(), status, true)) {\n+            return getString(R.string.file_status,\n+                    FileUtils.getUserName(status.getUid()),\n+                    FileUtils.getGroupName(status.getGid()),\n+                    FileUtils.getFormattedPermissions(status.getMode()),\n+                    file.getAbsolutePath());\n+        } else {\n+            return getString(R.string.no_file_status);\n+        }\n+    }\n+\n+    @Override\n+    protected void onDestroy() {\n+        super.onDestroy();\n+        if (mFindSuidFilesTask != null) {\n+            mFindSuidFilesTask.cancel(true);\n+        }\n+    }\n+\n+    /** {@link ListView} items display the basenames of the suid files. */\n+    class SuidFilesAdapter extends ArrayAdapter<File> {\n+\n+        SuidFilesAdapter() {\n+            super(SuidFilesActivity.this, android.R.layout.simple_list_item_1);\n+        }\n+\n+        @Override\n+        public View getView(int position, View convertView, ViewGroup parent) {\n+            TextView view = (TextView) super.getView(position, convertView, parent);\n+            File file = getItem(position);\n+            view.setText(file.getName());\n+            return view;\n+        }\n+    }\n+\n+    /** {@link AsyncTask} that searches the file system for suid files. */\n+    class SuidFilesTask extends AsyncTask<File, File, Set<File>> {\n+\n+        @Override\n+        protected void onPreExecute() {\n+            super.onPreExecute();\n+            mProgressDialog.show();\n+        }\n+\n+        @Override\n+        protected Set<File> doInBackground(File... paths) {\n+            Set<File> suidFiles = new HashSet<File>();\n+            DirectoryFileFilter dirFilter = new DirectoryFileFilter();\n+            SuidFileFilter suidFilter = new SuidFileFilter();\n+            for (File path : paths) {\n+                findSuidFiles(path, suidFiles, dirFilter, suidFilter);\n+            }\n+            return suidFiles;\n+        }\n+\n+        private void findSuidFiles(File dir, Set<File> foundSuidFiles,\n+                DirectoryFileFilter dirFilter, SuidFileFilter suidFilter) {\n+\n+            // Recursively traverse sub directories...\n+            File[] subDirs = dir.listFiles(dirFilter);\n+            if (subDirs != null && subDirs.length > 0) {\n+                for (File subDir : subDirs) {\n+                    findSuidFiles(subDir, foundSuidFiles, dirFilter, suidFilter);\n+                }\n+            }\n+\n+            // / ...then inspect files in directory to find offending binaries.\n+            publishProgress(dir);\n+            File[] suidFiles = dir.listFiles(suidFilter);\n+            if (suidFiles != null && suidFiles.length > 0) {\n+                Collections.addAll(foundSuidFiles, suidFiles);\n+            }\n+        }\n+\n+        /** {@link FileFilter} that returns only directories that are not symbolic links. */\n+        private class DirectoryFileFilter implements FileFilter {\n+\n+            private final FileStatus status = new FileStatus();\n+\n+            public boolean accept(File pathname) {\n+                // Don't follow symlinks to avoid infinite looping.\n+                if (FileUtils.getFileStatus(pathname.getPath(), status, true)) {\n+                    return status.isDirectory() && !status.isSymbolicLink();\n+                } else {\n+                    Log.w(TAG, \""Could not stat \"" + pathname);\n+                    return false;\n+                }\n+            }\n+        }\n+\n+        /** {@link FileFilter} that returns files that have setuid root or setgid root. */\n+        private class SuidFileFilter implements FileFilter {\n+\n+            private final FileStatus status = new FileStatus();\n+\n+            public boolean accept(File pathname) {\n+                if (!WHITELIST.contains(pathname.getName())\n+                        && FileUtils.getFileStatus(pathname.getPath(), status, true)) {\n+                    return !status.isDirectory()\n+                            && !status.isSymbolicLink()\n+                            && (status.isSetUid() && status.getUid() == 0);\n+                } else {\n+                    Log.w(TAG, \""Could not stat \"" + pathname);\n+                    return false;\n+                }\n+            }\n+        }\n+\n+        @Override\n+        protected void onPostExecute(Set<File> results) {\n+            super.onPostExecute(results);\n+            mProgressDialog.hide();\n+\n+            // Task could be cancled and results could be null but don't bother doing anything.\n+            if (results != null) {\n+                for (File result : results) {\n+                    mAdapter.add(result);\n+                }\n+\n+                // Alert the user that nothing was found rather than showing an empty list view.\n+                if (results.isEmpty()) {\n+                    new AlertDialog.Builder(SuidFilesActivity.this)\n+                            .setTitle(R.string.congratulations)\n+                            .setMessage(R.string.no_suid_files)\n+                            .setOnCancelListener(new OnCancelListener() {\n+                                public void onCancel(DialogInterface dialog) {\n+                                    // No reason to hang around if there were no offending files.\n+                                    finish();\n+                                }\n+                            })\n+                            .show();\n+                }\n+            }\n+        }\n+\n+        @Override\n+        protected void onProgressUpdate(File... values) {\n+            super.onProgressUpdate(values);\n+\n+            // Show the current directory being scanned...\n+            mProgressDialog.setMessage(values[0].getAbsolutePath());\n+        }\n+    }\n+}\n""}","feature, test 
"
11062,Jack Veenstra,GRO: Disable GRO on legacy netif_rx path,['net/core/dev.c'],"GRO: Disable GRO on legacy netif_rx path

When I fixed the GRO crash in the legacy receive path I used
napi_complete to replace __napi_complete.  Unfortunately they're
not the same when NETPOLL is enabled, which may result in us
not calling __napi_complete at all.

What's more, we really do need to keep the __napi_complete call
within the IRQ-off section since in theory an IRQ can occur in
between and fill up the backlog to the maximum, causing us to
lock up.

Since we can't seem to find a fix that works properly right now,
this patch reverts all the GRO support from the netif_rx path.

Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Jack Veenstra <veenstra@android.com>
",https://android-review.googlesource.com/c/11062,"bug 
",bug,Bug;Deprecat;,"{""dev.c"": ""@@ -2588,18 +2588,15 @@ static int process_backlog(struct napi_struct *napi, int quota)\n \t\tlocal_irq_disable();\n \t\tskb = __skb_dequeue(&queue->input_pkt_queue);\n \t\tif (!skb) {\n+\t\t\t__napi_complete(napi);\n \t\t\tlocal_irq_enable();\n-\t\t\tnapi_complete(napi);\n-\t\t\tgoto out;\n+\t\t\tbreak;\n \t\t}\n \t\tlocal_irq_enable();\n \n-\t\tnapi_gro_receive(napi, skb);\n+\t\tnetif_receive_skb(skb);\n \t} while (++work < quota && jiffies == start_time);\n \n-\tnapi_gro_flush(napi);\n-\n-out:\n \treturn work;\n }\n \n""}","bug, deprecate 
"
23086,Xavier Ducrohet,Merge d4166974 from master. do not merge. Fix issue with resource repository when using libraries,['ide_common/src/com/android/ide/common/resources/ResourceRepository.java'],"Merge d4166974 from master. do not merge.
Fix issue with resource repository when using libraries

Change-Id: I45c8af34020f047f08a53ddd6ada3a8be4061a52",https://android-review.googlesource.com/c/23086,"bug, merge 
","bug,merge",Bug;,"{""ResourceRepository.java"": ""@@ -482,10 +482,11 @@ public abstract class ResourceRepository {\n      */\n     private Map<String, ResourceValue> getConfiguredResource(ResourceType type,\n             FolderConfiguration referenceConfig) {\n+\n         // get the resource item for the given type\n         List<ResourceItem> items = mResourceMap.get(type);\n         if (items == null) {\n-            return Collections.emptyMap();\n+            return new HashMap<String, ResourceValue>();\n         }\n \n         // create the map\n""}","merge, resource 
"
14538,Mike Chan,[ARM] omap: pm34xx: Change prcm irq warn to printk_once,['arch/arm/mach-omap2/pm34xx.c'],"[ARM] omap: pm34xx: Change prcm irq warn to printk_once

Avoid log spam, switch to printk_once.

Change-Id: I7b4b0fd80140a59270be91c3c2379752e7278e52
Signed-off-by: Mike Chan <mike@android.com>",https://android-review.googlesource.com/c/14538,"bug, refactor 
",bug,Others;,"{""pm34xx.c"": ""@@ -317,8 +317,11 @@ static irqreturn_t prcm_interrupt_handler (int irq, void *dev_id)\n \t\t\t * Is the MPU PRCM interrupt handler racing with the\n \t\t\t * IVA2 PRCM interrupt handler ?\n \t\t\t */\n-\t\t\tWARN(c == 0, \""prcm: WARNING: PRCM indicated MPU wakeup \""\n-\t\t\t     \""but no wakeup sources are marked\\n\"");\n+\t\t\tif (unlikely(c == 0))\n+\t\t\t\tprintk_once(KERN_WARNING \""prcm: WARNING: \""\n+\t\t\t\t\t\t\""PRCM indicated MPU wakeup \""\n+\t\t\t\t\t\t\""but no wakeup sources are \""\n+\t\t\t\t\t\t\""marked\\n\"");\n \t\t} else {\n \t\t\t/* XXX we need to expand our PRCM interrupt handler */\n \t\t\tWARN(1, \""prcm: WARNING: PRCM interrupt received, but \""\n""}","bug, refactor 
"
17480,Dima Zavin,ARM: tegra: enable clk reset for non-peripheral clocks,"['arch/arm/mach-tegra/clock.h', 'arch/arm/mach-tegra/tegra2_clocks.c']","ARM: tegra: enable clk reset for non-peripheral clocks

Add a new 'reset' clk op. This can be provided for any clock,
not just peripherals.

Change-Id: I0742cfad1587ddc006066c7fa9bc22f180c04e6f
Signed-off-by: Dima Zavin <dima@android.com>",https://android-review.googlesource.com/c/17480,"feature 
",feature,Feature;,"{""clock.h"": ""@@ -86,6 +86,7 @@ struct clk_ops {\n \tint\t\t(*set_parent)(struct clk *, struct clk *);\n \tint\t\t(*set_rate)(struct clk *, unsigned long);\n \tlong\t\t(*round_rate)(struct clk *, unsigned long);\n+\tvoid\t\t(*reset)(struct clk *, bool);\n };\n \n enum clk_state {\n"", ""tegra2_clocks.c"": ""@@ -262,6 +262,18 @@ static struct clk_ops tegra_clk_m_ops = {\n \t.disable\t= tegra2_clk_m_disable,\n };\n \n+void tegra2_periph_reset_assert(struct clk *c)\n+{\n+\tBUG_ON(!c->ops->reset);\n+\tc->ops->reset(c, true);\n+}\n+\n+void tegra2_periph_reset_deassert(struct clk *c)\n+{\n+\tBUG_ON(!c->ops->reset);\n+\tc->ops->reset(c, false);\n+}\n+\n /* super clock functions */\n /* \""super clocks\"" on tegra have two-stage muxes and a clock skipping\n  * super divider.  We will ignore the clock skipping divider, since we\n@@ -869,23 +881,17 @@ static void tegra2_periph_clk_disable(struct clk *c)\n \t\tCLK_OUT_ENB_CLR + PERIPH_CLK_TO_ENB_SET_REG(c));\n }\n \n-void tegra2_periph_reset_deassert(struct clk *c)\n+static void tegra2_periph_clk_reset(struct clk *c, bool assert)\n {\n-\tpr_debug(\""%s on clock %s\\n\"", __func__, c->name);\n-\tif (!(c->flags & PERIPH_NO_RESET))\n-\t\tclk_writel(PERIPH_CLK_TO_ENB_BIT(c),\n-\t\t\tRST_DEVICES_CLR + PERIPH_CLK_TO_ENB_SET_REG(c));\n-}\n+\tunsigned long base = assert ? RST_DEVICES_SET : RST_DEVICES_CLR;\n \n-void tegra2_periph_reset_assert(struct clk *c)\n-{\n-\tpr_debug(\""%s on clock %s\\n\"", __func__, c->name);\n+\tpr_debug(\""%s %s on clock %s\\n\"", __func__,\n+\t\t assert ? \""assert\"" : \""deassert\"", c->name);\n \tif (!(c->flags & PERIPH_NO_RESET))\n \t\tclk_writel(PERIPH_CLK_TO_ENB_BIT(c),\n-\t\t\tRST_DEVICES_SET + PERIPH_CLK_TO_ENB_SET_REG(c));\n+\t\t\t   base + PERIPH_CLK_TO_ENB_SET_REG(c));\n }\n \n-\n static int tegra2_periph_clk_set_parent(struct clk *c, struct clk *p)\n {\n \tu32 val;\n@@ -976,6 +982,7 @@ static struct clk_ops tegra_periph_clk_ops = {\n \t.set_parent\t\t= &tegra2_periph_clk_set_parent,\n \t.set_rate\t\t= &tegra2_periph_clk_set_rate,\n \t.round_rate\t\t= &tegra2_periph_clk_round_rate,\n+\t.reset\t\t\t= &tegra2_periph_clk_reset,\n };\n \n /* Clock doubler ops */\n""}","feature 
"
22743,RaphaÃ«l Moll,Fix launchers for SDK tools using swtmenubar.,"['hierarchyviewer2/app/etc/hierarchyviewer.bat', 'ddms/app/etc/ddms', 'sdkmanager/app/etc/android.bat', 'ddms/app/etc/ddms.bat', 'hierarchyviewer2/app/etc/hierarchyviewer', 'sdkmanager/app/etc/android']","Fix launchers for SDK tools using swtmenubar.

Change-Id: Iba5860db0a56ab508d1ce155d0e079ab37eb2bc9",https://android-review.googlesource.com/c/22743,"bug
",Bug;Resource;,Bug;Resource;,"{""ddms"": ""@@ -75,7 +75,7 @@ if [ `uname` = \""Linux\"" ]; then\n     export GDK_NATIVE_WINDOWS=true\n fi\n \n-jarpath=\""$frameworkdir/$jarfile\""\n+jarpath=\""$frameworkdir/$jarfile:$frameworkdir/swtmenubar.jar\""\n \n # Figure out the path to the swt.jar for the current architecture.\n # if ANDROID_SWT is defined, then just use this.\n@@ -100,6 +100,8 @@ if [ ! -d \""$swtpath\"" ]; then\n     exit 1\n fi\n \n-# need to use \""java.ext.dirs\"" because \""-jar\"" causes classpath to be ignored\n-# might need more memory, e.g. -Xmx128M\n-exec \""$javaCmd\"" -Xmx256M $os_opts $java_debug -Dcom.android.ddms.bindir=\""$progdir\"" -classpath \""$jarpath:$swtpath/swt.jar\"" com.android.ddms.Main \""$@\""\n+exec \""$javaCmd\"" \\\n+    -Xmx256M $os_opts $java_debug \\\n+    -Dcom.android.ddms.bindir=\""$progdir\"" \\\n+    -classpath \""$jarpath:$swtpath/swt.jar\"" \\\n+    com.android.ddms.Main \""$@\""\n"", ""ddms.bat"": ""@@ -48,7 +48,7 @@ if debug NEQ \""%1\"" goto NoDebug\n     shift 1\r\n :NoDebug\r\n \r\n-set jarpath=%frameworkdir%%jarfile%\r\n+set jarpath=%frameworkdir%%jarfile%;%frameworkdir%swtmenubar.jar\r\n \r\n if not defined ANDROID_SWT goto QueryArch\r\n     set swt_path=%ANDROID_SWT%\r\n"", ""hierarchyviewer"": ""@@ -76,7 +76,7 @@ if [ `uname` = \""Linux\"" ]; then\n     export GDK_NATIVE_WINDOWS=true\n fi\n \n-jarpath=\""$frameworkdir/$jarfile\""\n+jarpath=\""$frameworkdir/$jarfile:$frameworkdir/swtmenubar.jar\""\n \n # Figure out the path to the swt.jar for the current architecture.\n # if ANDROID_SWT is defined, then just use this.\n@@ -103,4 +103,8 @@ fi\n \n # need to use \""java.ext.dirs\"" because \""-jar\"" causes classpath to be ignored\n # might need more memory, e.g. -Xmx128M\n-exec \""$javaCmd\"" -Xmx512M $os_opts $java_debug -Dcom.android.hierarchyviewer.bindir=\""$progdir\"" -classpath \""$jarpath:$swtpath/swt.jar\"" com.android.hierarchyviewer.HierarchyViewerApplication \""$@\""\n+exec \""$javaCmd\"" \\\n+    -Xmx512M $os_opts $java_debug \\\n+    -Dcom.android.hierarchyviewer.bindir=\""$progdir\"" \\\n+    -classpath \""$jarpath:$swtpath/swt.jar\"" \\\n+    com.android.hierarchyviewer.HierarchyViewerApplication \""$@\""\n"", ""hierarchyviewer.bat"": ""@@ -49,7 +49,7 @@ if debug NEQ \""%1\"" goto NoDebug\n     shift 1\r\n :NoDebug\r\n \r\n-set jarpath=%frameworkdir%%jarfile%;%frameworkdir%hierarchyviewerlib.jar\r\n+set jarpath=%frameworkdir%%jarfile%;%frameworkdir%hierarchyviewerlib.jar;%frameworkdir%swtmenubar.jar\r\n \r\n if not defined ANDROID_SWT goto QueryArch\r\n     set swt_path=%ANDROID_SWT%\r\n"", ""android"": ""@@ -74,9 +74,10 @@ fi\n \n if [ \""$OSTYPE\"" = \""cygwin\"" ] ; then\n     jarpath=`cygpath -w  \""$frameworkdir/$jarfile\""`\n+    jarpath=\""$jarpath;\""`cygpath -w  \""$frameworkdir/swtmenubar.jar\""`\n     progdir=`cygpath -w  \""$progdir\""`\n else\n-    jarpath=\""$frameworkdir/$jarfile\""\n+    jarpath=\""$frameworkdir/$jarfile:$frameworkdir/swtmenubar.jar\""\n fi\n \n # Get the current content of java.ext.dirs so that we can add to it instead of replacing\n@@ -106,4 +107,8 @@ if [ ! -d \""$swtpath\"" ]; then\n fi\n \n # need to use \""java.ext.dirs\"" because \""-jar\"" causes classpath to be ignored\n-exec \""$java_cmd\"" -Xmx256M $os_opts $java_debug -Dcom.android.sdkmanager.toolsdir=\""$progdir\"" -classpath \""$jarpath:$swtpath/swt.jar\"" com.android.sdkmanager.Main \""$@\""\n+exec \""$java_cmd\"" \\\n+    -Xmx256M $os_opts $java_debug \\\n+    -Dcom.android.sdkmanager.toolsdir=\""$progdir\"" \\\n+    -classpath \""$jarpath:$swtpath/swt.jar\"" \\\n+    com.android.sdkmanager.Main \""$@\""\n"", ""android.bat"": ""@@ -37,7 +37,7 @@ set java_exe=\n call lib\\find_java.bat\r\n if not defined java_exe goto :EOF\r\n \r\n-set jar_path=lib\\sdkmanager.jar\r\n+set jar_path=lib\\sdkmanager.jar;lib\\swtmenubar.jar\r\n \r\n rem Set SWT.Jar path based on current architecture (x86 or x86_64)\r\n for /f %%a in ('%java_exe% -jar lib\\archquery.jar') do set swt_path=lib\\%%a\r\n""}","feature 
"
23845,Dmitry Shmidt,net: wireless: bcmdhd: Add sdlock to firmware loading,['drivers/net/wireless/bcmdhd/dhd_linux.c'],"net: wireless: bcmdhd: Add sdlock to firmware loading

Signed-off-by: Dmitry Shmidt <dimitrysh@google.com>
",https://android-review.googlesource.com/c/23845,"bug
",bug,Feature;,"{""dhd_linux.c"": ""@@ -2702,6 +2702,8 @@ dhd_bus_start(dhd_pub_t *dhdp)\n \n \tDHD_TRACE((\""%s: \\n\"", __FUNCTION__));\n \n+\tdhd_os_sdlock(dhdp);\n+\n \t/* try to download image and nvram to the dongle */\n \tif  ((dhd->pub.busstate == DHD_BUS_DOWN) &&\n \t\t(fw_path != NULL) && (fw_path[0] != '\\0') &&\n@@ -2711,24 +2713,23 @@ dhd_bus_start(dhd_pub_t *dhdp)\n \t\t                                fw_path, nv_path))) {\n \t\t\tDHD_ERROR((\""%s: dhdsdio_probe_download failed. firmware = %s nvram = %s\\n\"",\n \t\t\t           __FUNCTION__, fw_path, nv_path));\n+\t\t\tdhd_os_sdunlock(dhdp);\n \t\t\treturn -1;\n \t\t}\n \t}\n-\tif (dhd->pub.busstate != DHD_BUS_LOAD)\n+\tif (dhd->pub.busstate != DHD_BUS_LOAD) {\n+\t\tdhd_os_sdunlock(dhdp);\n \t\treturn -ENETDOWN;\n+\t}\n \n \t/* Start the watchdog timer */\n \tdhd->pub.tickcnt = 0;\n \tdhd_os_wd_timer(&dhd->pub, dhd_watchdog_ms);\n \n \t/* Bring up the bus */\n-#ifdef DHDTHREAD\n-\tif ((ret = dhd_bus_init(&dhd->pub, TRUE)) != 0) {\n-#else\n \tif ((ret = dhd_bus_init(&dhd->pub, FALSE)) != 0) {\n-#endif\n-\n \t\tDHD_ERROR((\""%s, dhd_bus_init failed %d\\n\"", __FUNCTION__, ret));\n+\t\tdhd_os_sdunlock(dhdp);\n \t\treturn ret;\n \t}\n #if defined(OOB_INTR_ONLY)\n@@ -2739,6 +2740,7 @@ dhd_bus_start(dhd_pub_t *dhdp)\n \t\tdel_timer_sync(&dhd->timer);\n \n \t\tDHD_ERROR((\""%s Host failed to register for OOB\\n\"", __FUNCTION__));\n+\t\tdhd_os_sdunlock(dhdp);\n \t\treturn -ENODEV;\n \t}\n \n@@ -2751,9 +2753,12 @@ dhd_bus_start(dhd_pub_t *dhdp)\n \t\tdel_timer_sync(&dhd->timer);\n \t\tdhd->wd_timer_valid = FALSE;\n \t\tDHD_ERROR((\""%s failed bus is not ready\\n\"", __FUNCTION__));\n+\t\tdhd_os_sdunlock(dhdp);\n \t\treturn -ENODEV;\n \t}\n \n+\tdhd_os_sdunlock(dhdp);\n+\n #ifdef EMBEDDED_PLATFORM\n \tbcm_mkiovar(\""event_msgs\"", dhdp->eventmask, WL_EVENTING_MASK_LEN, iovbuf, sizeof(iovbuf));\n \tdhd_wl_ioctl_cmd(dhdp, WLC_GET_VAR, iovbuf, sizeof(iovbuf), FALSE, 0);\n""}","feature 
"
15509,Mike Lockwood,USB: composite: Add usb_composite_force_reset utility to force enumeration,"['drivers/usb/gadget/android.c', 'drivers/usb/gadget/composite.c', 'include/linux/usb/composite.h']","USB: composite: Add usb_composite_force_reset utility to force enumeration

Use this rather than calling usb_gadget_disconnect and usb_gadget_connect
directly to avoid sending USB disconnect events to userspace when resetting
the bus.

Signed-off-by: Mike Lockwood <lockwood@android.com>
",https://android-review.googlesource.com/c/15509,"feature,bug 
",feature,Feature;,"{""android.c"": ""@@ -337,7 +337,7 @@ void android_enable_function(struct usb_function *f, int enable)\n \t\t\t */\n \t\t\tlist_for_each_entry(func, &android_config_driver.functions, list) {\n \t\t\t\tif (!strcmp(func->name, \""usb_mass_storage\"")) {\n-\t\t\t\t\tusb_function_set_enabled(f, !enable);\n+\t\t\t\t\tusb_function_set_enabled(func, !enable);\n \t\t\t\t\tbreak;\n \t\t\t\t}\n \t\t\t}\n@@ -348,14 +348,7 @@ void android_enable_function(struct usb_function *f, int enable)\n \t\tdevice_desc.idProduct = __constant_cpu_to_le16(product_id);\n \t\tif (dev->cdev)\n \t\t\tdev->cdev->desc.idProduct = device_desc.idProduct;\n-\n-\t\t/* force reenumeration */\n-\t\tif (dev->cdev && dev->cdev->gadget &&\n-\t\t\t\tdev->cdev->gadget->speed != USB_SPEED_UNKNOWN) {\n-\t\t\tusb_gadget_disconnect(dev->cdev->gadget);\n-\t\t\tmsleep(10);\n-\t\t\tusb_gadget_connect(dev->cdev->gadget);\n-\t\t}\n+\t\tusb_composite_force_reset(dev->cdev);\n \t}\n }\n \n"", ""composite.c"": ""@@ -103,6 +103,20 @@ void usb_function_set_enabled(struct usb_function *f, int enabled)\n \tkobject_uevent(&f->dev->kobj, KOBJ_CHANGE);\n }\n \n+\n+void usb_composite_force_reset(struct usb_composite_dev *cdev)\n+{\n+\t/* force reenumeration */\n+\tif (cdev && cdev->gadget &&\n+\t\t\tcdev->gadget->speed != USB_SPEED_UNKNOWN) {\n+\t\t/* avoid sending a disconnect switch event until after we disconnect */\n+\t\tcdev->mute_switch = 1;\n+\t\tusb_gadget_disconnect(cdev->gadget);\n+\t\tmsleep(10);\n+\t\tusb_gadget_connect(cdev->gadget);\n+\t}\n+}\n+\n /**\n  * usb_add_function() - add a function to a configuration\n  * @config: the configuration\n@@ -1002,7 +1016,10 @@ static void composite_disconnect(struct usb_gadget *gadget)\n \t\treset_config(cdev);\n \tspin_unlock_irqrestore(&cdev->lock, flags);\n \n-\tschedule_work(&cdev->switch_work);\n+\tif (cdev->mute_switch)\n+\t\tcdev->mute_switch = 0;\n+\telse\n+\t\tschedule_work(&cdev->switch_work);\n }\n \n /*-------------------------------------------------------------------------*/\n"", ""composite.h"": ""@@ -39,6 +39,7 @@\n #include <linux/switch.h>\n \n \n+struct usb_composite_dev;\n struct usb_configuration;\n \n /**\n@@ -143,6 +144,7 @@ int usb_function_activate(struct usb_function *);\n int usb_interface_id(struct usb_configuration *, struct usb_function *);\n \n void usb_function_set_enabled(struct usb_function *, int);\n+void usb_composite_force_reset(struct usb_composite_dev *);\n \n /**\n  * ep_choose - select descriptor endpoint at current device speed\n@@ -353,6 +355,8 @@ struct usb_composite_dev {\n \tspinlock_t\t\t\tlock;\n \n \tstruct switch_dev sdev;\n+\t/* used by usb_composite_force_reset to avoid signalling switch changes */\n+\tu8\t\t\t\tmute_switch;\n \tstruct work_struct switch_work;\n };\n \n""}","bug, refactor 
"
16193,Colin Cross,"i2c: i2c-tegra: Fix checkpatch issues, remove debugging",['drivers/i2c/busses/i2c-tegra.c'],"i2c: i2c-tegra: Fix checkpatch issues, remove debugging

Change-Id: Icba24ebb1753619fcb039cbcf98487627f274744
Signed-off-by: Colin Cross <ccross@android.com>",https://android-review.googlesource.com/c/16193,"bug, refactor
",bug,Bug;Deprecat;,"{""i2c-tegra.c"": ""@@ -74,7 +74,7 @@\n #define DVC_STATUS\t\t\t\t0x00c\n #define DVC_STATUS_I2C_DONE_INTR\t\t(1<<30)\n \n-#define I2C_ERR_NONE \t\t\t\t0x00\n+#define I2C_ERR_NONE\t\t\t\t0x00\n #define I2C_ERR_NO_ACK\t\t\t\t0x01\n #define I2C_ERR_ARBITRATION_LOST\t\t0x02\n \n@@ -171,8 +171,6 @@ static void tegra_i2c_unmask_irq(struct tegra_i2c_dev *i2c_dev, u32 mask)\n static void tegra_i2c_set_clk(struct tegra_i2c_dev *i2c_dev, unsigned int freq)\n {\n \tclk_set_rate(i2c_dev->clk, freq * 8);\n-\tdev_dbg(i2c_dev->dev, \""%s: requested %u got %lu\\n\"", __func__,\n-\t\tfreq, clk_get_rate(i2c_dev->clk)/8);\n }\n \n static int tegra_i2c_flush_fifos(struct tegra_i2c_dev *i2c_dev)\n@@ -210,7 +208,7 @@ static int tegra_i2c_empty_rx_fifo(struct tegra_i2c_dev *i2c_dev)\n \tif (words_to_transfer > rx_fifo_avail)\n \t\twords_to_transfer = rx_fifo_avail;\n \n-\tfor (word=0; word < words_to_transfer; word++) {\n+\tfor (word = 0; word < words_to_transfer; word++) {\n \t\tval = i2c_readl(i2c_dev, I2C_RX_FIFO);\n \t\tput_unaligned_le32(val, buf);\n \t\tbuf += BYTES_PER_FIFO_WORD;\n@@ -252,9 +250,8 @@ static int tegra_i2c_fill_tx_fifo(struct tegra_i2c_dev *i2c_dev)\n \twords_to_transfer = buf_remaining / BYTES_PER_FIFO_WORD;\n \tif (words_to_transfer > tx_fifo_avail)\n \t\twords_to_transfer = tx_fifo_avail;\n-\tdev_dbg(i2c_dev->dev, \""fill_tx_fifo: tx_fifo_avail %d\\n\"", tx_fifo_avail);\n-\tdev_dbg(i2c_dev->dev, \""fill_tx_fifo: words_to_transfer %d\\n\"", words_to_transfer);\n-\tfor (word=0; word < words_to_transfer; word++) {\n+\n+\tfor (word = 0; word < words_to_transfer; word++) {\n \t\tval = get_unaligned_le32(buf);\n \t\ti2c_writel(i2c_dev, val, I2C_TX_FIFO);\n \t\tbuf += BYTES_PER_FIFO_WORD;\n@@ -265,12 +262,10 @@ static int tegra_i2c_fill_tx_fifo(struct tegra_i2c_dev *i2c_dev)\n \tif (tx_fifo_avail > 0 && buf_remaining > 0) {\n \t\tint bytes_to_transfer = buf_remaining;\n \t\tint byte;\n-\t\tdev_dbg(i2c_dev->dev, \""fill_tx_fifo: bytes_to_transfer %d\\n\"", bytes_to_transfer);\n \t\tBUG_ON(bytes_to_transfer > 3);\n \t\tval = 0;\n-\t\tfor (byte = 0; byte < bytes_to_transfer; byte++) {\n+\t\tfor (byte = 0; byte < bytes_to_transfer; byte++)\n \t\t\tval |= (*buf++) << (byte * 8);\n-\t\t}\n \t\ti2c_writel(i2c_dev, val, I2C_TX_FIFO);\n \t\tbuf_remaining -= bytes_to_transfer;\n \t\ttx_fifo_avail--;\n@@ -290,7 +285,6 @@ static int tegra_i2c_fill_tx_fifo(struct tegra_i2c_dev *i2c_dev)\n static void tegra_dvc_init(struct tegra_i2c_dev *i2c_dev)\n {\n \tu32 val = 0;\n-\tdev_dbg(i2c_dev->dev, \""dvc init\\n\"");\n \tval = dvc_readl(i2c_dev, DVC_CTRL_REG3);\n \tval |= DVC_CTRL_REG3_SW_PROG;\n \tval |= DVC_CTRL_REG3_I2C_DONE_INTR_EN;\n@@ -313,7 +307,6 @@ static int tegra_i2c_init(struct tegra_i2c_dev *i2c_dev)\n \n \tclk_enable(i2c_dev->clk);\n \n-\tdev_dbg(i2c_dev->dev, \""init\\n\"");\n \tif (i2c_dev->is_dvc)\n \t\ttegra_dvc_init(i2c_dev);\n \n@@ -342,18 +335,11 @@ static irqreturn_t tegra_i2c_isr(int irq, void *dev_id)\n \tstatus = i2c_readl(i2c_dev, I2C_INT_STATUS);\n \n \tif (status == 0) {\n-\t\tprintk(\""irq status 0 %08x\\n\"", i2c_readl(i2c_dev, I2C_PACKET_TRANSFER_STATUS));\n-\t\t//BUG();\n+\t\tdev_warn(&i2c_dev->dev, \""irq status 0 %08x\\n\"",\n+\t\t\ti2c_readl(i2c_dev, I2C_PACKET_TRANSFER_STATUS));\n \t\treturn IRQ_HANDLED;\n \t}\n \n-\tdev_dbg(i2c_dev->dev, \""irq status %02x\\n\"", status);\n-\tdev_dbg(i2c_dev->dev, \""irq mask %02x\\n\"", i2c_readl(i2c_dev, I2C_INT_MASK));\n-\tdev_dbg(i2c_dev->dev, \""transfer: %08x fifo %02x\\n\"", i2c_readl(i2c_dev, I2C_PACKET_TRANSFER_STATUS), i2c_readl(i2c_dev, I2C_FIFO_STATUS));\n-\tdev_dbg(i2c_dev->dev, \""remaining: %d\\n\"", i2c_dev->msg_buf_remaining);\n-\tdev_dbg(i2c_dev->dev, \""xfer complete: %d \\n\"", i2c_dev->msg_transfer_complete);\n-\tif (i2c_dev->is_dvc)\n-\t\tdev_dbg(i2c_dev->dev, \""dvc status: %08x\\n\"", dvc_readl(i2c_dev, DVC_STATUS));\n \tif (unlikely(status & status_err)) {\n \t\tif (status & I2C_INT_NO_ACK)\n \t\t\ti2c_dev->msg_err |= I2C_ERR_NO_ACK;\n@@ -406,8 +392,6 @@ static int tegra_i2c_xfer_msg(struct tegra_i2c_bus *i2c_bus,\n \ttegra_i2c_flush_fifos(i2c_dev);\n \ti2c_writel(i2c_dev, 0xFF, I2C_INT_STATUS);\n \n-\tdev_dbg(i2c_dev->dev, \""%s: addr 0x%04x, len %d, flags 0x%x, stop %d\\n\"",\n-\t\t__func__, msg->addr, msg->len, msg->flags, stop);\n \tif (msg->len == 0)\n \t\treturn -EINVAL;\n \n@@ -442,8 +426,6 @@ static int tegra_i2c_xfer_msg(struct tegra_i2c_bus *i2c_bus,\n \tif (!(msg->flags & I2C_M_RD))\n \t\ttegra_i2c_fill_tx_fifo(i2c_dev);\n \n-\tdev_dbg(i2c_dev->dev, \""before transfer: %08x fifo %02x\\n\"", i2c_readl(i2c_dev, I2C_PACKET_TRANSFER_STATUS), i2c_readl(i2c_dev, I2C_FIFO_STATUS));\n-\n \tint_mask = I2C_INT_NO_ACK | I2C_INT_ARBITRATION_LOST;\n \tif (msg->flags & I2C_M_RD)\n \t\tint_mask |= I2C_INT_RX_FIFO_DATA_REQ;\n@@ -455,7 +437,6 @@ static int tegra_i2c_xfer_msg(struct tegra_i2c_bus *i2c_bus,\n \tret = wait_for_completion_timeout(&i2c_dev->msg_complete, TEGRA_I2C_TIMEOUT);\n \ttegra_i2c_mask_irq(i2c_dev, int_mask);\n \n-\tdev_dbg(i2c_dev->dev, \""after transfer: %08x fifo %02x\\n\"", i2c_readl(i2c_dev, I2C_PACKET_TRANSFER_STATUS), i2c_readl(i2c_dev, I2C_FIFO_STATUS));\n \tif (WARN_ON(ret == 0)) {\n \t\tdev_err(i2c_dev->dev, \""i2c transfer timed out\\n\"");\n \n@@ -478,14 +459,15 @@ static int tegra_i2c_xfer_msg(struct tegra_i2c_bus *i2c_bus,\n \treturn -EIO;\n }\n \n-static int tegra_i2c_xfer(struct i2c_adapter *adap, struct i2c_msg msgs[], int num)\n+static int tegra_i2c_xfer(struct i2c_adapter *adap, struct i2c_msg msgs[],\n+\tint num)\n {\n \tstruct tegra_i2c_bus *i2c_bus = i2c_get_adapdata(adap);\n \tstruct tegra_i2c_dev *i2c_dev = i2c_bus->dev;\n \tint i;\n \tint ret = 0;\n \n-\tif(i2c_dev->is_suspended)\n+\tif (i2c_dev->is_suspended)\n \t\treturn -EBUSY;\n \n \trt_mutex_lock(&i2c_dev->dev_lock);\n@@ -681,7 +663,8 @@ static int tegra_i2c_remove(struct platform_device *pdev)\n \tfree_irq(i2c_dev->irq, i2c_dev);\n \tclk_put(i2c_dev->i2c_clk);\n \tclk_put(i2c_dev->clk);\n-\trelease_mem_region(i2c_dev->iomem->start, resource_size(i2c_dev->iomem));\n+\trelease_mem_region(i2c_dev->iomem->start,\n+\t\tresource_size(i2c_dev->iomem));\n \tiounmap(i2c_dev->base);\n \tkfree(i2c_dev);\n \treturn 0;\n@@ -728,8 +711,7 @@ static struct platform_driver tegra_i2c_driver = {\n \t.suspend = tegra_i2c_suspend,\n \t.resume  = tegra_i2c_resume,\n #endif\n-\t.driver  =\n-\t{\n+\t.driver  = {\n \t\t.name  = \""tegra-i2c\"",\n \t\t.owner = THIS_MODULE,\n \t},\n""}","bug
"
23042,Nick Kralevich,Don't fail if vold.fstab is empty,['tests/tests/security/src/android/security/cts/VoldExploitTest.java'],"Don't fail if vold.fstab is empty

This test shouldn't fail if vold.fstab is empty.  Rather, short
term, just ignore this case, at the expense that we may miss
legitimate security holes.

Long term, this needs to be properly fixed.

Change-Id: I328bc0360048b5233b336c1a35f7d8a9ade3c49c",https://android-review.googlesource.com/c/23042,"bug, test 
","test,bug",Bug;Test;,"{""VoldExploitTest.java"": ""@@ -50,7 +50,11 @@ public class VoldExploitTest extends TestCase {\n         Set<String> devices = new HashSet<String>();\n         devices.addAll(getSysFsPath(\""/etc/vold.fstab\""));\n         devices.addAll(getSysFsPath(\""/system/etc/vold.fstab\""));\n-        assertTrue(devices.size() > 0);\n+        if (devices.isEmpty()) {\n+          // FIXME: We should be able to detect this security hole\n+          // even if there's no vold.fstab entry\n+          return;\n+        }\n \n         // Verify that all processes listening for netlink messages\n         // currently exist.\n""}","bug, test 
"
15581,Jean-Baptiste Queru,Speculative fix for intermittent CTS UI test failures.,['tests/core/runner/src/android/test/InstrumentationCtsTestRunner.java'],"Speculative fix for intermittent CTS UI test failures.

UI related tests fail if the keyguard is currently displayed.
Previously, the CTS harness used a separate util app which would disable the
keyguard upon receiving a broadcast.

However, if the util app's process is killed by the system, the keyguard is
immediately displayed. Its not known for sure, but this could explain the
intermittent UI test failures.

This commit adds logic to disable the keyguard in the CTS test runner itself.

Bug 2342725.

Change-Id: I6fbc89fb895f56527d367508f455f5cbaa1a6f46",https://android-review.googlesource.com/c/15581,"bug, test 
",bug;test;,Bug;Deprecat;Test;,"{""InstrumentationCtsTestRunner.java"": ""@@ -16,27 +16,31 @@\n \n package android.test;\n \n-import java.io.File;\n-import java.lang.reflect.Field;\n-import java.lang.reflect.Modifier;\n-import java.util.List;\n-import java.util.TimeZone;\n-\n import com.android.internal.util.Predicate;\n import com.android.internal.util.Predicates;\n \n import dalvik.annotation.BrokenTest;\n import dalvik.annotation.SideEffect;\n \n-import junit.framework.AssertionFailedError;\n-import junit.framework.Test;\n-import junit.framework.TestCase;\n-import junit.framework.TestListener;\n+import android.app.KeyguardManager;\n+import android.content.Context;\n+import android.content.pm.PackageManager;\n import android.os.Bundle;\n import android.test.suitebuilder.TestMethod;\n import android.test.suitebuilder.annotation.HasAnnotation;\n import android.util.Log;\n \n+import java.io.File;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Modifier;\n+import java.util.List;\n+import java.util.TimeZone;\n+\n+import junit.framework.AssertionFailedError;\n+import junit.framework.Test;\n+import junit.framework.TestCase;\n+import junit.framework.TestListener;\n+\n /**\n  * This test runner extends the default InstrumentationTestRunner. It overrides\n  * the {@code onCreate(Bundle)} method and sets the system properties necessary\n@@ -52,37 +56,50 @@ public class InstrumentationCtsTestRunner extends InstrumentationTestRunner {\n \n     /**\n      * Convenience definition of our log tag.\n-     */ \n+     */\n     private static final String TAG = \""InstrumentationCtsTestRunner\"";\n-    \n+\n     /**\n      * True if (and only if) we are running in single-test mode (as opposed to\n      * batch mode).\n      */\n     private boolean singleTest = false;\n-    \n+\n     @Override\n     public void onCreate(Bundle arguments) {\n         // We might want to move this to /sdcard, if is is mounted/writable.\n         File cacheDir = getTargetContext().getCacheDir();\n \n-        // Set some properties that the core tests absolutely need. \n+        // Set some properties that the core tests absolutely need.\n         System.setProperty(\""user.language\"", \""en\"");\n         System.setProperty(\""user.region\"", \""US\"");\n-        \n+\n         System.setProperty(\""java.home\"", cacheDir.getAbsolutePath());\n         System.setProperty(\""user.home\"", cacheDir.getAbsolutePath());\n         System.setProperty(\""java.io.tmpdir\"", cacheDir.getAbsolutePath());\n         System.setProperty(\""javax.net.ssl.trustStore\"",\n                 \""/etc/security/cacerts.bks\"");\n-        \n+\n         TimeZone.setDefault(TimeZone.getTimeZone(\""GMT\""));\n-        \n+\n         if (arguments != null) {\n             String classArg = arguments.getString(ARGUMENT_TEST_CLASS);\n-            singleTest = classArg != null && classArg.contains(\""#\""); \n+            singleTest = classArg != null && classArg.contains(\""#\"");\n         }\n-        \n+\n+        // attempt to disable keyguard,  if current test has permission to do so\n+        // TODO: move this to a better place, such as InstrumentationTestRunner ?\n+        if (getContext().checkCallingOrSelfPermission(android.Manifest.permission.DISABLE_KEYGUARD)\n+                == PackageManager.PERMISSION_GRANTED) {\n+            Log.i(TAG, \""Disabling keyguard\"");\n+            KeyguardManager keyguardManager =\n+                (KeyguardManager) getContext().getSystemService(Context.KEYGUARD_SERVICE);\n+            keyguardManager.newKeyguardLock(\""cts\"").disableKeyguard();\n+        } else {\n+            Log.i(TAG, \""Test lacks permission to disable keyguard. \"" +\n+                    \""UI based tests may fail if keyguard is up\"");\n+        }\n+\n         super.onCreate(arguments);\n     }\n \n@@ -92,36 +109,36 @@ public class InstrumentationCtsTestRunner extends InstrumentationTestRunner {\n \n         runner.addTestListener(new TestListener() {\n             /**\n-             * The last test class we executed code from.  \n+             * The last test class we executed code from.\n              */\n             private Class<?> lastClass;\n-            \n+\n             /**\n              * The minimum time we expect a test to take.\n              */\n             private static final int MINIMUM_TIME = 100;\n-            \n+\n             /**\n              * The start time of our current test in System.currentTimeMillis().\n              */\n             private long startTime;\n-            \n+\n             public void startTest(Test test) {\n                 if (test.getClass() != lastClass) {\n                     lastClass = test.getClass();\n                     printMemory(test.getClass());\n                 }\n-                \n+\n                 Thread.currentThread().setContextClassLoader(\n                         test.getClass().getClassLoader());\n-                \n+\n                 startTime = System.currentTimeMillis();\n             }\n-            \n+\n             public void endTest(Test test) {\n                 if (test instanceof TestCase) {\n                     cleanup((TestCase)test);\n-                    \n+\n                     /*\n                      * Make sure all tests take at least MINIMUM_TIME to\n                      * complete. If they don't, we wait a bit. The Cupcake\n@@ -129,7 +146,7 @@ public class InstrumentationCtsTestRunner extends InstrumentationTestRunner {\n                      * short time, which causes headache for the CTS.\n                      */\n                     long timeTaken = System.currentTimeMillis() - startTime;\n-                    \n+\n                     if (timeTaken < MINIMUM_TIME) {\n                         try {\n                             Thread.sleep(MINIMUM_TIME - timeTaken);\n@@ -139,15 +156,15 @@ public class InstrumentationCtsTestRunner extends InstrumentationTestRunner {\n                     }\n                 }\n             }\n-            \n+\n             public void addError(Test test, Throwable t) {\n                 // This space intentionally left blank.\n             }\n-            \n+\n             public void addFailure(Test test, AssertionFailedError t) {\n                 // This space intentionally left blank.\n             }\n-            \n+\n             /**\n              * Dumps some memory info.\n              */\n@@ -157,7 +174,7 @@ public class InstrumentationCtsTestRunner extends InstrumentationTestRunner {\n                 long total = runtime.totalMemory();\n                 long free = runtime.freeMemory();\n                 long used = total - free;\n-                \n+\n                 Log.d(TAG, \""Total memory  : \"" + total);\n                 Log.d(TAG, \""Used memory   : \"" + used);\n                 Log.d(TAG, \""Free memory   : \"" + free);\n@@ -173,7 +190,7 @@ public class InstrumentationCtsTestRunner extends InstrumentationTestRunner {\n              */\n             private void cleanup(TestCase test) {\n                 Class<?> clazz = test.getClass();\n-                \n+\n                 while (clazz != TestCase.class) {\n                     Field[] fields = clazz.getDeclaredFields();\n                     for (int i = 0; i < fields.length; i++) {\n@@ -188,15 +205,15 @@ public class InstrumentationCtsTestRunner extends InstrumentationTestRunner {\n                             }\n                         }\n                     }\n-                    \n+\n                     clazz = clazz.getSuperclass();\n                 }\n             }\n-            \n+\n         });\n-        \n+\n         return runner;\n-    }    \n+    }\n \n     @Override\n     List<Predicate<TestMethod>> getBuilderRequirements() {\n""}","bug, test 
"
19379,RaphaÃ«l Moll,Display output error in the exception's toString..,"['eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/build/ProguardResultException.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/build/ExecResultException.java']","Display output error in the exception's toString..

Change-Id: I050a663fc760f0b0c98a7d8dbcfa141168e30030",https://android-review.googlesource.com/c/19379,"bug
",bug,Others;,"{""ExecResultException.java"": ""@@ -44,4 +44,29 @@ class ExecResultException extends Exception {\n     public int getErrorCode() {\n         return mErrorCode;\n     }\n+\n+    public String getLabel() {\n+        return \""Command-line\"";\n+    }\n+\n+    @Override\n+    public String toString() {\n+        String result = String.format(\""%1$s Error %2$d\"", getLabel(), mErrorCode);\n+        if (mOutput != null && mOutput.length > 0) {\n+            // Note : the \""error detail\"" window in Eclipse seem to ignore the \\n,\n+            // so we prefix them with a space. It's not optimal but it's slightly readable.\n+            result += \"" \\nOutput:\"";\n+            for (String o : mOutput) {\n+                if (o != null) {\n+                    result += \"" \\n\"" + o;\n+                }\n+            }\n+        }\n+        return result;\n+    }\n+\n+    @Override\n+    public String getMessage() {\n+        return toString();\n+    }\n }\n"", ""ProguardResultException.java"": ""@@ -26,4 +26,9 @@ public final class ProguardResultException extends ExecResultException {\n     ProguardResultException(int errorCode, String[] output) {\n         super(errorCode, output);\n     }\n+\n+    @Override\n+    public String getLabel() {\n+        return \""Proguard\"";\n+    }\n }\n""}","bug 
"
9737,Tim Chick,"Add bccmd tool to makefile, conditional on board bluetooth type",['utils/tools/Android.mk'],"Add bccmd tool to makefile, conditional on board bluetooth type

I think bcsp support needs to be added to hciattach too.
",https://android-review.googlesource.com/c/9737,"feature
",feature,Resource;,"{""Android.mk"": ""@@ -159,3 +159,42 @@ LOCAL_STATIC_LIBRARIES := \\\n LOCAL_MODULE:=hciattach\n \n include $(BUILD_EXECUTABLE)\n+\n+# Tools useful only for CSR Bluetooth chips\n+ifeq ($(BOARD_HAVE_BLUETOOTH_CSR),true)\n+\n+#\n+# bccmd\n+#\n+\n+include $(CLEAR_VARS)\n+\n+LOCAL_SRC_FILES:= \\\n+\tbccmd.c \\\n+\tcsr.c \\\n+\tcsr_hci.c \\\n+\tcsr_bcsp.c \\\n+\tcsr_h4.c \\\n+\tcsr_3wire.c \\\n+\tubcsp.h \\\n+\tubcsp.c\n+\n+LOCAL_C_INCLUDES:= \\\n+\t$(call include-path-for, bluez-libs) \\\n+\t$(call include-path-for, bluez-utils)/common/\n+\n+LOCAL_CFLAGS:= \\\n+\t-DVERSION=\\\""3.36\\\"" -fpermissive\n+\n+LOCAL_SHARED_LIBRARIES := \\\n+\tlibbluetooth\n+\n+LOCAL_STATIC_LIBRARIES := \\\n+\tlibbluez-utils-common-static\n+\n+LOCAL_MODULE:=bccmd\n+\n+include $(BUILD_EXECUTABLE)\n+\n+# End of BOARD_HAVE_BLUETOOTH_CSR\n+endif\n""}","feature 
"
8662,Team Android CDMA,Extend ANDROID with CDMA mobile technology support . Feature Complete. Review Comment Fixes.,"['src/com/android/phone/EditFdnContactScreen.java', 'AndroidManifest.xml', 'src/com/android/phone/IccNetworkDepersonalizationPanel.java', 'src/com/android/phone/CallCard.java', 'src/com/android/phone/CallNotifier.java', 'src/com/android/phone/FdnList.java', 'src/com/android/phone/FdnSetting.java', 'res/xml/network_setting.xml', 'src/com/android/phone/ChangeIccPinScreen.java', 'src/com/android/phone/PhoneApp.java', 'res/xml/cdma_options.xml', 'src/com/android/phone/NotificationMgr.java', 'src/com/android/phone/CdmaOptions.java', 'src/com/android/phone/EnableIccPinScreen.java', 'src/com/android/phone/Settings.java', 'src/com/android/phone/CellBroadcastSms.java', 'res/xml/gsm_umts_options.xml', 'src/com/android/phone/ADNList.java', 'src/com/android/phone/InCallScreen.java', 'src/com/android/phone/BluetoothHandsfree.java', 'src/com/android/phone/EnableFdnScreen.java', 'src/com/android/phone/PhoneUtils.java', 'src/com/android/phone/DeleteFdnContactScreen.java', 'src/com/android/phone/GsmUmtsOptions.java', 'src/com/android/phone/IccPinUnlockPanel.java', 'src/com/android/phone/Ringer.java', 'src/com/android/phone/IccMissingPanel.java', 'src/com/android/phone/PhoneInterfaceManager.java', 'res/values/strings.xml', 'res/xml/cell_broadcast_sms.xml', 'src/com/android/phone/SimContacts.java', 'src/com/android/phone/CallFeaturesSetting.java']","Extend ANDROID with CDMA mobile technology support . Feature Complete

This contribution is final functional step of the first release of the CDMA extension of the
Android telephony layers.
It contains changes in the phone related applications, the application
framework telephony packages and in the RIL daemon library space.
The implementation of the CDMA support requires architectural changes in the
telephony package and extensions of the RIL interface.
The application interface (SDK interface) will be extended to provide
CDMA specific features/information to the phone related application and other
applications.
Where ever possible the actual used radio technology is transparent for the
application using mobile connections.

This increment is tested on the Android emulator with a RIL simulator tool and
also tested on a reference HW platform.
The CDMA extension of the telephony stack can be used for Android phones
supporting either CDMA mobile technology only
or world mode including GSM/WCDMA and CDMA.
The following CDMA technologies are considered: IS-95, CDMA2000 1xRTT, CDMA2000
1x EVDO.

This contribution implements the following functionality:

- start up,
- access the CDMA subscription and other information from memory of from the
  card (either SIM, USIM or RUIM),
- register to the network,
- provides registration status to the application for displaying
- be able to handle incoming and outgoing voice calls,
- provide phone and call settings in the settings application
- provide supplementary services in the settings application
- provide supplementary services by in-call menues
- handles TTY and enhance voice privacy
- supports automatic radio technology change for a world mode phone from
  CDMA to GSM/UMTS or vice versa
- send and receive SMS
- configure and receive Broadcast SMS
- receive WAP Push SMS

Signed-off by : Saverio Labella,    saverio.labella@teleca.com
                Sigmar Lingner,     sigmar.lingner@teleca.com",https://android-review.googlesource.com/c/8662,"feature 
",feature;,Bug;Feature;Resource;Test;,,"feature 
"
15685,Xavier Ducrohet,ADT: dock/night combos in layout editor.,"['eclipse/plugins/com.android.ide.eclipse.adt/icons/orientation.png', 'sdkmanager/libs/sdklib/src/com/android/sdklib/resources/ScreenOrientation.java', 'eclipse/plugins/com.android.ide.eclipse.tests/unittests/com/android/ide/eclipse/adt/internal/editors/resources/configurations/DockModeQualifierTest.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/resources/KeyboardState.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/VersionQualifier.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/manager/ProjectResources.java', 'eclipse/plugins/com.android.ide.eclipse.adt/icons/size.png', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/ui/ConfigurationSelector.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/NavigationStateQualifier.java', 'eclipse/plugins/com.android.ide.eclipse.adt/icons/ratio.png', 'eclipse/plugins/com.android.ide.eclipse.adt/icons/nightmode.png', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/LanguageQualifier.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/NightModeQualifier.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/CountryCodeQualifier.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/RegionQualifier.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/NetworkCodeQualifier.java', 'eclipse/plugins/com.android.ide.eclipse.adt/icons/dockmode.png', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/ScreenSizeQualifier.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/PixelDensityQualifier.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/configuration/ConfigurationComposite.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/configuration/ConfigEditDialog.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/resources/NightMode.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/ResourceQualifier.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/NavigationMethodQualifier.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/ScreenOrientationQualifier.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/resources/DockMode.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/FolderConfiguration.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/resources/ScreenSize.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/KeyboardStateQualifier.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/DockModeQualifier.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/resources/ResourceEnum.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/ScreenDimensionQualifier.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/EnumBasedResourceQualifier.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/resources/TouchScreen.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/resources/Density.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/resources/Navigation.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/resources/NavigationState.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/resources/Keyboard.java', 'eclipse/plugins/com.android.ide.eclipse.adt/icons/version.png', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/TouchScreenQualifier.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/ScreenRatioQualifier.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/resources/configurations/TextInputMethodQualifier.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/resources/ScreenRatio.java']","ADT: dock/night combos in layout editor.

Also added proper support for qualifiers that have fake values
like ""__"" for language/region or ""none"" for dock mode. Those
are used by ADT internally but do not represent valid values, so
some UI (like the config creator) must handle them.

They didn't do it before which led to some weird UI behavior such
as a language or region qualifier with ""__"" value.

Finally, I also added some missing icons.

Change-Id: I29c7bb5a7783db1696f53d0e38f46f64671e5e0d",https://android-review.googlesource.com/c/15685,"**feature** 
",feature,Feature;,,"feature, resource 
"
24299,Dmitry Shmidt,"Update to 5.90.125.32: * Move Android specific functions to wl_android (wifi control functions,   wifi device, pre-alloc buffer.) * Link Android start/stop commands to interface up/down (download firmware   when primary interfacde is up.) * Fix a issue in driver unload, the same IRQ can not be disabled twice   (set_irq_wake)","['drivers/net/wireless/bcmdhd/dhd_linux.c', 'drivers/net/wireless/bcmdhd/wl_cfg80211.c', 'drivers/net/wireless/bcmdhd/wldev_common.h', 'drivers/net/wireless/bcmdhd/wl_android.h', 'drivers/net/wireless/bcmdhd/wl_iw.c', 'drivers/net/wireless/bcmdhd/wl_cfgp2p.c', 'drivers/net/wireless/bcmdhd/wl_android.c', 'drivers/net/wireless/bcmdhd/bcmsdh_linux.c', 'drivers/net/wireless/bcmdhd/dhd_common.c', 'drivers/net/wireless/bcmdhd/dhd_custom_gpio.c', 'drivers/net/wireless/bcmdhd/dhd_sdio.c', 'drivers/net/wireless/bcmdhd/linux_osl.c', 'drivers/net/wireless/bcmdhd/dhd_cdc.c', 'drivers/net/wireless/bcmdhd/include/epivers.h', 'drivers/net/wireless/bcmdhd/wldev_common.c', 'drivers/net/wireless/bcmdhd/dhd.h']","Update to 5.90.125.32:
* Move Android specific functions to wl_android (wifi control functions,
  wifi device, pre-alloc buffer.)
* Link Android start/stop commands to interface up/down (download firmware
  when primary interfacde is up.)
* Fix a issue in driver unload, the same IRQ can not be disabled twice
  (set_irq_wake)

Change-Id: Id49c4f746f69371323c9a34834c3b628b78ff713
Signed-off-by: Howard M. Harte <hharte@broadcom.com>
Signed-off-by: Dmitry Shmidt <dimitrysh@google.com>",https://android-review.googlesource.com/c/24299,"bug, feature, refactor 
","bug,featue",Bug;Deprecat;,,"bug, feature 
"
21103,Johan Redestig,Camera: Fix unstable test result on testpreviewcallback,['tests/tests/hardware/src/android/hardware/cts/CameraTest.java'],"Camera: Fix unstable test result on testpreviewcallback

The callback is called at unexpected timing.
To avoid this issue, we need to wait for a while before going
to the next test.

Change-Id: I1d17cbd4c6678eca399829828119c85ba805b243",https://android-review.googlesource.com/c/21103,"bug, test 
","bug, test 
",Bug;Test;,"{""CameraTest.java"": ""@@ -409,6 +409,13 @@ public class CameraTest extends ActivityInstrumentationTestCase2<CameraStubActiv\n             waitForPreviewDone();\n             assertTrue(mPreviewCallbackResult);\n             mCamera.stopPreview();\n+            try {\n+                // Wait for a while to throw away the remaining preview frames.\n+                Thread.sleep(1000);\n+            } catch(Exception e) {\n+                // ignore\n+            }\n+            mPreviewDone.close();\n         }\n         terminateMessageLooper();\n     }\n""}","test, bug 
"
23156,David Turner,Fix Eclair crash when loading gnustl-linked shared library,['build/tools/toolchain-patches/gcc/0001-gcc-prevent-crash-on-Eclair-and-older-platforms.patch'],"Fix Eclair crash when loading gnustl-linked shared library

This adds a local gcc patch to prevent exception or rtti aware
machine code linked against gnustl_static from crashing on Eclair
and older platform releases.

This is really a work-around for dynamic linker bug. Nothing that
should be sent to upstream.

Change-Id: I6b50c8024fa4500a2732d8d712e03d555989c6ab",https://android-review.googlesource.com/c/23156,"bug 
",bug,Bug;,"{""0001-gcc-prevent-crash-on-Eclair-and-older-platforms.patch"": ""@@ -0,0 +1,54 @@\n+From f8284d694bf6cf563c11df2e1bcfbeeb834e23d9 Mon Sep 17 00:00:00 2001\n+From: David 'Digit' Turner <digit@android.com>\n+Date: Tue, 24 May 2011 23:34:22 +0200\n+Subject: [PATCH] gcc: prevent crash on Eclair and older platforms.\n+\n+The point of this patch is to work-around a bug in the Eclair\n+dynamic linker, which doesn't support weak symbols. By default,\n+libsupc++ and libstdc++ generate static C++ constructors that\n+reference weak symbols.\n+\n+When they are statically linked into shared libraries, the\n+corresponding code is referenced in its .init_array section\n+and run when the shared library is loaded.\n+\n+On Eclair and previous release, the weak symbol is not resolved\n+before the constructor are launched, resulting in a crash when\n+the PLT entry tries to jump to address 0.\n+\n+By not generating weak symbol references, we avoid the problem\n+completely. And we don't need them because the pthread symbols\n+are all in the C library on Android, unlike legacy Linux systems\n+which put them in libpthread.so (and provide weak stubs in libc.so).\n+\n+Change-Id: I289db08a9ea567f0574bb2058516bfeb01c68a2c\n+---\n+ gcc-4.4.3/gcc/gthr-posix.h |   12 ++++++++++++\n+ 1 files changed, 12 insertions(+), 0 deletions(-)\n+\n+diff --git a/gcc-4.4.3/gcc/gthr-posix.h b/gcc-4.4.3/gcc/gthr-posix.h\n+index 27652f9..0cb706b 100644\n+--- a/gcc-4.4.3/gcc/gthr-posix.h\n++++ b/gcc-4.4.3/gcc/gthr-posix.h\n+@@ -38,6 +38,18 @@ see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see\n+ #define _REENTRANT 1\n+ #endif\n+ \n++/* The following should normally be in a different header file,\n++ * but I couldn't find the right location. The point of the macro\n++ * definition below is to prevent libsupc++ and libstdc++ to reference\n++ * weak symbols in their static C++ constructors. Such code crashes\n++ * when a shared object linked statically to these libraries is\n++ * loaded on Android 2.1 (Eclair) and older platform releases, due\n++ * to a dynamic linker bug.\n++ */\n++#ifdef __ANDROID__\n++#define GTHREAD_USE_WEAK 0\n++#endif\n++\n+ #include <pthread.h>\n+ #include <unistd.h>\n+ \n+-- \n+1.7.3.1\n+\n""}","bug 
"
16938,vchtchetkine,Add android_port initialization in the core.,"['android/main.c', 'android/qemulator.c', 'keymaps.c', 'android/ui-core-protocol.c', 'android/qemu-setup.c', 'Makefile.android', 'android/ui-core-protocol.h']","Add android_port initialization in the core.

Also some minor cleanups to the ui <-> core stuff.

Change-Id: I7d64ec1aa694c027851b7e262b6e1b80bb6cef08",https://android-review.googlesource.com/c/16938,"feature, refactor 
","feature,refactor",Feature;,"{""Makefile.android"": ""@@ -664,6 +664,7 @@ CORE_MISC_SOURCES = vl-android.c \\\n                     android/hw-control.c \\\n                     android/console.c \\\n                     android/hw-sensors.c \\\n+                    android/hw-qemud.c \\\n \n ifeq ($(HOST_ARCH),x86)\n     CORE_MISC_SOURCES += i386-dis.c\n@@ -727,7 +728,6 @@ UI_AND_CORE_SOURCES = osdep.c \\\n                       qemu-malloc.c \\\n                       android/keycode-array.c \\\n                       android/charmap.c \\\n-                      android/hw-qemud.c \\\n                       android/utils/bufprint.c \\\n                       android/utils/debug.c \\\n                       android/utils/path.c \\\n"", ""main.c"": ""@@ -44,11 +44,7 @@\n #include \""android/skin/window.h\""\n #include \""android/skin/keyset.h\""\n \n-#include \""android/gps.h\""\n-#include \""android/hw-qemud.h\""\n-#include \""android/hw-kmsg.h\""\n #include \""android/hw-lcd.h\""\n-#include \""android/hw-sensors.h\""\n #include \""android/boot-properties.h\""\n #include \""android/user-config.h\""\n #include \""android/utils/bufprint.h\""\n@@ -1389,14 +1385,10 @@ int main(int argc, char **argv)\n \n     /* we always send the kernel messages from ttyS0 to android_kmsg */\n     {\n-        AndroidKmsgFlags  flags = 0;\n-\n         if (opts->show_kernel) {\n-            flags |= ANDROID_KMSG_PRINT_MESSAGES;\n             args[n++] = \""-show-kernel\"";\n         }\n \n-        android_kmsg_init( flags );\n         args[n++] = \""-serial\"";\n         args[n++] = \""android-kmsg\"";\n         serial++;\n"", ""qemu-setup.c"": ""@@ -23,6 +23,7 @@\n #include \""android/utils/path.h\""\n #include \""android/utils/system.h\""\n #include \""android/utils/bufprint.h\""\n+#include \""android/core-ui-protocol.h\""\n \n #define  D(...)  do {  if (VERBOSE_CHECK(init)) dprint(__VA_ARGS__); } while (0)\n \n@@ -330,6 +331,8 @@ void  android_emulation_setup( void )\n \n     android_modem_init( base_port );\n \n+    /* Save base port and call back to UI so it can properly set up its window title. */\n+    android_base_port = base_port;\n     android_ui_set_base_port(base_port);\n \n    /* send a simple message to the ADB host server to tell it we just started.\n"", ""qemulator.c"": ""@@ -375,9 +375,9 @@ handle_key_command( void*  opaque, SkinKeyCommand  command, int  down )\n     {\n     case SKIN_KEY_COMMAND_TOGGLE_NETWORK:\n         {\n-            qemu_net_disable = !qemu_net_disable;\n-            android_core_set_network_enabled(!qemu_net_disable);\n-            D( \""network is now %s\"", qemu_net_disable ? \""disconnected\"" : \""connected\"" );\n+            android_core_toggle_network();\n+            D( \""network is now %s\"", android_core_is_network_disabled() ?\n+                                    \""disconnected\"" : \""connected\"" );\n         }\n         break;\n \n@@ -563,7 +563,7 @@ static void qemulator_refresh(QEmulator* emulator)\n #endif\n             /* only save emulator config through clean exit */\n             qemulator_done(qemulator_get());\n-            qemu_system_shutdown_request();\n+            android_core_system_shutdown_request();\n             return;\n         }\n     }\n@@ -597,6 +597,6 @@ android_emulator_set_window_scale( double  scale, int  is_dpi )\n void\n android_emulator_set_base_port( int  port )\n {\n-    android_base_port = port;\n+    /* Base port is already set in the emulator's core. */\n     qemulator_set_title(qemulator);\n }\n"", ""ui-core-protocol.c"": ""@@ -27,6 +27,8 @@\n #include \""telephony/modem_driver.h\""\n #include \""trace.h\""\n #include \""audio/audio.h\""\n+extern void qemu_system_shutdown_request(void);\n+extern char* qemu_find_file(int type, const char* filename);\n #endif  // CONFIG_STANDALONE_UI\n \n int\n@@ -68,6 +70,7 @@ android_core_sensors_set_coarse_orientation( AndroidCoarseOrientation  orient )\n void\n android_core_set_network_enabled(int enabled)\n {\n+    /* Temporary implementation for the monolitic (core + ui) builds. */\n #if !defined(CONFIG_STANDALONE_UI)\n     if (android_modem) {\n         amodem_set_data_registration(\n@@ -78,6 +81,27 @@ android_core_set_network_enabled(int enabled)\n #endif  // CONFIG_STANDALONE_UI\n }\n \n+void\n+android_core_toggle_network(void)\n+{\n+    /* Temporary implementation for the monolitic (core + ui) builds. */\n+#if !defined(CONFIG_STANDALONE_UI)\n+    qemu_net_disable = !qemu_net_disable;\n+    android_core_set_network_enabled(!qemu_net_disable);\n+#endif  // CONFIG_STANDALONE_UI\n+}\n+\n+int\n+android_core_is_network_disabled(void)\n+{\n+    /* Temporary implementation for the monolitic (core + ui) builds. */\n+#if !defined(CONFIG_STANDALONE_UI)\n+    return qemu_net_disable;\n+#else\n+    return 0;\n+#endif  // CONFIG_STANDALONE_UI\n+}\n+\n void android_core_tracing_start(void)\n {\n #if !defined(CONFIG_STANDALONE_UI)\n@@ -156,3 +180,31 @@ android_core_audio_get_backend_name(int is_input, int index,\n     return -1;\n #endif  // !CONFIG_STANDALONE_UI\n }\n+\n+void\n+android_core_system_shutdown_request(void)\n+{\n+    /* Temporary implementation for the monolitic (core + ui) builds. */\n+#if !defined(CONFIG_STANDALONE_UI)\n+    qemu_system_shutdown_request();\n+#endif  // !CONFIG_STANDALONE_UI\n+}\n+\n+int\n+android_core_qemu_find_file(int type, const char *filename,\n+                            char* path, size_t path_buf_size)\n+{\n+    /* Temporary implementation for the monolitic (core + ui) builds. */\n+#if !defined(CONFIG_STANDALONE_UI)\n+    char* filepath = qemu_find_file(type, filename);\n+    if (filepath == NULL) {\n+        return -1;\n+    }\n+    strncpy(path, filepath, path_buf_size);\n+    filepath[path_buf_size - 1] = '\\0';\n+    qemu_free(filepath);\n+    return 0;\n+#else\n+    return -1;\n+#endif  // !CONFIG_STANDALONE_UI\n+}\n"", ""ui-core-protocol.h"": ""@@ -45,9 +45,15 @@ int android_core_get_base_port(void);\n /* change the coarse orientation value */\n void  android_core_sensors_set_coarse_orientation( AndroidCoarseOrientation  orient );\n \n-/* Sets/toggles the network state */\n+/* Sets the network state */\n void android_core_set_network_enabled(int enabled);\n \n+/* Toggles the network state */\n+void android_core_toggle_network(void);\n+\n+/* Gets the network state */\n+int android_core_is_network_disabled(void);\n+\n /* Start/stop tracing in the guest system */\n void android_core_tracing_start(void);\n void android_core_tracing_stop(void);\n@@ -86,4 +92,22 @@ int android_core_audio_get_backend_name(int is_input, int index,\n                                         char* name, size_t name_buf_size,\n                                         char* descr, size_t descr_buf_size);\n \n+/* Notifies the core about system shutdown requested by the UI. */\n+void android_core_system_shutdown_request(void);\n+\n+/* Builds a path to a file of the given type in the emulator's data directory.\n+ * Param:\n+ *  type - Type of the file to find. Only QEMU_FILE_TYPE_BIOS, and\n+ *      QEMU_FILE_TYPE_KEYMAP are allowed for this value.\n+ *  filename - Name of the file to build path for.\n+ *  path - Upon success contains path to the requested file inside the\n+ *      emulator's data directory.\n+ *  path_buf_size Character size of the buffer addressed by the path parameter.\n+ * Return:\n+ *  0 on success, or -1 on an error.\n+ */\n+int\n+android_core_qemu_find_file(int type, const char *filename,\n+                            char* path, size_t path_buf_size);\n+\n #endif  // QEMU_ANDROID_UI_CORE_PROTOCOL_H\n"", ""keymaps.c"": ""@@ -64,20 +64,43 @@ static kbd_layout_t *parse_keyboard_layout(const name2keysym_t *table,\n \t\t\t\t\t   kbd_layout_t * k)\n {\n     FILE *f;\n+    /* This file is used by both, UI and core components. There are differences\n+     * in the way how keymap file path is obtained for these two different\n+     * configurations. */\n+#if defined(CONFIG_STANDALONE_UI)\n+    char filename[2048];\n+#else\n     char * filename;\n+#endif  // CONFIG_STANDALONE_UI\n     char line[1024];\n     int len;\n \n+#if defined(CONFIG_STANDALONE_UI)\n+    if (android_core_qemu_find_file(QEMU_FILE_TYPE_KEYMAP, language,\n+                                    filename, sizeof(filename))) {\n+        fprintf(stderr,\n+            \""Could not read keymap file: '%s'\\n\"", language);\n+        return NULL;\n+    }\n+#else\n     filename = qemu_find_file(QEMU_FILE_TYPE_KEYMAP, language);\n+    if (!filename) {\n+        fprintf(stderr,\n+            \""Could not read keymap file: '%s'\\n\"", language);\n+        return NULL;\n+    }\n+#endif  // CONFIG_STANDALONE_UI\n \n     if (!k)\n \tk = qemu_mallocz(sizeof(kbd_layout_t));\n-    if (!(filename && (f = fopen(filename, \""r\"")))) {\n+    if (!(f = fopen(filename, \""r\""))) {\n \tfprintf(stderr,\n \t\t\""Could not read keymap file: '%s'\\n\"", language);\n \treturn NULL;\n     }\n+#if defined(CONFIG_STANDALONE_UI)\n     qemu_free(filename);\n+#endif  // CONFIG_STANDALONE_UI\n     for(;;) {\n \tif (fgets(line, 1024, f) == NULL)\n             break;\n""}","feature 
"
22766,David Turner,console: Fix 'event send' handling.,"['android/hw-events.c', 'android/console.c']","console: Fix 'event send' handling.

This patch fixes two bugs in the implementation of the 'event send'
command:

1/ It prevents a crash when using the '0:0:0' event triple
   (note that the equivalent EV_SYNC:0:0 used in testing didn't crash)

2/ If fixes the parser to correctly handle several event triples on
   the same line, as in:

      event send  <type1>:<code1>:<value1> <type2>:<code2>:<value2> ...

Change-Id: I26cb55dd2feb75fda4f50ba0d49c7c8ad8a9dcca",https://android-review.googlesource.com/c/22766,"bug 
",bug,Bug;Feature;Test;,"{""console.c"": ""@@ -1854,9 +1854,10 @@ do_event_send( ControlClient  client, char*  args )\n     p = args;\n     while (*p) {\n         char*  q;\n+        char   temp[128];\n         int    type, code, value, ret;\n \n-        p += strspn( args, \"" \\t\"" );  /* skip spaces */\n+        p += strspn( p, \"" \\t\"" );  /* skip spaces */\n         if (*p == 0)\n             break;\n \n@@ -1865,7 +1866,8 @@ do_event_send( ControlClient  client, char*  args )\n         if (q == p)\n             break;\n \n-        ret = android_event_from_str( p, &type, &code, &value );\n+        snprintf(temp, sizeof temp, \""%.*s\"", q-p, p);\n+        ret = android_event_from_str( temp, &type, &code, &value );\n         if (ret < 0) {\n             if (ret == -1) {\n                 control_write( client,\n"", ""hw-events.c"": ""@@ -106,7 +106,7 @@ eventList_findCodeByName( EventList    list,\n     if (namelen <= 0)\n         return -1;\n \n-    for ( ; list != NULL; list += 1 ) {\n+    for ( ; list->name != NULL; list += 1 ) {\n         if ( !memcmp(name, list->name, namelen) &&\n              list->name[namelen] == 0 )\n         {\n@@ -167,7 +167,11 @@ android_event_from_str( const char*  name,\n         q = pend;\n \n     list   = eventList_findByType( *ptype );\n-    *pcode = eventList_findCodeByName( list, p, q-p );\n+    if (list == NULL) {\n+        *pcode = -1;\n+    } else {\n+        *pcode = eventList_findCodeByName( list, p, q-p );\n+    }\n     if (*pcode < 0) {\n         *pcode = (int) strtol( p, &end, 0 );\n         if (end != q)\n""}","bug, feature 
"
23797,Dmitry Shmidt,net: wireless: bcmdhd: Fix getting Mac address from platform data,['drivers/net/wireless/bcmdhd/dhd_common.c'],"net: wireless: bcmdhd: Fix getting Mac address from platform data

Signed-off-by: Dmitry Shmidt <dimitrysh@google.com>
",https://android-review.googlesource.com/c/23797,"bug
",bug,Bug;,"{""dhd_common.c"": ""@@ -1572,8 +1572,8 @@ dhd_preinit_ioctls(dhd_pub_t *dhd)\n \t\t\tDHD_ERROR((\""%s: can't set MAC address , error=%d\\n\"", __FUNCTION__, ret));\n \t\t} else\n \t\t\tmemcpy(dhd->mac.octet, (void *)&ea_addr, ETHER_ADDR_LEN);\n-\t}\n-#else\n+\t} else {\n+#endif /* GET_CUSTOM_MAC_ENABLE */\n \t/* Get the default device MAC address directly from firmware */\n \tstrcpy(iovbuf, \""cur_etheraddr\"");\n \tif ((ret = dhd_wl_ioctl_cmd(dhd, WLC_GET_VAR, iovbuf, sizeof(iovbuf), FALSE, 0)) < 0) {\n@@ -1581,6 +1581,8 @@ dhd_preinit_ioctls(dhd_pub_t *dhd)\n \t\treturn BCME_NOTUP;\n \t}\n \tmemcpy(dhd->mac.octet, iovbuf, ETHER_ADDR_LEN);\n+#ifdef GET_CUSTOM_MAC_ENABLE\n+\t}\n #endif /* GET_CUSTOM_MAC_ENABLE */\n \n #ifdef SET_RANDOM_MAC_SOFTAP\n""}","resource 
"
20620,vchtchetkine,Remove unnecessary calls in UI <-> Core protocols.,"['android/qemulator.c', 'android/core-ui-protocol.c', 'android/core-ui-protocol.h', 'android/main-ui.c', 'vl-android.c', 'android/ui-core-protocol.c', 'android/qemu-setup.c', 'android/ui-core-protocol.h']","Remove unnecessary calls in UI <-> Core protocols.

Core port related calls are no longer needed, since UI is aware of
core's base port on attachment to the core

Change-Id: Ic211fc9b02cb652009360f80917e90c44d941878",https://android-review.googlesource.com/c/20620,"refactor 
",refactor,Deprecat;,"{""core-ui-protocol.c"": ""@@ -24,7 +24,6 @@\n #if !defined(CONFIG_STANDALONE_CORE)\n /* in android/qemulator.c */\n extern void  android_emulator_set_window_scale( double, int );\n-extern void  android_emulator_set_base_port(int  port);\n #endif\n \n void\n@@ -35,11 +34,3 @@ android_ui_set_window_scale(double scale, int is_dpi)\n #endif\n }\n \n-void\n-android_ui_set_base_port(int  port)\n-{\n-#if !defined(CONFIG_STANDALONE_CORE)\n-    android_emulator_set_base_port(port);\n-#endif\n-}\n-\n"", ""core-ui-protocol.h"": ""@@ -24,7 +24,4 @@\n /* Changes the scale of the emulator window at runtime. */\n void android_ui_set_window_scale(double scale, int is_dpi);\n \n-/* Change the console port in the UI window */\n-void android_ui_set_base_port(int  port);\n-\n #endif  // QEMU_ANDROID_CORE_UI_PROTOCOL_H\n"", ""main-ui.c"": ""@@ -109,6 +109,9 @@ ClientFramebuffer* fb_client = NULL;\n /* -ui-settings parameters received from the core on UI attachment. */\n char* core_ui_settings = \""\"";\n \n+/* Emulator's core port. */\n+int android_base_port = 0;\n+\n /***********************************************************************/\n /***********************************************************************/\n /*****                                                             *****/\n@@ -951,7 +954,11 @@ attach_to_core(AndroidOptions* opts) {\n         return -1;\n     }\n \n+    // Save core's port, and set the title.\n+    android_base_port = sock_address_get_port(&console_socket);\n     emulator = qemulator_get();\n+    qemulator_set_title(emulator);\n+\n     fb_client = clientfb_create(&console_socket, \""-raw\"",\n                                 qemulator_get_first_framebuffer(emulator));\n     if (fb_client == NULL) {\n"", ""qemu-setup.c"": ""@@ -331,9 +331,8 @@ void  android_emulation_setup( void )\n \n     android_modem_init( base_port );\n \n-    /* Save base port and call back to UI so it can properly set up its window title. */\n+    /* Save base port. */\n     android_base_port = base_port;\n-    android_ui_set_base_port(base_port);\n \n    /* send a simple message to the ADB host server to tell it we just started.\n     * it should be listening on port 5037. if we can't reach it, don't bother\n"", ""qemulator.c"": ""@@ -258,7 +258,7 @@ qemulator_set_title(QEmulator* emulator)\n     }\n \n     p = bufprint(p, end, \""%d:%s\"",\n-                 android_core_get_base_port(),\n+                 android_base_port,\n                  avdInfo_getName( android_avdInfo ));\n \n     skin_window_set_title( emulator->window, temp );\n"", ""ui-core-protocol.c"": ""@@ -51,16 +51,6 @@ android_core_set_brightness_change_callback(AndroidHwLightBrightnessCallback cal\n #endif  // CONFIG_STANDALONE_UI\n }\n \n-int\n-android_core_get_base_port(void)\n-{\n-#if !defined(CONFIG_STANDALONE_UI)\n-    return android_base_port;\n-#else\n-    return 5554;\n-#endif  // CONFIG_STANDALONE_UI\n-}\n-\n void\n android_core_sensors_set_coarse_orientation( AndroidCoarseOrientation  orient )\n {\n"", ""ui-core-protocol.h"": ""@@ -39,9 +39,6 @@ typedef void  (*AndroidHwLightBrightnessCallback)( void*       opaque,\n void android_core_set_brightness_change_callback(AndroidHwLightBrightnessCallback callback,\n                                                  void* opaque);\n \n-/* Returns base port assigned for the emulated system. */\n-int android_core_get_base_port(void);\n-\n /* change the coarse orientation value */\n void  android_core_sensors_set_coarse_orientation( AndroidCoarseOrientation  orient );\n \n"", ""vl-android.c"": ""@@ -199,6 +199,11 @@\n unsigned long   android_verbose;\n #endif  // CONFIG_STANDALONE_CORE\n \n+#if !defined(CONFIG_STANDALONE_CORE)\n+/* in android/qemulator.c */\n+extern void  android_emulator_set_base_port(int  port);\n+#endif\n+\n #if defined(CONFIG_SKINS) && !defined(CONFIG_STANDALONE_CORE)\n #undef main\n #define main qemu_main\n@@ -5302,6 +5307,12 @@ int main(int argc, char **argv, char **envp)\n     /* call android-specific setup function */\n     android_emulation_setup();\n \n+#if !defined(CONFIG_STANDALONE_CORE)\n+    // For the standalone emulator (UI+core in one executable) we need to\n+    // set the window title here.\n+    android_emulator_set_base_port(android_base_port);\n+#endif\n+\n     if (loadvm)\n         do_loadvm(cur_mon, loadvm);\n \n""}","bug, refactor 
"
23512,Deleted User,emulator opengl: implement glGetString,"['tools/emulator/opengl/host/libs/libOpenglRender/RenderControl.cpp', 'tools/emulator/opengl/system/renderControl_enc/renderControl.in', 'tools/emulator/opengl/system/egl/egl.cpp', 'tools/emulator/opengl/system/renderControl_enc/renderControl.attrib', 'tools/emulator/opengl/system/OpenglSystemCommon/EGLClientIface.h', 'tools/emulator/opengl/system/GLESv1/gl.cpp']","emulator opengl: implement glGetString

Added rcGetGLString token to renderControl to query
a GL string constant from the current context from the host.
Implement glGetString functinality in EGL so that the string
value can be cached in the context structure and also
implementation can be shared between GLESv1 and GLESv2.

Also, fixed clientAPI context initialization check in
eglMakeCurrent. The check was for the previously bounded
context instead for the newly bounded context.

Change-Id: I41c0b4ad462c9ad5bd5c66719b41509bb1b7a947",https://android-review.googlesource.com/c/23512,"Categories: feature 
",Bug;Feature;,Bug;Feature;,"{""RenderControl.cpp"": ""@@ -17,6 +17,9 @@\n #include \""FrameBuffer.h\""\n #include \""FBConfig.h\""\n #include \""EGLDispatch.h\""\n+#include \""GLDispatch.h\""\n+#include \""GL2Dispatch.h\""\n+#include \""ThreadInfo.h\""\n \n static const GLint rendererVersion = 1;\n \n@@ -58,6 +61,38 @@ static EGLint rcQueryEGLString(EGLenum name, void* buffer, EGLint bufferSize)\n     return len;\n }\n \n+static EGLint rcGetGLString(EGLenum name, void* buffer, EGLint bufferSize)\n+{\n+    RenderThreadInfo *tInfo = getRenderThreadInfo();\n+    if (!tInfo || !tInfo->currContext.Ptr()) {\n+        return 0;\n+    }\n+\n+    const char *str = NULL;\n+#ifdef WITH_GLES2\n+    if (tInfo->currContext->isGL2()) {\n+        str = (const char *)s_gl2.glGetString(name);\n+    }\n+    else {\n+#endif\n+        str = (const char *)s_gl.glGetString(name);\n+#ifdef WITH_GLES2\n+    } \n+#endif\n+\n+    if (!str) {\n+        return 0;\n+    }\n+\n+    int len = strlen(str) + 1;\n+    if (!buffer || len > bufferSize) {\n+        return -len;\n+    }\n+\n+    strcpy((char *)buffer, str);\n+    return len;\n+}\n+\n static EGLint rcGetNumConfigs(uint32_t* numAttribs)\n {\n     if (numAttribs) {\n@@ -279,6 +314,7 @@ void initRenderControlContext(renderControl_decoder_context_t *dec)\n     dec->set_rcGetRendererVersion(rcGetRendererVersion);\n     dec->set_rcGetEGLVersion(rcGetEGLVersion);\n     dec->set_rcQueryEGLString(rcQueryEGLString);\n+    dec->set_rcGetGLString(rcGetGLString);\n     dec->set_rcGetNumConfigs(rcGetNumConfigs);\n     dec->set_rcGetConfigs(rcGetConfigs);\n     dec->set_rcChooseConfig(rcChooseConfig);\n"", ""gl.cpp"": ""@@ -68,10 +68,19 @@ void finish()\n \tglFinish();\n }\n \n+const GLubyte *my_glGetString (void *self, GLenum name)\n+{\n+    if (s_egl) {\n+        return (const GLubyte*)s_egl->getGLString(name);\n+    }\n+    return NULL;\n+}\n+\n void init() \n {\n \tGET_CONTEXT;\n \tctx->set_glEGLImageTargetTexture2DOES(glEGLImageTargetTexture2DOES);\n+\tctx->set_glGetString(my_glGetString);\n }\n \n extern \""C\"" {\n"", ""EGLClientIface.h"": ""@@ -5,6 +5,7 @@ struct EGLThreadInfo;  // defined in ThreadInfo.h\n \n typedef struct {\n     EGLThreadInfo* (*getThreadInfo)();\n+    const char* (*getGLString)(int glEnum);\n } EGLClient_eglInterface;\n \n typedef struct {\n"", ""egl.cpp"": ""@@ -142,14 +142,26 @@ struct EGLContext_t {\n \tEGLSurface          draw;\n \tEGLint\t\t\t\tversion;\n \tuint32_t \t\t\trcContext;\n+    const char*         versionString;\n+    const char*         vendorString;\n+    const char*         rendererString;\n+    const char*         extensionString;\n \n \tGLClientState * getClientState(){ return clientState; }\n private:\n \tGLClientState\t*\tclientState;\t\n };\n \n-EGLContext_t::EGLContext_t(EGLDisplay dpy, EGLConfig config) : dpy(dpy), config(config), \n-\t\tread(EGL_NO_SURFACE), draw(EGL_NO_SURFACE), rcContext(0)\n+EGLContext_t::EGLContext_t(EGLDisplay dpy, EGLConfig config) :\n+    dpy(dpy),\n+    config(config),\n+    read(EGL_NO_SURFACE),\n+    draw(EGL_NO_SURFACE),\n+    rcContext(0),\n+    versionString(NULL),\n+    vendorString(NULL),\n+    rendererString(NULL),\n+    extensionString(NULL)\n { \n \tflags = 0;\n \tversion = 1; \n@@ -158,8 +170,13 @@ EGLContext_t::EGLContext_t(EGLDisplay dpy, EGLConfig config) : dpy(dpy), config(\n \n EGLContext_t::~EGLContext_t() \n {\n-\tif (clientState) delete clientState;\n+\tdelete clientState;\n+    delete [] versionString;\n+    delete [] vendorString;\n+    delete [] rendererString;\n+    delete [] extensionString;\n }\n+\n // ----------------------------------------------------------------------------\n //egl_surface_t\n \n@@ -427,13 +444,76 @@ EGLBoolean egl_pbuffer_surface_t::connect()\n \treturn EGL_TRUE;\n }\n \n+static const char *getGLString(int glEnum)\n+{\n+    EGLThreadInfo *tInfo = getEGLThreadInfo();\n+    if (!tInfo || !tInfo->currentContext) {\n+        return NULL;\n+    }\n+\n+    const char** strPtr = NULL;\n+\n+#define GL_VENDOR                         0x1F00\n+#define GL_RENDERER                       0x1F01\n+#define GL_VERSION                        0x1F02\n+#define GL_EXTENSIONS                     0x1F03\n+\n+    switch(glEnum) {\n+        case GL_VERSION:\n+            strPtr = &tInfo->currentContext->versionString;\n+            break;\n+        case GL_VENDOR:\n+            strPtr = &tInfo->currentContext->vendorString;\n+            break;\n+        case GL_RENDERER:\n+            strPtr = &tInfo->currentContext->rendererString;\n+            break;\n+        case GL_EXTENSIONS:\n+            strPtr = &tInfo->currentContext->extensionString;\n+            break;\n+    }\n+\n+    if (!strPtr) {\n+        return NULL;\n+    }\n+\n+    if (*strPtr != NULL) {\n+        //\n+        // string is already cached\n+        //\n+        return *strPtr;\n+    }\n+\n+    //\n+    // first query of that string - need to query host\n+    //\n+\tDEFINE_AND_VALIDATE_HOST_CONNECTION(NULL);\n+    char *hostStr = NULL;\n+\tint n = rcEnc->rcGetGLString(rcEnc, glEnum, NULL, 0);\n+    if (n < 0) {\n+        hostStr = new char[-n+1];\n+        n = rcEnc->rcGetGLString(rcEnc, glEnum, hostStr, -n);\n+        if (n <= 0) {\n+            delete [] hostStr;\n+            hostStr = NULL;\n+        }\n+    }\n+\n+    //\n+    // keep the string in the context and return its value\n+    //\n+    *strPtr = hostStr;\n+    return hostStr;\n+}\n+\n // ----------------------------------------------------------------------------\n \n // The one and only supported display object.\n static eglDisplay s_display;\n \n static EGLClient_eglInterface s_eglIface = {\n-    getThreadInfo: getEGLThreadInfo\n+    getThreadInfo: getEGLThreadInfo,\n+    getGLString: getGLString\n };\n \n #define DBG_FUNC DBG(\""%s\\n\"", __FUNCTION__)\n@@ -928,6 +1008,9 @@ EGLBoolean eglMakeCurrent(EGLDisplay dpy, EGLSurface draw, EGLSurface read, EGLC\n \tif (tInfo->currentContext)\n \t\ttInfo->currentContext->flags &= ~EGLContext_t::IS_CURRENT;\n \n+\t//Now make current\n+\ttInfo->currentContext = context;\n+\n \t//Check maybe we need to init the encoder, if it's first eglMakeCurrent\n \tif (tInfo->currentContext) {\n \t\tif (!hostCon->glEncoder()->isInitialized()) {\n@@ -941,9 +1024,6 @@ EGLBoolean eglMakeCurrent(EGLDisplay dpy, EGLSurface draw, EGLSurface read, EGLC\n \t\t}\n \t}\n \n-\t//Now make current\n-\ttInfo->currentContext = context;\n-\n \t//connect the color buffer\n \tif (drawSurf)\n \t\tdrawSurf->connect();\n"", ""renderControl.attrib"": ""@@ -12,6 +12,10 @@ rcQueryEGLString\n     dir buffer out\n     len buffer bufferSize\n \n+rcGetGLString\n+    dir buffer out\n+    len buffer bufferSize\n+\n rcGetNumConfigs\n     dir numAttribs out\n     len numAttribs sizeof(uint32_t)\n"", ""renderControl.in"": ""@@ -1,6 +1,7 @@\n GL_ENRTY(GLint, rcGetRendererVersion)\n GL_ENTRY(EGLint, rcGetEGLVersion, EGLint *major, EGLint *minor)\n GL_ENTRY(EGLint, rcQueryEGLString, EGLenum name, void *buffer, EGLint bufferSize)\n+GL_ENTRY(EGLint, rcGetGLString, EGLenum name, void *buffer, EGLint bufferSize)\n GL_ENTRY(EGLint, rcGetNumConfigs, uint32_t *numAttribs)\n GL_ENTRY(EGLint, rcGetConfigs, uint32_t bufSize, GLuint *buffer)\n GL_ENTRY(EGLint, rcChooseConfig, EGLint *attribs, uint32_t attribs_size, uint32_t *configs, uint32_t configs_size)\n""}","feature 
"
21089,Jean-Baptiste Queru,disable prelinking - do not merge,['glib/Android.mk'],"disable prelinking - do not merge

Change-Id: I2b847fcd89046390fe54295f5b8fb2b1c77c2cdd",https://android-review.googlesource.com/c/21089,"bug 
",bug,Deprecat;Resource;,"{""Android.mk"": ""@@ -45,4 +45,6 @@ LOCAL_CFLAGS:= \\\n \n LOCAL_MODULE:=libglib\n \n+LOCAL_PRELINK_MODULE:=false\n+\n include $(BUILD_SHARED_LIBRARY)\n""}","merge 
"
23680,Tor Norbye,"RelativeLayout: Assign ids dynamically, handle multi-drag, bugs","['eclipse/plugins/com.android.ide.eclipse.tests/unittests/com/android/ide/common/layout/LayoutTestBase.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/relative/Match.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/api/Segment.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/relative/MoveHandler.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/relative/ResizeHandler.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/relative/GuidelineHandler.java', 'eclipse/dictionary.txt', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/api/IClientRulesEngine.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/relative/DependencyGraph.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/RelativeLayoutRule.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/relative/GuidelinePainter.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gre/ClientRulesEngine.java']","RelativeLayout: Assign ids dynamically, handle multi-drag, bugs

This CL fixes three issues with the new relative layout interaction:

(1) Assign ids dynamically. Before this changeset you couldn't attach
    to a node which does not have an @id attribute, since layout
    params need to name the constraint by id.

    This changeset changes this such that you can attach to any
    arbitrary edge, and when you commit the drag, a unique id is
    generated on the fly and assigned to the node.

(2) Handle dragging multiple nodes at the same time. The new
    constraints code was unconditionally applying the same constraints
    to all the dragged nodes, which meant they ended up on top of each
    other. This fixes things such that the first node is assigned the
    new constraints, and then all subsequent nodes are attached one
    next to the other, in a direction depending on which edge you
    attached to (e.g. attaching on the right will arrange the siblings
    towards the left out from the edge.)

(3) Fix a bug in the code to detect and prevent cycles.

Change-Id: I157d45e117d3229f285870517b85ed902607b966",https://android-review.googlesource.com/c/23680,"bug, feature
","bug,feature",Bug;,"{""dictionary.txt"": ""@@ -152,6 +152,7 @@ num\n ok\n os\n palette\n+param\n params\n pings\n placeholder\n"", ""IClientRulesEngine.java"": ""@@ -210,5 +210,18 @@ public interface IClientRulesEngine {\n          */\n         String getAttribute(INode node, String namespace, String localName);\n     }\n+\n+    /**\n+     * Given a UI root node and a potential XML node name, returns the first available id\n+     * that matches the pattern \""prefix%d\"".\n+     * <p/>\n+     * TabWidget is a special case and the method will always return \""@android:id/tabs\"".\n+     *\n+     * @param fqcn The fully qualified class name of the view to generate a unique id for\n+     * @return A suitable generated id in the attribute form needed by the XML id tag\n+     *         (e.g. \""@+id/something\"")\n+     */\n+    public String getUniqueId(String fqcn);\n+\n }\n \n"", ""Segment.java"": ""@@ -45,7 +45,10 @@ public class Segment {\n     /** The node that contains this edge */\n     public final INode node;\n \n-    /** The id of the node */\n+    /**\n+     * The id of the node. May be null (in which case id should be generated when\n+     * move/resize is completed\n+     */\n     public final String id;\n \n     public Segment(int at, int from, int to, INode node, String id, SegmentType edgeType,\n"", ""RelativeLayoutRule.java"": ""@@ -187,6 +187,7 @@ public class RelativeLayoutRule extends BaseLayoutRule {\n                 state.removeCycles();\n \n                 // Now write the new elements.\n+                INode previous = null;\n                 for (IDragElement element : elements) {\n                     String fqcn = element.getFqcn();\n \n@@ -202,7 +203,25 @@ public class RelativeLayoutRule extends BaseLayoutRule {\n                     addAttributes(newChild, element, idMap, BaseLayoutRule.DEFAULT_ATTR_FILTER);\n                     addInnerElements(newChild, element, idMap);\n \n-                    state.applyConstraints(newChild);\n+                    if (previous == null) {\n+                        state.applyConstraints(newChild);\n+                        previous = newChild;\n+                    } else {\n+                        // Arrange the nodes next to each other, depending on which\n+                        // edge we are attaching to. For example, if attaching to the\n+                        // top edge, arrange the subsequent nodes in a column below it.\n+                        //\n+                        // TODO: Try to do something smarter here where we detect\n+                        // constraints between the dragged edges, and we preserve these.\n+                        // We have to do this carefully though because if the\n+                        // constraints go through some other nodes not part of the\n+                        // selection, this doesn't work right, and you might be\n+                        // dragging several connected components, which we'd then\n+                        // need to stitch together such that they are all visible.\n+\n+                        state.attachPrevious(previous, newChild);\n+                        previous = newChild;\n+                    }\n                 }\n             }\n         });\n"", ""DependencyGraph.java"": ""@@ -21,8 +21,8 @@ import static com.android.ide.common.layout.LayoutConstants.ATTR_LAYOUT_PREFIX;\n import static com.android.ide.common.layout.LayoutConstants.VALUE_TRUE;\n \n import com.android.ide.common.api.IDragElement;\n-import com.android.ide.common.api.INode;\n import com.android.ide.common.api.IDragElement.IDragAttribute;\n+import com.android.ide.common.api.INode;\n import com.android.ide.common.api.INode.IAttribute;\n import com.android.ide.common.layout.BaseLayoutRule;\n \n@@ -150,8 +150,8 @@ class DependencyGraph {\n      *\n      * @param nodes the set of nodes that we want to compute the transitive dependencies\n      *            for\n-     * @param vertical if true, look for vertical dependencies, otherwise look for\n-     *            horizontal dependencies\n+     * @param vertical if true, look for vertical edge dependencies, otherwise look for\n+     *            horizontal edge dependencies\n      * @return the set of nodes that directly or indirectly depend on the given nodes in\n      *         the given direction\n      */\n"", ""GuidelineHandler.java"": ""@@ -24,6 +24,7 @@ import static com.android.ide.common.api.SegmentType.RIGHT;\n import static com.android.ide.common.api.SegmentType.TOP;\n import static com.android.ide.common.layout.BaseLayoutRule.getMaxMatchDistance;\n import static com.android.ide.common.layout.LayoutConstants.ANDROID_URI;\n+import static com.android.ide.common.layout.LayoutConstants.ATTR_ID;\n import static com.android.ide.common.layout.LayoutConstants.ATTR_LAYOUT_ABOVE;\n import static com.android.ide.common.layout.LayoutConstants.ATTR_LAYOUT_ALIGN_BASELINE;\n import static com.android.ide.common.layout.LayoutConstants.ATTR_LAYOUT_ALIGN_BOTTOM;\n@@ -109,13 +110,15 @@ public class GuidelineHandler {\n \n     /**\n      * The set of nodes which depend on the currently selected nodes, including\n-     * transitively, through horizontal constraints.\n+     * transitively, through horizontal constraints (a \""horizontal constraint\""\n+     * is a constraint between two horizontal edges)\n      */\n     protected Set<INode> mHorizontalDeps;\n \n     /**\n      * The set of nodes which depend on the currently selected nodes, including\n-     * transitively, through vertical constraints.\n+     * transitively, through vertical constraints (a \""vertical constraint\""\n+     * is a constraint between two vertical edges)\n      */\n     protected Set<INode> mVerticalDeps;\n \n@@ -468,7 +471,7 @@ public class GuidelineHandler {\n                 continue;\n             }\n \n-            Match match = new Match(edge, draggedEdge, type, delta);\n+            Match match = new Match(this, edge, draggedEdge, type, delta);\n \n             if (distance < closestDistance) {\n                 closest.clear();\n@@ -492,6 +495,8 @@ public class GuidelineHandler {\n     /**\n      * Given a node, apply the suggestions by expressing them as relative layout param\n      * values\n+     *\n+     * @param n the node to apply constraints to\n      */\n     public void applyConstraints(INode n) {\n         // Process each edge separately\n@@ -548,25 +553,25 @@ public class GuidelineHandler {\n         }\n \n         if (mMoveTop && mCurrentTopMatch != null) {\n-            applyConstraint(n, mCurrentTopMatch.getConstraint());\n+            applyConstraint(n, mCurrentTopMatch.getConstraint(true /* generateId */));\n             if (mCurrentTopMatch.type == ALIGN_BASELINE) {\n                 // HACK! WORKAROUND! Baseline doesn't provide a new bottom edge for attachments\n-                String c = mCurrentTopMatch.getConstraint();\n+                String c = mCurrentTopMatch.getConstraint(true);\n                 c = c.replace(ATTR_LAYOUT_ALIGN_BASELINE, ATTR_LAYOUT_ALIGN_BOTTOM);\n                 applyConstraint(n, c);\n             }\n         }\n \n         if (mMoveBottom && mCurrentBottomMatch != null) {\n-            applyConstraint(n, mCurrentBottomMatch.getConstraint());\n+            applyConstraint(n, mCurrentBottomMatch.getConstraint(true));\n         }\n \n         if (mMoveLeft && mCurrentLeftMatch != null) {\n-            applyConstraint(n, mCurrentLeftMatch.getConstraint());\n+            applyConstraint(n, mCurrentLeftMatch.getConstraint(true));\n         }\n \n         if (mMoveRight && mCurrentRightMatch != null) {\n-            applyConstraint(n, mCurrentRightMatch.getConstraint());\n+            applyConstraint(n, mCurrentRightMatch.getConstraint(true));\n         }\n \n         if (mMoveLeft) {\n@@ -588,7 +593,6 @@ public class GuidelineHandler {\n         String name = constraint.substring(0, constraint.indexOf('='));\n         String value = constraint.substring(constraint.indexOf('=') + 1);\n         n.setAttribute(ANDROID_URI, name, value);\n-\n     }\n \n     private void applyMargin(INode n, String marginAttribute, int margin) {\n@@ -601,6 +605,58 @@ public class GuidelineHandler {\n         }\n     }\n \n+    private void removeRelativeParams(INode node) {\n+        for (ConstraintType type : ConstraintType.values()) {\n+            node.setAttribute(ANDROID_URI, type.name, null);\n+        }\n+        node.setAttribute(ANDROID_URI,ATTR_LAYOUT_MARGIN_LEFT, null);\n+        node.setAttribute(ANDROID_URI,ATTR_LAYOUT_MARGIN_RIGHT, null);\n+        node.setAttribute(ANDROID_URI,ATTR_LAYOUT_MARGIN_TOP, null);\n+        node.setAttribute(ANDROID_URI,ATTR_LAYOUT_MARGIN_BOTTOM, null);\n+    }\n+\n+    /**\n+     * Attach the new child to the previous node\n+     * @param previous the previous child\n+     * @param node the new child to attach it to\n+     */\n+    public void attachPrevious(INode previous, INode node) {\n+        removeRelativeParams(node);\n+\n+        String id = previous.getStringAttr(ANDROID_URI, ATTR_ID);\n+        if (id == null) {\n+            return;\n+        }\n+\n+        if (mCurrentTopMatch != null || mCurrentBottomMatch != null) {\n+            // Attaching the top: arrange below, and for bottom arrange above\n+            node.setAttribute(ANDROID_URI,\n+                    mCurrentTopMatch != null ? ATTR_LAYOUT_BELOW : ATTR_LAYOUT_ABOVE, id);\n+            // Apply same left/right constraints as the parent\n+            if (mCurrentLeftMatch != null) {\n+                applyConstraint(node, mCurrentLeftMatch.getConstraint(true));\n+                applyMargin(node, ATTR_LAYOUT_MARGIN_LEFT, mLeftMargin);\n+            } else if (mCurrentRightMatch != null) {\n+                applyConstraint(node, mCurrentRightMatch.getConstraint(true));\n+                applyMargin(node, ATTR_LAYOUT_MARGIN_RIGHT, mRightMargin);\n+            }\n+        } else if (mCurrentLeftMatch != null || mCurrentRightMatch != null) {\n+            node.setAttribute(ANDROID_URI,\n+                    mCurrentLeftMatch != null ? ATTR_LAYOUT_TO_RIGHT_OF : ATTR_LAYOUT_TO_LEFT_OF,\n+                            id);\n+            // Apply same top/bottom constraints as the parent\n+            if (mCurrentTopMatch != null) {\n+                applyConstraint(node, mCurrentTopMatch.getConstraint(true));\n+                applyMargin(node, ATTR_LAYOUT_MARGIN_TOP, mTopMargin);\n+            } else if (mCurrentBottomMatch != null) {\n+                applyConstraint(node, mCurrentBottomMatch.getConstraint(true));\n+                applyMargin(node, ATTR_LAYOUT_MARGIN_BOTTOM, mBottomMargin);\n+            }\n+        } else {\n+            return;\n+        }\n+    }\n+\n     public void removeCycles() {\n         if (mHorizontalCycle != null) {\n             removeCycles(mHorizontalDeps);\n@@ -762,4 +818,13 @@ public class GuidelineHandler {\n             return 0;\n         }\n     }\n+\n+    /**\n+     * Returns the {@link IClientRulesEngine} IDE callback\n+     *\n+     * @return the {@link IClientRulesEngine} IDE callback, never null\n+     */\n+    public IClientRulesEngine getRulesEngine() {\n+        return mRulesEngine;\n+    }\n }\n\\ No newline at end of file\n"", ""GuidelinePainter.java"": ""@@ -130,7 +130,7 @@ public final class GuidelinePainter implements IFeedbackPainter {\n         // Display the constraint. Remove the @id/ and @+id/ prefixes to make the text\n         // shorter and easier to read. This doesn't use stripPrefix() because the id is\n         // usually not a prefix of the value (for example, 'layout_alignBottom=@+id/foo').\n-        String constraint = m.getConstraint();\n+        String constraint = m.getConstraint(false /* generateId */);\n         String description = constraint.replace(NEW_ID_PREFIX, \""\"").replace(ID_PREFIX, \""\"");\n         if (description.startsWith(ATTR_LAYOUT_PREFIX)) {\n             description = description.substring(ATTR_LAYOUT_PREFIX.length());\n"", ""Match.java"": ""@@ -15,6 +15,8 @@\n  */\n package com.android.ide.common.layout.relative;\n \n+import static com.android.ide.common.layout.LayoutConstants.ANDROID_URI;\n+import static com.android.ide.common.layout.LayoutConstants.ATTR_ID;\n import static com.android.ide.common.layout.LayoutConstants.VALUE_TRUE;\n \n import com.android.ide.common.api.Segment;\n@@ -36,15 +38,22 @@ class Match {\n     /** whether this {@link Match} results in a cycle */\n     public boolean cycle;\n \n+    /** The associated {@link GuidelineHander} which performed the match */\n+    private final GuidelineHandler mHandler;\n+\n     /**\n      * Create a new match.\n      *\n+     * @param handler the handler which performed the match\n      * @param edge the \""other\"" edge that the dragged edge is matched with\n      * @param with the edge of the dragged node that is matched\n      * @param type the type of constraint this is a match for\n      * @param delta the signed distance between the matched edges\n      */\n-    public Match(Segment edge, Segment with, ConstraintType type, int delta) {\n+    public Match(GuidelineHandler handler, Segment edge, Segment with,\n+            ConstraintType type, int delta) {\n+        mHandler = handler;\n+\n         this.edge = edge;\n         this.with = with;\n         this.type = type;\n@@ -54,13 +63,29 @@ class Match {\n     /**\n      * Returns the XML constraint attribute value for this match\n      *\n+     * @param generateId whether an id should be generated if one is missing\n      * @return the XML constraint attribute value for this match\n      */\n-    public String getConstraint() {\n+    public String getConstraint(boolean generateId) {\n         if (type.targetParent) {\n             return type.name + '=' + VALUE_TRUE;\n         } else {\n             String id = edge.id;\n+            if (id == null || id.length() == -1) {\n+                if (!generateId) {\n+                    // Placeholder to display for the user during dragging\n+                    id = \""<generated>\"";\n+                } else {\n+                    // Must generate an id on the fly!\n+                    // See if it's been set by a different constraint we've already applied\n+                    // to this same node\n+                    id = edge.node.getStringAttr(ANDROID_URI, ATTR_ID);\n+                    if (id == null || id.length() == 0) {\n+                        id = mHandler.getRulesEngine().getUniqueId(edge.node.getFqcn());\n+                        edge.node.setAttribute(ANDROID_URI, ATTR_ID, id);\n+                    }\n+                }\n+            }\n             return type.name + '=' + id;\n         }\n     }\n"", ""MoveHandler.java"": ""@@ -63,8 +63,8 @@ public class MoveHandler extends GuidelineHandler {\n         }\n         mDraggedNodes = nodes;\n \n-        mHorizontalDeps = mDependencyGraph.dependsOn(nodes, false /* vertical */);\n-        mVerticalDeps = mDependencyGraph.dependsOn(nodes, true /* vertical */);\n+        mHorizontalDeps = mDependencyGraph.dependsOn(nodes, false /* verticalEdge */);\n+        mVerticalDeps = mDependencyGraph.dependsOn(nodes, true /* verticalEdge */);\n \n         for (INode child : layout.getChildren()) {\n             Rect bc = child.getBounds();\n@@ -81,12 +81,9 @@ public class MoveHandler extends GuidelineHandler {\n                 }\n \n                 if (!isDragged) {\n-                    // Need an id to reference child in attachments to it, so skip\n-                    // nodes without ids\n                     String id = child.getStringAttr(ANDROID_URI, ATTR_ID);\n-                    if (id == null) {\n-                        continue;\n-                    }\n+                    // It's okay for id to be null; if you apply a constraint\n+                    // to a node with a missing id we will generate the id\n \n                     boolean addHorizontal = !mHorizontalDeps.contains(child);\n                     boolean addVertical = !mVerticalDeps.contains(child);\n@@ -233,7 +230,7 @@ public class MoveHandler extends GuidelineHandler {\n \n         Match match = pickBestMatch(mHorizontalSuggestions);\n         if (match != null) {\n-            if (mVerticalDeps.contains(match.edge.node)) {\n+            if (mHorizontalDeps.contains(match.edge.node)) {\n                 match.cycle = true;\n             }\n \n@@ -259,7 +256,7 @@ public class MoveHandler extends GuidelineHandler {\n \n         match = pickBestMatch(mVerticalSuggestions);\n         if (match != null) {\n-            if (mHorizontalDeps.contains(match.edge.node)) {\n+            if (mVerticalDeps.contains(match.edge.node)) {\n                 match.cycle = true;\n             }\n \n"", ""ResizeHandler.java"": ""@@ -84,14 +84,7 @@ public class ResizeHandler extends GuidelineHandler {\n \n         for (INode child : layout.getChildren()) {\n             if (child != resized) {\n-                // Need an id to reference child in attachments to it, so skip nodes\n-                // without ids\n-                // TODO: Generate an id on the fly when needed (at commit time) instead!\n                 String id = child.getStringAttr(ANDROID_URI, ATTR_ID);\n-                if (id == null) {\n-                    continue;\n-                }\n-\n                 addBounds(child, id,\n                         !mHorizontalDeps.contains(child),\n                         !mVerticalDeps.contains(child));\n@@ -208,7 +201,7 @@ public class ResizeHandler extends GuidelineHandler {\n             Match match = pickBestMatch(mHorizontalSuggestions);\n             if (match != null\n                     && (!mSnap || Math.abs(match.delta) < BaseLayoutRule.getMaxMatchDistance())) {\n-                if (mVerticalDeps.contains(match.edge.node)) {\n+                if (mHorizontalDeps.contains(match.edge.node)) {\n                     match.cycle = true;\n                 }\n \n@@ -232,7 +225,7 @@ public class ResizeHandler extends GuidelineHandler {\n             Match match = pickBestMatch(mVerticalSuggestions);\n             if (match != null\n                     && (!mSnap || Math.abs(match.delta) < BaseLayoutRule.getMaxMatchDistance())) {\n-                if (mHorizontalDeps.contains(match.edge.node)) {\n+                if (mVerticalDeps.contains(match.edge.node)) {\n                     match.cycle = true;\n                 }\n \n"", ""ClientRulesEngine.java"": ""@@ -29,21 +29,23 @@ import com.android.ide.common.resources.ResourceRepository;\n import com.android.ide.eclipse.adt.AdtPlugin;\n import com.android.ide.eclipse.adt.internal.actions.AddCompatibilityJarAction;\n import com.android.ide.eclipse.adt.internal.editors.AndroidXmlEditor;\n+import com.android.ide.eclipse.adt.internal.editors.descriptors.DescriptorsUtils;\n import com.android.ide.eclipse.adt.internal.editors.layout.configuration.ConfigurationComposite;\n import com.android.ide.eclipse.adt.internal.editors.layout.gle2.GraphicalEditorPart;\n import com.android.ide.eclipse.adt.internal.editors.layout.gle2.LayoutCanvas;\n import com.android.ide.eclipse.adt.internal.editors.layout.gle2.RenderService;\n import com.android.ide.eclipse.adt.internal.editors.layout.gle2.SelectionManager;\n import com.android.ide.eclipse.adt.internal.editors.manifest.ManifestInfo;\n+import com.android.ide.eclipse.adt.internal.editors.uimodel.UiDocumentNode;\n import com.android.ide.eclipse.adt.internal.project.BaseProjectHelper;\n import com.android.ide.eclipse.adt.internal.resources.CyclicDependencyValidator;\n import com.android.ide.eclipse.adt.internal.resources.manager.ResourceManager;\n import com.android.ide.eclipse.adt.internal.sdk.AndroidTargetData;\n import com.android.ide.eclipse.adt.internal.sdk.Sdk;\n import com.android.ide.eclipse.adt.internal.ui.MarginChooser;\n-import com.android.ide.eclipse.adt.internal.ui.ResourcePreviewHelper;\n import com.android.ide.eclipse.adt.internal.ui.ReferenceChooserDialog;\n import com.android.ide.eclipse.adt.internal.ui.ResourceChooser;\n+import com.android.ide.eclipse.adt.internal.ui.ResourcePreviewHelper;\n import com.android.resources.ResourceType;\n import com.android.sdklib.IAndroidTarget;\n \n@@ -481,4 +483,10 @@ class ClientRulesEngine implements IClientRulesEngine {\n         }\n     }\n \n+    public String getUniqueId(String fqcn) {\n+        UiDocumentNode root = mRulesEngine.getEditor().getModel();\n+        String prefix = fqcn.substring(fqcn.lastIndexOf('.') + 1);\n+        prefix = Character.toLowerCase(prefix.charAt(0)) + prefix.substring(1);\n+        return DescriptorsUtils.getFreeWidgetId(root, prefix);\n+    }\n }\n\\ No newline at end of file\n"", ""LayoutTestBase.java"": ""@@ -276,6 +276,11 @@ public class LayoutTestBase extends TestCase {\n             fail(\""Not supported in tests yet\"");\n             return px;\n         }\n+\n+        public String getUniqueId(String prefix) {\n+            fail(\""Not supported in tests yet\"");\n+            return null;\n+        }\n     }\n \n     public void testDummy() {\n""}","bug, feature 
"
21793,David Turner,Fix write of disk sizes in ini files.,['android/utils/ini.c'],"Fix write of disk sizes in ini files.

The old implementation always expressed the size as multiples of kilobytes
due to an improper order to size checks. For example, 66MB was written as
'67584k' instead of '66m', which is correct but sub-optimal.

Change-Id: I6365bf4c269ed7d213043182a8ae501713798b8f",https://android-review.googlesource.com/c/21793,"bug
",bug,Bug;Feature;,"{""ini.c"": ""@@ -480,19 +480,22 @@ iniFile_setDiskSize( IniFile* f, const char* key, int64_t size )\n {\n     char     temp[32];\n     int64_t  divisor = 0;\n+    const int64_t  kilo = 1024;\n+    const int64_t  mega = 1024*kilo;\n+    const int64_t  giga = 1024*mega;\n     char     suffix = '\\0';\n \n-    if (size >= 0) {\n-        if (!(size % 1024)) {\n-            suffix = 'k';\n-            divisor = 1024;\n-        } else if (!(size % 1024*1024)) {\n-            divisor = 1024*1024;\n-            suffix  = 'm';\n-        } else if (!(size % 1024*1024*1024LL)) {\n-            divisor = 1024*1024*1024;\n-            suffix = 'g';\n-        }\n+    if (size >= giga && !(size % giga)) {\n+        divisor = giga;\n+        suffix = 'g';\n+    }\n+    else if (size >= mega && !(size % mega)) {\n+        divisor = mega;\n+        suffix  = 'm';\n+    }\n+    else if (size >= kilo && !(size % kilo)) {\n+        divisor = kilo;\n+        suffix = 'k';\n     }\n     if (divisor) {\n         snprintf(temp, sizeof temp, \""%\"" PRId64 \""%c\"", size/divisor, suffix);\n""}","bug, refactor 
"
14121,Johan Redestig,Corrected thread problem causing some calls to hang for 25s,"['dbus/dbus-connection.c', 'dbus/dbus-connection-internal.h']","Corrected thread problem causing some calls to hang for 25s

Since the connection lock is released for a short while in
_dbus_connection_acquire_io_path there can already be a method return
received by another thread. The fix is to do an extra check after the
I/O path has been aquired both.

Change-Id: I9b285f71a08cde349ac0c32081e6d4d5bc0bb13b",https://android-review.googlesource.com/c/14121,"bug
",bug,Bug;,"{""dbus-connection-internal.h"": ""@@ -75,6 +75,7 @@ void              _dbus_connection_toggle_timeout_unlocked     (DBusConnection\n                                                                 dbus_bool_t         enabled);\n DBusConnection*   _dbus_connection_new_for_transport           (DBusTransport      *transport);\n void              _dbus_connection_do_iteration_unlocked       (DBusConnection     *connection,\n+                                                                DBusPendingCall *pending,\n                                                                 unsigned int        flags,\n                                                                 int                 timeout_milliseconds);\n void              _dbus_connection_close_possibly_shared       (DBusConnection     *connection);\n"", ""dbus-connection.c"": ""@@ -316,6 +316,7 @@ static void               _dbus_connection_release_dispatch                  (DB\n static DBusDispatchStatus _dbus_connection_flush_unlocked                    (DBusConnection     *connection);\n static void               _dbus_connection_close_possibly_shared_and_unlock  (DBusConnection     *connection);\n static dbus_bool_t        _dbus_connection_get_is_connected_unlocked         (DBusConnection     *connection);\n+static dbus_bool_t         peek_for_reply_unlocked                           (DBusConnection *connection, dbus_uint32_t  client_serial);\n \n static DBusMessageFilter *\n _dbus_message_filter_ref (DBusMessageFilter *filter)\n@@ -1113,14 +1114,22 @@ _dbus_connection_release_io_path (DBusConnection *connection)\n  * you specify DBUS_ITERATION_BLOCK; in that case the function\n  * returns immediately.\n  *\n+ * If pending is not NULL then a check is made if the pending call\n+ * is completed after the io path has been required. If the call\n+ * has been completed nothing is done. This must be done since\n+ * the _dbus_connection_acquire_io_path releases the connection\n+ * lock for a while.\n+ *\n  * Called with connection lock held.\n  * \n  * @param connection the connection.\n+ * @param pending the pending call that should be checked or NULL\n  * @param flags iteration flags.\n  * @param timeout_milliseconds maximum blocking time, or -1 for no limit.\n  */\n void\n _dbus_connection_do_iteration_unlocked (DBusConnection *connection,\n+                                        DBusPendingCall *pending,\n                                         unsigned int    flags,\n                                         int             timeout_milliseconds)\n {\n@@ -1136,8 +1145,20 @@ _dbus_connection_do_iteration_unlocked (DBusConnection *connection,\n     {\n       HAVE_LOCK_CHECK (connection);\n       \n-      _dbus_transport_do_iteration (connection->transport,\n-\t\t\t\t    flags, timeout_milliseconds);\n+      if ( (pending != NULL) && _dbus_pending_call_get_completed_unlocked(pending))\n+      {\n+        _dbus_verbose (\""pending call completed while acquiring I/O path\"");\n+      }\n+      else if ( (pending != NULL) && peek_for_reply_unlocked(connection, _dbus_pending_call_get_reply_serial_unlocked(pending)))\n+      {\n+        _dbus_verbose (\""pending call completed while acquiring I/O path (reply found in queue)\"");\n+      }\n+      else\n+      {\n+        _dbus_transport_do_iteration (connection->transport,\n+                                      flags, timeout_milliseconds);\n+      }\n+\n       _dbus_connection_release_io_path (connection);\n     }\n \n@@ -1923,6 +1944,7 @@ _dbus_connection_send_preallocated_unlocked_no_update (DBusConnection       *con\n    * out immediately, and otherwise get them queued up\n    */\n   _dbus_connection_do_iteration_unlocked (connection,\n+                                          NULL,\n                                           DBUS_ITERATION_DO_WRITING,\n                                           -1);\n \n@@ -2091,6 +2113,31 @@ generate_local_error_message (dbus_uint32_t serial,\n   return message;\n }\n \n+/*\n+ * Peek the incoming queue to see if we got reply for a specific serial\n+ */\n+static dbus_bool_t\n+peek_for_reply_unlocked (DBusConnection *connection,\n+                         dbus_uint32_t  client_serial)\n+{\n+  DBusList *link;\n+  HAVE_LOCK_CHECK (connection);\n+\n+  link = _dbus_list_get_first_link (&connection->incoming_messages);\n+\n+  while (link != NULL)\n+  {\n+    DBusMessage *reply = link->data;\n+\n+    if (dbus_message_get_reply_serial (reply) == client_serial)\n+    {\n+      _dbus_verbose (\""%s reply to %d found in queue\\n\"", _DBUS_FUNCTION_NAME, client_serial);\n+      return TRUE;\n+    }\n+    link = _dbus_list_get_next_link (&connection->incoming_messages, link);\n+  }\n+  return FALSE;\n+}\n \n /* This is slightly strange since we can pop a message here without\n  * the dispatch lock.\n@@ -2261,6 +2308,7 @@ _dbus_connection_block_pending_call (DBusPendingCall *pending)\n   /* Now we wait... */\n   /* always block at least once as we know we don't have the reply yet */\n   _dbus_connection_do_iteration_unlocked (connection,\n+                                          pending,\n                                           DBUS_ITERATION_DO_READING |\n                                           DBUS_ITERATION_BLOCK,\n                                           timeout_milliseconds);\n@@ -2332,6 +2380,7 @@ _dbus_connection_block_pending_call (DBusPendingCall *pending)\n         {          \n           /* block again, we don't have the reply buffered yet. */\n           _dbus_connection_do_iteration_unlocked (connection,\n+                                                  pending,\n                                                   DBUS_ITERATION_DO_READING |\n                                                   DBUS_ITERATION_BLOCK,\n                                                   timeout_milliseconds);\n@@ -3228,6 +3277,7 @@ _dbus_connection_flush_unlocked (DBusConnection *connection)\n       _dbus_verbose (\""doing iteration in %s\\n\"", _DBUS_FUNCTION_NAME);\n       HAVE_LOCK_CHECK (connection);\n       _dbus_connection_do_iteration_unlocked (connection,\n+                                              NULL,\n                                               DBUS_ITERATION_DO_READING |\n                                               DBUS_ITERATION_DO_WRITING |\n                                               DBUS_ITERATION_BLOCK,\n@@ -3309,6 +3359,7 @@ _dbus_connection_read_write_dispatch (DBusConnection *connection,\n         {\n           _dbus_verbose (\""doing iteration in %s\\n\"", _DBUS_FUNCTION_NAME);\n           _dbus_connection_do_iteration_unlocked (connection,\n+                                                  NULL,\n                                                   DBUS_ITERATION_DO_READING |\n                                                   DBUS_ITERATION_DO_WRITING |\n                                                   DBUS_ITERATION_BLOCK,\n""}","bug 
"
15584,Bruce Beare,Update to latest (froyo) init.rc,['target/board/generic_x86/init.rc'],"Update to latest (froyo) init.rc

Change-Id: Ibbf5427261dbb84cdc28c6de931e65c8cac547a6
Signed-off-by: Bruce Beare <brucex.j.beare@intel.com>",https://android-review.googlesource.com/c/15584,"resource
",resource,Test;,"{""init.rc"": ""@@ -12,58 +12,138 @@ loglevel 3\n     export ANDROID_ROOT /system\n     export ANDROID_ASSETS /system/app\n     export ANDROID_DATA /data\n-    export EXTERNAL_STORAGE /sdcard\n+    export EXTERNAL_STORAGE /mnt/sdcard\n+    export ASEC_MOUNTPOINT /mnt/asec\n     export BOOTCLASSPATH /system/framework/core.jar:/system/framework/ext.jar:/system/framework/framework.jar:/system/framework/android.policy.jar:/system/framework/services.jar\n \n # Backward compatibility\n     symlink /system/etc /etc\n+    symlink /sys/kernel/debug /d\n+\n+# create mountpoints\n+    mkdir /mnt 0775 root system\n+    mkdir /mnt/sdcard 0000 system system\n+\n+# Create cgroup mount point for cpu accounting\n+    mkdir /acct\n+    mount cgroup none /acct cpuacct\n+    mkdir /acct/uid\n+\n+# Backwards Compat - XXX: Going away in G*\n+    symlink /mnt/sdcard /sdcard\n \n-# create mountpoints and mount tmpfs on sqlite_stmt_journals and debugfs on d\n-    mkdir /d\n-    mkdir /sdcard 0000 system system\n     mkdir /system\n     mkdir /data 0771 system system\n     mkdir /cache 0770 system cache\n-    mkdir /sqlite_stmt_journals 01777 root root\n-    mount tmpfs tmpfs /sqlite_stmt_journals\n-    mount debugfs debugfs /d\n+    mkdir /config 0500 root root\n+\n+    # Directory for putting things only root should see.\n+    mkdir /mnt/secure 0700 root root\n+\n+    # Directory for staging bindmounts\n+    mkdir /mnt/secure/staging 0700 root root\n \n-    mount rootfs rootfs / rw remount\n+    # Directory-target for where the secure container\n+    # imagefile directory will be bind-mounted\n+    mkdir /mnt/secure/asec  0700 root root\n+\n+    # Secure container public mount points.\n+    mkdir /mnt/asec  0700 root system\n+    mount tmpfs tmpfs /mnt/asec mode=0755,gid=1000\n+\n+    mount rootfs rootfs / ro remount\n \n     write /proc/sys/kernel/panic_on_oops 1\n     write /proc/sys/kernel/hung_task_timeout_secs 0\n     write /proc/cpu/alignment 4\n     write /proc/sys/kernel/sched_latency_ns 10000000\n     write /proc/sys/kernel/sched_wakeup_granularity_ns 2000000\n+    write /proc/sys/kernel/sched_compat_yield 1\n+    write /proc/sys/kernel/sched_child_runs_first 0\n+\n+# Create cgroup mount points for process groups\n+    mkdir /dev/cpuctl\n+    mount cgroup none /dev/cpuctl cpu\n+    chown system system /dev/cpuctl\n+    chown system system /dev/cpuctl/tasks\n+    chmod 0777 /dev/cpuctl/tasks\n+    write /dev/cpuctl/cpu.shares 1024\n+\n+    mkdir /dev/cpuctl/fg_boost\n+    chown system system /dev/cpuctl/fg_boost/tasks\n+    chmod 0777 /dev/cpuctl/fg_boost/tasks\n+    write /dev/cpuctl/fg_boost/cpu.shares 1024\n+\n+    mkdir /dev/cpuctl/bg_non_interactive\n+    chown system system /dev/cpuctl/bg_non_interactive/tasks\n+    chmod 0777 /dev/cpuctl/bg_non_interactive/tasks\n+    # 5.0 %\n+    write /dev/cpuctl/bg_non_interactive/cpu.shares 52\n \n # mount mtd partitions\n     # Hack...\n     #   We'll attempt to mount both as sdcard and harddisk...\n     #   Only one or the other will actually work... this way, we can\n     #   use the same init.rc for both\n-    mount ext3 /dev/block/mmcblk0p6 /system\n-    mount ext3 /dev/block/mmcblk0p6 /system rw remount\n-    mount ext3 /dev/block/mmcblk0p2 /data nosuid nodev\n-    mount ext3 /dev/block/mmcblk0p7 /cache nosuid nodev\n-    mount ext3 /dev/block/sda6 /system\n-    mount ext3 /dev/block/sda6 /system rw remount\n+    # Mount /system rw first to give the filesystem a chance to save a checkpoint\n+    mount ext3 /dev/block/sda6 /system rw\n+    mount ext3 /dev/block/sda6 /system ro remount\n     mount ext3 /dev/block/sda8 /data\n+    mount ext3 /dev/block/sda7 /cache nosuid nodev\n \n     # We chown/chmod /data again so because mount is run as root + defaults\n     chown system system /data\n     chmod 0771 /data\n \n+    # Create dump dir and collect dumps.\n+    # Do this before we mount cache so eventually we can use cache for\n+    # storing dumps on platforms which do not have a dedicated dump partition.\n+   \n+    mkdir /data/dontpanic\n+    chown root log /data/dontpanic\n+    chmod 0750 /data/dontpanic\n+\n+    # Collect apanic data, free resources and re-arm trigger\n+    copy /proc/apanic_console /data/dontpanic/apanic_console\n+    chown root log /data/dontpanic/apanic_console\n+    chmod 0640 /data/dontpanic/apanic_console\n+\n+    copy /proc/apanic_threads /data/dontpanic/apanic_threads\n+    chown root log /data/dontpanic/apanic_threads\n+    chmod 0640 /data/dontpanic/apanic_threads\n+\n+    write /proc/apanic_console 1\n+\n     # Same reason as /data above\n     chown system cache /cache\n     chmod 0770 /cache\n \n     # This may have been created by the recovery system with odd permissions\n-    chown system system /cache/recovery\n+    chown system cache /cache/recovery\n     chmod 0770 /cache/recovery\n \n+    #change permissions on vmallocinfo so we can grab it from bugreports\n+    chown root log /proc/vmallocinfo\n+    chmod 0440 /proc/vmallocinfo\n+\n+    #change permissions on kmsg & sysrq-trigger so bugreports can grab kthread stacks\n+    chown root system /proc/kmsg\n+    chmod 0440 /proc/kmsg\n+    chown root system /proc/sysrq-trigger\n+    chmod 0220 /proc/sysrq-trigger\n+\n # create basic filesystem structure\n     mkdir /data/misc 01771 system misc\n-    mkdir /data/misc/hcid 0770 bluetooth bluetooth\n+    mkdir /data/misc/bluetoothd 0770 bluetooth bluetooth\n+    mkdir /data/misc/bluetooth 0770 system system\n+    mkdir /data/misc/keystore 0700 keystore keystore\n+    mkdir /data/misc/vpn 0770 system system\n+    mkdir /data/misc/systemkeys 0700 system system\n+    mkdir /data/misc/vpn/profiles 0770 system system\n+    # give system access to wpa_supplicant.conf for backup and restore\n+    mkdir /data/misc/wifi 0770 wifi wifi\n+    chmod 0770 /data/misc/wifi\n+    chmod 0660 /data/misc/wifi/wpa_supplicant.conf\n     mkdir /data/local 0771 shell shell\n     mkdir /data/local/tmp 0771 shell shell\n     mkdir /data/data 0771 system system\n@@ -77,7 +157,6 @@ loglevel 3\n     chmod 0771 /data/dalvik-cache\n \n     # create the lost+found directories, so as to enforce our permissions\n-    mkdir /system/lost+found 0770\n     mkdir /data/lost+found 0770\n     mkdir /cache/lost+found 0770\n \n@@ -88,32 +167,24 @@ loglevel 3\n     chmod 0770 /cache/lost+found\n \n on boot\n-\n-### Load some modules\n-\n # basic network init\n     ifup lo\n     hostname localhost\n     domainname localdomain\n \n-\n # set RLIMIT_NICE to allow priorities from 19 to -20\n     setrlimit 13 40 40\n-    mkdir /data/core 0777\n-    write /proc/sys/kernel/core_pattern /data/core/%e.%p\n-    setrlimit 4 -1 -1\n \n # Define the oom_adj values for the classes of processes that can be\n # killed by the kernel.  These are used in ActivityManagerService.\n     setprop ro.FOREGROUND_APP_ADJ 0\n     setprop ro.VISIBLE_APP_ADJ 1\n     setprop ro.SECONDARY_SERVER_ADJ 2\n+    setprop ro.BACKUP_APP_ADJ 2\n+    setprop ro.HOME_APP_ADJ 4\n     setprop ro.HIDDEN_APP_MIN_ADJ 7\n     setprop ro.CONTENT_PROVIDER_ADJ 14\n     setprop ro.EMPTY_APP_ADJ 15\n-    setprop ro.BACKUP_APP_ADJ 2\n-    setprop ro.HOME_APP_ADJ 4\n-\n \n # Define the memory thresholds at which the above process classes will\n # be killed.  These numbers are in pages (4k).\n@@ -126,16 +197,22 @@ on boot\n     setprop ro.CONTENT_PROVIDER_MEM 5632\n     setprop ro.EMPTY_APP_MEM 6144\n \n-\n # Write value must be consistent with the above properties.\n+# Note that the driver only supports 6 slots, so we have HOME_APP at the\n+# same memory level as services.\n     write /sys/module/lowmemorykiller/parameters/adj 0,1,2,7,14,15\n \n     write /proc/sys/vm/overcommit_memory 1\n-    write /sys/module/lowmemorykiller/parameters/minfree 1536,2048,4096,8192,16384\n+    write /proc/sys/vm/min_free_order_shift 4\n+    write /sys/module/lowmemorykiller/parameters/minfree 1536,2048,4096,5120,5632,6144\n \n     # Set init its forked children's oom_adj.\n     write /proc/1/oom_adj -16\n \n+    # Tweak background writeout\n+    write /proc/sys/vm/dirty_expire_centisecs 200\n+    write /proc/sys/vm/dirty_background_ratio  5\n+\n     # Permissions for System Server and daemons.\n     chown radio system /sys/android_power/state\n     chown radio system /sys/android_power/request_state\n@@ -148,11 +225,11 @@ on boot\n     chmod 0660 /sys/power/state\n     chmod 0660 /sys/power/wake_lock\n     chmod 0660 /sys/power/wake_unlock\n-\n     chown system system /sys/class/timed_output/vibrator/enable\n     chown system system /sys/class/leds/keyboard-backlight/brightness\n     chown system system /sys/class/leds/lcd-backlight/brightness\n     chown system system /sys/class/leds/button-backlight/brightness\n+    chown system system /sys/class/leds/jogball-backlight/brightness\n     chown system system /sys/class/leds/red/brightness\n     chown system system /sys/class/leds/green/brightness\n     chown system system /sys/class/leds/blue/brightness\n@@ -166,10 +243,7 @@ on boot\n     chown system system /sys/class/leds/red/device/grppwm\n     chown system system /sys/class/leds/red/device/blink\n     chown system system /sys/class/timed_output/vibrator/enable\n-    chown bluetooth bluetooth /sys/module/board_trout/parameters/bluetooth_power_on\n     chown system system /sys/module/sco/parameters/disable_esco\n-    chmod 0660 /sys/module/board_trout/parameters/bluetooth_power_on\n-    chown radio audio /system/etc/AudioPara4.csv\n     chown system system /sys/kernel/ipv4/tcp_wmem_min\n     chown system system /sys/kernel/ipv4/tcp_wmem_def\n     chown system system /sys/kernel/ipv4/tcp_wmem_max\n@@ -178,9 +252,6 @@ on boot\n     chown system system /sys/kernel/ipv4/tcp_rmem_max\n     chown root radio /proc/cmdline\n \n-# Enable audio based on existing /dev/dsp\n-    chmod 0666 /dev/snd/dsp\n-\n # Define TCP buffer sizes for various networks\n #   ReadMin, ReadInitial, ReadMax, WriteMin, WriteInitial, WriteMax,\n     setprop net.tcp.buffersize.default 4096,87380,110208,4096,16384,110208\n@@ -191,7 +262,6 @@ on boot\n \n     class_start default\n \n-\n ## Daemon processes to be run by init.\n ##\n service console /system/bin/sh\n@@ -199,16 +269,12 @@ service console /system/bin/sh\n \n # adbd is controlled by the persist.service.adb.enable system property\n service adbd /sbin/adbd\n-#    disabled\n+    disabled\n \n # adbd on at boot in emulator\n on property:ro.kernel.qemu=1\n     start adbd\n \n-# adbd on at boot in insecure builds\n-on property:ro.secure=0\n-    start adbd\n-\n on property:persist.service.adb.enable=1\n     start adbd\n \n@@ -223,32 +289,104 @@ service servicemanager /system/bin/servicemanager\n \n service vold /system/bin/vold\n     socket vold stream 0660 root mount\n+    ioprio be 2\n+\n+service netd /system/bin/netd\n+    socket netd stream 0660 root system\n+\n+service debuggerd /system/bin/debuggerd\n+\n+service ril-daemon /system/bin/rild\n+    socket rild stream 660 root radio\n+    socket rild-debug stream 660 radio system\n+    user root\n+    group radio cache inet misc audio\n+\n+service rcpvr /system/bin/sh /system/etc/rc.pvr start\n+    oneshot\n \n+# service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server\n service zygote /system/bin/app_process -Xzygote -Xint:fast /system/bin --zygote --start-system-server\n     socket zygote stream 666\n+    write /sys/power/wake_lock always_on\n     onrestart write /sys/android_power/request_state wake\n+    onrestart write /sys/power/state on\n+    onrestart restart media\n \n service media /system/bin/mediaserver\n     user media\n-    group system audio camera graphics inet net_bt net_bt_admin\n+    group system audio camera graphics inet net_bt net_bt_admin net_raw\n+    ioprio rt 4\n+\n+service bootanim /system/bin/bootanimation\n+    user graphics\n+    group graphics\n+    disabled\n+    oneshot\n \n service dbus /system/bin/dbus-daemon --system --nofork\n     socket dbus stream 660 bluetooth bluetooth\n     user bluetooth\n     group bluetooth net_bt_admin\n \n-service brick /system/bin/wipe nuke\n+service bluetoothd /system/bin/bluetoothd -n\n+    socket bluetooth stream 660 bluetooth bluetooth\n+    socket dbus_bluetooth stream 660 bluetooth bluetooth\n+    # init.rc does not yet support applying capabilities, so run as root and\n+    # let bluetoothd drop uid to bluetooth with the right linux capabilities\n+    group bluetooth net_bt_admin misc\n     disabled\n \n+service hfag /system/bin/sdptool add --channel=10 HFAG\n+    user bluetooth\n+    group bluetooth net_bt_admin\n+    disabled\n+    oneshot\n+\n+service hsag /system/bin/sdptool add --channel=11 HSAG\n+    user bluetooth\n+    group bluetooth net_bt_admin\n+    disabled\n+    oneshot\n+\n+service opush /system/bin/sdptool add --channel=12 OPUSH\n+    user bluetooth\n+    group bluetooth net_bt_admin\n+    disabled\n+    oneshot\n+\n+service pbap /system/bin/sdptool add --channel=19 PBAP\n+    user bluetooth\n+    group bluetooth net_bt_admin\n+    disabled\n+    oneshot\n+\n service installd /system/bin/installd\n     socket installd stream 600 system system\n \n-#\n-# Set by PRODUCT_PROPERTY_OVERRIDES in <product>.mk\n-on property:net.eth0.startonboot=1\n-    setprop ro.com.android.dataroaming true\n-    start start_eth0\n+service flash_recovery /system/etc/install-recovery.sh\n+    oneshot\n+\n+service racoon /system/bin/racoon\n+    socket racoon stream 600 system system\n+    # racoon will setuid to vpn after getting necessary resources.\n+    group net_admin\n+    disabled\n+    oneshot\n \n-service start_eth0 /system/bin/netcfg eth0 dhcp\n+service mtpd /system/bin/mtpd\n+    socket mtpd stream 600 system system\n+    user vpn\n+    group vpn net_admin net_raw\n+    disabled\n     oneshot\n+\n+service keystore /system/bin/keystore /data/misc/keystore\n+    user keystore\n+    group keystore\n+    socket keystore stream 666\n+\n+service dumpstate /system/bin/dumpstate -s\n+    socket dumpstate stream 0660 shell log\n     disabled\n+    oneshot\n""}","merge 
"
13025,PacketVideo CM,RIO-8176: Specific test mp3 content cannot be played on streaming with HTTP Progressive protocol,"['fileformats/mp3/parser/include/mp3parser.h', 'engines/2way/src/pv_2way_sdkinfo.h', 'engines/player/src/pv_player_sdkinfo.h', 'fileformats/mp3/parser/src/mp3parser.cpp', 'engines/author/src/pv_author_sdkinfo.h', 'nodes/pvmp3ffparsernode/src/pvmf_mp3ffparser_node.cpp']",RIO-8176: Specific test mp3 content cannot be played on streaming with HTTP Progressive protocol,https://android-review.googlesource.com/c/13025,"bug
",bug;,Test;,"{""pv_2way_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PV2WAY_ENGINE_SDKINFO_LABEL \""1146120\""\n+#define PV2WAY_ENGINE_SDKINFO_LABEL \""1146307\""\n #define PV2WAY_ENGINE_SDKINFO_DATE 0x20091216\n \n #endif //PV_2WAY_SDKINFO_H_INCLUDED\n"", ""pv_author_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""1146120\""\n+#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""1146307\""\n #define PVAUTHOR_ENGINE_SDKINFO_DATE 0x20091216\n \n #endif //PV_AUTHOR_SDKINFO_H_INCLUDED\n"", ""pv_player_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVPLAYER_ENGINE_SDKINFO_LABEL \""1146120\""\n+#define PVPLAYER_ENGINE_SDKINFO_LABEL \""1146307\""\n #define PVPLAYER_ENGINE_SDKINFO_DATE 0x20091216\n \n #endif //PV_PLAYER_SDKINFO_H_INCLUDED\n"", ""mp3parser.h"": ""@@ -445,6 +445,7 @@ class MP3Parser\n         uint32 iLocalFileSize;\n         uint32 iFileSizeFromExternalSource;\n         uint32 iInitSearchFileSize;\n+        uint32 iMinBytesRequiredForInit;\n         bool iLocalFileSizeSet;\n         PVFile * fp;\n         MediaClockConverter iClockConverter;\n"", ""mp3parser.cpp"": ""@@ -334,6 +334,9 @@ MP3Parser::MP3Parser(PVFile* aFileHandle)\n     iClipDurationFromRandomScan = 0;\n     iClipDurationFromMetadata = 0;\n \n+    //minimum bytes required for init\n+    iMinBytesRequiredForInit = KMAX_MP3FRAME_LENGTH_IN_BYTES;\n+\n     iSamplesPerFrame = 0;\n     iSamplingRate = 0;\n \n@@ -385,6 +388,7 @@ MP3Parser::~MP3Parser()\n     iLocalFileSize = 0;\n     iLocalFileSize = false;\n     iInitSearchFileSize = 0;\n+    iMinBytesRequiredForInit = 0;\n     iCurrFrameNumber = 0;\n     iNumberOfFrames = 0;\n     ConfigSize = 0;\n@@ -510,6 +514,11 @@ MP3ErrorType MP3Parser::ParseMP3File(PVFile * fpUsed, bool aEnableCRC)\n     err = mp3FindSync(StartOffset, seekOffset, fp);\n     if (err != MP3_SUCCESS)\n     {\n+        if (err == MP3_INSUFFICIENT_DATA)\n+        {\n+            iMinBytesRequiredForInit += KMAX_MP3FRAME_LENGTH_IN_BYTES;\n+        }\n+\n         // in eof scenario parser reports eof error to the user\n         // eof will be reported in case when no valid sync\n         // word is find in the maximum specified search limit\n@@ -1575,7 +1584,7 @@ MP3ErrorType MP3Parser::GetMetadataSize(uint32 &aMetadataSize)\n  ***********************************************************************/\n uint32 MP3Parser::GetMinBytesRequired(bool aNextBytes)\n {\n-    uint32 minBytes = KMAX_MP3FRAME_LENGTH_IN_BYTES;\n+    uint32 minBytes = iMinBytesRequiredForInit;\n     if (aNextBytes && fp)\n     {\n         // case where parse file has failed due to lack of data\n"", ""pvmf_mp3ffparser_node.cpp"": ""@@ -20,7 +20,6 @@\n #define LOGINFO(m) PVLOGGER_LOGMSG(PVLOGMSG_INST_MLDBG,iLogger,PVLOGMSG_INFO,m);\n \n // constructor\n-\n PVMFMP3FFParserNode::PVMFMP3FFParserNode(int32 aPriority)\n         : PVMFNodeInterfaceImpl(aPriority, \""PVMFMP3FFParserNode\""),\n         iParseStatus(false),\n@@ -313,7 +312,6 @@ PVMFStatus PVMFMP3FFParserNode::DoQueryUuid()\n }\n \n // CommandHandler for Query Interface\n-\n PVMFStatus PVMFMP3FFParserNode::DoQueryInterface()\n {\n     // This node supports Query Interface from any state\n@@ -893,29 +891,6 @@ void PVMFMP3FFParserNode::Run()\n             // complete init command\n             CompleteInit(cmdStatus);\n         }\n-        else if (PVMFErrUnderflow == cmdStatus)\n-        {\n-            if (iMP3File)\n-            {\n-                bool nextBytes = true;\n-                uint32 currCapacity = 0;\n-                uint32 minBytesRequired = iMP3File->GetMinBytesRequired(nextBytes);\n-                // CheckForMP3HeaderAvailability has failed because of underflow.\n-                // parser needs more bytes to do parsing and verification of the clip.\n-                PvmiDataStreamStatus status = iDataStreamInterface->QueryReadCapacity(iDataStreamSessionID,\n-                                              currCapacity);\n-\n-                if (PVDS_SUCCESS == status && currCapacity < minBytesRequired + iMP3MetaDataSize)\n-                {\n-                    // Request for read capacity notification was issued\n-                    iRequestReadCapacityNotificationID =\n-                        iDataStreamInterface->RequestReadCapacityNotification(iDataStreamSessionID,\n-                                *this,\n-                                iMP3MetaDataSize + minBytesRequired);\n-                }\n-            }\n-            LOGINFO((0, \""PVMFMP3FFParserNode::Run() CheckForMP3HeaderAvailability() failed %d\"", cmdStatus));\n-        }\n         else if (PVMFFailure == cmdStatus)\n         {\n             CompleteInit(cmdStatus);\n@@ -3062,16 +3037,20 @@ PVMFStatus PVMFMP3FFParserNode::CheckForMP3HeaderAvailability()\n         }\n     }\n \n+    uint32 currCapacity = 0;\n+    uint32 minBytesRequired = 0;\n+\n+    // in local playback these variables will not be used.\n+    OSCL_UNUSED_ARG(currCapacity);\n+    OSCL_UNUSED_ARG(minBytesRequired);\n+\n     if (iDataStreamInterface != NULL)\n     {\n-        uint32 minBytesRequired = 0;\n         minBytesRequired = iMP3File->GetMinBytesRequired();\n-\n         /*\n          * First check if we have minimum number of bytes to recognize\n          * the file and determine the header size.\n          */\n-        uint32 currCapacity = 0;\n         PvmiDataStreamStatus status = iDataStreamInterface->QueryReadCapacity(iDataStreamSessionID,\n                                       currCapacity);\n \n@@ -3115,8 +3094,34 @@ PVMFStatus PVMFMP3FFParserNode::CheckForMP3HeaderAvailability()\n             }\n         }\n     }\n-    PVMFStatus status = ParseFile();\n-    return status;\n+    PVMFStatus retVal = ParseFile();\n+    // parse file failed because of lack of available data\n+    // if there's lack of data request more data\n+    if (NULL != iDataStreamInterface)\n+    {\n+        if (PVMFErrUnderflow == retVal)\n+        {\n+            minBytesRequired = iMP3File->GetMinBytesRequired();\n+            /*\n+             * First check if we have minimum number of bytes to recognize\n+             * the file and determine the header size.\n+             */\n+            if (currCapacity < minBytesRequired)\n+            {\n+                iRequestReadCapacityNotificationID =\n+                    iDataStreamInterface->RequestReadCapacityNotification(iDataStreamSessionID,\n+                            *this,\n+                            minBytesRequired);\n+                return PVMFPending;\n+            }\n+            else\n+            {\n+                // data read capacity notification failed.\n+                return PVMFFailure;\n+            }\n+        }\n+    }\n+    return retVal;\n }\n \n void PVMFMP3FFParserNode::GetCPMMetaDataKeys()\n""}","bug, test 
"
16107,Deleted User,i2c-tegra: add support for virtual busses with dynamic pinmuxing,"['drivers/i2c/busses/i2c-tegra.c', 'include/linux/i2c-tegra.h']","i2c-tegra: add support for virtual busses with dynamic pinmuxing

this adds support for dynamically reprogramming the I2C controller's
pin mux on transaction boundaries to enable one controller to be
registered as multiple I2C bus adapters with the kernel. this allows
platform designers an additional tool to resolve clock rate, I/O
voltage and electrical loading restrictions between the platform's
peripherals.

the i2c-tegra platform data is extended to support this; platforms
which use this feature should pass in the number of busses which
should be created for each controller, the starting adapter number
to use and the clock rate and pin mux for each virtual bus.

Change-Id: I57a96deb7b7b793222ec3f8cc3a941917a023609
Signed-off-by: Gary King <gking@nvidia.com>",https://android-review.googlesource.com/c/16107,"feature 
",feature,Feature;,"{""i2c-tegra.c"": ""@@ -29,6 +29,7 @@\n #include <asm/unaligned.h>\n \n #include <mach/clk.h>\n+#include <mach/pinmux.h>\n \n #define TEGRA_I2C_TIMEOUT (msecs_to_jiffies(1000))\n #define BYTES_PER_FIFO_WORD 4\n@@ -92,9 +93,19 @@\n #define I2C_HEADER_MASTER_ADDR_SHIFT\t\t12\n #define I2C_HEADER_SLAVE_ADDR_SHIFT\t\t1\n \n+struct tegra_i2c_dev;\n+\n+struct tegra_i2c_bus {\n+\tstruct tegra_i2c_dev *dev;\n+\tstruct rt_mutex *bus_lock;\n+\tconst struct tegra_pingroup_config *mux;\n+\tint mux_len;\n+\tunsigned long bus_clk_rate;\n+\tstruct i2c_adapter adapter;\n+};\n+\n struct tegra_i2c_dev {\n \tstruct device *dev;\n-\tstruct i2c_adapter adapter;\n \tstruct clk *clk;\n \tstruct clk *i2c_clk;\n \tstruct resource *iomem;\n@@ -108,8 +119,12 @@ struct tegra_i2c_dev {\n \tsize_t msg_buf_remaining;\n \tint msg_read;\n \tint msg_transfer_complete;\n-\tunsigned long bus_clk_rate;\n \tbool is_suspended;\n+\tint bus_count;\n+\tconst struct tegra_pingroup_config *last_mux;\n+\tint last_mux_len;\n+\tunsigned long last_bus_clk;\n+\tstruct tegra_i2c_bus busses[1];\n };\n \n static void dvc_writel(struct tegra_i2c_dev *i2c_dev, u32 val, unsigned long reg)\n@@ -305,7 +320,7 @@ static int tegra_i2c_init(struct tegra_i2c_dev *i2c_dev)\n \tval = I2C_CNFG_NEW_MASTER_FSM | I2C_CNFG_PACKET_MODE_EN;\n \ti2c_writel(i2c_dev, val, I2C_CNFG);\n \ti2c_writel(i2c_dev, 0, I2C_INT_MASK);\n-\ttegra_i2c_set_clk(i2c_dev, i2c_dev->bus_clk_rate);\n+\ttegra_i2c_set_clk(i2c_dev, i2c_dev->last_bus_clk);\n \n \tval = 7 << I2C_FIFO_CONTROL_TX_TRIG_SHIFT |\n \t\t0 << I2C_FIFO_CONTROL_RX_TRIG_SHIFT;\n@@ -380,9 +395,10 @@ err:\n \treturn IRQ_HANDLED;\n }\n \n-static int tegra_i2c_xfer_msg(struct tegra_i2c_dev *i2c_dev,\n+static int tegra_i2c_xfer_msg(struct tegra_i2c_bus *i2c_bus,\n \tstruct i2c_msg *msg, int stop)\n {\n+\tstruct tegra_i2c_dev *i2c_dev = i2c_bus->dev;\n \tu32 packet_header;\n \tu32 int_mask;\n \tint ret;\n@@ -462,23 +478,66 @@ static int tegra_i2c_xfer_msg(struct tegra_i2c_dev *i2c_dev,\n \treturn -EIO;\n }\n \n+static int tegra_i2c_lock(struct tegra_i2c_bus *i2c_bus)\n+{\n+\tif (likely(i2c_bus->bus_lock == &i2c_bus->adapter.bus_lock))\n+\t\treturn 0;\n+\n+\tif (in_atomic() || irqs_disabled()) {\n+\t\tif (!rt_mutex_trylock(i2c_bus->bus_lock))\n+\t\t\treturn -EAGAIN;\n+\t} else {\n+\t\trt_mutex_lock(i2c_bus->bus_lock);\n+\t}\n+\treturn 0;\n+}\n+\n+static void tegra_i2c_unlock(struct tegra_i2c_bus *i2c_bus)\n+{\n+\tif (likely(i2c_bus->bus_lock == &i2c_bus->adapter.bus_lock))\n+\t\treturn;\n+\n+\trt_mutex_unlock(i2c_bus->bus_lock);\n+}\n+\n static int tegra_i2c_xfer(struct i2c_adapter *adap, struct i2c_msg msgs[], int num)\n {\n-\tstruct tegra_i2c_dev *i2c_dev = i2c_get_adapdata(adap);\n+\tstruct tegra_i2c_bus *i2c_bus = i2c_get_adapdata(adap);\n+\tstruct tegra_i2c_dev *i2c_dev = i2c_bus->dev;\n \tint i;\n \tint ret = 0;\n \n \tif(i2c_dev->is_suspended)\n \t\treturn -EBUSY;\n \n+\tif (tegra_i2c_lock(i2c_bus))\n+\t\treturn -EAGAIN;\n+\n+\tif (i2c_dev->last_mux != i2c_bus->mux) {\n+\t\ttegra_pinmux_set_safe_pinmux_table(i2c_dev->last_mux,\n+\t\t\ti2c_dev->last_mux_len);\n+\t\ttegra_pinmux_config_pinmux_table(i2c_bus->mux,\n+\t\t\ti2c_bus->mux_len);\n+\t\ti2c_dev->last_mux = i2c_bus->mux;\n+\t\ti2c_dev->last_mux_len = i2c_bus->mux_len;\n+\t}\n+\n+\tif (i2c_dev->last_bus_clk != i2c_bus->bus_clk_rate) {\n+\t\ttegra_i2c_set_clk(i2c_dev, i2c_bus->bus_clk_rate);\n+\t\ti2c_dev->last_bus_clk = i2c_bus->bus_clk_rate;\n+\t}\n+\n \tclk_enable(i2c_dev->clk);\n \tfor (i = 0; i < num; i++) {\n \t\tint stop = (i == (num - 1)) ? 1  : 0;\n-\t\tret = tegra_i2c_xfer_msg(i2c_dev, &msgs[i], stop);\n+\t\tret = tegra_i2c_xfer_msg(i2c_bus, &msgs[i], stop);\n \t\tif (ret)\n \t\t\tbreak;\n \t}\n \tclk_disable(i2c_dev->clk);\n+\n+\ttegra_i2c_unlock(i2c_bus);\n+\n \treturn i;\n }\n \n@@ -497,15 +556,30 @@ static const struct i2c_algorithm tegra_i2c_algo = {\n static int tegra_i2c_probe(struct platform_device *pdev)\n {\n \tstruct tegra_i2c_dev *i2c_dev;\n-\tstruct tegra_i2c_platform_data *pdata = pdev->dev.platform_data;\n+\tstruct tegra_i2c_platform_data *plat = pdev->dev.platform_data;\n \tstruct resource *res;\n \tstruct resource *iomem;\n \tstruct clk *clk;\n \tstruct clk *i2c_clk;\n \tvoid *base;\n \tint irq;\n+\tint nbus;\n+\tint i = 0;\n \tint ret = 0;\n \n+\tif (!plat) {\n+\t\tdev_err(&pdev->dev, \""no platform data?\\n\"");\n+\t\treturn -ENODEV;\n+\t}\n+\n+\tif (plat->bus_count <= 0 || plat->adapter_nr < 0) {\n+\t\tdev_err(&pdev->dev, \""invalid platform data?\\n\"");\n+\t\treturn -ENODEV;\n+\t}\n+\n+\tWARN_ON(plat->bus_count > TEGRA_I2C_MAX_BUS);\n+\tnbus = min(TEGRA_I2C_MAX_BUS, plat->bus_count);\n+\n \tres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\n \tif (!res) {\n \t\tdev_err(&pdev->dev, \""no mem resource?\\n\"");\n@@ -543,7 +617,8 @@ static int tegra_i2c_probe(struct platform_device *pdev)\n \t\tgoto err_clk_put;\n \t}\n \n-\ti2c_dev = kzalloc(sizeof(struct tegra_i2c_dev), GFP_KERNEL);\n+\ti2c_dev = kzalloc(sizeof(struct tegra_i2c_dev) +\n+\t\t\t  (nbus-1) * sizeof(struct tegra_i2c_bus), GFP_KERNEL);\n \tif (!i2c_dev) {\n \t\tret = -ENOMEM;\n \t\tgoto err_i2c_clk_put;\n@@ -553,14 +628,12 @@ static int tegra_i2c_probe(struct platform_device *pdev)\n \ti2c_dev->clk = clk;\n \ti2c_dev->i2c_clk = i2c_clk;\n \ti2c_dev->iomem = iomem;\n-\ti2c_dev->adapter.algo = &tegra_i2c_algo;\n \ti2c_dev->irq = irq;\n \ti2c_dev->cont_id = pdev->id;\n \ti2c_dev->dev = &pdev->dev;\n-\ti2c_dev->bus_clk_rate = pdata ? pdata->bus_clk_rate : 100000;\n+\ti2c_dev->last_bus_clk = plat->bus_clk_rate[0] ?: 100000;\n \n-\tif (pdev->id == 3)\n-\t\ti2c_dev->is_dvc = 1;\n+\ti2c_dev->is_dvc = plat->is_dvc;\n \tinit_completion(&i2c_dev->msg_complete);\n \n \tplatform_set_drvdata(pdev, i2c_dev);\n@@ -578,23 +651,36 @@ static int tegra_i2c_probe(struct platform_device *pdev)\n \n \tclk_enable(i2c_dev->i2c_clk);\n \n-\ti2c_set_adapdata(&i2c_dev->adapter, i2c_dev);\n-\ti2c_dev->adapter.owner = THIS_MODULE;\n-\ti2c_dev->adapter.class = I2C_CLASS_HWMON;\n-\tstrlcpy(i2c_dev->adapter.name, \""Tegra I2C adapter\"",\n-\t\tsizeof(i2c_dev->adapter.name));\n-\ti2c_dev->adapter.algo = &tegra_i2c_algo;\n-\ti2c_dev->adapter.dev.parent = &pdev->dev;\n-\ti2c_dev->adapter.nr = pdev->id;\n-\n-\tret = i2c_add_numbered_adapter(&i2c_dev->adapter);\n-\tif (ret) {\n-\t\tdev_err(&pdev->dev, \""Failed to add I2C adapter\\n\"");\n-\t\tgoto err_free_irq;\n+\tfor (i=0; i<nbus; i++) {\n+\t\tstruct tegra_i2c_bus *i2c_bus = &i2c_dev->busses[i];\n+\n+\t\ti2c_bus->dev = i2c_dev;\n+\t\ti2c_bus->mux = plat->bus_mux[i];\n+\t\ti2c_bus->mux_len = plat->bus_mux_len[i];\n+\t\ti2c_bus->bus_lock = &i2c_dev->busses[0].adapter.bus_lock;\n+\t\ti2c_bus->bus_clk_rate = plat->bus_clk_rate[i] ?: 100000;\n+\n+\t\ti2c_bus->adapter.algo = &tegra_i2c_algo;\n+\t\ti2c_set_adapdata(&i2c_bus->adapter, i2c_bus);\n+\t\ti2c_bus->adapter.owner = THIS_MODULE;\n+\t\ti2c_bus->adapter.class = I2C_CLASS_HWMON;\n+\t\tstrlcpy(i2c_bus->adapter.name, \""Tegra I2C adapter\"",\n+\t\t\tsizeof(i2c_bus->adapter.name));\n+\t\ti2c_bus->adapter.dev.parent = &pdev->dev;\n+\t\ti2c_bus->adapter.nr = plat->adapter_nr + i;\n+\t\tret = i2c_add_numbered_adapter(&i2c_bus->adapter);\n+\t\tif (ret) {\n+\t\t\tdev_err(&pdev->dev, \""Failed to add I2C adapter\\n\"");\n+\t\t\tgoto err_free_irq;\n+\t\t}\n+\t\ti2c_dev->bus_count++;\n \t}\n \n \treturn 0;\n err_free_irq:\n+\twhile (i2c_dev->bus_count--)\n+\t\ti2c_del_adapter(&i2c_dev->busses[i2c_dev->bus_count].adapter);\n+\n \tfree_irq(i2c_dev->irq, i2c_dev);\n err_free:\n \tkfree(i2c_dev);\n@@ -612,7 +698,9 @@ err_iounmap:\n static int tegra_i2c_remove(struct platform_device *pdev)\n {\n \tstruct tegra_i2c_dev *i2c_dev = platform_get_drvdata(pdev);\n-\ti2c_del_adapter(&i2c_dev->adapter);\n+\twhile (i2c_dev->bus_count--)\n+\t\ti2c_del_adapter(&i2c_dev->busses[i2c_dev->bus_count].adapter);\n+\n \tfree_irq(i2c_dev->irq, i2c_dev);\n \tclk_put(i2c_dev->i2c_clk);\n \tclk_put(i2c_dev->clk);\n@@ -627,9 +715,9 @@ static int tegra_i2c_suspend(struct platform_device *pdev, pm_message_t state)\n {\n \tstruct tegra_i2c_dev *i2c_dev = platform_get_drvdata(pdev);\n \n-\ti2c_lock_adapter(&i2c_dev->adapter);\n+\ti2c_lock_adapter(&i2c_dev->busses[0].adapter);\n \ti2c_dev->is_suspended = true;\n-\ti2c_unlock_adapter(&i2c_dev->adapter);\n+\ti2c_unlock_adapter(&i2c_dev->busses[0].adapter);\n \n \treturn 0;\n }\n@@ -639,18 +727,18 @@ static int tegra_i2c_resume(struct platform_device *pdev)\n \tstruct tegra_i2c_dev *i2c_dev = platform_get_drvdata(pdev);\n \tint ret;\n \n-\ti2c_lock_adapter(&i2c_dev->adapter);\n+\ti2c_lock_adapter(&i2c_dev->busses[0].adapter);\n \n \tret = tegra_i2c_init(i2c_dev);\n \n \tif (ret) {\n-\t\ti2c_unlock_adapter(&i2c_dev->adapter);\n+\t\ti2c_unlock_adapter(&i2c_dev->busses[0].adapter);\n \t\treturn ret;\n \t}\n \n \ti2c_dev->is_suspended = false;\n \n-\ti2c_unlock_adapter(&i2c_dev->adapter);\n+\ti2c_unlock_adapter(&i2c_dev->busses[0].adapter);\n \n \treturn 0;\n }\n"", ""i2c-tegra.h"": ""@@ -18,8 +18,17 @@\n #ifndef _LINUX_I2C_TEGRA_H\n #define _LINUX_I2C_TEGRA_H\n \n+#include <mach/pinmux.h>\n+\n+#define TEGRA_I2C_MAX_BUS 2\n+\n struct tegra_i2c_platform_data {\n-\tunsigned long bus_clk_rate;\n+\tint adapter_nr;\n+\tint bus_count;\n+\tconst struct tegra_pingroup_config *bus_mux[TEGRA_I2C_MAX_BUS];\n+\tint bus_mux_len[TEGRA_I2C_MAX_BUS];\n+\tunsigned long bus_clk_rate[TEGRA_I2C_MAX_BUS];\n+\tbool is_dvc;\n };\n \n #endif /* _LINUX_I2C_TEGRA_H */\n""}","feature 
"
14432,Colin Cross,"[ARM] tegra: clock: redo debugfs clock interface, add clock tree","['arch/arm/mach-tegra/clock.h', 'arch/arm/mach-tegra/clock.c', 'arch/arm/mach-tegra/tegra2_clocks.c']","[ARM] tegra: clock: redo debugfs clock interface, add clock tree, bug fixes

Fixes:
Don't reset peripherials on clk_disable
Correct flags on dvc_i2c
Remove input clock
Autodetect state of all clocks on init
Add cpu, sys, and bus clocks
Fix clk_set_rate on PLLs

Change-Id: I2a3efe98b93478e7bbd68a01aaba5d4f6a955537",https://android-review.googlesource.com/c/14432,"bug, feature, refactor, test 
","bug,feature,deprecat",Bug;Deprecat;,"{""clock.c"": ""@@ -22,11 +22,15 @@\n #include <linux/init.h>\n #include <linux/module.h>\n #include <linux/debugfs.h>\n+#include <linux/slab.h>\n+#include <linux/seq_file.h>\n #include <asm/clkdev.h>\n \n #include \""clock.h\""\n \n+#ifdef CONFIG_DEBUG_FS\n static int clk_debugfs_reparent(struct clk *c);\n+#endif\n \n static LIST_HEAD(clocks);\n static DEFINE_MUTEX(clocks_mutex);\n@@ -51,7 +55,9 @@ static int clk_reparent(struct clk *c, struct clk *parent)\n \t\tlist_del_init(&c->sibling);\n \tif (parent)\n \t\tlist_add(&c->sibling, &parent->children);\n+#ifdef CONFIG_DEBUG_FS\n \tclk_debugfs_reparent(c);\n+#endif\n \treturn 0;\n }\n \n@@ -105,6 +111,8 @@ int clk_enable(struct clk *c)\n \t\t\t\t\tclk_disable(c->parent);\n \t\t\t\tgoto err;\n \t\t\t}\n+\t\t\tc->state = ON;\n+\t\t\tc->set = 1;\n \t\t}\n \t}\n \tc->refcnt++;\n@@ -128,6 +136,9 @@ void clk_disable(struct clk *c)\n \n \t\tif (c->ops && c->ops->disable)\n \t\t\tc->ops->disable(c);\n+\n+\t\tc->state = OFF;\n+\t\tc->set = 1;\n \t}\n \tc->refcnt--;\n err:\n@@ -205,43 +216,125 @@ int __init tegra_init_clock(void)\n #ifdef CONFIG_DEBUG_FS\n static struct dentry *clk_debugfs_root;\n \n+\n+static void clock_tree_show_one(struct seq_file *s, struct clk *c, int level)\n+{\n+\tstruct clk *child;\n+\tstruct clk *safe;\n+\tconst char *state = \""uninit\"";\n+\tchar div[5] = {0};\n+\n+\tif (c->state == ON)\n+\t\tstate = \""on\"";\n+\telse if (c->state == OFF)\n+\t\tstate = \""off\"";\n+\n+\tif (c->mul != 0 && c->div != 0) {\n+\t\tBUG_ON(c->mul > 2);\n+\t\tif (c->mul > c->div)\n+\t\t\tsnprintf(div, sizeof(div), \""x%d\"", c->mul / c->div);\n+\t\telse\n+\t\t\tsnprintf(div, sizeof(div), \""%d%s\"", c->div / c->mul,\n+\t\t\t\t(c->div % c->mul) ? \"".5\"" : \""\"");\n+\t}\n+\n+\tseq_printf(s, \""%*s%-*s %-6s %-3d %-5s %-10lu\\n\"",\n+\t\tlevel * 3 + 1, c->set ? \""\"" : \""*\"",\n+\t\t30 - level * 3, c->name,\n+\t\tstate, c->refcnt, div, c->rate);\n+\tlist_for_each_entry_safe(child, safe, &c->children, sibling) {\n+\t\tclock_tree_show_one(s, child, level + 1);\n+\t}\n+}\n+\n+static int clock_tree_show(struct seq_file *s, void *data)\n+{\n+\tstruct clk *c;\n+\tseq_printf(s, \"" clock                          state  ref div   rate      \\n\"");\n+\tseq_printf(s, \""-----------------------------------------------------------\\n\"");\n+\tmutex_lock(&clocks_mutex);\n+\tlist_for_each_entry(c, &clocks, node)\n+\t\tif (c->parent == NULL)\n+\t\t\tclock_tree_show_one(s, c, 0);\n+\tmutex_unlock(&clocks_mutex);\n+\treturn 0;\n+}\n+\n+static int clock_tree_open(struct inode *inode, struct file *file)\n+{\n+\treturn single_open(file, clock_tree_show, inode->i_private);\n+}\n+\n+static const struct file_operations clock_tree_fops = {\n+\t.open\t\t= clock_tree_open,\n+\t.read\t\t= seq_read,\n+\t.llseek\t\t= seq_lseek,\n+\t.release\t= single_release,\n+};\n+\n+static int possible_parents_show(struct seq_file *s, void *data)\n+{\n+\tstruct clk *c = s->private;\n+\tint i;\n+\n+\tfor (i=0; c->inputs[i].input; i++) {\n+\t\tchar *first = (i == 0) ? \""\"" : \"" \"";\n+\t\tseq_printf(s, \""%s%s\"", first, c->inputs[i].input->name);\n+\t}\n+\tseq_printf(s, \""\\n\"");\n+\treturn 0;\n+}\n+\n+static int possible_parents_open(struct inode *inode, struct file *file)\n+{\n+\treturn single_open(file, possible_parents_show, inode->i_private);\n+}\n+\n+static const struct file_operations possible_parents_fops = {\n+\t.open\t\t= possible_parents_open,\n+\t.read\t\t= seq_read,\n+\t.llseek\t\t= seq_lseek,\n+\t.release\t= single_release,\n+};\n+\n static int clk_debugfs_register_one(struct clk *c)\n {\n-\tint err;\n \tstruct dentry *d, *child, *child_tmp;\n-\tstruct clk *pa = c->parent;\n \tchar s[255];\n-\tchar *p = s;\n \n-\tp += sprintf(p, \""%s\"", c->name);\n-\td = debugfs_create_dir(s, pa ? pa->dent : clk_debugfs_root);\n+\tsprintf(s, \""%s\"", c->name);\n+\td = debugfs_create_dir(s, clk_debugfs_root);\n \tif (!d)\n \t\treturn -ENOMEM;\n \tc->dent = d;\n \n \td = debugfs_create_u8(\""refcnt\"", S_IRUGO, c->dent, (u8 *)&c->refcnt);\n-\tif (!d) {\n-\t\terr = -ENOMEM;\n+\tif (!d)\n \t\tgoto err_out;\n-\t}\n+\n \td = debugfs_create_u32(\""rate\"", S_IRUGO, c->dent, (u32 *)&c->rate);\n-\tif (!d) {\n-\t\terr = -ENOMEM;\n+\tif (!d)\n \t\tgoto err_out;\n-\t}\n+\n \td = debugfs_create_x32(\""flags\"", S_IRUGO, c->dent, (u32 *)&c->flags);\n-\tif (!d) {\n-\t\terr = -ENOMEM;\n+\tif (!d)\n \t\tgoto err_out;\n+\n+\tif (c->inputs) {\n+\t\td = debugfs_create_file(\""possible_parents\"", S_IRUGO, c->dent,\n+\t\t\tc, &possible_parents_fops);\n+\t\tif (!d)\n+\t\t\tgoto err_out;\n \t}\n-\treturn 0;\n+\n+\treturn clk_debugfs_reparent(c);\n \n err_out:\n \td = c->dent;\n \tlist_for_each_entry_safe(child, child_tmp, &d->d_subdirs, d_u.d_child)\n \t\tdebugfs_remove(child);\n \tdebugfs_remove(c->dent);\n-\treturn err;\n+\treturn -ENOMEM;\n }\n \n static int clk_debugfs_register(struct clk *c)\n@@ -267,13 +360,18 @@ static int __init clk_debugfs_init(void)\n {\n \tstruct clk *c;\n \tstruct dentry *d;\n-\tint err;\n+\tint err = -ENOMEM;\n \n \td = debugfs_create_dir(\""clock\"", NULL);\n \tif (!d)\n \t\treturn -ENOMEM;\n \tclk_debugfs_root = d;\n \n+\td = debugfs_create_file(\""clock_tree\"", S_IRUGO, clk_debugfs_root, NULL,\n+\t\t&clock_tree_fops);\n+\tif (!d)\n+\t\tgoto err_out;\n+\n \tlist_for_each_entry(c, &clocks, node) {\n \t\terr = clk_debugfs_register(c);\n \t\tif (err)\n@@ -284,17 +382,19 @@ err_out:\n \tdebugfs_remove_recursive(clk_debugfs_root);\n \treturn err;\n }\n-late_initcall(clk_debugfs_init);\n-#endif\n \n static int clk_debugfs_reparent(struct clk *c)\n {\n \tint ret = 0;\n-\tpr_debug(\""%s: %s %p %p %s\\n\"", __func__, c->name, c->dent, c->parent,\n-\t\tc->parent ? c->parent->name : NULL);\n-#ifdef CONFIG_DEBUG_FS\n-\tdebugfs_remove(c->dent);\n-\tret = clk_debugfs_register_one(c);\n-#endif\n+\tchar tmp[256];\n+\tif (c->parent_dent)\n+\t\tdebugfs_remove(c->parent_dent);\n+\tc->parent_dent = NULL;\n+\tif (c->parent) {\n+\t\tsnprintf(tmp, sizeof(tmp), \""../%s\"", c->parent->name);\n+\t\tc->parent_dent = debugfs_create_symlink(\""parent\"", c->dent, tmp);\n+\t}\n \treturn ret;\n }\n+late_initcall(clk_debugfs_init);\n+#endif\n"", ""clock.h"": ""@@ -22,7 +22,7 @@\n \n #include <asm/clkdev.h>\n \n-#define ENABLE_ON_INIT\t0x00000001\n+#define DIV_BUS\t\t0x00000001\n #define DIV_U71\t\t0x00000002\n #define DIV_U71_FIXED\t0x00000004\n #define DIV_2\t\t0x00000008\n@@ -30,7 +30,10 @@\n #define PLL_HAS_CPCON\t0x00000020\n #define MUX\t\t0x00000040\n #define PLLD\t\t0x00000080\n-\n+#define PERIPH_NO_RESET\t0x00000100\n+#define PERIPH_NO_ENB\t0x00000200\n+#define PERIPH_EMC_ENB\t0x00000400\n+#define ENABLE_ON_INIT\t0x10000000\n struct clk;\n \n struct clk_mux_sel {\n@@ -59,6 +62,12 @@ struct clk_ops {\n \tunsigned long\t(*recalculate_rate)(struct clk *);\n };\n \n+enum clk_state {\n+\tUNINITIALIZED = 0,\n+\tON,\n+\tOFF,\n+};\n+\n struct clk {\n \t/* node for master clocks list */\n \tstruct list_head\t\tnode;\n@@ -66,6 +75,7 @@ struct clk {\n \tstruct list_head\t\tsibling;\t/* node for children */\n #ifdef CONFIG_DEBUG_FS\n \tstruct dentry \t\t\t*dent;\n+\tstruct dentry \t\t\t*parent_dent;\n #endif\n \tstruct clk_ops\t\t\t*ops;\n \tstruct clk\t\t\t*parent;\n@@ -78,6 +88,8 @@ struct clk {\n \tu32\t\t\t\treg_shift;\n \tunsigned int\t\t\tclk_num;\n \tspinlock_t\t\t\tlock;\n+\tenum clk_state\t\t\tstate;\n+\tbool\t\t\t\tset;\n \n \t/* PLL */\n \tunsigned long\t\t\tinput_min;\n@@ -94,6 +106,7 @@ struct clk {\n \n \t/* DIV */\n \tu32\t\t\t\tdiv;\n+\tu32\t\t\t\tmul;\n \n \t/* MUX */\n \tconst struct clk_mux_sel\t*inputs;\n@@ -110,7 +123,6 @@ struct clk_duplicate {\n void tegra2_init_clocks(void);\n void clk_init(struct clk *clk);\n struct clk *get_tegra_clock_by_name(const char *name);\n-\n unsigned long clk_measure_input_freq(void);\n \n #endif\n"", ""tegra2_clocks.c"": ""@@ -78,18 +78,43 @@\n #define PLL_OUT_CLKEN\t\t\t(1<<1)\n #define PLL_OUT_RESET_DISABLE\t\t(1<<0)\n \n-\n #define PLL_MISC\t\t\t0xc\n #define PLL_MISC_DCCON_SHIFT\t\t20\n #define PLL_MISC_LOCK_ENABLE\t\t(1<<18)\n #define PLL_MISC_CPCON_SHIFT\t\t8\n+#define PLL_MISC_CPCON_MASK\t\t(0xF<<PLL_MISC_CPCON_SHIFT)\n #define PLL_MISC_LFCON_SHIFT\t\t4\n+#define PLL_MISC_LFCON_MASK\t\t(0xF<<PLL_MISC_LFCON_SHIFT)\n #define PLL_MISC_VCOCON_SHIFT\t\t0\n+#define PLL_MISC_VCOCON_MASK\t\t(0xF<<PLL_MISC_VCOCON_SHIFT)\n \n #define PLLD_MISC_CLKENABLE\t\t(1<<30)\n #define PLLD_MISC_DIV_RST\t\t(1<<23)\n #define PLLD_MISC_DCCON_SHIFT\t\t12\n \n+#define PERIPH_CLK_TO_ENB_REG(c)\t((c->clk_num / 32) * 4)\n+#define PERIPH_CLK_TO_ENB_SET_REG(c)\t((c->clk_num / 32) * 8)\n+#define PERIPH_CLK_TO_ENB_BIT(c)\t(1 << (c->clk_num % 32))\n+\n+#define SUPER_CLK_MUX\t\t\t0x00\n+#define SUPER_STATE_SHIFT\t\t28\n+#define SUPER_STATE_MASK\t\t(0xF << SUPER_STATE_SHIFT)\n+#define SUPER_STATE_STANDBY\t\t(0x0 << SUPER_STATE_SHIFT)\n+#define SUPER_STATE_IDLE\t\t(0x1 << SUPER_STATE_SHIFT)\n+#define SUPER_STATE_RUN\t\t\t(0x2 << SUPER_STATE_SHIFT)\n+#define SUPER_STATE_IRQ\t\t\t(0x3 << SUPER_STATE_SHIFT)\n+#define SUPER_STATE_FIQ\t\t\t(0x4 << SUPER_STATE_SHIFT)\n+#define SUPER_SOURCE_MASK\t\t0xF\n+#define\tSUPER_FIQ_SOURCE_SHIFT\t\t12\n+#define\tSUPER_IRQ_SOURCE_SHIFT\t\t8\n+#define\tSUPER_RUN_SOURCE_SHIFT\t\t4\n+#define\tSUPER_IDLE_SOURCE_SHIFT\t\t0\n+\n+#define SUPER_CLK_DIVIDER\t\t0x04\n+\n+#define BUS_CLK_DISABLE\t\t\t(1<<3)\n+#define BUS_CLK_DIV_MASK\t\t0x3\n+\n static void __iomem *reg_clk_base = IO_ADDRESS(TEGRA_CLK_RESET_BASE);\n \n /* Lock clk_reg_lock around any non-atomic access to a register\n@@ -133,6 +158,19 @@ static int clk_div71_possible_rate(struct clk *c, unsigned long rate)\n \t\treturn -EINVAL;\n }\n \n+static unsigned long tegra2_clk_recalculate_rate(struct clk* c)\n+{\n+\tunsigned long rate;\n+\trate = c->parent->rate;\n+\n+\tif (c->mul != 0 && c->div != 0)\n+\t\tc->rate = rate * c->mul / c->div;\n+\telse\n+\t\tc->rate = rate;\n+\treturn c->rate;\n+}\n+\n+\n /* clk_m functions */\n static unsigned long tegra2_clk_m_autodetect_rate(struct clk *c)\n {\n@@ -184,7 +222,172 @@ static struct clk_ops tegra_clk_m_ops = {\n \t.disable  = tegra2_clk_m_disable,\n };\n \n+/* super clock functions */\n+/* \""super clocks\"" on tegra have two-stage muxes and a clock skipping\n+ * super divider.  We will ignore the clock skipping divider, since we\n+ * can't lower the voltage when using the clock skip, but we can if we\n+ * lower the PLL frequency.\n+ */\n+static void tegra2_super_clk_init(struct clk *c)\n+{\n+\tu32 val;\n+\tint source;\n+\tint shift;\n+\tconst struct clk_mux_sel *sel;\n+\tval = clk_readl(c->reg + SUPER_CLK_MUX);\n+\tc->state = ON;\n+\tBUG_ON(((val & SUPER_STATE_MASK) != SUPER_STATE_RUN) &&\n+\t\t((val & SUPER_STATE_MASK) != SUPER_STATE_IDLE));\n+\tshift = ((val & SUPER_STATE_MASK) == SUPER_STATE_IDLE) ?\n+\t\tSUPER_IDLE_SOURCE_SHIFT : SUPER_RUN_SOURCE_SHIFT;\n+\tsource = (val >> shift) & SUPER_SOURCE_MASK;\n+\tpr_info(\""%s %s %d\\n\"", __func__, c->name, source);\n+\tfor (sel = c->inputs; sel->input != NULL; sel++) {\n+\t\tif (sel->value == source)\n+\t\t\tbreak;\n+\t}\n+\tBUG_ON(sel->input == NULL);\n+\tc->parent = sel->input;\n+\ttegra2_clk_recalculate_rate(c);\n+}\n+\n+static int tegra2_super_clk_enable(struct clk *c)\n+{\n+\tclk_writel(0, c->reg + SUPER_CLK_DIVIDER);\n+\treturn 0;\n+}\n+\n+static void tegra2_super_clk_disable(struct clk *c)\n+{\n+\tpr_debug(\""%s on clock %s\\n\"", __func__, c->name);\n+\n+\t/* oops - don't disable the CPU clock! */\n+\tBUG();\n+}\n+\n+static int tegra2_super_clk_set_parent(struct clk *c, struct clk *p)\n+{\n+\tu32 val;\n+\tconst struct clk_mux_sel *sel;\n+\tint shift;\n+\tval = clk_readl(c->reg + SUPER_CLK_MUX);;\n+\tBUG_ON(((val & SUPER_STATE_MASK) != SUPER_STATE_RUN) &&\n+\t\t((val & SUPER_STATE_MASK) != SUPER_STATE_IDLE));\n+\tshift = ((val & SUPER_STATE_MASK) == SUPER_STATE_IDLE) ?\n+\t\tSUPER_IDLE_SOURCE_SHIFT : SUPER_RUN_SOURCE_SHIFT;\n+\tfor (sel = c->inputs; sel->input != NULL; sel++) {\n+\t\tif (sel->input == p) {\n+\t\t\tc->parent = p;\n+\t\t\tval &= ~(SUPER_SOURCE_MASK << shift);\n+\t\t\tval |= sel->value << shift;\n+\t\t\tclk_writel(val, c->reg);\n+\t\t\tc->rate = clk_get_rate(c->parent);\n+\t\t\treturn 0;\n+\t\t}\n+\t}\n+\treturn -EINVAL;\n+}\n+\n+static struct clk_ops tegra_super_ops = {\n+\t.init     = tegra2_super_clk_init,\n+\t.enable   = tegra2_super_clk_enable,\n+\t.disable  = tegra2_super_clk_disable,\n+\t.set_parent = tegra2_super_clk_set_parent,\n+\t.recalculate_rate = tegra2_clk_recalculate_rate,\n+};\n+\n+/* bus clock functions */\n+static void tegra2_bus_clk_init(struct clk *c)\n+{\n+\tu32 val = clk_readl(c->reg);\n+\tc->state = ((val >> c->reg_shift) & BUS_CLK_DISABLE) ? OFF : ON;\n+\tc->div = ((val >> c->reg_shift) & BUS_CLK_DIV_MASK) + 1;\n+\tc->mul = 1;\n+\ttegra2_clk_recalculate_rate(c);\n+}\n+\n+static int tegra2_bus_clk_enable(struct clk *c)\n+{\n+\tu32 val = clk_readl(c->reg);\n+\tval &= ~(BUS_CLK_DISABLE << c->reg_shift);\n+\tclk_writel(val, c->reg);\n+\treturn 0;\n+}\n+\n+static void tegra2_bus_clk_disable(struct clk *c)\n+{\n+\tu32 val = clk_readl(c->reg);\n+\tval |= BUS_CLK_DISABLE << c->reg_shift;\n+\tclk_writel(val, c->reg);\n+}\n+\n+static int tegra2_bus_clk_set_rate(struct clk *c, unsigned long rate)\n+{\n+\tu32 val = clk_readl(c->reg);\n+\tunsigned long parent_rate = clk_get_rate(c->parent);\n+\tint i;\n+\tfor (i = 1; i <= 4; i++) {\n+\t\tif (rate == parent_rate / i) {\n+\t\t\tval &= ~(BUS_CLK_DIV_MASK << c->reg_shift);\n+\t\t\tval |= (i - 1) << c->reg_shift;\n+\t\t\tclk_writel(val, c->reg);\n+\t\t\tc->div = i;\n+\t\t\tc->mul = 1;\n+\t\t\treturn 0;\n+\t\t}\n+\t}\n+\treturn -EINVAL;\n+}\n+\n+static struct clk_ops tegra_bus_ops = {\n+\t.init     = tegra2_bus_clk_init,\n+\t.enable   = tegra2_bus_clk_enable,\n+\t.disable  = tegra2_bus_clk_disable,\n+\t.set_rate = tegra2_bus_clk_set_rate,\n+\t.recalculate_rate = tegra2_clk_recalculate_rate,\n+};\n+\n /* PLL Functions */\n+static unsigned long tegra2_pll_clk_recalculate_rate(struct clk* c)\n+{\n+\tu64 rate;\n+\trate = c->parent->rate;\n+\trate *= c->n;\n+\tdo_div(rate, c->m);\n+\tif (c->p == 2)\n+\t\trate >>= 1;\n+\tc->rate = rate;\n+\treturn c->rate;\n+}\n+\n+static void tegra2_pll_clk_init(struct clk *c)\n+{\n+\tu32 val = clk_readl(c->reg + PLL_BASE);\n+\n+\tc->state = (val & PLL_BASE_ENABLE) ? ON : OFF;\n+\n+\tif (c->flags & PLL_FIXED && !(val & PLL_BASE_OVERRIDE)) {\n+\t\tpr_warning(\""Clock %s has unknown fixed frequency\\n\"", c->name);\n+\t\tc->n = 1;\n+\t\tc->m = 0;\n+\t\tc->p = 1;\n+\t} else if (val & PLL_BASE_BYPASS) {\n+\t\tc->n = 1;\n+\t\tc->m = 1;\n+\t\tc->p = 1;\n+\t} else {\n+\t\tc->n = (val & PLL_BASE_DIVN_MASK) >> PLL_BASE_DIVN_SHIFT;\n+\t\tc->m = (val & PLL_BASE_DIVM_MASK) >> PLL_BASE_DIVM_SHIFT;\n+\t\tc->p = (val & PLL_BASE_DIVP_MASK) ? 2 : 1;\n+\t}\n+\n+\tval = clk_readl(c->reg + PLL_MISC);\n+\tif (c->flags & PLL_HAS_CPCON)\n+\t\tc->cpcon = (val & PLL_MISC_CPCON_MASK) >> PLL_MISC_CPCON_SHIFT;\n+\n+\ttegra2_pll_clk_recalculate_rate(c);\n+}\n+\n static int tegra2_pll_clk_set_rate(struct clk *c, unsigned long rate)\n {\n \tu32 val;\n@@ -247,12 +450,38 @@ static void tegra2_pll_clk_disable(struct clk *c)\n }\n \n static struct clk_ops tegra_pll_ops = {\n+\t.init     = tegra2_pll_clk_init,\n \t.enable   = tegra2_pll_clk_enable,\n \t.disable  = tegra2_pll_clk_disable,\n \t.set_rate = tegra2_pll_clk_set_rate,\n+\t.recalculate_rate = tegra2_pll_clk_recalculate_rate,\n };\n \n /* Clock divider ops */\n+static void tegra2_pll_div_clk_init(struct clk *c)\n+{\n+\tu32 val = clk_readl(c->reg);\n+\tu32 divu71;\n+\tval >>= c->reg_shift;\n+\tc->state = (val & PLL_OUT_CLKEN) ? ON : OFF;\n+\tif (!(val & PLL_OUT_RESET_DISABLE))\n+\t\tc->state = OFF;\n+\n+\tif (c->flags & DIV_U71) {\n+\t\tdivu71 = (val & PLL_OUT_RATIO_MASK) >> PLL_OUT_RATIO_SHIFT;\n+\t\tc->div = (divu71 + 2);\n+\t\tc->mul = 2;\n+\t} else if (c->flags & DIV_2) {\n+\t\tc->div = 2;\n+\t\tc->mul = 1;\n+\t} else {\n+\t\tc->div = 1;\n+\t\tc->mul = 1;\n+\t}\n+\n+\ttegra2_clk_recalculate_rate(c);\n+}\n+\n static int tegra2_pll_div_clk_enable(struct clk *c)\n {\n \tu32 val;\n@@ -326,10 +555,9 @@ static int tegra2_pll_div_clk_set_rate(struct clk *c, unsigned long rate)\n \t\t\tval = clk_readl(c->reg);\n \t\t\tnew_val = val >> c->reg_shift;\n \t\t\tnew_val &= 0xFFFF;\n-\n \t\t\tif (c->flags & DIV_U71_FIXED)\n \t\t\t\tnew_val |= PLL_OUT_OVERRIDE;\n-\t\t\tnew_val &= PLL_OUT_RATIO_MASK;\n+\t\t\tnew_val &= ~PLL_OUT_RATIO_MASK;\n \t\t\tnew_val |= divider_u71 << PLL_OUT_RATIO_SHIFT;\n \n \t\t\tval &= ~(0xFFFF << c->reg_shift);\n@@ -337,7 +565,6 @@ static int tegra2_pll_div_clk_set_rate(struct clk *c, unsigned long rate)\n \t\t\tclk_writel(val, c->reg);\n \t\t\tspin_unlock_irqrestore(&clk_reg_lock, flags);\n \t\t\tc->rate = rate;\n-\t\t\tprintk(\""set to %lu\\n\"", c->rate);\n \t\t\treturn 0;\n \t\t}\n \t} else if (c->flags & DIV_2) {\n@@ -351,19 +578,21 @@ static int tegra2_pll_div_clk_set_rate(struct clk *c, unsigned long rate)\n \n \n static struct clk_ops tegra_pll_div_ops = {\n+\t.init     = tegra2_pll_div_clk_init,\n \t.enable   = tegra2_pll_div_clk_enable,\n \t.disable  = tegra2_pll_div_clk_disable,\n \t.set_rate = tegra2_pll_div_clk_set_rate,\n+\t.recalculate_rate = tegra2_clk_recalculate_rate,\n };\n \n /* Periph clk ops */\n+\n static void tegra2_periph_clk_init(struct clk *c)\n {\n-\tu32 val;\n+\tu32 val = clk_readl(c->reg);\n \tconst struct clk_mux_sel *mux = 0;\n \tconst struct clk_mux_sel *sel;\n \tif (c->flags & MUX) {\n-\t\tval = clk_readl(c->reg);\n \t\tfor (sel = c->inputs; sel->input != NULL; sel++) {\n \t\t\tif (val >> PERIPH_CLK_SOURCE_SHIFT == sel->value)\n \t\t\t\tmux = sel;\n@@ -374,29 +603,53 @@ static void tegra2_periph_clk_init(struct clk *c)\n \t} else {\n \t\tc->ops->set_parent(c, c->inputs[0].input);\n \t}\n+\n+\tif (c->flags & DIV_U71) {\n+\t\tu32 divu71 = val & PERIPH_CLK_SOURCE_DIV_MASK;\n+\t\tc->div = divu71 + 2;\n+\t\tc->mul = 2;\n+\t} else {\n+\t\tc->div = 1;\n+\t\tc->mul = 1;\n+\t}\n+\n+\tc->state = ON;\n+\tif (!(clk_readl(CLK_OUT_ENB + PERIPH_CLK_TO_ENB_REG(c)) &\n+\t\t\tPERIPH_CLK_TO_ENB_BIT(c)))\n+\t\tc->state = OFF;\n+\tif (!(c->flags & PERIPH_NO_RESET))\n+\t\tif (clk_readl(RST_DEVICES + PERIPH_CLK_TO_ENB_REG(c)) &\n+\t\t\t\tPERIPH_CLK_TO_ENB_BIT(c))\n+\t\t\tc->state = OFF;\n+\ttegra2_clk_recalculate_rate(c);\n }\n \n static int tegra2_periph_clk_enable(struct clk *c)\n {\n-\tu32 val = (1<<(c->clk_num%32));\n-\tunsigned long reg = (c->clk_num / 32) * 8;\n-\n+\tu32 val;\n \tpr_debug(\""%s on clock %s\\n\"", __func__, c->name);\n \n-\tclk_writel(val, CLK_OUT_ENB_SET + reg);\n-\tclk_writel(val, RST_DEVICES_CLR + reg);\n+\tclk_writel(PERIPH_CLK_TO_ENB_BIT(c),\n+\t\tCLK_OUT_ENB_SET + PERIPH_CLK_TO_ENB_SET_REG(c));\n+\tif (!(c->flags & PERIPH_NO_RESET))\n+\t\tclk_writel(PERIPH_CLK_TO_ENB_BIT(c),\n+\t\t\tRST_DEVICES_CLR + PERIPH_CLK_TO_ENB_SET_REG(c));\n+\tif (c->flags & PERIPH_EMC_ENB) {\n+\t\t/* The EMC peripheral clock has 2 extra enable bits */\n+\t\t/* FIXME: Do they need to be disabled? */\n+\t\tval = clk_readl(c->reg);\n+\t\tval |= 0x3 << 24;\n+\t\tclk_writel(val, c->reg);\n+\t}\n \treturn 0;\n }\n \n static void tegra2_periph_clk_disable(struct clk *c)\n {\n-\tu32 val = (1<<(c->clk_num%32));\n-\tunsigned long reg = (c->clk_num / 32) * 8;\n-\n \tpr_debug(\""%s on clock %s\\n\"", __func__, c->name);\n \n-\tclk_writel(val, CLK_OUT_ENB_CLR + reg);\n-\tclk_writel(val, RST_DEVICES_SET + reg);\n+\tclk_writel(PERIPH_CLK_TO_ENB_BIT(c),\n+\t\tCLK_OUT_ENB_CLR + PERIPH_CLK_TO_ENB_SET_REG(c));\n }\n \n static int tegra2_periph_clk_set_parent(struct clk *c, struct clk *p)\n@@ -456,36 +709,40 @@ static int tegra2_periph_clk_set_rate(struct clk *c, unsigned long rate)\n \treturn -EINVAL;\n }\n \n-static unsigned long tegra2_periph_clk_recalculate_rate(struct clk* c)\n-{\n-\t/* FIXME: Divide by U71 divider value */\n-\tc->rate = c->parent->rate;\n-\tpr_debug(\""%s: %lu\\n\"", c->name, c->rate);\n-\treturn c->rate;\n-}\n-\n static struct clk_ops tegra_periph_clk_ops = {\n \t.init       = &tegra2_periph_clk_init,\n \t.enable     = &tegra2_periph_clk_enable,\n \t.disable    = &tegra2_periph_clk_disable,\n \t.set_parent = &tegra2_periph_clk_set_parent,\n \t.set_rate   = &tegra2_periph_clk_set_rate,\n-\t.recalculate_rate = &tegra2_periph_clk_recalculate_rate,\n+\t.recalculate_rate = &tegra2_clk_recalculate_rate,\n+};\n+\n+/* Clock doubler ops */\n+static void tegra2_clk_double_init(struct clk *c) {\n+\tc->mul = 2;\n+\tc->div = 1;\n+\tc->state = ON;\n+\tif (!(clk_readl(CLK_OUT_ENB + PERIPH_CLK_TO_ENB_REG(c)) &\n+\t\t\tPERIPH_CLK_TO_ENB_BIT(c)))\n+\t\tc->state = OFF;\n+\ttegra2_clk_recalculate_rate(c);\n };\n \n+static struct clk_ops tegra_clk_double_ops = {\n+\t.init       = &tegra2_clk_double_init,\n+\t.enable     = &tegra2_periph_clk_enable,\n+\t.disable    = &tegra2_periph_clk_disable,\n+\t.recalculate_rate = &tegra2_clk_recalculate_rate,\n+};\n+\n+/* Clock definitions */\n static struct clk tegra_clk_32k = {\n \t.name = \""tegra_clk_32k\"",\n \t.rate = 32678,\n \t.ops  = NULL,\n };\n \n-static struct clk tegra_clk_input = {\n-\t.name = \""tegra_clk_input\"",\n-\t.flags = ENABLE_ON_INIT,\n-\t.rate = 12000000,\n-\t.ops = NULL,\n-};\n-\n static struct clk_pll_table tegra_pll_s_table[] = {\n \t{32768, 12000000, 366, 1, 1, 0},\n \t{32768, 13000000, 397, 1, 1, 0},\n@@ -754,6 +1011,85 @@ static struct clk tegra_pll_x = {\n \t.pll_table = tegra_pll_x_table,\n };\n \n+static struct clk tegra_clk_d = {\n+\t.name      = \""tegra_clk_d\"",\n+\t.flags     = PERIPH_NO_RESET,\n+\t.ops       = &tegra_clk_double_ops,\n+\t.clk_num   = 90,\n+\t.reg       = 0x34,\n+\t.reg_shift = 12,\n+\t.parent    = &tegra_clk_m,\n+};\n+\n+/* FIXME: need tegra_audio\n+static struct clk tegra_clk_audio_2x = {\n+\t.name      = \""tegra_clk_d\"",\n+\t.flags     = PERIPH_NO_RESET,\n+\t.ops       = &tegra_clk_double_ops,\n+\t.clk_num   = 89,\n+\t.reg       = 0x34,\n+\t.reg_shift = 8,\n+\t.parent    = &tegra_audio,\n+}\n+*/\n+\n+static struct clk_mux_sel mux_cclk[] = {\n+\t{ .input = &tegra_clk_m,\t.value = 0},\n+\t{ .input = &tegra_pll_c,\t.value = 1},\n+\t{ .input = &tegra_clk_32k,\t.value = 2},\n+\t{ .input = &tegra_pll_m,\t.value = 3},\n+\t{ .input = &tegra_pll_p,\t.value = 4},\n+\t{ .input = &tegra_pll_p_out4,\t.value = 5},\n+\t{ .input = &tegra_pll_p_out3,\t.value = 6},\n+\t{ .input = &tegra_clk_d,\t.value = 7},\n+\t{ .input = &tegra_pll_x,\t.value = 8},\n+\t{ 0, 0},\n+};\n+\n+static struct clk_mux_sel mux_sclk[] = {\n+\t{ .input = &tegra_clk_m,\t.value = 0},\n+\t{ .input = &tegra_pll_c_out1,\t.value = 1},\n+\t{ .input = &tegra_pll_p_out4,\t.value = 2},\n+\t{ .input = &tegra_pll_p_out3,\t.value = 3},\n+\t{ .input = &tegra_pll_p_out2,\t.value = 4},\n+\t{ .input = &tegra_clk_d,\t.value = 5},\n+\t{ .input = &tegra_clk_32k,\t.value = 6},\n+\t{ .input = &tegra_pll_m_out1,\t.value = 7},\n+\t{ 0, 0},\n+};\n+\n+static struct clk tegra_clk_cpu = {\n+\t.name\t= \""cpu\"",\n+\t.inputs\t= mux_cclk,\n+\t.reg\t= 0x20,\n+\t.ops\t= &tegra_super_ops,\n+};\n+\n+static struct clk tegra_clk_sys = {\n+\t.name\t= \""sys\"",\n+\t.inputs\t= mux_sclk,\n+\t.reg\t= 0x28,\n+\t.ops\t= &tegra_super_ops,\n+};\n+\n+static struct clk tegra_clk_hclk = {\n+\t.name\t\t= \""hclk\"",\n+\t.flags\t\t= DIV_BUS,\n+\t.parent\t\t= &tegra_clk_sys,\n+\t.reg\t\t= 0x30,\n+\t.reg_shift\t= 4,\n+\t.ops\t\t= &tegra_bus_ops,\n+};\n+\n+static struct clk tegra_clk_pclk = {\n+\t.name\t\t= \""pclk\"",\n+\t.flags\t\t= DIV_BUS,\n+\t.parent\t\t= &tegra_clk_hclk,\n+\t.reg\t\t= 0x30,\n+\t.reg_shift\t= 0,\n+\t.ops\t\t= &tegra_bus_ops,\n+};\n+\n static struct clk_mux_sel mux_pllm_pllc_pllp_plla[] = {\n \t{ .input = &tegra_pll_m, .value = 0},\n \t{ .input = &tegra_pll_c, .value = 1},\n@@ -762,6 +1098,14 @@ static struct clk_mux_sel mux_pllm_pllc_pllp_plla[] = {\n \t{ 0, 0},\n };\n \n+static struct clk_mux_sel mux_pllm_pllc_pllp_clkm[] = {\n+\t{ .input = &tegra_pll_m, .value = 0},\n+\t{ .input = &tegra_pll_c, .value = 1},\n+\t{ .input = &tegra_pll_p, .value = 2},\n+\t{ .input = &tegra_clk_m, .value = 3},\n+\t{ 0, 0},\n+};\n+\n static struct clk_mux_sel mux_pllp_pllc_pllm_clkm[] = {\n \t{ .input = &tegra_pll_p, .value = 0},\n \t{ .input = &tegra_pll_c, .value = 1},\n@@ -834,7 +1178,7 @@ static struct clk_mux_sel mux_clk_32k[] = {\n \t}\n \n struct clk tegra_periph_clks[] = {\n-\tPERIPH_CLK(\""rtc\"",       \""rtc-tegra\"",  NULL,   4,  0,     mux_clk_32k,                    0),\n+\tPERIPH_CLK(\""rtc\"",       \""rtc-tegra\"",  NULL,   4,  0,     mux_clk_32k,                    PERIPH_NO_RESET),\n \tPERIPH_CLK(\""timer\"",     \""timer\"",      NULL,   5,  0,     mux_clk_m,                      0),\n \tPERIPH_CLK(\""i2s1\"",      \""i2s.0\"",      NULL,   11, 0x100, mux_plla_audio_pllp_clkm,       MUX | DIV_U71),\n \tPERIPH_CLK(\""i2s2\"",      \""i2s.1\"",      NULL,   18, 0x104, mux_plla_audio_pllp_clkm,       MUX | DIV_U71),\n@@ -871,7 +1215,7 @@ struct clk tegra_periph_clks[] = {\n \tPERIPH_CLK(\""i2c1_i2c\"",  \""tegra-i2c.0\"",      \""i2c\"",  0, 0, mux_pllp_out3,        0),\n \tPERIPH_CLK(\""i2c2_i2c\"",  \""tegra-i2c.1\"",      \""i2c\"",  0, 0, mux_pllp_out3,        0),\n \tPERIPH_CLK(\""i2c3_i2c\"",  \""tegra-i2c.2\"",      \""i2c\"",  0, 0, mux_pllp_out3,        0),\n-\tPERIPH_CLK(\""dvc_i2c\"",   \""tegra-i2c.3\"",      \""i2c\"",  0, 0, mux_pllp_out3,        MUX | DIV_U71),\n+\tPERIPH_CLK(\""dvc_i2c\"",   \""tegra-i2c.3\"",      \""i2c\"",  0, 0, mux_pllp_out3,        0),\n \tPERIPH_CLK(\""uarta\"",     \""uart.0\"",     NULL,   6,  0x178, mux_pllp_pllc_pllm_clkm,        MUX | DIV_U71),\n \tPERIPH_CLK(\""uartb\"",     \""uart.1\"",     NULL,   7,  0x17c, mux_pllp_pllc_pllm_clkm,        MUX | DIV_U71),\n \tPERIPH_CLK(\""uartc\"",     \""uart.2\"",     NULL,   55, 0x1a0, mux_pllp_pllc_pllm_clkm,        MUX | DIV_U71),\n@@ -895,6 +1239,7 @@ struct clk tegra_periph_clks[] = {\n \tPERIPH_CLK(\""usbd\"",      \""fsl-tegra-udc\"",      NULL,   22, 0,     mux_clk_m,                    0),\n \tPERIPH_CLK(\""usb2\"",      \""usb.1\"",      NULL,   58, 0,     mux_clk_m,                              0),\n \tPERIPH_CLK(\""usb3\"",      \""usb.2\"",      NULL,   59, 0,     mux_clk_m,                              0),\n+\tPERIPH_CLK(\""emc\"",       \""emc\"",        NULL,   57, 0x19c, mux_pllm_pllc_pllp_clkm,        MUX | DIV_U71 | PERIPH_EMC_ENB),\n };\n \n #define CLK_DUPLICATE(_name, _dev, _con) \\\n@@ -927,7 +1272,6 @@ struct clk_duplicate tegra_clk_duplicates[] = {\n \n struct clk_lookup tegra_clk_lookups[] = {\n \t/* external root sources */\n-\tCLK(NULL, \""input_clk\"",  &tegra_clk_input),\n \tCLK(NULL, \""32k_clk\"", &tegra_clk_32k),\n \tCLK(NULL, \""pll_s\"", &tegra_pll_s),\n \tCLK(NULL, \""clk_m\"", &tegra_clk_m),\n@@ -946,6 +1290,11 @@ struct clk_lookup tegra_clk_lookups[] = {\n \tCLK(NULL, \""pll_d_out0\"", &tegra_pll_d_out0),\n \tCLK(NULL, \""pll_u\"",      &tegra_pll_u),\n \tCLK(NULL, \""pll_x\"",      &tegra_pll_x),\n+\tCLK(NULL, \""cpu\"",\t&tegra_clk_cpu),\n+\tCLK(NULL, \""sys\"",\t&tegra_clk_sys),\n+\tCLK(NULL, \""hclk\"",\t&tegra_clk_hclk),\n+\tCLK(NULL, \""pclk\"",\t&tegra_clk_pclk),\n+\tCLK(NULL, \""clk_d\"", \t&tegra_clk_d),\n };\n \n void tegra2_init_clocks(void)\n""}","bug, refactor 
"
15504,vchtchetkine,Add ui_core_protocol.* to simulate UI->Core exchange.,"['android/qemulator.c', 'android/ui_core_protocol.c', 'android/ui_core_protocol.h', 'Makefile.android']","Add ui_core_protocol.* to simulate UI->Core exchange.

Change-Id: I969bb097fcd9be55d83368ddee0e377a0f0af896",https://android-review.googlesource.com/c/15504,"feature 
",feature;,Feature;,"{""Makefile.android"": ""@@ -604,6 +604,7 @@ endif\n #\n CORE_MISC_SOURCES = android/boot-properties.c \\\n                     android/hw-kmsg.c \\\n+                    android/hw-lcd.c \\\n \n ifeq ($(HOST_ARCH),x86)\n     CORE_MISC_SOURCES += i386-dis.c\n@@ -628,6 +629,8 @@ endif\n \n CORE_SOURCES = $(CORE_BLOCK_SOURCES) $(CORE_HW_SOURCES)\n CORE_SOURCES += $(CORE_MIGRATION_SOURCES) $(CORE_MISC_SOURCES)\n+# temp file used to collect UI->Core exchange protocol.\n+CORE_SOURCES += android/ui_core_protocol.c\n \n ##############################################################################\n # lists of source files used to build the emulator UI\n@@ -638,7 +641,6 @@ UI_SOURCES = android/user-config.c \\\n              android/charmap.c \\\n              android/qemulator.c \\\n              android/keycode.c \\\n-             android/hw-lcd.c \\\n \n ##############################################################################\n # now build the emulator itself\n"", ""qemulator.c"": ""@@ -15,6 +15,7 @@\n #include \""android/utils/bufprint.h\""\n #include \""android/globals.h\""\n #include \""android/qemulator.h\""\n+#include \""android/ui_core_protocol.h\""\n \n #define  D(...)  do {  if (VERBOSE_CHECK(init)) dprint(__VA_ARGS__); } while (0)\n static double get_default_scale( AndroidOptions*  opts );\n@@ -230,7 +231,7 @@ qemulator_set_title(QEmulator* emulator)\n int\n get_device_dpi( AndroidOptions*  opts )\n {\n-    int    dpi_device  = android_hw->hw_lcd_density;\n+    int    dpi_device  = core_get_android_hw_lcd_density();\n \n     if (opts->dpi_device != NULL) {\n         char*  end;\n"", ""ui_core_protocol.c"": ""@@ -0,0 +1,29 @@\n+/* Copyright (C) 2010 The Android Open Source Project\n+**\n+** This software is licensed under the terms of the GNU General Public\n+** License version 2, as published by the Free Software Foundation, and\n+** may be copied, distributed, and modified under those terms.\n+**\n+** This program is distributed in the hope that it will be useful,\n+** but WITHOUT ANY WARRANTY; without even the implied warranty of\n+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+** GNU General Public License for more details.\n+*/\n+\n+/*\n+ * This file contains helper routines that are used to establish communication\n+ * between UI and Core components of the emulator. This is a temporary file\n+ * where we will collect functional dependencies between UI and Core in the\n+ * process of separating UI and Core in the emulator build. Ideally at the\n+ * end this will be replaced with a message protocol over sockets, or other\n+ * means of interprocess communication.\n+ */\n+\n+#include \""android/globals.h\""\n+#include \""android/ui_core_protocol.h\""\n+\n+int\n+core_get_android_hw_lcd_density(void)\n+{\n+    return android_hw->hw_lcd_density;\n+}\n"", ""ui_core_protocol.h"": ""@@ -0,0 +1,19 @@\n+/* Copyright (C) 2010 The Android Open Source Project\n+**\n+** This software is licensed under the terms of the GNU General Public\n+** License version 2, as published by the Free Software Foundation, and\n+** may be copied, distributed, and modified under those terms.\n+**\n+** This program is distributed in the hope that it will be useful,\n+** but WITHOUT ANY WARRANTY; without even the implied warranty of\n+** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+** GNU General Public License for more details.\n+*/\n+\n+#ifndef QEMU_ANDROID_UI_CORE_PROTOCOL_H\n+#define QEMU_ANDROID_UI_CORE_PROTOCOL_H\n+\n+/* Gets LCD density property from the core properties. */\n+int core_get_android_hw_lcd_density(void);\n+\n+#endif  // QEMU_ANDROID_UI_CORE_PROTOCOL_H\n""}","feature 
"
14393,Rebecca Zavin,media: video: isp: Enable/disable the isp interrupt when turning on/off clocks,['drivers/media/video/isp/isp.c'],"media: video: isp: Enable/disable the isp interrupt when turning on/off clocks

Without this patch an irq can occur while the clocks are off, in that
case the interrupt handler tries to access resources that aren't being
clocked.

Change-Id: I08f6ffc1e1a4fa0f96d7031800c1feb421be5b4a
Signed-off-by: Rebecca Schultz Zavin <rebecca@android.com>",https://android-review.googlesource.com/c/14393,"bug 
",bug,Deprecat;,"{""isp.c"": ""@@ -2516,6 +2516,7 @@ int isp_get(void)\n \t\t\tisp_restore_ctx();\n \t\telse\n \t\t\thas_context = 1;\n+\t\tenable_irq(omap3isp->irq);\n \t}\n \tisp_obj.ref_count++;\n \tmutex_unlock(&(isp_obj.isp_mutex));\n@@ -2543,6 +2544,7 @@ int isp_put(void)\n \tmutex_lock(&(isp_obj.isp_mutex));\n \tif (isp_obj.ref_count) {\n \t\tif (--isp_obj.ref_count == 0) {\n+\t\t\tdisable_irq_nosync(omap3isp->irq);\n \t\t\tisp_save_ctx();\n \t\t\tisp_release_resources();\n \t\t\tisp_obj.module.isp_pipeline = 0;\n""}","bug, feature 
"
16806,Jean-Baptiste Queru,Fix a monkey crash when the new WebView is destroyed.,"['core/java/android/webkit/BrowserFrame.java', 'core/java/android/webkit/CallbackProxy.java']","Fix a monkey crash when the new WebView is destroyed.

Grab the WebViewCore immediately so that if the Tab is destroyed, we have the
old WebViewCore object and can return the BrowserFrame.

Bug: 2733004
Change-Id: Ic3e4c5417f2165f412f60f05aea3ed403d8cecfd",https://android-review.googlesource.com/c/16806,"bug 
",bug,Bug;,"{""BrowserFrame.java"": ""@@ -785,11 +785,7 @@ class BrowserFrame extends Handler {\n      * @return The BrowserFrame object stored in the new WebView.\n      */\n     private BrowserFrame createWindow(boolean dialog, boolean userGesture) {\n-        WebView w = mCallbackProxy.createWindow(dialog, userGesture);\n-        if (w != null) {\n-            return w.getWebViewCore().getBrowserFrame();\n-        }\n-        return null;\n+        return mCallbackProxy.createWindow(dialog, userGesture);\n     }\n \n     /**\n"", ""CallbackProxy.java"": ""@@ -1098,7 +1098,7 @@ class CallbackProxy extends Handler {\n         }\n     }\n \n-    public WebView createWindow(boolean dialog, boolean userGesture) {\n+    public BrowserFrame createWindow(boolean dialog, boolean userGesture) {\n         // Do an unsynchronized quick check to avoid posting if no callback has\n         // been set.\n         if (mWebChromeClient == null) {\n@@ -1122,9 +1122,15 @@ class CallbackProxy extends Handler {\n \n         WebView w = transport.getWebView();\n         if (w != null) {\n-            w.getWebViewCore().initializeSubwindow();\n+            WebViewCore core = w.getWebViewCore();\n+            // If WebView.destroy() has been called, core may be null.  Skip\n+            // initialization in that case and return null.\n+            if (core != null) {\n+                core.initializeSubwindow();\n+                return core.getBrowserFrame();\n+            }\n         }\n-        return w;\n+        return null;\n     }\n \n     public void onRequestFocus() {\n""}","bug 
"
10852,Arve HjÃ¸nnevÃ¥g,Input: gpio_input: Fix keys with keycode 0x100-0x1ff,['drivers/input/misc/gpio_matrix.c'],"Input: gpio_input: Fix keys with keycode 0x100-0x1ff

KEY_MAX is no longer a power of 2.

Signed-off-by: Arve HjÃ¸nnevÃ¥g <arve@android.com>",https://android-review.googlesource.com/c/10852,"bug
",bug,Bug;,"{""gpio_matrix.c"": ""@@ -315,9 +315,8 @@ int gpio_event_matrix_func(struct input_dev *input_dev,\n \t\tkp->keypad_info = mi;\n \t\tset_bit(EV_KEY, input_dev->evbit);\n \t\tfor (i = 0; i < key_count; i++) {\n-\t\t\tif (mi->keymap[i])\n-\t\t\t\tset_bit(mi->keymap[i] & KEY_MAX,\n-\t\t\t\t\tinput_dev->keybit);\n+\t\t\tif (mi->keymap[i] && mi->keymap[i] <= KEY_MAX)\n+\t\t\t\tset_bit(mi->keymap[i], input_dev->keybit);\n \t\t}\n \n \t\tfor (i = 0; i < mi->noutputs; i++) {\n""}","feature 
"
21658,Xavier Ducrohet,Make the feature require Eclipse 3.5,"['eclipse/features/com.android.ide.eclipse.adt/feature.xml', 'eclipse/sites/internal/.gitignore', 'eclipse/features/com.android.ide.eclipse.hierarchyviewer/feature.xml', 'eclipse/features/com.android.ide.eclipse.ddms/feature.xml', 'eclipse/features/com.android.ide.eclipse.traceview/feature.xml']","Make the feature require Eclipse 3.5

Change-Id: Idcc1ae2566e41656327190053e8e0ea22264d31d",https://android-review.googlesource.com/c/21658,"feature 
",resource,Resource;,"{""feature.xml"": ""@@ -223,7 +223,7 @@\n    </url>\n \n    <requires>\n-      <import plugin=\""org.eclipse.ui\""/>\n+      <import plugin=\""org.eclipse.ui\"" version=\""3.5\"" match=\""greaterOrEqual\""/>\n       <import plugin=\""org.eclipse.core.runtime\""/>\n       <import plugin=\""org.eclipse.ui.ide\""/>\n       <import plugin=\""com.android.ide.eclipse.ddms\"" version=\""10.0.0\"" match=\""greaterOrEqual\""/>\n"", "".gitignore"": ""@@ -0,0 +1,2 @@\n+*.jar\n+*/*.jar\n\\ No newline at end of file\n""}","feature 
"
31015,Jim Huang,res_send: Avoid spurious close()s and (rare) failure,['libc/netbsd/resolv/res_send.c'],"res_send: Avoid spurious close()s and (rare) failure

When looping over the current list of sockets we are connected to,
use getpeername() not getsockname() to find out who the remote
end is.  This change avoids spurious close() and (rare) failure.

Origin: ISC bug #18625 and fixed in libbind 6.0

Change-Id: I5e85f9ff4b98c237978e4bf4bd85ba0a90d768e6",https://android-review.googlesource.com/c/31015,"bug 
",bug,Bug;,"{""res_send.c"": ""@@ -413,7 +413,7 @@ res_nsend(res_state statp,\n \t\t\t\tif (EXT(statp).nssocks[ns] == -1)\n \t\t\t\t\tcontinue;\n \t\t\t\tpeerlen = sizeof(peer);\n-\t\t\t\tif (getsockname(EXT(statp).nssocks[ns],\n+\t\t\t\tif (getpeername(EXT(statp).nssocks[ns],\n \t\t\t\t    (struct sockaddr *)(void *)&peer, &peerlen) < 0) {\n \t\t\t\t\tneedclose++;\n \t\t\t\t\tbreak;\n""}","bug 
"
24175,Brian Muramatsu,CTS Verifier XML Reports,"['apps/CtsVerifier/res/layout/main.xml', 'apps/CtsVerifier/res/values/styles.xml', 'apps/CtsVerifier/res/values/strings.xml', 'apps/CtsVerifier/src/com/android/cts/verifier/TestResultsReport.java', 'apps/CtsVerifier/src/com/android/cts/verifier/TestListActivity.java', 'apps/CtsVerifier/src/com/android/cts/verifier/Version.java', 'apps/CtsVerifier/AndroidManifest.xml', 'apps/CtsVerifier/src/com/android/cts/verifier/CtsVerifierActivity.java']","CTS Verifier XML Reports

1. Add a version name and code to the CTS Verifier. Show this
   info on the welcome screen.

2. Share a XML report instead of a plain text report.

Change-Id: I10d21b7ea4d468472fc15866d7259e456d6741a6",https://android-review.googlesource.com/c/24175,"**feature** 
",feature,Bug;Test;,"{""AndroidManifest.xml"": ""@@ -17,8 +17,8 @@\n \n <manifest xmlns:android=\""http://schemas.android.com/apk/res/android\""\n       package=\""com.android.cts.verifier\""\n-      android:versionCode=\""1\""\n-      android:versionName=\""1.0\"">\n+      android:versionCode=\""2\""\n+      android:versionName=\""2.3_r4\"">\n       \n     <uses-sdk android:minSdkVersion=\""5\""></uses-sdk>\n \n"", ""main.xml"": ""@@ -26,12 +26,21 @@\n         android:text=\""@string/continue_button_text\""\n         />\n     <TextView\n-        android:id=\""@+id/welcome_text\""\n+        android:id=\""@+id/version_text\""\n         android:gravity=\""center\""\n         android:layout_width=\""fill_parent\""\n         android:layout_height=\""wrap_content\""\n         android:layout_above=\""@+id/continue_button\""\n-        android:padding=\""10dip\""\n+        android:paddingBottom=\""10dip\""\n+        style=\""@style/VersionFont\""\n+        />\n+    <TextView\n+        android:id=\""@+id/welcome_text\""\n+        android:gravity=\""center\""\n+        android:layout_width=\""fill_parent\""\n+        android:layout_height=\""wrap_content\""\n+        android:layout_above=\""@+id/version_text\""\n+        android:paddingTop=\""10dip\""\n         android:text=\""@string/welcome_text\""\n         style=\""@style/WelcomeFont\""\n         />\n"", ""strings.xml"": ""@@ -16,6 +16,7 @@\n <resources>\n     <string name=\""app_name\"">CTS Verifier</string>\n     <string name=\""welcome_text\"">Welcome to the CTS Verifier!</string>\n+    <string name=\""version_text\"">%1$s (%2$d)</string>\n     <string name=\""continue_button_text\"">Continue</string>\n \n     <string name=\""pass_button_text\"">Pass</string>\n@@ -23,7 +24,7 @@\n     <string name=\""fail_button_text\"">Fail</string>\n \n     <!-- Strings for TestResultsReport -->\n-    <string name=\""subject_header\"">[CTS Verifier %1$s]</string>\n+    <string name=\""subject_header\"">CTS Verifier %1$s (%2$d) - %3$s</string>\n     <string name=\""body_header\"">CTS Verifier %1$s Test Results</string>\n     <string name=\""pass_result\"">PASS</string>\n     <string name=\""fail_result\"">FAIL</string>\n@@ -43,6 +44,7 @@\n     <string name=\""test_results_copied\"">Test results copied to clipboard.</string>\n     <string name=\""share\"">Share</string>\n     <string name=\""share_test_results\"">Share Test Results</string>\n+    <string name=\""test_results_error\"">Couldn\\'t create test results report.</string>\n \n     <!-- Strings for BluetoothActivity -->\n     <string name=\""bluetooth_test\"">Bluetooth Test</string>\n"", ""styles.xml"": ""@@ -3,4 +3,7 @@\n     <style name=\""WelcomeFont\"" parent=\""@android:style/TextAppearance.Large\"">\n         <item name=\""android:textColor\"">#9fbf3b</item>\n     </style>\n+    <style name=\""VersionFont\"" parent=\""@android:style/TextAppearance.Large\"">\n+        <item name=\""android:textColor\"">#ffffff</item>\n+    </style>\n </resources>\n\\ No newline at end of file\n"", ""CtsVerifierActivity.java"": ""@@ -20,8 +20,9 @@ import android.app.Activity;\n import android.content.Intent;\n import android.os.Bundle;\n import android.view.View;\n-import android.view.Window;\n import android.view.View.OnClickListener;\n+import android.view.Window;\n+import android.widget.TextView;\n \n /** {@link Activity} that displays an introduction to the verifier. */\n public class CtsVerifierActivity extends Activity {\n@@ -40,6 +41,11 @@ public class CtsVerifierActivity extends Activity {\n             }\n         };\n \n+        TextView versionText = (TextView) findViewById(R.id.version_text);\n+        versionText.setText(getString(R.string.version_text,\n+                Version.getVersionName(this),\n+                Version.getVersionCode(this)));\n+\n         findViewById(R.id.detective_logo).setOnClickListener(clickListener);\n         findViewById(R.id.continue_button).setOnClickListener(clickListener);\n     }\n"", ""TestListActivity.java"": ""@@ -22,6 +22,7 @@ import android.app.ListActivity;\n import android.content.Intent;\n import android.os.Bundle;\n import android.text.ClipboardManager;\n+import android.util.Log;\n import android.view.Menu;\n import android.view.MenuInflater;\n import android.view.MenuItem;\n@@ -29,10 +30,15 @@ import android.view.View;\n import android.widget.ListView;\n import android.widget.Toast;\n \n+import java.io.IOException;\n+\n /** {@link ListActivity} that displays a  list of manual tests. */\n public class TestListActivity extends ListActivity {\n \n+    private static final String TAG = TestListActivity.class.getSimpleName();\n+\n     private static final int LAUNCH_TEST_REQUEST_CODE = 1;\n+\n     private TestListAdapter mAdapter;\n \n     @Override\n@@ -109,19 +115,29 @@ public class TestListActivity extends ListActivity {\n     }\n \n     private void handleCopyItemSelected() {\n-        TestResultsReport report = new TestResultsReport(this, mAdapter);\n-        ClipboardManager clipboardManager = (ClipboardManager) getSystemService(CLIPBOARD_SERVICE);\n-        clipboardManager.setText(report.getBody());\n-        Toast.makeText(this, R.string.test_results_copied, Toast.LENGTH_SHORT).show();\n+        try {\n+            TestResultsReport report = new TestResultsReport(this, mAdapter);\n+            ClipboardManager clipboardManager = (ClipboardManager)\n+                    getSystemService(CLIPBOARD_SERVICE);\n+            clipboardManager.setText(report.getBody());\n+            Toast.makeText(this, R.string.test_results_copied, Toast.LENGTH_SHORT).show();\n+        } catch (IOException e) {\n+            Toast.makeText(this, R.string.test_results_error, Toast.LENGTH_SHORT).show();\n+            Log.e(TAG, \""Coudn't copy test results report\"", e);\n+        }\n     }\n \n     private void handleShareItemSelected() {\n-        Intent target = new Intent(Intent.ACTION_SEND);\n-        target.setType(\""text/plain\"");\n-\n-        TestResultsReport report = new TestResultsReport(this, mAdapter);\n-        target.putExtra(Intent.EXTRA_SUBJECT, report.getSubject());\n-        target.putExtra(Intent.EXTRA_TEXT, report.getBody());\n-        startActivity(Intent.createChooser(target, getString(R.string.share_test_results)));\n+        try {\n+            Intent target = new Intent(Intent.ACTION_SEND);\n+            TestResultsReport report = new TestResultsReport(this, mAdapter);\n+            target.setType(report.getType());\n+            target.putExtra(Intent.EXTRA_SUBJECT, report.getSubject());\n+            target.putExtra(Intent.EXTRA_TEXT, report.getBody());\n+            startActivity(Intent.createChooser(target, getString(R.string.share_test_results)));\n+        } catch (IOException e) {\n+            Toast.makeText(this, R.string.test_results_error, Toast.LENGTH_SHORT).show();\n+            Log.e(TAG, \""Coudn't share test results report\"", e);\n+        }\n     }\n }\n"", ""TestResultsReport.java"": ""@@ -18,90 +18,112 @@ package com.android.cts.verifier;\n \n import com.android.cts.verifier.TestListAdapter.TestListItem;\n \n+import org.xmlpull.v1.XmlSerializer;\n+\n import android.content.Context;\n-import android.content.pm.PackageInfo;\n-import android.content.pm.PackageManager;\n-import android.content.pm.PackageManager.NameNotFoundException;\n import android.os.Build;\n+import android.util.Xml;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n \n-/** Plain text report of the current test results. */\n+/** XML text report of the current test results. */\n class TestResultsReport {\n \n+    /** Version of the test report. Increment whenever adding new tags and attributes. */\n+    private static final int REPORT_VERSION = 1;\n+\n+    /** Format of the report's creation time. Maintain the same format at CTS. */\n+    private static DateFormat DATE_FORMAT =\n+            new SimpleDateFormat(\""EEE MMM dd HH:mm:ss z yyyy\"", Locale.ENGLISH);\n+\n+    private static final String TEST_RESULTS_REPORT_TAG = \""test-results-report\"";\n+    private static final String VERIFIER_INFO_TAG = \""verifier-info\"";\n+    private static final String DEVICE_INFO_TAG = \""device-info\"";\n+    private static final String BUILD_INFO_TAG = \""build-info\"";\n+    private static final String TEST_RESULTS_TAG = \""test-results\"";\n+    private static final String TEST_TAG = \""test\"";\n+\n     private final Context mContext;\n \n     private final TestListAdapter mAdapter;\n \n-    private final String mVersionName;\n-\n     TestResultsReport(Context context, TestListAdapter adapter) {\n         this.mContext = context;\n         this.mAdapter = adapter;\n-        this.mVersionName = getVersionName(context);\n     }\n \n-    private static String getVersionName(Context context) {\n-        try {\n-            PackageManager packageManager = context.getPackageManager();\n-            PackageInfo info = packageManager.getPackageInfo(context.getPackageName(), 0);\n-            return info.versionName;\n-        } catch (NameNotFoundException e) {\n-            throw new RuntimeException(\""Could not get find package information for \""\n-                    + context.getPackageName());\n-        }\n+    String getType() {\n+        return \""application/xml\"";\n     }\n \n     String getSubject() {\n-        return new StringBuilder()\n-                .append(mContext.getString(R.string.subject_header, mVersionName))\n-                .append(' ')\n-                .append(Build.FINGERPRINT)\n-                .toString();\n+        return mContext.getString(R.string.subject_header,\n+                Version.getVersionName(mContext),\n+                Version.getVersionCode(mContext),\n+                Build.FINGERPRINT);\n     }\n \n-    String getBody() {\n-        StringBuilder builder = new StringBuilder()\n-                .append(mContext.getString(R.string.body_header, mVersionName))\n-                .append(\""\\n\\n\"")\n-                .append(Build.FINGERPRINT)\n-                .append(\""\\n\\n\"");\n+    String getBody() throws IllegalArgumentException, IllegalStateException, IOException {\n+        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();\n+\n+        XmlSerializer xml = Xml.newSerializer();\n+        xml.setOutput(outputStream, \""utf-8\"");\n+        xml.setFeature(\""http://xmlpull.org/v1/doc/features.html#indent-output\"", true);\n+        xml.startDocument(\""utf-8\"", true);\n \n+        xml.startTag(null, TEST_RESULTS_REPORT_TAG);\n+        xml.attribute(null, \""version\"", Integer.toString(REPORT_VERSION));\n+        xml.attribute(null, \""creation-time\"", DATE_FORMAT.format(new Date()));\n+\n+        xml.startTag(null, VERIFIER_INFO_TAG);\n+        xml.attribute(null, \""version-name\"", Version.getVersionName(mContext));\n+        xml.attribute(null, \""version-code\"", Integer.toString(Version.getVersionCode(mContext)));\n+        xml.endTag(null, VERIFIER_INFO_TAG);\n+\n+        xml.startTag(null, DEVICE_INFO_TAG);\n+        xml.startTag(null, BUILD_INFO_TAG);\n+        xml.attribute(null, \""fingerprint\"", Build.FINGERPRINT);\n+        xml.endTag(null, BUILD_INFO_TAG);\n+        xml.endTag(null, DEVICE_INFO_TAG);\n+\n+        xml.startTag(null, TEST_RESULTS_TAG);\n         int count = mAdapter.getCount();\n         for (int i = 0; i < count; i++) {\n             TestListItem item = mAdapter.getItem(i);\n-            if (!item.isTest()) {\n-                builder.append(item.title).append('\\n');\n-            } else {\n-                builder.append(item.title)\n-                        .append(\"".....\"")\n-                        .append(getTestResultString(mAdapter.getTestResult(i)))\n-                        .append('\\n');\n-            }\n-\n-            if (i + 1 < count && !mAdapter.getItem(i + 1).isTest()) {\n-                builder.append('\\n');\n+            if (item.isTest()) {\n+                xml.startTag(null, TEST_TAG);\n+                xml.attribute(null, \""title\"", item.title);\n+                xml.attribute(null, \""class-name\"", item.className);\n+                xml.attribute(null, \""result\"", getTestResultString(mAdapter.getTestResult(i)));\n+                xml.endTag(null, TEST_TAG);\n             }\n         }\n-        return builder.toString();\n+        xml.endTag(null, TEST_RESULTS_TAG);\n+\n+        xml.endTag(null, TEST_RESULTS_REPORT_TAG);\n+        xml.endDocument();\n+\n+        return outputStream.toString(\""utf-8\"");\n     }\n \n     private String getTestResultString(int testResult) {\n-        int resId = 0;\n         switch (testResult) {\n             case TestResult.TEST_RESULT_PASSED:\n-                resId = R.string.pass_result;\n-                break;\n+                return \""pass\"";\n \n             case TestResult.TEST_RESULT_FAILED:\n-                resId = R.string.fail_result;\n-                break;\n+                return \""fail\"";\n \n             case TestResult.TEST_RESULT_NOT_EXECUTED:\n-                resId = R.string.not_executed_result;\n-                break;\n+                return \""not-executed\"";\n \n             default:\n                 throw new IllegalArgumentException(\""Unknown test result: \"" + testResult);\n         }\n-        return mContext.getString(resId);\n     }\n }\n"", ""Version.java"": ""@@ -0,0 +1,43 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.android.cts.verifier;\n+\n+import android.content.Context;\n+import android.content.pm.PackageInfo;\n+import android.content.pm.PackageManager;\n+import android.content.pm.PackageManager.NameNotFoundException;\n+\n+class Version {\n+\n+    static String getVersionName(Context context) {\n+        return getPackageInfo(context).versionName;\n+    }\n+\n+    static int getVersionCode(Context context) {\n+        return getPackageInfo(context).versionCode;\n+    }\n+\n+    static PackageInfo getPackageInfo(Context context) {\n+        try {\n+            PackageManager packageManager = context.getPackageManager();\n+            return packageManager.getPackageInfo(context.getPackageName(), 0);\n+        } catch (NameNotFoundException e) {\n+            throw new RuntimeException(\""Could not get find package information for \""\n+                    + context.getPackageName());\n+        }\n+    }\n+}\n""}","feature, resource 
"
23126,Tor Norbye,Disable palette preview for some widgets on some platforms,"['eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/common/layout/LayoutConstants.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/PreviewIconFactory.java']","Disable palette preview for some widgets on some platforms

ListView palette preview requires adapterview support in layoutlib,
and DatePicker and TimePicker require Holo themes on Honeycomb. This
changeset adds some conditional logic to the palette preview code to
drop rendering of these widgets based on the current render target,
layout library and theme.

Change-Id: Ic42a40faf817e60525485e0a46b7ad967ed1c363",https://android-review.googlesource.com/c/23126,"bug, feature 
",feature,Deprecat;,"{""LayoutConstants.java"": ""@@ -198,9 +198,21 @@ public class LayoutConstants {\n     /** The fully qualified class name of an AdapterView */\n     public static final String FQCN_ADAPTER_VIEW = \""android.widget.AdapterView\""; //$NON-NLS-1$\n \n+    /** The fully qualified class name of a ListView */\n+    public static final String FQCN_LIST_VIEW = \""android.widget.ListView\""; //$NON-NLS-1$\n+\n+    /** The fully qualified class name of an ExpandableListView */\n+    public static final String FQCN_EXPANDABLE_LIST_VIEW = \""android.widget.ExpandableListView\""; //$NON-NLS-1$\n+\n     /** The fully qualified class name of a GestureOverlayView */\n     public static final String FQCN_GESTURE_OVERLAY_VIEW = \""android.gesture.GestureOverlayView\""; //$NON-NLS-1$\n \n+    /** The fully qualified class name of a DatePicker */\n+    public static final String FQCN_DATE_PICKER = \""android.widget.DatePicker\""; //$NON-NLS-1$\n+\n+    /** The fully qualified class name of a TimePicker */\n+    public static final String FQCN_TIME_PICKER = \""android.widget.TimePicker\""; //$NON-NLS-1$\n+\n     /** The fully qualified class name of a RadioGroup */\n     public static final String FQCN_RADIO_GROUP = \""android.widgets.RadioGroup\"";  //$NON-NLS-1$\n \n"", ""PreviewIconFactory.java"": ""@@ -17,6 +17,10 @@\n package com.android.ide.eclipse.adt.internal.editors.layout.gle2;\n \n import static com.android.ide.common.layout.LayoutConstants.ANDROID_URI;\n+import static com.android.ide.common.layout.LayoutConstants.FQCN_DATE_PICKER;\n+import static com.android.ide.common.layout.LayoutConstants.FQCN_EXPANDABLE_LIST_VIEW;\n+import static com.android.ide.common.layout.LayoutConstants.FQCN_LIST_VIEW;\n+import static com.android.ide.common.layout.LayoutConstants.FQCN_TIME_PICKER;\n import static com.android.ide.eclipse.adt.AdtConstants.DOT_PNG;\n import static com.android.ide.eclipse.adt.AdtConstants.DOT_XML;\n \n@@ -39,6 +43,7 @@ import com.android.ide.eclipse.adt.internal.editors.layout.gre.ViewMetadataRepos\n import com.android.ide.eclipse.adt.internal.editors.uimodel.UiDocumentNode;\n import com.android.ide.eclipse.adt.internal.editors.uimodel.UiElementNode;\n import com.android.ide.eclipse.adt.internal.sdk.AndroidTargetData;\n+import com.android.sdklib.IAndroidTarget;\n import com.android.util.Pair;\n \n import org.eclipse.core.runtime.IPath;\n@@ -164,6 +169,32 @@ public class PreviewIconFactory {\n                 String fqn = repository.getFullClassName(element);\n                 assert fqn.length() > 0 : element.getNodeName();\n                 RenderMode renderMode = repository.getRenderMode(fqn);\n+\n+                // Temporary special cases\n+                if (fqn.equals(FQCN_LIST_VIEW) || fqn.equals(FQCN_EXPANDABLE_LIST_VIEW)) {\n+                    if (!mPalette.getEditor().renderingSupports(Capability.ADAPTER_BINDING)) {\n+                        renderMode = RenderMode.SKIP;\n+                    }\n+                } else if (fqn.equals(FQCN_DATE_PICKER) || fqn.equals(FQCN_TIME_PICKER)) {\n+                    IAndroidTarget renderingTarget = mPalette.getEditor().getRenderingTarget();\n+                    // In Honeycomb, these widgets only render properly in the Holo themes.\n+                    int apiLevel = renderingTarget.getVersion().getApiLevel();\n+                    if (apiLevel == 11) {\n+                        String themeName = mPalette.getCurrentTheme();\n+                        if (themeName == null || !themeName.startsWith(\""Theme.Holo\"")) { //$NON-NLS-1$\n+                            // Note - it's possible that the the theme is some other theme\n+                            // such as a user theme which inherits from Theme.Holo and that\n+                            // the render -would- have worked, but it's harder to detect that\n+                            // scenario, so we err on the side of caution and just show an\n+                            // icon + name for the time widgets.\n+                            renderMode = RenderMode.SKIP;\n+                        }\n+                    } else if (apiLevel >= 12) {\n+                        // Currently broken, even for Holo.\n+                        renderMode = RenderMode.SKIP;\n+                    } // apiLevel <= 10 is fine\n+                }\n+\n                 if (renderMode == RenderMode.ALONE) {\n                     elements.add(Collections.singletonList(element));\n                 } else if (renderMode == RenderMode.NORMAL) {\n@@ -561,7 +592,7 @@ public class PreviewIconFactory {\n             if (themeName.startsWith(themeNamePrefix)) {\n                 themeName = themeName.substring(themeNamePrefix.length());\n             }\n-            String dirName = String.format(\""palette-preview-r11c-%s-%s-%s\"", cleanup(targetName),\n+            String dirName = String.format(\""palette-preview-r11d-%s-%s-%s\"", cleanup(targetName),\n                     cleanup(themeName), cleanup(mPalette.getCurrentDevice()));\n             IPath dirPath = pluginState.append(dirName);\n \n""}","bug, feature 
"
18903,RaphaÃ«l Moll,Win SDK: Split the win-sdk makefile and script into 2 parts.,"['build/windows_sdk_tools.mk', 'build/patch_windows_sdk.sh']","Win SDK: Split the win-sdk makefile and script into 2 parts.

The main makefile+scripts to build the Windows SDK is still
in development/build/tools. However it defers to a new
matching set of files here in sdk/build to build and
package things that depend on the sdk.git or external/qemu.git.

This will make it easier for us to prepare SDKs based on
a tools_rN branch that isn't cut at the same time than the
platform branch.

This is a multi-part changeset. The other part is in
development.git.

Change-Id: Ic94d261b16ad595101c6f83cd77055715b45a622",https://android-review.googlesource.com/c/18903,"refactor 
",refactor,Feature;,"{""patch_windows_sdk.sh"": ""@@ -0,0 +1,51 @@\n+#!/bin/bash\n+\n+# This file is included by development.git/tools/build/patch_windows_sdk.sh.\n+# Please see the details in the other file.\n+\n+\n+# Verbose by default. Use -q to make more silent.\n+V=\""-v\""\n+if [[ \""$1\"" == \""-q\"" ]]; then\n+  V=\""\""\n+  shift\n+fi\n+\n+TEMP_SDK_DIR=$1\n+WIN_OUT_DIR=$2\n+TOPDIR=${TOPDIR:-$3}\n+\n+# Remove obsolete stuff from tools\n+TOOLS=$TEMP_SDK_DIR/tools\n+LIB=$TEMP_SDK_DIR/tools/lib\n+rm $V $TOOLS/{android,apkbuilder,ddms,draw9patch,emulator}\n+rm $V $TOOLS/{hierarchyviewer,layoutopt,mksdcard,traceview,monkeyrunner}\n+rm $V $TOOLS/proguard/bin/*.sh\n+\n+# Copy all the new stuff in tools\n+# Note: keep this line here, just to remind us this is already done by the\n+# script in development.git/tools/build/patch_windows_sdk.sh. This will\n+# be obsolete when we switch to an .atree format.\n+# -- cp $V $WIN_OUT_DIR/host/windows-x86/bin/*.{exe,dll} $TOOLS/\n+\n+# Copy the SDK Manager (aka sdklauncher) to the root of the SDK (it was copied in tools above)\n+# and move it also in SDK/tools/lib (so that tools updates can update the root one too)\n+cp $TOOLS/sdklauncher.exe $TEMP_SDK_DIR/\""SDK Manager.exe\""\n+mv $TOOLS/sdklauncher.exe $LIB/\""SDK Manager.exe\""\n+\n+# Copy the emulator NOTICE in the tools dir\n+cp $V ${TOPDIR}external/qemu/NOTICE $TOOLS/emulator_NOTICE.txt\n+\n+# Update a bunch of bat files\n+cp $V ${TOPDIR}sdk/files/post_tools_install.bat                 $LIB/\n+cp $V ${TOPDIR}sdk/files/find_java.bat                          $LIB/\n+cp $V ${TOPDIR}sdk/apkbuilder/etc/apkbuilder.bat                $TOOLS/\n+cp $V ${TOPDIR}sdk/ddms/app/etc/ddms.bat                        $TOOLS/\n+cp $V ${TOPDIR}sdk/traceview/etc/traceview.bat                  $TOOLS/\n+cp $V ${TOPDIR}sdk/hierarchyviewer2/app/etc/hierarchyviewer.bat $TOOLS/\n+cp $V ${TOPDIR}sdk/layoutopt/app/etc/layoutopt.bat              $TOOLS/\n+cp $V ${TOPDIR}sdk/draw9patch/etc/draw9patch.bat                $TOOLS/\n+cp $V ${TOPDIR}sdk/sdkmanager/app/etc/android.bat               $TOOLS/\n+cp $V ${TOPDIR}sdk/monkeyrunner/etc/monkeyrunner.bat            $TOOLS/\n+cp $V ${TOPDIR}sdk/files/proguard/bin/*.bat                     $TOOLS/proguard/bin/\n+\n"", ""windows_sdk_tools.mk"": ""@@ -0,0 +1,10 @@\n+# Makefile to build the Windows SDK Tools under linux.\n+#\n+# This makefile is included by development/build/tools/windows_sdk.mk\n+# to device which tools we want to build from the sdk.git project.\n+\n+WIN_SDK_TARGETS := \\\n+\temulator \\\n+\tmksdcard \\\n+\tsdklauncher\n+\n""}","Categories: **refactor** 
"
17050,Xavier Ducrohet,Open the debug perspective when showing hprof files.,"['eclipse/plugins/com.android.ide.eclipse.ddms/src/com/android/ide/eclipse/ddms/views/DeviceView.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/AdtPlugin.java']","Open the debug perspective when showing hprof files.

This prevents the creation of an editor area in the
ddms perspective (the only way to get rid of it later
seems to be to reset the perspective).

Change-Id: I1eb4a3f6a77f27cc462b18b9db43d27cfef09337",https://android-review.googlesource.com/c/17050,"**feature** 
",feature,Bug;,"{""AdtPlugin.java"": ""@@ -16,8 +16,6 @@\n \n package com.android.ide.eclipse.adt;\n \n-import com.android.ddmuilib.StackTracePanel;\n-import com.android.ddmuilib.StackTracePanel.ISourceRevealer;\n import com.android.ddmuilib.console.DdmConsole;\n import com.android.ddmuilib.console.IDdmConsole;\n import com.android.ide.eclipse.adt.internal.VersionCheck;\n"", ""DeviceView.java"": ""@@ -42,6 +42,8 @@ import com.android.ide.eclipse.ddms.preferences.PreferenceInitializer;\n \n import org.eclipse.core.filesystem.EFS;\n import org.eclipse.core.filesystem.IFileStore;\n+import org.eclipse.core.resources.ResourcesPlugin;\n+import org.eclipse.core.runtime.IAdaptable;\n import org.eclipse.core.runtime.Path;\n import org.eclipse.jface.action.Action;\n import org.eclipse.jface.action.IAction;\n@@ -56,8 +58,12 @@ import org.eclipse.swt.widgets.Display;\n import org.eclipse.swt.widgets.Shell;\n import org.eclipse.ui.IActionBars;\n import org.eclipse.ui.ISharedImages;\n+import org.eclipse.ui.IWorkbench;\n+import org.eclipse.ui.IWorkbenchPage;\n+import org.eclipse.ui.IWorkbenchWindow;\n import org.eclipse.ui.PartInitException;\n import org.eclipse.ui.PlatformUI;\n+import org.eclipse.ui.WorkbenchException;\n import org.eclipse.ui.ide.IDE;\n import org.eclipse.ui.part.ViewPart;\n \n@@ -228,6 +234,24 @@ public class DeviceView extends ViewPart implements IUiSelectionListener, IClien\n \n             IFileStore fileStore =  EFS.getLocalFileSystem().getStore(new Path(tempPath));\n             if (!fileStore.fetchInfo().isDirectory() && fileStore.fetchInfo().exists()) {\n+                // before we open the file in an editor window, we make sure the current\n+                // workbench page has an editor area (typically the ddms perspective doesn't).\n+                IWorkbench workbench = PlatformUI.getWorkbench();\n+                IWorkbenchWindow window = workbench.getActiveWorkbenchWindow();\n+                IWorkbenchPage page = window.getActivePage();\n+                if (page.isEditorAreaVisible() == false) {\n+                    IAdaptable input;\n+                    if (page != null)\n+                        input= page.getInput();\n+                    else\n+                        input= ResourcesPlugin.getWorkspace().getRoot();\n+                    try {\n+                        workbench.showPerspective(\""org.eclipse.debug.ui.DebugPerspective\"",\n+                                window, input);\n+                    } catch (WorkbenchException e) {\n+                    }\n+                }\n+\n                 IDE.openEditorOnFileStore(\n                         getSite().getWorkbenchWindow().getActivePage(),\n                         fileStore);\n""}","bug, feature 
"
14087,Johan Redestig,Improved error-handling in Rfc822Tokenizer,"['tests/AndroidTests/src/com/android/unit_tests/TextUtilsTest.java', 'core/java/android/text/util/Rfc822Tokenizer.java']","Improved error-handling in Rfc822Tokenizer

The javadoc for the Rfc822Tokenizer states that it will try
to be tolerant to broken syntax instead of returning an error
(as in an unchecked exception). In some rare cases where the
input is clearly incorrect, the tokenizer throws a
StringIndexOutOfBoundsException, which was found during
one of the monkey test runs. This commits fixes that crash,
and teaches the tokenizer to just continue to run anyway. Two
simple junit testcases has also been added for testing the
default and the errornous case.",https://android-review.googlesource.com/c/14087,"bug,test 
","bug,test 
",Bug;Test;,"{""Rfc822Tokenizer.java"": ""@@ -86,7 +86,9 @@ public class Rfc822Tokenizer implements MultiAutoCompleteTextView.Tokenizer {\n                         i++;\n                         break;\n                     } else if (c == '\\\\') {\n-                        name.append(text.charAt(i + 1));\n+                        if (i + 1 < cursor) {\n+                            name.append(text.charAt(i + 1));\n+                        }\n                         i += 2;\n                     } else {\n                         name.append(c);\n@@ -112,7 +114,9 @@ public class Rfc822Tokenizer implements MultiAutoCompleteTextView.Tokenizer {\n                         level++;\n                         i++;\n                     } else if (c == '\\\\') {\n-                        comment.append(text.charAt(i + 1));\n+                        if (i + 1 < cursor) {\n+                            comment.append(text.charAt(i + 1));\n+                        }\n                         i += 2;\n                     } else {\n                         comment.append(c);\n"", ""TextUtilsTest.java"": ""@@ -29,6 +29,8 @@ import android.text.SpannedString;\n import android.text.TextPaint;\n import android.text.TextUtils;\n import android.text.style.StyleSpan;\n+import android.text.util.Rfc822Token;\n+import android.text.util.Rfc822Tokenizer;\n import android.text.util.Rfc822Validator;\n import android.test.MoreAsserts;\n \n@@ -269,6 +271,24 @@ public class TextUtilsTest extends TestCase {\n         }\n     }\n \n+    @SmallTest\n+    public void testRfc822TokenizerFullAddress() {\n+        Rfc822Token[] tokens = Rfc822Tokenizer.tokenize(\""Foo Bar (something) <foo@google.com>\"");\n+        assertNotNull(tokens);\n+        assertEquals(1, tokens.length);\n+        assertEquals(\""foo@google.com\"", tokens[0].getAddress());\n+        assertEquals(\""Foo Bar\"", tokens[0].getName());\n+        assertEquals(\""something\"",tokens[0].getComment());\n+    }\n+\n+    @SmallTest\n+    public void testRfc822TokenizeItemWithError() {\n+        Rfc822Token[] tokens = Rfc822Tokenizer.tokenize(\""\\\""Foo Bar\\\\\"");\n+        assertNotNull(tokens);\n+        assertEquals(1, tokens.length);\n+        assertEquals(\""Foo Bar\"", tokens[0].getAddress());\n+    }\n+\n     @LargeTest\n     public void testEllipsize() {\n         CharSequence s1 = \""The quick brown fox jumps over \\u00FEhe lazy dog.\"";\n""}","bug, test 
"
22859,Amit Feller,adding functionality to get the local name of an object from it's local name,"['tools/emulator/opengl/host/libs/Translator/GLcommon/objectNameManager.cpp', 'tools/emulator/opengl/host/libs/Translator/include/GLcommon/objectNameManager.h']","adding functionality to get the local name of an object from it's local name

Change-Id: I8c9ccc36a5fb70a38a77fa0f0e7826a6fe886db1",https://android-review.googlesource.com/c/22859,"feature
",feature,Feature;,"{""objectNameManager.cpp"": ""@@ -112,6 +112,20 @@ NameSpace::getGlobalName(unsigned int p_localName)\n     return 0;\n }\n \n+unsigned int\n+NameSpace::getLocalName(unsigned int p_globalName)\n+{\n+    for(NamesMap::iterator it = m_localToGlobalMap.begin(); it != m_localToGlobalMap.end();it++){\n+        if((*it).second == p_globalName){\n+            // object found - return its local name\n+            return (*it).first;\n+        }\n+    }\n+\n+    // object does not exist;\n+    return 0;\n+}\n+\n void\n NameSpace::deleteName(unsigned int p_localName)\n {\n@@ -190,6 +204,18 @@ ShareGroup::getGlobalName(NamedObjectType p_type, unsigned int p_localName)\n     return globalName;\n }\n \n+unsigned int\n+ShareGroup::getLocalName(NamedObjectType p_type, unsigned int p_globalName)\n+{\n+    if (p_type >= NUM_OBJECT_TYPES) return 0;\n+\n+    mutex_lock(&m_lock);\n+    unsigned int localName = m_nameSpace[p_type]->getLocalName(p_globalName);\n+    mutex_unlock(&m_lock);\n+\n+    return localName;\n+}\n+\n void\n ShareGroup::deleteName(NamedObjectType p_type, unsigned int p_localName)\n {\n"", ""objectNameManager.h"": ""@@ -73,6 +73,12 @@ private:\n     //\n     unsigned int getGlobalName(unsigned int p_localName);\n \n+    //\n+    // getLocaalName - returns the local name of an object or 0 if the object\n+    //                 does not exist.\n+    //\n+    unsigned int getLocalName(unsigned int p_globalName);\n+\n     //\n     // deleteName - deletes and object from the namespace as well as its\n     //              global name from the global name space.\n@@ -124,6 +130,12 @@ public:\n     //\n     unsigned int getGlobalName(NamedObjectType p_type, unsigned int p_localName);\n \n+    //\n+    // getLocalName - retrieves the \""local\"" name of an object or 0 if the\n+    //                 object does not exist.\n+    //\n+    unsigned int getLocalName(NamedObjectType p_type, unsigned int p_globalName);\n+\n     //\n     // deleteName - deletes and object from the namespace as well as its\n     //              global name from the global name space.\n""}","bug 
"
14837,Mike Lockwood,adb connect and disconnect improvements:,"['adb/transport.c', 'adb/adb.h', 'adb/adb.c', 'adb/commandline.c']","adb connect and disconnect improvements:

Port number is now optional.  Will use default port 5555 if not specified.
""adb disconnect"" with no additional arguments will disconnect all TCP devices.

Change-Id: I7fc26528ed85e66a73b8f6254cea7bf83d98109f
Signed-off-by: Mike Lockwood <lockwood@android.com>",https://android-review.googlesource.com/c/14837,"**feature** 
",feature,Feature;,"{""adb.c"": ""@@ -971,25 +971,32 @@ void connect_device(char* host, char* buffer, int buffer_size)\n {\n     int port, fd;\n     char* portstr = strchr(host, ':');\n-    char buf[4096];\n+    char hostbuf[100];\n+    char serial[100];\n \n-    if (!portstr) {\n-        snprintf(buffer, buffer_size, \""unable to parse %s as <host>:<port>\"", host);\n-        return;\n-    }\n-    if (find_transport(host)) {\n-        snprintf(buffer, buffer_size, \""already connected to %s\"", host);\n-        return;\n+    strncpy(hostbuf, host, sizeof(hostbuf) - 1);\n+    if (portstr) {\n+        if (portstr - host >= sizeof(hostbuf)) {\n+            snprintf(buffer, buffer_size, \""bad host name %s\"", host);\n+            return;\n+        }\n+        // zero terminate the host at the point we found the colon\n+        hostbuf[portstr - host] = 0;\n+        if (sscanf(portstr + 1, \""%d\"", &port) == 0) {\n+            snprintf(buffer, buffer_size, \""bad port number %s\"", portstr);\n+            return;\n+        }\n+    } else {\n+        port = DEFAULT_ADB_LOCAL_TRANSPORT_PORT;\n     }\n \n-    // zero terminate host by overwriting the ':'\n-    *portstr++ = 0;\n-    if (sscanf(portstr, \""%d\"", &port) == 0) {\n-        snprintf(buffer, buffer_size, \""bad port number %s\"", portstr);\n+    snprintf(serial, sizeof(serial), \""%s:%d\"", hostbuf, port);\n+    if (find_transport(serial)) {\n+        snprintf(buffer, buffer_size, \""already connected to %s\"", serial);\n         return;\n     }\n \n-    fd = socket_network_client(host, port, SOCK_STREAM);\n+    fd = socket_network_client(hostbuf, port, SOCK_STREAM);\n     if (fd < 0) {\n         snprintf(buffer, buffer_size, \""unable to connect to %s:%d\"", host, port);\n         return;\n@@ -998,9 +1005,8 @@ void connect_device(char* host, char* buffer, int buffer_size)\n     D(\""client: connected on remote on fd %d\\n\"", fd);\n     close_on_exec(fd);\n     disable_tcp_nagle(fd);\n-    snprintf(buf, sizeof buf, \""%s:%d\"", host, port);\n-    register_socket_transport(fd, buf, port, 0);\n-    snprintf(buffer, buffer_size, \""connected to %s:%d\"", host, port);\n+    register_socket_transport(fd, serial, port, 0);\n+    snprintf(buffer, buffer_size, \""connected to %s\"", serial);\n }\n \n void connect_emulator(char* port_spec, char* buffer, int buffer_size)\n@@ -1136,12 +1142,23 @@ int handle_host_request(char *service, transport_type ttype, char* serial, int r\n         char buffer[4096];\n         memset(buffer, 0, sizeof(buffer));\n         char* serial = service + 11;\n-        atransport *t = find_transport(serial);\n-\n-        if (t) {\n-            unregister_transport(t);\n+        if (serial[0] == 0) {\n+            // disconnect from all TCP devices\n+            unregister_all_tcp_transports();\n         } else {\n-            snprintf(buffer, sizeof(buffer), \""No such device %s\"", serial);\n+            char hostbuf[100];\n+            // assume port 5555 if no port is specified\n+            if (!strchr(serial, ':')) {\n+                snprintf(hostbuf, sizeof(hostbuf) - 1, \""%s:5555\"", serial);\n+                serial = hostbuf;\n+            }\n+            atransport *t = find_transport(serial);\n+\n+            if (t) {\n+                unregister_transport(t);\n+            } else {\n+                snprintf(buffer, sizeof(buffer), \""No such device %s\"", serial);\n+            }\n         }\n \n         snprintf(buf, sizeof(buf), \""OKAY%04x%s\"",(unsigned)strlen(buffer), buffer);\n"", ""adb.h"": ""@@ -275,8 +275,9 @@ void close_usb_devices();\n /* cause new transports to be init'd and added to the list */\n void register_socket_transport(int s, const char *serial, int port, int local);\n \n-/* this should only be used for the \""adb disconnect\"" command */\n+/* these should only be used for the \""adb disconnect\"" command */\n void unregister_transport(atransport *t);\n+void unregister_all_tcp_transports();\n \n void register_usb_transport(usb_handle *h, const char *serial, unsigned writeable);\n \n"", ""commandline.c"": ""@@ -105,8 +105,12 @@ void help()\n         \""                                 environment variable is used, which must\\n\""\n         \""                                 be an absolute path.\\n\""\n         \"" devices                       - list all connected devices\\n\""\n-        \"" connect <host>:<port>         - connect to a device via TCP/IP\\n\""\n-        \"" disconnect <host>:<port>      - disconnect from a TCP/IP device\\n\""\n+        \"" connect <host>[:<port>]       - connect to a device via TCP/IP\\n\""\n+        \""                                 Port 5555 is used by default if no port number is specified.\\n\""\n+        \"" disconnect [<host>[:<port>]]  - disconnect from a TCP/IP device.\\n\""\n+        \""                                 Port 5555 is used by default if no port number is specified.\\n\""\n+        \""                                 Using this ocmmand with no additional arguments\\n\""\n+        \""                                 will disconnect from all connected TCP/IP devices.\\n\""\n         \""\\n\""\n         \""device commands:\\n\""\n         \""  adb push <local> <remote>    - copy file/dir to device\\n\""\n@@ -877,13 +881,33 @@ top:\n         }\n     }\n \n-    if(!strcmp(argv[0], \""connect\"") || !strcmp(argv[0], \""disconnect\"")) {\n+    if(!strcmp(argv[0], \""connect\"")) {\n         char *tmp;\n         if (argc != 2) {\n-            fprintf(stderr, \""Usage: adb %s <host>:<port>\\n\"", argv[0]);\n+            fprintf(stderr, \""Usage: adb connect <host>[:<port>]\\n\"");\n             return 1;\n         }\n-        snprintf(buf, sizeof buf, \""host:%s:%s\"", argv[0], argv[1]);\n+        snprintf(buf, sizeof buf, \""host:connect:%s\"", argv[1]);\n+        tmp = adb_query(buf);\n+        if(tmp) {\n+            printf(\""%s\\n\"", tmp);\n+            return 0;\n+        } else {\n+            return 1;\n+        }\n+    }\n+\n+    if(!strcmp(argv[0], \""disconnect\"")) {\n+        char *tmp;\n+        if (argc > 2) {\n+            fprintf(stderr, \""Usage: adb disconnect [<host>[:<port>]]\\n\"");\n+            return 1;\n+        }\n+        if (argc == 2) {\n+            snprintf(buf, sizeof buf, \""host:disconnect:%s\"", argv[1]);\n+        } else {\n+            snprintf(buf, sizeof buf, \""host:disconnect:\"");\n+        }\n         tmp = adb_query(buf);\n         if(tmp) {\n             printf(\""%s\\n\"", tmp);\n"", ""transport.c"": ""@@ -671,21 +671,26 @@ static void remove_transport(atransport *transport)\n }\n \n \n+static void transport_unref_locked(atransport *t)\n+{\n+    t->ref_count--;\n+    D(\""transport: %p R- (ref=%d)\\n\"", t, t->ref_count);\n+    if (t->ref_count == 0) {\n+        D(\""transport: %p kicking and closing\\n\"", t);\n+        if (!t->kicked) {\n+            t->kicked = 1;\n+            t->kick(t);\n+        }\n+        t->close(t);\n+        remove_transport(t);\n+    }\n+}\n+\n static void transport_unref(atransport *t)\n {\n     if (t) {\n         adb_mutex_lock(&transport_lock);\n-        t->ref_count--;\n-        D(\""transport: %p R- (ref=%d)\\n\"", t, t->ref_count);\n-        if (t->ref_count == 0) {\n-            D(\""transport: %p kicking and closing\\n\"", t);\n-            if (!t->kicked) {\n-                t->kicked = 1;\n-                t->kick(t);\n-            }\n-            t->close(t);\n-            remove_transport(t);\n-        }\n+        transport_unref_locked(t);\n         adb_mutex_unlock(&transport_lock);\n     }\n }\n@@ -894,6 +899,29 @@ void unregister_transport(atransport *t)\n     transport_unref(t);\n }\n \n+// unregisters all non-emulator TCP transports\n+void unregister_all_tcp_transports()\n+{\n+    atransport *t, *next;\n+    adb_mutex_lock(&transport_lock);\n+    for (t = transport_list.next; t != &transport_list; t = next) {\n+        next = t->next;\n+        if (t->type == kTransportLocal && t->adb_port == 0) {\n+            t->next->prev = t->prev;\n+            t->prev->next = next;\n+            // we cannot call kick_transport when holding transport_lock\n+            if (!t->kicked)\n+            {\n+                t->kicked = 1;\n+                t->kick(t);\n+            }\n+            transport_unref_locked(t);\n+        }\n+     }\n+\n+    adb_mutex_unlock(&transport_lock);\n+}\n+\n #endif\n \n void register_usb_transport(usb_handle *usb, const char *serial, unsigned writeable)\n""}","feature 
"
19306,Iliyan Malchev,[ARM] tegra: dma: Remove spam log,['arch/arm/mach-tegra/dma.c'],"[ARM] tegra: dma: Remove spam log

""Interrupt during enqueue"" happens periodically when the
DMA is almost starving.  This happens under certain not-
uncommon scenarios.

Signed-off-by: Iliyan Malchev <malchev@google.com>
",https://android-review.googlesource.com/c/19306,"bug
",bug,Deprecat;,"{""dma.c"": ""@@ -729,7 +729,7 @@ static void handle_continuous_sngl_dma(struct tegra_dma_channel *ch)\n \t\t */\n \t\tnext_req = list_entry(req->node.next, typeof(*next_req), node);\n \t\tif (next_req->status != TEGRA_DMA_REQ_INFLIGHT) {\n-\t\t\tpr_warning(\""%s: interrupt during enqueue\\n\"", __func__);\n+\t\t\tpr_debug(\""%s: interrupt during enqueue\\n\"", __func__);\n \t\t\ttegra_dma_stop(ch);\n \t\t\ttegra_dma_update_hw(ch, next_req);\n \t\t} else if (!list_is_last(&next_req->node, &ch->list)) {\n""}","bug 
"
12200,PacketVideo CM,RIO-7666: The issue fixes the logic that put frame start code in front of WMV Advanced Profile frame if it's not there.,"['nodes/pvomxbasedecnode/src/pvmf_omx_basedec_node.cpp', 'engines/2way/src/pv_2way_sdkinfo.h', 'engines/player/src/pv_player_sdkinfo.h', 'engines/author/src/pv_author_sdkinfo.h']",RIO-7666: The issue fixes the logic that put frame start code in front of WMV Advanced Profile frame if it's not there.,https://android-review.googlesource.com/c/12200,"bug
",bug,Bug;,"{""pv_2way_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PV2WAY_ENGINE_SDKINFO_LABEL \""1001199\""\n+#define PV2WAY_ENGINE_SDKINFO_LABEL \""1001287\""\n #define PV2WAY_ENGINE_SDKINFO_DATE 0x20091005\n \n #endif //PV_2WAY_SDKINFO_H_INCLUDED\n"", ""pv_author_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""1001199\""\n+#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""1001287\""\n #define PVAUTHOR_ENGINE_SDKINFO_DATE 0x20091005\n \n #endif //PV_AUTHOR_SDKINFO_H_INCLUDED\n"", ""pv_player_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVPLAYER_ENGINE_SDKINFO_LABEL \""1001199\""\n+#define PVPLAYER_ENGINE_SDKINFO_LABEL \""1001287\""\n #define PVPLAYER_ENGINE_SDKINFO_DATE 0x20091005\n \n #endif //PV_PLAYER_SDKINFO_H_INCLUDED\n"", ""pvmf_omx_basedec_node.cpp"": ""@@ -2178,12 +2178,12 @@ OSCL_EXPORT_REF bool PVMFOMXBaseDecNode::SendInputBufferToOMXComponent()\n                 if (iIsVC1AdvancedProfile)\n                 {\n                     uint8 vc1_frame_sc[4] = {0, 0, 1, 0xD};\n-                    uint8 *buffer = input_buf->pBufHdr->pBuffer + input_buf->pBufHdr->nFilledLen;\n+                    uint8 *buffer = ((uint8 *)frag.getMemFragPtr());\n \n                     if (buffer[0] || buffer[1] || !(buffer[2] == 1) || !(buffer[3] == 0xD))\n                     {\n                         /* does not have frame start code, therefore inserting it */\n-                        oscl_memcpy(buffer, vc1_frame_sc, 4);\n+                        oscl_memcpy(input_buf->pBufHdr->pBuffer + input_buf->pBufHdr->nFilledLen, vc1_frame_sc, 4);\n \n                         input_buf->pBufHdr->nFilledLen += 4;\n                     }\n""}","bug 
"
20716,Jeff Brown,Move keymaps from sdk/emulator/keymaps.,"['data/keyboards/qwerty.kl', 'data/keyboards/AVRCP.kl', 'data/keyboards/qwerty.kcm', 'data/keyboards/Android.mk', 'data/keyboards/qwerty2.kcm']","Move keymaps from sdk/emulator/keymaps.

Change-Id: Ia10992a5988641b338cb4a50f57deadd5188a5e2",https://android-review.googlesource.com/c/20716,"resource
",resource,Resource;,"{""AVRCP.kl"": ""@@ -0,0 +1,7 @@\n+key 200   MEDIA_PLAY_PAUSE    WAKE\n+key 201   MEDIA_PLAY_PAUSE    WAKE\n+key 166   MEDIA_STOP          WAKE\n+key 163   MEDIA_NEXT          WAKE\n+key 165   MEDIA_PREVIOUS      WAKE\n+key 168   MEDIA_REWIND        WAKE\n+key 208   MEDIA_FAST_FORWARD  WAKE\n"", ""Android.mk"": ""@@ -0,0 +1,18 @@\n+LOCAL_PATH:= $(call my-dir)\n+include $(CLEAR_VARS)\n+LOCAL_SRC_FILES := qwerty.kcm\n+include $(BUILD_KEY_CHAR_MAP)\n+\n+include $(CLEAR_VARS)\n+LOCAL_SRC_FILES := qwerty2.kcm\n+include $(BUILD_KEY_CHAR_MAP)\n+\n+file := $(TARGET_OUT_KEYLAYOUT)/qwerty.kl\n+ALL_PREBUILT += $(file)\n+$(file): $(LOCAL_PATH)/qwerty.kl | $(ACP)\n+\t$(transform-prebuilt-to-target)\n+\n+file := $(TARGET_OUT_KEYLAYOUT)/AVRCP.kl\n+ALL_PREBUILT += $(file)\n+$(file) : $(LOCAL_PATH)/AVRCP.kl | $(ACP)\n+\t$(transform-prebuilt-to-target)\n"", ""qwerty.kcm"": ""@@ -0,0 +1,64 @@\n+[type=QWERTY]                                           \n+                                                        \n+# keycode       display number  base    caps    fn      caps_fn\n+                                                        \n+A               'A'     '2'     'a'     'A'     '#'     0x00\n+B               'B'     '2'     'b'     'B'     '<'     0x00\n+C               'C'     '2'     'c'     'C'     '9'     0x00E7\n+D               'D'     '3'     'd'     'D'     '5'     0x00\n+E               'E'     '3'     'e'     'E'     '2'     0x0301\n+F               'F'     '3'     'f'     'F'     '6'     0x00A5\n+G               'G'     '4'     'g'     'G'     '-'     '_'\n+H               'H'     '4'     'h'     'H'     '['     '{'\n+I               'I'     '4'     'i'     'I'     '$'     0x0302\n+J               'J'     '5'     'j'     'J'     ']'     '}'\n+K               'K'     '5'     'k'     'K'     '\""'     '~'\n+L               'L'     '5'     'l'     'L'     '''     '`'\n+M               'M'     '6'     'm'     'M'     '!'     0x00\n+N               'N'     '6'     'n'     'N'     '>'     0x0303\n+O               'O'     '6'     'o'     'O'     '('     0x00\n+P               'P'     '7'     'p'     'P'     ')'     0x00\n+Q               'Q'     '7'     'q'     'Q'     '*'     0x0300\n+R               'R'     '7'     'r'     'R'     '3'     0x20AC\n+S               'S'     '7'     's'     'S'     '4'     0x00DF\n+T               'T'     '8'     't'     'T'     '+'     0x00A3\n+U               'U'     '8'     'u'     'U'     '&'     0x0308\n+V               'V'     '8'     'v'     'V'     '='     '^'\n+W               'W'     '9'     'w'     'W'     '1'     0x00\n+X               'X'     '9'     'x'     'X'     '8'     0xEF00\n+Y               'Y'     '9'     'y'     'Y'     '%'     0x00A1\n+Z               'Z'     '9'     'z'     'Z'     '7'     0x00\n+                                                        \n+# on pc keyboards\n+COMMA           ','     ','     ','     ';'     ';'     '|'\n+PERIOD          '.'     '.'     '.'     ':'     ':'     0x2026\n+AT              '@'     '0'     '@'     '0'     '0'     0x2022\n+SLASH           '/'     '/'     '/'     '?'     '?'     '\\'\n+                                                        \n+SPACE           0x20    0x20    0x20    0x20    0xEF01  0xEF01\n+ENTER         0xa     0xa     0xa     0xa     0xa     0xa\n+                                                        \n+TAB             0x9     0x9     0x9     0x9     0x9     0x9\n+0               '0'     '0'     '0'     ')'     ')'     ')'\n+1               '1'     '1'     '1'     '!'     '!'     '!'\n+2               '2'     '2'     '2'     '@'     '@'     '@'\n+3               '3'     '3'     '3'     '#'     '#'     '#'\n+4               '4'     '4'     '4'     '$'     '$'     '$'\n+5               '5'     '5'     '5'     '%'     '%'     '%'\n+6               '6'     '6'     '6'     '^'     '^'     '^'\n+7               '7'     '7'     '7'     '&'     '&'     '&'\n+8               '8'     '8'     '8'     '*'     '*'     '*'\n+9               '9'     '9'     '9'     '('     '('     '('\n+                                                        \n+GRAVE           '`'     '`'     '`'     '~'     '`'     '~'\n+MINUS           '-'     '-'     '-'     '_'     '-'     '_'\n+EQUALS          '='     '='     '='     '+'     '='     '+'\n+LEFT_BRACKET    '['     '['     '['     '{'     '['     '{'\n+RIGHT_BRACKET   ']'     ']'     ']'     '}'     ']'     '}'\n+BACKSLASH       '\\'     '\\'     '\\'     '|'     '\\'     '|'\n+SEMICOLON       ';'     ';'     ';'     ':'     ';'     ':'\n+APOSTROPHE      '''     '''     '''     '\""'     '''     '\""'\n+STAR            '*'     '*'     '*'     '*'     '*'     '*'\n+POUND           '#'     '#'     '#'     '#'     '#'     '#'\n+PLUS            '+'     '+'     '+'     '+'     '+'     '+'\n+                                                        \n"", ""qwerty.kl"": ""@@ -0,0 +1,91 @@\n+key 399   GRAVE\n+key 2     1\n+key 3     2\n+key 4     3\n+key 5     4\n+key 6     5\n+key 7     6\n+key 8     7\n+key 9     8\n+key 10    9\n+key 11    0\n+key 158   BACK              WAKE_DROPPED\n+key 230   SOFT_RIGHT        WAKE\n+key 60    SOFT_RIGHT        WAKE\n+key 107   ENDCALL           WAKE_DROPPED\n+key 62    ENDCALL           WAKE_DROPPED\n+key 229   MENU              WAKE_DROPPED\n+key 139   MENU              WAKE_DROPPED\n+key 59    MENU              WAKE_DROPPED\n+key 127   SEARCH            WAKE_DROPPED\n+key 217   SEARCH            WAKE_DROPPED\n+key 228   POUND\n+key 227   STAR\n+key 231   CALL              WAKE_DROPPED\n+key 61    CALL              WAKE_DROPPED\n+key 232   DPAD_CENTER       WAKE_DROPPED\n+key 108   DPAD_DOWN         WAKE_DROPPED\n+key 103   DPAD_UP           WAKE_DROPPED\n+key 102   HOME              WAKE\n+key 105   DPAD_LEFT         WAKE_DROPPED\n+key 106   DPAD_RIGHT        WAKE_DROPPED\n+key 115   VOLUME_UP         WAKE\n+key 114   VOLUME_DOWN       WAKE\n+key 116   POWER             WAKE\n+key 212   CAMERA\n+\n+key 16    Q\n+key 17    W\n+key 18    E\n+key 19    R\n+key 20    T\n+key 21    Y\n+key 22    U\n+key 23    I\n+key 24    O\n+key 25    P\n+key 26    LEFT_BRACKET\n+key 27    RIGHT_BRACKET\n+key 43    BACKSLASH\n+\n+key 30    A\n+key 31    S\n+key 32    D\n+key 33    F\n+key 34    G\n+key 35    H\n+key 36    J\n+key 37    K\n+key 38    L\n+key 39    SEMICOLON\n+key 40    APOSTROPHE\n+key 14    DEL\n+        \n+key 44    Z\n+key 45    X\n+key 46    C\n+key 47    V\n+key 48    B\n+key 49    N\n+key 50    M\n+key 51    COMMA\n+key 52    PERIOD\n+key 53    SLASH\n+key 28    ENTER\n+        \n+key 56    ALT_LEFT\n+key 100   ALT_RIGHT\n+key 42    SHIFT_LEFT\n+key 54    SHIFT_RIGHT\n+key 15    TAB\n+key 57    SPACE\n+key 150   EXPLORER\n+key 155   ENVELOPE        \n+\n+key 12    MINUS\n+key 13    EQUALS\n+key 215   AT\n+\n+# On an AT keyboard: ESC, F10\n+key 1     BACK              WAKE_DROPPED\n+key 68    MENU              WAKE_DROPPED\n"", ""qwerty2.kcm"": ""@@ -0,0 +1,81 @@\n+[type=QWERTY]                                           \n+                                                        \n+# this keymap is to be used in the emulator only. note\n+# that I have liberally modified certain key strokes to\n+# make it more usable in this context. the main differences\n+# with the reference keyboard image are:\n+#\n+#  - cap-2 produces '@', and not '\""', without that, typing\n+#    email addresses becomes a major pain with a qwerty\n+#    keyboard. note that you can type '\""' with fn-E anyway.\n+#\n+#  - cap-COMMA and cap-PERIOD return '<' and '>', instead\n+#    of nothing.\n+#\n+#\n+                                                        \n+# keycode       display  number base    caps    fn      caps_fn\n+                                                        \n+A               'A'     '2'     'a'     'A'     'a'     'A'\n+B               'B'     '2'     'b'     'B'     'b'     'B'\n+C               'C'     '2'     'c'     'C'     0x00e7  0x00E7\n+D               'D'     '3'     'd'     'D'     '''     '''\n+E               'E'     '3'     'e'     'E'     '\""'     0x0301\n+F               'F'     '3'     'f'     'F'     '['     '['\n+G               'G'     '4'     'g'     'G'     ']'     ']'\n+H               'H'     '4'     'h'     'H'     '<'     '<'\n+I               'I'     '4'     'i'     'I'     '-'     0x0302\n+J               'J'     '5'     'j'     'J'     '>'     '>'\n+K               'K'     '5'     'k'     'K'     ';'     '~'\n+L               'L'     '5'     'l'     'L'     ':'     '`'\n+M               'M'     '6'     'm'     'M'     '%'     0x00\n+N               'N'     '6'     'n'     'N'     0x00    0x0303\n+O               'O'     '6'     'o'     'O'     '+'     '+'\n+P               'P'     '7'     'p'     'P'     '='     0x00A5\n+Q               'Q'     '7'     'q'     'Q'     '|'     0x0300\n+R               'R'     '7'     'r'     'R'     '`'     0x20AC\n+S               'S'     '7'     's'     'S'     '\\'     0x00DF\n+T               'T'     '8'     't'     'T'     '{'     0x00A3\n+U               'U'     '8'     'u'     'U'     '_'     0x0308\n+V               'V'     '8'     'v'     'V'     'v'     'V'\n+W               'W'     '9'     'w'     'W'     '~'     '~'\n+X               'X'     '9'     'x'     'X'     'x'     0xEF00\n+Y               'Y'     '9'     'y'     'Y'     '}'     0x00A1\n+Z               'Z'     '9'     'z'     'Z'     'z'     'Z'\n+                                                        \n+COMMA           ','     ','     ','     '<'     ','     ','\n+PERIOD          '.'     '.'     '.'     '>'     '.'     0x2026\n+AT              '@'     '@'     '@'     '@'     '@'     0x2022\n+SLASH           '/'     '/'     '/'     '?'     '?'     '?'\n+                                                        \n+SPACE           0x20    0x20    0x20    0x20    0xEF01  0xEF01\n+ENTER         0xa     0xa     0xa     0xa     0xa     0xa\n+                                                        \n+0               '0'     '0'     '0'     ')'     ')'     ')'\n+1               '1'     '1'     '1'     '!'     '!'     '!'\n+2               '2'     '2'     '2'     '@'     '@'     '@'\n+3               '3'     '3'     '3'     '#'     '#'     '#'\n+4               '4'     '4'     '4'     '$'     '$'     '$'\n+5               '5'     '5'     '5'     '%'     '%'     '%'\n+6               '6'     '6'     '6'     '^'     '^'     '^'\n+7               '7'     '7'     '7'     '&'     '&'     '&'\n+8               '8'     '8'     '8'     '*'     '*'     '*'\n+9               '9'     '9'     '9'     '('     '('     '('\n+                                                        \n+# the rest is for a qwerty keyboard\n+#\n+TAB             0x9     0x9     0x9     0x9     0x9     0x9\n+GRAVE           '`'     '`'     '`'     '~'     '`'     '~'\n+MINUS           '-'     '-'     '-'     '_'     '-'     '_'\n+EQUALS          '='     '='     '='     '+'     '='     '+'\n+LEFT_BRACKET    '['     '['     '['     '{'     '['     '{'\n+RIGHT_BRACKET   ']'     ']'     ']'     '}'     ']'     '}'\n+BACKSLASH       '\\'     '\\'     '\\'     '|'     '\\'     '|'\n+SEMICOLON       ';'     ';'     ';'     ':'     ';'     ':'\n+APOSTROPHE      '''     '''     '''     '\""'     '''     '\""'\n+STAR            '*'     '*'     '*'     '*'     '*'     '*'\n+POUND           '#'     '#'     '#'     '#'     '#'     '#'\n+PLUS            '+'     '+'     '+'     '+'     '+'     '+'\n+                                                        \n+                                                        \n+                                                        \n""}","resource 
"
20965,David Turner,Improve telephony emulation support.,['telephony/android_modem.c'],"Improve telephony emulation support.

This patch fixes a few minor bugs in our emulated GSM modem.
- Mixup between the answers for +CGDCONT=? and +CGDCONT?
- Return our IP address as part of +CGDCONT=? now
- Ensure the area code and cell id are no more than 4 hexadecimal digits

Change-Id: I4fc0b333ed0f7df88a9874490d3b3e0b4a09a7d3",https://android-review.googlesource.com/c/20965,"bug, feature 
","bug,feature",Bug;,"{""android_modem.c"": ""@@ -671,7 +671,7 @@ amodem_set_voice_registration( AModem  modem, ARegistrationState  state )\n         case A_REGISTRATION_UNSOL_ENABLED_FULL:\n             amodem_unsol( modem, \""+CREG: %d,%d, \\\""%04x\\\"", \\\""%04x\\\""\\r\"",\n                           modem->voice_mode, modem->voice_state,\n-                          modem->area_code, modem->cell_id );\n+                          modem->area_code & 0xffff, modem->cell_id & 0xffff);\n             break;\n         default:\n             ;\n@@ -699,12 +699,12 @@ amodem_set_data_registration( AModem  modem, ARegistrationState  state )\n             if (modem->supportsNetworkDataType)\n                 amodem_unsol( modem, \""+CGREG: %d,%d,\\\""%04x\\\"",\\\""%04x\\\"",\\\""%04x\\\""\\r\"",\n                             modem->data_mode, modem->data_state,\n-                            modem->area_code, modem->cell_id,\n+                            modem->area_code & 0xffff, modem->cell_id & 0xffff,\n                             modem->data_network );\n             else\n                 amodem_unsol( modem, \""+CGREG: %d,%d,\\\""%04x\\\"",\\\""%04x\\\""\\r\"",\n                             modem->data_mode, modem->data_state,\n-                            modem->area_code, modem->cell_id );\n+                            modem->area_code & 0xffff, modem->cell_id & 0xffff );\n             break;\n \n         default:\n@@ -1343,9 +1343,13 @@ handleNetworkRegistration( const char*  cmd, AModem  modem )\n     if ( !memcmp( cmd, \""+CREG\"", 5 ) ) {\n         cmd += 5;\n         if (cmd[0] == '?') {\n-            return amodem_printf( modem, \""+CREG: %d,%d, \\\""%04x\\\"", \\\""%04x\\\""\"",\n-                                  modem->voice_mode, modem->voice_state,\n-                                  modem->area_code, modem->cell_id );\n+            if (modem->voice_mode == A_REGISTRATION_UNSOL_ENABLED_FULL)\n+                return amodem_printf( modem, \""+CREG: %d,%d, \\\""%04x\\\"", \\\""%04x\\\""\"",\n+                                       modem->voice_mode, modem->voice_state,\n+                                       modem->area_code, modem->cell_id );\n+            else\n+                return amodem_printf( modem, \""+CREG: %d,%d\"",\n+                                       modem->voice_mode, modem->voice_state );\n         } else if (cmd[0] == '=') {\n             switch (cmd[1]) {\n                 case '0':\n@@ -1955,7 +1959,7 @@ handleListPDPContexts( const char*  cmd, AModem  modem )\n         ADataContext  data = modem->data_contexts + nn;\n         if (!data->active)\n             continue;\n-        amodem_add_line( modem, \""+CGACT: %d,%d\\r\"", data->id, data->active );\n+        amodem_add_line( modem, \""+CGACT: %d,%d\\r\\n\"", data->id, data->active );\n     }\n     return amodem_end_line( modem );\n }\n@@ -1966,18 +1970,11 @@ handleDefinePDPContext( const char*  cmd, AModem  modem )\n     assert( !memcmp( cmd, \""+CGDCONT=\"", 9 ) );\n     cmd += 9;\n     if (cmd[0] == '?') {\n-        int  nn;\n-        amodem_begin_line(modem);\n-        for (nn = 0; nn < MAX_DATA_CONTEXTS; nn++) {\n-            ADataContext  data = modem->data_contexts + nn;\n-            if (!data->active)\n-                continue;\n-            amodem_add_line( modem, \""+CGDCONT: %d,%s,\\\""%s\\\"",,0,0\\r\\n\"",\n-                             data->id,\n-                             data->type == A_DATA_IP ? \""IP\"" : \""PPP\"",\n-                             data->apn );\n-        }\n-        return amodem_end_line(modem);\n+        /* +CGDCONT=? is used to query the ranges of supported PDP Contexts.\n+         * We only really support IP ones in the emulator, so don't try to\n+         * fake PPP ones.\n+         */\n+        return \""+CGDCONT: (1-1),\\\""IP\\\"",,,(0-2),(0-4)\\r\\n\"";\n     } else {\n         /* template is +CGDCONT=<id>,\""<type>\"",\""<apn>\"",,0,0 */\n         int              id = cmd[0] - '1';\n@@ -2021,26 +2018,31 @@ BadCommand:\n     return \""ERROR: BAD COMMAND\"";\n }\n \n+static const char*\n+handleQueryPDPContext( const char* cmd, AModem modem )\n+{\n+    int  nn;\n+    amodem_begin_line(modem);\n+    for (nn = 0; nn < MAX_DATA_CONTEXTS; nn++) {\n+        ADataContext  data = modem->data_contexts + nn;\n+        if (!data->active)\n+            continue;\n+        amodem_add_line( modem, \""+CGDCONT: %d,\\\""%s\\\"",\\\""%s\\\"",\\\""%s\\\"",0,0\\r\\n\"",\n+                         data->id,\n+                         data->type == A_DATA_IP ? \""IP\"" : \""PPP\"",\n+                         data->apn,\n+                         /* Note: For now, hard-code the IP address of our\n+                          *       network interface\n+                          */\n+                         data->type == A_DATA_IP ? \""10.0.2.15\"" : \""\"");\n+    }\n+    return amodem_end_line(modem);\n+}\n \n static const char*\n handleStartPDPContext( const char*  cmd, AModem  modem )\n {\n     /* XXX: TODO: handle PDP start appropriately */\n-    /* for the moment, always return success */\n-#if 0\n-    AVoiceCall  vcall = amodem_alloc_call( modem );\n-    ACall       call  = (ACall) vcall;\n-    if (call == NULL) {\n-        return \""ERROR: TOO MANY CALLS\"";\n-    }\n-    call->id    = 1;\n-    call->dir   = A_CALL_OUTBOUND;\n-    /* XXX: it would be better to delay this */\n-    call->state = A_CALL_ACTIVE;\n-    call->mode  = A_CALL_DATA;\n-    call->multi = 0;\n-    strcpy( call->number, \""012345\"" );\n-#endif\n     return NULL;\n }\n \n@@ -2377,7 +2379,7 @@ static const struct {\n     { \""+WPRL?\"", NULL, handlePrlVersion }, /* Query the current PRL version */\n \n     /* see requestOrSendPDPContextList() */\n-    { \""+CGACT?\"", \""\"", handleListPDPContexts },\n+    { \""+CGACT?\"", NULL, handleListPDPContexts },\n \n     /* see requestOperator() */\n     { \""+COPS=3,0;+COPS?;+COPS=3,1;+COPS?;+COPS=3,2;+COPS?\"", NULL, handleRequestOperator },\n@@ -2409,6 +2411,7 @@ static const struct {\n     { \""%DATA=2,\\\""UART\\\"",1,,\\\""SER\\\"",\\\""UART\\\"",0\"", NULL, NULL },\n \n     { \""!+CGDCONT=\"", NULL, handleDefinePDPContext },\n+    { \""+CGDCONT?\"", NULL, handleQueryPDPContext },\n \n     { \""+CGQREQ=1\"", NULL, NULL },\n     { \""+CGQMIN=1\"", NULL, NULL },\n@@ -2453,9 +2456,6 @@ static const struct {\n     { \""E0Q0V1\"", NULL, NULL },\n     { \""S0=0\"", NULL, NULL },\n     { \""+CMEE=1\"", NULL, NULL },\n-    { \""+CREG=2\"", NULL, handleNetworkRegistration },\n-    { \""+CREG=1\"", NULL, handleNetworkRegistration },\n-    { \""+CGREG=1\"", NULL, handleNetworkRegistration },\n     { \""+CCWA=1\"", NULL, NULL },\n     { \""+CMOD=0\"", NULL, NULL },\n     { \""+CMUT=0\"", NULL, NULL },\n""}","feature, bug 
"
12730,PacketVideo CM,RIO-6456: Failures in Java-based mediaframework unit test cases.,"['android/mediascanner.cpp', 'android/metadatadriver.cpp', 'engines/2way/src/pv_2way_sdkinfo.h', 'engines/player/src/pv_player_sdkinfo.h', 'engines/author/src/pv_author_sdkinfo.h']",RIO-6456: Failures in Java-based mediaframework unit test cases.,https://android-review.googlesource.com/c/12730,"bug 
",bug,Test;,"{""mediascanner.cpp"": ""@@ -290,7 +290,7 @@ static PVMFStatus reportM4ATags(IMpeg4File *mp4Input, MediaScannerClient& client\n     trackNum = mp4Input->getITunesThisTrackNo();\n     totalTracks = mp4Input->getITunesTotalTracks();\n     sprintf(buffer, \""%d/%d\"", trackNum, totalTracks);\n-    if (!client.addStringTag(\""tracknumber\"", buffer)) goto failure;\n+    if (!client.addStringTag(\""track-info/track-number\"", buffer)) goto failure;\n \n     // Duration\n     duration = mp4Input->getMovieDuration();\n@@ -534,7 +534,7 @@ static PVMFStatus parseASF(const char *filename, MediaScannerClient& client)\n         client.addStringTag(\""year\"", value);\n     value = retriever->extractMetadata(METADATA_KEY_CD_TRACK_NUMBER);\n     if (value)\n-        client.addStringTag(\""tracknumber\"", value);\n+        client.addStringTag(\""track-info/track-number\"", value);\n \n     retriever->disconnect();\n     return PVMFSuccess;\n"", ""metadatadriver.cpp"": ""@@ -33,7 +33,7 @@ using namespace android;\n const char* MetadataDriver::ALBUM_ART_KEY = \""graphic;maxsize=3000000;truncate=false\"";\n \n const char* MetadataDriver::METADATA_KEYS[NUM_METADATA_KEYS] = {\n-        \""tracknumber\"",\n+        \""track-info/track-number\"",\n         \""album\"",\n         \""artist\"",\n         \""author\"",\n"", ""pv_2way_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PV2WAY_ENGINE_SDKINFO_LABEL \""1083678\""\n+#define PV2WAY_ENGINE_SDKINFO_LABEL \""1083734\""\n #define PV2WAY_ENGINE_SDKINFO_DATE 0x20091112\n \n #endif //PV_2WAY_SDKINFO_H_INCLUDED\n"", ""pv_author_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""1083678\""\n+#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""1083734\""\n #define PVAUTHOR_ENGINE_SDKINFO_DATE 0x20091112\n \n #endif //PV_AUTHOR_SDKINFO_H_INCLUDED\n"", ""pv_player_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVPLAYER_ENGINE_SDKINFO_LABEL \""1083678\""\n+#define PVPLAYER_ENGINE_SDKINFO_LABEL \""1083734\""\n #define PVPLAYER_ENGINE_SDKINFO_DATE 0x20091112\n \n #endif //PV_PLAYER_SDKINFO_H_INCLUDED\n""}","bug, test 
"
23268,Tor Norbye,Move rendering code into RenderService class,"['eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/PreviewIconFactory.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/PaletteControl.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/RenderService.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gre/RulesEngine.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/GraphicalEditorPart.java']","Move rendering code into RenderService class

This CL moves the various rendering-related code in
GraphicalEditorPart into a separate RenderService class, which can be
configured for different purposes:

- Rendering a layout shown in the canvas
- Rendering palette previews
- Rendering a preview of a node during a drag from a palette
- Rendering a theme drawable
- Rendering layout-only to measure preferred sizes

Once configured, the rendering service can be used repeatedly and off
the UI thread to for example render all the palette previews without
blocking editor startup. This will be addressed in a follow-up CL.

Change-Id: I851148d80c3a4dc9e4b5b66c9838ae49809ea03c",https://android-review.googlesource.com/c/23268,"refactor
",refactor,Resource;,,"refactor 
"
12563,PacketVideo CM,RIO-7549: Video config parser additions,"['engines/2way/src/pv_2way_sdkinfo.h', 'engines/player/src/pv_player_sdkinfo.h', 'codecs_v2/utilities/pv_config_parser/src/pv_video_config_parser.cpp', 'engines/author/src/pv_author_sdkinfo.h']",RIO-7549: Video config parser additions,https://android-review.googlesource.com/c/12563,"feature 
",feature,Resource;,"{""pv_video_config_parser.cpp"": ""@@ -48,6 +48,7 @@\n #define mmioFOURCC_WMC(ch0, ch1, ch2, ch3)  MAKEFOURCC_WMC(ch0, ch1, ch2, ch3)\n #endif\n \n+#define FOURCC_WMV1     mmioFOURCC_WMC('W','M','V','1')\n #define FOURCC_WMV2     mmioFOURCC_WMC('W','M','V','2')\n #define FOURCC_WMV3     mmioFOURCC_WMC('W','M','V','3')\n #define FOURCC_WMVA     mmioFOURCC_WMC('W','M','V','A')\n@@ -58,6 +59,7 @@\n #define FOURCC_MP43     mmioFOURCC_WMC('M','P','4','3')\n #define FOURCC_mp42     mmioFOURCC_WMC('m','p','4','2')\n #define FOURCC_mp43     mmioFOURCC_WMC('m','p','4','3')\n+#define FOURCC_MP4S     mmioFOURCC_WMC('M','P','4','S')\n \n // For PlayReady\n #define FOURCC_PRDY     mmioFOURCC_WMC('P','R','D','Y')\n@@ -188,14 +190,16 @@ OSCL_EXPORT_REF int16 pv_video_config_parser(pvVideoConfigParserInputs *aInputs,\n         // in case of WMV store \""Compression Type as Level\""\n         aOutputs->level = NewCompression;\n \n-        if (NewCompression != FOURCC_WMV2 &&\n+        if (NewCompression != FOURCC_WMV1 &&\n+                NewCompression != FOURCC_WMV2 &&\n                 NewCompression != FOURCC_WMV3 &&\n                 NewCompression != FOURCC_WVC1 &&\n                 NewCompression != FOURCC_WMVA &&\n                 NewCompression != FOURCC_MP42 &&\n                 NewCompression != FOURCC_MP43 &&\n                 NewCompression != FOURCC_mp42 &&\n-                NewCompression != FOURCC_mp43)\n+                NewCompression != FOURCC_mp43 &&\n+                NewCompression != FOURCC_MP4S)\n         {\n             return -1;\n         }\n"", ""pv_2way_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PV2WAY_ENGINE_SDKINFO_LABEL \""1068366\""\n+#define PV2WAY_ENGINE_SDKINFO_LABEL \""1068577\""\n #define PV2WAY_ENGINE_SDKINFO_DATE 0x20091105\n \n #endif //PV_2WAY_SDKINFO_H_INCLUDED\n"", ""pv_author_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""1068366\""\n+#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""1068577\""\n #define PVAUTHOR_ENGINE_SDKINFO_DATE 0x20091105\n \n #endif //PV_AUTHOR_SDKINFO_H_INCLUDED\n"", ""pv_player_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVPLAYER_ENGINE_SDKINFO_LABEL \""1068366\""\n+#define PVPLAYER_ENGINE_SDKINFO_LABEL \""1068577\""\n #define PVPLAYER_ENGINE_SDKINFO_DATE 0x20091105\n \n #endif //PV_PLAYER_SDKINFO_H_INCLUDED\n""}","feature 
"
21898,Keiji Ariyama,Applying the previous rotation state when refreshing screen image.,['ddms/libs/ddmuilib/src/com/android/ddmuilib/ScreenShotDialog.java'],"Applying the previous rotation state when refreshing screen image.

Change-Id: I04e81b591701e096bb553ac31af3226fa6d6b3f6",https://android-review.googlesource.com/c/21898,"bug, feature 
",feature,Others;,"{""ScreenShotDialog.java"": ""@@ -99,6 +99,8 @@ public class ScreenShotDialog extends Dialog {\n \n     }\n \n+    private int mRotate = 0;\n+\n     /*\n      * Create the screen capture dialog contents.\n      */\n@@ -119,6 +121,12 @@ public class ScreenShotDialog extends Dialog {\n             @Override\n             public void widgetSelected(SelectionEvent e) {\n                 updateDeviceImage(shell);\n+                // This is easiest way.\n+                // TODO: improve the RawImage class.\n+                for (int i=0; i < mRotate; i++) {\n+                    mRawImage = mRawImage.getRotated();\n+                }\n+                updateImageDisplay(shell);\n             }\n         });\n \n@@ -132,6 +140,7 @@ public class ScreenShotDialog extends Dialog {\n             @Override\n             public void widgetSelected(SelectionEvent e) {\n                 if (mRawImage != null) {\n+                    mRotate = (mRotate + 1) % 4;\n                     mRawImage = mRawImage.getRotated();\n                     updateImageDisplay(shell);\n                 }\n""}","bug, feature 
"
22788,Dmitry Shmidt,net: wireless: bcm4329: Add new and default wifi locale support,['drivers/net/wireless/bcm4329/dhd_custom_gpio.c'],"net: wireless: bcm4329: Add new and default wifi locale support

Signed-off-by: Dmitry Shmidt <dimitrysh@google.com>",https://android-review.googlesource.com/c/22788,"feature 
",feature,Feature;,"{""dhd_custom_gpio.c"": ""@@ -183,6 +183,7 @@ dhd_custom_get_mac_address(unsigned char *buf)\n const struct cntry_locales_custom translate_custom_table[] = {\n /* Table should be filled out based on custom platform regulatory requirement */\n #ifdef EXAMPLE_TABLE\n+\t{\""\"",   \""XY\"",  4}  /* universal */\n \t{\""US\"", \""US\"", 69}, /* input ISO \""US\"" to : US regrev 69 */\n \t{\""CA\"", \""US\"", 69}, /* input ISO \""CA\"" to : US regrev 69 */\n \t{\""EU\"", \""EU\"",  5}, /* input ISO \""EU\"" to : EU regrev 05 */\n@@ -193,7 +194,10 @@ const struct cntry_locales_custom translate_custom_table[] = {\n \t{\""KR\"", \""XY\"",  3},\n \t{\""AU\"", \""XY\"",  3},\n \t{\""CN\"", \""XY\"",  3}, /* input ISO \""CN\"" to : XY regrev 03 */\n+\t{\""HK\"", \""XY\"",  3},\n \t{\""TW\"", \""XY\"",  3},\n+\t{\""BR\"", \""XY\"",  3},\n+\t{\""MX\"", \""XY\"",  3},\n \t{\""AR\"", \""XY\"",  3}\n #endif /* EXAMPLE_TABLE */\n };\n@@ -232,9 +236,11 @@ void get_customized_country_code(char *country_iso_code, wl_country_t *cspec)\n \t\tif (strcmp(country_iso_code, translate_custom_table[i].iso_abbrev) == 0) {\n \t\t\tmemcpy(cspec->ccode, translate_custom_table[i].custom_locale, WLC_CNTRY_BUF_SZ);\n \t\t\tcspec->rev = translate_custom_table[i].custom_locale_rev;\n-\t\t\tbreak;\n+\t\t\treturn;\n \t\t}\n \t}\n+\tmemcpy(cspec->ccode, translate_custom_table[0].custom_locale, WLC_CNTRY_BUF_SZ);\n+\tcspec->rev = translate_custom_table[0].custom_locale_rev;\n \treturn;\n #endif\n }\n""}","feature 
"
18975,Matthias Bady,build failed with g++ v. 4.4.5 err msg: frameworks/base/media/libstagefright/MediaExtractor.cpp:62: error: invalid conversion from âconst char*â to âchar*â strrchr provides two prototypes. the one used returns const char* instead of char*,['media/libstagefright/MediaExtractor.cpp'],"build failed with g++ v. 4.4.5
err msg: frameworks/base/media/libstagefright/MediaExtractor.cpp:62: error: invalid conversion from âconst char*â to âchar*â
strrchr provides two prototypes. the one used returns const char* instead of char*

Change-Id: I6442ee642aebfbfc2f977bab40016cfedc7789ac",https://android-review.googlesource.com/c/18975,"bug
",bug,Others;,"{""MediaExtractor.cpp"": ""@@ -59,7 +59,7 @@ sp<MediaExtractor> MediaExtractor::Create(\n     }\n \n     if (!strncmp(mime, \""drm\"", 3)) {\n-        char *originalMime = strrchr(mime, '+') + 1;\n+        const char *originalMime = strrchr(mime, '+') + 1;\n \n         if (!strncmp(mime, \""drm+es_based\"", 12)) {\n             return new DRMExtractor(source, originalMime);\n""}","bug 
"
20204,RaphaÃ«l Moll,SDK Manager: specify proxy on no-UI command-line.,"['sdkmanager/libs/sdkuilib/src/com/android/sdkuilib/internal/repository/UpdateNoWindow.java', 'sdkmanager/libs/sdkuilib/src/com/android/sdkuilib/internal/repository/SettingsController.java', 'sdkmanager/app/src/com/android/sdkmanager/Main.java', 'sdkmanager/app/src/com/android/sdkmanager/SdkCommandLine.java', 'sdkmanager/app/src/com/android/sdkmanager/CommandLineProcessor.java']","SDK Manager: specify proxy on no-UI command-line.

This adds 2 flags to specify the http/https proxy host/port on
the command line when using the console-base ""no-ui"" SDK update.
The command-line proxy values override settings if defined.

Also revamped the argument help display to support larger
command-line long argument sizes and mandate that arguments
can have one of ther short or long argument name optional.

Change-Id: I87cc535ab369602a5c02c7a938b0e4f4736c0040",https://android-review.googlesource.com/c/20204,"feature
",feature,Feature;,"{""CommandLineProcessor.java"": ""@@ -536,6 +536,18 @@ class CommandLineProcessor {\n      */\n     protected void listOptions(String verb, String directObject) {\n         int numOptions = 0;\n+        int longArgLen = 8;\n+\n+        for (Entry<String, Arg> entry : mArguments.entrySet()) {\n+            Arg arg = entry.getValue();\n+            if (arg.getVerb().equals(verb) && arg.getDirectObject().equals(directObject)) {\n+                int n = arg.getLongArg().length();\n+                if (n > longArgLen) {\n+                    longArgLen = n;\n+                }\n+            }\n+        }\n+\n         for (Entry<String, Arg> entry : mArguments.entrySet()) {\n             Arg arg = entry.getValue();\n             if (arg.getVerb().equals(verb) && arg.getDirectObject().equals(directObject)) {\n@@ -564,10 +576,25 @@ class CommandLineProcessor {\n                     }\n                 }\n \n-                stdout(\""  -%1$s %2$-10s %3$s%4$s%5$s\"",\n-                        arg.getShortArg(),\n-                        \""--\"" + arg.getLongArg(),\n-                        arg.getDescription(),\n+                // Java doesn't support * for printf variable with, so we'll insert the long arg\n+                // width \""manually\"" in the printf format string.\n+                String longArgWidth = Integer.toString(longArgLen + 2);\n+\n+                // For multi-line descriptions, pad new lines with the necessary whitespace.\n+                String desc = arg.getDescription();\n+                desc = desc.replaceAll(\""\\n\"",                                           //$NON-NLS-1$\n+                        String.format(\""\\n      %\"" + longArgWidth + \""s\"", \"" \"")); //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n+\n+                // Print a line in the form \"" -1_letter_arg --long_arg description\""\n+                // where either the 1-letter arg or the long arg are optional.\n+                stdout(\""  %1$-2s %2$-\"" + longArgWidth + \""s %3$s%4$s%5$s\"",              //$NON-NLS-1$\n+                        arg.getShortArg().length() > 0 ?\n+                                \""-\"" + arg.getShortArg() :                              //$NON-NLS-1$\n+                                \""\"",                                                    //$NON-NLS-1$\n+                        arg.getLongArg().length() > 0 ?\n+                                \""--\"" + arg.getLongArg() :                              //$NON-NLS-1$\n+                                \""\"",                                                    //$NON-NLS-1$\n+                        desc,\n                         value,\n                         required);\n                 numOptions++;\n@@ -707,8 +734,8 @@ class CommandLineProcessor {\n          * @param mode The {@link Mode} for the argument.\n          * @param mandatory True if this argument is mandatory for this action.\n          * @param directObject The action name. Can be #NO_VERB_OBJECT or #INTERNAL_FLAG.\n-         * @param shortName The one-letter short argument name. Cannot be empty nor null.\n-         * @param longName The long argument name. Cannot be empty nor null.\n+         * @param shortName The one-letter short argument name. Can be empty but not null.\n+         * @param longName The long argument name. Can be empty but not null.\n          * @param description The description. Cannot be null.\n          * @param defaultValue The default value (or values), which depends on the selected {@link Mode}.\n          */\n@@ -803,8 +830,8 @@ class CommandLineProcessor {\n      * @param mode The {@link Mode} for the argument.\n      * @param verb The verb name. Can be #INTERNAL_VERB.\n      * @param directObject The action name. Can be #NO_VERB_OBJECT or #INTERNAL_FLAG.\n-     * @param shortName The one-letter short argument name. Cannot be empty nor null.\n-     * @param longName The long argument name. Cannot be empty nor null.\n+     * @param shortName The one-letter short argument name. Can be empty but not null.\n+     * @param longName The long argument name. Can be empty but not null.\n      * @param description The description. Cannot be null.\n      * @param defaultValue The default value (or values), which depends on the selected {@link Mode}.\n      */\n@@ -816,6 +843,12 @@ class CommandLineProcessor {\n             String description, Object defaultValue) {\n         assert(!(mandatory && mode == Mode.BOOLEAN)); // a boolean mode cannot be mandatory\n \n+        // We should always have at least a short or long name, ideally both but never none.\n+        assert shortName != null;\n+        assert longName != null;\n+        assert (shortName != null && shortName.length() > 0) ||\n+               (longName  != null && longName.length()  > 0);\n+\n         if (directObject == null) {\n             directObject = NO_VERB_OBJECT;\n         }\n"", ""Main.java"": ""@@ -321,6 +321,8 @@ public class Main {\n         boolean useHttp = mSdkCommandLine.getFlagNoHttps();\n         boolean dryMode = mSdkCommandLine.getFlagDryMode();\n         boolean obsolete = mSdkCommandLine.getFlagObsolete();\n+        String proxyHost = mSdkCommandLine.getProxyHost();\n+        String proxyPort = mSdkCommandLine.getProxyPort();\n \n         // Check filter types.\n         ArrayList<String> pkgFilter = new ArrayList<String>();\n@@ -350,7 +352,8 @@ public class Main {\n             }\n         }\n \n-        UpdateNoWindow upd = new UpdateNoWindow(mOsSdkFolder, mSdkManager, mSdkLog, force, useHttp);\n+        UpdateNoWindow upd = new UpdateNoWindow(mOsSdkFolder, mSdkManager, mSdkLog,\n+                force, useHttp, proxyHost, proxyPort);\n         upd.updateAll(pkgFilter, obsolete, dryMode);\n     }\n \n"", ""SdkCommandLine.java"": ""@@ -74,6 +74,8 @@ class SdkCommandLine extends CommandLineProcessor {\n     public static final String KEY_MAIN_PROJECT = \""main\"";\n     public static final String KEY_NO_UI        = \""no-ui\"";\n     public static final String KEY_NO_HTTPS     = \""no-https\"";\n+    public static final String KEY_PROXY_PORT   = \""proxy-port\"";\n+    public static final String KEY_PROXY_HOST   = \""proxy-host\"";\n     public static final String KEY_DRY_MODE     = \""dry-mode\"";\n     public static final String KEY_OBSOLETE     = \""obsolete\"";\n \n@@ -199,6 +201,22 @@ class SdkCommandLine extends CommandLineProcessor {\n                 VERB_UPDATE, OBJECT_SDK, \""s\"", KEY_NO_HTTPS,\n                 \""Uses HTTP instead of HTTPS (the default) for downloads\"", false);\n \n+        define(Mode.STRING, false,\n+                VERB_UPDATE, OBJECT_SDK, \""\"", KEY_PROXY_PORT,\n+                \""HTTPS/HTTPS proxy port (overrides settings if defined)\"",\n+                null);\n+\n+        define(Mode.STRING, false,\n+                VERB_UPDATE, OBJECT_SDK, \""\"", KEY_PROXY_HOST,\n+                \""HTTPS/HTTPS proxy host (overrides settings if defined)\"",\n+                null);\n+\n+        define(Mode.STRING, false,\n+                VERB_UPDATE, OBJECT_SDK, \""t\"", KEY_FILTER,\n+                \""A filter that limits the update to the specified types of packages in the form of\\n\"" +\n+                \""a comma-separated list of \"" + Arrays.toString(SdkRepoConstants.NODES),\n+                null);\n+\n         define(Mode.BOOLEAN, false,\n                 VERB_UPDATE, OBJECT_SDK, \""f\"", KEY_FORCE,\n                 \""Forces replacement of a package or its parts, even if something has been modified\"",\n@@ -207,7 +225,7 @@ class SdkCommandLine extends CommandLineProcessor {\n         define(Mode.STRING, false,\n                 VERB_UPDATE, OBJECT_SDK, \""t\"", KEY_FILTER,\n                 \""A filter that limits the update to the specified types of packages in the form of\\n\"" +\n-                \""                a comma-separated list of \"" + Arrays.toString(SdkRepoConstants.NODES),\n+                \""a comma-separated list of \"" + Arrays.toString(SdkRepoConstants.NODES),\n                 null);\n \n         define(Mode.BOOLEAN, false,\n@@ -467,4 +485,14 @@ class SdkCommandLine extends CommandLineProcessor {\n     public String getParamFilter() {\n         return ((String) getValue(null, null, KEY_FILTER));\n     }\n+\n+    /** Helper to retrieve the --proxy-host value. */\n+    public String getProxyHost() {\n+        return ((String) getValue(null, null, KEY_PROXY_HOST));\n+    }\n+\n+    /** Helper to retrieve the --proxy-port value. */\n+    public String getProxyPort() {\n+        return ((String) getValue(null, null, KEY_PROXY_PORT));\n+    }\n }\n"", ""SettingsController.java"": ""@@ -258,7 +258,7 @@ public class SettingsController {\n         String newHttpsSetting = mProperties.getProperty(ISettingsPage.KEY_FORCE_HTTP,\r\n                 Boolean.FALSE.toString());\r\n         if (!newHttpsSetting.equals(oldHttpsSetting)) {\r\n-            // In case the HTTP/HTTPS setting change, force sources to be reloaded\r\n+            // In case the HTTP/HTTPS setting changes, force sources to be reloaded\r\n             // (this only refreshes sources that the user has already tried to open.)\r\n             mUpdaterData.refreshSources(false /*forceFetching*/);\r\n         }\r\n@@ -276,11 +276,18 @@ public class SettingsController {\n         String proxyPort = mProperties.getProperty(ISettingsPage.KEY_HTTP_PROXY_PORT,\r\n                 \""\""); //$NON-NLS-1$\r\n \r\n-        // Set both the HTTP and HTTPS proxy system properties\r\n-        props.setProperty(ISettingsPage.KEY_HTTP_PROXY_HOST, proxyHost);\r\n-        props.setProperty(ISettingsPage.KEY_HTTP_PROXY_PORT, proxyPort);\r\n-        props.setProperty(\""https.proxyHost\"", proxyHost); //$NON-NLS-1$\r\n-        props.setProperty(\""https.proxyPort\"", proxyPort); //$NON-NLS-1$\r\n+        // Set both the HTTP and HTTPS proxy system properties.\r\n+        // The system property constants can be found in the Java SE documentation at\r\n+        // http://download.oracle.com/javase/6/docs/technotes/guides/net/proxies.html\r\n+        final String JAVA_PROP_HTTP_PROXY_HOST =  \""http.proxyHost\"";      //$NON-NLS-1$\r\n+        final String JAVA_PROP_HTTP_PROXY_PORT =  \""http.proxyPort\"";      //$NON-NLS-1$\r\n+        final String JAVA_PROP_HTTPS_PROXY_HOST = \""https.proxyHost\"";     //$NON-NLS-1$\r\n+        final String JAVA_PROP_HTTPS_PROXY_PORT = \""https.proxyPort\"";     //$NON-NLS-1$\r\n+\r\n+        props.setProperty(JAVA_PROP_HTTP_PROXY_HOST,  proxyHost);\r\n+        props.setProperty(JAVA_PROP_HTTP_PROXY_PORT,  proxyPort);\r\n+        props.setProperty(JAVA_PROP_HTTPS_PROXY_HOST, proxyHost);\r\n+        props.setProperty(JAVA_PROP_HTTPS_PROXY_PORT, proxyPort);\r\n      }\r\n \r\n }\r\n"", ""UpdateNoWindow.java"": ""@@ -24,6 +24,7 @@ import com.android.sdklib.internal.repository.ITaskMonitor;\n import com.android.sdklib.repository.SdkRepoConstants;\n \n import java.util.ArrayList;\n+import java.util.Properties;\n \n /**\n  * Performs an update using only a non-interactive console output with no GUI.\n@@ -53,20 +54,26 @@ public class UpdateNoWindow {\n      * @param force The reply to any question asked by the update process. Currently this will\n      *   be yes/no for ability to replace modified samples or restart ADB.\n      * @param useHttp True to force using HTTP instead of HTTPS for downloads.\n+     * @param proxyPort An optional HTTP/HTTPS proxy port. Can be null.\n+     * @param proxyHost An optional HTTP/HTTPS proxy host. Can be null.\n      */\n     public UpdateNoWindow(String osSdkRoot,\n             SdkManager sdkManager,\n             ISdkLog sdkLog,\n             boolean force,\n-            boolean useHttp) {\n+            boolean useHttp,\n+            String proxyHost,\n+            String proxyPort) {\n         mSdkLog = sdkLog;\n         mForce = force;\n         mUpdaterData = new UpdaterData(osSdkRoot, sdkLog);\n \n         // Read and apply settings from settings file, so that http/https proxy is set\n+        // and let the command line args override them as necessary.\n         SettingsController settingsController = mUpdaterData.getSettingsController();\n         settingsController.loadSettings();\n         settingsController.applySettings();\n+        setupProxy(proxyHost, proxyPort);\n \n         // Change the in-memory settings to force the http/https mode\n         settingsController.setSetting(ISettingsPage.KEY_FORCE_HTTP, useHttp);\n@@ -86,7 +93,6 @@ public class UpdateNoWindow {\n         mUpdaterData.setupDefaultSources();\n \n         mUpdaterData.getLocalSdkParser().parseSdk(osSdkRoot, sdkManager, sdkLog);\n-\n     }\n \n     /**\n@@ -105,6 +111,33 @@ public class UpdateNoWindow {\n         mUpdaterData.updateOrInstallAll_NoGUI(pkgFilter, includeObsoletes, dryMode);\n     }\n \n+    // -----\n+\n+    /**\n+     * Sets both the HTTP and HTTPS proxy system properties, overriding the ones\n+     * from the settings with these values if they are defined.\n+     */\n+    private void setupProxy(String proxyHost, String proxyPort) {\n+\n+        // The system property constants can be found in the Java SE documentation at\n+        // http://download.oracle.com/javase/6/docs/technotes/guides/net/proxies.html\n+        final String JAVA_PROP_HTTP_PROXY_HOST =  \""http.proxyHost\"";      //$NON-NLS-1$\n+        final String JAVA_PROP_HTTP_PROXY_PORT =  \""http.proxyPort\"";      //$NON-NLS-1$\n+        final String JAVA_PROP_HTTPS_PROXY_HOST = \""https.proxyHost\"";     //$NON-NLS-1$\n+        final String JAVA_PROP_HTTPS_PROXY_PORT = \""https.proxyPort\"";     //$NON-NLS-1$\n+\n+        Properties props = System.getProperties();\n+\n+        if (proxyHost != null && proxyHost.length() > 0) {\n+            props.setProperty(JAVA_PROP_HTTP_PROXY_HOST,  proxyHost);\n+            props.setProperty(JAVA_PROP_HTTPS_PROXY_HOST, proxyHost);\n+        }\n+        if (proxyPort != null && proxyPort.length() > 0) {\n+            props.setProperty(JAVA_PROP_HTTP_PROXY_PORT,  proxyPort);\n+            props.setProperty(JAVA_PROP_HTTPS_PROXY_PORT, proxyPort);\n+        }\n+    }\n+\n     /**\n      * A custom implementation of {@link ITaskFactory} that provides {@link ConsoleTask} objects.\n      */\n""}","feature, refactor 
"
22392,RaphaÃ«l Moll,SDK Manager: fix extra package update detection.,"['sdkmanager/libs/sdkuilib/src/com/android/sdkuilib/internal/repository/RepoSourcesAdapter.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/internal/repository/ExtraPackage.java']","SDK Manager: fix extra package update detection.

(cherry picked from commit fcb38f8f3ee58bbac65340c4878f8ab66431ddb6)

Change-Id: I44eeeb06dd406beb8ab53288da7b1eca3f74edad",https://android-review.googlesource.com/c/22392,"bug
",bug,Bug;,"{""ExtraPackage.java"": ""@@ -394,19 +394,33 @@ public class ExtraPackage extends MinToolsPackage\n             ExtraPackage ep = (ExtraPackage) pkg;\r\n \r\n             // To be backward compatible, we need to support the old vendor-path form\r\n-            if (ep.mPath != null && (ep.mVendor == null || ep.mVendor.length() == 0) &&\r\n-                    mPath != null && mVendor != null) {\r\n-                if (ep.mPath.equals(mVendor + \""-\"" + mPath)) {  //$NON-NLS-1$\r\n+            // in either the current or the remote package.\r\n+            //\r\n+            // The vendor test below needs to account for an old installed package\r\n+            // (e.g. with an install path of vendor-name) that has then beeen updated\r\n+            // in-place and thus when reloaded contains the vendor name in both the\r\n+            // path and the vendor attributes.\r\n+            if (ep.mPath != null && mPath != null && mVendor != null) {\r\n+                if (ep.mPath.equals(mVendor + \""-\"" + mPath) &&  //$NON-NLS-1$\r\n+                        (ep.mVendor == null || ep.mVendor.length() == 0\r\n+                                || ep.mVendor.equals(mVendor))) {\r\n+                    return true;\r\n+                }\r\n+            }\r\n+            if (mPath != null && ep.mPath != null && ep.mVendor != null) {\r\n+                if (mPath.equals(ep.mVendor + \""-\"" + ep.mPath) &&  //$NON-NLS-1$\r\n+                        (mVendor == null || mVendor.length() == 0 || mVendor.equals(ep.mVendor))) {\r\n                     return true;\r\n                 }\r\n             }\r\n \r\n+\r\n             if (!mPath.equals(ep.mPath)) {\r\n                 return false;\r\n             }\r\n             if ((mVendor == null && ep.mVendor == null) ||\r\n-                (mVendor != null && !mVendor.equals(ep.mVendor))) {\r\n-                return false;\r\n+                (mVendor != null && mVendor.equals(ep.mVendor))) {\r\n+                return true;\r\n             }\r\n         }\r\n \r\n"", ""RepoSourcesAdapter.java"": ""@@ -316,13 +316,13 @@ public class RepoSourcesAdapter {\n         // get the installed packages\r\n         Package[] installedPackages = mUpdaterData.getInstalledPackages();\r\n \r\n+        // we'll populate this package list with either upgrades or new packages.\r\n         ArrayList<Package> filteredList = new ArrayList<Package>();\r\n \r\n         // for each remote packages, we look for an existing version.\r\n         // If no existing version -> add to the list\r\n         // if existing version but with older revision -> add it to the list\r\n         for (Package remotePkg : remotePackages) {\r\n-            boolean newPkg = true;\r\n \r\n             // Obsolete packages are not offered as updates.\r\n             if (remotePkg.isObsolete()) {\r\n@@ -332,20 +332,27 @@ public class RepoSourcesAdapter {\n             // For all potential packages, we also make sure that there's an archive for\r\n             // the current platform, or we simply skip them.\r\n             if (remotePkg.hasCompatibleArchive()) {\r\n-                for (Package installedPkg : installedPackages) {\r\n+                boolean keepPkg = true;\r\n+\r\n+                nextPkg: for (Package installedPkg : installedPackages) {\r\n                     UpdateInfo info = installedPkg.canBeUpdatedBy(remotePkg);\r\n-                    if (info == UpdateInfo.UPDATE) {\r\n-                        filteredList.add(remotePkg);\r\n-                        newPkg = false;\r\n-                        break; // there shouldn't be 2 revisions of the same package\r\n-                    } else if (info != UpdateInfo.INCOMPATIBLE) {\r\n-                        newPkg = false;\r\n-                        break; // there shouldn't be 2 revisions of the same package\r\n+                    switch(info) {\r\n+                    case UPDATE:\r\n+                        // The remote package is an update to an existing one.\r\n+                        // We're done looking.\r\n+                        keepPkg = true;\r\n+                        break nextPkg;\r\n+                    case NOT_UPDATE:\r\n+                        // The remote package is the same as one that is already installed.\r\n+                        keepPkg = false;\r\n+                        break;\r\n+                    case INCOMPATIBLE:\r\n+                        // We can't compare and decide on incompatible things.\r\n+                        break;\r\n                     }\r\n                 }\r\n \r\n-                // if we have not found the same package, then we add it (it's a new package)\r\n-                if (newPkg) {\r\n+                if (keepPkg) {\r\n                     filteredList.add(remotePkg);\r\n                 }\r\n             }\r\n""}","feature 
"
17509,Bheemsen kulkarni,System/bluetooth/bludroid:Remove the 3 second delay after starting bluetoothd,['bluedroid/bluetooth.c'],"System/bluetooth/bludroid:Remove the 3 second delay after starting bluetoothd

Remove the 3 second delay, which is not required for bluetoothd,
We wait for 10 secs to get the adapter path in android_server_BluetoothEventLoop.cpp,
which will handle the bluetoothd delay.

Change-Id: I194610675fcca70c908baf206318281ecde78fab
Signed-off-by: Bheemsen Kulkarni <x0099674@ti.com>",https://android-review.googlesource.com/c/17509,"bug, refactor 
",bug,Deprecat;,"{""bluetooth.c"": ""@@ -183,7 +183,6 @@ int bt_enable() {\n         LOGE(\""Failed to start bluetoothd\"");\n         goto out;\n     }\n-    sleep(HCID_START_DELAY_SEC);\n \n     ret = 0;\n \n""}","bug, refactor 
"
22457,Martin StorsjÃ¶,stagefright aacenc: Fix type definitions for 64 bit platforms,['media/libstagefright/codecs/aacenc/basic_op/typedefs.h'],"stagefright aacenc: Fix type definitions for 64 bit platforms

Also don't require LINUX to be defined, enable the MSVC typedefs
only within _MSC_VER.

Change-Id: I4afbe0ed81295ebe6e5ee2c7f0fb0cc2dc83c89b",https://android-review.googlesource.com/c/22457,"bug
",bug,Bug;,"{""typedefs.h"": ""@@ -77,12 +77,12 @@ typedef unsigned short UWord16;\n /*\n  ********* define 32 bit signed/unsigned types & constants\n  */\n-typedef long Word32;\n-typedef unsigned long UWord32;\n+typedef int Word32;\n+typedef unsigned int UWord32;\n \n \r\n \r\n-#ifdef LINUX\n+#ifndef _MSC_VER\n typedef long long Word64;\n typedef unsigned long long UWord64;\n #else\n""}","bug, refactor 
"
13386,AndrÃ© Goddard Rosa,improve readability of stdlib: fix indentation and remove trailing spaces,"['libc/stdlib/getenv.c', 'libc/stdlib/sha1hash.c', 'libc/stdlib/qsort.c', 'libc/stdlib/seed48.c', 'libc/stdlib/assert.c', 'libc/stdlib/ctype_.c', 'libc/stdlib/wchar.c', 'libc/stdlib/strtod.c', 'libc/stdlib/putenv.c', 'libc/stdlib/strtoumax.c', 'libc/stdlib/strtoimax.c']","improve readability of stdlib: fix indentation and remove trailing spaces

Signed-off-by: AndrÃ© Goddard Rosa <andre.goddard@gmail.com>
",https://android-review.googlesource.com/c/13386,"refactor
",refactor,Bug;Deprecat;,"{""assert.c"": ""@@ -49,6 +49,6 @@ __assert2(const char *file, int line, const char *func, const char *failedexpr)\n \t(void)fprintf(stderr,\n \t    \""assertion \\\""%s\\\"" failed: file \\\""%s\\\"", line %d, function \\\""%s\\\""\\n\"",\n \t    failedexpr, file, line, func);\n-  abort();\n+\tabort();\n \t/* NOTREACHED */\n }\n"", ""ctype_.c"": ""@@ -53,7 +53,7 @@ const char _C_ctype_[1 + CTYPE_NUM_CHARS] = {\n \t_P,\t_L|_X,\t_L|_X,\t_L|_X,\t_L|_X,\t_L|_X,\t_L|_X,\t_L,\n \t_L,\t_L,\t_L,\t_L,\t_L,\t_L,\t_L,\t_L,\n \t_L,\t_L,\t_L,\t_L,\t_L,\t_L,\t_L,\t_L,\n-/* determine printability based on the IS0 8859 8-bit standard */\n+\t/* determine printability based on the IS0 8859 8-bit standard */\n \t_L,\t_L,\t_L,\t_P,\t_P,\t_P,\t_P,\t_C,\n \n \t_C,\t_C,\t_C,\t_C,\t_C,\t_C,\t_C,\t_C, /* 80 */\n"", ""getenv.c"": ""@@ -62,8 +62,8 @@ __findenv(const char *name, int *offset)\n \t\tif (i == 0 && *cp++ == '=') {\n \t\t\t*offset = p - environ;\n \t\t\treturn (cp);\n-    }\n-  }\n+\t\t}\n+\t}\n \treturn (NULL);\n }\n \n"", ""putenv.c"": ""@@ -42,7 +42,7 @@ putenv(const char *str)\n \tif ((equal = strchr(p, '=')) == NULL) {\n \t\t(void)free(p);\n \t\treturn (-1);\n-  }\n+\t}\n \t*equal = '\\0';\n \trval = setenv(p, equal + 1, 1);\n \t(void)free(p);\n"", ""qsort.c"": ""@@ -39,11 +39,11 @@ static __inline void\t swapfunc(char *, char *, int, int);\n /*\n  * Qsort routine from Bentley & McIlroy's \""Engineering a Sort Function\"".\n  */\n-#define swapcode(TYPE, parmi, parmj, n) { \t\t\\\n-\tlong i = (n) / sizeof (TYPE); \t\t\t\\\n-\tTYPE *pi = (TYPE *) (parmi); \t\t\t\\\n-\tTYPE *pj = (TYPE *) (parmj); \t\t\t\\\n-\tdo { \t\t\t\t\t\t\\\n+#define swapcode(TYPE, parmi, parmj, n) {\t\t\\\n+\tlong i = (n) / sizeof (TYPE);\t\t\t\\\n+\tTYPE *pi = (TYPE *) (parmi);\t\t\t\\\n+\tTYPE *pj = (TYPE *) (parmj);\t\t\t\\\n+\tdo {\t\t\t\t\t\t\\\n \t\tTYPE\tt = *pi;\t\t\t\\\n \t\t*pi++ = *pj;\t\t\t\t\\\n \t\t*pj++ = t;\t\t\t\t\\\n@@ -56,7 +56,7 @@ static __inline void\t swapfunc(char *, char *, int, int);\n static __inline void\n swapfunc(char *a, char *b, int n, int swaptype)\n {\n-\tif (swaptype <= 1) \n+\tif (swaptype <= 1)\n \t\tswapcode(long, a, b, n)\n \telse\n \t\tswapcode(char, a, b, n)\n@@ -70,7 +70,7 @@ swapfunc(char *a, char *b, int n, int swaptype)\n \t} else\t\t\t\t\t\t\\\n \t\tswapfunc(a, b, es, swaptype)\n \n-#define vecswap(a, b, n) \tif ((n) > 0) swapfunc(a, b, n, swaptype)\n+#define vecswap(a, b, n)\tif ((n) > 0) swapfunc(a, b, n, swaptype)\n \n static __inline char *\n med3(char *a, char *b, char *c, int (*cmp)(const void *, const void *))\n@@ -110,7 +110,7 @@ loop:\tSWAPINIT(a, es);\n \t}\n \tswap(a, pm);\n \tpa = pb = (char *)a + es;\n-    \n+\n \tpc = pd = (char *)a + (n - 1) * es;\n \tfor (;;) {\n \t\twhile (pb <= pc && (r = cmp(pb, a)) <= 0) {\n@@ -118,7 +118,7 @@ loop:\tSWAPINIT(a, es);\n \t\t\t\tswap_cnt = 1;\n \t\t\t\tswap(pa, pb);\n \t\t\t\tpa += es;\n-      }\n+\t\t\t}\n \t\t\tpb += es;\n \t\t}\n \t\twhile (pb <= pc && (r = cmp(pc, a)) >= 0) {\n@@ -138,11 +138,11 @@ loop:\tSWAPINIT(a, es);\n \t}\n \tif (swap_cnt == 0) {  /* Switch to insertion sort */\n \t\tfor (pm = (char *) a + es; pm < (char *) a + n * es; pm += es)\n-\t\t\tfor (pl = pm; pl > (char *) a && cmp(pl - es, pl) > 0; \n+\t\t\tfor (pl = pm; pl > (char *) a && cmp(pl - es, pl) > 0;\n \t\t\t     pl -= es)\n \t\t\t\tswap(pl, pl - es);\n \t\treturn;\n-    }\n+\t}\n \n \tpn = (char *)a + n * es;\n \tr = min(pa - (char *)a, pb - pa);\n@@ -151,11 +151,11 @@ loop:\tSWAPINIT(a, es);\n \tvecswap(pb, pn - r, r);\n \tif ((r = pb - pa) > (int)es)\n \t\tqsort(a, r / es, es, cmp);\n-\tif ((r = pd - pc) > (int)es) { \n+\tif ((r = pd - pc) > (int)es) {\n \t\t/* Iterate rather than recurse to save stack space */\n \t\ta = pn - r;\n \t\tn = r / es;\n \t\tgoto loop;\n \t}\n-/*\t\tqsort(pn - r, r / es, es, cmp);*/\n+\t/* qsort(pn - r, r / es, es, cmp); */\n }\n"", ""seed48.c"": ""@@ -22,7 +22,7 @@ unsigned short *\n seed48(unsigned short xseed[3])\n {\n \tstatic unsigned short sseed[3];\n-  \n+\n \tsseed[0] = __rand48_seed[0];\n \tsseed[1] = __rand48_seed[1];\n \tsseed[2] = __rand48_seed[2];\n"", ""sha1hash.c"": ""@@ -4,7 +4,7 @@ By Steve Reid <sreid@sea-to-sky.net>\n 100% Public Domain\n \n -----------------\n-Modified 7/98 \n+Modified 7/98\n By James H. Brown <jbrown@burgoyne.com>\n Still 100% Public Domain\n \n@@ -26,7 +26,7 @@ Since the file IO in main() reads 16K at a time, any file 8K or larger would\n be guaranteed to generate the wrong hash (e.g. Test Vector #3, a million\n \""a\""s).\n \n-I also changed the declaration of variables i & j in SHA1Update to \n+I also changed the declaration of variables i & j in SHA1Update to\n unsigned long from unsigned int for the same reason.\n \n These changes should make no difference to any 32 bit implementations since\n@@ -53,7 +53,7 @@ Still 100% public domain\n Modified 4/01\n By Saul Kravitz <Saul.Kravitz@celera.com>\n Still 100% PD\n-Modified to run on Compaq Alpha hardware.  \n+Modified to run on Compaq Alpha hardware.\n \n -----------------\n Modified 2/03\n@@ -92,7 +92,7 @@ typedef struct {\n \n void SHA1Transform(uint32_t state[5], unsigned char buffer[64]);\n void SHA1Init(SHA1_CTX* context);\n-void SHA1Update(SHA1_CTX* context, unsigned char* data, uint32_t len);\t/*\n+void SHA1Update(SHA1_CTX* context, unsigned char* data, uint32_t len);/*\n JHB */\n void SHA1Final(unsigned char digest[20], SHA1_CTX* context);\n \n@@ -116,7 +116,7 @@ void SHA1Final(unsigned char digest[20], SHA1_CTX* context);\n void SHAPrintContext(SHA1_CTX *context, char *msg){\n   printf(\""%s (%d,%d) %x %x %x %x %x\\n\"",\n \t msg,\n-\t context->count[0], context->count[1], \n+\t context->count[0], context->count[1],\n \t context->state[0],\n \t context->state[1],\n \t context->state[2],\n@@ -238,8 +238,7 @@ unsigned char finalcount[8];\n     while ((context->count[0] & 504) != 448) {\n         SHA1Update(context, (unsigned char *)\""\\0\"", 1);\n     }\n-    SHA1Update(context, finalcount, 8);  /* Should cause a SHA1Transform()\n-*/\n+    SHA1Update(context, finalcount, 8);  /* Should cause a SHA1Transform() */\n     for (i = 0; i < 20; i++) {\n         digest[i] = (unsigned char)\n          ((context->state[i>>2] >> ((3-(i & 3)) * 8) ) & 255);\n@@ -254,7 +253,7 @@ unsigned char finalcount[8];\n     SHA1Transform(context->state, context->buffer);\n #endif\n }\n-  \n+\n /*************************************************************/\n \n /* This is not quite the MIME base64 algorithm: it uses _ instead of /,\n@@ -302,7 +301,7 @@ int main(int argc, char** argv)\n       fputs(\""Unable to open file.\"", stderr);\n       return(-1);\n     }\n-  } \n+  }\n   SHA1Init(&context);\n   while (!feof(file)) {  /* note: what if ferror(file) */\n     i = fread(buffer, 1, 16384, file);\n"", ""strtod.c"": ""@@ -364,7 +364,7 @@ Bigint {\n \tstruct Bigint *next;\n \tint k, maxwds, sign, wds;\n \tULong x[1];\n-\t};\n+};\n \n  typedef struct Bigint Bigint;\n \n@@ -393,19 +393,19 @@ Balloc\n \n \tif ((rv = freelist[k]) != NULL) {\n \t\tfreelist[k] = rv->next;\n-\t\t}\n+\t}\n \telse {\n \t\tx = 1 << k;\n \t\trv = (Bigint *)MALLOC(sizeof(Bigint) + (x-1)*sizeof(Long));\n \t\trv->k = k;\n \t\trv->maxwds = x;\n-\t\t}\n+\t}\n \trv->sign = rv->wds = 0;\n \n \tmutex_unlock(&freelist_mutex);\n \n \treturn rv;\n-\t}\n+}\n \n  static void\n Bfree\n@@ -422,8 +422,8 @@ Bfree\n \t\tfreelist[v->k] = v;\n \n \t\tmutex_unlock(&freelist_mutex);\n-\t\t}\n \t}\n+}\n \n #define Bcopy(x,y) memcpy(&x->sign, &y->sign, \\\n     y->wds*sizeof(Long) + 2*sizeof(int))\n@@ -458,8 +458,8 @@ multadd\n \t\ta = (int)(y >> 16);\n \t\t*x++ = y & 0xffff;\n #endif\n-\t\t}\n-\t\twhile(++i < wds);\n+\t}\n+\twhile(++i < wds);\n \tif (a) {\n \t\tif (wds >= b->maxwds) {\n \t\t\tb1 = Balloc(b->k+1);\n@@ -469,9 +469,9 @@ multadd\n \t\t\t}\n \t\tb->x[wds++] = a;\n \t\tb->wds = wds;\n-\t\t}\n-\treturn b;\n \t}\n+\treturn b;\n+}\n \n  static Bigint *\n s2b\n@@ -503,13 +503,13 @@ s2b\n \t\tdo b = multadd(b, 10, *s++ - '0');\n \t\t\twhile(++i < nd0);\n \t\ts++;\n-\t\t}\n+\t}\n \telse\n \t\ts += 10;\n \tfor(; i < nd; i++)\n \t\tb = multadd(b, 10, *s++ - '0');\n \treturn b;\n-\t}\n+}\n \n  static int\n hi0bits\n@@ -524,26 +524,26 @@ hi0bits\n \tif (!(x & 0xffff0000)) {\n \t\tk = 16;\n \t\tx <<= 16;\n-\t\t}\n+\t}\n \tif (!(x & 0xff000000)) {\n \t\tk += 8;\n \t\tx <<= 8;\n-\t\t}\n+\t}\n \tif (!(x & 0xf0000000)) {\n \t\tk += 4;\n \t\tx <<= 4;\n-\t\t}\n+\t}\n \tif (!(x & 0xc0000000)) {\n \t\tk += 2;\n \t\tx <<= 2;\n-\t\t}\n+\t}\n \tif (!(x & 0x80000000)) {\n \t\tk++;\n \t\tif (!(x & 0x40000000))\n \t\t\treturn 32;\n-\t\t}\n-\treturn k;\n \t}\n+\treturn k;\n+}\n \n  static int\n lo0bits\n@@ -565,33 +565,33 @@ lo0bits\n \t\t\t}\n \t\t*y = x >> 2;\n \t\treturn 2;\n-\t\t}\n+\t}\n \tk = 0;\n \tif (!(x & 0xffff)) {\n \t\tk = 16;\n \t\tx >>= 16;\n-\t\t}\n+\t}\n \tif (!(x & 0xff)) {\n \t\tk += 8;\n \t\tx >>= 8;\n-\t\t}\n+\t}\n \tif (!(x & 0xf)) {\n \t\tk += 4;\n \t\tx >>= 4;\n-\t\t}\n+\t}\n \tif (!(x & 0x3)) {\n \t\tk += 2;\n \t\tx >>= 2;\n-\t\t}\n+\t}\n \tif (!(x & 1)) {\n \t\tk++;\n \t\tx >>= 1;\n \t\tif (!x & 1)\n \t\t\treturn 32;\n-\t\t}\n+\t}\n \t*y = x;\n \treturn k;\n-\t}\n+}\n \n  static Bigint *\n i2b\n@@ -607,7 +607,7 @@ i2b\n \tb->x[0] = i;\n \tb->wds = 1;\n \treturn b;\n-\t}\n+}\n \n  static Bigint *\n mult\n@@ -629,7 +629,7 @@ mult\n \t\tc = a;\n \t\ta = b;\n \t\tb = c;\n-\t\t}\n+\t}\n \tk = a->k;\n \twa = a->wds;\n \twb = b->wds;\n@@ -656,10 +656,10 @@ mult\n \t\t\t\tz2 = (*x++ >> 16) * y + (*xc >> 16) + carry;\n \t\t\t\tcarry = z2 >> 16;\n \t\t\t\tStoreinc(xc, z2, z);\n-\t\t\t\t}\n-\t\t\t\twhile(x < xae);\n-\t\t\t*xc = carry;\n \t\t\t}\n+\t\t\twhile(x < xae);\n+\t\t\t*xc = carry;\n+\t\t}\n \t\tif ((y = *xb >> 16) != 0) {\n \t\t\tx = xa;\n \t\t\txc = xc0;\n@@ -671,11 +671,11 @@ mult\n \t\t\t\tStoreinc(xc, z, z2);\n \t\t\t\tz2 = (*x++ >> 16) * y + (*xc & 0xffff) + carry;\n \t\t\t\tcarry = z2 >> 16;\n-\t\t\t\t}\n-\t\t\t\twhile(x < xae);\n-\t\t\t*xc = z2;\n \t\t\t}\n+\t\t\twhile(x < xae);\n+\t\t\t*xc = z2;\n \t\t}\n+\t}\n #else\n \tfor(; xb < xbe; xc0++) {\n \t\tif (y = *xb++) {\n@@ -686,16 +686,16 @@ mult\n \t\t\t\tz = *x++ * y + *xc + carry;\n \t\t\t\tcarry = z >> 16;\n \t\t\t\t*xc++ = z & 0xffff;\n-\t\t\t\t}\n-\t\t\t\twhile(x < xae);\n-\t\t\t*xc = carry;\n \t\t\t}\n+\t\t\twhile(x < xae);\n+\t\t\t*xc = carry;\n \t\t}\n+\t}\n #endif\n \tfor(xc0 = c->x, xc = xc0 + wc; wc > 0 && !*--xc; --wc) ;\n \tc->wds = wc;\n \treturn c;\n-\t}\n+}\n \n  static Bigint *p5s;\n \n@@ -720,23 +720,23 @@ pow5mult\n \t\t/* first time */\n \t\tp5 = p5s = i2b(625);\n \t\tp5->next = 0;\n-\t\t}\n+\t}\n \tfor(;;) {\n \t\tif (k & 1) {\n \t\t\tb1 = mult(b, p5);\n \t\t\tBfree(b);\n \t\t\tb = b1;\n-\t\t\t}\n+\t\t}\n \t\tif (!(k = (unsigned int) k >> 1))\n \t\t\tbreak;\n \t\tif (!(p51 = p5->next)) {\n \t\t\tp51 = p5->next = mult(p5,p5);\n \t\t\tp51->next = 0;\n-\t\t\t}\n-\t\tp5 = p51;\n \t\t}\n-\treturn b;\n+\t\tp5 = p51;\n \t}\n+\treturn b;\n+}\n \n  static Bigint *\n lshift\n@@ -772,11 +772,11 @@ lshift\n \t\tdo {\n \t\t\t*x1++ = *x << k | z;\n \t\t\tz = *x++ >> k1;\n-\t\t\t}\n-\t\t\twhile(x < xe);\n+\t\t}\n+\t\twhile(x < xe);\n \t\tif ((*x1 = z) != 0)\n \t\t\t++n1;\n-\t\t}\n+\t}\n #else\n \tif (k &= 0xf) {\n \t\tk1 = 16 - k;\n@@ -784,11 +784,11 @@ lshift\n \t\tdo {\n \t\t\t*x1++ = *x << k  & 0xffff | z;\n \t\t\tz = *x++ >> k1;\n-\t\t\t}\n-\t\t\twhile(x < xe);\n+\t\t}\n+\t\twhile(x < xe);\n \t\tif (*x1 = z)\n \t\t\t++n1;\n-\t\t}\n+\t}\n #endif\n \telse do\n \t\t*x1++ = *x++;\n@@ -796,7 +796,7 @@ lshift\n \tb1->wds = n1 - 1;\n \tBfree(b);\n \treturn b1;\n-\t}\n+}\n \n  static int\n cmp\n@@ -828,9 +828,9 @@ cmp\n \t\t\treturn *xa < *xb ? -1 : 1;\n \t\tif (xa <= xa0)\n \t\t\tbreak;\n-\t\t}\n-\treturn 0;\n \t}\n+\treturn 0;\n+}\n \n  static Bigint *\n diff\n@@ -854,13 +854,13 @@ diff\n \t\tc->wds = 1;\n \t\tc->x[0] = 0;\n \t\treturn c;\n-\t\t}\n+\t}\n \tif (i < 0) {\n \t\tc = a;\n \t\ta = b;\n \t\tb = c;\n \t\ti = 1;\n-\t\t}\n+\t}\n \telse\n \t\ti = 0;\n \tc = Balloc(a->k);\n@@ -882,8 +882,8 @@ diff\n \t\tborrow = (ULong)z >> 16;\n \t\tSign_Extend(borrow, z);\n \t\tStoreinc(xc, z, y);\n-\t\t}\n-\t\twhile(xb < xbe);\n+\t}\n+\twhile(xb < xbe);\n \twhile(xa < xae) {\n \t\ty = (*xa & 0xffff) + borrow;\n \t\tborrow = (ULong)y >> 16;\n@@ -892,27 +892,27 @@ diff\n \t\tborrow = (ULong)z >> 16;\n \t\tSign_Extend(borrow, z);\n \t\tStoreinc(xc, z, y);\n-\t\t}\n+\t}\n #else\n \tdo {\n \t\ty = *xa++ - *xb++ + borrow;\n \t\tborrow = y >> 16;\n \t\tSign_Extend(borrow, y);\n \t\t*xc++ = y & 0xffff;\n-\t\t}\n-\t\twhile(xb < xbe);\n+\t}\n+\twhile(xb < xbe);\n \twhile(xa < xae) {\n \t\ty = *xa++ + borrow;\n \t\tborrow = y >> 16;\n \t\tSign_Extend(borrow, y);\n \t\t*xc++ = y & 0xffff;\n-\t\t}\n+\t}\n #endif\n \twhile(!*--xc)\n \t\twa--;\n \tc->wds = wa;\n \treturn c;\n-\t}\n+}\n \n  static double\n ulp\n@@ -937,22 +937,22 @@ ulp\n \t\tword0(a) = L;\n \t\tword1(a) = 0;\n #ifndef Sudden_Underflow\n-\t\t}\n+\t}\n \telse {\n \t\tL = (ULong)-L >> Exp_shift;\n \t\tif (L < Exp_shift) {\n \t\t\tword0(a) = 0x80000 >> L;\n \t\t\tword1(a) = 0;\n-\t\t\t}\n+\t\t}\n \t\telse {\n \t\t\tword0(a) = 0;\n \t\t\tL -= Exp_shift;\n \t\t\tword1(a) = L >= 31 ? 1 : 1 << (31 - L);\n-\t\t\t}\n \t\t}\n+\t}\n #endif\n \treturn value(a);\n-\t}\n+}\n \n  static double\n b2d\n@@ -986,17 +986,17 @@ b2d\n \t\tw = xa > xa0 ? *--xa : 0;\n \t\td1 = y << ((32-Ebits) + k) | w >> (Ebits - k);\n \t\tgoto ret_d;\n-\t\t}\n+\t}\n \tz = xa > xa0 ? *--xa : 0;\n \tif (k -= Ebits) {\n \t\td0 = Exp_1 | y << k | z >> (32 - k);\n \t\ty = xa > xa0 ? *--xa : 0;\n \t\td1 = z << k | y >> (32 - k);\n-\t\t}\n+\t}\n \telse {\n \t\td0 = Exp_1 | y;\n \t\td1 = z;\n-\t\t}\n+\t}\n #else\n \tif (k < Ebits + 16) {\n \t\tz = xa > xa0 ? *--xa : 0;\n@@ -1005,7 +1005,7 @@ b2d\n \t\ty = xa > xa0 ? *--xa : 0;\n \t\td1 = z << k + 16 - Ebits | w << k - Ebits | y >> 16 + Ebits - k;\n \t\tgoto ret_d;\n-\t\t}\n+\t}\n \tz = xa > xa0 ? *--xa : 0;\n \tw = xa > xa0 ? *--xa : 0;\n \tk -= Ebits + 16;\n@@ -1022,7 +1022,7 @@ b2d\n #undef d1\n #endif\n \treturn value(d);\n-\t}\n+}\n \n  static Bigint *\n d2b\n@@ -1072,11 +1072,11 @@ d2b\n \t\tif ((k = lo0bits(&y)) != 0) {\n \t\t\tx[0] = y | z << (32 - k);\n \t\t\tz >>= k;\n-\t\t\t}\n+\t\t}\n \t\telse\n \t\t\tx[0] = y;\n \t\ti = b->wds = (x[1] = z) ? 2 : 1;\n-\t\t}\n+\t}\n \telse {\n #ifdef DEBUG\n \t\tif (!z)\n@@ -1086,7 +1086,7 @@ d2b\n \t\tx[0] = z;\n \t\ti = b->wds = 1;\n \t\tk += 32;\n-\t\t}\n+\t}\n #else\n \tif (y = d1) {\n \t\tif (k = lo0bits(&y))\n@@ -1095,22 +1095,22 @@ d2b\n \t\t\t\tx[1] = z >> k - 16 & 0xffff;\n \t\t\t\tx[2] = z >> k;\n \t\t\t\ti = 2;\n-\t\t\t\t}\n+\t\t\t}\n \t\t\telse {\n \t\t\t\tx[0] = y & 0xffff;\n \t\t\t\tx[1] = y >> 16 | z << 16 - k & 0xffff;\n \t\t\t\tx[2] = z >> k & 0xffff;\n \t\t\t\tx[3] = z >> k+16;\n \t\t\t\ti = 3;\n-\t\t\t\t}\n+\t\t\t}\n \t\telse {\n \t\t\tx[0] = y & 0xffff;\n \t\t\tx[1] = y >> 16;\n \t\t\tx[2] = z & 0xffff;\n \t\t\tx[3] = z >> 16;\n \t\t\ti = 3;\n-\t\t\t}\n \t\t}\n+\t}\n \telse {\n #ifdef DEBUG\n \t\tif (!z)\n@@ -1120,14 +1120,14 @@ d2b\n \t\tif (k >= 16) {\n \t\t\tx[0] = z;\n \t\t\ti = 0;\n-\t\t\t}\n+\t\t}\n \t\telse {\n \t\t\tx[0] = z & 0xffff;\n \t\t\tx[1] = z >> 16;\n \t\t\ti = 1;\n-\t\t\t}\n-\t\tk += 32;\n \t\t}\n+\t\tk += 32;\n+\t}\n \twhile(!x[i])\n \t\t--i;\n \tb->wds = i + 1;\n@@ -1143,7 +1143,7 @@ d2b\n \t\t*bits = P - k;\n #endif\n #ifndef Sudden_Underflow\n-\t\t}\n+\t}\n \telse {\n \t\t*e = de - Bias - (P-1) + 1 + k;\n #ifdef Pack_32\n@@ -1154,7 +1154,7 @@ d2b\n \t\t}\n #endif\n \treturn b;\n-\t}\n+}\n #undef d0\n #undef d1\n \n@@ -1181,23 +1181,23 @@ ratio\n \t\tword0(da) += (k >> 2)*Exp_msk1;\n \t\tif (k &= 3)\n \t\t\tda *= 1 << k;\n-\t\t}\n+\t}\n \telse {\n \t\tk = -k;\n \t\tword0(db) += (k >> 2)*Exp_msk1;\n \t\tif (k &= 3)\n \t\t\tdb *= 1 << k;\n-\t\t}\n+\t}\n #else\n \tif (k > 0)\n \t\tword0(da) += k*Exp_msk1;\n \telse {\n \t\tk = -k;\n \t\tword0(db) += k*Exp_msk1;\n-\t\t}\n+\t}\n #endif\n \treturn value(da) / value(db);\n-\t}\n+}\n \n static CONST double\n tens[] = {\n@@ -1207,7 +1207,7 @@ tens[] = {\n #ifdef VAX\n \t\t, 1e23, 1e24\n #endif\n-\t\t};\n+};\n \n #ifdef IEEE_Arith\n static CONST double bigtens[] = { 1e16, 1e32, 1e64, 1e128, 1e256 };\n@@ -1312,7 +1312,7 @@ strtod\n \t\twhile(*++s == '0') ;\n \t\tif (!*s)\n \t\t\tgoto ret;\n-\t\t}\n+\t}\n \ts0 = s;\n \ty = z = 0;\n \tfor(nd = nf = 0; (c = *s) >= '0' && c <= '9'; nd++, s++)\n@@ -1333,7 +1333,7 @@ strtod\n \t\t\t\tgoto have_dig;\n \t\t\t\t}\n \t\t\tgoto dig_done;\n-\t\t\t}\n+\t\t}\n \t\tfor(; c >= '0' && c <= '9'; c = *++s) {\n  have_dig:\n \t\t\tnz++;\n@@ -1349,16 +1349,16 @@ strtod\n \t\t\t\telse if (nd <= DBL_DIG + 1)\n \t\t\t\t\tz = 10*z + c;\n \t\t\t\tnz = 0;\n-\t\t\t\t}\n \t\t\t}\n \t\t}\n+\t}\n  dig_done:\n \te = 0;\n \tif (c == 'e' || c == 'E') {\n \t\tif (!nd && !nz && !nz0) {\n \t\t\ts = s00;\n \t\t\tgoto ret;\n-\t\t\t}\n+\t\t}\n \t\ts00 = s;\n \t\tesign = 0;\n \t\tswitch(c = *++s) {\n@@ -1367,7 +1367,7 @@ strtod\n \t\t\t\t/* FALLTHROUGH */\n \t\t\tcase '+':\n \t\t\t\tc = *++s;\n-\t\t\t}\n+\t\t}\n \t\tif (c >= '0' && c <= '9') {\n \t\t\twhile(c == '0')\n \t\t\t\tc = *++s;\n@@ -1385,18 +1385,18 @@ strtod\n \t\t\t\t\te = (int)L;\n \t\t\t\tif (esign)\n \t\t\t\t\te = -e;\n-\t\t\t\t}\n+\t\t\t}\n \t\t\telse\n \t\t\t\te = 0;\n-\t\t\t}\n+\t\t}\n \t\telse\n \t\t\ts = s00;\n-\t\t}\n+\t}\n \tif (!nd) {\n \t\tif (!nz && !nz0)\n \t\t\ts = s00;\n \t\tgoto ret;\n-\t\t}\n+\t}\n \te1 = e -= nf;\n \n \t/* Now we have nd0 digits, starting at s0, followed by a\n@@ -1415,7 +1415,7 @@ strtod\n #ifndef RND_PRODQUOT\n \t\t&& FLT_ROUNDS == 1\n #endif\n-\t\t\t) {\n+\t\t) {\n \t\tif (!e)\n \t\t\tgoto ret;\n \t\tif (e > 0) {\n@@ -1427,7 +1427,7 @@ strtod\n \t\t\t\t    tens[e]);\n \t\t\t\tgoto ret;\n #endif\n-\t\t\t\t}\n+\t\t\t}\n \t\t\ti = DBL_DIG - nd;\n \t\t\tif (e <= Ten_pmax + i) {\n \t\t\t\t/* A fancier test would sometimes let us do\n@@ -1452,16 +1452,16 @@ strtod\n \t\t\t\t    tens[e]);\n #endif\n \t\t\t\tgoto ret;\n-\t\t\t\t}\n \t\t\t}\n+\t\t}\n #ifndef Inaccurate_Divide\n \t\telse if (e >= -Ten_pmax) {\n \t\t\t/* value(rv) = */ rounded_quotient(value(rv),\n \t\t\t    tens[-e]);\n \t\t\tgoto ret;\n-\t\t\t}\n-#endif\n \t\t}\n+#endif\n+\t}\n \te1 += nd - k;\n \n \t/* Get starting approximation = rv * 10**e1 */\n@@ -1477,7 +1477,7 @@ strtod\n \t\t\t\tif (bd0)\n \t\t\t\t\tgoto retfree;\n \t\t\t\tgoto ret;\n-\t\t\t\t}\n+\t\t\t}\n \t\t\tif ((e1 = (unsigned int)e1 >> 4) != 0) {\n \t\t\t\tfor(j = 0; e1 > 1; j++,\n \t\t\t\t    e1 = (unsigned int)e1 >> 1)\n@@ -1497,10 +1497,9 @@ strtod\n \t\t\t\t\t}\n \t\t\t\telse\n \t\t\t\t\tword0(rv) += P*Exp_msk1;\n-\t\t\t\t}\n-\n \t\t\t}\n \t\t}\n+\t}\n \telse if (e1 < 0) {\n \t\te1 = -e1;\n \t\tif ((i = e1 & 15) != 0)\n@@ -1526,15 +1525,15 @@ strtod\n \t\t\t\t\tif (bd0)\n \t\t\t\t\t\tgoto retfree;\n \t\t\t\t\tgoto ret;\n-\t\t\t\t\t}\n+\t\t\t\t}\n \t\t\t\tword0(rv) = Tiny0;\n \t\t\t\tword1(rv) = Tiny1;\n \t\t\t\t/* The refinement below will clean\n \t\t\t\t * this approximation up.\n \t\t\t\t */\n-\t\t\t\t}\n \t\t\t}\n \t\t}\n+\t}\n \n \t/* Now the hard part -- adjusting rv to the correct value.*/\n \n@@ -1551,11 +1550,11 @@ strtod\n \t\tif (e >= 0) {\n \t\t\tbb2 = bb5 = 0;\n \t\t\tbd2 = bd5 = e;\n-\t\t\t}\n+\t\t}\n \t\telse {\n \t\t\tbb2 = bb5 = -e;\n \t\t\tbd2 = bd5 = 0;\n-\t\t\t}\n+\t\t}\n \t\tif (bbe >= 0)\n \t\t\tbb2 += bbe;\n \t\telse\n@@ -1583,13 +1582,13 @@ strtod\n \t\t\tbb2 -= i;\n \t\t\tbd2 -= i;\n \t\t\tbs2 -= i;\n-\t\t\t}\n+\t\t}\n \t\tif (bb5 > 0) {\n \t\t\tbs = pow5mult(bs, bb5);\n \t\t\tbb1 = mult(bs, bb);\n \t\t\tBfree(bb);\n \t\t\tbb = bb1;\n-\t\t\t}\n+\t\t}\n \t\tif (bb2 > 0)\n \t\t\tbb = lshift(bb, bb2);\n \t\tif (bd5 > 0)\n@@ -1612,7 +1611,7 @@ strtod\n \t\t\tif (cmp(delta, bs) > 0)\n \t\t\t\tgoto drop_down;\n \t\t\tbreak;\n-\t\t\t}\n+\t\t}\n \t\tif (i == 0) {\n \t\t\t/* exactly half-way between */\n \t\t\tif (dsign) {\n@@ -1627,8 +1626,8 @@ strtod\n \t\t\t\t\t\t;\n \t\t\t\t\tword1(rv) = 0;\n \t\t\t\t\tbreak;\n-\t\t\t\t\t}\n \t\t\t\t}\n+\t\t\t}\n \t\t\telse if (!(word0(rv) & Bndry_mask) && !word1(rv)) {\n  drop_down:\n \t\t\t\t/* boundary case -- decrement exponent */\n@@ -1651,7 +1650,7 @@ strtod\n #else\n \t\t\t\tbreak;\n #endif\n-\t\t\t\t}\n+\t\t\t}\n #ifndef ROUND_BIASED\n \t\t\tif (!(word1(rv) & LSB))\n \t\t\t\tbreak;\n@@ -1665,10 +1664,10 @@ strtod\n \t\t\t\tif (!value(rv))\n \t\t\t\t\tgoto undfl;\n #endif\n-\t\t\t\t}\n+\t\t\t}\n #endif\n \t\t\tbreak;\n-\t\t\t}\n+\t\t}\n \t\tif ((aadj = ratio(delta, bs)) <= 2.) {\n \t\t\tif (dsign)\n \t\t\t\taadj = aadj1 = 1.;\n@@ -1679,7 +1678,7 @@ strtod\n #endif\n \t\t\t\taadj = 1.;\n \t\t\t\taadj1 = -1.;\n-\t\t\t\t}\n+\t\t\t}\n \t\t\telse {\n \t\t\t\t/* special case -- power of FLT_RADIX to be */\n \t\t\t\t/* rounded down... */\n@@ -1690,7 +1689,7 @@ strtod\n \t\t\t\t\taadj *= 0.5;\n \t\t\t\taadj1 = -aadj;\n \t\t\t\t}\n-\t\t\t}\n+\t\t}\n \t\telse {\n \t\t\taadj *= 0.5;\n \t\t\taadj1 = dsign ? aadj : -aadj;\n@@ -1702,12 +1701,12 @@ strtod\n \t\t\t\tcase 0: /* towards 0 */\n \t\t\t\tcase 3: /* towards -infinity */\n \t\t\t\t\taadj1 += 0.5;\n-\t\t\t\t}\n+\t\t\t}\n #else\n \t\t\tif (FLT_ROUNDS == 0)\n \t\t\t\taadj1 += 0.5;\n #endif\n-\t\t\t}\n+\t\t}\n \t\ty = word0(rv) & Exp_mask;\n \n \t\t/* Check for overflow */\n@@ -1724,10 +1723,10 @@ strtod\n \t\t\t\tword0(rv) = Big0;\n \t\t\t\tword1(rv) = Big1;\n \t\t\t\tgoto cont;\n-\t\t\t\t}\n+\t\t\t}\n \t\t\telse\n \t\t\t\tword0(rv) += P*Exp_msk1;\n-\t\t\t}\n+\t\t}\n \t\telse {\n #ifdef Sudden_Underflow\n \t\t\tif ((word0(rv) & Exp_mask) <= P*Exp_msk1) {\n@@ -1740,21 +1739,21 @@ strtod\n #else\n \t\t\t\tif ((word0(rv) & Exp_mask) <= P*Exp_msk1)\n #endif\n-\t\t\t\t\t{\n+\t\t\t\t{\n \t\t\t\t\tif (word0(rv0) == Tiny0\n \t\t\t\t\t && word1(rv0) == Tiny1)\n \t\t\t\t\t\tgoto undfl;\n \t\t\t\t\tword0(rv) = Tiny0;\n \t\t\t\t\tword1(rv) = Tiny1;\n \t\t\t\t\tgoto cont;\n-\t\t\t\t\t}\n+\t\t\t\t}\n \t\t\t\telse\n \t\t\t\t\tword0(rv) -= P*Exp_msk1;\n \t\t\t\t}\n \t\t\telse {\n \t\t\t\tadj = aadj1 * ulp(value(rv));\n \t\t\t\tvalue(rv) += adj;\n-\t\t\t\t}\n+\t\t\t}\n #else\n \t\t\t/* Compute adj so that the IEEE rounding rules will\n \t\t\t * correctly round rv + adj in some half-way cases.\n@@ -1767,11 +1766,11 @@ strtod\n \t\t\t\taadj1 = (double)(int)(aadj + 0.5);\n \t\t\t\tif (!dsign)\n \t\t\t\t\taadj1 = -aadj1;\n-\t\t\t\t}\n+\t\t\t}\n \t\t\tadj = aadj1 * ulp(value(rv));\n \t\t\tvalue(rv) += adj;\n #endif\n-\t\t\t}\n+\t\t}\n \t\tz = word0(rv) & Exp_mask;\n \t\tif (y == z) {\n \t\t\t/* Can we stop now? */\n@@ -1781,16 +1780,16 @@ strtod\n \t\t\tif (dsign || word1(rv) || word0(rv) & Bndry_mask) {\n \t\t\t\tif (aadj < .4999999 || aadj > .5000001)\n \t\t\t\t\tbreak;\n-\t\t\t\t}\n+\t\t\t}\n \t\t\telse if (aadj < .4999999/FLT_RADIX)\n \t\t\t\tbreak;\n-\t\t\t}\n+\t\t}\n  cont:\n \t\tBfree(bb);\n \t\tBfree(bd);\n \t\tBfree(bs);\n \t\tBfree(delta);\n-\t\t}\n+\t}\n  retfree:\n \tBfree(bb);\n \tBfree(bd);\n@@ -1802,7 +1801,7 @@ strtod\n \t\t/* LINTED interface specification */\n \t\t*se = (char *)s;\n \treturn sign ? -value(rv) : value(rv);\n-\t}\n+}\n \n  static int\n quorem\n@@ -1861,15 +1860,15 @@ quorem\n \t\t\tSign_Extend(borrow, y);\n \t\t\t*bx++ = y & 0xffff;\n #endif\n-\t\t\t}\n-\t\t\twhile(sx <= sxe);\n+\t\t}\n+\t\twhile(sx <= sxe);\n \t\tif (!*bxe) {\n \t\t\tbx = b->x;\n \t\t\twhile(--bxe > bx && !*bxe)\n \t\t\t\t--n;\n \t\t\tb->wds = n;\n-\t\t\t}\n \t\t}\n+\t}\n \tif (cmp(b, S) >= 0) {\n \t\tq++;\n \t\tborrow = 0;\n@@ -1897,18 +1896,18 @@ quorem\n \t\t\tSign_Extend(borrow, y);\n \t\t\t*bx++ = y & 0xffff;\n #endif\n-\t\t\t}\n-\t\t\twhile(sx <= sxe);\n+\t\t}\n+\t\twhile(sx <= sxe);\n \t\tbx = b->x;\n \t\tbxe = bx + n;\n \t\tif (!*bxe) {\n \t\t\twhile(--bxe > bx && !*bxe)\n \t\t\t\t--n;\n \t\t\tb->wds = n;\n-\t\t\t}\n \t\t}\n-\treturn q;\n \t}\n+\treturn q;\n+}\n \n /* freedtoa(s) must be used to free values s returned by dtoa\n  * when MULTIPLE_THREADS is #defined.  It should be used in all cases,\n@@ -2028,7 +2027,7 @@ __dtoa\n \t\t/* set sign for everything, including 0's and NaNs */\n \t\t*sign = 1;\n \t\tword0(d) &= ~Sign_bit;\t/* clear sign bit */\n-\t\t}\n+\t}\n \telse\n \t\t*sign = 0;\n \n@@ -2038,7 +2037,7 @@ __dtoa\n #else\n \tif (word0(d)  == 0x8000)\n #endif\n-\t\t{\n+\t{\n \t\t/* Infinity or NaN */\n \t\t*decpt = 9999;\n \t\ts =\n@@ -2046,30 +2045,30 @@ __dtoa\n \t\t\t!word1(d) && !(word0(d) & 0xfffff) ? \""Infinity\"" :\n #endif\n \t\t\t\t\""NaN\"";\n-        result = Balloc(strlen(s)+1);\n-        s0 = (char *)(void *)result;\n-        strcpy(s0, s);\n-        if (rve)\n-            *rve =\n+\t\tresult = Balloc(strlen(s)+1);\n+\t\ts0 = (char *)(void *)result;\n+\t\tstrcpy(s0, s);\n+\t\tif (rve)\n+\t\t\t*rve =\n #ifdef IEEE_Arith\n-                s0[3] ? s0 + 8 :\n+\t\t\t\ts0[3] ? s0 + 8 :\n #endif\n-                        s0 + 3;\n+\t\t\t\ts0 + 3;\n \t\treturn s0;\n-\t\t}\n+\t}\n #endif\n #ifdef IBM\n \tvalue(d) += 0; /* normalize */\n #endif\n \tif (!value(d)) {\n \t\t*decpt = 1;\n-        result = Balloc(2);\n-        s0 = (char *)(void *)result;\n-        strcpy(s0, \""0\"");\n-        if (rve)\n-            *rve = s0 + 1;\n-        return s0;\n-\t\t}\n+\t\tresult = Balloc(2);\n+\t\ts0 = (char *)(void *)result;\n+\t\tstrcpy(s0, \""0\"");\n+\t\tif (rve)\n+\t\t\t*rve = s0 + 1;\n+\t\treturn s0;\n+\t}\n \n \tb = d2b(value(d), &be, &bbits);\n #ifdef Sudden_Underflow\n@@ -2114,7 +2113,7 @@ __dtoa\n #endif\n #ifndef Sudden_Underflow\n \t\tdenorm = 0;\n-\t\t}\n+\t}\n \telse {\n \t\t/* d is denormalized */\n \n@@ -2125,7 +2124,7 @@ __dtoa\n \t\tword0(d2) -= 31*Exp_msk1; /* adjust exponent */\n \t\ti -= (Bias + (P-1) - 1) + 1;\n \t\tdenorm = 1;\n-\t\t}\n+\t}\n #endif\n \tds = (value(d2)-1.5)*0.289529654602168 + 0.1760912590558 +\n \t    i*0.301029995663981;\n@@ -2137,33 +2136,33 @@ __dtoa\n \t\tif (value(d) < tens[k])\n \t\t\tk--;\n \t\tk_check = 0;\n-\t\t}\n+\t}\n \tj = bbits - i - 1;\n \tif (j >= 0) {\n \t\tb2 = 0;\n \t\ts2 = j;\n-\t\t}\n+\t}\n \telse {\n \t\tb2 = -j;\n \t\ts2 = 0;\n-\t\t}\n+\t}\n \tif (k >= 0) {\n \t\tb5 = 0;\n \t\ts5 = k;\n \t\ts2 += k;\n-\t\t}\n+\t}\n \telse {\n \t\tb2 -= k;\n \t\tb5 = -k;\n \t\ts5 = 0;\n-\t\t}\n+\t}\n \tif (mode < 0 || mode > 9)\n \t\tmode = 0;\n \ttry_quick = 1;\n \tif (mode > 5) {\n \t\tmode -= 4;\n \t\ttry_quick = 0;\n-\t\t}\n+\t}\n \tleftright = 1;\n \tswitch(mode) {\n \t\tcase 0:\n@@ -2189,7 +2188,7 @@ __dtoa\n \t\t\tilim1 = i - 1;\n \t\t\tif (i <= 0)\n \t\t\t\ti = 1;\n-\t\t}\n+\t}\n \tj = sizeof(ULong);\n         for(result_k = 0; (int)(sizeof(Bigint) - sizeof(ULong)) + j <= i;\n \t\tj <<= 1) result_k++;\n@@ -2225,7 +2224,7 @@ __dtoa\n \t\t\t\t\tds *= bigtens[i];\n \t\t\t\t\t}\n \t\t\tvalue(d) /= ds;\n-\t\t\t}\n+\t\t}\n \t\telse if ((jj1 = -k) != 0) {\n \t\t\tvalue(d) *= tens[jj1 & 0xf];\n \t\t\tfor(j = (unsigned int)jj1 >> 4; j;\n@@ -2233,8 +2232,8 @@ __dtoa\n \t\t\t\tif (j & 1) {\n \t\t\t\t\tieps++;\n \t\t\t\t\tvalue(d) *= bigtens[i];\n-\t\t\t\t\t}\n-\t\t\t}\n+\t\t\t\t}\n+\t\t}\n \t\tif (k_check && value(d) < 1. && ilim > 0) {\n \t\t\tif (ilim1 <= 0)\n \t\t\t\tgoto fast_failed;\n@@ -2242,7 +2241,7 @@ __dtoa\n \t\t\tk--;\n \t\t\tvalue(d) *= 10.;\n \t\t\tieps++;\n-\t\t\t}\n+\t\t}\n \t\tvalue(eps) = ieps*value(d) + 7.;\n \t\tword0(eps) -= (P-1)*Exp_msk1;\n \t\tif (ilim == 0) {\n@@ -2253,7 +2252,7 @@ __dtoa\n \t\t\tif (value(d) < -value(eps))\n \t\t\t\tgoto no_digits;\n \t\t\tgoto fast_failed;\n-\t\t\t}\n+\t\t}\n #ifndef No_leftright\n \t\tif (leftright) {\n \t\t\t/* Use Steele & White method of only\n@@ -2273,7 +2272,7 @@ __dtoa\n \t\t\t\tvalue(eps) *= 10.;\n \t\t\t\tvalue(d) *= 10.;\n \t\t\t\t}\n-\t\t\t}\n+\t\t}\n \t\telse {\n #endif\n \t\t\t/* Generate ilim digits, then fix them up. */\n@@ -2291,17 +2290,17 @@ __dtoa\n \t\t\t\t\t\tgoto ret1;\n \t\t\t\t\t\t}\n \t\t\t\t\tbreak;\n-\t\t\t\t\t}\n \t\t\t\t}\n-#ifndef No_leftright\n \t\t\t}\n+#ifndef No_leftright\n+\t\t}\n #endif\n  fast_failed:\n \t\ts = s0;\n \t\tvalue(d) = value(d2);\n \t\tk = k0;\n \t\tilim = ilim0;\n-\t\t}\n+\t}\n \n \t/* Do we have a \""small\"" integer? */\n \n@@ -2313,7 +2312,7 @@ __dtoa\n \t\t\tif (ilim < 0 || value(d) <= 5*ds)\n \t\t\t\tgoto no_digits;\n \t\t\tgoto one_digit;\n-\t\t\t}\n+\t\t}\n \t\tfor(i = 1;; i++) {\n \t\t\tL = value(d) / ds;\n \t\t\tvalue(d) -= L*ds;\n@@ -2322,7 +2321,7 @@ __dtoa\n \t\t\tif (value(d) < 0) {\n \t\t\t\tL--;\n \t\t\t\tvalue(d) += ds;\n-\t\t\t\t}\n+\t\t\t}\n #endif\n \t\t\t*s++ = '0' + (int)L;\n \t\t\tif (i == ilim) {\n@@ -2334,16 +2333,16 @@ __dtoa\n \t\t\t\t\t\t\tk++;\n \t\t\t\t\t\t\t*s = '0';\n \t\t\t\t\t\t\tbreak;\n-\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t}\n \t\t\t\t\t++*s++;\n-\t\t\t\t\t}\n-\t\t\t\tbreak;\n \t\t\t\t}\n+\t\t\t\tbreak;\n+\t\t\t}\n \t\t\tif (!(value(d) *= 10.))\n \t\t\t\tbreak;\n \t\t\t}\n \t\tgoto ret1;\n-\t\t}\n+\t}\n \n \tm2 = b2;\n \tm5 = b5;\n@@ -2359,7 +2358,7 @@ __dtoa\n #else\n \t\t\t\t1 + P - bbits;\n #endif\n-\t\t\t}\n+\t\t}\n \t\telse {\n \t\t\tj = ilim - 1;\n \t\t\tif (m5 >= j)\n@@ -2368,22 +2367,22 @@ __dtoa\n \t\t\t\ts5 += j -= m5;\n \t\t\t\tb5 += j;\n \t\t\t\tm5 = 0;\n-\t\t\t\t}\n+\t\t\t}\n \t\t\tif ((i = ilim) < 0) {\n \t\t\t\tm2 -= i;\n \t\t\t\ti = 0;\n-\t\t\t\t}\n \t\t\t}\n+\t\t}\n \t\tb2 += i;\n \t\ts2 += i;\n \t\tmhi = i2b(1);\n-\t\t}\n+\t}\n \tif (m2 > 0 && s2 > 0) {\n \t\ti = m2 < s2 ? m2 : s2;\n \t\tb2 -= i;\n \t\tm2 -= i;\n \t\ts2 -= i;\n-\t\t}\n+\t}\n \tif (b5 > 0) {\n \t\tif (leftright) {\n \t\t\tif (m5 > 0) {\n@@ -2391,13 +2390,13 @@ __dtoa\n \t\t\t\tb1 = mult(mhi, b);\n \t\t\t\tBfree(b);\n \t\t\t\tb = b1;\n-\t\t\t\t}\n+\t\t\t}\n \t\t\tif ((j = b5 - m5) != 0)\n \t\t\t\tb = pow5mult(b, j);\n \t\t\t}\n \t\telse\n \t\t\tb = pow5mult(b, b5);\n-\t\t}\n+\t}\n \tS = i2b(1);\n \tif (s5 > 0)\n \t\tS = pow5mult(S, s5);\n@@ -2417,7 +2416,7 @@ __dtoa\n \t\t\t}\n \t\telse\n \t\t\tspec_case = 0;\n-\t\t}\n+\t}\n \n \t/* Arrange for convenient computation of quotients:\n \t * shift left if necessary so divisor has 4 leading 0 bits.\n@@ -2438,13 +2437,13 @@ __dtoa\n \t\tb2 += i;\n \t\tm2 += i;\n \t\ts2 += i;\n-\t\t}\n+\t}\n \telse if (i < 4) {\n \t\ti += 28;\n \t\tb2 += i;\n \t\tm2 += i;\n \t\ts2 += i;\n-\t\t}\n+\t}\n \tif (b2 > 0)\n \t\tb = lshift(b, b2);\n \tif (s2 > 0)\n@@ -2457,19 +2456,19 @@ __dtoa\n \t\t\t\tmhi = multadd(mhi, 10, 0);\n \t\t\tilim = ilim1;\n \t\t\t}\n-\t\t}\n+\t}\n \tif (ilim <= 0 && mode > 2) {\n \t\tif (ilim < 0 || cmp(b,S = multadd(S,5,0)) <= 0) {\n \t\t\t/* no digits, fcvt style */\n  no_digits:\n \t\t\tk = -1 - ndigits;\n \t\t\tgoto ret;\n-\t\t\t}\n+\t\t}\n  one_digit:\n \t\t*s++ = '1';\n \t\tk++;\n \t\tgoto ret;\n-\t\t}\n+\t}\n \tif (leftright) {\n \t\tif (m2 > 0)\n \t\t\tmhi = lshift(mhi, m2);\n@@ -2483,7 +2482,7 @@ __dtoa\n \t\t\tmhi = Balloc(mhi->k);\n \t\t\tBcopy(mhi, mlo);\n \t\t\tmhi = lshift(mhi, Log2P);\n-\t\t\t}\n+\t\t}\n \n \t\tfor(i = 1;;i++) {\n \t\t\tdig = quorem(b,S) + '0';\n@@ -2502,7 +2501,7 @@ __dtoa\n \t\t\t\t\tdig++;\n \t\t\t\t*s++ = dig;\n \t\t\t\tgoto ret;\n-\t\t\t\t}\n+\t\t\t}\n #endif\n \t\t\tif (j < 0 || (j == 0 && !mode\n #ifndef ROUND_BIASED\n@@ -2518,7 +2517,7 @@ __dtoa\n \t\t\t\t\t}\n \t\t\t\t*s++ = dig;\n \t\t\t\tgoto ret;\n-\t\t\t\t}\n+\t\t\t}\n \t\t\tif (jj1 > 0) {\n \t\t\t\tif (dig == '9') { /* possible if i == 1 */\n  round_9_up:\n@@ -2527,7 +2526,7 @@ __dtoa\n \t\t\t\t\t}\n \t\t\t\t*s++ = dig + 1;\n \t\t\t\tgoto ret;\n-\t\t\t\t}\n+\t\t\t}\n \t\t\t*s++ = dig;\n \t\t\tif (i == ilim)\n \t\t\t\tbreak;\n@@ -2537,16 +2536,16 @@ __dtoa\n \t\t\telse {\n \t\t\t\tmlo = multadd(mlo, 10, 0);\n \t\t\t\tmhi = multadd(mhi, 10, 0);\n-\t\t\t\t}\n \t\t\t}\n \t\t}\n+\t}\n \telse\n \t\tfor(i = 1;; i++) {\n \t\t\t*s++ = dig = quorem(b,S) + '0';\n \t\t\tif (i >= ilim)\n \t\t\t\tbreak;\n \t\t\tb = multadd(b, 10, 0);\n-\t\t\t}\n+\t\t}\n \n \t/* Round off last digit */\n \n@@ -2561,18 +2560,18 @@ __dtoa\n \t\t\t\tgoto ret;\n \t\t\t\t}\n \t\t++*s++;\n-\t\t}\n+\t}\n \telse {\n \t\twhile(*--s == '0');\n \t\ts++;\n-\t\t}\n+\t}\n  ret:\n \tBfree(S);\n \tif (mhi) {\n \t\tif (mlo && mlo != mhi)\n \t\t\tBfree(mlo);\n \t\tBfree(mhi);\n-\t\t}\n+\t}\n  ret1:\n \tBfree(b);\n \tif (s == s0) {\t\t\t\t/* don't return empty string */\n@@ -2584,7 +2583,7 @@ __dtoa\n \tif (rve)\n \t\t*rve = s;\n \treturn s0;\n-\t}\n+}\n #ifdef __cplusplus\n }\n #endif\n"", ""strtoimax.c"": ""@@ -103,7 +103,7 @@ strtoimax(const char *nptr, char **endptr, int base)\n \t\t    cutoff = INTMAX_MAX / x; \\\n \t\t }; \\\n \t\t break\n-\t\t \n+\n \tswitch (base) {\n             case 4:\n                 if (neg) {\n@@ -118,13 +118,13 @@ strtoimax(const char *nptr, char **endptr, int base)\n \t    CASE_BASE(8);\n \t    CASE_BASE(10);\n \t    CASE_BASE(16);\n-\t    default:  \n+\t    default:\n \t              cutoff  = neg ? INTMAX_MIN : INTMAX_MAX;\n \t\t      cutlim  = cutoff % base;\n \t              cutoff /= base;\n \t}\n #undef CASE_BASE\n-\t\n+\n \tif (neg) {\n \t\tif (cutlim > 0) {\n \t\t\tcutlim -= base;\n"", ""strtoumax.c"": ""@@ -57,7 +57,7 @@ strtoumax(const char *nptr, char **endptr, int base)\n \tif (c == '-') {\n \t\tneg = 1;\n \t\tc = *s++;\n-\t} else { \n+\t} else {\n \t\tneg = 0;\n \t\tif (c == '+')\n \t\t\tc = *s++;\n@@ -76,7 +76,7 @@ strtoumax(const char *nptr, char **endptr, int base)\n             case x: cutoff = UINTMAX_MAX / x;    \\\n \t            cutlim = UINTMAX_MAX % x;    \\\n \t\t    break\n-\t\t    \t\n+\n         switch (base) {\n         CASE_BASE(8);\n \tCASE_BASE(10);\n@@ -85,7 +85,7 @@ strtoumax(const char *nptr, char **endptr, int base)\n \t    cutoff = UINTMAX_MAX / base;\n \t    cutlim = UINTMAX_MAX % base;\n \t}\n-\t\n+\n \tfor (acc = 0, any = 0;; c = (unsigned char) *s++) {\n \t\tif (isdigit(c))\n \t\t\tc -= '0';\n"", ""wchar.c"": ""@@ -387,7 +387,7 @@ size_t wcsxfrm(wchar_t *ws1, const wchar_t *ws2, size_t n)\n \n int wctob(wint_t c)\n {\n-  return c;\n+    return c;\n }\n \n wctype_t wctype(const char *property)\n""}","refactor
"
17272,David Turner,Fix Makefile by adding mandatory user tags.,['Makefile.android'],"Fix Makefile by adding mandatory user tags.

The build system now requires a LOCAL_MODULE_TAGS definition in each Android.mk

Change-Id: I080a721224dcf6cb24fa2a803a52dcfe7f626cd6",https://android-review.googlesource.com/c/17272,"bug 
",resource;bug,Bug;Resource;,"{""Makefile.android"": ""@@ -1147,6 +1147,7 @@ ifeq ($(CONFIG_STATIC_EXECUTABLE),true)\n endif\n \n LOCAL_MODULE := qemu-android\n+LOCAL_MODULE_TAGS := debug\n \n include $(BUILD_HOST_EXECUTABLE)\n \n""}","**refactor** 
"
18911,Madan Ankapura,DO NOT MERGE fix failing test testWifiInfoProperties for non-telephony devices,['tests/tests/net/src/android/net/wifi/cts/WifiInfoTest.java'],"fix failing test testWifiInfoProperties for non-telephony devices

Device can still have a valid networkId even after disconnection if it
was associated with AP, getWifiState is a better check to get valid state.

Change-Id: I31a8ca38f304fbf639e1f3111be4b5ed406e3b3c",https://android-review.googlesource.com/c/18911,"bug, test 
","test,bug",Bug;Test;,"{""WifiInfoTest.java"": ""@@ -168,8 +168,6 @@ public class WifiInfoTest extends AndroidTestCase {\n             args = {}\n         )\n     })\n-    @ToBeFixed(bug=\""1871573\"", explanation=\""android.net.wifi.WifiInfo#getNetworkId() return -1 when\""\n-        + \"" there is wifi connection\"")\n     public void testWifiInfoProperties() throws Exception {\n         // this test case should in Wifi environment\n         WifiInfo wifiInfo = mWifiManager.getConnectionInfo();\n@@ -187,8 +185,7 @@ public class WifiInfoTest extends AndroidTestCase {\n         wifiInfo.getMacAddress();\n         setWifiEnabled(false);\n         Thread.sleep(DURATION);\n-        wifiInfo = mWifiManager.getConnectionInfo();\n-        assertEquals(-1, wifiInfo.getNetworkId());\n+\tassertEquals(mWifiManager.WIFI_STATE_DISABLED, mWifiManager.getWifiState());\n     }\n \n }\n""}","bug, test 
"
14431,Colin Cross,[ARM] tegra: tegrafb: Free irq in probe error case and remove function,['drivers/video/tegrafb.c'],"[ARM] tegra: tegrafb: Free irq in probe error case and remove function

    v3: Fixes from review by Jaya Kumar
        - Free irq in probe error case and remove function

Change-Id: Id6ebb8b79a738d0e3a9ac63fddd785f5652982f7
CC: Jaya Kumar <jayakumar.lkml@gmail.com>",https://android-review.googlesource.com/c/14431,"bug 
",Bug;Deprecat;,Bug;Deprecat;,"{""tegrafb.c"": ""@@ -422,42 +422,42 @@ static int tegra_plat_probe(struct platform_device *pdev)\n \n \tirq = platform_get_irq(pdev, 0);\n \tif (irq <= 0) {\n-\t\tpr_debug(\""%s: no irq\\n\"", pdev->name);\n+\t\tdev_err(&pdev->dev, \""%s: no irq\\n\"", pdev->name);\n \t\tret = -ENOENT;\n \t\tgoto err_free;\n \t}\n \n \tres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\n \tif (!res) {\n-\t\tpr_debug(\""%s: no mem resource\\n\"", pdev->name);\n+\t\tdev_err(&pdev->dev, \""%s: no mem resource\\n\"", pdev->name);\n \t\tret = -ENOENT;\n \t\tgoto err_free;\n \t}\n \n \treg_mem = request_mem_region(res->start, resource_size(res), pdev->name);\n \tif (!reg_mem) {\n-\t\tpr_debug(\""%s: request_mem_region failed\\n\"", pdev->name);\n+\t\tdev_err(&pdev->dev, \""%s: request_mem_region failed\\n\"", pdev->name);\n \t\tret = -EBUSY;\n \t\tgoto err_free;\n \t}\n \n \treg_base = ioremap(res->start, resource_size(res));\n \tif (!reg_base) {\n-\t\tpr_debug(\""%s: registers can't be mapped\\n\"", pdev->name);\n+\t\tdev_err(&pdev->dev, \""%s: registers can't be mapped\\n\"", pdev->name);\n \t\tret = -EBUSY;\n \t\tgoto err_release_resource_reg;\n \t}\n \n \tres = platform_get_resource(pdev, IORESOURCE_MEM, 1);\n \tif (!res) {\n-\t\tpr_debug(\""%s: no mem resource\\n\"", pdev->name);\n+\t\tdev_err(&pdev->dev, \""%s: no mem resource\\n\"", pdev->name);\n \t\tret = -ENOENT;\n \t\tgoto err_iounmap_reg;\n \t}\n \n \tfb_mem = request_mem_region(res->start, resource_size(res), pdev->name);\n \tif (!fb_mem) {\n-\t\tpr_debug(\""%s: request_mem_region failed\\n\"", pdev->name);\n+\t\tdev_err(&pdev->dev, \""%s: request_mem_region failed\\n\"", pdev->name);\n \t\tret = -EBUSY;\n \t\tgoto err_iounmap_reg;\n \t}\n@@ -466,14 +466,14 @@ static int tegra_plat_probe(struct platform_device *pdev)\n \tfb_phys = res->start;\n \tfb_base = ioremap_nocache(fb_phys, fb_size);\n \tif (!fb_base) {\n-\t\tpr_debug(\""%s: fb can't be mapped\\n\"", pdev->name);\n+\t\tdev_err(&pdev->dev, \""%s: fb can't be mapped\\n\"", pdev->name);\n \t\tret = -EBUSY;\n \t\tgoto err_release_resource_fb;\n \t}\n \n \tclk = clk_get(&pdev->dev, NULL);\n \tif (!clk) {\n-\t\tpr_debug(\""%s: can't get clock\\n\"", pdev->name);\n+\t\tdev_err(&pdev->dev, \""%s: can't get clock\\n\"", pdev->name);\n \t\tret = -ENOENT;\n \t\tgoto err_iounmap_fb;\n \t}\n@@ -549,10 +549,16 @@ static int tegra_plat_probe(struct platform_device *pdev)\n \t\t\t(unsigned int)info->fix.smem_start,\n \t\t\t(unsigned int)info->screen_base);\n \n-\tregister_framebuffer(info);\n+\tif (register_framebuffer(info)) {\n+\t\tdev_err(&pdev->dev, \""failed to register framebuffer\\n\"");\n+\t\tret = -ENODEV;\n+\t\tgoto err_free_irq;\n+\t}\n \tplatform_set_drvdata(pdev, info);\n \treturn 0;\n \n+err_free_irq:\n+\tfree_irq(irq, info);\n err_clk_disable:\n \tclk_disable(clk);\n err_iounmap_fb:\n@@ -574,6 +580,7 @@ static int tegra_plat_remove(struct platform_device *pdev)\n \tstruct fb_info *info = platform_get_drvdata(pdev);\n \tstruct tegra_fb_info *tegra_fb = info->par;\n \tunregister_framebuffer(info);\n+\tfree_irq(tegra_fb->irq, info);\n \tclk_disable(tegra_fb->clk);\n \tiounmap(info->screen_base);\n \trelease_resource(tegra_fb->fb_mem);\n""}","bug, refactor 
"
12918,PacketVideo CM,RIO-7999: H264 raw support for PVMI MIO file input / output (minor additional change 2),"['pvmi/media_io/pvmi_mio_fileinput/src/pvmi_mio_fileinput.h', 'pvmi/media_io/pvmi_mio_fileinput/src/pvmi_mio_fileinput.cpp', 'engines/2way/src/pv_2way_sdkinfo.h', 'engines/player/src/pv_player_sdkinfo.h', 'engines/author/src/pv_author_sdkinfo.h']",RIO-7999: H264 raw support for PVMI MIO file input / output (minor additional change 2),https://android-review.googlesource.com/c/12918,"feature 
",feature,Feature;,"{""pv_2way_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PV2WAY_ENGINE_SDKINFO_LABEL \""1131501\""\n+#define PV2WAY_ENGINE_SDKINFO_LABEL \""1131577\""\n #define PV2WAY_ENGINE_SDKINFO_DATE 0x20091209\n \n #endif //PV_2WAY_SDKINFO_H_INCLUDED\n"", ""pv_author_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""1131501\""\n+#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""1131577\""\n #define PVAUTHOR_ENGINE_SDKINFO_DATE 0x20091209\n \n #endif //PV_AUTHOR_SDKINFO_H_INCLUDED\n"", ""pv_player_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVPLAYER_ENGINE_SDKINFO_LABEL \""1131501\""\n+#define PVPLAYER_ENGINE_SDKINFO_LABEL \""1131577\""\n #define PVPLAYER_ENGINE_SDKINFO_DATE 0x20091209\n \n #endif //PV_PLAYER_SDKINFO_H_INCLUDED\n"", ""pvmi_mio_fileinput.cpp"": ""@@ -16,9 +16,9 @@\n  * -------------------------------------------------------------------\n  */\n /**\n-* @file pvmi_mio_fileinput.cpp\n-* @brief PV Media IO interface implementation using file input\n-*/\n+ * @file pvmi_mio_fileinput.cpp\n+ * @brief PV Media IO interface implementation using file input\n+ */\n \n #ifndef OSCL_BASE_H_INCLUDED\n #include \""oscl_base.h\""\n@@ -890,28 +890,28 @@ PVMFStatus PvmiMIOFileInput::DoInit()\n     iTimeStampVector.reserve(2500);\n \n     /*\n-    * For some of the compressed formats we expect a log file to be present.\n-    * The syntax of the logfile is as follows:\n-    *********************************************************\n-    unsigned int(32) total_num_samples;\n-    unsigned int(32) avg_bitrate; // could be 0 if not available\n-    unsigned int(32) timescale; //this is the timescale of all sample timestamps below\n-    unsigned int(32) max_sample_size; // could be 0 if not available\n-    unsigned int(32) config_size; //could be 0 for streams that have no config, say AMR\n-    unsigned int(32) height; //zero if it is audio stream\n-    unsigned int(32) width; //zero if it is audio stream\n-    unsigned int(32) frame_rate; //zero if audio stream\n-    for (j=0; j < total_num_samples; j++)\n-    {\n-    unsigned int(32) sample_length_in_bytes;\n-    unsigned int(32) sample_timestamp;\n-    }\n-    *********************************************************\n-    * for some others like AMR & AMR-WB we do not need log files\n-    * For M4V and H263, log file is optional. Author unit test will\n-    * always use one, but there could be other test apps that use\n-    * this media input comp that may not pass the log file.\n-    */\n+     * For some of the compressed formats we expect a log file to be present.\n+     * The syntax of the logfile is as follows:\n+     *********************************************************\n+       unsigned int(32) total_num_samples;\n+       unsigned int(32) avg_bitrate; // could be 0 if not available\n+       unsigned int(32) timescale; //this is the timescale of all sample timestamps below\n+       unsigned int(32) max_sample_size; // could be 0 if not available\n+       unsigned int(32) config_size; //could be 0 for streams that have no config, say AMR\n+       unsigned int(32) height; //zero if it is audio stream\n+       unsigned int(32) width; //zero if it is audio stream\n+       unsigned int(32) frame_rate; //zero if audio stream\n+       for (j=0; j < total_num_samples; j++)\n+       {\n+           unsigned int(32) sample_length_in_bytes;\n+           unsigned int(32) sample_timestamp;\n+       }\n+     *********************************************************\n+     * for some others like AMR & AMR-WB we do not need log files\n+     * For M4V and H263, log file is optional. Author unit test will\n+     * always use one, but there could be other test apps that use\n+     * this media input comp that may not pass the log file.\n+     */\n     if (iSettings.iMediaFormat == PVMF_MIME_ISO_AVC_SAMPLE_FORMAT)\n     {\n         // Validate settings - even when using logfile we assume the test app\n@@ -1109,77 +1109,6 @@ PVMFStatus PvmiMIOFileInput::DoInit()\n             }\n         }\n     }\n-    else if (iSettings.iMediaFormat == PVMF_MIME_H264_VIDEO_RAW)\n-    {\n-        // Validate settings - even when using logfile we assume the test app\n-        // has parsed the log file to populate iSettings correcrtly\n-        if (iSettings.iFrameHeight <= 0 || iSettings.iFrameWidth <= 0 ||\n-                iSettings.iFrameRate <= 0 || iSettings.iTimescale <= 0)\n-        {\n-            CloseInputFile();\n-            return PVMFErrArgument;\n-        }\n-\n-        iStreamDuration = 0;\n-        iTotalNumFrames = 0;\n-        if (iSettings.iFrameRate != 0)\n-        {\n-            iMilliSecondsPerDataEvent = (int32)(1000 / iSettings.iFrameRate);\n-        }\n-        iMicroSecondsPerDataEvent = iMilliSecondsPerDataEvent * 1000;\n-        if (!iFsOpened_log)\n-        {\n-            if (iFs_log.Connect() != 0)\n-                return PVMFFailure;\n-            iFsOpened_log = true;\n-        }\n-        if (iFileOpened_log ||\n-                0 != iLogFile.Open(iSettings.iVideoLogFileName.get_cstr(), Oscl_File::MODE_READ | Oscl_File::MODE_BINARY, iFs_log))\n-        {\n-            PVLOGGER_LOGMSG(PVLOGMSG_INST_LLDBG, iLogger, PVLOGMSG_ERR,\n-                            (0, \""PvmiMIOFileInput::DoInit: Error - iLogFile.Open failed\""));\n-            //try to parse the bitstream to locate frame boundaries\n-            int32  frameSize;\n-            uint32 bytesProcessed;\n-            uint8* fileData = NULL;\n-            uint8* currentFrame;\n-            fileData = (uint8*)iAlloc.allocate(fileSize);\n-            if (!fileData)\n-            {\n-                CloseInputFile();\n-                return PVMFErrNoMemory;\n-            }\n-\n-            // Read the whole file to data buffer then go back to front\n-            iInputFile.Read((OsclAny*)fileData, sizeof(uint8), fileSize);\n-            iInputFile.Seek(fileStart, Oscl_File::SEEKSET);\n-\n-            // Get ready to search for frame sizes\n-            iFrameSizeVector.reserve(200);\n-            currentFrame = fileData;\n-            bytesProcessed = 0;\n-            while (bytesProcessed < fileSize)\n-            {\n-\n-                frameSize = GetNextNALSize(currentFrame, fileSize - bytesProcessed); // get the size of next NAL (including 4 bytes of sync word)\n-\n-                // don't skip over the sync word, since that is part of the RAW format\n-\n-                if ((uint32)frameSize > maxFrameSize)\n-                    maxFrameSize = frameSize;\n-\n-                iFrameSizeVector.push_back(frameSize);\n-                currentFrame += frameSize; // move ptr to beginning of next NAL\n-                bytesProcessed += frameSize;\n-\n-                ++iTotalNumFrames;\n-\n-\n-            }\n-            iAlloc.deallocate((OsclAny*)fileData);\n-            iStreamDuration = iTotalNumFrames * (iMicroSecondsPerDataEvent / 1000); //in msec\n-        }\n-    }\n     else if (iSettings.iMediaFormat == PVMF_MIME_H2631998 ||\n              iSettings.iMediaFormat == PVMF_MIME_H2632000)\n     {\n@@ -1878,21 +1807,6 @@ PVMFStatus PvmiMIOFileInput::DoRead()\n         iReadTimeStamp = (uint32)(iDataEventCounter * 1000 / chunkrate);\n         ++iDataEventCounter;\n     }\n-    else if (iSettings.iMediaFormat == PVMF_MIME_H264_VIDEO_RAW)\n-    {\n-        if (iDataEventCounter)\n-        {\n-            bytesToRead = iFrameSizeVector[iDataEventCounter % iTotalNumFrames];\n-            iReadTimeStamp = (uint32)(iDataEventCounter * 1000 / iSettings.iFrameRate);\n-        }\n-        else\n-        {\n-            bytesToRead = iFrameSizeVector[0] + iFrameSizeVector[1];\n-            ++iDataEventCounter;\n-            iReadTimeStamp = 0;\n-        }\n-        ++iDataEventCounter;\n-    }\n     else\n     {\n         PVLOGGER_LOGMSG(PVLOGMSG_INST_LLDBG, iLogger, PVLOGMSG_ERR,\n@@ -2230,33 +2144,6 @@ int32 PvmiMIOFileInput::GetIETFFrameSize(uint8 aFrameType,\n     return -1;\n }\n \n-//////////////////////////////////////////////////////////////////////////////////\n-\n-uint32 PvmiMIOFileInput::GetNextNALSize(uint8 *video_buffer, uint32 bytes_left)\n-{\n-    // locate the next sync word 0x 00 00 00 01\n-    // for the case of very last NAL, we compare the bytes_left\n-    video_buffer++;\n-\n-    // clarity over efficiency !\n-    uint32 size = 0;\n-    while (true)\n-    {\n-        size++;\n-        if (((video_buffer[0] == 0) &&\n-                (video_buffer[1] == 0) &&\n-                (video_buffer[2] == 0) &&\n-                (video_buffer[3] == 1)) ||\n-                (size >= bytes_left))\n-            break;\n-\n-        video_buffer++;\n-    }\n-\n-    return size;\n-}\n-\n-\n //////////////////////////////////////////////////////////////////////////////////\n int32 PvmiMIOFileInput::LocateM4VFrameHeader(uint8* video_buffer, int32 vop_size)\n {\n@@ -2890,7 +2777,7 @@ PVMFStatus PvmiMIOFileInput::RetrieveNALType()\n \n PVMFStatus PvmiMIOFileInput::RetrieveFSI(uint32 fsi_size)\n {\n-    if ((iSettings.iMediaFormat != PVMF_MIME_M4V) && (iSettings.iMediaFormat != PVMF_MIME_H264_VIDEO_RAW))\n+    if (iSettings.iMediaFormat != PVMF_MIME_M4V)\n     {\n         return PVMFFailure;\n     }\n@@ -2945,18 +2832,8 @@ PVMFStatus PvmiMIOFileInput::RetrieveFSI(uint32 fsi_size)\n         return PVMFFailure;\n     }\n \n-    if (iSettings.iMediaFormat == PVMF_MIME_M4V)\n-    {\n-        // Anything before the first frame is assumed to be FSI\n-        iFormatSpecificInfoSize = LocateM4VFrameHeader(fileData, fsi_size);\n-    }\n-    else\n-    {\n-        // two first frames include SPS and PPS\n-        iFormatSpecificInfoSize = GetNextNALSize(fileData, fsi_size);\n-        iFormatSpecificInfoSize += GetNextNALSize(fileData + iFormatSpecificInfoSize, fsi_size - iFormatSpecificInfoSize);\n-    }\n-\n+    // Anything before the first frame is assumed to be FSI\n+    iFormatSpecificInfoSize = LocateM4VFrameHeader(fileData, fsi_size);\n \n     if (iFormatSpecificInfoSize == 0)\n     {\n"", ""pvmi_mio_fileinput.h"": ""@@ -248,7 +248,6 @@ class PvmiMIOFileInput\n         PVMFStatus DoFlush();\n         PVMFStatus DoStop();\n         PVMFStatus DoRead();\n-        uint32 GetNextNALSize(uint8 *video_buffer, uint32 bytes_left);\n         int32 LocateM4VFrameHeader(uint8* video_buffer, int32 vop_size);\n         int32 LocateH263FrameHeader(uint8* video_buffer, int32 vop_size);\n         int32 GetIF2FrameSize(uint8 aFrameType);\n""}","feature 
"
11498,Garret Pick,2way engine - Not all settings are saved across sessions in 2way GUI app,"['protocols/systems/3g-324m_pvterminal/h324/tsc/src/tscmain.cpp', 'engines/2way/sample_app/pv2waysample/include/pv_2way_mio.h', 'engines/2way/src/pv_2way_sdkinfo.h', 'engines/player/src/pv_player_sdkinfo.h', 'engines/author/src/pv_author_sdkinfo.h', 'engines/2way/src/pv_2way_proxy_adapter.cpp', 'engines/2way/test/src/connect_test.cpp']",2way engine - Not all settings are saved across sessions in 2way GUI app,https://android-review.googlesource.com/c/11498,"bug, feature 
",bug,Others;,"{""pv_2way_mio.h"": ""@@ -54,6 +54,7 @@ class LipSyncDummyMIOSettings;\n #define FILENAME_LEN   255\n #define OUTPUT_TXT_LEN   20\n #define EXTN_LEN       5\n+#define NUMBER_LEN 20\n #define PORT_LEN 1200\n #define LOOP_LEN 500\n #define TRANS_LEN 500\n"", ""pv_2way_proxy_adapter.cpp"": ""@@ -651,7 +651,7 @@ void CPV2WayProxyAdapter::CommandCompleted(const PVCmdResponse& aResponse)\n             tface->addRef();\n         }\n \n-        if (uuid == PV2WayTestEncExtensionUUID)\n+        if ((uuid == PV2WayTestEncExtensionUUID) | (uuid == PVMp4H263EncExtensionUUID))\n         {\n             // for requests for non-proxied interface- such as the test interface.\n             // don't need to proxy response.\n"", ""pv_2way_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PV2WAY_ENGINE_SDKINFO_LABEL \""911433\""\n-#define PV2WAY_ENGINE_SDKINFO_DATE 0x20090812\n+#define PV2WAY_ENGINE_SDKINFO_LABEL \""911832\""\n+#define PV2WAY_ENGINE_SDKINFO_DATE 0x20090813\n \n #endif //PV_2WAY_SDKINFO_H_INCLUDED\n"", ""connect_test.cpp"": ""@@ -107,10 +107,13 @@ void connect_test::EncoderIFSucceeded()\n {\n     PVUuid mp4h263EncUuid = PVMp4H263EncExtensionUUID;\n     PVMp4H263EncExtensionInterface *ptr = (PVMp4H263EncExtensionInterface *) iMP4H263EncoderInterface;\n-    // Default frame rate is 5\n-    ptr->SetOutputFrameRate(0, 4);\n-    iMP4H263EncoderInterface->removeRef();\n-    iEncoderIFSet = true;\n+    if (ptr)\n+    {\n+        // Default frame rate is 5\n+        ptr->SetOutputFrameRate(0, 4);\n+        iMP4H263EncoderInterface->removeRef();\n+        iEncoderIFSet = true;\n+    }\n     connect();\n }\n \n"", ""pv_author_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""911433\""\n-#define PVAUTHOR_ENGINE_SDKINFO_DATE 0x20090812\n+#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""911832\""\n+#define PVAUTHOR_ENGINE_SDKINFO_DATE 0x20090813\n \n #endif //PV_AUTHOR_SDKINFO_H_INCLUDED\n"", ""pv_player_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVPLAYER_ENGINE_SDKINFO_LABEL \""911433\""\n-#define PVPLAYER_ENGINE_SDKINFO_DATE 0x20090812\n+#define PVPLAYER_ENGINE_SDKINFO_LABEL \""911832\""\n+#define PVPLAYER_ENGINE_SDKINFO_DATE 0x20090813\n \n #endif //PV_PLAYER_SDKINFO_H_INCLUDED\n"", ""tscmain.cpp"": ""@@ -502,8 +502,6 @@ TPVStatusCode TSC_324m::ResetTsc()\n         iTSCcomponent = NULL;\n     }\n \n-\n-\n     if (iH223)\n     {\n         iH223->Close();\n@@ -2131,6 +2129,10 @@ PVMFCommandId TSC_324m::QueryInterface(PVMFSessionId aSession,\n                 backup->removeRef();\n             }\n         }\n+        else\n+        {\n+            iTSCcomponent = backup;\n+        }\n     }\n \n     // Add command to queue\n""}","feature 
"
23643,Deleted User,OMAP: TILER: Expose 1D mapping/unmapping operations,"['arch/arm/mach-omap2/include/mach/tiler.h', 'drivers/media/video/tiler/_tiler.h', 'drivers/media/video/tiler/tiler-iface.c', 'drivers/media/video/tiler/tiler-main.c']","OMAP: TILER: Expose 1D mapping/unmapping operations

Expose kernel methods to map a set of physical pages into TILER 1D
(reserve area + pin memory), and free those areas.

Change-Id: I744ca24797710e59c7f274f802ed781fa24f1729
Signed-off-by: Lajos Molnar <molnar@ti.com>",https://android-review.googlesource.com/c/23643,"feature
",feature,Others;,"{""tiler.h"": ""@@ -373,6 +373,30 @@ s32 tilview_rotate(struct tiler_view_t *view, s32 rotation);\n  */\n s32 tilview_flip(struct tiler_view_t *view, bool flip_x, bool flip_y);\n \n+/*\n+ * -------------------- TILER hooks for ION/HWC migration --------------------\n+ */\n+\n+/* type of tiler memory */\n+enum tiler_memtype {\n+\tTILER_MEM_ALLOCED,\t\t/* tiler allocated the memory */\n+\tTILER_MEM_GOT_PAGES,\t\t/* tiler used get_user_pages */\n+\tTILER_MEM_USING,\t\t/* tiler is using the pages */\n+};\n+\n+/* physical pages to pin - mem must be kmalloced */\n+struct tiler_pa_info {\n+\tu32 num_pg;\t\t\t/* number of pages in page-list */\n+\tu32 *mem;\t\t\t/* list of phys page addresses */\n+\tenum tiler_memtype memtype;\t/* how we got physical pages */\n+};\n+\n+typedef struct mem_info *tiler_blk_handle;\n+\n+/* NOTE: this will take ownership pa->mem (will free it) */\n+tiler_blk_handle tiler_map_1d_block(struct tiler_pa_info *pa);\n+void tiler_free_block(tiler_blk_handle block);\n+\n /*\n  * ---------------------------- IOCTL Definitions ----------------------------\n  */\n"", ""_tiler.h"": ""@@ -77,20 +77,6 @@ struct area_info {\n \tstruct gid_info *gi;\t\t/* link to parent, if still alive */\n };\n \n-/* type of tiler memory */\n-enum tiler_memtype {\n-\tTILER_MEM_ALLOCED,\t\t/* tiler allocated the memory */\n-\tTILER_MEM_GOT_PAGES,\t\t/* tiler used get_user_pages */\n-\tTILER_MEM_USING,\t\t/* tiler is using the pages */\n-};\n-\n-/* physical pages to pin */\n-struct tiler_pa_info {\n-\tu32 num_pg;\t\t\t/* number of pages in page-list */\n-\tu32 *mem;\t\t\t/* list of phys page addresses */\n-\tenum tiler_memtype memtype;\t/* how we got physical pages */\n-};\n-\n /* info for a block */\n struct mem_info {\n \tstruct list_head global;\t/* reserved / global blocks */\n@@ -176,4 +162,6 @@ void tiler_iface_init(struct tiler_ops *tiler);\n void tiler_geom_init(struct tiler_ops *tiler);\n void tiler_reserve_init(struct tiler_ops *tiler);\n \n+struct process_info *__get_pi(pid_t pid, bool kernel);\n+\n #endif\n"", ""tiler-iface.c"": ""@@ -183,7 +183,7 @@ static void _m_unregister_buf(struct __buf_info *_b)\n  */\n \n /* get process info, and increment refs for device tracking */\n-static struct process_info *__get_pi(pid_t pid, bool kernel)\n+struct process_info *__get_pi(pid_t pid, bool kernel)\n {\n \tstruct process_info *pi;\n \n"", ""tiler-main.c"": ""@@ -1354,6 +1354,24 @@ static void __exit tiler_exit(void)\n \tclass_destroy(tilerdev_class);\n }\n \n+tiler_blk_handle tiler_map_1d_block(struct tiler_pa_info *pa)\n+{\n+\tstruct mem_info *mi = NULL;\n+\tstruct tiler_pa_info *pa_tmp = kmemdup(pa, sizeof(*pa), GFP_KERNEL);\n+\ts32 res = map_any_block(TILFMT_PAGE, pa->num_pg << PAGE_SHIFT, 1, 0, 0,\n+\t\t\t\t\t\t__get_pi(0, true), &mi, pa_tmp);\n+\treturn res ? ERR_PTR(res) : mi;\n+}\n+EXPORT_SYMBOL(tiler_map_1d_block);\n+\n+void tiler_free_block(tiler_blk_handle block)\n+{\n+\tmutex_lock(&mtx);\n+\t_m_try_free(block);\n+\tmutex_unlock(&mtx);\n+}\n+EXPORT_SYMBOL(tiler_free_block);\n+\n MODULE_LICENSE(\""GPL v2\"");\n MODULE_AUTHOR(\""Lajos Molnar <molnar@ti.com>\"");\n MODULE_AUTHOR(\""David Sin <davidsin@ti.com>\"");\n""}","bug, refactor 
"
12178,Jean-Baptiste Queru,Add kernel headers,['default.xml'],"Add kernel headers
",https://android-review.googlesource.com/c/12178,"feature 
",resource,Resource;,"{""default.xml"": ""@@ -113,6 +113,7 @@\n   <project path=\""external/jhead\"" name=\""platform/external/jhead\"" />\n   <project path=\""external/jpeg\"" name=\""platform/external/jpeg\"" />\n   <project path=\""external/junit\"" name=\""platform/external/junit\"" />\n+  <project path=\""external/kernel-headers\"" name=\""platform/external/kernel-headers\"" />\n   <project path=\""external/lcc\"" name=\""platform/external/lcc\"" />\n   <project path=\""external/libffi\"" name=\""platform/external/libffi\"" />\n   <project path=\""external/libpcap\"" name=\""platform/external/libpcap\"" />\n""}","resource 
"
24325,Deleted User,1.1 Translaotr: handle glGet(POINT_SIZE_ARRAY),['tools/emulator/opengl/host/libs/Translator/GLES_CM/GLEScmContext.cpp'],"1.1 Translaotr: handle glGet(POINT_SIZE_ARRAY)

Should be handled internaly, like all other ARRAY queries.",https://android-review.googlesource.com/c/24325,"bug 
",bug,Others;,"{""GLEScmContext.cpp"": ""@@ -361,6 +361,12 @@ bool GLEScmContext::glGetIntegerv(GLenum pname, GLint *params)\n             ptr = getPointer(GL_TEXTURE_COORD_ARRAY_POINTER);\n             break;\n \n+        case GL_POINT_SIZE_ARRAY_BUFFER_BINDING_OES:\n+        case GL_POINT_SIZE_ARRAY_STRIDE_OES:\n+        case GL_POINT_SIZE_ARRAY_TYPE_OES:\n+            ptr = getPointer(GL_POINT_SIZE_ARRAY_POINTER_OES);\n+            break;\n+\n         default:\n             return false;\n     }\n@@ -371,6 +377,7 @@ bool GLEScmContext::glGetIntegerv(GLenum pname, GLint *params)\n         case GL_NORMAL_ARRAY_BUFFER_BINDING:\n         case GL_COLOR_ARRAY_BUFFER_BINDING:\n         case GL_TEXTURE_COORD_ARRAY_BUFFER_BINDING:\n+        case GL_POINT_SIZE_ARRAY_BUFFER_BINDING_OES:\n             *params = ptr ? ptr->getBufferName() : 0;\n             break;\n \n@@ -378,6 +385,7 @@ bool GLEScmContext::glGetIntegerv(GLenum pname, GLint *params)\n         case GL_NORMAL_ARRAY_STRIDE:\n         case GL_COLOR_ARRAY_STRIDE:\n         case GL_TEXTURE_COORD_ARRAY_STRIDE:\n+        case GL_POINT_SIZE_ARRAY_STRIDE_OES:\n             *params = ptr ? ptr->getStride() : 0;\n             break;\n \n@@ -391,6 +399,7 @@ bool GLEScmContext::glGetIntegerv(GLenum pname, GLint *params)\n         case GL_NORMAL_ARRAY_TYPE:\n         case GL_COLOR_ARRAY_TYPE:\n         case GL_TEXTURE_COORD_ARRAY_TYPE:\n+        case GL_POINT_SIZE_ARRAY_TYPE_OES:\n             *params = ptr ? ptr->getType() : 0;\n             break;\n     }\n""}","bug 
"
23267,Jean-Baptiste Queru,Add icmp6.h and ip6.h files from current NetBSD libc.,"['libc/include/netinet/ip6.h', 'libc/include/netinet/icmp6.h']","Add icmp6.h and ip6.h files from current NetBSD libc.

Change-Id: I6b304dfbefaec74c5fb15b216f38d698a55f0642",https://android-review.googlesource.com/c/23267,"resource
",resource,Feature;,"{""icmp6.h"": ""@@ -0,0 +1,730 @@\n+/*\t$NetBSD: icmp6.h,v 1.40 2009/10/31 22:32:17 christos Exp $\t*/\n+/*\t$KAME: icmp6.h,v 1.84 2003/04/23 10:26:51 itojun Exp $\t*/\n+\n+\n+/*\n+ * Copyright (C) 1995, 1996, 1997, and 1998 WIDE Project.\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions\n+ * are met:\n+ * 1. Redistributions of source code must retain the above copyright\n+ *    notice, this list of conditions and the following disclaimer.\n+ * 2. Redistributions in binary form must reproduce the above copyright\n+ *    notice, this list of conditions and the following disclaimer in the\n+ *    documentation and/or other materials provided with the distribution.\n+ * 3. Neither the name of the project nor the names of its contributors\n+ *    may be used to endorse or promote products derived from this software\n+ *    without specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\n+ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE\n+ * ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE\n+ * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL\n+ * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS\n+ * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)\n+ * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT\n+ * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY\n+ * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF\n+ * SUCH DAMAGE.\n+ */\n+\n+/*\n+ * Copyright (c) 1982, 1986, 1993\n+ *\tThe Regents of the University of California.  All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions\n+ * are met:\n+ * 1. Redistributions of source code must retain the above copyright\n+ *    notice, this list of conditions and the following disclaimer.\n+ * 2. Redistributions in binary form must reproduce the above copyright\n+ *    notice, this list of conditions and the following disclaimer in the\n+ *    documentation and/or other materials provided with the distribution.\n+ * 3. Neither the name of the University nor the names of its contributors\n+ *    may be used to endorse or promote products derived from this software\n+ *    without specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\n+ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE\n+ * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE\n+ * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL\n+ * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS\n+ * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)\n+ * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT\n+ * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY\n+ * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF\n+ * SUCH DAMAGE.\n+ *\n+ *\t@(#)ip_icmp.h\t8.1 (Berkeley) 6/10/93\n+ */\n+\n+#ifndef _NETINET_ICMP6_H_\n+#define _NETINET_ICMP6_H_\n+\n+#define ICMPV6_PLD_MAXLEN\t1232\t/* IPV6_MMTU - sizeof(struct ip6_hdr)\n+\t\t\t\t\t   - sizeof(struct icmp6_hdr) */\n+\n+struct icmp6_hdr {\n+\tu_int8_t\ticmp6_type;\t/* type field */\n+\tu_int8_t\ticmp6_code;\t/* code field */\n+\tu_int16_t\ticmp6_cksum;\t/* checksum field */\n+\tunion {\n+\t\tu_int32_t\ticmp6_un_data32[1]; /* type-specific field */\n+\t\tu_int16_t\ticmp6_un_data16[2]; /* type-specific field */\n+\t\tu_int8_t\ticmp6_un_data8[4];  /* type-specific field */\n+\t} icmp6_dataun;\n+} __packed;\n+\n+#define icmp6_data32\ticmp6_dataun.icmp6_un_data32\n+#define icmp6_data16\ticmp6_dataun.icmp6_un_data16\n+#define icmp6_data8\ticmp6_dataun.icmp6_un_data8\n+#define icmp6_pptr\ticmp6_data32[0]\t\t/* parameter prob */\n+#define icmp6_mtu\ticmp6_data32[0]\t\t/* packet too big */\n+#define icmp6_id\ticmp6_data16[0]\t\t/* echo request/reply */\n+#define icmp6_seq\ticmp6_data16[1]\t\t/* echo request/reply */\n+#define icmp6_maxdelay\ticmp6_data16[0]\t\t/* mcast group membership */\n+\n+#define ICMP6_DST_UNREACH\t\t1\t/* dest unreachable, codes: */\n+#define ICMP6_PACKET_TOO_BIG\t\t2\t/* packet too big */\n+#define ICMP6_TIME_EXCEEDED\t\t3\t/* time exceeded, code: */\n+#define ICMP6_PARAM_PROB\t\t4\t/* ip6 header bad */\n+\n+#define ICMP6_ECHO_REQUEST\t\t128\t/* echo service */\n+#define ICMP6_ECHO_REPLY\t\t129\t/* echo reply */\n+#define MLD_LISTENER_QUERY\t\t130 \t/* multicast listener query */\n+#define MLD_LISTENER_REPORT\t\t131\t/* multicast listener report */\n+#define MLD_LISTENER_DONE\t\t132\t/* multicast listener done */\n+\n+/* RFC2292 decls */\n+#define ICMP6_MEMBERSHIP_QUERY\t\t130\t/* group membership query */\n+#define ICMP6_MEMBERSHIP_REPORT\t\t131\t/* group membership report */\n+#define ICMP6_MEMBERSHIP_REDUCTION\t132\t/* group membership termination */\n+\n+#ifndef _KERNEL\n+/* the followings are for backward compatibility to old KAME apps. */\n+#define MLD6_LISTENER_QUERY\tMLD_LISTENER_QUERY\n+#define MLD6_LISTENER_REPORT\tMLD_LISTENER_REPORT\n+#define MLD6_LISTENER_DONE\tMLD_LISTENER_DONE\n+#endif\n+\n+#define ND_ROUTER_SOLICIT\t\t133\t/* router solicitation */\n+#define ND_ROUTER_ADVERT\t\t134\t/* router advertisement */\n+#define ND_NEIGHBOR_SOLICIT\t\t135\t/* neighbor solicitation */\n+#define ND_NEIGHBOR_ADVERT\t\t136\t/* neighbor advertisement */\n+#define ND_REDIRECT\t\t\t137\t/* redirect */\n+\n+#define ICMP6_ROUTER_RENUMBERING\t138\t/* router renumbering */\n+\n+#define ICMP6_WRUREQUEST\t\t139\t/* who are you request */\n+#define ICMP6_WRUREPLY\t\t\t140\t/* who are you reply */\n+#define ICMP6_FQDN_QUERY\t\t139\t/* FQDN query */\n+#define ICMP6_FQDN_REPLY\t\t140\t/* FQDN reply */\n+#define ICMP6_NI_QUERY\t\t\t139\t/* node information request */\n+#define ICMP6_NI_REPLY\t\t\t140\t/* node information reply */\n+\n+/* The definitions below are experimental. TBA */\n+#define MLD_MTRACE_RESP\t\t\t200\t/* mtrace response(to sender) */\n+#define MLD_MTRACE\t\t\t201\t/* mtrace messages */\n+\n+#ifndef _KERNEL\n+/* the followings are for backward compatibility to old KAME apps. */\n+#define MLD6_MTRACE_RESP\tMLD_MTRACE_RESP\n+#define MLD6_MTRACE\t\tMLD_MTRACE\n+#endif\n+\n+#define ICMP6_MAXTYPE\t\t\t201\n+\n+#define ICMP6_DST_UNREACH_NOROUTE\t0\t/* no route to destination */\n+#define ICMP6_DST_UNREACH_ADMIN\t \t1\t/* administratively prohibited */\n+#define ICMP6_DST_UNREACH_NOTNEIGHBOR\t2\t/* not a neighbor(obsolete) */\n+#define ICMP6_DST_UNREACH_BEYONDSCOPE\t2\t/* beyond scope of source address */\n+#define ICMP6_DST_UNREACH_ADDR\t\t3\t/* address unreachable */\n+#define ICMP6_DST_UNREACH_NOPORT\t4\t/* port unreachable */\n+\n+#define ICMP6_TIME_EXCEED_TRANSIT \t0\t/* ttl==0 in transit */\n+#define ICMP6_TIME_EXCEED_REASSEMBLY\t1\t/* ttl==0 in reass */\n+\n+#define ICMP6_PARAMPROB_HEADER \t \t0\t/* erroneous header field */\n+#define ICMP6_PARAMPROB_NEXTHEADER\t1\t/* unrecognized next header */\n+#define ICMP6_PARAMPROB_OPTION\t\t2\t/* unrecognized option */\n+\n+#define ICMP6_INFOMSG_MASK\t\t0x80\t/* all informational messages */\n+\n+#define ICMP6_NI_SUBJ_IPV6\t0\t/* Query Subject is an IPv6 address */\n+#define ICMP6_NI_SUBJ_FQDN\t1\t/* Query Subject is a Domain name */\n+#define ICMP6_NI_SUBJ_IPV4\t2\t/* Query Subject is an IPv4 address */\n+\n+#define ICMP6_NI_SUCCESS\t0\t/* node information successful reply */\n+#define ICMP6_NI_REFUSED\t1\t/* node information request is refused */\n+#define ICMP6_NI_UNKNOWN\t2\t/* unknown Qtype */\n+\n+#define ICMP6_ROUTER_RENUMBERING_COMMAND  0\t/* rr command */\n+#define ICMP6_ROUTER_RENUMBERING_RESULT   1\t/* rr result */\n+#define ICMP6_ROUTER_RENUMBERING_SEQNUM_RESET   255\t/* rr seq num reset */\n+\n+/* Used in kernel only */\n+#define ND_REDIRECT_ONLINK\t0\t/* redirect to an on-link node */\n+#define ND_REDIRECT_ROUTER\t1\t/* redirect to a better router */\n+\n+/*\n+ * Multicast Listener Discovery\n+ */\n+struct mld_hdr {\n+\tstruct icmp6_hdr\tmld_icmp6_hdr;\n+\tstruct in6_addr\t\tmld_addr; /* multicast address */\n+} __packed;\n+\n+/* definitions to provide backward compatibility to old KAME applications */\n+#ifndef _KERNEL\n+#define mld6_hdr\tmld_hdr\n+#define mld6_type\tmld_type\n+#define mld6_code\tmld_code\n+#define mld6_cksum\tmld_cksum\n+#define mld6_maxdelay\tmld_maxdelay\n+#define mld6_reserved\tmld_reserved\n+#define mld6_addr\tmld_addr\n+#endif\n+\n+/* shortcut macro definitions */\n+#define mld_type\tmld_icmp6_hdr.icmp6_type\n+#define mld_code\tmld_icmp6_hdr.icmp6_code\n+#define mld_cksum\tmld_icmp6_hdr.icmp6_cksum\n+#define mld_maxdelay\tmld_icmp6_hdr.icmp6_data16[0]\n+#define mld_reserved\tmld_icmp6_hdr.icmp6_data16[1]\n+\n+#define MLD_MINLEN\t\t\t24\n+\n+/*\n+ * Neighbor Discovery\n+ */\n+\n+struct nd_router_solicit {\t/* router solicitation */\n+\tstruct icmp6_hdr \tnd_rs_hdr;\n+\t/* could be followed by options */\n+} __packed;\n+\n+#define nd_rs_type\tnd_rs_hdr.icmp6_type\n+#define nd_rs_code\tnd_rs_hdr.icmp6_code\n+#define nd_rs_cksum\tnd_rs_hdr.icmp6_cksum\n+#define nd_rs_reserved\tnd_rs_hdr.icmp6_data32[0]\n+\n+struct nd_router_advert {\t/* router advertisement */\n+\tstruct icmp6_hdr\tnd_ra_hdr;\n+\tu_int32_t\t\tnd_ra_reachable;\t/* reachable time */\n+\tu_int32_t\t\tnd_ra_retransmit;\t/* retransmit timer */\n+\t/* could be followed by options */\n+} __packed;\n+\n+#define nd_ra_type\t\tnd_ra_hdr.icmp6_type\n+#define nd_ra_code\t\tnd_ra_hdr.icmp6_code\n+#define nd_ra_cksum\t\tnd_ra_hdr.icmp6_cksum\n+#define nd_ra_curhoplimit\tnd_ra_hdr.icmp6_data8[0]\n+#define nd_ra_flags_reserved\tnd_ra_hdr.icmp6_data8[1]\n+#define ND_RA_FLAG_MANAGED\t0x80\n+#define ND_RA_FLAG_OTHER\t0x40\n+#define ND_RA_FLAG_HOME_AGENT\t0x20\n+\n+/*\n+ * Router preference values based on RFC4199.\n+ */\n+#define ND_RA_FLAG_RTPREF_MASK\t0x18 /* 00011000 */\n+\n+#define ND_RA_FLAG_RTPREF_HIGH\t0x08 /* 00001000 */\n+#define ND_RA_FLAG_RTPREF_MEDIUM\t0x00 /* 00000000 */\n+#define ND_RA_FLAG_RTPREF_LOW\t0x18 /* 00011000 */\n+#define ND_RA_FLAG_RTPREF_RSV\t0x10 /* 00010000 */\n+\n+#define nd_ra_router_lifetime\tnd_ra_hdr.icmp6_data16[1]\n+\n+struct nd_neighbor_solicit {\t/* neighbor solicitation */\n+\tstruct icmp6_hdr\tnd_ns_hdr;\n+\tstruct in6_addr\t\tnd_ns_target;\t/*target address */\n+\t/* could be followed by options */\n+} __packed;\n+\n+#define nd_ns_type\t\tnd_ns_hdr.icmp6_type\n+#define nd_ns_code\t\tnd_ns_hdr.icmp6_code\n+#define nd_ns_cksum\t\tnd_ns_hdr.icmp6_cksum\n+#define nd_ns_reserved\t\tnd_ns_hdr.icmp6_data32[0]\n+\n+struct nd_neighbor_advert {\t/* neighbor advertisement */\n+\tstruct icmp6_hdr\tnd_na_hdr;\n+\tstruct in6_addr\t\tnd_na_target;\t/* target address */\n+\t/* could be followed by options */\n+} __packed;\n+\n+#define nd_na_type\t\tnd_na_hdr.icmp6_type\n+#define nd_na_code\t\tnd_na_hdr.icmp6_code\n+#define nd_na_cksum\t\tnd_na_hdr.icmp6_cksum\n+#define nd_na_flags_reserved\tnd_na_hdr.icmp6_data32[0]\n+#if BYTE_ORDER == BIG_ENDIAN\n+#define ND_NA_FLAG_ROUTER\t\t0x80000000\n+#define ND_NA_FLAG_SOLICITED\t\t0x40000000\n+#define ND_NA_FLAG_OVERRIDE\t\t0x20000000\n+#else\n+#if BYTE_ORDER == LITTLE_ENDIAN\n+#define ND_NA_FLAG_ROUTER\t\t0x80\n+#define ND_NA_FLAG_SOLICITED\t\t0x40\n+#define ND_NA_FLAG_OVERRIDE\t\t0x20\n+#endif\n+#endif\n+\n+struct nd_redirect {\t\t/* redirect */\n+\tstruct icmp6_hdr\tnd_rd_hdr;\n+\tstruct in6_addr\t\tnd_rd_target;\t/* target address */\n+\tstruct in6_addr\t\tnd_rd_dst;\t/* destination address */\n+\t/* could be followed by options */\n+} __packed;\n+\n+#define nd_rd_type\t\tnd_rd_hdr.icmp6_type\n+#define nd_rd_code\t\tnd_rd_hdr.icmp6_code\n+#define nd_rd_cksum\t\tnd_rd_hdr.icmp6_cksum\n+#define nd_rd_reserved\t\tnd_rd_hdr.icmp6_data32[0]\n+\n+struct nd_opt_hdr {\t\t/* Neighbor discovery option header */\n+\tu_int8_t\tnd_opt_type;\n+\tu_int8_t\tnd_opt_len;\n+\t/* followed by option specific data*/\n+} __packed;\n+\n+#define ND_OPT_SOURCE_LINKADDR\t\t1\n+#define ND_OPT_TARGET_LINKADDR\t\t2\n+#define ND_OPT_PREFIX_INFORMATION\t3\n+#define ND_OPT_REDIRECTED_HEADER\t4\n+#define ND_OPT_MTU\t\t\t5\n+#define ND_OPT_ADVINTERVAL\t\t7\n+#define ND_OPT_HOMEAGENT_INFO\t\t8\n+#define ND_OPT_SOURCE_ADDRLIST\t\t9\n+#define ND_OPT_TARGET_ADDRLIST\t\t10\n+#define ND_OPT_RDNSS\t\t\t25\n+/* draft-ietf-ipngwg-router-preference, not officially assigned yet */\n+#define ND_OPT_ROUTE_INFO\t\t200\n+/* draft-ietf-mobileip-hmipv6, not officially assigned yet */\n+#define ND_OPT_MAP\t\t\t201\n+\n+struct nd_opt_route_info {\t/* route info */\n+\tu_int8_t\tnd_opt_rti_type;\n+\tu_int8_t\tnd_opt_rti_len;\n+\tu_int8_t\tnd_opt_rti_prefixlen;\n+\tu_int8_t\tnd_opt_rti_flags;\n+\tu_int32_t\tnd_opt_rti_lifetime;\n+\t/* prefix follows */\n+};\n+\n+struct nd_opt_prefix_info {\t/* prefix information */\n+\tu_int8_t\tnd_opt_pi_type;\n+\tu_int8_t\tnd_opt_pi_len;\n+\tu_int8_t\tnd_opt_pi_prefix_len;\n+\tu_int8_t\tnd_opt_pi_flags_reserved;\n+\tu_int32_t\tnd_opt_pi_valid_time;\n+\tu_int32_t\tnd_opt_pi_preferred_time;\n+\tu_int32_t\tnd_opt_pi_reserved2;\n+\tstruct in6_addr\tnd_opt_pi_prefix;\n+} __packed;\n+\n+#define ND_OPT_PI_FLAG_ONLINK\t\t0x80\n+#define ND_OPT_PI_FLAG_AUTO\t\t0x40\n+\n+struct nd_opt_rd_hdr {\t\t/* redirected header */\n+\tu_int8_t\tnd_opt_rh_type;\n+\tu_int8_t\tnd_opt_rh_len;\n+\tu_int16_t\tnd_opt_rh_reserved1;\n+\tu_int32_t\tnd_opt_rh_reserved2;\n+\t/* followed by IP header and data */\n+} __packed;\n+\n+struct nd_opt_mtu {\t\t/* MTU option */\n+\tu_int8_t\tnd_opt_mtu_type;\n+\tu_int8_t\tnd_opt_mtu_len;\n+\tu_int16_t\tnd_opt_mtu_reserved;\n+\tu_int32_t\tnd_opt_mtu_mtu;\n+} __packed;\n+\n+struct nd_opt_rdnss {\t\t/* RDNSS option RFC 5006 */\n+\tu_int8_t\tnd_opt_rdnss_type;\n+\tu_int8_t\tnd_opt_rdnss_len;\n+\tu_int16_t\tnd_opt_rdnss_reserved;\n+\tu_int32_t\tnd_opt_rdnss_lifetime;\n+\t/* followed by list of IP prefixes */\n+} __packed;\n+\n+/*\n+ * icmp6 namelookup\n+ */\n+\n+struct icmp6_namelookup {\n+\tstruct icmp6_hdr \ticmp6_nl_hdr;\n+\tu_int8_t\ticmp6_nl_nonce[8];\n+\tint32_t\t\ticmp6_nl_ttl;\n+#if 0\n+\tu_int8_t\ticmp6_nl_len;\n+\tu_int8_t\ticmp6_nl_name[3];\n+#endif\n+\t/* could be followed by options */\n+} __packed;\n+\n+/*\n+ * icmp6 node information\n+ */\n+struct icmp6_nodeinfo {\n+\tstruct icmp6_hdr icmp6_ni_hdr;\n+\tu_int8_t icmp6_ni_nonce[8];\n+\t/* could be followed by reply data */\n+} __packed;\n+\n+#define ni_type\t\ticmp6_ni_hdr.icmp6_type\n+#define ni_code\t\ticmp6_ni_hdr.icmp6_code\n+#define ni_cksum\ticmp6_ni_hdr.icmp6_cksum\n+#define ni_qtype\ticmp6_ni_hdr.icmp6_data16[0]\n+#define ni_flags\ticmp6_ni_hdr.icmp6_data16[1]\n+\n+#define NI_QTYPE_NOOP\t\t0 /* NOOP  */\n+#define NI_QTYPE_SUPTYPES\t1 /* Supported Qtypes */\n+#define NI_QTYPE_FQDN\t\t2 /* FQDN (draft 04) */\n+#define NI_QTYPE_DNSNAME\t2 /* DNS Name */\n+#define NI_QTYPE_NODEADDR\t3 /* Node Addresses */\n+#define NI_QTYPE_IPV4ADDR\t4 /* IPv4 Addresses */\n+\n+#if BYTE_ORDER == BIG_ENDIAN\n+#define NI_SUPTYPE_FLAG_COMPRESS\t0x1\n+#define NI_FQDN_FLAG_VALIDTTL\t\t0x1\n+#elif BYTE_ORDER == LITTLE_ENDIAN\n+#define NI_SUPTYPE_FLAG_COMPRESS\t0x0100\n+#define NI_FQDN_FLAG_VALIDTTL\t\t0x0100\n+#endif\n+\n+#ifdef NAME_LOOKUPS_04\n+#if BYTE_ORDER == BIG_ENDIAN\n+#define NI_NODEADDR_FLAG_LINKLOCAL\t0x1\n+#define NI_NODEADDR_FLAG_SITELOCAL\t0x2\n+#define NI_NODEADDR_FLAG_GLOBAL\t\t0x4\n+#define NI_NODEADDR_FLAG_ALL\t\t0x8\n+#define NI_NODEADDR_FLAG_TRUNCATE\t0x10\n+#define NI_NODEADDR_FLAG_ANYCAST\t0x20 /* just experimental. not in spec */\n+#elif BYTE_ORDER == LITTLE_ENDIAN\n+#define NI_NODEADDR_FLAG_LINKLOCAL\t0x0100\n+#define NI_NODEADDR_FLAG_SITELOCAL\t0x0200\n+#define NI_NODEADDR_FLAG_GLOBAL\t\t0x0400\n+#define NI_NODEADDR_FLAG_ALL\t\t0x0800\n+#define NI_NODEADDR_FLAG_TRUNCATE\t0x1000\n+#define NI_NODEADDR_FLAG_ANYCAST\t0x2000 /* just experimental. not in spec */\n+#endif\n+#else  /* draft-ietf-ipngwg-icmp-name-lookups-05 (and later?) */\n+#if BYTE_ORDER == BIG_ENDIAN\n+#define NI_NODEADDR_FLAG_TRUNCATE\t0x1\n+#define NI_NODEADDR_FLAG_ALL\t\t0x2\n+#define NI_NODEADDR_FLAG_COMPAT\t\t0x4\n+#define NI_NODEADDR_FLAG_LINKLOCAL\t0x8\n+#define NI_NODEADDR_FLAG_SITELOCAL\t0x10\n+#define NI_NODEADDR_FLAG_GLOBAL\t\t0x20\n+#define NI_NODEADDR_FLAG_ANYCAST\t0x40 /* just experimental. not in spec */\n+#elif BYTE_ORDER == LITTLE_ENDIAN\n+#define NI_NODEADDR_FLAG_TRUNCATE\t0x0100\n+#define NI_NODEADDR_FLAG_ALL\t\t0x0200\n+#define NI_NODEADDR_FLAG_COMPAT\t\t0x0400\n+#define NI_NODEADDR_FLAG_LINKLOCAL\t0x0800\n+#define NI_NODEADDR_FLAG_SITELOCAL\t0x1000\n+#define NI_NODEADDR_FLAG_GLOBAL\t\t0x2000\n+#define NI_NODEADDR_FLAG_ANYCAST\t0x4000 /* just experimental. not in spec */\n+#endif\n+#endif\n+\n+struct ni_reply_fqdn {\n+\tu_int32_t ni_fqdn_ttl;\t/* TTL */\n+\tu_int8_t ni_fqdn_namelen; /* length in octets of the FQDN */\n+\tu_int8_t ni_fqdn_name[3]; /* XXX: alignment */\n+} __packed;\n+\n+/*\n+ * Router Renumbering. as router-renum-08.txt\n+ */\n+struct icmp6_router_renum {\t/* router renumbering header */\n+\tstruct icmp6_hdr\trr_hdr;\n+\tu_int8_t\trr_segnum;\n+\tu_int8_t\trr_flags;\n+\tu_int16_t\trr_maxdelay;\n+\tu_int32_t\trr_reserved;\n+} __packed;\n+\n+#define ICMP6_RR_FLAGS_TEST\t\t0x80\n+#define ICMP6_RR_FLAGS_REQRESULT\t0x40\n+#define ICMP6_RR_FLAGS_FORCEAPPLY\t0x20\n+#define ICMP6_RR_FLAGS_SPECSITE\t\t0x10\n+#define ICMP6_RR_FLAGS_PREVDONE\t\t0x08\n+\n+#define rr_type\t\trr_hdr.icmp6_type\n+#define rr_code\t\trr_hdr.icmp6_code\n+#define rr_cksum\trr_hdr.icmp6_cksum\n+#define rr_seqnum \trr_hdr.icmp6_data32[0]\n+\n+struct rr_pco_match {\t\t/* match prefix part */\n+\tu_int8_t\trpm_code;\n+\tu_int8_t\trpm_len;\n+\tu_int8_t\trpm_ordinal;\n+\tu_int8_t\trpm_matchlen;\n+\tu_int8_t\trpm_minlen;\n+\tu_int8_t\trpm_maxlen;\n+\tu_int16_t\trpm_reserved;\n+\tstruct\tin6_addr\trpm_prefix;\n+} __packed;\n+\n+#define RPM_PCO_ADD\t\t1\n+#define RPM_PCO_CHANGE\t\t2\n+#define RPM_PCO_SETGLOBAL\t3\n+#define RPM_PCO_MAX\t\t4\n+\n+struct rr_pco_use {\t\t/* use prefix part */\n+\tu_int8_t\trpu_uselen;\n+\tu_int8_t\trpu_keeplen;\n+\tu_int8_t\trpu_ramask;\n+\tu_int8_t\trpu_raflags;\n+\tu_int32_t\trpu_vltime;\n+\tu_int32_t\trpu_pltime;\n+\tu_int32_t\trpu_flags;\n+\tstruct\tin6_addr rpu_prefix;\n+} __packed;\n+#define ICMP6_RR_PCOUSE_RAFLAGS_ONLINK\t0x80\n+#define ICMP6_RR_PCOUSE_RAFLAGS_AUTO\t0x40\n+\n+#if BYTE_ORDER == BIG_ENDIAN\n+#define ICMP6_RR_PCOUSE_FLAGS_DECRVLTIME     0x80000000\n+#define ICMP6_RR_PCOUSE_FLAGS_DECRPLTIME     0x40000000\n+#elif BYTE_ORDER == LITTLE_ENDIAN\n+#define ICMP6_RR_PCOUSE_FLAGS_DECRVLTIME     0x80\n+#define ICMP6_RR_PCOUSE_FLAGS_DECRPLTIME     0x40\n+#endif\n+\n+struct rr_result {\t\t/* router renumbering result message */\n+\tu_int16_t\trrr_flags;\n+\tu_int8_t\trrr_ordinal;\n+\tu_int8_t\trrr_matchedlen;\n+\tu_int32_t\trrr_ifid;\n+\tstruct\tin6_addr rrr_prefix;\n+} __packed;\n+#if BYTE_ORDER == BIG_ENDIAN\n+#define ICMP6_RR_RESULT_FLAGS_OOB\t\t0x0002\n+#define ICMP6_RR_RESULT_FLAGS_FORBIDDEN\t\t0x0001\n+#elif BYTE_ORDER == LITTLE_ENDIAN\n+#define ICMP6_RR_RESULT_FLAGS_OOB\t\t0x0200\n+#define ICMP6_RR_RESULT_FLAGS_FORBIDDEN\t\t0x0100\n+#endif\n+\n+/*\n+ * icmp6 filter structures.\n+ */\n+\n+struct icmp6_filter {\n+\tu_int32_t icmp6_filt[8];\n+};\n+\n+#define\tICMP6_FILTER_SETPASSALL(filterp) \\\n+\t(void)memset(filterp, 0xff, sizeof(struct icmp6_filter))\n+#define\tICMP6_FILTER_SETBLOCKALL(filterp) \\\n+\t(void)memset(filterp, 0x00, sizeof(struct icmp6_filter))\n+#define\tICMP6_FILTER_SETPASS(type, filterp) \\\n+\t(((filterp)->icmp6_filt[(type) >> 5]) |= (1 << ((type) & 31)))\n+#define\tICMP6_FILTER_SETBLOCK(type, filterp) \\\n+\t(((filterp)->icmp6_filt[(type) >> 5]) &= ~(1 << ((type) & 31)))\n+#define\tICMP6_FILTER_WILLPASS(type, filterp) \\\n+\t((((filterp)->icmp6_filt[(type) >> 5]) & (1 << ((type) & 31))) != 0)\n+#define\tICMP6_FILTER_WILLBLOCK(type, filterp) \\\n+\t((((filterp)->icmp6_filt[(type) >> 5]) & (1 << ((type) & 31))) == 0)\n+\n+/*\n+ * Variables related to this implementation\n+ * of the internet control message protocol version 6.\n+ */\n+\n+/*\n+ * IPv6 ICMP statistics.\n+ * Each counter is an unsigned 64-bit value.\n+ */\n+#define\tICMP6_STAT_ERROR\t0\t/* # of calls to icmp6_error */\n+#define\tICMP6_STAT_CANTERROR\t1\t/* no error (old was icmp) */\n+#define\tICMP6_STAT_TOOFREQ\t2\t/* no error (rate limitation) */\n+#define\tICMP6_STAT_OUTHIST\t3\t/* # of output messages */\n+\t\t/* space for 256 counters */\n+#define\tICMP6_STAT_BADCODE\t259\t/* icmp6_code out of range */\n+#define\tICMP6_STAT_TOOSHORT\t260\t/* packet < sizeof(struct icmp6_hdr) */\n+#define\tICMP6_STAT_CHECKSUM\t261\t/* bad checksum */\n+#define\tICMP6_STAT_BADLEN\t262\t/* calculated bound mismatch */\n+\t/*\n+\t * number of responses; this member is inherited from the netinet code,\n+\t * but for netinet6 code, it is already available in outhist[].\n+\t */\n+#define\tICMP6_STAT_REFLECT\t263\n+#define\tICMP6_STAT_INHIST\t264\t/* # of input messages */\n+\t\t/* space for 256 counters */\n+#define\tICMP6_STAT_ND_TOOMANYOPT 520\t/* too many ND options */\n+#define\tICMP6_STAT_OUTERRHIST\t521\n+\t\t/* space for 13 counters */\n+#define\tICMP6_STAT_PMTUCHG\t534\t/* path MTU changes */\n+#define\tICMP6_STAT_ND_BADOPT\t535\t/* bad ND options */\n+#define\tICMP6_STAT_BADNS\t536\t/* bad neighbor solicititation */\n+#define\tICMP6_STAT_BADNA\t537\t/* bad neighbor advertisement */\n+#define\tICMP6_STAT_BADRS\t538\t/* bad router solicitiation */\n+#define\tICMP6_STAT_BADRA\t539\t/* bad router advertisement */\n+#define\tICMP6_STAT_BADREDIRECT\t540\t/* bad redirect message */\n+\n+#define\tICMP6_NSTATS\t\t541\n+\n+#define\tICMP6_ERRSTAT_DST_UNREACH_NOROUTE\t0\n+#define\tICMP6_ERRSTAT_DST_UNREACH_ADMIN\t\t1\n+#define\tICMP6_ERRSTAT_DST_UNREACH_BEYONDSCOPE\t2\n+#define\tICMP6_ERRSTAT_DST_UNREACH_ADDR\t\t3\n+#define\tICMP6_ERRSTAT_DST_UNREACH_NOPORT\t4\n+#define\tICMP6_ERRSTAT_PACKET_TOO_BIG\t\t5\n+#define\tICMP6_ERRSTAT_TIME_EXCEED_TRANSIT\t6\n+#define\tICMP6_ERRSTAT_TIME_EXCEED_REASSEMBLY\t7\n+#define\tICMP6_ERRSTAT_PARAMPROB_HEADER\t\t8\n+#define\tICMP6_ERRSTAT_PARAMPROB_NEXTHEADER\t9\n+#define\tICMP6_ERRSTAT_PARAMPROB_OPTION\t\t10\n+#define\tICMP6_ERRSTAT_REDIRECT\t\t\t11\n+#define\tICMP6_ERRSTAT_UNKNOWN\t\t\t12\n+\n+/*\n+ * Names for ICMP sysctl objects\n+ */\n+#define ICMPV6CTL_STATS\t\t1\n+#define ICMPV6CTL_REDIRACCEPT\t2\t/* accept/process redirects */\n+#define ICMPV6CTL_REDIRTIMEOUT\t3\t/* redirect cache time */\n+#if 0\t/*obsoleted*/\n+#define ICMPV6CTL_ERRRATELIMIT\t5\t/* ICMPv6 error rate limitation */\n+#endif\n+#define ICMPV6CTL_ND6_PRUNE\t6\n+#define ICMPV6CTL_ND6_DELAY\t8\n+#define ICMPV6CTL_ND6_UMAXTRIES\t9\n+#define ICMPV6CTL_ND6_MMAXTRIES\t\t10\n+#define ICMPV6CTL_ND6_USELOOPBACK\t11\n+/*#define ICMPV6CTL_ND6_PROXYALL\t12\tobsoleted, do not reuse here */\n+#define ICMPV6CTL_NODEINFO\t13\n+#define ICMPV6CTL_ERRPPSLIMIT\t14\t/* ICMPv6 error pps limitation */\n+#define ICMPV6CTL_ND6_MAXNUDHINT\t15\n+#define ICMPV6CTL_MTUDISC_HIWAT\t16\n+#define ICMPV6CTL_MTUDISC_LOWAT\t17\n+#define ICMPV6CTL_ND6_DEBUG\t18\n+#define ICMPV6CTL_ND6_DRLIST\t19\n+#define ICMPV6CTL_ND6_PRLIST\t20\n+#define\tICMPV6CTL_ND6_MAXQLEN\t24\n+#define ICMPV6CTL_MAXID\t\t25\n+\n+#define ICMPV6CTL_NAMES { \\\n+\t{ 0, 0 }, \\\n+\t{ 0, 0 }, \\\n+\t{ \""rediraccept\"", CTLTYPE_INT }, \\\n+\t{ \""redirtimeout\"", CTLTYPE_INT }, \\\n+\t{ 0, 0 }, \\\n+\t{ 0, 0 }, \\\n+\t{ \""nd6_prune\"", CTLTYPE_INT }, \\\n+\t{ 0, 0 }, \\\n+\t{ \""nd6_delay\"", CTLTYPE_INT }, \\\n+\t{ \""nd6_umaxtries\"", CTLTYPE_INT }, \\\n+\t{ \""nd6_mmaxtries\"", CTLTYPE_INT }, \\\n+\t{ \""nd6_useloopback\"", CTLTYPE_INT }, \\\n+\t{ 0, 0 }, \\\n+\t{ \""nodeinfo\"", CTLTYPE_INT }, \\\n+\t{ \""errppslimit\"", CTLTYPE_INT }, \\\n+\t{ \""nd6_maxnudhint\"", CTLTYPE_INT }, \\\n+\t{ \""mtudisc_hiwat\"", CTLTYPE_INT }, \\\n+\t{ \""mtudisc_lowat\"", CTLTYPE_INT }, \\\n+\t{ \""nd6_debug\"", CTLTYPE_INT }, \\\n+\t{ 0, 0 }, \\\n+\t{ 0, 0 }, \\\n+\t{ 0, 0 }, \\\n+\t{ 0, 0 }, \\\n+\t{ 0, 0 }, \\\n+\t{ \""nd6_maxqueuelen\"", CTLTYPE_INT }, \\\n+}\n+\n+#define RTF_PROBEMTU\tRTF_PROTO1\n+\n+#ifdef _KERNEL\n+struct\trtentry;\n+struct\trttimer;\n+struct\tin6_multi;\n+\n+void\ticmp6_init(void);\n+void\ticmp6_paramerror(struct mbuf *, int);\n+void\ticmp6_error(struct mbuf *, int, int, int);\n+void\ticmp6_error2(struct mbuf *, int, int, int, struct ifnet *);\n+int\ticmp6_input(struct mbuf **, int *, int);\n+void\ticmp6_fasttimo(void);\n+void\ticmp6_reflect(struct mbuf *, size_t);\n+void\ticmp6_prepare(struct mbuf *);\n+void\ticmp6_redirect_input(struct mbuf *, int);\n+void\ticmp6_redirect_output(struct mbuf *, struct rtentry *);\n+int\ticmp6_sysctl(int *, u_int, void *, size_t *, void *, size_t);\n+\n+void\ticmp6_statinc(u_int);\n+\n+struct\tip6ctlparam;\n+void\ticmp6_mtudisc_update(struct ip6ctlparam *, int);\n+void\ticmp6_mtudisc_callback_register(void (*)(struct in6_addr *));\n+\n+/* XXX: is this the right place for these macros? */\n+#define icmp6_ifstat_inc(ifp, tag) \\\n+do {\t\t\t\t\t\t\t\t\\\n+\tif (ifp)\t\t\t\t\t\t\\\n+\t\t((struct in6_ifextra *)((ifp)->if_afdata[AF_INET6]))->icmp6_ifstat->tag++; \\\n+} while (/*CONSTCOND*/ 0)\n+\n+#define icmp6_ifoutstat_inc(ifp, type, code) \\\n+do { \\\n+\t\ticmp6_ifstat_inc(ifp, ifs6_out_msg); \\\n+\t\tswitch(type) { \\\n+\t\t case ICMP6_DST_UNREACH: \\\n+\t\t\t icmp6_ifstat_inc(ifp, ifs6_out_dstunreach); \\\n+\t\t\t if (code == ICMP6_DST_UNREACH_ADMIN) \\\n+\t\t\t\t icmp6_ifstat_inc(ifp, ifs6_out_adminprohib); \\\n+\t\t\t break; \\\n+\t\t case ICMP6_PACKET_TOO_BIG: \\\n+\t\t\t icmp6_ifstat_inc(ifp, ifs6_out_pkttoobig); \\\n+\t\t\t break; \\\n+\t\t case ICMP6_TIME_EXCEEDED: \\\n+\t\t\t icmp6_ifstat_inc(ifp, ifs6_out_timeexceed); \\\n+\t\t\t break; \\\n+\t\t case ICMP6_PARAM_PROB: \\\n+\t\t\t icmp6_ifstat_inc(ifp, ifs6_out_paramprob); \\\n+\t\t\t break; \\\n+\t\t case ICMP6_ECHO_REQUEST: \\\n+\t\t\t icmp6_ifstat_inc(ifp, ifs6_out_echo); \\\n+\t\t\t break; \\\n+\t\t case ICMP6_ECHO_REPLY: \\\n+\t\t\t icmp6_ifstat_inc(ifp, ifs6_out_echoreply); \\\n+\t\t\t break; \\\n+\t\t case MLD_LISTENER_QUERY: \\\n+\t\t\t icmp6_ifstat_inc(ifp, ifs6_out_mldquery); \\\n+\t\t\t break; \\\n+\t\t case MLD_LISTENER_REPORT: \\\n+\t\t\t icmp6_ifstat_inc(ifp, ifs6_out_mldreport); \\\n+\t\t\t break; \\\n+\t\t case MLD_LISTENER_DONE: \\\n+\t\t\t icmp6_ifstat_inc(ifp, ifs6_out_mlddone); \\\n+\t\t\t break; \\\n+\t\t case ND_ROUTER_SOLICIT: \\\n+\t\t\t icmp6_ifstat_inc(ifp, ifs6_out_routersolicit); \\\n+\t\t\t break; \\\n+\t\t case ND_ROUTER_ADVERT: \\\n+\t\t\t icmp6_ifstat_inc(ifp, ifs6_out_routeradvert); \\\n+\t\t\t break; \\\n+\t\t case ND_NEIGHBOR_SOLICIT: \\\n+\t\t\t icmp6_ifstat_inc(ifp, ifs6_out_neighborsolicit); \\\n+\t\t\t break; \\\n+\t\t case ND_NEIGHBOR_ADVERT: \\\n+\t\t\t icmp6_ifstat_inc(ifp, ifs6_out_neighboradvert); \\\n+\t\t\t break; \\\n+\t\t case ND_REDIRECT: \\\n+\t\t\t icmp6_ifstat_inc(ifp, ifs6_out_redirect); \\\n+\t\t\t break; \\\n+\t\t} \\\n+} while (/*CONSTCOND*/ 0)\n+\n+extern int\ticmp6_rediraccept;\t/* accept/process redirects */\n+extern int\ticmp6_redirtimeout;\t/* cache time for redirect routes */\n+#endif /* _KERNEL */\n+\n+#endif /* !_NETINET_ICMP6_H_ */\n"", ""ip6.h"": ""@@ -0,0 +1,319 @@\n+/*\t$NetBSD: ip6.h,v 1.23 2007/12/25 18:33:46 perry Exp $\t*/\n+/*\t$KAME: ip6.h,v 1.45 2003/06/05 04:46:38 keiichi Exp $\t*/\n+\n+/*\n+ * Copyright (C) 1995, 1996, 1997, and 1998 WIDE Project.\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions\n+ * are met:\n+ * 1. Redistributions of source code must retain the above copyright\n+ *    notice, this list of conditions and the following disclaimer.\n+ * 2. Redistributions in binary form must reproduce the above copyright\n+ *    notice, this list of conditions and the following disclaimer in the\n+ *    documentation and/or other materials provided with the distribution.\n+ * 3. Neither the name of the project nor the names of its contributors\n+ *    may be used to endorse or promote products derived from this software\n+ *    without specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\n+ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE\n+ * ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE\n+ * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL\n+ * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS\n+ * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)\n+ * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT\n+ * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY\n+ * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF\n+ * SUCH DAMAGE.\n+ */\n+\n+/*\n+ * Copyright (c) 1982, 1986, 1993\n+ *\tThe Regents of the University of California.  All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions\n+ * are met:\n+ * 1. Redistributions of source code must retain the above copyright\n+ *    notice, this list of conditions and the following disclaimer.\n+ * 2. Redistributions in binary form must reproduce the above copyright\n+ *    notice, this list of conditions and the following disclaimer in the\n+ *    documentation and/or other materials provided with the distribution.\n+ * 3. Neither the name of the University nor the names of its contributors\n+ *    may be used to endorse or promote products derived from this software\n+ *    without specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\n+ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE\n+ * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE\n+ * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL\n+ * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS\n+ * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)\n+ * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT\n+ * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY\n+ * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF\n+ * SUCH DAMAGE.\n+ *\n+ *\t@(#)ip.h\t8.1 (Berkeley) 6/10/93\n+ */\n+\n+#ifndef _NETINET_IP6_H_\n+#define _NETINET_IP6_H_\n+\n+/*\n+ * Definition for internet protocol version 6.\n+ * RFC 2460\n+ */\n+\n+struct ip6_hdr {\n+\tunion {\n+\t\tstruct ip6_hdrctl {\n+\t\t\tu_int32_t ip6_un1_flow;\t/* 20 bits of flow-ID */\n+\t\t\tu_int16_t ip6_un1_plen;\t/* payload length */\n+\t\t\tu_int8_t  ip6_un1_nxt;\t/* next header */\n+\t\t\tu_int8_t  ip6_un1_hlim;\t/* hop limit */\n+\t\t} ip6_un1;\n+\t\tu_int8_t ip6_un2_vfc;\t/* 4 bits version, top 4 bits class */\n+\t} ip6_ctlun;\n+\tstruct in6_addr ip6_src;\t/* source address */\n+\tstruct in6_addr ip6_dst;\t/* destination address */\n+} __packed;\n+\n+#define ip6_vfc\t\tip6_ctlun.ip6_un2_vfc\n+#define ip6_flow\tip6_ctlun.ip6_un1.ip6_un1_flow\n+#define ip6_plen\tip6_ctlun.ip6_un1.ip6_un1_plen\n+#define ip6_nxt\t\tip6_ctlun.ip6_un1.ip6_un1_nxt\n+#define ip6_hlim\tip6_ctlun.ip6_un1.ip6_un1_hlim\n+#define ip6_hops\tip6_ctlun.ip6_un1.ip6_un1_hlim\n+\n+#define IPV6_VERSION\t\t0x60\n+#define IPV6_VERSION_MASK\t0xf0\n+\n+#if BYTE_ORDER == BIG_ENDIAN\n+#define IPV6_FLOWINFO_MASK\t0x0fffffff\t/* flow info (28 bits) */\n+#define IPV6_FLOWLABEL_MASK\t0x000fffff\t/* flow label (20 bits) */\n+#else\n+#if BYTE_ORDER == LITTLE_ENDIAN\n+#define IPV6_FLOWINFO_MASK\t0xffffff0f\t/* flow info (28 bits) */\n+#define IPV6_FLOWLABEL_MASK\t0xffff0f00\t/* flow label (20 bits) */\n+#endif /* LITTLE_ENDIAN */\n+#endif\n+#if 1\n+/* ECN bits proposed by Sally Floyd */\n+#define IP6TOS_CE\t\t0x01\t/* congestion experienced */\n+#define IP6TOS_ECT\t\t0x02\t/* ECN-capable transport */\n+#endif\n+\n+#ifdef _KERNEL\n+/*\n+ * for IPv6 pseudo header checksum\n+ * XXX nonstandard\n+ */\n+struct ip6_hdr_pseudo {\n+\tstruct in6_addr ip6ph_src;\n+\tstruct in6_addr ip6ph_dst;\n+\tu_int32_t\tip6ph_len;\n+\tu_int8_t\tip6ph_zero[3];\n+\tu_int8_t\tip6ph_nxt;\n+} __packed;\n+#endif\n+\n+/*\n+ * Extension Headers\n+ */\n+\n+struct\tip6_ext {\n+\tu_int8_t ip6e_nxt;\n+\tu_int8_t ip6e_len;\n+} __packed;\n+\n+/* Hop-by-Hop options header */\n+/* XXX should we pad it to force alignment on an 8-byte boundary? */\n+struct ip6_hbh {\n+\tu_int8_t ip6h_nxt;\t/* next header */\n+\tu_int8_t ip6h_len;\t/* length in units of 8 octets */\n+\t/* followed by options */\n+} __packed;\n+\n+/* Destination options header */\n+/* XXX should we pad it to force alignment on an 8-byte boundary? */\n+struct ip6_dest {\n+\tu_int8_t ip6d_nxt;\t/* next header */\n+\tu_int8_t ip6d_len;\t/* length in units of 8 octets */\n+\t/* followed by options */\n+} __packed;\n+\n+/* Option types and related macros */\n+#define IP6OPT_PAD1\t\t0x00\t/* 00 0 00000 */\n+#define IP6OPT_PADN\t\t0x01\t/* 00 0 00001 */\n+#define IP6OPT_JUMBO\t\t0xC2\t/* 11 0 00010 = 194 */\n+#define IP6OPT_NSAP_ADDR\t0xC3\t/* 11 0 00011 */\n+#define IP6OPT_TUNNEL_LIMIT\t0x04\t/* 00 0 00100 */\n+#define IP6OPT_RTALERT\t\t0x05\t/* 00 0 00101 (KAME definition) */\n+#define IP6OPT_ROUTER_ALERT\t0x05\t/* (RFC3542 def, recommended) */\n+\n+#define IP6OPT_RTALERT_LEN\t4\n+#define IP6OPT_RTALERT_MLD\t0\t/* Datagram contains an MLD message */\n+#define IP6OPT_RTALERT_RSVP\t1\t/* Datagram contains an RSVP message */\n+#define IP6OPT_RTALERT_ACTNET\t2 \t/* contains an Active Networks msg */\n+#define IP6OPT_MINLEN\t\t2\n+\n+#define IP6OPT_TYPE(o)\t\t((o) & 0xC0)\n+#define IP6OPT_TYPE_SKIP\t0x00\n+#define IP6OPT_TYPE_DISCARD\t0x40\n+#define IP6OPT_TYPE_FORCEICMP\t0x80\n+#define IP6OPT_TYPE_ICMP\t0xC0\n+\n+#define IP6OPT_MUTABLE\t\t0x20\n+\n+/* IPv6 options: common part */\n+struct ip6_opt {\n+\tu_int8_t ip6o_type;\n+\tu_int8_t ip6o_len;\n+} __packed;\n+\n+/* Jumbo Payload Option */\n+struct ip6_opt_jumbo {\n+\tu_int8_t ip6oj_type;\n+\tu_int8_t ip6oj_len;\n+\tu_int8_t ip6oj_jumbo_len[4];\n+} __packed;\n+#define IP6OPT_JUMBO_LEN 6\n+\n+/* NSAP Address Option */\n+struct ip6_opt_nsap {\n+\tu_int8_t ip6on_type;\n+\tu_int8_t ip6on_len;\n+\tu_int8_t ip6on_src_nsap_len;\n+\tu_int8_t ip6on_dst_nsap_len;\n+\t/* followed by source NSAP */\n+\t/* followed by destination NSAP */\n+} __packed;\n+\n+/* Tunnel Limit Option */\n+struct ip6_opt_tunnel {\n+\tu_int8_t ip6ot_type;\n+\tu_int8_t ip6ot_len;\n+\tu_int8_t ip6ot_encap_limit;\n+} __packed;\n+\n+/* Router Alert Option */\n+struct ip6_opt_router {\n+\tu_int8_t ip6or_type;\n+\tu_int8_t ip6or_len;\n+\tu_int8_t ip6or_value[2];\n+} __packed;\n+/* Router alert values (in network byte order) */\n+#if BYTE_ORDER == BIG_ENDIAN\n+#define IP6_ALERT_MLD\t0x0000\n+#define IP6_ALERT_RSVP\t0x0001\n+#define IP6_ALERT_AN\t0x0002\n+#else\n+#if BYTE_ORDER == LITTLE_ENDIAN\n+#define IP6_ALERT_MLD\t0x0000\n+#define IP6_ALERT_RSVP\t0x0100\n+#define IP6_ALERT_AN\t0x0200\n+#endif /* LITTLE_ENDIAN */\n+#endif\n+\n+/* Routing header */\n+struct ip6_rthdr {\n+\tu_int8_t  ip6r_nxt;\t/* next header */\n+\tu_int8_t  ip6r_len;\t/* length in units of 8 octets */\n+\tu_int8_t  ip6r_type;\t/* routing type */\n+\tu_int8_t  ip6r_segleft;\t/* segments left */\n+\t/* followed by routing type specific data */\n+} __packed;\n+\n+/* Type 0 Routing header */\n+struct ip6_rthdr0 {\n+\tu_int8_t  ip6r0_nxt;\t\t/* next header */\n+\tu_int8_t  ip6r0_len;\t\t/* length in units of 8 octets */\n+\tu_int8_t  ip6r0_type;\t\t/* always zero */\n+\tu_int8_t  ip6r0_segleft;\t/* segments left */\n+\tu_int32_t ip6r0_reserved;\t/* reserved field */\n+} __packed;\n+\n+/* Fragment header */\n+struct ip6_frag {\n+\tu_int8_t  ip6f_nxt;\t\t/* next header */\n+\tu_int8_t  ip6f_reserved;\t/* reserved field */\n+\tu_int16_t ip6f_offlg;\t\t/* offset, reserved, and flag */\n+\tu_int32_t ip6f_ident;\t\t/* identification */\n+} __packed;\n+\n+#if BYTE_ORDER == BIG_ENDIAN\n+#define IP6F_OFF_MASK\t\t0xfff8\t/* mask out offset from _offlg */\n+#define IP6F_RESERVED_MASK\t0x0006\t/* reserved bits in ip6f_offlg */\n+#define IP6F_MORE_FRAG\t\t0x0001\t/* more-fragments flag */\n+#else /* BYTE_ORDER == LITTLE_ENDIAN */\n+#define IP6F_OFF_MASK\t\t0xf8ff\t/* mask out offset from _offlg */\n+#define IP6F_RESERVED_MASK\t0x0600\t/* reserved bits in ip6f_offlg */\n+#define IP6F_MORE_FRAG\t\t0x0100\t/* more-fragments flag */\n+#endif /* BYTE_ORDER == LITTLE_ENDIAN */\n+\n+/*\n+ * Internet implementation parameters.\n+ */\n+#define IPV6_MAXHLIM\t255\t/* maximum hoplimit */\n+#define IPV6_DEFHLIM\t64\t/* default hlim */\n+#define IPV6_FRAGTTL\t120\t/* ttl for fragment packets, in slowtimo tick */\n+#define IPV6_HLIMDEC\t1\t/* subtracted when forwarding */\n+\n+#define IPV6_MMTU\t1280\t/* minimal MTU and reassembly. 1024 + 256 */\n+#define IPV6_MAXPACKET\t65535\t/* ip6 max packet size without Jumbo payload*/\n+\n+#ifdef _KERNEL\n+/*\n+ * IP6_EXTHDR_GET ensures that intermediate protocol header (from \""off\"" to\n+ * \""len\"") is located in single mbuf, on contiguous memory region.\n+ * The pointer to the region will be returned to pointer variable \""val\"",\n+ * with type \""typ\"".\n+ * IP6_EXTHDR_GET0 does the same, except that it aligns the structure at the\n+ * very top of mbuf.  GET0 is likely to make memory copy than GET.\n+ *\n+ * XXX we're now testing this, needs m_pulldown()\n+ */\n+#define IP6_EXTHDR_GET(val, typ, m, off, len) \\\n+do {\t\t\t\t\t\t\t\t\t\\\n+\tstruct mbuf *_t;\t\t\t\t\t\t\\\n+\tint _tmp;\t\t\t\t\t\t\t\\\n+\tif ((m)->m_len >= (off) + (len))\t\t\t\t\\\n+\t\t(val) = (typ)(mtod((m), char *) + (off));\t\t\\\n+\telse {\t\t\t\t\t\t\t\t\\\n+\t\t_t = m_pulldown((m), (off), (len), &_tmp);\t\t\\\n+\t\tif (_t) {\t\t\t\t\t\t\\\n+\t\t\tif (_t->m_len < _tmp + (len))\t\t\t\\\n+\t\t\t\tpanic(\""m_pulldown malfunction\"");\t\\\n+\t\t\t(val) = (typ)(mtod(_t, char *) + _tmp);\t\\\n+\t\t} else {\t\t\t\t\t\t\\\n+\t\t\t(val) = (typ)NULL;\t\t\t\t\\\n+\t\t\t(m) = NULL;\t\t\t\t\t\\\n+\t\t}\t\t\t\t\t\t\t\\\n+\t}\t\t\t\t\t\t\t\t\\\n+} while (/*CONSTCOND*/ 0)\n+\n+#define IP6_EXTHDR_GET0(val, typ, m, off, len) \\\n+do {\t\t\t\t\t\t\t\t\t\\\n+\tstruct mbuf *_t;\t\t\t\t\t\t\\\n+\tif ((off) == 0 && (m)->m_len >= len)\t\t\t\t\\\n+\t\t(val) = (typ)mtod((m), void *);\t\t\t\\\n+\telse {\t\t\t\t\t\t\t\t\\\n+\t\t_t = m_pulldown((m), (off), (len), NULL);\t\t\\\n+\t\tif (_t) {\t\t\t\t\t\t\\\n+\t\t\tif (_t->m_len < (len))\t\t\t\t\\\n+\t\t\t\tpanic(\""m_pulldown malfunction\"");\t\\\n+\t\t\t(val) = (typ)mtod(_t, void *);\t\t\t\\\n+\t\t} else {\t\t\t\t\t\t\\\n+\t\t\t(val) = (typ)NULL;\t\t\t\t\\\n+\t\t\t(m) = NULL;\t\t\t\t\t\\\n+\t\t}\t\t\t\t\t\t\t\\\n+\t}\t\t\t\t\t\t\t\t\\\n+} while (/*CONSTCOND*/ 0)\n+#endif /*_KERNEL*/\n+\n+#endif /* !_NETINET_IP6_H_ */\n""}","merge 
"
10797,Mike Chan,OMAP3 SDRC: Fix freeze when scaling CORE dpll to < 83Mhz,['arch/arm/mach-omap2/sram34xx.S'],"OMAP3 SDRC: Fix freeze when scaling CORE dpll to < 83Mhz

This patch fixes a bug in the CORE dpll scaling sequence which was
errouneously clearing some bits in the SDRC DLLA CTRL register and
hence causing a freeze.  The issue was observed only on platforms
which scale CORE dpll to < 83Mhz and hence program the DLL in fixed
delay mode.

Issue reported by Limei Wang <E12499@motorola.com>, with debugging
assistance from Richard Woodruff <r-woodruff2@ti.com> and Girish
Ghongdemath <girishsg@ti.com>.

Signed-off-by: Rajendra Nayak <rnayak@ti.com>
Cc: Limei Wang <E12499@motorola.com>
Cc: Richard Woodruff <r-woodruff2@ti.com>
Cc: Girish Ghongdemath <girishsg@ti.com>
Signed-off-by: Paul Walmsley <paul@pwsan.com>
Signed-off-by: Mike Chan <mike@android.com>
[paul@pwsan.com: updated patch description to include collaboration credits]
(cherry picked from commit 74ca25a3ac71cd0d7e933c067b3e4e0fb8721f30)",https://android-review.googlesource.com/c/10797,"bug
",bug,Bug;Resource;,"{""sram34xx.S"": ""@@ -112,7 +112,7 @@ return_to_sdram:\n unlock_dll:\n \tldr\tr11, omap3_sdrc_dlla_ctrl\n \tldr\tr12, [r11]\n-\tand\tr12, r12, #FIXEDDELAY_MASK\n+\tbic\tr12, r12, #FIXEDDELAY_MASK\n \torr\tr12, r12, #FIXEDDELAY_DEFAULT\n \torr\tr12, r12, #DLLIDLE_MASK\n \tstr\tr12, [r11]\t\t@ (no OCP barrier needed)\n""}","Categories: bug 
"
21925,luse cheng,Allow building toolchain without target gdb alternatively.,"['configure.ac', 'configure', 'Makefile.in']","Allow building toolchain without target gdb alternatively.

Change-Id: I3fd1c4f628c221e6ae4f939aab73e69b3e546bd1",https://android-review.googlesource.com/c/21925,"feature
",feature,Others;,"{""Makefile.in"": ""@@ -518,6 +518,11 @@ install-host-mpc: stmp-install-host-mpc\n \n # target gdb rules\n .PHONY: config-target-gdb build-target-gdb install-target-gdb\n+ifeq ($(GDB_VERSION),gdb-no)\n+config-target-gdb:\n+build-target-gdb:\n+install-target-gdb:\n+else\n config-target-gdb: stmp-config-target-gdb\n \n GDB_CONFIG_ARGS=$(baseargs) --prefix=$(prefix) \\\n@@ -539,6 +544,7 @@ stmp-build-target-gdb: stmp-config-target-gdb\n install-target-gdb: stmp-build-target-gdb\n \t($(canadian_env) \\\n \t $(MAKE) -C ${GDB_VERSION} install)\n+endif\n \n # clean rules\n .PHONY: clean\n"", ""configure"": ""@@ -808,6 +808,8 @@ Optional Packages:\n                           use mpfr-VERSION (default is 2.3.0)\n   --with-mpc-version=VERSION\n                           use mpc-VERSION (default is 0.8.1)\n+  --without-gdb\n+                          alternative to build without target gdb\n   --with-gdb-version=VERSION\n                           use gdb-VERSION (default is 6.6)\n   --with-sysroot=DIR\n@@ -1910,6 +1912,16 @@ fi\n fi\n \n \n+\n+# Check whether --with-gdb or --without-gdb was given.\n+if test \""${with_gdb+set}\"" = set; then\n+  withval=\""$with_gdb\""\n+  if test x\""$withval\"" = x\""no\"" ; then\n+     GDB_VERSION=\""$withval\""\n+   fi\n+fi;\n+\n+if test x\""$GDB_VERSION\"" != x\""no\"" ; then\n # gdb version (default is 6.6)\n echo \""$as_me:$LINENO: checking target gdb version to build\"" >&5\n echo $ECHO_N \""checking target gdb version to build... $ECHO_C\"" >&6\n@@ -1950,6 +1962,7 @@ echo \""$as_me: error: 'package gdb-${GDB_VERSION} does not exist.'\"" >&2;}\n    { (exit 1); exit 1; }; }\n   fi\n fi\n+fi\n \n # Sysroot location\n \n"", ""configure.ac"": ""@@ -364,6 +364,15 @@ ANDROID_CHECK_PACKAGE(mpc-${MPC_VERSION})\n fi\n AC_SUBST(MPC_VERSION)\n \n+AC_ARG_WITH([gdb],\n+  [  --without-gdb\n+                          alternative to build without target gdb],\n+  [if test x\""$withval\"" = x\""no\"" ; then\n+     GDB_VERSION=\""$withval\""\n+   fi],\n+[])\n+\n+if test x\""$GDB_VERSION\"" != x\""no\"" ; then\n # gdb version (default is 6.6)\n AC_MSG_CHECKING([target gdb version to build])\n AC_ARG_WITH([gdb-version],\n@@ -376,6 +385,7 @@ AC_ARG_WITH([gdb-version],\n AC_MSG_RESULT($GDB_VERSION)\n AC_SUBST(GDB_VERSION)\n ANDROID_CHECK_PACKAGE(gdb-${GDB_VERSION})\n+fi\n \n # Sysroot location\n AC_ARG_WITH([sysroot],\n""}","Categories: **refactor** 
"
16616,Xavier Ducrohet,Merge sdklib manifest fix for r7. DO NOT MERGE.,"['sdkmanager/libs/sdklib/manifest.txt', 'sdkmanager/libs/sdkuilib/src/com/android/sdkuilib/internal/repository/UpdaterData.java']","Merge sdklib manifest fix for r7. DO NOT MERGE.

Original commit msg:
Fix missing dependency in the sdklib manifest + improved error reporting.

Change-Id: I778a839cc280db8bcc7a4a0b11378119de9aed57",https://android-review.googlesource.com/c/16616,"merge, bug 
","bug,merge",Bug;,"{""manifest.txt"": ""@@ -1 +1 @@\n-Class-Path: androidprefs.jar\n+Class-Path: androidprefs.jar commons-compress-1.0.jar\n"", ""UpdaterData.java"": ""@@ -458,19 +458,22 @@ class UpdaterData {\n                         // Display anything unexpected in the monitor.\r\n                         String msg = t.getMessage();\r\n                         if (msg != null) {\r\n-                            monitor.setResult(\""Unexpected Error installing '%1$s': %2$s\"",\r\n-                                    archive.getParentPackage().getShortDescription(), msg);\r\n+                            msg = String.format(\""Unexpected Error installing '%1$s': %2$s: %3$s\"",\r\n+                                    archive.getParentPackage().getShortDescription(),\r\n+                                    t.getClass().getCanonicalName(), msg);\r\n                         } else {\r\n                             // no error info? get the stack call to display it\r\n                             // At least that'll give us a better bug report.\r\n                             ByteArrayOutputStream baos = new ByteArrayOutputStream();\r\n                             t.printStackTrace(new PrintStream(baos));\r\n \r\n-                            // and display it\r\n-                            monitor.setResult(\""Unexpected Error installing '%1$s'\\n%2$s\"",\r\n+                            msg = String.format(\""Unexpected Error installing '%1$s'\\n%2$s\"",\r\n                                     archive.getParentPackage().getShortDescription(),\r\n                                     baos.toString());\r\n                         }\r\n+\r\n+                        monitor.setResult(msg);\r\n+                        mSdkLog.error(t, msg);\r\n                     } finally {\r\n \r\n                         // Always move the progress bar to the desired position.\r\n""}","merge 
"
23045,David Turner,x86: kvm: fix KVM build + enable auto-detection.,"['qemu-options.hx', 'Makefile.target', 'android/config/linux-x86_64/asm/kvm.h', 'android/config/linux-x86_64/linux/kvm.h', 'vl-android.c', 'android/config/linux-x86/asm/kvm.h', 'target-i386/kvm.c', 'android/config/linux-x86/linux/kvm.h', 'kvm-android.c', 'android/config/target-x86/config.h', 'kvm-android.h']","x86: kvm: fix KVM build + enable auto-detection.

This patch fixes the build of KVM support in the x86 emulator by
copying official Ubuntu Lucid KVM headers into android/config/linux-*/

This removes the need to rely on the build machine's versions of these
headers, which caused various issues.

Also, by default, the emulator will now probe the system to see if it
can start in KVM mode automatically. See android-kvm.c for details.
You can see the result of the probing with the -verbose option.

IMPORTANT NOTE:
    It looks like it is not possible to use KVM when the emulator
    is built as a 32-bit binary, running on a 64-bit kernel. I assume
    because the kernel expects 64-bit address space pointers or
    something like that.

    As such, KVM only works when building the emulator as a
    64-bit program. For now, this is only possible with
    ""android-configure.sh --try-64"", not the Android build system.

+ Add a new QEMU option (-disable-kvm) to explicitely disable KVM
  if needed. This is an addition to -enable-kvm which already exists
  (and forces usage of KVM).

Change-Id: I6a397cae29ab62b1c56fce95c1ee75a4664d6688",https://android-review.googlesource.com/c/23045,"bug,feature
","bug,feature",Bug;Deprecat;Resource;,"{""Makefile.target"": ""@@ -175,12 +175,13 @@ LOCAL_SRC_FILES += fpu/softfloat-native.c\n endif\n \n # compile KVM only if target is x86 on x86 Linux\n-ifeq ($(QEMU_HOST_TAG)-$(EMULATOR_TARGET_ARCH),linux-x86-x86)\n-# the following is to include linux/kvm.h\n-LOCAL_CFLAGS += -I /usr/include\n-LOCAL_SRC_FILES += \\\n-    target-i386/kvm.c \\\n-    kvm-all.c\n+QEMU_KVM_TAG := $(QEMU_HOST_TAG)-$(EMULATOR_TARGET_ARCH)\n+QEMU_DO_KVM := $(if $(filter linux-x86-x86 linux-x86_64-x86,$(QEMU_KVM_TAG)),true,false)\n+ifeq ($(QEMU_DO_KVM),true)\n+    LOCAL_SRC_FILES += \\\n+        target-i386/kvm.c \\\n+        kvm-all.c \\\n+        kvm-android.c\n endif\n \n ##############################################################################\n"", ""kvm.h"": ""@@ -0,0 +1,712 @@\n+#ifndef __LINUX_KVM_H\n+#define __LINUX_KVM_H\n+\n+/*\n+ * Userspace interface for /dev/kvm - kernel based virtual machine\n+ *\n+ * Note: you must update KVM_API_VERSION if you change this interface.\n+ */\n+\n+#include <linux/types.h>\n+\n+#include <linux/ioctl.h>\n+#include <asm/kvm.h>\n+\n+#define KVM_API_VERSION 12\n+\n+/* for KVM_TRACE_ENABLE, deprecated */\n+struct kvm_user_trace_setup {\n+\t__u32 buf_size; /* sub_buffer size of each per-cpu */\n+\t__u32 buf_nr; /* the number of sub_buffers of each per-cpu */\n+};\n+\n+/* for KVM_CREATE_MEMORY_REGION */\n+struct kvm_memory_region {\n+\t__u32 slot;\n+\t__u32 flags;\n+\t__u64 guest_phys_addr;\n+\t__u64 memory_size; /* bytes */\n+};\n+\n+/* for KVM_SET_USER_MEMORY_REGION */\n+struct kvm_userspace_memory_region {\n+\t__u32 slot;\n+\t__u32 flags;\n+\t__u64 guest_phys_addr;\n+\t__u64 memory_size; /* bytes */\n+\t__u64 userspace_addr; /* start of the userspace allocated memory */\n+};\n+\n+/* for kvm_memory_region::flags */\n+#define KVM_MEM_LOG_DIRTY_PAGES  1UL\n+\n+\n+/* for KVM_IRQ_LINE */\n+struct kvm_irq_level {\n+\t/*\n+\t * ACPI gsi notion of irq.\n+\t * For IA-64 (APIC model) IOAPIC0: irq 0-23; IOAPIC1: irq 24-47..\n+\t * For X86 (standard AT mode) PIC0/1: irq 0-15. IOAPIC0: 0-23..\n+\t */\n+\tunion {\n+\t\t__u32 irq;\n+\t\t__s32 status;\n+\t};\n+\t__u32 level;\n+};\n+\n+\n+struct kvm_irqchip {\n+\t__u32 chip_id;\n+\t__u32 pad;\n+        union {\n+\t\tchar dummy[512];  /* reserving space */\n+#ifdef __KVM_HAVE_PIT\n+\t\tstruct kvm_pic_state pic;\n+#endif\n+#ifdef __KVM_HAVE_IOAPIC\n+\t\tstruct kvm_ioapic_state ioapic;\n+#endif\n+\t} chip;\n+};\n+\n+/* for KVM_CREATE_PIT2 */\n+struct kvm_pit_config {\n+\t__u32 flags;\n+\t__u32 pad[15];\n+};\n+\n+#define KVM_PIT_SPEAKER_DUMMY     1\n+\n+#define KVM_EXIT_UNKNOWN          0\n+#define KVM_EXIT_EXCEPTION        1\n+#define KVM_EXIT_IO               2\n+#define KVM_EXIT_HYPERCALL        3\n+#define KVM_EXIT_DEBUG            4\n+#define KVM_EXIT_HLT              5\n+#define KVM_EXIT_MMIO             6\n+#define KVM_EXIT_IRQ_WINDOW_OPEN  7\n+#define KVM_EXIT_SHUTDOWN         8\n+#define KVM_EXIT_FAIL_ENTRY       9\n+#define KVM_EXIT_INTR             10\n+#define KVM_EXIT_SET_TPR          11\n+#define KVM_EXIT_TPR_ACCESS       12\n+#define KVM_EXIT_S390_SIEIC       13\n+#define KVM_EXIT_S390_RESET       14\n+#define KVM_EXIT_DCR              15\n+#define KVM_EXIT_NMI              16\n+#define KVM_EXIT_INTERNAL_ERROR   17\n+\n+/* For KVM_EXIT_INTERNAL_ERROR */\n+#define KVM_INTERNAL_ERROR_EMULATION 1\n+\n+/* for KVM_RUN, returned by mmap(vcpu_fd, offset=0) */\n+struct kvm_run {\n+\t/* in */\n+\t__u8 request_interrupt_window;\n+\t__u8 padding1[7];\n+\n+\t/* out */\n+\t__u32 exit_reason;\n+\t__u8 ready_for_interrupt_injection;\n+\t__u8 if_flag;\n+\t__u8 padding2[2];\n+\n+\t/* in (pre_kvm_run), out (post_kvm_run) */\n+\t__u64 cr8;\n+\t__u64 apic_base;\n+\n+#ifdef __KVM_S390\n+\t/* the processor status word for s390 */\n+\t__u64 psw_mask; /* psw upper half */\n+\t__u64 psw_addr; /* psw lower half */\n+#endif\n+\tunion {\n+\t\t/* KVM_EXIT_UNKNOWN */\n+\t\tstruct {\n+\t\t\t__u64 hardware_exit_reason;\n+\t\t} hw;\n+\t\t/* KVM_EXIT_FAIL_ENTRY */\n+\t\tstruct {\n+\t\t\t__u64 hardware_entry_failure_reason;\n+\t\t} fail_entry;\n+\t\t/* KVM_EXIT_EXCEPTION */\n+\t\tstruct {\n+\t\t\t__u32 exception;\n+\t\t\t__u32 error_code;\n+\t\t} ex;\n+\t\t/* KVM_EXIT_IO */\n+\t\tstruct {\n+#define KVM_EXIT_IO_IN  0\n+#define KVM_EXIT_IO_OUT 1\n+\t\t\t__u8 direction;\n+\t\t\t__u8 size; /* bytes */\n+\t\t\t__u16 port;\n+\t\t\t__u32 count;\n+\t\t\t__u64 data_offset; /* relative to kvm_run start */\n+\t\t} io;\n+\t\tstruct {\n+\t\t\tstruct kvm_debug_exit_arch arch;\n+\t\t} debug;\n+\t\t/* KVM_EXIT_MMIO */\n+\t\tstruct {\n+\t\t\t__u64 phys_addr;\n+\t\t\t__u8  data[8];\n+\t\t\t__u32 len;\n+\t\t\t__u8  is_write;\n+\t\t} mmio;\n+\t\t/* KVM_EXIT_HYPERCALL */\n+\t\tstruct {\n+\t\t\t__u64 nr;\n+\t\t\t__u64 args[6];\n+\t\t\t__u64 ret;\n+\t\t\t__u32 longmode;\n+\t\t\t__u32 pad;\n+\t\t} hypercall;\n+\t\t/* KVM_EXIT_TPR_ACCESS */\n+\t\tstruct {\n+\t\t\t__u64 rip;\n+\t\t\t__u32 is_write;\n+\t\t\t__u32 pad;\n+\t\t} tpr_access;\n+\t\t/* KVM_EXIT_S390_SIEIC */\n+\t\tstruct {\n+\t\t\t__u8 icptcode;\n+\t\t\t__u16 ipa;\n+\t\t\t__u32 ipb;\n+\t\t} s390_sieic;\n+\t\t/* KVM_EXIT_S390_RESET */\n+#define KVM_S390_RESET_POR       1\n+#define KVM_S390_RESET_CLEAR     2\n+#define KVM_S390_RESET_SUBSYSTEM 4\n+#define KVM_S390_RESET_CPU_INIT  8\n+#define KVM_S390_RESET_IPL       16\n+\t\t__u64 s390_reset_flags;\n+\t\t/* KVM_EXIT_DCR */\n+\t\tstruct {\n+\t\t\t__u32 dcrn;\n+\t\t\t__u32 data;\n+\t\t\t__u8  is_write;\n+\t\t} dcr;\n+\t\tstruct {\n+\t\t\t__u32 suberror;\n+\t\t} internal;\n+\t\t/* Fix the size of the union. */\n+\t\tchar padding[256];\n+\t};\n+};\n+\n+/* for KVM_REGISTER_COALESCED_MMIO / KVM_UNREGISTER_COALESCED_MMIO */\n+\n+struct kvm_coalesced_mmio_zone {\n+\t__u64 addr;\n+\t__u32 size;\n+\t__u32 pad;\n+};\n+\n+struct kvm_coalesced_mmio {\n+\t__u64 phys_addr;\n+\t__u32 len;\n+\t__u32 pad;\n+\t__u8  data[8];\n+};\n+\n+struct kvm_coalesced_mmio_ring {\n+\t__u32 first, last;\n+\tstruct kvm_coalesced_mmio coalesced_mmio[0];\n+};\n+\n+#define KVM_COALESCED_MMIO_MAX \\\n+\t((PAGE_SIZE - sizeof(struct kvm_coalesced_mmio_ring)) / \\\n+\t sizeof(struct kvm_coalesced_mmio))\n+\n+/* for KVM_TRANSLATE */\n+struct kvm_translation {\n+\t/* in */\n+\t__u64 linear_address;\n+\n+\t/* out */\n+\t__u64 physical_address;\n+\t__u8  valid;\n+\t__u8  writeable;\n+\t__u8  usermode;\n+\t__u8  pad[5];\n+};\n+\n+/* for KVM_INTERRUPT */\n+struct kvm_interrupt {\n+\t/* in */\n+\t__u32 irq;\n+};\n+\n+/* for KVM_GET_DIRTY_LOG */\n+struct kvm_dirty_log {\n+\t__u32 slot;\n+\t__u32 padding1;\n+\tunion {\n+\t\tvoid *dirty_bitmap; /* one bit per page */\n+\t\t__u64 padding2;\n+\t};\n+};\n+\n+/* for KVM_SET_SIGNAL_MASK */\n+struct kvm_signal_mask {\n+\t__u32 len;\n+\t__u8  sigset[0];\n+};\n+\n+/* for KVM_TPR_ACCESS_REPORTING */\n+struct kvm_tpr_access_ctl {\n+\t__u32 enabled;\n+\t__u32 flags;\n+\t__u32 reserved[8];\n+};\n+\n+/* for KVM_SET_VAPIC_ADDR */\n+struct kvm_vapic_addr {\n+\t__u64 vapic_addr;\n+};\n+\n+/* for KVM_SET_MPSTATE */\n+\n+#define KVM_MP_STATE_RUNNABLE          0\n+#define KVM_MP_STATE_UNINITIALIZED     1\n+#define KVM_MP_STATE_INIT_RECEIVED     2\n+#define KVM_MP_STATE_HALTED            3\n+#define KVM_MP_STATE_SIPI_RECEIVED     4\n+\n+struct kvm_mp_state {\n+\t__u32 mp_state;\n+};\n+\n+struct kvm_s390_psw {\n+\t__u64 mask;\n+\t__u64 addr;\n+};\n+\n+/* valid values for type in kvm_s390_interrupt */\n+#define KVM_S390_SIGP_STOP\t\t0xfffe0000u\n+#define KVM_S390_PROGRAM_INT\t\t0xfffe0001u\n+#define KVM_S390_SIGP_SET_PREFIX\t0xfffe0002u\n+#define KVM_S390_RESTART\t\t0xfffe0003u\n+#define KVM_S390_INT_VIRTIO\t\t0xffff2603u\n+#define KVM_S390_INT_SERVICE\t\t0xffff2401u\n+#define KVM_S390_INT_EMERGENCY\t\t0xffff1201u\n+\n+struct kvm_s390_interrupt {\n+\t__u32 type;\n+\t__u32 parm;\n+\t__u64 parm64;\n+};\n+\n+/* for KVM_SET_GUEST_DEBUG */\n+\n+#define KVM_GUESTDBG_ENABLE\t\t0x00000001\n+#define KVM_GUESTDBG_SINGLESTEP\t\t0x00000002\n+\n+struct kvm_guest_debug {\n+\t__u32 control;\n+\t__u32 pad;\n+\tstruct kvm_guest_debug_arch arch;\n+};\n+\n+enum {\n+\tkvm_ioeventfd_flag_nr_datamatch,\n+\tkvm_ioeventfd_flag_nr_pio,\n+\tkvm_ioeventfd_flag_nr_deassign,\n+\tkvm_ioeventfd_flag_nr_max,\n+};\n+\n+#define KVM_IOEVENTFD_FLAG_DATAMATCH (1 << kvm_ioeventfd_flag_nr_datamatch)\n+#define KVM_IOEVENTFD_FLAG_PIO       (1 << kvm_ioeventfd_flag_nr_pio)\n+#define KVM_IOEVENTFD_FLAG_DEASSIGN  (1 << kvm_ioeventfd_flag_nr_deassign)\n+\n+#define KVM_IOEVENTFD_VALID_FLAG_MASK  ((1 << kvm_ioeventfd_flag_nr_max) - 1)\n+\n+struct kvm_ioeventfd {\n+\t__u64 datamatch;\n+\t__u64 addr;        /* legal pio/mmio address */\n+\t__u32 len;         /* 1, 2, 4, or 8 bytes    */\n+\t__s32 fd;\n+\t__u32 flags;\n+\t__u8  pad[36];\n+};\n+\n+#define KVM_TRC_SHIFT           16\n+/*\n+ * kvm trace categories\n+ */\n+#define KVM_TRC_ENTRYEXIT       (1 << KVM_TRC_SHIFT)\n+#define KVM_TRC_HANDLER         (1 << (KVM_TRC_SHIFT + 1)) /* only 12 bits */\n+\n+/*\n+ * kvm trace action\n+ */\n+#define KVM_TRC_VMENTRY         (KVM_TRC_ENTRYEXIT + 0x01)\n+#define KVM_TRC_VMEXIT          (KVM_TRC_ENTRYEXIT + 0x02)\n+#define KVM_TRC_PAGE_FAULT      (KVM_TRC_HANDLER + 0x01)\n+\n+#define KVM_TRC_HEAD_SIZE       12\n+#define KVM_TRC_CYCLE_SIZE      8\n+#define KVM_TRC_EXTRA_MAX       7\n+\n+#define KVMIO 0xAE\n+\n+/*\n+ * ioctls for /dev/kvm fds:\n+ */\n+#define KVM_GET_API_VERSION       _IO(KVMIO,   0x00)\n+#define KVM_CREATE_VM             _IO(KVMIO,   0x01) /* returns a VM fd */\n+#define KVM_GET_MSR_INDEX_LIST    _IOWR(KVMIO, 0x02, struct kvm_msr_list)\n+\n+#define KVM_S390_ENABLE_SIE       _IO(KVMIO,   0x06)\n+/*\n+ * Check if a kvm extension is available.  Argument is extension number,\n+ * return is 1 (yes) or 0 (no, sorry).\n+ */\n+#define KVM_CHECK_EXTENSION       _IO(KVMIO,   0x03)\n+/*\n+ * Get size for mmap(vcpu_fd)\n+ */\n+#define KVM_GET_VCPU_MMAP_SIZE    _IO(KVMIO,   0x04) /* in bytes */\n+#define KVM_GET_SUPPORTED_CPUID   _IOWR(KVMIO, 0x05, struct kvm_cpuid2)\n+/*\n+ * ioctls for kvm trace\n+ */\n+#define KVM_TRACE_ENABLE          _IOW(KVMIO, 0x06, struct kvm_user_trace_setup)\n+#define KVM_TRACE_PAUSE           _IO(KVMIO,  0x07)\n+#define KVM_TRACE_DISABLE         _IO(KVMIO,  0x08)\n+/*\n+ * Extension capability list.\n+ */\n+#define KVM_CAP_IRQCHIP\t  0\n+#define KVM_CAP_HLT\t  1\n+#define KVM_CAP_MMU_SHADOW_CACHE_CONTROL 2\n+#define KVM_CAP_USER_MEMORY 3\n+#define KVM_CAP_SET_TSS_ADDR 4\n+#define KVM_CAP_VAPIC 6\n+#define KVM_CAP_EXT_CPUID 7\n+#define KVM_CAP_CLOCKSOURCE 8\n+#define KVM_CAP_NR_VCPUS 9       /* returns max vcpus per vm */\n+#define KVM_CAP_NR_MEMSLOTS 10   /* returns max memory slots per vm */\n+#define KVM_CAP_PIT 11\n+#define KVM_CAP_NOP_IO_DELAY 12\n+#define KVM_CAP_PV_MMU 13\n+#define KVM_CAP_MP_STATE 14\n+#define KVM_CAP_COALESCED_MMIO 15\n+#define KVM_CAP_SYNC_MMU 16  /* Changes to host mmap are reflected in guest */\n+#ifdef __KVM_HAVE_DEVICE_ASSIGNMENT\n+#define KVM_CAP_DEVICE_ASSIGNMENT 17\n+#endif\n+#define KVM_CAP_IOMMU 18\n+#ifdef __KVM_HAVE_MSI\n+#define KVM_CAP_DEVICE_MSI 20\n+#endif\n+/* Bug in KVM_SET_USER_MEMORY_REGION fixed: */\n+#define KVM_CAP_DESTROY_MEMORY_REGION_WORKS 21\n+#ifdef __KVM_HAVE_USER_NMI\n+#define KVM_CAP_USER_NMI 22\n+#endif\n+#ifdef __KVM_HAVE_GUEST_DEBUG\n+#define KVM_CAP_SET_GUEST_DEBUG 23\n+#endif\n+#ifdef __KVM_HAVE_PIT\n+#define KVM_CAP_REINJECT_CONTROL 24\n+#endif\n+#ifdef __KVM_HAVE_IOAPIC\n+#define KVM_CAP_IRQ_ROUTING 25\n+#endif\n+#define KVM_CAP_IRQ_INJECT_STATUS 26\n+#ifdef __KVM_HAVE_DEVICE_ASSIGNMENT\n+#define KVM_CAP_DEVICE_DEASSIGNMENT 27\n+#endif\n+#ifdef __KVM_HAVE_MSIX\n+#define KVM_CAP_DEVICE_MSIX 28\n+#endif\n+#define KVM_CAP_ASSIGN_DEV_IRQ 29\n+/* Another bug in KVM_SET_USER_MEMORY_REGION fixed: */\n+#define KVM_CAP_JOIN_MEMORY_REGIONS_WORKS 30\n+#ifdef __KVM_HAVE_MCE\n+#define KVM_CAP_MCE 31\n+#endif\n+#define KVM_CAP_IRQFD 32\n+#ifdef __KVM_HAVE_PIT\n+#define KVM_CAP_PIT2 33\n+#endif\n+#define KVM_CAP_SET_BOOT_CPU_ID 34\n+#ifdef __KVM_HAVE_PIT_STATE2\n+#define KVM_CAP_PIT_STATE2 35\n+#endif\n+#define KVM_CAP_IOEVENTFD 36\n+#define KVM_CAP_SET_IDENTITY_MAP_ADDR 37\n+#define KVM_CAP_ADJUST_CLOCK 39\n+\n+#ifdef KVM_CAP_IRQ_ROUTING\n+\n+struct kvm_irq_routing_irqchip {\n+\t__u32 irqchip;\n+\t__u32 pin;\n+};\n+\n+struct kvm_irq_routing_msi {\n+\t__u32 address_lo;\n+\t__u32 address_hi;\n+\t__u32 data;\n+\t__u32 pad;\n+};\n+\n+/* gsi routing entry types */\n+#define KVM_IRQ_ROUTING_IRQCHIP 1\n+#define KVM_IRQ_ROUTING_MSI 2\n+\n+struct kvm_irq_routing_entry {\n+\t__u32 gsi;\n+\t__u32 type;\n+\t__u32 flags;\n+\t__u32 pad;\n+\tunion {\n+\t\tstruct kvm_irq_routing_irqchip irqchip;\n+\t\tstruct kvm_irq_routing_msi msi;\n+\t\t__u32 pad[8];\n+\t} u;\n+};\n+\n+struct kvm_irq_routing {\n+\t__u32 nr;\n+\t__u32 flags;\n+\tstruct kvm_irq_routing_entry entries[0];\n+};\n+\n+#endif\n+#define KVM_CAP_S390_PSW 42\n+\n+#ifdef KVM_CAP_MCE\n+/* x86 MCE */\n+struct kvm_x86_mce {\n+\t__u64 status;\n+\t__u64 addr;\n+\t__u64 misc;\n+\t__u64 mcg_status;\n+\t__u8 bank;\n+\t__u8 pad1[7];\n+\t__u64 pad2[3];\n+};\n+#endif\n+\n+#define KVM_IRQFD_FLAG_DEASSIGN (1 << 0)\n+\n+struct kvm_irqfd {\n+\t__u32 fd;\n+\t__u32 gsi;\n+\t__u32 flags;\n+\t__u8  pad[20];\n+};\n+\n+struct kvm_clock_data {\n+\t__u64 clock;\n+\t__u32 flags;\n+\t__u32 pad[9];\n+};\n+\n+/*\n+ * ioctls for VM fds\n+ */\n+#define KVM_SET_MEMORY_REGION     _IOW(KVMIO, 0x40, struct kvm_memory_region)\n+/*\n+ * KVM_CREATE_VCPU receives as a parameter the vcpu slot, and returns\n+ * a vcpu fd.\n+ */\n+#define KVM_CREATE_VCPU           _IO(KVMIO,  0x41)\n+#define KVM_GET_DIRTY_LOG         _IOW(KVMIO, 0x42, struct kvm_dirty_log)\n+#define KVM_SET_MEMORY_ALIAS      _IOW(KVMIO, 0x43, struct kvm_memory_alias)\n+#define KVM_SET_NR_MMU_PAGES      _IO(KVMIO, 0x44)\n+#define KVM_GET_NR_MMU_PAGES      _IO(KVMIO, 0x45)\n+#define KVM_SET_USER_MEMORY_REGION _IOW(KVMIO, 0x46,\\\n+\t\t\t\t\tstruct kvm_userspace_memory_region)\n+#define KVM_SET_TSS_ADDR          _IO(KVMIO, 0x47)\n+#define KVM_SET_IDENTITY_MAP_ADDR _IOW(KVMIO, 0x48, __u64)\n+/* Device model IOC */\n+#define KVM_CREATE_IRQCHIP\t  _IO(KVMIO,  0x60)\n+#define KVM_IRQ_LINE\t\t  _IOW(KVMIO, 0x61, struct kvm_irq_level)\n+#define KVM_GET_IRQCHIP\t\t  _IOWR(KVMIO, 0x62, struct kvm_irqchip)\n+#define KVM_SET_IRQCHIP\t\t  _IOR(KVMIO,  0x63, struct kvm_irqchip)\n+#define KVM_CREATE_PIT\t\t  _IO(KVMIO,  0x64)\n+#define KVM_GET_PIT\t\t  _IOWR(KVMIO, 0x65, struct kvm_pit_state)\n+#define KVM_SET_PIT\t\t  _IOR(KVMIO,  0x66, struct kvm_pit_state)\n+#define KVM_IRQ_LINE_STATUS\t  _IOWR(KVMIO, 0x67, struct kvm_irq_level)\n+#define KVM_REGISTER_COALESCED_MMIO \\\n+\t\t\t_IOW(KVMIO,  0x67, struct kvm_coalesced_mmio_zone)\n+#define KVM_UNREGISTER_COALESCED_MMIO \\\n+\t\t\t_IOW(KVMIO,  0x68, struct kvm_coalesced_mmio_zone)\n+#define KVM_ASSIGN_PCI_DEVICE _IOR(KVMIO, 0x69, \\\n+\t\t\t\t   struct kvm_assigned_pci_dev)\n+#define KVM_SET_GSI_ROUTING       _IOW(KVMIO, 0x6a, struct kvm_irq_routing)\n+/* deprecated, replaced by KVM_ASSIGN_DEV_IRQ */\n+#define KVM_ASSIGN_IRQ _IOR(KVMIO, 0x70, \\\n+\t\t\t    struct kvm_assigned_irq)\n+#define KVM_ASSIGN_DEV_IRQ        _IOW(KVMIO, 0x70, struct kvm_assigned_irq)\n+#define KVM_REINJECT_CONTROL      _IO(KVMIO, 0x71)\n+#define KVM_DEASSIGN_PCI_DEVICE _IOW(KVMIO, 0x72, \\\n+\t\t\t\t     struct kvm_assigned_pci_dev)\n+#define KVM_ASSIGN_SET_MSIX_NR \\\n+\t\t\t_IOW(KVMIO, 0x73, struct kvm_assigned_msix_nr)\n+#define KVM_ASSIGN_SET_MSIX_ENTRY \\\n+\t\t\t_IOW(KVMIO, 0x74, struct kvm_assigned_msix_entry)\n+#define KVM_DEASSIGN_DEV_IRQ       _IOW(KVMIO, 0x75, struct kvm_assigned_irq)\n+#define KVM_IRQFD                  _IOW(KVMIO, 0x76, struct kvm_irqfd)\n+#define KVM_CREATE_PIT2\t\t   _IOW(KVMIO, 0x77, struct kvm_pit_config)\n+#define KVM_SET_BOOT_CPU_ID        _IO(KVMIO, 0x78)\n+#define KVM_IOEVENTFD             _IOW(KVMIO, 0x79, struct kvm_ioeventfd)\n+#define KVM_SET_CLOCK             _IOW(KVMIO, 0x7b, struct kvm_clock_data)\n+#define KVM_GET_CLOCK             _IOR(KVMIO, 0x7c, struct kvm_clock_data)\n+\n+/*\n+ * ioctls for vcpu fds\n+ */\n+#define KVM_RUN                   _IO(KVMIO,   0x80)\n+#define KVM_GET_REGS              _IOR(KVMIO,  0x81, struct kvm_regs)\n+#define KVM_SET_REGS              _IOW(KVMIO,  0x82, struct kvm_regs)\n+#define KVM_GET_SREGS             _IOR(KVMIO,  0x83, struct kvm_sregs)\n+#define KVM_SET_SREGS             _IOW(KVMIO,  0x84, struct kvm_sregs)\n+#define KVM_TRANSLATE             _IOWR(KVMIO, 0x85, struct kvm_translation)\n+#define KVM_INTERRUPT             _IOW(KVMIO,  0x86, struct kvm_interrupt)\n+/* KVM_DEBUG_GUEST is no longer supported, use KVM_SET_GUEST_DEBUG instead */\n+#define KVM_DEBUG_GUEST           __KVM_DEPRECATED_DEBUG_GUEST\n+#define KVM_GET_MSRS              _IOWR(KVMIO, 0x88, struct kvm_msrs)\n+#define KVM_SET_MSRS              _IOW(KVMIO,  0x89, struct kvm_msrs)\n+#define KVM_SET_CPUID             _IOW(KVMIO,  0x8a, struct kvm_cpuid)\n+#define KVM_SET_SIGNAL_MASK       _IOW(KVMIO,  0x8b, struct kvm_signal_mask)\n+#define KVM_GET_FPU               _IOR(KVMIO,  0x8c, struct kvm_fpu)\n+#define KVM_SET_FPU               _IOW(KVMIO,  0x8d, struct kvm_fpu)\n+#define KVM_GET_LAPIC             _IOR(KVMIO,  0x8e, struct kvm_lapic_state)\n+#define KVM_SET_LAPIC             _IOW(KVMIO,  0x8f, struct kvm_lapic_state)\n+#define KVM_SET_CPUID2            _IOW(KVMIO,  0x90, struct kvm_cpuid2)\n+#define KVM_GET_CPUID2            _IOWR(KVMIO, 0x91, struct kvm_cpuid2)\n+/* Available with KVM_CAP_VAPIC */\n+#define KVM_TPR_ACCESS_REPORTING  _IOWR(KVMIO,  0x92, struct kvm_tpr_access_ctl)\n+/* Available with KVM_CAP_VAPIC */\n+#define KVM_SET_VAPIC_ADDR        _IOW(KVMIO,  0x93, struct kvm_vapic_addr)\n+/* valid for virtual machine (for floating interrupt)_and_ vcpu */\n+#define KVM_S390_INTERRUPT        _IOW(KVMIO,  0x94, struct kvm_s390_interrupt)\n+/* store status for s390 */\n+#define KVM_S390_STORE_STATUS_NOADDR    (-1ul)\n+#define KVM_S390_STORE_STATUS_PREFIXED  (-2ul)\n+#define KVM_S390_STORE_STATUS\t  _IOW(KVMIO,  0x95, unsigned long)\n+/* initial ipl psw for s390 */\n+#define KVM_S390_SET_INITIAL_PSW  _IOW(KVMIO,  0x96, struct kvm_s390_psw)\n+/* initial reset for s390 */\n+#define KVM_S390_INITIAL_RESET    _IO(KVMIO,  0x97)\n+#define KVM_GET_MP_STATE          _IOR(KVMIO,  0x98, struct kvm_mp_state)\n+#define KVM_SET_MP_STATE          _IOW(KVMIO,  0x99, struct kvm_mp_state)\n+/* Available with KVM_CAP_NMI */\n+#define KVM_NMI                   _IO(KVMIO,  0x9a)\n+/* Available with KVM_CAP_SET_GUEST_DEBUG */\n+#define KVM_SET_GUEST_DEBUG       _IOW(KVMIO,  0x9b, struct kvm_guest_debug)\n+/* MCE for x86 */\n+#define KVM_X86_SETUP_MCE         _IOW(KVMIO,  0x9c, __u64)\n+#define KVM_X86_GET_MCE_CAP_SUPPORTED _IOR(KVMIO,  0x9d, __u64)\n+#define KVM_X86_SET_MCE           _IOW(KVMIO,  0x9e, struct kvm_x86_mce)\n+\n+/*\n+ * Deprecated interfaces\n+ */\n+struct kvm_breakpoint {\n+\t__u32 enabled;\n+\t__u32 padding;\n+\t__u64 address;\n+};\n+\n+struct kvm_debug_guest {\n+\t__u32 enabled;\n+\t__u32 pad;\n+\tstruct kvm_breakpoint breakpoints[4];\n+\t__u32 singlestep;\n+};\n+\n+#define __KVM_DEPRECATED_DEBUG_GUEST _IOW(KVMIO,  0x87, struct kvm_debug_guest)\n+\n+#define KVM_IA64_VCPU_GET_STACK   _IOR(KVMIO,  0x9a, void *)\n+#define KVM_IA64_VCPU_SET_STACK   _IOW(KVMIO,  0x9b, void *)\n+\n+#define KVM_GET_PIT2   _IOR(KVMIO,   0x9f, struct kvm_pit_state2)\n+#define KVM_SET_PIT2   _IOW(KVMIO,   0xa0, struct kvm_pit_state2)\n+\n+#define KVM_TRC_INJ_VIRQ         (KVM_TRC_HANDLER + 0x02)\n+#define KVM_TRC_REDELIVER_EVT    (KVM_TRC_HANDLER + 0x03)\n+#define KVM_TRC_PEND_INTR        (KVM_TRC_HANDLER + 0x04)\n+#define KVM_TRC_IO_READ          (KVM_TRC_HANDLER + 0x05)\n+#define KVM_TRC_IO_WRITE         (KVM_TRC_HANDLER + 0x06)\n+#define KVM_TRC_CR_READ          (KVM_TRC_HANDLER + 0x07)\n+#define KVM_TRC_CR_WRITE         (KVM_TRC_HANDLER + 0x08)\n+#define KVM_TRC_DR_READ          (KVM_TRC_HANDLER + 0x09)\n+#define KVM_TRC_DR_WRITE         (KVM_TRC_HANDLER + 0x0A)\n+#define KVM_TRC_MSR_READ         (KVM_TRC_HANDLER + 0x0B)\n+#define KVM_TRC_MSR_WRITE        (KVM_TRC_HANDLER + 0x0C)\n+#define KVM_TRC_CPUID            (KVM_TRC_HANDLER + 0x0D)\n+#define KVM_TRC_INTR             (KVM_TRC_HANDLER + 0x0E)\n+#define KVM_TRC_NMI              (KVM_TRC_HANDLER + 0x0F)\n+#define KVM_TRC_VMMCALL          (KVM_TRC_HANDLER + 0x10)\n+#define KVM_TRC_HLT              (KVM_TRC_HANDLER + 0x11)\n+#define KVM_TRC_CLTS             (KVM_TRC_HANDLER + 0x12)\n+#define KVM_TRC_LMSW             (KVM_TRC_HANDLER + 0x13)\n+#define KVM_TRC_APIC_ACCESS      (KVM_TRC_HANDLER + 0x14)\n+#define KVM_TRC_TDP_FAULT        (KVM_TRC_HANDLER + 0x15)\n+#define KVM_TRC_GTLB_WRITE       (KVM_TRC_HANDLER + 0x16)\n+#define KVM_TRC_STLB_WRITE       (KVM_TRC_HANDLER + 0x17)\n+#define KVM_TRC_STLB_INVAL       (KVM_TRC_HANDLER + 0x18)\n+#define KVM_TRC_PPC_INSTR        (KVM_TRC_HANDLER + 0x19)\n+\n+#define KVM_DEV_ASSIGN_ENABLE_IOMMU\t(1 << 0)\n+\n+struct kvm_assigned_pci_dev {\n+\t__u32 assigned_dev_id;\n+\t__u32 busnr;\n+\t__u32 devfn;\n+\t__u32 flags;\n+\tunion {\n+\t\t__u32 reserved[12];\n+\t};\n+};\n+\n+#define KVM_DEV_IRQ_HOST_INTX    (1 << 0)\n+#define KVM_DEV_IRQ_HOST_MSI     (1 << 1)\n+#define KVM_DEV_IRQ_HOST_MSIX    (1 << 2)\n+\n+#define KVM_DEV_IRQ_GUEST_INTX   (1 << 8)\n+#define KVM_DEV_IRQ_GUEST_MSI    (1 << 9)\n+#define KVM_DEV_IRQ_GUEST_MSIX   (1 << 10)\n+\n+#define KVM_DEV_IRQ_HOST_MASK\t 0x00ff\n+#define KVM_DEV_IRQ_GUEST_MASK   0xff00\n+\n+struct kvm_assigned_irq {\n+\t__u32 assigned_dev_id;\n+\t__u32 host_irq;\n+\t__u32 guest_irq;\n+\t__u32 flags;\n+\tunion {\n+\t\tstruct {\n+\t\t\t__u32 addr_lo;\n+\t\t\t__u32 addr_hi;\n+\t\t\t__u32 data;\n+\t\t} guest_msi;\n+\t\t__u32 reserved[12];\n+\t};\n+};\n+\n+\n+struct kvm_assigned_msix_nr {\n+\t__u32 assigned_dev_id;\n+\t__u16 entry_nr;\n+\t__u16 padding;\n+};\n+\n+#define KVM_MAX_MSIX_PER_DEV\t\t256\n+struct kvm_assigned_msix_entry {\n+\t__u32 assigned_dev_id;\n+\t__u32 gsi;\n+\t__u16 entry; /* The index of entry in the MSI-X table */\n+\t__u16 padding[3];\n+};\n+\n+#endif\n"", ""config.h"": ""@@ -1,3 +1,4 @@\n /* x86-specific configuration */\n #include \""android/config/config.h\""\n #define TARGET_I386 1\n+#define CONFIG_KVM  1\n"", ""kvm-android.c"": ""@@ -0,0 +1,62 @@\n+#include <unistd.h>\n+#include <string.h>\n+#include <sys/utsname.h>\n+#include \""android/utils/debug.h\""\n+\n+#define D(...) VERBOSE_PRINT(init,__VA_ARGS__)\n+\n+/* A simple routine used to check that we can run the program under KVM.\n+ * We simply want to ensure that the emulator binary and the kernel have the\n+ * same endianess.\n+ *\n+ * A 32-bit executable cannot use the 64-bit KVM interface, even to run a 32-bit guest.\n+ */\n+\n+#ifndef __linux__\n+#error \""This file should only be compiled under linux\""\n+#endif\n+\n+int\n+kvm_check_allowed(void)\n+{\n+    /* sizeof(void*) is enough to give us the program's bitness */\n+    const int isProgram64bits = (sizeof(void*) == 8);\n+    int isKernel64bits = 0;\n+    struct utsname utn;\n+\n+    /* Is there a /dev/kvm device file here? */\n+    if (access(\""/dev/kvm\"",F_OK)) {\n+        /* no need to print a warning here */\n+        D(\""No kvm device file detected\"");\n+        return 0;\n+    }\n+\n+    /* Can we access it? */\n+    if (access(\""/dev/kvm\"",R_OK)) {\n+        D(\""KVM device file is not readable for this user.\"");\n+        return 0;\n+    }\n+\n+    /* Determine kernel endianess */\n+    memset(&utn,0,sizeof(utn));\n+    uname(&utn);\n+    D(\""Kernel machine type: %s\"", utn.machine);\n+    if (strcmp(utn.machine,\""x86_64\"") == 0)\n+        isKernel64bits = 1;\n+    else if (strcmp(utn.machine,\""amd64\"") == 0)\n+        isKernel64bits = 1;\n+\n+\n+    if (isProgram64bits != isKernel64bits) {\n+        if (isProgram64bits) {\n+            D(\""kvm disabled (64-bit emulator and 32-bit kernel)\"");\n+        } else {\n+            D(\""kvm disabled (32-bit emulator and 64-bit kernel)\"");\n+        }\n+        return 0;\n+    }\n+\n+    D(\""KVM mode auto-enabled!\"");\n+    return 1;\n+}\n+\n"", ""kvm-android.h"": ""@@ -0,0 +1,7 @@\n+#ifndef KVM_ANDROID_H\n+#define KVM_ANDROID_H\n+\n+/* Returns 1 if we can use /dev/kvm on this machine */\n+extern int kvm_check_allowed(void);\n+\n+#endif /* KVM_ANDROID_H */\n"", ""qemu-options.hx"": ""@@ -1350,6 +1350,8 @@ ETEXI\n #ifdef CONFIG_KVM\n DEF(\""enable-kvm\"", 0, QEMU_OPTION_enable_kvm, \\\n     \""-enable-kvm     enable KVM full virtualization support\\n\"")\n+DEF(\""disable-kvm\"", 0, QEMU_OPTION_disable_kvm, \\\n+    \""-disable-kvm    disable KVM full virtualization support\\n\"")\n #endif\n STEXI\n @item -enable-kvm\n"", ""kvm.c"": ""@@ -16,6 +16,8 @@\n #include <sys/ioctl.h>\n #include <sys/mman.h>\n \n+#undef __user\n+#define __xuser  /* nothing */\n #include <linux/kvm.h>\n \n #include \""qemu-common.h\""\n@@ -117,6 +119,10 @@ uint32_t kvm_arch_get_supported_cpuid(CPUState *env, uint32_t function, int reg)\n \n #endif\n \n+#ifndef KVM_MP_STATE_RUNNABLE\n+#define KVM_MP_STATE_RUNNABLE 0\n+#endif\n+\n int kvm_arch_init_vcpu(CPUState *env)\n {\n     struct {\n"", ""vl-android.c"": ""@@ -195,6 +195,9 @@\n #include \""audio/audio.h\""\n #include \""migration.h\""\n #include \""kvm.h\""\n+#ifdef CONFIG_KVM\n+#include \""kvm-android.h\""\n+#endif\n #include \""balloon.h\""\n #include \""android/hw-lcd.h\""\n #include \""android/boot-properties.h\""\n@@ -4047,6 +4050,11 @@ int main(int argc, char **argv, char **envp)\n     android_hw_control_init();\n     android_net_pipes_init();\n \n+#ifdef CONFIG_KVM\n+    /* By default, force auto-detection for kvm */\n+    kvm_allowed = -1;\n+#endif\n+\n     optind = 1;\n     for(;;) {\n         if (optind >= argc)\n@@ -4524,16 +4532,14 @@ int main(int argc, char **argv, char **envp)\n                 kqemu_allowed = 2;\n                 break;\n #endif\n-#ifdef TARGET_I386\n #ifdef CONFIG_KVM\n             case QEMU_OPTION_enable_kvm:\n                 kvm_allowed = 1;\n-#ifdef CONFIG_KQEMU\n-                kqemu_allowed = 0;\n-#endif\n                 break;\n-#endif\n-#endif  /* TARGET_I386 */\n+            case QEMU_OPTION_disable_kvm:\n+                kvm_allowed = 0;\n+                break;\n+#endif /* CONFIG_KVM */\n             case QEMU_OPTION_usb:\n                 usb_enabled = 1;\n                 break;\n@@ -5282,6 +5288,12 @@ int main(int argc, char **argv, char **envp)\n     serial_hds_add_at(1, \""android-qemud\"");\n     stralloc_add_str(kernel_params, \"" android.qemud=ttyS1\"");\n \n+#if defined(CONFIG_KVM)\n+    if (kvm_allowed < 0) {\n+        kvm_allowed = kvm_check_allowed();\n+    }\n+#endif\n+\n #if defined(CONFIG_KVM) && defined(CONFIG_KQEMU)\n     if (kvm_allowed && kqemu_allowed) {\n         PANIC(\n""}","feature,build 
"
20583,Xavier Ducrohet,Better support for 64-bit clearsilver build.,"['cs/Android.mk', 'util/Android.mk', 'cgi/Android.mk', 'java-jni/Android.mk']","Better support for 64-bit clearsilver build.

This patch ensures that ClearSilver is built as 64-bit even if a 32-bit
host toolchain is used by default (e.g. when building the Linux SDK).

Change-Id: I49f9440906af27669074a3f6f12eddb6ac8b0550",https://android-review.googlesource.com/c/20583,"bug,feature 
","bug,resource",Resource;,"{""Android.mk"": ""@@ -20,6 +20,10 @@ LOCAL_CFLAGS := -fPIC\n # This forces a 64-bit build for Java6\n LOCAL_CFLAGS += -m64\n LOCAL_LDFLAGS += -m64\n+# We use the host compilers because the Linux SDK build\n+# uses a 32-bit toolchain that can't handle -m64\n+LOCAL_CC := $(CC)\n+LOCAL_CXX := $(CXX)\n \n LOCAL_NO_DEFAULT_COMPILER_FLAGS := true\n \n""}","feature 
"
20172,Benoit Goby,usb: host: tegra: Fix enumeration after lp0,['drivers/usb/host/ehci-tegra.c'],"usb: host: tegra: Fix enumeration after lp0

Fix enumeration when a device is plugged while the host is in lp0 state.

Change-Id: Idb491f347172daac8a5603ed098b422b15cc534e
Signed-off-by: Benoit Goby <benoit@android.com>",https://android-review.googlesource.com/c/20172,"bug 
",bug,Bug;,"{""ehci-tegra.c"": ""@@ -331,6 +331,7 @@ static int tegra_usb_resume(struct usb_hcd *hcd)\n \treturn 0;\n \n restart:\n+\tmsleep(1);\n \ttegra_ehci_restart(hcd);\n \treturn 0;\n }\n""}","feature 
"
22202,Haris Peco,Drop-Down list for example projects looks strange on Linux (Project Wizard),['eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/wizards/newproject/NewProjectCreationPage.java'],"Drop-Down list for example projects looks strange on Linux (Project Wizard)

See http://code.google.com/p/android/issues/detail?id=15529

Change-Id: If69ae23c3949a6c871c4d6dd451011e7c0ba1656",https://android-review.googlesource.com/c/22202,"bug
",bug,Others;,"{""NewProjectCreationPage.java"": ""@@ -77,6 +77,9 @@ import java.io.File;\n import java.io.FileFilter;\n import java.net.URI;\n import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.TreeSet;\n import java.util.regex.Pattern;\n \n /**\n@@ -532,7 +535,11 @@ public class NewProjectCreationPage extends WizardPage {\n \n         new Label(samples_group, SWT.NONE).setText(\""Samples:\"");\n \n-        mSamplesCombo = new Combo(samples_group, SWT.DROP_DOWN | SWT.READ_ONLY);\n+        if (Platform.getWS().equals(Platform.WS_GTK)) {\n+            mSamplesCombo = new Combo(samples_group, SWT.SIMPLE | SWT.READ_ONLY);\n+        } else {\n+            mSamplesCombo = new Combo(samples_group, SWT.DROP_DOWN | SWT.READ_ONLY);\n+        }\n         mSamplesCombo.setEnabled(false);\n         mSamplesCombo.select(0);\n         mSamplesCombo.setLayoutData(new GridData(GridData.FILL_HORIZONTAL));\n@@ -1208,6 +1215,7 @@ public class NewProjectCreationPage extends WizardPage {\n             int selIndex = 0;\n             int i = 0;\n             int n = samplesRootPath.length();\n+            Set<String> paths = new TreeSet<String>();\n             for (String path : mSamplesPaths) {\n                 if (path.length() > n) {\n                     path = path.substring(n);\n@@ -1224,10 +1232,10 @@ public class NewProjectCreationPage extends WizardPage {\n                     selIndex = i;\n                 }\n \n-                mSamplesCombo.add(path);\n+                paths.add(path);\n                 i++;\n             }\n-\n+            mSamplesCombo.setItems(paths.toArray(new String[0]));\n             mSamplesCombo.select(selIndex);\n \n         } else {\n""}","bug 
"
22206,Brian Muramatsu,Fix WifiInfoTest,['tests/tests/net/src/android/net/wifi/cts/WifiInfoTest.java'],"Fix WifiInfoTest

Do not listen to supplicant state change for wifi disable action,
instead depend on wifi state changed action

Bug: 4242273
Change-Id: Ie53ff42d5e51bbc9f28d93a435fa3315611d342e",https://android-review.googlesource.com/c/22206,"bug, test 
","bug,test",Bug;Deprecat;Test;,"{""WifiInfoTest.java"": ""@@ -54,7 +54,7 @@ public class WifiInfoTest extends AndroidTestCase {\n         @Override\n         public void onReceive(Context context, Intent intent) {\n             final String action = intent.getAction();\n-            if (action.equals(WifiManager.SUPPLICANT_STATE_CHANGED_ACTION)) {\n+            if (action.equals(WifiManager.WIFI_STATE_CHANGED_ACTION)) {\n                 synchronized (mMySync) {\n                     mMySync.expectedState = STATE_WIFI_CHANGED;\n                     mMySync.notify();\n@@ -68,14 +68,7 @@ public class WifiInfoTest extends AndroidTestCase {\n         super.setUp();\n         mMySync = new MySync();\n         mIntentFilter = new IntentFilter();\n-        mIntentFilter.addAction(WifiManager.NETWORK_STATE_CHANGED_ACTION);\n-        mIntentFilter.addAction(WifiManager.SCAN_RESULTS_AVAILABLE_ACTION);\n-        mIntentFilter.addAction(WifiManager.SUPPLICANT_CONNECTION_CHANGE_ACTION);\n-        mIntentFilter.addAction(WifiManager.SUPPLICANT_STATE_CHANGED_ACTION);\n         mIntentFilter.addAction(WifiManager.WIFI_STATE_CHANGED_ACTION);\n-        mIntentFilter.addAction(WifiManager.RSSI_CHANGED_ACTION);\n-        mIntentFilter.addAction(WifiManager.NETWORK_IDS_CHANGED_ACTION);\n-        mIntentFilter.addAction(WifiManager.ACTION_PICK_WIFI_NETWORK);\n \n         mContext.registerReceiver(mReceiver, mIntentFilter);\n         mWifiManager = (WifiManager) getContext().getSystemService(Context.WIFI_SERVICE);\n""}","test 
"
22857,David Turner,rebuild-all-prebuilt.sh: Fix --darwin-ssh with --arch=x86,['build/tools/rebuild-all-prebuilt.sh'],"rebuild-all-prebuilt.sh: Fix --darwin-ssh with --arch=x86

This patch allows one to use both --arch=x86 and --darwin-ssh=<host>
to remotely build the x86 prebuilt binaries on a Darwin machine
accessed remotely through ssh.

Change-Id: I1e375237912b1cd4767cc6db67d877ebf07b7b89",https://android-review.googlesource.com/c/22857,"bug
",bug,Bug;,"{""rebuild-all-prebuilt.sh"": ""@@ -180,8 +180,9 @@ if [ -n \""$DARWIN_SSH\"" ] ; then\n     copy_directory \""$ANDROID_NDK_ROOT/build\"" \""$TMPDARWIN/ndk/build\""\n     copy_file_list \""$ANDROID_NDK_ROOT\"" \""$TMPDARWIN/ndk\"" sources/android/libthread_db\n     copy_file_list \""$ANDROID_NDK_ROOT\"" \""$TMPDARWIN/ndk\"" \""$STLPORT_SUBDIR\""\n+    copy_file_list \""$ANDROID_NDK_ROOT\"" \""$TMPDARWIN/ndk\"" tests/build/prebuild-stlport\n     dump \""Prepare platforms files\""\n-    `dirname $0`/build-platforms.sh --no-samples --dst-dir=\""$TMPDARWIN/ndk\""\n+    `dirname $0`/build-platforms.sh --arch=$ARCH --no-samples --dst-dir=\""$TMPDARWIN/ndk\""\n     dump \""Copying NDK build scripts and platform files to remote...\""\n     (cd \""$TMPDARWIN\"" && tar czf - ndk) | (ssh $DARWIN_SSH tar xzf - -C $TMPREMOTE)\n     fail_panic \""Could not copy!\""\n@@ -191,7 +192,7 @@ if [ -n \""$DARWIN_SSH\"" ] ; then\n     (cd \""$SRC_DIR\"" && tar czf - .) | (ssh $DARWIN_SSH tar xzf - -C $TMPREMOTE/toolchain)\n     fail_panic \""Could not copy toolchain!\""\n     dump \""Running remote build...\""\n-    run ssh $DARWIN_SSH \""$TMPREMOTE/ndk/build/tools/rebuild-all-prebuilt.sh --toolchain-src-dir=$TMPREMOTE/toolchain --package-dir=$TMPREMOTE/packages\""\n+    run ssh $DARWIN_SSH \""$TMPREMOTE/ndk/build/tools/rebuild-all-prebuilt.sh --toolchain-src-dir=$TMPREMOTE/toolchain --package-dir=$TMPREMOTE/packages --arch=$ARCH\""\n     fail_panic \""Could not build prebuilt packages on Darwin!\""\n     dump \""Copying back Darwin prebuilt packages...\""\n     run scp $DARWIN_SSH:$TMPREMOTE/packages/*-darwin-* $PACKAGE_DIR/\n""}","resource 
"
20622,Benoit Goby,usb: gadget: tegra: Enable emc clock while usb is connected,['drivers/usb/gadget/fsl_tegra_udc.c'],"usb: gadget: tegra: Enable emc clock while usb is connected

Change-Id: Icb94c516a580e29b42b1899e622c9b91f8701dd2
Signed-off-by: Benoit Goby <benoit@android.com>",https://android-review.googlesource.com/c/20622,"feature 
",feature,Feature;,"{""fsl_tegra_udc.c"": ""@@ -15,6 +15,7 @@\n \n static struct tegra_usb_phy *phy;\n static struct clk *udc_clk;\n+static struct clk *emc_clk;\n static void *udc_base;\n \n int fsl_udc_clk_init(struct platform_device *pdev)\n@@ -33,6 +34,16 @@ int fsl_udc_clk_init(struct platform_device *pdev)\n \n \tclk_enable(udc_clk);\n \n+\temc_clk = clk_get(&pdev->dev, \""emc\"");\n+\tif (IS_ERR(emc_clk)) {\n+\t\tdev_err(&pdev->dev, \""Can't get emc clock\\n\"");\n+\t\terr = PTR_ERR(emc_clk);\n+\t\tgoto err_emc;\n+\t}\n+\n+\tclk_enable(emc_clk);\n+\tclk_set_rate(emc_clk, 240000000);\n+\n \t/* we have to remap the registers ourselves as fsl_udc does not\n \t * export them for us.\n \t */\n@@ -65,6 +76,9 @@ int fsl_udc_clk_init(struct platform_device *pdev)\n err1:\n \tiounmap(udc_base);\n err0:\n+\tclk_disable(emc_clk);\n+\tclk_put(emc_clk);\n+err_emc:\n \tclk_disable(udc_clk);\n \tclk_put(udc_clk);\n \treturn err;\n@@ -82,16 +96,21 @@ void fsl_udc_clk_release(void)\n \n \tclk_disable(udc_clk);\n \tclk_put(udc_clk);\n+\n+\tclk_disable(emc_clk);\n+\tclk_put(emc_clk);\n }\n \n void fsl_udc_clk_suspend(void)\n {\n \ttegra_usb_phy_power_off(phy);\n \tclk_disable(udc_clk);\n+\tclk_disable(emc_clk);\n }\n \n void fsl_udc_clk_resume(void)\n {\n+\tclk_enable(emc_clk);\n \tclk_enable(udc_clk);\n \ttegra_usb_phy_power_on(phy);\n }\n""}","feature 
"
10505,Dmitry Shmidt,[ARM] omap: mmc: Add option to change mmc device name,"['arch/arm/plat-omap/include/mach/mmc.h', 'arch/arm/mach-omap2/board-zoom2-wifi.c', 'arch/arm/mach-omap2/devices.c']","[ARM] omap: mmc: Add option to change mmc device name

Signed-off-by: Dmitry Shmidt <dimitrysh@android.com>
",https://android-review.googlesource.com/c/10505,"feature 
",feature,Feature;,"{""board-zoom2-wifi.c"": ""@@ -20,7 +20,8 @@ static int zoom2_wifi_cd = 0;\t\t/* WIFI virtual 'card detect' status */\n static void (*wifi_status_cb)(int card_present, void *dev_id);\n static void *wifi_status_cb_devid;\n \n-static int zoom2_wifi_status_register(void (*callback)(int card_present, void *dev_id), void *dev_id)\n+int zoom2_wifi_status_register(void (*callback)(int card_present,\n+\t\t\t\t\t\tvoid *dev_id), void *dev_id)\n {\n \tif (wifi_status_cb)\n \t\treturn -EAGAIN;\n@@ -29,7 +30,7 @@ static int zoom2_wifi_status_register(void (*callback)(int card_present, void *d\n \treturn 0;\n }\n \n-static unsigned int zoom2_wifi_status(struct device *dev)\n+int zoom2_wifi_status(int irq)\n {\n \treturn zoom2_wifi_cd;\n }\n"", ""devices.c"": ""@@ -633,7 +633,10 @@ void __init omap2_init_mmc(struct omap_mmc_platform_data **mmc_data,\n \t\t\tname = \""mmci-omap\"";\n \t\t} else {\n \t\t\tsize = HSMMC_SIZE;\n-\t\t\tname = \""mmci-omap-hs\"";\n+\t\t\tif (mmc_data[i]->name)\n+\t\t\t\tname = mmc_data[i]->name;\n+\t\t\telse\n+\t\t\t\tname = \""mmci-omap-hs\"";\n \t\t}\n \t\tomap_mmc_add(name, i, base, size, irq, mmc_data[i]);\n \t};\n"", ""mmc.h"": ""@@ -64,6 +64,9 @@ struct omap_mmc_platform_data {\n \n \tu64 dma_mask;\n \n+\t/* To identify device name */\n+\tchar * name;\n+\n \tstruct omap_mmc_slot_data {\n \n \t\t/* 4 wire signaling is optional, and is used for SD/SDIO/HSMMC;\n""}","feature 
"
16910,Jean-Baptiste Queru,"Revert ""Shutdown when capacity is 0% and no charging or when battery is dead""",['services/java/com/android/server/BatteryService.java'],"Revert ""Shutdown when capacity is 0% and no charging or when battery is dead""

This reverts commit fd04143a47770256dabcfa4d8447127b3ec8b2bf.",https://android-review.googlesource.com/c/16910,"bug
",bug,Others;,"{""BatteryService.java"": ""@@ -136,13 +136,7 @@ class BatteryService extends Binder {\n \n     final boolean isPowered() {\n         // assume we are powered if battery state is unknown so the \""stay on while plugged in\"" option will work.\n-        // Do not look at the plug status to check if we are powered.\n-        // Charger can be plugged but not charging because of i.e. USB suspend,\n-        // battery temperature reasons etc. We are powered only if battery is\n-        // being charged. This function fill return false if charger is\n-        // connected and battery is reported full.\n-        return (mBatteryStatus == BatteryManager.BATTERY_STATUS_CHARGING ||\n-                mBatteryStatus == BatteryManager.BATTERY_STATUS_UNKNOWN);\n+        return (mAcOnline || mUsbOnline || mBatteryStatus == BatteryManager.BATTERY_STATUS_UNKNOWN);\n     }\n \n     final boolean isPowered(int plugTypeSet) {\n@@ -154,13 +148,11 @@ class BatteryService extends Binder {\n         if (plugTypeSet == 0) {\n             return false;\n         }\n-\n-        // we are not powered when plug is connected and not charging\n         int plugTypeBit = 0;\n-        if (mAcOnline && mBatteryStatus == BatteryManager.BATTERY_STATUS_CHARGING) {\n+        if (mAcOnline) {\n             plugTypeBit |= BatteryManager.BATTERY_PLUGGED_AC;\n         }\n-        if (mUsbOnline && mBatteryStatus == BatteryManager.BATTERY_STATUS_CHARGING) {\n+        if (mUsbOnline) {\n             plugTypeBit |= BatteryManager.BATTERY_PLUGGED_USB;\n         }\n         return (plugTypeSet & plugTypeBit) != 0;\n@@ -191,11 +183,7 @@ class BatteryService extends Binder {\n     private final void shutdownIfNoPower() {\n         // shut down gracefully if our battery is critically low and we are not powered.\n         // wait until the system has booted before attempting to display the shutdown dialog.\n-        // Also shutdown if battery is reported to be 'dead' independent of\n-        // battery level and power supply.\n-        if (((mBatteryLevel == 0 && !isPowered()) ||\n-             mBatteryHealth == BatteryManager.BATTERY_HEALTH_DEAD) &&\n-            ActivityManagerNative.isSystemReady()) {\n+        if (mBatteryLevel == 0 && !isPowered() && ActivityManagerNative.isSystemReady()) {\n             Intent intent = new Intent(Intent.ACTION_REQUEST_SHUTDOWN);\n             intent.putExtra(Intent.EXTRA_KEY_CONFIRM, false);\n             intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);\n""}","bug 
"
9071,Jean-Baptiste Queru,Use static const variable for speed. Clarify a comment.,"['vm/analysis/CodeVerify.c', 'vm/analysis/DexVerify.c']","Clarify a few comments. Use static const variable for speed.

Fixes http://code.google.com/p/android/issues/detail?id=2088",https://android-review.googlesource.com/c/9071,"bug, refactor 
",bug,Bug;,"{""CodeVerify.c"": ""@@ -331,7 +331,7 @@ static bool isTypeWidthEqual1nr(RegType type1, RegType type2)\n  */\n static RegType primitiveTypeToRegType(PrimitiveType primType)\n {\n-    struct {\n+    static const struct {\n         RegType         regType;        /* type equivalent */\n         PrimitiveType   primType;       /* verification */\n     } convTab[] = {\n@@ -1326,7 +1326,7 @@ static ClassObject* getFieldClass(const Method* meth, const Field* field)\n  */\n \n /*\n- * Get the type of register N, verifying that the register is valid.\n+ * Get the type of register vscr, verifying that the register is valid.\n  *\n  * Sets \""*pOkay\"" to false if the register number is out of range.\n  */\n@@ -1424,8 +1424,8 @@ bail:\n }\n \n /*\n- * Set the type of register N, verifying that the register is valid.  If\n- * \""newType\"" is the \""Lo\"" part of a 64-bit value, register N+1 will be\n+ * Set the type of register vdst, verifying that the register is valid.  If\n+ * \""newType\"" is the \""Lo\"" part of a 64-bit value, register vdst+1 will be\n  * set to \""newType+1\"".\n  *\n  * Sets \""*pOkay\"" to false if the register number is out of range.\n@@ -3037,7 +3037,7 @@ static bool doCodeVerification(const Method* meth, InsnFlags* insnFlags,\n     if (DEAD_CODE_SCAN) {\n         /*\n          * Scan for dead code.  There's nothing \""evil\"" about dead code, but it\n-         * indicates a flaw somewhere down the line, possibly in the verifier.\n+         * indicates a flaw somewhere upstream, possibly in the verifier.\n          */\n         int deadStart = -1;\n         for (insnIdx = 0; insnIdx < insnsSize;\n"", ""DexVerify.c"": ""@@ -40,7 +40,7 @@ bool dvmVerificationStartup(void)\n }\n \n /*\n- * Initialize some things we need for verification.\n+ * Free up some things we needed for verification.\n  */\n void dvmVerificationShutdown(void)\n {\n""}","**refactor** 
"
13924,npelly,Bluetooth: Use non-flushable pb flag by default for ACL data on capable chipsets.,"['include/net/bluetooth/hci.h', 'include/net/bluetooth/hci_core.h', 'net/bluetooth/l2cap.c', 'include/net/bluetooth/l2cap.h', 'net/bluetooth/hci_core.c']","Bluetooth: Use non-flushable pb flag by default for ACL data on capable chipsets.

With Bluetooth 2.1 ACL packets can be flushable or non-flushable. This commit
makes ACL data packets non-flushable by default on compatible chipsets, and
adds the L2CAP_LM_FLUSHABLE socket option to explicitly request flushable ACL
data packets for a given L2CAP socket. This is useful for A2DP data which can
be safely discarded if it can not be delivered within a short time (while
other ACL data should not be discarded).

Note that making ACL data flushable has no effect unless the automatic flush
timeout for that ACL link is changed from its default of 0 (infinite).

Change-Id: Ie3d4befdeaefb8c979de7ae603ff5ec462b3483c
Signed-off-by: Nick Pelly <npelly@google.com>",https://android-review.googlesource.com/c/13924,"feature 
",feature,Feature;,"{""hci.h"": ""@@ -145,11 +145,14 @@ enum {\n \t\t\tEDR_ESCO_MASK)\n \n /* ACL flags */\n+#define ACL_START_NO_FLUSH\t0x00\n #define ACL_CONT\t\t0x01\n #define ACL_START\t\t0x02\n #define ACL_ACTIVE_BCAST\t0x04\n #define ACL_PICO_BCAST\t\t0x08\n \n+#define ACL_PB_MASK\t(ACL_CONT | ACL_START)\n+\n /* Baseband links */\n #define SCO_LINK\t0x00\n #define ACL_LINK\t0x01\n@@ -188,6 +191,7 @@ enum {\n #define LMP_EDR_ESCO_3M\t0x40\n #define LMP_EDR_3S_ESCO\t0x80\n \n+#define LMP_NO_FLUSH\t0x01\n #define LMP_SIMPLE_PAIR\t0x08\n \n /* Connection modes */\n"", ""hci_core.h"": ""@@ -479,6 +479,7 @@ void hci_conn_del_sysfs(struct hci_conn *conn);\n #define lmp_sniffsubr_capable(dev) ((dev)->features[5] & LMP_SNIFF_SUBR)\n #define lmp_esco_capable(dev)      ((dev)->features[3] & LMP_ESCO)\n #define lmp_ssp_capable(dev)       ((dev)->features[6] & LMP_SIMPLE_PAIR)\n+#define lmp_no_flush_capable(dev)  ((dev)->features[6] & LMP_NO_FLUSH)\n \n /* ----- HCI protocols ----- */\n struct hci_proto {\n"", ""l2cap.h"": ""@@ -70,6 +70,7 @@ struct l2cap_conninfo {\n #define L2CAP_LM_TRUSTED\t0x0008\n #define L2CAP_LM_RELIABLE\t0x0010\n #define L2CAP_LM_SECURE\t\t0x0020\n+#define L2CAP_LM_FLUSHABLE\t0x0040\n \n /* L2CAP command codes */\n #define L2CAP_COMMAND_REJ\t0x01\n@@ -316,6 +317,7 @@ struct l2cap_pinfo {\n \t__u8\t\tsec_level;\n \t__u8\t\trole_switch;\n \t__u8\t\tforce_reliable;\n+\t__u8\t\tflushable;\n \n \t__u8\t\tconf_req[64];\n \t__u8\t\tconf_len;\n"", ""hci_core.c"": ""@@ -1239,7 +1239,7 @@ int hci_send_acl(struct hci_conn *conn, struct sk_buff *skb, __u16 flags)\n \n \tskb->dev = (void *) hdev;\n \tbt_cb(skb)->pkt_type = HCI_ACLDATA_PKT;\n-\thci_add_acl_hdr(skb, conn->handle, flags | ACL_START);\n+\thci_add_acl_hdr(skb, conn->handle, flags);\n \n \tif (!(list = skb_shinfo(skb)->frag_list)) {\n \t\t/* Non fragmented */\n@@ -1256,12 +1256,14 @@ int hci_send_acl(struct hci_conn *conn, struct sk_buff *skb, __u16 flags)\n \t\tspin_lock_bh(&conn->data_q.lock);\n \n \t\t__skb_queue_tail(&conn->data_q, skb);\n+\t\tflags &= ~ACL_PB_MASK;\n+\t\tflags |= ACL_CONT;\n \t\tdo {\n \t\t\tskb = list; list = list->next;\n \n \t\t\tskb->dev = (void *) hdev;\n \t\t\tbt_cb(skb)->pkt_type = HCI_ACLDATA_PKT;\n-\t\t\thci_add_acl_hdr(skb, conn->handle, flags | ACL_CONT);\n+\t\t\thci_add_acl_hdr(skb, conn->handle, flags);\n \n \t\t\tBT_DBG(\""%s frag %p len %d\"", hdev->name, skb, skb->len);\n \n"", ""l2cap.c"": ""@@ -325,13 +325,19 @@ static inline u8 l2cap_get_ident(struct l2cap_conn *conn)\n static inline int l2cap_send_cmd(struct l2cap_conn *conn, u8 ident, u8 code, u16 len, void *data)\n {\n \tstruct sk_buff *skb = l2cap_build_cmd(conn, code, ident, len, data);\n+\tu8 flags;\n \n \tBT_DBG(\""code 0x%2.2x\"", code);\n \n \tif (!skb)\n \t\treturn -ENOMEM;\n \n-\treturn hci_send_acl(conn->hcon, skb, 0);\n+\tif (lmp_no_flush_capable(conn->hcon->hdev))\n+\t\tflags = ACL_START_NO_FLUSH;\n+\telse\n+\t\tflags = ACL_START;\n+\n+\treturn hci_send_acl(conn->hcon, skb, flags);\n }\n \n static inline int l2cap_send_sframe(struct l2cap_pinfo *pi, u16 control)\n@@ -770,6 +776,7 @@ static void l2cap_sock_init(struct sock *sk, struct sock *parent)\n \t\tpi->sec_level = l2cap_pi(parent)->sec_level;\n \t\tpi->role_switch = l2cap_pi(parent)->role_switch;\n \t\tpi->force_reliable = l2cap_pi(parent)->force_reliable;\n+\t\tpi->flushable = l2cap_pi(parent)->flushable;\n \t} else {\n \t\tpi->imtu = L2CAP_DEFAULT_MTU;\n \t\tpi->omtu = 0;\n@@ -778,6 +785,7 @@ static void l2cap_sock_init(struct sock *sk, struct sock *parent)\n \t\tpi->sec_level = BT_SECURITY_LOW;\n \t\tpi->role_switch = 0;\n \t\tpi->force_reliable = 0;\n+\t\tpi->flushable = 0;\n \t}\n \n \t/* Default config options */\n@@ -1258,11 +1266,18 @@ static void l2cap_drop_acked_frames(struct sock *sk)\n static inline int l2cap_do_send(struct sock *sk, struct sk_buff *skb)\n {\n \tstruct l2cap_pinfo *pi = l2cap_pi(sk);\n+\tstruct hci_conn *hcon = pi->conn->hcon;\n \tint err;\n+\tu16 flags;\n \n \tBT_DBG(\""sk %p, skb %p len %d\"", sk, skb, skb->len);\n \n-\terr = hci_send_acl(pi->conn->hcon, skb, 0);\n+\tif (lmp_no_flush_capable(hcon->hdev) && !l2cap_pi(sk)->flushable)\n+\t\tflags = ACL_START_NO_FLUSH;\n+\telse\n+\t\tflags = ACL_START;\n+\n+\terr = hci_send_acl(hcon, skb, flags);\n \tif (err < 0)\n \t\tkfree_skb(skb);\n \n@@ -1747,6 +1762,7 @@ static int l2cap_sock_setsockopt_old(struct socket *sock, int optname, char __us\n \n \t\tl2cap_pi(sk)->role_switch    = (opt & L2CAP_LM_MASTER);\n \t\tl2cap_pi(sk)->force_reliable = (opt & L2CAP_LM_RELIABLE);\n+\t\tl2cap_pi(sk)->flushable = (opt & L2CAP_LM_FLUSHABLE);\n \t\tbreak;\n \n \tdefault:\n@@ -1874,6 +1890,9 @@ static int l2cap_sock_getsockopt_old(struct socket *sock, int optname, char __us\n \t\tif (l2cap_pi(sk)->force_reliable)\n \t\t\topt |= L2CAP_LM_RELIABLE;\n \n+\t\tif (l2cap_pi(sk)->flushable)\n+\t\t\topt |= L2CAP_LM_FLUSHABLE;\n+\n \t\tif (put_user(opt, (u32 __user *) optval))\n \t\t\terr = -EFAULT;\n \t\tbreak;\n@@ -3801,7 +3820,7 @@ static int l2cap_recv_acldata(struct hci_conn *hcon, struct sk_buff *skb, u16 fl\n \n \tBT_DBG(\""conn %p len %d flags 0x%x\"", conn, skb->len, flags);\n \n-\tif (flags & ACL_START) {\n+\tif (!(flags & ACL_CONT)) {\n \t\tstruct l2cap_hdr *hdr;\n \t\tint len;\n \n""}","feature, bug 
"
14276,Garmin Android,Allow Am to start services,['cmds/am/src/com/android/commands/am/Am.java'],"Allow Am to start services

Change-Id: I31d066ae2c980cc293e55034446a63a0f42088ad",https://android-review.googlesource.com/c/14276,"feature 
",feature,Others;,"{""Am.java"": ""@@ -88,6 +88,8 @@ public class Am {\n \n         if (op.equals(\""start\"")) {\n             runStart();\n+        } else if (op.equals(\""start-service\"")) {\n+            runStartService();\n         } else if (op.equals(\""instrument\"")) {\n             runInstrument();\n         } else if (op.equals(\""broadcast\"")) {\n@@ -238,6 +240,19 @@ public class Am {\n         }\n     }\n \n+    private void runStartService() throws Exception {\n+        Intent intent = makeIntent();\n+\n+        if (intent != null) {\n+            System.out.println(\""Starting: \"" + intent);\n+            try {\n+                mAm.startService(null, intent, intent.getType());\n+            } catch (Exception e) {\n+                System.err.println(\""Error: \"" + e);\n+            }\n+        }\n+    }\n+\n     private void sendBroadcast() throws Exception {\n         Intent intent = makeIntent();\n         IntentReceiver receiver = new IntentReceiver();\n""}","feature 
"
19234,RaphaÃ«l Moll,Move WST doc to sdk/docs.,['docs/Notes_on_WST_StructuredDocument.txt'],"Move WST doc to sdk/docs.

Change-Id: I53d7838b557da43a9194ddb13ec1bcd0f1119a36",https://android-review.googlesource.com/c/19234,"resource 
",resource,Resource;,"{""Notes_on_WST_StructuredDocument.txt"": ""@@ -1,16 +1,18 @@\n Notes on WST StructuredDocument\n -------------------------------\n \n-Created: 2010/11/26\n+Created:    2010/11/26\n References: WST 3.1.x, Eclipse 3.5 Galileo\n \n-\n To manipulate XML documents in refactorings, we sometimes use the WST/SEE\n \""StructuredDocument\"" API. There isn't exactly a lot of documentation on\n this out there, so this is a short explanation of how it works, totally\n based on _empirical_ evidence. As such, it must be taken with a grain of salt.\n \n+Examples of usage can be found in\n+  sdk/eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/refactorings/\n \n+  \n 1- Get a document instance\n --------------------------\n \n""}","resource 
"
20260,Todd Poynor,NCT1008 temperature sensor driver,"['include/linux/nct1008.h', 'drivers/misc/nct1008.c']","NCT1008 temperature sensor driver

Replace the PM-only driver for NCT1008 with a new version written by
Varun Wadekar and Dmitriy Gruzman.  Add a callback to an alarm
function specified in the board platform data.

Change-Id: Ib429533930ee75af3402d24b0bc286da9f6ee67b
Signed-off-by: Todd Poynor <toddpoynor@google.com>",https://android-review.googlesource.com/c/20260,"**feature,deprecate** 
",feature;deprecat,Feature;,"{""nct1008.c"": ""@@ -1,139 +1,291 @@\n /*\n- * Copyright (C) 2010 Motorola, Inc.\n+ * drivers/misc/nct1008.c\n+ *\n+ * Driver for NCT1008, temperature monitoring device from ON Semiconductors\n+ *\n+ * Copyright (c) 2010, NVIDIA Corporation.\n  *\n  * This program is free software; you can redistribute it and/or modify\n- * it under the terms of the GNU General Public License version 2 as\n- * published by the Free Software Foundation.\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation; either version 2 of the License, or\n+ * (at your option) any later version.\n  *\n- * This program is distributed in the hope that it will be useful,\n- * but WITHOUT ANY WARRANTY; without even the implied warranty of\n- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n- * GNU General Public License for more details.\n+ * This program is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for\n+ * more details.\n  *\n- * You should have received a copy of the GNU General Public License\n- * along with this program; if not, write to the Free Software\n- * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA\n- * 02111-1307, USA\n+ * You should have received a copy of the GNU General Public License along\n+ * with this program; if not, write to the Free Software Foundation, Inc.,\n+ * 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n  */\n \n-#include <linux/i2c.h>\n-#include <linux/irq.h>\n-#include <linux/input.h>\n+\n #include <linux/interrupt.h>\n-#include <linux/nct1008.h>\n-#include <linux/platform_device.h>\n+#include <linux/mutex.h>\n+#include <linux/module.h>\n+#include <linux/i2c.h>\n #include <linux/slab.h>\n-#include <linux/types.h>\n-#include <linux/uaccess.h>\n+#include <linux/err.h>\n+#include <linux/gpio.h>\n+\n+#include <linux/nct1008.h>\n \n-#define NCT_BIT_CONFIG_RUN_STOP 6\n+#define DRIVER_NAME \""nct1008\""\n+\n+/* Register Addresses */\n+#define LOCAL_TEMP_RD\t\t\t0x00\n+#define STATUS_RD\t\t\t0x02\n+#define CONFIG_RD\t\t\t0x03\n+\n+#define CONFIG_WR\t\t\t0x09\n+#define CONV_RATE_WR\t\t\t0x0A\n+#define LOCAL_TEMP_HI_LIMIT_WR\t\t0x0B\n+#define EXT_TEMP_HI_LIMIT_HI_BYTE\t0x0D\n+#define OFFSET_WR\t\t\t0x11\n+#define EXT_THERM_LIMIT_WR\t\t0x19\n+#define LOCAL_THERM_LIMIT_WR\t\t0x20\n+#define THERM_HYSTERESIS_WR\t\t0x21\n+\n+/* Configuration Register Bits */\n+#define EXTENDED_RANGE_BIT\t\t(0x1 << 2)\n+#define THERM2_BIT\t\t\t(0x1 << 5)\n+#define STANDBY_BIT\t\t\t(0x1 << 6)\n+\n+/* Max Temperature Measurements */\n+#define EXTENDED_RANGE_OFFSET\t\t64U\n+#define STANDARD_RANGE_MAX\t\t127U\n+#define EXTENDED_RANGE_MAX\t\t(150U + EXTENDED_RANGE_OFFSET)\n \n struct nct1008_data {\n+\tstruct work_struct work;\n \tstruct i2c_client *client;\n+\tstruct mutex mutex;\n+\tu8 config;\n+\tvoid (*alarm_fn)(bool raised);\n };\n \n-static uint32_t nct1008_debug;\n-module_param_named(temp_debug, nct1008_debug, uint, 0664);\n+static void nct1008_enable(struct i2c_client *client)\n+{\n+\tstruct nct1008_data *data = i2c_get_clientdata(client);\n+\n+\ti2c_smbus_write_byte_data(client, CONFIG_WR,\n+\t\t\t\t  data->config & ~STANDBY_BIT);\n+}\n \n-static int nct1008_run(struct nct1008_data *nct, u8 run)\n+static void nct1008_disable(struct i2c_client *client)\n {\n-\tint err;\n-\tu8 rd_val;\n-\tu8 wr_val;\n+\tstruct nct1008_data *data = i2c_get_clientdata(client);\n \n-\trd_val = i2c_smbus_read_byte_data(nct->client, NCT_CONFIG_RD);\n-\tif (rd_val < 0) {\n-\t\tpr_err(\""%s: config register read fail: %d\\n\"", __func__, rd_val);\n-\t\treturn rd_val;\n+\ti2c_smbus_write_byte_data(client, CONFIG_WR,\n+\t\t\t\t  data->config | STANDBY_BIT);\n+}\n+\n+\n+static void nct1008_work_func(struct work_struct *work)\n+{\n+\tstruct nct1008_data *data = container_of(work, struct nct1008_data, work);\n+\tint irq = data->client->irq;\n+\n+\tmutex_lock(&data->mutex);\n+\n+\tif (data->alarm_fn) {\n+\t\t/* Therm2 line is active low */\n+\t\tdata->alarm_fn(!gpio_get_value(irq_to_gpio(irq)));\n \t}\n \n-\tif (nct1008_debug)\n-\t\tpr_info(\""%s: Previous config is 0x%02x\\n\"", __func__, rd_val);\n+\tmutex_unlock(&data->mutex);\n+}\n+\n+static irqreturn_t nct1008_irq(int irq, void *dev_id)\n+{\n+\tstruct nct1008_data *data = dev_id;\n+\tschedule_work(&data->work);\n+\n+\treturn IRQ_HANDLED;\n+}\n+\n+static inline u8 value_to_temperature(bool extended, u8 value)\n+{\n+\treturn (extended ? (u8)(value - EXTENDED_RANGE_OFFSET) : value);\n+}\n+\n+static inline u8 temperature_to_value(bool extended, u8 temp)\n+{\n+\treturn (extended ? (u8)(temp + EXTENDED_RANGE_OFFSET) : temp);\n+}\n+\n+static int __devinit nct1008_configure_sensor(struct nct1008_data* data)\n+{\n+\tstruct i2c_client *client           = data->client;\n+\tstruct nct1008_platform_data *pdata = client->dev.platform_data;\n+\tu8 value;\n+\tint err;\n+\n+\tif (!pdata || !pdata->supported_hwrev)\n+\t\treturn -ENODEV;\n+\n+\t/*\n+\t * Initial Configuration - device is placed in standby and\n+\t * ALERT/THERM2 pin is configured as THERM2\n+\t */\n+\tdata->config = value = pdata->ext_range ?\n+\t\t(STANDBY_BIT | THERM2_BIT | EXTENDED_RANGE_BIT) :\n+\t\t(STANDBY_BIT | THERM2_BIT);\n+\n+\terr = i2c_smbus_write_byte_data(client, CONFIG_WR, value);\n+\tif (err < 0)\n+\t\tgoto error;\n+\n+\t/* Temperature conversion rate */\n+\terr = i2c_smbus_write_byte_data(client, CONV_RATE_WR, pdata->conv_rate);\n+\tif (err < 0)\n+\t\tgoto error;\n \n-\tif (run)\n-\t\twr_val = rd_val & ~(1 << NCT_BIT_CONFIG_RUN_STOP);\n-\telse\n-\t\twr_val = rd_val | (1 << NCT_BIT_CONFIG_RUN_STOP);\n-\terr = i2c_smbus_write_byte_data(nct->client, NCT_CONFIG_WR, wr_val);\n-\tif (err)\n-\t\tpr_err(\""%s: setting RUN/STOP failed: %d\\n\"", __func__, err);\n+\t/* External temperature h/w shutdown limit */\n+\tvalue = temperature_to_value(pdata->ext_range, pdata->shutdown_ext_limit);\n+\terr = i2c_smbus_write_byte_data(client, EXT_THERM_LIMIT_WR, value);\n+\tif (err < 0)\n+\t\tgoto error;\n \n+\t/* Local temperature h/w shutdown limit */\n+\tvalue = temperature_to_value(pdata->ext_range, pdata->shutdown_local_limit);\n+\terr = i2c_smbus_write_byte_data(client, LOCAL_THERM_LIMIT_WR, value);\n+\tif (err < 0)\n+\t\tgoto error;\n+\n+\t/* External Temperature Throttling limit */\n+\tvalue = temperature_to_value(pdata->ext_range, pdata->throttling_ext_limit);\n+\terr = i2c_smbus_write_byte_data(client, EXT_TEMP_HI_LIMIT_HI_BYTE, value);\n+\tif (err < 0)\n+\t\tgoto error;\n+\n+\t/* Local Temperature Throttling limit */\n+\tvalue = pdata->ext_range ? EXTENDED_RANGE_MAX : STANDARD_RANGE_MAX;\n+\terr = i2c_smbus_write_byte_data(client, LOCAL_TEMP_HI_LIMIT_WR, value);\n+\tif (err < 0)\n+\t\tgoto error;\n+\n+\t/* Remote channel offset */\n+\terr = i2c_smbus_write_byte_data(client, OFFSET_WR, pdata->offset);\n+\tif (err < 0)\n+\t\tgoto error;\n+\n+\t/* THERM hysteresis */\n+\terr = i2c_smbus_write_byte_data(client, THERM_HYSTERESIS_WR, pdata->hysteresis);\n+\tif (err < 0)\n+\t\tgoto error;\n+\n+\tdata->alarm_fn = pdata->alarm_fn;\n+\treturn 0;\n+error:\n \treturn err;\n }\n \n-static int nct1008_probe(struct i2c_client *client,\n-\t\t\t const struct i2c_device_id *id)\n+static int __devinit nct1008_configure_irq(struct nct1008_data *data)\n+{\n+\tINIT_WORK(&data->work, nct1008_work_func);\n+\n+\treturn request_irq(data->client->irq, nct1008_irq, IRQF_TRIGGER_RISING |\n+\t\t\t\tIRQF_TRIGGER_FALLING, DRIVER_NAME, data);\n+}\n+\n+static int __devinit nct1008_probe(struct i2c_client *client, const struct i2c_device_id *id)\n {\n-\tstruct nct1008_data *nct;\n+\tstruct nct1008_data *data;\n+\tint err;\n+\n+\tdata = kzalloc(sizeof(struct nct1008_data), GFP_KERNEL);\n \n-\tnct = kzalloc(sizeof(struct nct1008_data), GFP_KERNEL);\n-\tif (nct == NULL)\n+\tif (!data)\n \t\treturn -ENOMEM;\n \n-\tnct->client = client;\n-\ti2c_set_clientdata(client, nct);\n+\tdata->client = client;\n+\ti2c_set_clientdata(client, data);\n+\tmutex_init(&data->mutex);\n+\n+\terr = nct1008_configure_sensor(data);\t/* sensor is in standby */\n+\tif (err < 0)\n+\t\tgoto error;\n+\n+\terr = nct1008_configure_irq(data);\n+\tif (err < 0)\n+\t\tgoto error;\n+\n+\tnct1008_enable(client);\t\t/* sensor is running */\n+\n+\tschedule_work(&data->work);\t\t/* check initial state */\n \n \treturn 0;\n+\n+error:\n+\tkfree(data);\n+\treturn err;\n }\n \n-static int nct1008_remove(struct i2c_client *client)\n+static int __devexit nct1008_remove(struct i2c_client *client)\n {\n-\tstruct nct1008_data *nct = i2c_get_clientdata(client);\n+\tstruct nct1008_data *data = i2c_get_clientdata(client);\n+\n+\tfree_irq(data->client->irq, data);\n+\tcancel_work_sync(&data->work);\n+\tkfree(data);\n \n-\tkfree(nct);\n \treturn 0;\n }\n \n-static int nct1008_suspend(struct i2c_client *client, pm_message_t mesg)\n+#ifdef CONFIG_PM\n+static int nct1008_suspend(struct i2c_client *client, pm_message_t state)\n {\n-\tstruct nct1008_data *nct = i2c_get_clientdata(client);\n-\n-\tif (nct1008_debug)\n-\t\tpr_info(\""%s: Suspending\\n\"", __func__);\n+\tdisable_irq(client->irq);\n+\tnct1008_disable(client);\n \n-\treturn nct1008_run(nct, 0);\n+\treturn 0;\n }\n \n static int nct1008_resume(struct i2c_client *client)\n {\n-\tstruct nct1008_data *nct = i2c_get_clientdata(client);\n+\tstruct nct1008_data *data = i2c_get_clientdata(client);\n \n-\tif (nct1008_debug)\n-\t\tpr_info(\""%s: Resuming\\n\"", __func__);\n+\tnct1008_enable(client);\n+\tenable_irq(client->irq);\n+\tschedule_work(&data->work);\n \n-\treturn nct1008_run(nct, 1);\n+\treturn 0;\n }\n+#endif\n \n static const struct i2c_device_id nct1008_id[] = {\n-\t{\""nct1008\"", 0},\n-\t{}\n+\t{ DRIVER_NAME, 0 },\n+\t{ }\n };\n+MODULE_DEVICE_TABLE(i2c, nct1008_id);\n \n-static struct i2c_driver nct1008_i2c_driver = {\n-\t.probe = nct1008_probe,\n-\t.remove = nct1008_remove,\n-\t.suspend = nct1008_suspend,\n-\t.resume = nct1008_resume,\n-\t.id_table = nct1008_id,\n+static struct i2c_driver nct1008_driver = {\n \t.driver = {\n-\t\t.name = \""nct1008\"",\n-\t\t.owner = THIS_MODULE,\n+\t\t.name\t= DRIVER_NAME,\n \t},\n+\t.probe\t\t= nct1008_probe,\n+\t.remove\t\t= __devexit_p(nct1008_remove),\n+\t.id_table\t= nct1008_id,\n+#ifdef CONFIG_PM\n+\t.suspend\t= nct1008_suspend,\n+\t.resume\t\t= nct1008_resume,\n+#endif\n };\n \n static int __init nct1008_init(void)\n {\n-\treturn i2c_add_driver(&nct1008_i2c_driver);\n+\treturn i2c_add_driver(&nct1008_driver);\n }\n \n static void __exit nct1008_exit(void)\n {\n-\ti2c_del_driver(&nct1008_i2c_driver);\n+\ti2c_del_driver(&nct1008_driver);\n }\n \n-module_init(nct1008_init);\n-module_exit(nct1008_exit);\n-\n MODULE_DESCRIPTION(\""Temperature sensor driver for OnSemi NCT1008\"");\n-MODULE_AUTHOR(\""Motorola\"");\n MODULE_LICENSE(\""GPL\"");\n+\n+module_init (nct1008_init);\n+module_exit (nct1008_exit);\n"", ""nct1008.h"": ""@@ -1,54 +1,40 @@\n /*\n- * Copyright (C) 2010 Motorola, Inc.\n+ * include/linux/nct1008.h\n+ *\n+ * NCT1008, temperature monitoring device from ON Semiconductors\n+ *\n+ * Copyright (c) 2010, NVIDIA Corporation.\n  *\n  * This program is free software; you can redistribute it and/or modify\n- * it under the terms of the GNU General Public License version 2 as\n- * published by the Free Software Foundation.\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation; either version 2 of the License, or\n+ * (at your option) any later version.\n  *\n- * This program is distributed in the hope that it will be useful,\n- * but WITHOUT ANY WARRANTY; without even the implied warranty of\n- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n- * GNU General Public License for more details.\n+ * This program is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for\n+ * more details.\n  *\n- * You should have received a copy of the GNU General Public License\n- * along with this program; if not, write to the Free Software\n- * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA\n- * 02111-1307, USA\n+ * You should have received a copy of the GNU General Public License along\n+ * with this program; if not, write to the Free Software Foundation, Inc.,\n+ * 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.\n  */\n \n-#ifndef _LINUX_NCT1008_H__\n-#define _LINUX_NCT1008_H__\n-\n-/* NCT1008 Read Only Registers */\n-#define NCT_LOCAL_TEMP_RD\t\t\t0x00\n-#define NCT_EXT_TEMP_HIGH_RD\t\t\t0x01\n-#define NCT_EXT_TEMP_LOW_RD\t\t\t0x10\n-#define NCT_STATUS_RD\t\t\t\t0x02\n-\n-/* NCT1008 Control Registers */\n-#define NCT_CONFIG_RD\t\t\t\t0x03\n-#define NCT_CONFIG_WR\t\t\t\t0x09\n-#define NCT_CONV_RATE_RD\t\t\t0x04\n-#define NCT_CONV_RATE_WR\t\t\t0x0A\n-\n-/* NCT1008 Limit Registers */\n-#define NCT_LOCAL_TEMP_HIGH_LIMIT_RD\t\t0x05\n-#define NCT_LOCAL_TEMP_LOW_LIMIT_RD\t\t0x06\n-#define NCT_LOCAL_TEMP_HIGH_LIMIT_WR\t\t0x0B\n-#define NCT_LOCAL_TEMP_LOW_LIMIT_WR\t\t0x0C\n+#ifndef _LINUX_NCT1008_H\n+#define _LINUX_NCT1008_H\n \n-#define NCT_EXT_TEMP_HIGH_LIMIT_HBYTE_RD\t0x07\n-#define NCT_EXT_TEMP_LOW_LIMIT_HBYTE_RD\t\t0x08\n-#define NCT_EXT_TEMP_HIGH_LIMIT_HBYTE_WR\t0x0D\n-#define NCT_EXT_TEMP_LOW_LIMIT_HBYTE_WR\t\t0x0E\n-#define NCT_EXT_TEMP_HIGH_LIMIT_LBYTE_RDWR\t0x13\n-#define NCT_EXT_TEMP_LOW_LIMIT_LBYTE_RDWR\t0x14\n-#define NCT_EXT_THERM_LIMIT\t\t\t0x19\n-#define NCT_LOCAL_THERM_LIMIT\t\t\t0x20\n+#include <linux/types.h>\n \n-#define NCT_EXT_TEMP_OFFSET_HIGH_RDWR\t\t0x11\n-#define NCT_EXT_TEMP_OFFSET_LOW_RDWR\t\t0x12\n-#define NCT_THERM_HYST\t\t\t\t0x21\n-#define NCT_CONSEC_ALERT\t\t\t0x22\n+struct nct1008_platform_data {\n+\tbool supported_hwrev;\n+\tbool ext_range;\n+\tu8 conv_rate;\n+\tu8 offset;\n+\tu8 hysteresis;\n+\tu8 shutdown_ext_limit;\n+\tu8 shutdown_local_limit;\n+\tu8 throttling_ext_limit;\n+\tvoid (*alarm_fn)(bool raised);\n+};\n \n-#endif\t/* _LINUX_NCT1008_H__ */\n+#endif /* _LINUX_NCT1008_H */\n""}","feature 
"
789,Evan JIANG,"Evan JIANG: Fix build bug when ""make sdk"" If you run ""make sdk"" under the root path, there would be an error: development/build/sdk.atree:122: couldn't locate source file: development/emulator/prebuilt/android-arm/kernel-qemu make: *** [out/host/darwin-x86/sdk/android-sdk_eng.Evan_mac-x86.zip] Error 44",['build/sdk.atree'],"Evan JIANG: Fix build bug when ""make sdk""
If you run ""make sdk"" under the root path, there would be an error:
development/build/sdk.atree:122: couldn't locate source file:
development/emulator/prebuilt/android-arm/kernel-qemu
make: *** [out/host/darwin-x86/sdk/android-sdk_eng.Evan_mac-x86.zip]
Error 44

I guess the kernel-qemu path is wrong in the sdk.atree file.
With this patch, ""make sdk"" works ok.",https://android-review.googlesource.com/c/789,"bug 
",bug,Bug;Resource;,"{""sdk.atree"": ""@@ -119,7 +119,7 @@ system.img tools/lib/images/system.img\n ramdisk.img tools/lib/images/ramdisk.img\n userdata.img tools/lib/images/userdata.img\n userdata.img tools/lib/images/userdata.img\n-development/emulator/prebuilt/android-arm/kernel-qemu tools/lib/images/kernel-qemu\n+prebuilt/android-arm/kernel/kernel-qemu tools/lib/images/kernel-qemu\n \n # emulator skins\n development/emulator/skins/HVGA   tools/lib/images/skins/HVGA\n""}","bug
"
22567,Mark Horn,Remove absolute paths from shared libraries,"['build/core/setup-toolchain.mk', 'build/core/default-build-commands.mk']","Remove absolute paths from shared libraries

Resulting binary for the target contained some shared
libraries which has an (incorrect) absolute path to the .so.

Change-Id: Ic04be5103b1fafed4aad19d50fc3e36bed020e40
Signed-off-by: Mark D Horn <mark.d.horn@intel.com>",https://android-review.googlesource.com/c/22567,"bug
",deprecat,Deprecat;Resource;,"{""default-build-commands.mk"": ""@@ -74,7 +74,7 @@ endef\n cmd-strip = $(TOOLCHAIN_PREFIX)strip --strip-unneeded $(call host-path,$1)\n \n TARGET_LIBGCC = $(shell $(TARGET_CC) -print-libgcc-file-name)\n-TARGET_LDLIBS := -Wl,-rpath-link=$(call host-path,$(SYSROOT)/usr/lib)\n+TARGET_LDLIBS := -lc -lm\n \n #\n # IMPORTANT: The following definitions must use lazy assignment because\n"", ""setup-toolchain.mk"": ""@@ -66,8 +66,7 @@ TARGET_CRTEND_O           := $(SYSROOT)/usr/lib/crtend_android.o\n TARGET_CRTBEGIN_SO_O := $(strip $(wildcard $(SYSROOT)/usr/lib/crtbegin_so.o))\n TARGET_CRTEND_SO_O   := $(strip $(wildcard $(SYSROOT)/usr/lib/crtend_so.o))\n \n-TARGET_PREBUILT_SHARED_LIBRARIES := libc libstdc++ libm\n-TARGET_PREBUILT_SHARED_LIBRARIES := $(TARGET_PREBUILT_SHARED_LIBRARIES:%=$(SYSROOT)/usr/lib/%.so)\n+TARGET_PREBUILT_SHARED_LIBRARIES :=\n \n # Define default values for TOOLCHAIN_NAME, this can be overriden in\n # the setup file.\n""}","bug, refactor 
"
12132,npelly,Bluetooth: Set general bonding security for ACL by default,['net/bluetooth/hci_conn.c'],"Bluetooth: Set general bonding security for ACL by default

This patch fixes double pairing issues with SSP.

It was observed that when pairing with SSP bluez asks confirmation
2 times.
http://www.spinics.net/lists/linux-bluetooth/msg02473.html

This also causes bug when we initiate SSP connection from Vista.

The reason is because bluetoothd does not store link keys since
ioctl  HCIGETAUTHINFO returns 0. Setting default general
bonding fixes these issues.

Signed-off-by: Andrei Emeltchenko <andrei.emeltchenko.news@gmail.com>",https://android-review.googlesource.com/c/12132,"bug, feature 
",bug,Bug;Resource;,"{""hci_conn.c"": ""@@ -213,6 +213,7 @@ struct hci_conn *hci_conn_add(struct hci_dev *hdev, int type, bdaddr_t *dst)\n \tconn->type  = type;\n \tconn->mode  = HCI_CM_ACTIVE;\n \tconn->state = BT_OPEN;\n+\tconn->auth_type = HCI_AT_GENERAL_BONDING;\n \n \tconn->power_save = 1;\n \n""}","bug 
"
17224,RaphaÃ«l Moll,GLE2: fix layout editor not properly closed when dirty.,"['eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/AndroidXmlEditor.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/ui/tree/PasteAction.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/AndroidTextEditor.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/MatchingStrategy.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/manifest/ManifestEditor.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/ui/tree/UiElementDetail.java']","GLE2: fix layout editor not properly closed when dirty.

The symptom was that once the layout editor had a modification
and was in the ""dirty"" mode, closing it would keep the model
around and re-opening would show the previous state. That was
a red herring.

The actual issue is that the undo begin/end wrapper methods
were calling getModelForEdit() without doing a proper
releaseFromEdit() call after the fact. Somewhere down in the
overly complex code that disposes the EditorPart there is
a test that would not purge the model if it is still locked.

The fix is thus in the begin/endUndoRecording of the base
AndroidXmlEditor.

This CL also cleans up some IFile usage; when fixing the
code above I noticed we can now get the model without
first getting an SSE internal document, instead we can use
the editor's IFile. However I doubt SSE for 3.3 would have
the API, I need to check that in another CL. Later, it's a P3.

Change-Id: I2437475dfeee9d6689b7b604782ae140d7aff1c3",https://android-review.googlesource.com/c/17224,"bug, refactor
","bug,refactor",Bug;,"{""AndroidTextEditor.java"": ""@@ -317,6 +317,20 @@ public abstract class AndroidTextEditor extends FormEditor implements IResourceC\n         super.init(site, editorInput);\n     }\n \n+    /**\n+     * Returns the {@link IFile} matching the editor's input or null.\n+     * <p/>\n+     * By construction, the editor input has to be an {@link IFileEditorInput} so it must\n+     * have an associated {@link IFile}. Null can only be returned if this editor has no\n+     * input somehow.\n+     */\n+    public IFile getFile() {\n+        if (getEditorInput() instanceof IFileEditorInput) {\n+            return ((IFileEditorInput) getEditorInput()).getFile();\n+        }\n+        return null;\n+    }\n+\n     /**\n      * Removes attached listeners.\n      *\n"", ""AndroidXmlEditor.java"": ""@@ -56,7 +56,6 @@ import org.eclipse.ui.forms.events.HyperlinkEvent;\n import org.eclipse.ui.forms.events.IHyperlinkListener;\n import org.eclipse.ui.forms.widgets.FormText;\n import org.eclipse.ui.internal.browser.WorkbenchBrowserSupport;\n-import org.eclipse.ui.part.FileEditorInput;\n import org.eclipse.ui.part.MultiPageEditorPart;\n import org.eclipse.ui.part.WorkbenchPart;\n import org.eclipse.wst.sse.core.StructuredModelManager;\n@@ -249,9 +248,8 @@ public abstract class AndroidXmlEditor extends FormEditor implements IResourceCh\n      */\n     protected void selectDefaultPage(String defaultPageId) {\n         if (defaultPageId == null) {\n-            if (getEditorInput() instanceof IFileEditorInput) {\n-                IFile file = ((IFileEditorInput) getEditorInput()).getFile();\n-\n+            IFile file = getInputFile();\n+            if (file != null) {\n                 QualifiedName qname = new QualifiedName(AdtPlugin.PLUGIN_ID,\n                         getClass().getSimpleName() + PREF_CURRENT_PAGE);\n                 String pageId;\n@@ -323,9 +321,8 @@ public abstract class AndroidXmlEditor extends FormEditor implements IResourceCh\n             return;\n         }\n \n-        if (getEditorInput() instanceof IFileEditorInput) {\n-            IFile file = ((IFileEditorInput) getEditorInput()).getFile();\n-\n+        IFile file = getInputFile();\n+        if (file != null) {\n             QualifiedName qname = new QualifiedName(AdtPlugin.PLUGIN_ID,\n                     getClass().getSimpleName() + PREF_CURRENT_PAGE);\n             try {\n@@ -345,21 +342,19 @@ public abstract class AndroidXmlEditor extends FormEditor implements IResourceCh\n      */\n     public void resourceChanged(final IResourceChangeEvent event) {\n         if (event.getType() == IResourceChangeEvent.PRE_CLOSE) {\n-            Display.getDefault().asyncExec(new Runnable() {\n-                public void run() {\n-                    IWorkbenchPage[] pages = getSite().getWorkbenchWindow()\n-                            .getPages();\n-                    for (int i = 0; i < pages.length; i++) {\n-                        if (((FileEditorInput)mTextEditor.getEditorInput())\n-                                .getFile().getProject().equals(\n-                                        event.getResource())) {\n-                            IEditorPart editorPart = pages[i].findEditor(mTextEditor\n-                                    .getEditorInput());\n+            IFile file = getInputFile();\n+            if (file != null && file.getProject().equals(event.getResource())) {\n+                final IEditorInput input = getEditorInput();\n+                Display.getDefault().asyncExec(new Runnable() {\n+                    public void run() {\n+                        IWorkbenchPage[] pages = getSite().getWorkbenchWindow().getPages();\n+                        for (int i = 0; i < pages.length; i++) {\n+                            IEditorPart editorPart = pages[i].findEditor(input);\n                             pages[i].closeEditor(editorPart, true);\n                         }\n                     }\n-                }\n-            });\n+                });\n+            }\n         }\n     }\n \n@@ -377,6 +372,21 @@ public abstract class AndroidXmlEditor extends FormEditor implements IResourceCh\n         super.init(site, editorInput);\n     }\n \n+    /**\n+     * Returns the {@link IFile} matching the editor's input or null.\n+     * <p/>\n+     * By construction, the editor input has to be an {@link IFileEditorInput} so it must\n+     * have an associated {@link IFile}. Null can only be returned if this editor has no\n+     * input somehow.\n+     */\n+    public IFile getInputFile() {\n+        IEditorInput input = getEditorInput();\n+        if (input instanceof IFileEditorInput) {\n+            return ((IFileEditorInput) input).getFile();\n+        }\n+        return null;\n+    }\n+\n     /**\n      * Removes attached listeners.\n      *\n@@ -626,6 +636,11 @@ public abstract class AndroidXmlEditor extends FormEditor implements IResourceCh\n         if (document != null) {\n             IModelManager mm = StructuredModelManager.getModelManager();\n             if (mm != null) {\n+                // TODO simplify this by not using the internal IStructuredDocument.\n+                // Instead we can now use mm.getModelForRead(getFile()).\n+                // However we must first check that SSE for Eclipse 3.3 or 3.4 has this\n+                // method. IIRC 3.3 didn't have it.\n+\n                 return mm.getModelForRead(document);\n             }\n         }\n@@ -636,18 +651,25 @@ public abstract class AndroidXmlEditor extends FormEditor implements IResourceCh\n      * Returns a version of the model that has been shared for edit.\n      * <p/>\n      * Callers <em>must</em> call model.releaseFromEdit() when done, typically\n-     * in a try..finally clause. Because of this, it is highly recommended\n-     * to <b>NOT</b> use this method directly and instead use the wrapper\n+     * in a try..finally clause.\n+     * <p/>\n+     * Because of this, it is mandatory to use the wrapper\n      * {@link #wrapEditXmlModel(Runnable)} which executes a runnable into a\n      * properly configured model and then performs whatever cleanup is necessary.\n      *\n      * @return The model for the XML document or null if cannot be obtained from the editor\n      */\n-    public final IStructuredModel getModelForEdit() {\n+    private IStructuredModel getModelForEdit() {\n+\n         IStructuredDocument document = getStructuredDocument();\n         if (document != null) {\n             IModelManager mm = StructuredModelManager.getModelManager();\n             if (mm != null) {\n+                // TODO simplify this by not using the internal IStructuredDocument.\n+                // Instead we can now use mm.getModelForRead(getFile()).\n+                // However we must first check that SSE for Eclipse 3.3 or 3.4 has this\n+                // method. IIRC 3.3 didn't have it.\n+\n                 return mm.getModelForEdit(document);\n             }\n         }\n@@ -700,7 +722,7 @@ public abstract class AndroidXmlEditor extends FormEditor implements IResourceCh\n \n                 if (mIsEditXmlModelPending < 0) {\n                     AdtPlugin.log(IStatus.ERROR,\n-                            \""wrapEditXmlModel finished with invalid nested counter==%d\"", //$NON-NLS-1$\n+                            \""wrapEditXmlModel finished with invalid nested counter==%1$d\"", //$NON-NLS-1$\n                             mIsEditXmlModelPending);\n                     mIsEditXmlModelPending = 0;\n                 }\n@@ -770,16 +792,14 @@ public abstract class AndroidXmlEditor extends FormEditor implements IResourceCh\n      * @return True if the undo recording actually started, false if any kind of error occured.\n      *         {@link #endUndoRecording()} should only be called if True is returned.\n      */\n-    private final boolean beginUndoRecording(String label) {\n-        IStructuredDocument document = getStructuredDocument();\n-        if (document != null) {\n-            IModelManager mm = StructuredModelManager.getModelManager();\n-            if (mm != null) {\n-                IStructuredModel model = mm.getModelForEdit(document);\n-                if (model != null) {\n-                    model.beginRecording(this, label);\n-                    return true;\n-                }\n+    private boolean beginUndoRecording(String label) {\n+        IStructuredModel model = getModelForEdit();\n+        if (model != null) {\n+            try {\n+                model.beginRecording(this, label);\n+                return true;\n+            } finally {\n+                model.releaseFromEdit();\n             }\n         }\n         return false;\n@@ -792,15 +812,13 @@ public abstract class AndroidXmlEditor extends FormEditor implements IResourceCh\n      * used if the initial call returned true.\n      * To guarantee that, only access this via {@link #wrapUndoEditXmlModel(String, Runnable)}.\n      */\n-    private final void endUndoRecording() {\n-        IStructuredDocument document = getStructuredDocument();\n-        if (document != null) {\n-            IModelManager mm = StructuredModelManager.getModelManager();\n-            if (mm != null) {\n-                IStructuredModel model = mm.getModelForEdit(document);\n-                if (model != null) {\n-                    model.endRecording(this);\n-                }\n+    private void endUndoRecording() {\n+        IStructuredModel model = getModelForEdit();\n+        if (model != null) {\n+            try {\n+                model.endRecording(this);\n+            } finally {\n+                model.releaseFromEdit();\n             }\n         }\n     }\n@@ -825,16 +843,9 @@ public abstract class AndroidXmlEditor extends FormEditor implements IResourceCh\n      * Returns the {@link IProject} for the edited file.\n      */\n     public IProject getProject() {\n-        if (mTextEditor != null) {\n-            IEditorInput input = mTextEditor.getEditorInput();\n-            if (input instanceof FileEditorInput) {\n-                FileEditorInput fileInput = (FileEditorInput)input;\n-                IFile inputFile = fileInput.getFile();\n-\n-                if (inputFile != null) {\n-                    return inputFile.getProject();\n-                }\n-            }\n+        IFile file = getInputFile();\n+        if (file != null) {\n+            return file.getProject();\n         }\n \n         return null;\n"", ""MatchingStrategy.java"": ""@@ -37,11 +37,11 @@ public class MatchingStrategy implements IEditorMatchingStrategy {\n         // first check that the file being opened is a layout file.\n         if (input instanceof FileEditorInput) {\n             FileEditorInput fileInput = (FileEditorInput)input;\n-            \n+\n             // get the IFile object and check it's in one of the layout folders.\n             IFile iFile = fileInput.getFile();\n             ResourceFolder resFolder = ResourceManager.getInstance().getResourceFolder(iFile);\n-            \n+\n             // if it's a layout, we know check the name of the fileInput against the name of the\n             // file being currently edited by the editor since those are independent of the config.\n             if (resFolder != null && resFolder.getType() == ResourceFolderType.LAYOUT) {\n@@ -50,7 +50,7 @@ public class MatchingStrategy implements IEditorMatchingStrategy {\n                     if (editorInput instanceof FileEditorInput) {\n                         FileEditorInput editorFileInput = (FileEditorInput)editorInput;\n                         IFile editorIFile = editorFileInput.getFile();\n-                        \n+\n                         return editorIFile.getProject().equals(iFile.getProject())\n                             && editorIFile.getName().equals(iFile.getName());\n                     }\n"", ""ManifestEditor.java"": ""@@ -41,7 +41,7 @@ import org.eclipse.core.runtime.CoreException;\n import org.eclipse.ui.IEditorInput;\n import org.eclipse.ui.IEditorPart;\n import org.eclipse.ui.PartInitException;\n-import org.eclipse.ui.part.FileEditorInput;\n+import org.eclipse.wst.sse.core.internal.provisional.IStructuredModel;\n import org.w3c.dom.Document;\n import org.w3c.dom.Node;\n \n@@ -198,8 +198,15 @@ public final class ManifestEditor extends AndroidXmlEditor {\n     }\n \n     private void onDescriptorsChanged() {\n-        Node node = getManifestXmlNode(getXmlDocument(getModelForRead()));\n-        mUiManifestNode.reloadFromXmlNode(node);\n+        IStructuredModel model = getModelForRead();\n+        if (model != null) {\n+            try {\n+                Node node = getManifestXmlNode(getXmlDocument(model));\n+                mUiManifestNode.reloadFromXmlNode(node);\n+            } finally {\n+                model.releaseFromRead();\n+            }\n+        }\n \n         if (mOverviewPage != null) {\n             mOverviewPage.refreshUiApplicationNode();\n@@ -234,7 +241,8 @@ public final class ManifestEditor extends AndroidXmlEditor {\n                 }\n             };\n \n-            GlobalProjectMonitor.getMonitor().addFileListener(mMarkerMonitor, IResourceDelta.CHANGED);\n+            GlobalProjectMonitor.getMonitor().addFileListener(\n+                    mMarkerMonitor, IResourceDelta.CHANGED);\n         }\n     }\n \n@@ -246,17 +254,17 @@ public final class ManifestEditor extends AndroidXmlEditor {\n     private void updateFromExistingMarkers(IFile inputFile) {\n         try {\n             // get the markers for the file\n-            IMarker[] markers = inputFile.findMarkers(AndroidConstants.MARKER_ANDROID, true,\n-                    IResource.DEPTH_ZERO);\n+            IMarker[] markers = inputFile.findMarkers(\n+                    AndroidConstants.MARKER_ANDROID, true, IResource.DEPTH_ZERO);\n \n             AndroidManifestDescriptors desc = getManifestDescriptors();\n             if (desc != null) {\n                 ElementDescriptor appElement = desc.getApplicationElement();\n \n-                if (appElement != null) {\n-                    UiElementNode app_ui_node = mUiManifestNode.findUiChildNode(\n+                if (appElement != null && mUiManifestNode != null) {\n+                    UiElementNode appUiNode = mUiManifestNode.findUiChildNode(\n                             appElement.getXmlName());\n-                    List<UiElementNode> children = app_ui_node.getUiChildren();\n+                    List<UiElementNode> children = appUiNode.getUiChildren();\n \n                     for (IMarker marker : markers) {\n                         processMarker(marker, children, IResourceDelta.ADDED);\n@@ -378,17 +386,4 @@ public final class ManifestEditor extends AndroidXmlEditor {\n             mUiManifestNode.setEditor(this);\n         }\n     }\n-\n-    /**\n-     * Returns the {@link IFile} being edited, or <code>null</code> if it couldn't be computed.\n-     */\n-    private IFile getInputFile() {\n-        IEditorInput input = getEditorInput();\n-        if (input instanceof FileEditorInput) {\n-            FileEditorInput fileInput = (FileEditorInput) input;\n-            return fileInput.getFile();\n-        }\n-\n-        return null;\n-    }\n }\n"", ""PasteAction.java"": ""@@ -27,7 +27,6 @@ import org.eclipse.swt.dnd.Clipboard;\n import org.eclipse.swt.dnd.TextTransfer;\n import org.eclipse.ui.ISharedImages;\n import org.eclipse.ui.PlatformUI;\n-import org.eclipse.wst.sse.core.internal.provisional.IStructuredModel;\n import org.eclipse.wst.sse.core.internal.provisional.IndexedRegion;\n import org.eclipse.wst.sse.core.internal.provisional.text.IStructuredDocument;\n import org.eclipse.wst.sse.core.internal.provisional.text.IStructuredDocumentRegion;\n@@ -63,61 +62,65 @@ public class PasteAction extends Action {\n     @Override\n     public void run() {\n         super.run();\n-        \n+\n         final String data = (String) mClipboard.getContents(TextTransfer.getInstance());\n         if (data != null) {\n-            IStructuredModel model = mEditor.getModelForEdit();\n-            try {\n-                IStructuredDocument sse_doc = mEditor.getStructuredDocument();\n-                if (sse_doc != null) {\n-                    if (mUiNode.getDescriptor().hasChildren()) {\n-                        // This UI Node can have children. The new XML is\n-                        // inserted as the first child.\n-                        \n-                        if (mUiNode.getUiChildren().size() > 0) {\n-                            // There's already at least one child, so insert right before it.\n-                            Node xml_node = mUiNode.getUiChildren().get(0).getXmlNode();\n-                            if (xml_node instanceof IndexedRegion) { // implies xml_node != null\n-                                IndexedRegion region = (IndexedRegion) xml_node;\n-                                sse_doc.replace(region.getStartOffset(), 0, data);\n-                                return; // we're done, no need to try the other cases\n-                            }                                \n-                        }\n-                        \n-                        // If there's no first XML node child. Create one by\n-                        // inserting at the end of the *start* tag.\n-                        Node xml_node = mUiNode.getXmlNode();\n-                        if (xml_node instanceof NodeContainer) {\n-                            NodeContainer container = (NodeContainer) xml_node;\n-                            IStructuredDocumentRegion start_tag =\n-                                container.getStartStructuredDocumentRegion();\n-                            if (start_tag != null) {\n-                                sse_doc.replace(start_tag.getEndOffset(), 0, data);\n-                                return; // we're done, no need to try the other case\n+            mEditor.wrapEditXmlModel(new Runnable() {\n+                public void run() {\n+                    try {\n+                        IStructuredDocument sse_doc = mEditor.getStructuredDocument();\n+                        if (sse_doc != null) {\n+                            if (mUiNode.getDescriptor().hasChildren()) {\n+                                // This UI Node can have children. The new XML is\n+                                // inserted as the first child.\n+\n+                                if (mUiNode.getUiChildren().size() > 0) {\n+                                    // There's already at least one child,\n+                                    // so insert right before it.\n+                                    Node xml_node = mUiNode.getUiChildren().get(0).getXmlNode();\n+\n+                                    if (xml_node instanceof IndexedRegion) {\n+                                        IndexedRegion region = (IndexedRegion) xml_node;\n+                                        sse_doc.replace(region.getStartOffset(), 0, data);\n+                                        return; // we're done, no need to try the other cases\n+                                    }\n+                                }\n+\n+                                // If there's no first XML node child. Create one by\n+                                // inserting at the end of the *start* tag.\n+                                Node xml_node = mUiNode.getXmlNode();\n+                                if (xml_node instanceof NodeContainer) {\n+                                    NodeContainer container = (NodeContainer) xml_node;\n+                                    IStructuredDocumentRegion start_tag =\n+                                        container.getStartStructuredDocumentRegion();\n+                                    if (start_tag != null) {\n+                                        sse_doc.replace(start_tag.getEndOffset(), 0, data);\n+                                        return; // we're done, no need to try the other case\n+                                    }\n+                                }\n+                            }\n+\n+                            // This UI Node doesn't accept children. The new XML is inserted as the\n+                            // next sibling. This also serves as a fallback if all the previous\n+                            // attempts failed. However, this is not possible if the current node\n+                            // has for parent a document -- an XML document can only have one root,\n+                            // with no siblings.\n+                            if (!(mUiNode.getUiParent() instanceof UiDocumentNode)) {\n+                                Node xml_node = mUiNode.getXmlNode();\n+                                if (xml_node instanceof IndexedRegion) {\n+                                    IndexedRegion region = (IndexedRegion) xml_node;\n+                                    sse_doc.replace(region.getEndOffset(), 0, data);\n+                                }\n                             }\n                         }\n-                    }\n-                    \n-                    // This UI Node doesn't accept children. The new XML is inserted as the\n-                    // next sibling. This also serves as a fallback if all the previous\n-                    // attempts failed. However, this is not possible if the current node\n-                    // has for parent a document -- an XML document can only have one root,\n-                    // with no siblings.\n-                    if (!(mUiNode.getUiParent() instanceof UiDocumentNode)) {\n-                        Node xml_node = mUiNode.getXmlNode();\n-                        if (xml_node instanceof IndexedRegion) {\n-                            IndexedRegion region = (IndexedRegion) xml_node;\n-                            sse_doc.replace(region.getEndOffset(), 0, data);\n-                        }\n+\n+                    } catch (BadLocationException e) {\n+                        AdtPlugin.log(e,\n+                                \""ParseAction failed for UI Node %2$s, content '%1$s'\"", //$NON-NLS-1$\n+                                mUiNode.getBreadcrumbTrailDescription(true), data);\n                     }\n                 }\n-\n-            } catch (BadLocationException e) {\n-                AdtPlugin.log(e, \""ParseAction failed for UI Node %2$s, content '%1$s'\"", //$NON-NLS-1$\n-                        mUiNode.getBreadcrumbTrailDescription(true), data);\n-            } finally {\n-                model.releaseFromEdit();\n-            }\n+            });\n         }\n     }\n }\n"", ""UiElementDetail.java"": ""@@ -73,13 +73,13 @@ class UiElementDetail implements IDetailsPage {\n     private IManagedForm mManagedForm;\n \n     private final UiTreeBlock mTree;\n-    \n+\n     public UiElementDetail(UiTreeBlock tree) {\n         mTree = tree;\n         mMasterPart = mTree.getMasterPart();\n         mManagedForm = mMasterPart.getManagedForm();\n     }\n-    \n+\n     /* (non-java doc)\n      * Initializes the part.\n      */\n@@ -117,25 +117,21 @@ class UiElementDetail implements IDetailsPage {\n      * Instructs it to commit the new (modified) data back into the model.\n      */\n     public void commit(boolean onSave) {\n-        \n-        IStructuredModel model = mTree.getEditor().getModelForEdit();\n-        try {\n-            // Notify the model we're about to change data...\n-            model.aboutToChangeModel();\n-\n-            if (mCurrentUiElementNode != null) {\n-                mCurrentUiElementNode.commit();\n+\n+        mTree.getEditor().wrapEditXmlModel(new Runnable() {\n+            public void run() {\n+                try {\n+                    if (mCurrentUiElementNode != null) {\n+                        mCurrentUiElementNode.commit();\n+                    }\n+\n+                    // Finally reset the dirty flag if everything was saved properly\n+                    mIsDirty = false;\n+                } catch (Exception e) {\n+                    AdtPlugin.log(e, \""Detail node failed to commit XML attribute!\""); //$NON-NLS-1$\n+                }\n             }\n-            \n-            // Finally reset the dirty flag if everything was saved properly\n-            mIsDirty = false;\n-        } catch (Exception e) {\n-            AdtPlugin.log(e, \""Detail node failed to commit XML attribute!\""); //$NON-NLS-1$\n-        } finally {\n-            // Notify the model we're done modifying it. This must *always* be executed.\n-            model.changedModel();\n-            model.releaseFromEdit();\n-        }\n+        });\n     }\n \n     public void dispose() {\n@@ -183,7 +179,7 @@ class UiElementDetail implements IDetailsPage {\n \n     /**\n      * Creates a TableWrapLayout in the DetailsPage, which in turns contains a Section.\n-     * \n+     *\n      * All the UI should be created in a layout which parent is the mSection itself.\n      * The hierarchy is:\n      * <pre>\n@@ -194,7 +190,7 @@ class UiElementDetail implements IDetailsPage {\n      *       + Labels/Forms/etc... [*]\n      * </pre>\n      * Both items marked with [*] are created by the derived classes to fit their needs.\n-     * \n+     *\n      * @param parent Parent of the mSection (from createContents)\n      * @return The new Section\n      */\n@@ -215,7 +211,7 @@ class UiElementDetail implements IDetailsPage {\n      * <p/>\n      * This is called by the constructor.\n      * Derived classes can override this if necessary.\n-     * \n+     *\n      * @param managedForm The managed form\n      */\n     private void createUiAttributeControls(\n@@ -258,7 +254,7 @@ class UiElementDetail implements IDetailsPage {\n             mCurrentTable = masterTable;\n \n             mCurrentUiElementNode = ui_node;\n-                \n+\n             if (elem_desc.getTooltip() != null) {\n                 String tooltip;\n                 if (Sdk.getCurrent() != null &&\n@@ -285,7 +281,7 @@ class UiElementDetail implements IDetailsPage {\n                             \""Malformed javadoc, rejected by FormText for node %1$s: '%2$s'\"", //$NON-NLS-1$\n                             ui_node.getDescriptor().getXmlName(),\n                             tooltip);\n-                    \n+\n                     // Fallback to a pure text tooltip, no fancy HTML\n                     tooltip = DescriptorsUtils.formatTooltip(elem_desc.getTooltip());\n                     Label label = SectionHelper.createLabel(masterTable, toolkit,\n@@ -294,7 +290,7 @@ class UiElementDetail implements IDetailsPage {\n             }\n \n             Composite table = useSubsections ? null : masterTable;\n-            \n+\n             for (AttributeDescriptor attr_desc : attr_desc_list) {\n                 if (attr_desc instanceof XmlnsAttributeDescriptor) {\n                     // Do not show hidden attributes\n@@ -318,7 +314,7 @@ class UiElementDetail implements IDetailsPage {\n \n                 if (ui_attr != null) {\n                     ui_attr.createUiControl(table, managedForm);\n-                    \n+\n                     if (ui_attr.getCurrentValue() != null &&\n                             ui_attr.getCurrentValue().length() > 0) {\n                         ((Section) table.getParent()).setExpanded(true);\n@@ -339,7 +335,7 @@ class UiElementDetail implements IDetailsPage {\n                     \""Unknown XML Attributes\"");\n             unknownTable.getParent().setVisible(false); // set section to not visible\n             final HashSet<UiAttributeNode> reference = new HashSet<UiAttributeNode>();\n-            \n+\n             final IUiUpdateListener updateListener = new IUiUpdateListener() {\n                 public void uiElementNodeUpdated(UiElementNode ui_node, UiUpdateState state) {\n                     if (state == UiUpdateState.ATTR_UPDATED) {\n@@ -349,16 +345,16 @@ class UiElementDetail implements IDetailsPage {\n                 }\n             };\n             ui_node.addUpdateListener(updateListener);\n-            \n+\n             // remove the listener when the UI is disposed\n             unknownTable.addDisposeListener(new DisposeListener() {\n                 public void widgetDisposed(DisposeEvent e) {\n                     ui_node.removeUpdateListener(updateListener);\n                 }\n             });\n-            \n+\n             updateUnknownAttributesSection(ui_node, unknownTable, managedForm, reference);\n-            \n+\n             mMasterSection.getParent().pack(true /* changed */);\n         }\n     }\n@@ -369,7 +365,7 @@ class UiElementDetail implements IDetailsPage {\n      */\n     private Composite createSubSectionTable(FormToolkit toolkit,\n             Composite masterTable, String title) {\n-        \n+\n         // The Section composite seems to ignore colspan when assigned a TableWrapData so\n         // if the parent is a table with more than one column an extra table with one column\n         // is inserted to respect colspan.\n@@ -381,7 +377,7 @@ class UiElementDetail implements IDetailsPage {\n             twd.colspan = parentNumCol;\n             masterTable.setLayoutData(twd);\n         }\n-        \n+\n         Composite table;\n         Section section = toolkit.createSection(masterTable,\n                 Section.TITLE_BAR | Section.TWISTIE);\n@@ -449,28 +445,28 @@ class UiElementDetail implements IDetailsPage {\n         if (has_differences) {\n             needs_reflow = true;\n             reference.clear();\n-            \n+\n             // Remove all children of the table\n             for (Control c : unknownTable.getChildren()) {\n                 c.dispose();\n             }\n-    \n+\n             // Recreate all attributes UI\n             for (UiAttributeNode ui_attr : ui_attrs) {\n                 reference.add(ui_attr);\n                 ui_attr.createUiControl(unknownTable, managedForm);\n-    \n+\n                 if (ui_attr.getCurrentValue() != null && ui_attr.getCurrentValue().length() > 0) {\n                     section.setExpanded(true);\n                 }\n             }\n         }\n-        \n+\n         if (needs_reflow) {\n             reflowMasterSection();\n         }\n     }\n-    \n+\n     /**\n      * Marks the part dirty. Called as a result of user interaction with the widgets in the\n      * section.\n""}","bug, refactor 
"
17481,Dima Zavin,ARM: tegra: add a virtual cop clock for AVP reset assertion,['arch/arm/mach-tegra/tegra2_clocks.c'],"ARM: tegra: add a virtual cop clock for AVP reset assertion

Change-Id: Ib27e5191d78f7994d444167b7d3a981a43f59b3c
Signed-off-by: Dima Zavin <dima@android.com>",https://android-review.googlesource.com/c/17481,"feature 
",feature,Feature;,"{""tegra2_clocks.c"": ""@@ -412,6 +412,32 @@ static struct clk_ops tegra_cpu_ops = {\n \t.set_rate = tegra2_cpu_clk_set_rate,\n };\n \n+/* virtual cop clock functions. Used to acquire the fake 'cop' clock to\n+ * reset the COP block (i.e. AVP) */\n+static void tegra2_cop_clk_init(struct clk *c)\n+{\n+\tc->state = c->parent->state;\n+}\n+\n+static int tegra2_cop_clk_enable(struct clk *c)\n+{\n+\treturn 0;\n+}\n+\n+static void tegra2_cop_clk_reset(struct clk *c, bool assert)\n+{\n+\tunsigned long reg = assert ? RST_DEVICES_SET : RST_DEVICES_CLR;\n+\n+\tpr_debug(\""%s %s\\n\"", __func__, assert ? \""assert\"" : \""deassert\"");\n+\tclk_writel(1 << 1, reg);\n+}\n+\n+static struct clk_ops tegra_cop_ops = {\n+\t.init     = tegra2_cop_clk_init,\n+\t.enable   = tegra2_cop_clk_enable,\n+\t.reset    = tegra2_cop_clk_reset,\n+};\n+\n /* bus clock functions */\n static void tegra2_bus_clk_init(struct clk *c)\n {\n@@ -1619,6 +1645,13 @@ static struct clk tegra_clk_virtual_cpu = {\n \t.dvfs      = &tegra_dvfs_virtual_cpu_dvfs,\n };\n \n+static struct clk tegra_clk_cop = {\n+\t.name      = \""cop\"",\n+\t.parent    = &tegra_clk_sclk,\n+\t.ops       = &tegra_cop_ops,\n+\t.max_rate  = 240000000,\n+};\n+\n static struct clk tegra_clk_hclk = {\n \t.name\t\t= \""hclk\"",\n \t.flags\t\t= DIV_BUS,\n@@ -1873,6 +1906,7 @@ struct clk_lookup tegra_clk_lookups[] = {\n \tCLK(NULL,\t\""clk_dev2\"",\t&tegra_dev2_clk),\n \tCLK(NULL,\t\""cpu\"",\t\t&tegra_clk_virtual_cpu),\n \tCLK(NULL,\t\""blink\"",\t&tegra_clk_blink),\n+\tCLK(\""tegra-avp\"", \""cop\"",\t\t&tegra_clk_cop),\n };\n \n void __init tegra2_init_clocks(void)\n""}","bug 
"
14841,Xavier Ducrohet,Add proper support for <uses-library> and <uses-feature> in the manifest parsing.,"['sdkmanager/libs/sdklib/src/com/android/sdklib/xml/ManifestData.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/launch/junit/InstrumentationRunnerValidator.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/xml/AndroidManifest.java', 'sdkmanager/libs/sdklib/tests/com/android/sdklib/xml/AndroidManifestParserTest.java', 'sdkmanager/libs/sdklib/src/com/android/sdklib/xml/AndroidManifestParser.java', 'sdkmanager/libs/sdklib/tests/com/android/sdklib/testdata/AndroidManifest-testapp.xml']","Add proper support for <uses-library> and <uses-feature> in the manifest parsing.

Change-Id: I80d5fd57f66005fcb4157cb6acc3f9473dd19701",https://android-review.googlesource.com/c/14841,"feature, test 
","feature,test 
",Feature;,"{""InstrumentationRunnerValidator.java"": ""@@ -22,6 +22,7 @@ import com.android.ide.eclipse.adt.internal.project.BaseProjectHelper;\n import com.android.sdklib.SdkConstants;\n import com.android.sdklib.xml.ManifestData;\n import com.android.sdklib.xml.ManifestData.Instrumentation;\n+import com.android.sdklib.xml.ManifestData.UsesLibrary;\n \n import org.eclipse.core.resources.IProject;\n import org.eclipse.core.runtime.CoreException;\n@@ -86,8 +87,8 @@ class InstrumentationRunnerValidator {\n      * @return true if test runner library found, false otherwise\n      */\n     private boolean hasTestRunnerLibrary(ManifestData manifestData) {\n-       for (String lib : manifestData.getUsesLibraries()) {\n-           if (lib.equals(AndroidConstants.LIBRARY_TEST_RUNNER)) {\n+       for (UsesLibrary lib : manifestData.getUsesLibraries()) {\n+           if (AndroidConstants.LIBRARY_TEST_RUNNER.equals(lib.getName())) {\n                return true;\n            }\n        }\n"", ""AndroidManifest.java"": ""@@ -48,10 +48,13 @@ public final class AndroidManifest {\n     public final static String NODE_USES_LIBRARY = \""uses-library\"";\n     public final static String NODE_SUPPORTS_SCREENS = \""supports-screens\"";\n     public final static String NODE_USES_CONFIGURATION = \""uses-configuration\"";\n+    public final static String NODE_USES_FEATURE = \""uses-feature\"";\n \n     public final static String ATTRIBUTE_PACKAGE = \""package\"";\n     public final static String ATTRIBUTE_VERSIONCODE = \""versionCode\"";\n     public final static String ATTRIBUTE_NAME = \""name\"";\n+    public final static String ATTRIBUTE_REQUIRED = \""required\"";\n+    public final static String ATTRIBUTE_GLESVERSION = \""glEsVersion\"";\n     public final static String ATTRIBUTE_PROCESS = \""process\"";\n     public final static String ATTRIBUTE_DEBUGGABLE = \""debuggable\"";\n     public final static String ATTRIBUTE_MIN_SDK_VERSION = \""minSdkVersion\"";\n"", ""AndroidManifestParser.java"": ""@@ -27,6 +27,8 @@ import com.android.sdklib.xml.ManifestData.Activity;\n import com.android.sdklib.xml.ManifestData.Instrumentation;\n import com.android.sdklib.xml.ManifestData.SupportsScreens;\n import com.android.sdklib.xml.ManifestData.UsesConfiguration;\n+import com.android.sdklib.xml.ManifestData.UsesFeature;\n+import com.android.sdklib.xml.ManifestData.UsesLibrary;\n \n import org.xml.sax.Attributes;\n import org.xml.sax.ErrorHandler;\n@@ -46,11 +48,11 @@ import javax.xml.parsers.SAXParserFactory;\n \n public class AndroidManifestParser {\n \n-    private final static int LEVEL_MANIFEST = 0;\n-    private final static int LEVEL_APPLICATION = 1;\n-    private final static int LEVEL_ACTIVITY = 2;\n-    private final static int LEVEL_INTENT_FILTER = 3;\n-    private final static int LEVEL_CATEGORY = 4;\n+    private final static int LEVEL_TOP = 0;\n+    private final static int LEVEL_INSIDE_MANIFEST = 1;\n+    private final static int LEVEL_INSIDE_APPLICATION = 2;\n+    private final static int LEVEL_INSIDE_APP_COMPONENT = 3;\n+    private final static int LEVEL_INSIDE_INTENT_FILTER = 4;\n \n     private final static String ACTION_MAIN = \""android.intent.action.MAIN\""; //$NON-NLS-1$\n     private final static String CATEGORY_LAUNCHER = \""android.intent.category.LAUNCHER\""; //$NON-NLS-1$\n@@ -134,7 +136,7 @@ public class AndroidManifestParser {\n                 if (mValidLevel == mCurrentLevel) {\n                     String value;\n                     switch (mValidLevel) {\n-                        case LEVEL_MANIFEST:\n+                        case LEVEL_TOP:\n                             if (AndroidManifest.NODE_MANIFEST.equals(localName)) {\n                                 // lets get the package name.\n                                 mManifestData.mPackage = getAttributeValue(attributes,\n@@ -154,7 +156,7 @@ public class AndroidManifestParser {\n                                 mValidLevel++;\n                             }\n                             break;\n-                        case LEVEL_APPLICATION:\n+                        case LEVEL_INSIDE_MANIFEST:\n                             if (AndroidManifest.NODE_APPLICATION.equals(localName)) {\n                                 value = getAttributeValue(attributes,\n                                         AndroidManifest.ATTRIBUTE_PROCESS,\n@@ -184,9 +186,46 @@ public class AndroidManifestParser {\n                             } else if (AndroidManifest.NODE_USES_CONFIGURATION.equals(localName)) {\n                                 processUsesConfiguration(attributes);\n \n+                            } else if (AndroidManifest.NODE_USES_FEATURE.equals(localName)) {\n+                                UsesFeature feature = new UsesFeature();\n+\n+                                // get the name\n+                                value = getAttributeValue(attributes,\n+                                        AndroidManifest.ATTRIBUTE_NAME,\n+                                        true /* hasNamespace */);\n+                                if (value != null) {\n+                                    feature.mName = value;\n+                                }\n+\n+                                // read the required attribute\n+                                value = getAttributeValue(attributes,\n+                                        AndroidManifest.ATTRIBUTE_REQUIRED,\n+                                        true /*hasNamespace*/);\n+                                if (value != null) {\n+                                    Boolean b = Boolean.valueOf(value);\n+                                    if (b != null) {\n+                                        feature.mRequired = b;\n+                                    }\n+                                }\n+\n+                                // read the gl es attribute\n+                                value = getAttributeValue(attributes,\n+                                        AndroidManifest.ATTRIBUTE_GLESVERSION,\n+                                        true /*hasNamespace*/);\n+                                if (value != null) {\n+                                    try {\n+                                        int version = Integer.decode(value);\n+                                        feature.mGlEsVersion = version;\n+                                    } catch (NumberFormatException e) {\n+                                        // ignore\n+                                    }\n+\n+                                }\n+\n+                                mManifestData.mFeatures.add(feature);\n                             }\n                             break;\n-                        case LEVEL_ACTIVITY:\n+                        case LEVEL_INSIDE_APPLICATION:\n                             if (AndroidManifest.NODE_ACTIVITY.equals(localName)) {\n                                 processActivityNode(attributes);\n                                 mValidLevel++;\n@@ -204,11 +243,25 @@ public class AndroidManifestParser {\n                                         AndroidManifest.ATTRIBUTE_NAME,\n                                         true /* hasNamespace */);\n                                 if (value != null) {\n-                                    mManifestData.mLibraries.add(value);\n+                                    UsesLibrary library = new UsesLibrary();\n+                                    library.mName = value;\n+\n+                                    // read the required attribute\n+                                    value = getAttributeValue(attributes,\n+                                            AndroidManifest.ATTRIBUTE_REQUIRED,\n+                                            true /*hasNamespace*/);\n+                                    if (value != null) {\n+                                        Boolean b = Boolean.valueOf(value);\n+                                        if (b != null) {\n+                                            library.mRequired = b;\n+                                        }\n+                                    }\n+\n+                                    mManifestData.mLibraries.add(library);\n                                 }\n                             }\n                             break;\n-                        case LEVEL_INTENT_FILTER:\n+                        case LEVEL_INSIDE_APP_COMPONENT:\n                             // only process this level if we are in an activity\n                             if (mCurrentActivity != null &&\n                                     AndroidManifest.NODE_INTENT.equals(localName)) {\n@@ -216,7 +269,7 @@ public class AndroidManifestParser {\n                                 mValidLevel++;\n                             }\n                             break;\n-                        case LEVEL_CATEGORY:\n+                        case LEVEL_INSIDE_INTENT_FILTER:\n                             if (mCurrentActivity != null) {\n                                 if (AndroidManifest.NODE_ACTION.equals(localName)) {\n                                     // get the name attribute\n@@ -271,10 +324,10 @@ public class AndroidManifestParser {\n                 // process the end of the element\n                 if (mValidLevel == mCurrentLevel) {\n                     switch (mValidLevel) {\n-                        case LEVEL_ACTIVITY:\n+                        case LEVEL_INSIDE_APPLICATION:\n                             mCurrentActivity = null;\n                             break;\n-                        case LEVEL_INTENT_FILTER:\n+                        case LEVEL_INSIDE_APP_COMPONENT:\n                             // if we found both a main action and a launcher category, this is our\n                             // launcher activity!\n                             if (mManifestData.mLauncherActivity == null &&\n"", ""ManifestData.java"": ""@@ -46,7 +46,9 @@ public final class ManifestData {\n     final ArrayList<Instrumentation> mInstrumentations =\n         new ArrayList<Instrumentation>();\n     /** List of all libraries in use declared by the manifest */\n-    final ArrayList<String> mLibraries = new ArrayList<String>();\n+    final ArrayList<UsesLibrary> mLibraries = new ArrayList<UsesLibrary>();\n+    /** List of all feature in use declared by the manifest */\n+    final ArrayList<UsesFeature> mFeatures = new ArrayList<UsesFeature>();\n \n     SupportsScreens mSupportsScreens;\n     UsesConfiguration mUsesConfiguration;\n@@ -178,6 +180,46 @@ public final class ManifestData {\n         }\n     }\n \n+    /**\n+     * Class representing a <code>uses-library</code> node in the manifest.\n+     */\n+    public final static class UsesLibrary {\n+        String mName;\n+        Boolean mRequired = Boolean.TRUE; // default is true even if missing\n+\n+        public String getName() {\n+            return mName;\n+        }\n+\n+        public Boolean getRequired() {\n+            return mRequired;\n+        }\n+    }\n+\n+    /**\n+     * Class representing a <code>uses-feature</code> node in the manifest.\n+     */\n+    public final static class UsesFeature {\n+        String mName;\n+        int mGlEsVersion = 0;\n+        Boolean mRequired = Boolean.TRUE;  // default is true even if missing\n+\n+        public String getName() {\n+            return mName;\n+        }\n+\n+        /**\n+         * Returns the value of the glEsVersion attribute, or 0 if the attribute was not present.\n+         */\n+        public int getGlEsVersion() {\n+            return mGlEsVersion;\n+        }\n+\n+        public Boolean getRequired() {\n+            return mRequired;\n+        }\n+    }\n+\n     /**\n      * Class representing the <code>uses-configuration</code> node in the manifest.\n      */\n@@ -293,10 +335,18 @@ public final class ManifestData {\n \n     /**\n      * Returns the list of libraries in use found in the manifest.\n-     * @return An array of library names, or empty if no libraries were found.\n+     * @return An array of {@link UsesLibrary} objects, or empty if no libraries were found.\n+     */\n+    public UsesLibrary[] getUsesLibraries() {\n+        return mLibraries.toArray(new UsesLibrary[mLibraries.size()]);\n+    }\n+\n+    /**\n+     * Returns the list of features in use found in the manifest.\n+     * @return An array of {@link UsesFeature} objects, or empty if no libraries were found.\n      */\n-    public String[] getUsesLibraries() {\n-        return mLibraries.toArray(new String[mLibraries.size()]);\n+    public UsesFeature[] getUsesFeatures() {\n+        return mFeatures.toArray(new UsesFeature[mFeatures.size()]);\n     }\n \n     /**\n"", ""AndroidManifest-testapp.xml"": ""@@ -1,28 +1,29 @@\n <?xml version=\""1.0\"" encoding=\""utf-8\""?>\n <manifest xmlns:android=\""http://schemas.android.com/apk/res/android\""\n-    package=\""com.android.testapp\""\n-    android:versionCode=\""42\""\n-    android:versionName=\""1.42\"">\n-  <application android:icon=\""@drawable/icon\"">\n-    <activity android:name=\""com.android.testapp.MainActivity\""\n-              android:label=\""@string/app_name\"">\n-      <intent-filter>\n-        <action android:name=\""android.intent.action.MAIN\"" />\n-          <category android:name=\""android.intent.category.LAUNCHER\"" />\""\n-          <category android:name=\""android.intent.category.DEFAULT\"" />\n-      </intent-filter>\n-    </activity>\n-    <uses-library android:name=\""android.test.runner\""/>\n-  </application>\""\n-  <uses-sdk android:minSdkVersion=\""7\""/>\n-  <supports-screens android:resizeable=\""true\"" android:smallScreens=\""true\""\n-      android:anyDensity=\""true\"" android:largeScreens=\""true\"" android:normalScreens=\""true\""/>\n-  <uses-configuration android:reqKeyboardType=\""twelvekey\""\n-      android:reqTouchScreen=\""finger\"" android:reqFiveWayNav=\""true\"" android:reqHardKeyboard=\""true\""\n-      android:reqNavigation=\""nonav\""/>\n-  <uses-feature android:glEsVersion=\""1\""/>\n-  <uses-feature android:name=\""com.foo.feature\""/>\n-  <instrumentation android:name=\""android.test.InstrumentationTestRunner\""\n-                   android:targetPackage=\""com.example.android.apis\""\n-                   android:label=\""Tests for Api Demos.\""/>\n-</manifest>\n\\ No newline at end of file\n+\tpackage=\""com.android.testapp\"" android:versionCode=\""42\""\n+\tandroid:versionName=\""1.42\"">\n+\t<application android:icon=\""@drawable/icon\"">\n+\t\t<activity android:name=\""com.android.testapp.MainActivity\""\n+\t\t\tandroid:label=\""@string/app_name\"">\n+\t\t\t<intent-filter>\n+\t\t\t\t<action android:name=\""android.intent.action.MAIN\"" />\n+\t\t\t\t<category android:name=\""android.intent.category.LAUNCHER\"" />\n+\t\t\t\t<category android:name=\""android.intent.category.DEFAULT\"" />\n+\t\t\t</intent-filter>\n+\t\t</activity>\n+\t\t<uses-library android:name=\""android.test.runner\""\n+\t\t\tandroid:required=\""false\"" />\n+\t\t<uses-library android:name=\""android.test.runner2\"" />\n+\t</application>\n+\t<uses-sdk android:minSdkVersion=\""7\"" />\n+\t<supports-screens android:resizeable=\""true\""\n+\t\tandroid:smallScreens=\""true\"" android:anyDensity=\""true\""\n+\t\tandroid:largeScreens=\""true\"" android:normalScreens=\""true\"" />\n+\t<uses-configuration android:reqKeyboardType=\""twelvekey\""\n+\t\tandroid:reqTouchScreen=\""finger\"" android:reqFiveWayNav=\""true\""\n+\t\tandroid:reqHardKeyboard=\""true\"" android:reqNavigation=\""nonav\"" />\n+\t<uses-feature android:glEsVersion=\""0x00020001\"" />\n+\t<uses-feature android:name=\""com.foo.feature\"" />\n+\t<instrumentation android:name=\""android.test.InstrumentationTestRunner\""\n+\t\tandroid:targetPackage=\""com.example.android.apis\"" android:label=\""Tests for Api Demos.\"" />\n+</manifest>\n"", ""AndroidManifestParserTest.java"": ""@@ -19,6 +19,8 @@ package com.android.sdklib.xml;\n import com.android.sdklib.resources.Keyboard;\n import com.android.sdklib.resources.Navigation;\n import com.android.sdklib.resources.TouchScreen;\n+import com.android.sdklib.xml.ManifestData.UsesFeature;\n+import com.android.sdklib.xml.ManifestData.UsesLibrary;\n \n import java.io.InputStream;\n \n@@ -41,6 +43,8 @@ public class AndroidManifestParserTest extends TestCase {\n     private static final Integer VERSION_CODE = 42;\n     private static final String ACTIVITY_NAME = \""com.android.testapp.MainActivity\""; //$NON-NLS-1$\n     private static final String LIBRARY_NAME = \""android.test.runner\""; //$NON-NLS-1$\n+    private static final String LIBRARY_NAME2 = \""android.test.runner2\""; //$NON-NLS-1$\n+    private static final String FEATURE_NAME = \""com.foo.feature\""; //$NON-NLS-1$\n     private static final String INSTRUMENTATION_NAME = \""android.test.InstrumentationTestRunner\""; //$NON-NLS-1$\n     private static final String INSTRUMENTATION_TARGET = \""com.android.AndroidProject\""; //$NON-NLS-1$\n \n@@ -129,8 +133,23 @@ public class AndroidManifestParserTest extends TestCase {\n     }\n \n     public void testGetUsesLibraries() {\n-        assertEquals(1, mManifestTestApp.getUsesLibraries().length);\n-        assertEquals(LIBRARY_NAME, mManifestTestApp.getUsesLibraries()[0]);\n+        UsesLibrary[] libraries = mManifestTestApp.getUsesLibraries();\n+\n+        assertEquals(2,             libraries.length);\n+        assertEquals(LIBRARY_NAME,  libraries[0].getName());\n+        assertEquals(Boolean.FALSE, libraries[0].getRequired());\n+        assertEquals(LIBRARY_NAME2, libraries[1].getName());\n+        assertEquals(Boolean.TRUE,  libraries[1].getRequired());\n+    }\n+\n+    public void testGetUsesFeatures() {\n+        UsesFeature[] features = mManifestTestApp.getUsesFeatures();\n+\n+        assertEquals(2,            features.length);\n+        assertEquals(0x00020001,   features[0].mGlEsVersion);\n+        assertEquals(Boolean.TRUE, features[0].getRequired());\n+        assertEquals(FEATURE_NAME, features[1].getName());\n+        assertEquals(Boolean.TRUE, features[1].getRequired());\n     }\n \n     public void testGetPackageName() {\n""}","feature,test 
"
15990,Xavier Ducrohet,Move tools to r8 in the dev branch.,['files/tools_source.properties'],"Move tools to r8 in the dev branch.

Change-Id: I703a4a52c0f2e76c5b19103f3b43ef203472006c",https://android-review.googlesource.com/c/15990,"resource 
",resource,Resource;,"{""tools_source.properties"": ""@@ -1,2 +1,2 @@\n Pkg.UserSrc=false\n-Pkg.Revision=7\n+Pkg.Revision=8\n""}","merge 
"
18708,Brian Muramatsu,Fix opcode tests for sput_byte,"['tools/vm-tests/src/dot/junit/opcodes/sput_byte/d/T_sput_byte_17.java', 'tools/vm-tests/src/dot/junit/opcodes/sput_byte/d/T_sput_byte_9.java', 'tools/vm-tests/src/dot/junit/opcodes/sput_byte/d/T_sput_byte_10.java', 'tools/vm-tests/src/dot/junit/opcodes/sput_byte/d/T_sput_byte_15.java', 'tools/vm-tests/src/dot/junit/opcodes/sput_byte/d/T_sput_byte_7.java', 'tools/vm-tests/src/dot/junit/opcodes/sput_byte/Test_sput_byte.java', 'tools/vm-tests/src/dot/junit/opcodes/sput_byte/d/T_sput_byte_8.java']","Fix opcode tests for sput_byte

Bug 3147582

Change-Id: Id263bccbd2e7e1fd7689549bf4f01fe001eb71fd",https://android-review.googlesource.com/c/18708,"test,bug 
","test,bug",Bug;Test;,"{""Test_sput_byte.java"": ""@@ -19,10 +19,16 @@ package dot.junit.opcodes.sput_byte;\n import dot.junit.DxTestCase;\n import dot.junit.DxUtil;\n import dot.junit.opcodes.sput_byte.d.T_sput_byte_1;\n+import dot.junit.opcodes.sput_byte.d.T_sput_byte_10;\n import dot.junit.opcodes.sput_byte.d.T_sput_byte_11;\n import dot.junit.opcodes.sput_byte.d.T_sput_byte_12;\n import dot.junit.opcodes.sput_byte.d.T_sput_byte_13;\n import dot.junit.opcodes.sput_byte.d.T_sput_byte_14;\n+import dot.junit.opcodes.sput_byte.d.T_sput_byte_15;\n+import dot.junit.opcodes.sput_byte.d.T_sput_byte_17;\n+import dot.junit.opcodes.sput_byte.d.T_sput_byte_7;\n+import dot.junit.opcodes.sput_byte.d.T_sput_byte_8;\n+import dot.junit.opcodes.sput_byte.d.T_sput_byte_9;\n \n public class Test_sput_byte extends DxTestCase {\n     /**\n@@ -35,7 +41,7 @@ public class Test_sput_byte extends DxTestCase {\n         assertEquals(77, T_sput_byte_1.st_i1);\n     }\n \n- \n+\n     /**\n      * @title modification of final field\n      */\n@@ -57,7 +63,7 @@ public class Test_sput_byte extends DxTestCase {\n         t.run();\n         assertEquals(77, T_sput_byte_14.getProtectedField());\n     }\n-    \n+\n \n     /**\n      * @title initialization of referenced class throws exception\n@@ -73,7 +79,7 @@ public class Test_sput_byte extends DxTestCase {\n     }\n \n     /**\n-     * @constraint A12 \n+     * @constraint A12\n      * @title constant pool index\n      */\n     public void testVFE1() {\n@@ -86,8 +92,8 @@ public class Test_sput_byte extends DxTestCase {\n     }\n \n     /**\n-     * \n-     * @constraint A23 \n+     *\n+     * @constraint A23\n      * @title number of registers\n      */\n     public void testVFE2() {\n@@ -101,22 +107,21 @@ public class Test_sput_byte extends DxTestCase {\n \n \n     /**\n-     * \n-     * @constraint B13 \n-     * @title put byte into long field - only field with same name but \n+     *\n+     * @constraint B13\n+     * @title put byte into long field - only field with same name but\n      * different type exists\n      */\n     public void testVFE5() {\n         try {\n-            Class.forName(\""dot.junit.opcodes.sput_byte.d.T_sput_byte_17\"");\n-            fail(\""expected a verification exception\"");\n-        } catch (Throwable t) {\n-            DxUtil.checkVerifyException(t);\n+            new T_sput_byte_17().run();\n+            fail(\""expected NoSuchFieldError\"");\n+        } catch (NoSuchFieldError t) {\n         }\n     }\n-    \n+\n     /**\n-     * \n+     *\n      * @constraint B13\n      * @title put value '256' into byte field\n      */\n@@ -130,9 +135,9 @@ public class Test_sput_byte extends DxTestCase {\n     }\n \n     /**\n-     * \n-     * @constraint B13 \n-     * @title type of field doesn't match opcode - attempt to modify double \n+     *\n+     * @constraint B13\n+     * @title type of field doesn't match opcode - attempt to modify double\n      * field with single-width register\n      */\n     public void testVFE7() {\n@@ -143,87 +148,77 @@ public class Test_sput_byte extends DxTestCase {\n             DxUtil.checkVerifyException(t);\n         }\n     }\n-    \n+\n     /**\n-     * \n-     * @constraint A12 \n-     * @title Attempt to set non-static field. Java throws IncompatibleClassChangeError \n-     * on first access but Dalvik throws VerifyError on class loading.\n+     *\n+     * @constraint A12\n+     * @title Attempt to set non-static field.\n      */\n     public void testVFE8() {\n          try {\n-             Class.forName(\""dot.junit.opcodes.sput_byte.d.T_sput_byte_7\"");\n-             fail(\""expected a verification exception\"");\n-         } catch (Throwable t) {\n-             DxUtil.checkVerifyException(t);\n+             new T_sput_byte_7().run();\n+             fail(\""expected IncompatibleClassChangeError\"");\n+         } catch (IncompatibleClassChangeError t) {\n          }\n     }\n-    \n+\n     /**\n      * @constraint n/a\n-     * @title Attempt to modify inaccessible field. Java throws IllegalAccessError \n-     * on first access but Dalvik throws VerifyError on class loading.\n+     * @title Attempt to modify inaccessible field.\n      */\n     public void testVFE9() {\n         //@uses dot.junit.opcodes.sput_byte.TestStubs\n         //@uses dot.junit.opcodes.sput_byte.d.T_sput_byte_8\n         try {\n-            Class.forName(\""dot.junit.opcodes.sput_byte.d.T_sput_byte_8\"");\n-            fail(\""expected a verification exception\"");\n-        } catch (Throwable t) {\n-            DxUtil.checkVerifyException(t);\n+            new T_sput_byte_8().run();\n+            fail(\""expected IllegalAccessError\"");\n+        } catch (IllegalAccessError t) {\n         }\n     }\n \n     /**\n      * @constraint n/a\n-     * @title Attempt to modify field of undefined class. Java throws NoClassDefFoundError \n-     * on first access but Dalvik throws VerifyError on class loading.\n+     * @title Attempt to modify field of undefined class.\n      */\n     public void testVFE10() {\n         try {\n-            Class.forName(\""dot.junit.opcodes.sput_byte.d.T_sput_byte_9\"");\n-            fail(\""expected a verification exception\"");\n-        } catch (Throwable t) {\n-            DxUtil.checkVerifyException(t);\n+            new T_sput_byte_9().run();\n+            fail(\""expected NoClassDefFoundError\"");\n+        } catch (NoClassDefFoundError t) {\n         }\n     }\n \n     /**\n      * @constraint n/a\n-     * @title Attempt to modify undefined field. Java throws NoSuchFieldError \n-     * on first access but Dalvik throws VerifyError on class loading.\n+     * @title Attempt to modify undefined field.\n      */\n     public void testVFE11() {\n         try {\n-            Class.forName(\""dot.junit.opcodes.sput_byte.d.T_sput_byte_10\"");\n-            fail(\""expected a verification exception\"");\n-        } catch (Throwable t) {\n-            DxUtil.checkVerifyException(t);\n+            new T_sput_byte_10().run();\n+            fail(\""expected NoSuchFieldError\"");\n+        } catch (NoSuchFieldError t) {\n         }\n     }\n-    \n-    \n-    \n+\n+\n+\n     /**\n      * @constraint n/a\n-     * @title Attempt to modify superclass' private field from subclass. Java \n-     * throws IllegalAccessError on first access but Dalvik throws VerifyError on class loading.\n+     * @title Attempt to modify superclass' private field from subclass.\n      */\n     public void testVFE12() {\n         //@uses dot.junit.opcodes.sput_byte.d.T_sput_byte_1\n         //@uses dot.junit.opcodes.sput_byte.d.T_sput_byte_15\n         try {\n-            Class.forName(\""dot.junit.opcodes.sput_byte.d.T_sput_byte_15\"");\n-            fail(\""expected a verification exception\"");\n-        } catch (Throwable t) {\n-            DxUtil.checkVerifyException(t);\n+            new T_sput_byte_15().run();\n+            fail(\""expected IllegalAccessError\"");\n+        } catch (IllegalAccessError t) {\n         }\n     }\n-    \n-    \n+\n+\n     /**\n-     * @constraint B1 \n+     * @constraint B1\n      * @title sput-byte shall not work for wide numbers\n      */\n     public void testVFE13() {\n@@ -234,10 +229,10 @@ public class Test_sput_byte extends DxTestCase {\n             DxUtil.checkVerifyException(t);\n         }\n     }\n-    \n+\n     /**\n-     * \n-     * @constraint B1 \n+     *\n+     * @constraint B1\n      * @title sput-byte shall not work for reference fields\n      */\n     public void testVFE14() {\n@@ -248,10 +243,10 @@ public class Test_sput_byte extends DxTestCase {\n             DxUtil.checkVerifyException(t);\n         }\n     }\n-    \n+\n     /**\n-     * \n-     * @constraint B1 \n+     *\n+     * @constraint B1\n      * @title sput-byte shall not work for short fields\n      */\n     public void testVFE15() {\n@@ -262,10 +257,10 @@ public class Test_sput_byte extends DxTestCase {\n             DxUtil.checkVerifyException(t);\n         }\n     }\n-    \n+\n     /**\n-     * \n-     * @constraint B1 \n+     *\n+     * @constraint B1\n      * @title sput-byte shall not work for int fields\n      */\n     public void testVFE16() {\n@@ -276,10 +271,10 @@ public class Test_sput_byte extends DxTestCase {\n             DxUtil.checkVerifyException(t);\n         }\n     }\n-    \n+\n     /**\n-     * \n-     * @constraint B1 \n+     *\n+     * @constraint B1\n      * @title sput-byte shall not work for char fields\n      */\n     public void testVFE17() {\n@@ -290,9 +285,9 @@ public class Test_sput_byte extends DxTestCase {\n             DxUtil.checkVerifyException(t);\n         }\n     }\n-    \n+\n     /**\n-     * @constraint B1 \n+     * @constraint B1\n      * @title sput-byte shall not work for boolean fields\n      */\n     public void testVFE18() {\n@@ -303,7 +298,7 @@ public class Test_sput_byte extends DxTestCase {\n             DxUtil.checkVerifyException(t);\n         }\n     }\n-    \n+\n     /**\n      * @constraint n/a\n      * @title Modification of final field in other class\n@@ -312,10 +307,9 @@ public class Test_sput_byte extends DxTestCase {\n         //@uses dot.junit.opcodes.sput_byte.TestStubs\n         //@uses dot.junit.opcodes.sput_byte.d.T_sput_byte_11\n     \ttry {\n-            Class.forName(\""dot.junit.opcodes.sput_byte.d.T_sput_byte_11\"");\n-            fail(\""expected a verification exception\"");\n-        } catch (Throwable t) {\n-            DxUtil.checkVerifyException(t);\n+            new T_sput_byte_11().run();\n+            fail(\""expected IllegalAccessError\"");\n+        } catch (IllegalAccessError t) {\n         }\n     }\n \n"", ""T_sput_byte_10.java"": ""@@ -0,0 +1,22 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package dot.junit.opcodes.sput_byte.d;\n+\n+public class T_sput_byte_10 {\n+    public void run() {\n+    }\n+}\n"", ""T_sput_byte_15.java"": ""@@ -0,0 +1,22 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package dot.junit.opcodes.sput_byte.d;\n+\n+public class T_sput_byte_15 {\n+    public void run() {\n+    }\n+}\n"", ""T_sput_byte_17.java"": ""@@ -0,0 +1,22 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package dot.junit.opcodes.sput_byte.d;\n+\n+public class T_sput_byte_17 {\n+    public void run() {\n+    }\n+}\n"", ""T_sput_byte_7.java"": ""@@ -0,0 +1,22 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package dot.junit.opcodes.sput_byte.d;\n+\n+public class T_sput_byte_7 {\n+    public void run() {\n+    }\n+}\n"", ""T_sput_byte_8.java"": ""@@ -0,0 +1,22 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package dot.junit.opcodes.sput_byte.d;\n+\n+public class T_sput_byte_8 {\n+    public void run() {\n+    }\n+}\n"", ""T_sput_byte_9.java"": ""@@ -0,0 +1,22 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package dot.junit.opcodes.sput_byte.d;\n+\n+public class T_sput_byte_9 {\n+    public void run() {\n+    }\n+}\n""}","test 
"
20632,Brian Muramatsu,Fix Bad Merge,['tests/tests/permission/src/android/permission/cts/NoActivityRelatedPermissionTest.java'],"Fix Bad Merge

My merging of Froyo changes reintroduced a test in
NoActivityRelatedPermissionTest that had already been
removed.

Change-Id: I103e615be7b32196a6eab0ad07016002fa25207c",https://android-review.googlesource.com/c/20632,"bug
","test,bug",Bug;Deprecat;Test;,"{""NoActivityRelatedPermissionTest.java"": ""@@ -22,7 +22,6 @@ import android.app.Activity;\n import android.app.ActivityManager;\n import android.content.Context;\n import android.test.ActivityInstrumentationTestCase2;\n-import android.test.UiThreadTest;\n import android.test.suitebuilder.annotation.MediumTest;\n \n /**\n@@ -44,22 +43,6 @@ public class NoActivityRelatedPermissionTest\n         mActivity = getActivity();\n     }\n \n-    /**\n-     * Verify that setting Activity's persistent attribute requires permissions.\n-     * <p>Requires Permission:\n-     *   {@link android.Manifest.permission#PERSISTENT_ACTIVITY}.\n-     */\n-    @UiThreadTest\n-    @MediumTest\n-    public void testSetPersistent() {\n-        try {\n-            mActivity.setPersistent(true);\n-            fail(\""Activity.setPersistent() did not throw SecurityException as expected\"");\n-        } catch (SecurityException e) {\n-            // Expected\n-        }\n-    }\n-\n     /**\n      * Verify that get task requires permissions.\n      * <p>Requires Permission:\n""}","merge, test 
"
20798,Brian Muramatsu,"Updated features test to check new features reported in Gingerbread to fix warning of device reporting a disallowed feature for front-facing camera, nfc, gyroscope, sip, etc).","['apps/CtsVerifier/tests/src/com/android/cts/verifier/features/FeatureSummaryActivityTest.java', 'apps/CtsVerifier/src/com/android/cts/verifier/features/FeatureSummaryActivity.java']","Updated features test to check new features reported in Gingerbread to fix warning of device reporting a disallowed feature for front-facing camera, nfc, gyroscope, sip, etc).

Change-Id: Id10bf78dd0681c739e8f313d8e602665b1bf3dcf",https://android-review.googlesource.com/c/20798,"test, bug 
","test,bug",Bug;Feature;Test;,"{""FeatureSummaryActivity.java"": ""@@ -92,8 +92,9 @@ public class FeatureSummaryActivity extends PassFailButtons.ListActivity {\n     };\n \n     /**\n-     * A list of all features added in FroYo (API=8). Because we want to run on\n-     * Eclair devices, we can't use static references to constants added later\n+     * A list of all features added in FroYo (API=8) and Gingerbread (API=9). \n+     * Because we want to run on Eclair devices, \n+     * we can't use static references to constants added later\n      * than Eclair. We could use Reflection, but we'd still need a list of\n      * string literals (for constant names) anyway, and there's little point in\n      * using Reflection to to look up a constant String value for a constant\n@@ -113,6 +114,17 @@ public class FeatureSummaryActivity extends PassFailButtons.ListActivity {\n             new Feature(\""android.hardware.wifi\"", false),\n     };\n \n+    public static final Feature[] ALL_GINGERBREAD_FEATURES = {\n+            new Feature(\""android.hardware.audio.low_latency\"", false),\n+            new Feature(\""android.hardware.camera.front\"", false),\n+            new Feature(\""android.hardware.nfc\"", false),\n+            new Feature(\""android.hardware.sensor.barometer\"", false),\n+            new Feature(\""android.hardware.sensor.gyroscope\"", false),\n+            new Feature(\""android.hardware.touchscreen.multitouch.jazzhand\"", false),\n+            new Feature(\""android.software.sip\"", false),\n+            new Feature(\""android.software.sip.voip\"", false),\n+    };\n+\n     @Override\n     public void onCreate(Bundle savedInstanceState) {\n         super.onCreate(savedInstanceState);\n@@ -147,6 +159,9 @@ public class FeatureSummaryActivity extends PassFailButtons.ListActivity {\n         if (apiVersion >= Build.VERSION_CODES.FROYO) {\n             Collections.addAll(features, ALL_FROYO_FEATURES);\n         }\n+        if (apiVersion >= Build.VERSION_CODES.GINGERBREAD) {\n+            Collections.addAll(features, ALL_GINGERBREAD_FEATURES);\n+        }\n         for (Feature f : features) {\n             HashMap<String, Object> row = new HashMap<String, Object>();\n             listViewData.add(row);\n"", ""FeatureSummaryActivityTest.java"": ""@@ -43,6 +43,11 @@ public class FeatureSummaryActivityTest extends TestCase {\n                 actualFeatures.add(feature.name);\n             }\n         }\n+        if (version >= Build.VERSION_CODES.GINGERBREAD) {\n+            for (Feature feature : FeatureSummaryActivity.ALL_GINGERBREAD_FEATURES) {\n+                actualFeatures.add(feature.name);\n+            }\n+        }\n \n         assertEquals(\""Feature list needs to be updated.\"",\n                 expectedFeatures.size(), actualFeatures.size());\n""}","test 
"
10744,Mike Lockwood,USB: musb: Fix usb_gadget_disconnect(),['drivers/usb/musb/musb_gadget.c'],"USB: musb: Fix usb_gadget_disconnect()

musb_gadget_pullup() should call stop_activity() when USB is disconnected.

Signed-off-by: Mike Lockwood <lockwood@android.com>
",https://android-review.googlesource.com/c/10744,"bug 
",bug,Bug;,"{""musb_gadget.c"": ""@@ -90,6 +90,8 @@\n \n /* ----------------------------------------------------------------------- */\n \n+static void stop_activity(struct musb *musb, struct usb_gadget_driver *driver);\n+\n /*\n  * Immediately complete a request.\n  *\n@@ -1512,10 +1514,14 @@ static int musb_gadget_pullup(struct usb_gadget *gadget, int is_on)\n \t * not pullup unless the B-session is active.\n \t */\n \tspin_lock_irqsave(&musb->lock, flags);\n-\tif (is_on != musb->softconnect) {\n-\t\tmusb->softconnect = is_on;\n-\t\tmusb_pullup(musb, is_on);\n-\t}\n+\tif (is_on) {\n+\t    if (!musb->softconnect) {\n+\t\t\tmusb->softconnect = 1;\n+\t\t\tmusb_pullup(musb, is_on);\n+\t\t}\n+\t} else\n+\t\tstop_activity(musb, musb->gadget_driver);\n+\n \tspin_unlock_irqrestore(&musb->lock, flags);\n \treturn 0;\n }\n""}","bug 
"
20953,Mike Lockwood,Fix adb leaking file descriptors to forked processes,"['adb/sysdeps.h', 'adb/jdwp_service.c', 'adb/adb.c', 'adb/services.c']","Fix adb leaking file descriptors to forked processes

accept() creates a new file descriptor that should be closed on exec so
that forked processes don't keep a fd opened on the socket.

This also fixes b/3297070 where adb hangs after running adb on the
target.

Change-Id: I8df511289e5549ae49b4824c9dfb71a3bf85eae8",https://android-review.googlesource.com/c/20953,"bug
",bug,Bug;,"{""adb.c"": ""@@ -682,9 +682,11 @@ void start_device_log(void)\n     dup2(fd, 1);\n     dup2(fd, 2);\n     fprintf(stderr,\""--- adb starting (pid %d) ---\\n\"", getpid());\n+    adb_close(fd);\n \n     fd = unix_open(\""/dev/null\"", O_RDONLY);\n     dup2(fd, 0);\n+    adb_close(fd);\n }\n #endif\n \n"", ""jdwp_service.c"": ""@@ -499,6 +499,7 @@ jdwp_control_init( JdwpControl*  control,\n \n     /* only wait for incoming connections */\n     fdevent_add(control->fde, FDE_READ);\n+    close_on_exec(s);\n \n     D(\""jdwp control socket started (%d)\\n\"", control->listen_socket);\n     return 0;\n"", ""services.c"": ""@@ -309,6 +309,7 @@ static int create_subprocess(const char *cmd, const char *arg0, const char *arg1\n         dup2(pts, 1);\n         dup2(pts, 2);\n \n+        adb_close(pts);\n         adb_close(ptm);\n \n         execl(cmd, cmd, arg0, arg1, NULL);\n"", ""sysdeps.h"": ""@@ -387,7 +387,13 @@ static __inline__  int  adb_creat(const char*  path, int  mode)\n \n static __inline__ int  adb_socket_accept(int  serverfd, struct sockaddr*  addr, socklen_t  *addrlen)\n {\n-    return  accept( serverfd, addr, addrlen );\n+    int fd;\n+\n+    fd = accept(serverfd, addr, addrlen);\n+    if (fd >= 0)\n+        close_on_exec(fd);\n+\n+    return fd;\n }\n \n #undef   accept\n""}","**bug** 
"
14724,Colin Cross,[ARM] tegra: clock: Add dsi clock,['arch/arm/mach-tegra/tegra2_clocks.c'],"[ARM] tegra: clock: Add dsi clock

Change-Id: Id7655df9b466e58896a5989ff43d9991b493efd7
Signed-off-by: Colin Cross <ccross@android.com>",https://android-review.googlesource.com/c/14724,"feature 
",feature,Feature;,"{""tegra2_clocks.c"": ""@@ -1175,6 +1175,11 @@ static struct clk_mux_sel mux_pllp_out3[] = {\n \t{ 0, 0},\n };\n \n+static struct clk_mux_sel mux_plld[] = {\n+\t{ .input = &tegra_pll_d, .value = 0},\n+\t{ 0, 0},\n+};\n+\n static struct clk_mux_sel mux_clk_32k[] = {\n \t{ .input = &tegra_clk_32k, .value = 0},\n \t{ 0, 0},\n@@ -1257,6 +1262,7 @@ struct clk tegra_periph_clks[] = {\n \tPERIPH_CLK(\""usb2\"",      \""usb.1\"",      NULL,   58, 0,     mux_clk_m,                              0),\n \tPERIPH_CLK(\""usb3\"",      \""usb.2\"",      NULL,   59, 0,     mux_clk_m,                              0),\n \tPERIPH_CLK(\""emc\"",       \""emc\"",        NULL,   57, 0x19c, mux_pllm_pllc_pllp_clkm,        MUX | DIV_U71 | PERIPH_EMC_ENB),\n+\tPERIPH_CLK(\""dsi\"",       \""dsi\"",        NULL,   48, 0, mux_plld, 0),\n };\n \n #define CLK_DUPLICATE(_name, _dev, _con) \\\n""}","bug 
"
19579,Johan Redestig,Corrected android.media.cts.AudioEffectTest#test1_0ConstructorFromType,['tests/tests/media/src/android/media/cts/AudioEffectTest.java'],"Corrected android.media.cts.AudioEffectTest#test1_0ConstructorFromType

The test case queries for all effects and then tries to recreate them
by using the type uuid of the effect. This however failed for effects
that did not implement a standard type. These effects will have their
type set to AudioEffect.EFFECT_TYPE_NULL and thus reconstruction of
them would fail. Made the test skip effects that has this NULL type.

Change-Id: I352844a473a174c2fbf7d37fc0f40923c00b957b",https://android-review.googlesource.com/c/19579,"bug,test 
","test,bug",Feature;Test;,"{""AudioEffectTest.java"": ""@@ -137,23 +137,25 @@ public class AudioEffectTest extends AndroidTestCase {\n         AudioEffect.Descriptor[] desc = AudioEffect.queryEffects();\n         assertTrue(\""no effects found\"", (desc.length != 0));\n         for (int i = 0; i < desc.length; i++) {\n-            try {\n-                AudioEffect effect = new AudioEffect(desc[i].type,\n-                        AudioEffect.EFFECT_TYPE_NULL,\n-                        0,\n-                        0);\n-                assertNotNull(\""could not create AudioEffect\"", effect);\n+            if (!desc[i].type.equals(AudioEffect.EFFECT_TYPE_NULL)) {\n                 try {\n-                    assertTrue(\""invalid effect ID\"", (effect.getId() != 0));\n-                } catch (IllegalStateException e) {\n-                    fail(\""AudioEffect not initialized\"");\n-                } finally {\n-                    effect.release();\n+                    AudioEffect effect = new AudioEffect(desc[i].type,\n+                            AudioEffect.EFFECT_TYPE_NULL,\n+                            0,\n+                            0);\n+                    assertNotNull(\""could not create AudioEffect\"", effect);\n+                    try {\n+                        assertTrue(\""invalid effect ID\"", (effect.getId() != 0));\n+                    } catch (IllegalStateException e) {\n+                        fail(\""AudioEffect not initialized\"");\n+                    } finally {\n+                        effect.release();\n+                    }\n+                } catch (IllegalArgumentException e) {\n+                    fail(\""Effect not found: \""+desc[i].name);\n+                } catch (UnsupportedOperationException e) {\n+                    fail(\""Effect library not loaded\"");\n                 }\n-            } catch (IllegalArgumentException e) {\n-                fail(\""Effect not found: \""+desc[i].name);\n-            } catch (UnsupportedOperationException e) {\n-                fail(\""Effect library not loaded\"");\n             }\n         }\n     }\n@@ -1376,4 +1378,4 @@ public class AudioEffectTest extends AndroidTestCase {\n         }\n     }\n \n-}\n\\ No newline at end of file\n+}\n""}","test,bug 
"
19348,Xavier Ducrohet,LayoutLib API: new log API + updated SceneStatus API.,"['layoutlib_api/src/com/android/layoutlib/api/LayoutLog.java', 'layoutlib_api/src/com/android/layoutlib/api/SceneResult.java', 'layoutlib_api/src/com/android/layoutlib/api/SceneParams.java', 'layoutlib_api/src/com/android/layoutlib/api/ILayoutLog.java', 'layoutlib_api/src/com/android/layoutlib/api/LayoutScene.java', 'ide_common/src/com/android/ide/common/layoutlib/LayoutBridgeWrapper.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/GraphicalEditorPart.java']","LayoutLib API: new log API + updated SceneStatus API.

Change-Id: I8fe107397c2322cca979e7953d2be5933a59d0bf",https://android-review.googlesource.com/c/19348,"feature, refactor 
",feature,Feature;,"{""GraphicalEditorPart.java"": ""@@ -47,10 +47,10 @@ import com.android.ide.eclipse.adt.internal.sdk.AndroidTargetData;\n import com.android.ide.eclipse.adt.internal.sdk.Sdk;\n import com.android.ide.eclipse.adt.internal.sdk.Sdk.ITargetChangeListener;\n import com.android.ide.eclipse.adt.io.IFileWrapper;\n-import com.android.layoutlib.api.ILayoutLog;\n import com.android.layoutlib.api.IResourceValue;\n import com.android.layoutlib.api.IXmlPullParser;\n import com.android.layoutlib.api.LayoutBridge;\n+import com.android.layoutlib.api.LayoutLog;\n import com.android.layoutlib.api.LayoutScene;\n import com.android.layoutlib.api.SceneParams;\n import com.android.layoutlib.api.SceneParams.RenderingMode;\n@@ -187,7 +187,7 @@ public class GraphicalEditorPart extends EditorPart\n     private Map<String, Map<String, IResourceValue>> mConfiguredFrameworkRes;\n     private Map<String, Map<String, IResourceValue>> mConfiguredProjectRes;\n     private ProjectCallback mProjectCallback;\n-    private ILayoutLog mLogger;\n+    private LayoutLog mLog;\n \n     private boolean mNeedsRecompute = false;\n \n@@ -1018,7 +1018,7 @@ public class GraphicalEditorPart extends EditorPart\n                 // no root view yet indicates success and then update the canvas with it.\n \n                 mCanvasViewer.getCanvas().setResult(\n-                        new BasicLayoutScene(SceneStatus.SUCCESS.getResult(),\n+                        new BasicLayoutScene(SceneStatus.SUCCESS.createResult(),\n                                 null /*rootViewInfo*/, null /*image*/),\n                         null /*explodeNodes*/);\n                 return;\n@@ -1331,23 +1331,34 @@ public class GraphicalEditorPart extends EditorPart\n         }\n \n         // Lazily create the logger the first time we need it\n-        if (mLogger == null) {\n-            mLogger = new ILayoutLog() {\n-                public void error(String message) {\n+        if (mLog == null) {\n+            mLog = new LayoutLog() {\n+                @Override\n+                public void error(String tag, String message) {\n                     AdtPlugin.printErrorToConsole(mEditedFile.getName(), message);\n                 }\n \n-                public void error(Throwable error) {\n-                    String message = error.getMessage();\n+                @Override\n+                public void error(String tag, Throwable throwable) {\n+                    String message = throwable.getMessage();\n                     if (message == null) {\n-                        message = error.getClass().getName();\n+                        message = throwable.getClass().getName();\n                     }\n \n                     PrintStream ps = new PrintStream(AdtPlugin.getErrorStream());\n-                    error.printStackTrace(ps);\n+                    throwable.printStackTrace(ps);\n                 }\n \n-                public void warning(String message) {\n+                @Override\n+                public void error(String tag, String message, Throwable throwable) {\n+                    AdtPlugin.printErrorToConsole(mEditedFile.getName(), message);\n+\n+                    PrintStream ps = new PrintStream(AdtPlugin.getErrorStream());\n+                    throwable.printStackTrace(ps);\n+                }\n+\n+                @Override\n+                public void warning(String tag, String message) {\n                     AdtPlugin.printToConsole(mEditedFile.getName(), message);\n                 }\n             };\n@@ -1435,7 +1446,7 @@ public class GraphicalEditorPart extends EditorPart\n                 density, xdpi, ydpi,\n                 theme, isProjectTheme,\n                 configuredProjectRes, frameworkResources, mProjectCallback,\n-                mLogger);\n+                mLog);\n \n         if (transparentBackground) {\n             // It doesn't matter what the background color is as long as the alpha\n"", ""LayoutBridgeWrapper.java"": ""@@ -17,8 +17,10 @@\n package com.android.ide.common.layoutlib;\n \n import com.android.layoutlib.api.ILayoutBridge;\n+import com.android.layoutlib.api.ILayoutLog;\n import com.android.layoutlib.api.ILayoutResult;\n import com.android.layoutlib.api.LayoutBridge;\n+import com.android.layoutlib.api.LayoutLog;\n import com.android.layoutlib.api.LayoutScene;\n import com.android.layoutlib.api.SceneParams;\n import com.android.layoutlib.api.SceneResult;\n@@ -78,6 +80,23 @@ class LayoutBridgeWrapper extends LayoutBridge {\n     public LayoutScene createScene(SceneParams params) {\n         int apiLevel = mBridge.getApiLevel();\n \n+        // create a log wrapper since the older api requires a ILayoutLog\n+        final LayoutLog log = params.getLog();\n+        ILayoutLog logWrapper = new ILayoutLog() {\n+\n+            public void warning(String message) {\n+                log.warning(null, message);\n+            }\n+\n+            public void error(Throwable t) {\n+                log.error(null, t);\n+            }\n+\n+            public void error(String message) {\n+                log.error(null, message);\n+            }\n+        };\n+\n         ILayoutResult result = null;\n \n         if (apiLevel == 4) {\n@@ -89,7 +108,7 @@ class LayoutBridgeWrapper extends LayoutBridge {\n                     params.getDensity(), params.getXdpi(), params.getYdpi(),\n                     params.getThemeName(), params.getIsProjectTheme(),\n                     params.getProjectResources(), params.getFrameworkResources(),\n-                    params.getProjectCallback(), params.getLogger());\n+                    params.getProjectCallback(), logWrapper);\n         } else if (apiLevel == 3) {\n             // api 3 add density support.\n             result = mBridge.computeLayout(\n@@ -98,7 +117,7 @@ class LayoutBridgeWrapper extends LayoutBridge {\n                     params.getDensity(), params.getXdpi(), params.getYdpi(),\n                     params.getThemeName(), params.getIsProjectTheme(),\n                     params.getProjectResources(), params.getFrameworkResources(),\n-                    params.getProjectCallback(), params.getLogger());\n+                    params.getProjectCallback(), logWrapper);\n         } else if (apiLevel == 2) {\n             // api 2 added boolean for separation of project/framework theme\n             result = mBridge.computeLayout(\n@@ -106,7 +125,7 @@ class LayoutBridgeWrapper extends LayoutBridge {\n                     params.getScreenWidth(), params.getScreenHeight(),\n                     params.getThemeName(), params.getIsProjectTheme(),\n                     params.getProjectResources(), params.getFrameworkResources(),\n-                    params.getProjectCallback(), params.getLogger());\n+                    params.getProjectCallback(), logWrapper);\n         } else {\n             // First api with no density/dpi, and project theme boolean mixed\n             // into the theme name.\n@@ -123,7 +142,7 @@ class LayoutBridgeWrapper extends LayoutBridge {\n                     params.getScreenWidth(), params.getScreenHeight(),\n                     themeName,\n                     params.getProjectResources(), params.getFrameworkResources(),\n-                    params.getProjectCallback(), params.getLogger());\n+                    params.getProjectCallback(), logWrapper);\n         }\n \n         // clean up that is not done by the ILayoutBridge itself\n@@ -147,10 +166,10 @@ class LayoutBridgeWrapper extends LayoutBridge {\n         ViewInfo rootViewInfo;\n \n         if (result.getSuccess() == ILayoutResult.SUCCESS) {\n-            sceneResult = SceneStatus.SUCCESS.getResult();\n+            sceneResult = SceneStatus.SUCCESS.createResult();\n             rootViewInfo = convertToViewInfo(result.getRootView());\n         } else {\n-            sceneResult = SceneStatus.ERROR_UNKNOWN.getResult(result.getErrorMessage());\n+            sceneResult = SceneStatus.ERROR_UNKNOWN.createResult(result.getErrorMessage());\n             rootViewInfo = null;\n         }\n \n"", ""ILayoutLog.java"": ""@@ -18,25 +18,27 @@ package com.android.layoutlib.api;\n \n /**\n  * Callback interface to display warnings/errors that happened during the computation and\n- * rendering of the layout. \n+ * rendering of the layout.\n+ * @deprecated use {@link LayoutLog}.\n  */\n+@Deprecated\n public interface ILayoutLog {\n-    \n+\n     /**\n-     * Displays a warning message.\n-     * @param message the message to display.\n+     * Logs a warning message.\n+     * @param message the message to log.\n      */\n     void warning(String message);\n-    \n+\n     /**\n-     * Displays an error message.\n-     * @param message the message to display.\n+     * Logs an error message.\n+     * @param message the message to log.\n      */\n     void error(String message);\n-    \n+\n     /**\n-     * Displays an exception\n-     * @param t the {@link Throwable} to display.\n+     * Logs an exception\n+     * @param t the {@link Throwable} to log.\n      */\n     void error(Throwable t);\n }\n"", ""LayoutLog.java"": ""@@ -0,0 +1,38 @@\n+/*\n+ * Copyright (C) 2010 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.android.layoutlib.api;\n+\n+public class LayoutLog {\n+\n+    public void error(String tag, String message) {\n+    }\n+\n+    public void error(String tag, Throwable t) {\n+    }\n+\n+    public void warning(String tag, String message) {\n+    }\n+\n+    /**\n+     * Logs an error message and a {@link Throwable}.\n+     * @param message the message to log.\n+     * @param throwable the {@link Throwable} to log.\n+     */\n+    public void error(String tag, String message, Throwable throwable) {\n+\n+    }\n+}\n"", ""LayoutScene.java"": ""@@ -65,7 +65,7 @@ public class LayoutScene {\n      * Returns the last operation result.\n      */\n     public SceneResult getResult() {\n-        return NOT_IMPLEMENTED.getResult();\n+        return NOT_IMPLEMENTED.createResult();\n     }\n \n     /**\n@@ -134,7 +134,7 @@ public class LayoutScene {\n      * @return a {@link SceneResult} indicating the status of the action.\n      */\n     public SceneResult render(long timeout) {\n-        return NOT_IMPLEMENTED.getResult();\n+        return NOT_IMPLEMENTED.createResult();\n     }\n \n     /**\n@@ -152,7 +152,7 @@ public class LayoutScene {\n      * @return a {@link SceneResult} indicating the status of the action.\n      */\n     public SceneResult setProperty(Object objectView, String propertyName, String propertyValue) {\n-        return NOT_IMPLEMENTED.getResult();\n+        return NOT_IMPLEMENTED.createResult();\n     }\n \n     /**\n@@ -182,7 +182,7 @@ public class LayoutScene {\n      */\n     public SceneResult insertChild(Object parentView, IXmlPullParser childXml, int index,\n             IAnimationListener listener) {\n-        return NOT_IMPLEMENTED.getResult();\n+        return NOT_IMPLEMENTED.createResult();\n     }\n \n     /**\n@@ -218,7 +218,7 @@ public class LayoutScene {\n      */\n     public SceneResult moveChild(Object parentView, Object childView, int index,\n             Map<String, String> layoutParams, IAnimationListener listener) {\n-        return NOT_IMPLEMENTED.getResult();\n+        return NOT_IMPLEMENTED.createResult();\n     }\n \n     /**\n@@ -235,7 +235,7 @@ public class LayoutScene {\n      * @return a {@link SceneResult} indicating the status of the action.\n      */\n     public SceneResult removeChild(Object childView, IAnimationListener listener) {\n-        return NOT_IMPLEMENTED.getResult();\n+        return NOT_IMPLEMENTED.createResult();\n     }\n \n     /**\n@@ -252,7 +252,7 @@ public class LayoutScene {\n      */\n     public SceneResult animate(Object targetObject, String animationName,\n             boolean isFrameworkAnimation, IAnimationListener listener) {\n-        return NOT_IMPLEMENTED.getResult();\n+        return NOT_IMPLEMENTED.createResult();\n     }\n \n     /**\n"", ""SceneParams.java"": ""@@ -58,7 +58,7 @@ public class SceneParams {\n     private Map<String, Map<String, IResourceValue>> mProjectResources;\n     private Map<String, Map<String, IResourceValue>> mFrameworkResources;\n     private IProjectCallback mProjectCallback;\n-    private ILayoutLog mLogger;\n+    private LayoutLog mLog;\n \n     private boolean mCustomBackgroundEnabled;\n     private int mCustomBackgroundColor;\n@@ -89,7 +89,7 @@ public class SceneParams {\n      * value is the resource value.\n      * @param projectCallback The {@link IProjectCallback} object to get information from\n      * the project.\n-     * @param logger the object responsible for displaying warning/errors to the user.\n+     * @param log the object responsible for displaying warning/errors to the user.\n      */\n     public SceneParams(IXmlPullParser layoutDescription,\n             Object projectKey,\n@@ -98,7 +98,7 @@ public class SceneParams {\n             String themeName, boolean isProjectTheme,\n             Map<String, Map<String, IResourceValue>> projectResources,\n             Map<String, Map<String, IResourceValue>> frameworkResources,\n-            IProjectCallback projectCallback, ILayoutLog logger) {\n+            IProjectCallback projectCallback, LayoutLog log) {\n         mLayoutDescription = layoutDescription;\n         mProjectKey = projectKey;\n         mScreenWidth = screenWidth;\n@@ -112,7 +112,7 @@ public class SceneParams {\n         mProjectResources = projectResources;\n         mFrameworkResources = frameworkResources;\n         mProjectCallback = projectCallback;\n-        mLogger = logger;\n+        mLog = log;\n         mCustomBackgroundEnabled = false;\n         mTimeout = DEFAULT_TIMEOUT;\n     }\n@@ -134,7 +134,7 @@ public class SceneParams {\n         mProjectResources = params.mProjectResources;\n         mFrameworkResources = params.mFrameworkResources;\n         mProjectCallback = params.mProjectCallback;\n-        mLogger = params.mLogger;\n+        mLog = params.mLog;\n         mCustomBackgroundEnabled = params.mCustomBackgroundEnabled;\n         mCustomBackgroundColor = params.mCustomBackgroundColor;\n         mTimeout = params.mTimeout;\n@@ -206,8 +206,8 @@ public class SceneParams {\n         return mProjectCallback;\n     }\n \n-    public ILayoutLog getLogger() {\n-        return mLogger;\n+    public LayoutLog getLog() {\n+        return mLog;\n     }\n \n     public boolean isCustomBackgroundEnabled() {\n"", ""SceneResult.java"": ""@@ -54,7 +54,7 @@ public class SceneResult {\n          * Returns a {@link SceneResult} object with this status.\n          * @return an instance of SceneResult;\n          */\n-        public SceneResult getResult() {\n+        public SceneResult createResult() {\n             // don't want to get generic error that way.\n             assert this != ERROR_UNKNOWN;\n \n@@ -71,8 +71,8 @@ public class SceneResult {\n          *\n          * @see SceneResult#getData()\n          */\n-        public SceneResult getResult(Object data) {\n-            SceneResult res = getResult();\n+        public SceneResult createResult(Object data) {\n+            SceneResult res = createResult();\n \n             if (data != null) {\n                 res = res.getCopyWithData(data);\n@@ -87,7 +87,7 @@ public class SceneResult {\n          * @param throwable the throwable\n          * @return an instance of SceneResult.\n          */\n-        public SceneResult getResult(String errorMessage, Throwable throwable) {\n+        public SceneResult createResult(String errorMessage, Throwable throwable) {\n             return new SceneResult(this, errorMessage, throwable);\n         }\n \n@@ -96,7 +96,7 @@ public class SceneResult {\n          * @param errorMessage the error message\n          * @return an instance of SceneResult.\n          */\n-        public SceneResult getResult(String errorMessage) {\n+        public SceneResult createResult(String errorMessage) {\n             return new SceneResult(this, errorMessage, null /*throwable*/);\n         }\n     }\n""}","feature 
"
20817,Xavier Ducrohet,Refactor aidl handling in its own class.,"['testapps/basicProjectWithAidl/build.xml', 'testapps/basicProjectWithAidl/.project', 'testapps/basicProjectWithAidl/build.properties', 'testapps/basicProjectWithAidl/res/drawable/icon.png', 'testapps/basicProjectWithAidl/res/layout/main.xml', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/build/builders/BaseBuilder.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/build/builders/PreCompilerDeltaVisitor.java', 'testapps/basicProjectWithAidl/src/com/android/tests/basicprojectwithaidl/Rect.java', 'testapps/basicProjectWithAidl/src/com/android/tests/basicprojectwithaidl/Rect.aidl', 'testapps/basicProjectWithAidl/.classpath', 'testapps/basicProjectWithAidl/default.properties', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/build/JavaGenerator.java', 'testapps/basicProjectWithAidl/res/values/strings.xml', 'testapps/basicProjectWithAidl/AndroidManifest.xml', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/build/builders/PreCompilerBuilder.java', 'testapps/basicProjectWithAidl/src/com/android/tests/basicprojectwithaidl/Main.java', 'testapps/basicProjectWithAidl/src/com/android/tests/basicprojectwithaidl/ITest.aidl', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/build/AidlGenerator.java']","Refactor aidl handling in its own class.

It extends a new base class that will serve as a base
class for the one handling renderscript files.

Change-Id: Ibef0c4b9a792fe52bf7b70bf5d24f76a15cb65c9",https://android-review.googlesource.com/c/20817,"refactor
",refactor,Refactoring;,,"refactor 
"
21913,Brian Muramatsu,Increase time interval in points provided to VelocityTracker,['tests/tests/view/src/android/view/cts/VelocityTrackerTest.java'],"Increase time interval in points provided to VelocityTracker

There are cases where motion events arrive at VelocityTracker very close
together in time (~1 ms), even though they are generated by hardware with
much more time between then (~10 ms).  In these cases, VelocityTracker can
be tweaked to treat these points with more time between them, to prevent
wildly incorrect velocities from being calculated.

Tweak the CTS test case to validate VelocityTracker with more realistic
time deltas between points.

Change-Id: I35137ad4ca6223aee0cbba5650672a04f7cea831",https://android-review.googlesource.com/c/21913,"test 
",test,Test;,"{""VelocityTrackerTest.java"": ""@@ -96,10 +96,10 @@ public class VelocityTrackerTest extends AndroidTestCase {\n         VelocityTracker vt = VelocityTracker.obtain();\n         assertNotNull(vt);\n \n-        MotionEvent me = MotionEvent.obtain(0L, 1, 1, .0f, .0f, 0);\n+        MotionEvent me = MotionEvent.obtain(0L, 10, 1, .0f, .0f, 0);\n \n         vt.clear();\n-        me.addBatch(2L, 2, 2, .0f, .0f, 0);\n+        me.addBatch(20L, 20, 20, .0f, .0f, 0);\n         vt.addMovement(me);\n         vt.computeCurrentVelocity(1);\n         XVelocity = 2.0f;\n@@ -112,7 +112,7 @@ public class VelocityTrackerTest extends AndroidTestCase {\n         assertEquals(XVelocity, vt.getXVelocity(), ERROR_TOLERANCE);\n         assertEquals(YVelocity, vt.getYVelocity(), ERROR_TOLERANCE);\n \n-        for (int i = 3; i < 10; i++) {\n+        for (int i = 30; i < 100; i += 10) {\n             me.addBatch((long)i, (float)i, (float)i, .0f, .0f, 0);\n         }\n         vt.clear();\n@@ -124,7 +124,7 @@ public class VelocityTrackerTest extends AndroidTestCase {\n         assertEquals(YVelocity, vt.getYVelocity(), ERROR_TOLERANCE);\n \n         vt.clear();\n-        me.addBatch(10L, 10, 10, .0f, .0f, 0);\n+        me.addBatch(100L, 100, 100, .0f, .0f, 0);\n         vt.addMovement(me);\n         vt.computeCurrentVelocity(1);\n         XVelocity = 1.1562872f;\n""}","test,bug 
"
20646,Haris Peco,Binary XML editor,"['eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/binedit/XmlStorageEditorInput.java', 'eclipse/plugins/com.android.ide.eclipse.adt/plugin.xml', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/binedit/BinaryXMLDescriber.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/binedit/BinaryXMLMultiPageEditorPart.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/binedit/FileStorage.java']","Binary XML editor

The change enable to review xml files from the android.jar file.
It works so that actually open file from <SDK_HOME>/android-<APILEVEL>/data.
See http://code.google.com/p/android/issues/detail?id=13956 and
http://code.google.com/p/adt-addons/ for more details.

Change-Id: I8596f0d3ca5477a12dc25f551243f125f8e6ba7e",https://android-review.googlesource.com/c/20646,"feature 
",feature,Feature;,"{""plugin.xml"": ""@@ -902,4 +902,25 @@\n             commandId=\""com.android.ide.eclipse.adt.launch.LaunchShortcut.run\""\n             schemeId=\""org.eclipse.ui.defaultAcceleratorConfiguration\""/>\n    </extension>\n+   <extension point=\""org.eclipse.core.contenttype.contentTypes\"">  \n+    <content-type id=\""com.android.ide.eclipse.adt.binaryXml\"" name=\""Android Binary XML\""\n+        priority=\""high\""             \n+        file-extensions=\""xml\"">        \n+        <describer\n+            class=\""com.android.ide.eclipse.adt.binedit.BinaryXMLDescriber\"">\n+        </describer>\n+    </content-type>\n+  </extension>\n+  <extension point=\""org.eclipse.ui.editors\"">\n+        <editor\n+            name=\""Android Binary XML editor\""\n+            icon=\""$nl$/icons/android_file.png\""\n+            contributorClass=\""org.eclipse.wst.xml.ui.internal.tabletree.XMLMultiPageEditorActionBarContributor\""\n+            class=\""com.android.ide.eclipse.adt.binedit.BinaryXMLMultiPageEditorPart\""\n+            symbolicFontName=\""org.eclipse.wst.sse.ui.textfont\""\n+            id=\""com.android.ide.eclipse.adt.binedit.BinaryXMLMultiPageEditorPart\"">\n+            <contentTypeBinding\n+                contentTypeId=\""com.android.ide.eclipse.adt.binaryXml\"" />\n+        </editor>\n+    </extension>\n </plugin>\n"", ""BinaryXMLDescriber.java"": ""@@ -0,0 +1,64 @@\n+/*\n+ * Copyright (C) 2011 The Android Open Source Project\n+ *\n+ * Licensed under the Eclipse Public License, Version 1.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.eclipse.org/org/documents/epl-v10.php\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.android.ide.eclipse.adt.binedit;\n+\n+import org.eclipse.core.runtime.QualifiedName;\n+import org.eclipse.core.runtime.content.IContentDescriber;\n+import org.eclipse.core.runtime.content.IContentDescription;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.ByteBuffer;\n+import java.nio.ByteOrder;\n+\n+public class BinaryXMLDescriber implements IContentDescriber {\n+\n+    private static final int RES_XML_HEADER_SIZE = 8;\n+    private final static short RES_XML_TYPE = 0x0003;\n+\n+    /*\n+     * (non-Javadoc)\n+     * @see org.eclipse.core.runtime.content.IContentDescriber#describe(java.io.\n+     * InputStream, org.eclipse.core.runtime.content.IContentDescription)\n+     */\n+    public int describe(InputStream contents, IContentDescription description) throws IOException {\n+        int length = 8;\n+        byte[] bytes = new byte[length];\n+        if (contents.read(bytes, 0, length) != length) {\n+            return INVALID;\n+        }\n+        ByteBuffer buf = ByteBuffer.wrap(bytes);\n+        buf.order(ByteOrder.LITTLE_ENDIAN);\n+        short type = buf.getShort();\n+        short headerSize = buf.getShort();\n+        buf.getInt(); // chunk size\n+        if (type == RES_XML_TYPE && headerSize == RES_XML_HEADER_SIZE) {\n+            return VALID;\n+        }\n+        return INVALID;\n+    }\n+\n+    /*\n+     * (non-Javadoc)\n+     * @see\n+     * org.eclipse.core.runtime.content.IContentDescriber#getSupportedOptions()\n+     */\n+    public QualifiedName[] getSupportedOptions() {\n+        return new QualifiedName[0];\n+    }\n+\n+}\n"", ""BinaryXMLMultiPageEditorPart.java"": ""@@ -0,0 +1,71 @@\n+/*\n+ * Copyright (C) 2011 The Android Open Source Project\n+ *\n+ * Licensed under the Eclipse Public License, Version 1.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.eclipse.org/org/documents/epl-v10.php\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.android.ide.eclipse.adt.binedit;\n+\n+import com.android.ide.eclipse.adt.AdtPlugin;\n+\n+import org.eclipse.core.resources.IStorage;\n+import org.eclipse.core.runtime.IPath;\n+import org.eclipse.jdt.core.IPackageFragmentRoot;\n+import org.eclipse.jdt.internal.core.JarEntryFile;\n+import org.eclipse.jdt.internal.ui.javaeditor.JarEntryEditorInput;\n+import org.eclipse.ui.IEditorInput;\n+import org.eclipse.wst.xml.ui.internal.tabletree.XMLMultiPageEditorPart;\n+\n+import java.io.File;\n+\n+public class BinaryXMLMultiPageEditorPart extends XMLMultiPageEditorPart {\n+\n+    @Override\n+    protected void setInput(IEditorInput input) {\n+        if (input instanceof JarEntryEditorInput) {\n+            JarEntryEditorInput jarInput = (JarEntryEditorInput) input;\n+            IStorage storage = jarInput.getStorage();\n+            if (storage instanceof JarEntryFile) {\n+                JarEntryFile jarEntryFile = (JarEntryFile) storage;\n+                IPackageFragmentRoot fragmentRoot = jarEntryFile.getPackageFragmentRoot();\n+                if (fragmentRoot == null) {\n+                    super.setInput(input);\n+                    return;\n+                }\n+                IPath path = fragmentRoot.getPath();\n+                if (path == null) {\n+                    super.setInput(input);\n+                    return;\n+                }\n+                path = path.removeLastSegments(1);\n+                IPath filePath = path.append(\""data\"").append(\n+                        jarEntryFile.getFullPath().toPortableString());\n+                File file = new File(filePath.toOSString());\n+                if (!(file.isFile())) {\n+                    super.setInput(input);\n+                    return;\n+                }\n+                try {\n+                    XmlStorageEditorInput newInput = new XmlStorageEditorInput(\n+                            new FileStorage(file));\n+                    super.setInput(newInput);\n+                    return;\n+                } catch (Exception e) {\n+                    AdtPlugin.log(e, e.getMessage(), null);\n+                }\n+            }\n+        }\n+        super.setInput(input);\n+    }\n+\n+}\n"", ""FileStorage.java"": ""@@ -0,0 +1,73 @@\n+/*\n+ * Copyright (C) 2011 The Android Open Source Project\n+ *\n+ * Licensed under the Eclipse Public License, Version 1.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.eclipse.org/org/documents/epl-v10.php\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.android.ide.eclipse.adt.binedit;\n+\n+import com.android.ide.eclipse.adt.AdtPlugin;\n+\n+import org.eclipse.core.resources.IStorage;\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IPath;\n+import org.eclipse.core.runtime.IStatus;\n+import org.eclipse.core.runtime.Path;\n+import org.eclipse.core.runtime.Status;\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.InputStream;\n+\n+public class FileStorage implements IStorage {\n+\n+    private File mFile = null;\n+\n+    public FileStorage(File file) {\n+        mFile = file;\n+    }\n+\n+    public boolean equals(Object obj) {\n+        if (obj instanceof FileStorage) {\n+            return mFile.equals(((FileStorage) obj).mFile);\n+        }\n+        return super.equals(obj);\n+    }\n+\n+    public InputStream getContents() throws CoreException {\n+        InputStream stream = null;\n+        try {\n+            stream = new FileInputStream(mFile);\n+        } catch (Exception e) {\n+            throw new CoreException(new Status(IStatus.ERROR, AdtPlugin.getDefault().getBundle()\n+                    .getSymbolicName(), IStatus.ERROR, mFile.getAbsolutePath(), e));\n+        }\n+        return stream;\n+    }\n+\n+    public IPath getFullPath() {\n+        return new Path(mFile.getAbsolutePath());\n+    }\n+\n+    public String getName() {\n+        return mFile.getName();\n+    }\n+\n+    public boolean isReadOnly() {\n+        return true;\n+    }\n+\n+    public Object getAdapter(Class adapter) {\n+        return null;\n+    }\n+}\n"", ""XmlStorageEditorInput.java"": ""@@ -0,0 +1,69 @@\n+/*\n+ * Copyright (C) 2011 The Android Open Source Project\n+ *\n+ * Licensed under the Eclipse Public License, Version 1.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.eclipse.org/org/documents/epl-v10.php\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.android.ide.eclipse.adt.binedit;\n+\n+import org.eclipse.core.resources.IStorage;\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.jface.resource.ImageDescriptor;\n+import org.eclipse.ui.IPersistableElement;\n+import org.eclipse.ui.IStorageEditorInput;\n+\n+public class XmlStorageEditorInput implements IStorageEditorInput {\n+\n+    IStorage mStorage = null;\n+\n+    public XmlStorageEditorInput(IStorage storage) {\n+        mStorage = storage;\n+    }\n+\n+    public IStorage getStorage() throws CoreException {\n+        return mStorage;\n+    }\n+\n+    public boolean exists() {\n+        return mStorage != null;\n+    }\n+\n+    public boolean equals(Object obj) {\n+        if (obj instanceof XmlStorageEditorInput) {\n+            return mStorage.equals(((XmlStorageEditorInput) obj).mStorage);\n+        }\n+        return super.equals(obj);\n+    }\n+\n+    public ImageDescriptor getImageDescriptor() {\n+        return null;\n+    }\n+\n+    public String getName() {\n+        return mStorage.getName();\n+    }\n+\n+    public IPersistableElement getPersistable() {\n+        return null;\n+    }\n+\n+    public String getToolTipText() {\n+        return mStorage.getFullPath() != null ? mStorage.getFullPath().toString() : mStorage\n+                .getName();\n+    }\n+\n+    public Object getAdapter(Class adapter) {\n+        return null;\n+    }\n+\n+}\n""}","feature, bug 
"
23438,Arve HjÃ¸nnevÃ¥g,ARM: etm: Don't try to clear the buffer full status after reading the buffer,['arch/arm/kernel/etm.c'],"ARM: etm: Don't try to clear the buffer full status after reading the buffer

If the write address was at the end of the buffer, toggling the trace
capture bit would set the RAM-full status instead of clearing it, and
if any of the stop bits in the formatter is set toggling the trace
capture bit may not do anything.

Instead use the read position to find out if the data has already
been returned.

This also fixes the read function so it works when the trace buffer is
larger than the buffer passed in from user space. The old version
would reset the trace buffer pointers after every read, so the second
call to read would always return 0.

Change-Id: I75256abe2556adfd66fd5963e46f9e84ae4645e1
Signed-off-by: Arve HjÃ¸nnevÃ¥g <arve@android.com>",https://android-review.googlesource.com/c/23438,"bug, feature
",bug,Bug;,"{""etm.c"": ""@@ -91,6 +91,7 @@ static int trace_start(struct tracectx *t)\n \n \tetb_unlock(t);\n \n+\tetb_writel(t, 0, ETBR_WRITEADDR);\n \tetb_writel(t, 0, ETBR_FORMATTERCTRL);\n \tetb_writel(t, 1, ETBR_CTRL);\n \n@@ -184,24 +185,15 @@ static int trace_stop(struct tracectx *t)\n static int etb_getdatalen(struct tracectx *t)\n {\n \tu32 v;\n-\tint rp, wp;\n+\tint wp;\n \n \tv = etb_readl(t, ETBR_STATUS);\n \n \tif (v & 1)\n \t\treturn t->etb_bufsz;\n \n-\trp = etb_readl(t, ETBR_READADDR);\n \twp = etb_readl(t, ETBR_WRITEADDR);\n-\n-\tif (rp > wp) {\n-\t\tetb_writel(t, 0, ETBR_READADDR);\n-\t\tetb_writel(t, 0, ETBR_WRITEADDR);\n-\n-\t\treturn 0;\n-\t}\n-\n-\treturn wp - rp;\n+\treturn wp;\n }\n \n /* sysrq+v will always stop the running trace and leave it at that */\n@@ -234,14 +226,6 @@ static void etm_dump(void)\n \t\tprintk(\""%08x\"", cpu_to_be32(etb_readl(t, ETBR_READMEM)));\n \tprintk(KERN_INFO \""\\n--- ETB buffer end ---\\n\"");\n \n-\t/* deassert the overflow bit */\n-\tetb_writel(t, 1, ETBR_CTRL);\n-\tetb_writel(t, 0, ETBR_CTRL);\n-\n-\tetb_writel(t, 0, ETBR_TRIGGERCOUNT);\n-\tetb_writel(t, 0, ETBR_READADDR);\n-\tetb_writel(t, 0, ETBR_WRITEADDR);\n-\n \tetb_lock(t);\n }\n \n@@ -275,6 +259,10 @@ static ssize_t etb_read(struct file *file, char __user *data,\n \tstruct tracectx *t = file->private_data;\n \tu32 first = 0;\n \tu32 *buf;\n+\tint wpos;\n+\tint skip;\n+\tlong wlength;\n+\tloff_t pos = *ppos;\n \n \tmutex_lock(&t->mutex);\n \n@@ -289,28 +277,34 @@ static ssize_t etb_read(struct file *file, char __user *data,\n \tif (total == t->etb_bufsz)\n \t\tfirst = etb_readl(t, ETBR_WRITEADDR);\n \n+\tif (pos > total * 4) {\n+\t\tskip = 0;\n+\t\twpos = total;\n+\t} else {\n+\t\tskip = (int)pos % 4;\n+\t\twpos = (int)pos / 4;\n+\t}\n+\ttotal -= wpos;\n+\tfirst = (first + wpos) % t->etb_bufsz;\n+\n \tetb_writel(t, first, ETBR_READADDR);\n \n-\tlength = min(total * 4, (int)len);\n-\tbuf = vmalloc(length);\n+\twlength = min(total, DIV_ROUND_UP(skip + (int)len, 4));\n+\tlength = min(total * 4 - skip, (int)len);\n+\tbuf = vmalloc(wlength * 4);\n \n-\tdev_dbg(t->dev, \""ETB buffer length: %d\\n\"", total);\n+\tdev_dbg(t->dev, \""ETB read %ld bytes to %lld from %ld words at %d\\n\"",\n+\t\tlength, pos, wlength, first);\n+\tdev_dbg(t->dev, \""ETB buffer length: %d\\n\"", total + wpos);\n \tdev_dbg(t->dev, \""ETB status reg: %x\\n\"", etb_readl(t, ETBR_STATUS));\n-\tfor (i = 0; i < length / 4; i++)\n+\tfor (i = 0; i < wlength; i++)\n \t\tbuf[i] = etb_readl(t, ETBR_READMEM);\n \n-\t/* the only way to deassert overflow bit in ETB status is this */\n-\tetb_writel(t, 1, ETBR_CTRL);\n-\tetb_writel(t, 0, ETBR_CTRL);\n-\n-\tetb_writel(t, 0, ETBR_WRITEADDR);\n-\tetb_writel(t, 0, ETBR_READADDR);\n-\tetb_writel(t, 0, ETBR_TRIGGERCOUNT);\n-\n \tetb_lock(t);\n \n-\tlength -= copy_to_user(data, buf, length);\n+\tlength -= copy_to_user(data, (u8 *)buf + skip, length);\n \tvfree(buf);\n+\t*ppos = pos + length;\n \n out:\n \tmutex_unlock(&t->mutex);\n""}","bug, refactor 
"
20085,RaphaÃ«l Moll,"Merge ""Fix android.bat to properly cd to temp dir"" in tools_r9.",['sdkmanager/app/etc/android.bat'],"Merge ""Fix android.bat to properly cd to temp dir"" in tools_r9.

Fixes an issue when the SDK is not on the same drive
than the temp dir that android.bat uses.
Reported on http://code.google.com/p/android/issues/detail?id=4410

Change-Id: Ie89f77b92aaa1219f1b77aa8f8d4117e715d4533",https://android-review.googlesource.com/c/20085,"bug, merge 
","bug,merge",Merge;Resource;,"{""android.bat"": ""@@ -62,7 +62,7 @@ if not \""%1\""==\""\"" goto EndTempCopy\n \r\n     rem jar_path and swt_path are relative to PWD so we don't need to adjust them, just change dirs.\r\n     set tools_dir=%cd%\r\n-    cd %tmp_dir%\r\n+    cd /d %tmp_dir%\r\n \r\n :EndTempCopy\r\n \r\n""}","merge 
"
1550,Bill Napier,Changed dexpreopt/Config.mk to use new (correct) path.,['core/Makefile'],"Changed dexpreopt/Config.mk to use new (correct) path.
",https://android-review.googlesource.com/c/1550,"bug 
","bug,resource",Resource;,"{""Makefile"": ""@@ -481,7 +481,7 @@ ifdef WITH_DEXPREOPT\n endif\n ifdef with_dexpreopt\n   # This file will set BUILT_SYSTEMIMAGE and SYSTEMIMAGE_SOURCE_DIR\n-  include tools/dexpreopt/Config.mk\n+  include build/tools/dexpreopt/Config.mk\n else\n   BUILT_SYSTEMIMAGE := $(BUILT_SYSTEMIMAGE_UNOPT)\n   SYSTEMIMAGE_SOURCE_DIR := $(TARGET_OUT)\n""}","bug 
"
12920,PacketVideo CM,RIO-8230: Fix for compiler warnings in mediaoutputnode and player engine test app.,"['engines/player/test/src/test_pv_player_engine_testset8.cpp', 'engines/2way/src/pv_2way_sdkinfo.h', 'engines/player/src/pv_player_sdkinfo.h', 'nodes/pvmediaoutputnode/src/pv_media_output_node.cpp', 'engines/author/src/pv_author_sdkinfo.h']",RIO-8230: Fix for compiler warnings in mediaoutputnode and player engine test app.,https://android-review.googlesource.com/c/12920,"bug 
",bug,Bug;Test;,"{""pv_2way_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PV2WAY_ENGINE_SDKINFO_LABEL \""1132988\""\n+#define PV2WAY_ENGINE_SDKINFO_LABEL \""1133020\""\n #define PV2WAY_ENGINE_SDKINFO_DATE 0x20091209\n \n #endif //PV_2WAY_SDKINFO_H_INCLUDED\n"", ""pv_author_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""1132988\""\n+#define PVAUTHOR_ENGINE_SDKINFO_LABEL \""1133020\""\n #define PVAUTHOR_ENGINE_SDKINFO_DATE 0x20091209\n \n #endif //PV_AUTHOR_SDKINFO_H_INCLUDED\n"", ""pv_player_sdkinfo.h"": ""@@ -21,7 +21,7 @@\n // This header file is automatically generated at build-time\n // *** OFFICIAL RELEASE INFO -- Will not auto update\n \n-#define PVPLAYER_ENGINE_SDKINFO_LABEL \""1132988\""\n+#define PVPLAYER_ENGINE_SDKINFO_LABEL \""1133020\""\n #define PVPLAYER_ENGINE_SDKINFO_DATE 0x20091209\n \n #endif //PV_PLAYER_SDKINFO_H_INCLUDED\n"", ""test_pv_player_engine_testset8.cpp"": ""@@ -1139,13 +1139,13 @@ void pvplayer_async_test_printmetadata::PrintMetadataInfo()\n                 if ((int32)StartIndex == iCodecSpecificInfoAudioIndex)\n                 {\n                     fprintf(iTestMsgOutputFile, \""Value %d:\\n\"", (i + 1));\n-                    fprintf(iTestMsgOutputFile, \""   Key string: %s\\n\"", iMetadataValueList[sCSI[jj].MetadataKeyIndex].key);\n+                    fprintf(iTestMsgOutputFile, \""   Key string: %s\\n\"", iMetadataValueList[i].key);\n                     PrintCodecSpecificInfo(iMetadataValueList[i].value.pChar_value, INDEX_CODEC_SPECIFIC_INFO_AUDIO);\n                 }\n                 else if ((int32)StartIndex == iCodecSpecificInfoVideoIndex)\n                 {\n                     fprintf(iTestMsgOutputFile, \""Value %d:\\n\"", (i + 1));\n-                    fprintf(iTestMsgOutputFile, \""   Key string: %s\\n\"", iMetadataValueList[sCSI[jj].MetadataKeyIndex].key);\n+                    fprintf(iTestMsgOutputFile, \""   Key string: %s\\n\"", iMetadataValueList[i].key);\n                     PrintCodecSpecificInfo(iMetadataValueList[i].value.pChar_value, INDEX_CODEC_SPECIFIC_INFO_VIDEO);\n                 }\n             }\n"", ""pv_media_output_node.cpp"": ""@@ -1602,14 +1602,14 @@ PVMFStatus PVMediaOutputNode::SendMioRequest(PVMediaOutputNodeCmd& aCmd, EMioReq\n     //save media io request.\n     iMediaIORequest = aRequest;\n \n-    PVMFStatus status;\n+    PVMFStatus status = PVMFPending;\n+    int32 err = OsclErrGeneral;\n \n     //Issue the command to the MIO.\n     switch (aRequest)\n     {\n         case EQueryCapability:\n         {\n-            int32 err ;\n             iMIOConfigPVI = NULL;\n             OSCL_TRY(err,\n                      iMediaIOCmdId = iMIOControl->QueryInterface(PVMI_CAPABILITY_AND_CONFIG_PVUUID,\n@@ -1623,16 +1623,11 @@ PVMFStatus PVMediaOutputNode::SendMioRequest(PVMediaOutputNodeCmd& aCmd, EMioReq\n                 aCmd.iEventCode = PVMFMoutNodeErr_MediaIOQueryCapConfigInterface;\n                 status = PVMFFailure;\n             }\n-            else\n-            {\n-                status = PVMFPending;\n-            }\n         }\n         break;\n \n         case EQueryClockExtension:\n         {\n-            int32 err ;\n             iMIOClockExtensionPVI = NULL;\n             OSCL_TRY(err,\n                      iMediaIOCmdId = iMIOControl->QueryInterface(PvmiClockExtensionInterfaceUuid,\n@@ -1646,23 +1641,20 @@ PVMFStatus PVMediaOutputNode::SendMioRequest(PVMediaOutputNodeCmd& aCmd, EMioReq\n                 //this interface is optional so ignore the error\n                 status = PVMFSuccess;\n             }\n-            else\n-            {\n-                status = PVMFPending;\n-            }\n         }\n         break;\n \n         case EInit:\n         {\n-            int32 err = OsclErrNone;\n             PvmiMediaTransfer* mediaTransfer = NULL;\n             if (iInPortVector.size() > 0)\n             {\n                 mediaTransfer = iInPortVector[0]->getMediaTransfer();\n             }\n-\n-            OSCL_TRY(err, iMediaIOCmdId = iMIOControl->Init(););\n+            if (mediaTransfer != NULL)\n+            {\n+                OSCL_TRY(err, iMediaIOCmdId = iMIOControl->Init(););\n+            }\n             if ((err != OsclErrNone))\n             {\n                 PVLOGGER_LOGMSG(PVLOGMSG_INST_LLDBG, iLogger, PVLOGMSG_ERR,\n@@ -1670,17 +1662,11 @@ PVMFStatus PVMediaOutputNode::SendMioRequest(PVMediaOutputNodeCmd& aCmd, EMioReq\n                 aCmd.iEventCode = PVMFMoutNodeErr_MediaIOInit;\n                 status = PVMFFailure;\n             }\n-            else\n-            {\n-                status = PVMFPending;\n-            }\n         }\n         break;\n \n         case EStart:\n         {\n-\n-            int32 err = OsclErrNone;\n             PvmiMediaTransfer* mediaTransfer = NULL;\n             if (iInPortVector.size() > 0)\n             {\n@@ -1690,23 +1676,18 @@ PVMFStatus PVMediaOutputNode::SendMioRequest(PVMediaOutputNodeCmd& aCmd, EMioReq\n             {\n                 OSCL_TRY(err, iMediaIOCmdId = iMIOControl->Start(););\n             }\n-            if ((err != OsclErrNone) || (mediaTransfer == NULL))\n+            if (err != OsclErrNone)\n             {\n                 PVLOGGER_LOGMSG(PVLOGMSG_INST_LLDBG, iLogger, PVLOGMSG_ERR,\n                                 (0, \""PVMediaOutputNode::SendMioRequest: Error - iMIOControl->Start failed\""));\n                 aCmd.iEventCode = PVMFMoutNodeErr_MediaIOStart;\n                 status = PVMFFailure;\n             }\n-            else\n-            {\n-                status = PVMFPending;\n-            }\n         }\n         break;\n \n         case EPause:\n         {\n-            int32 err = OsclErrNone;\n             PvmiMediaTransfer* mediaTransfer = NULL;\n             if (iInPortVector.size() > 0)\n             {\n@@ -1716,24 +1697,18 @@ PVMFStatus PVMediaOutputNode::SendMioRequest(PVMediaOutputNodeCmd& aCmd, EMioReq\n             {\n                 OSCL_TRY(err, iMediaIOCmdId = iMIOControl->Pause(););\n             }\n-            if ((err != OsclErrNone) || (mediaTransfer == NULL))\n+            if (err != OsclErrNone)\n             {\n                 PVLOGGER_LOGMSG(PVLOGMSG_INST_LLDBG, iLogger, PVLOGMSG_ERR,\n                                 (0, \""PVMediaOutputNode::SendMioRequest: Error - iMIOControl->Pause failed\""));\n                 aCmd.iEventCode = PVMFMoutNodeErr_MediaIOPause;\n                 status = PVMFFailure;\n             }\n-            else\n-            {\n-                status = PVMFPending;\n-            }\n         }\n         break;\n \n         case EStop:\n         {\n-\n-            int32 err = OsclErrNone;\n             PvmiMediaTransfer* mediaTransfer = NULL;\n             if (iInPortVector.size() > 0)\n             {\n@@ -1750,23 +1725,18 @@ PVMFStatus PVMediaOutputNode::SendMioRequest(PVMediaOutputNodeCmd& aCmd, EMioReq\n             {\n                 OSCL_TRY(err, iMediaIOCmdId = iMIOControl->Stop(););\n             }\n-            if ((err != OsclErrNone) || (mediaTransfer == NULL))\n+            if (err != OsclErrNone)\n             {\n                 PVLOGGER_LOGMSG(PVLOGMSG_INST_LLDBG, iLogger, PVLOGMSG_ERR,\n                                 (0, \""PVMediaOutputNode::SendMioRequest: Error - iMIOControl->Stop failed\""));\n                 aCmd.iEventCode = PVMFMoutNodeErr_MediaIOStop;\n                 status = PVMFFailure;\n             }\n-            else\n-            {\n-                status = PVMFPending;\n-            }\n         }\n         break;\n \n         case EDiscard:\n         {\n-            int32 err = OsclErrNone;\n             PvmiMediaTransfer* mediaTransfer = NULL;\n             if (iInPortVector.size() > 0)\n             {\n@@ -1782,23 +1752,18 @@ PVMFStatus PVMediaOutputNode::SendMioRequest(PVMediaOutputNodeCmd& aCmd, EMioReq\n                                 (0, \""PVMediaOutputNode::SendMioRequest(EDiscard): skipTimestamp=%d\"", resumeTimestamp));\n                 OSCL_TRY(err, iMediaIOCmdId = iMIOControl->DiscardData(resumeTimestamp););\n             }\n-            if ((err != OsclErrNone) || (mediaTransfer == NULL))\n+            if (err != OsclErrNone)\n             {\n                 PVLOGGER_LOGMSG(PVLOGMSG_INST_LLDBG, iLogger, PVLOGMSG_ERR,\n                                 (0, \""PVMediaOutputNode::SendMioRequest: Error - iMIOControl->DiscardData failed\""));\n                 aCmd.iEventCode = PVMFMoutNodeErr_MediaIODiscardData;\n                 status = PVMFFailure;\n             }\n-            else\n-            {\n-                status = PVMFPending;\n-            }\n         }\n         break;\n \n         case EReset:\n         {\n-            int32 err ;\n             OSCL_TRY(err, iMediaIOCmdId = iMIOControl->Reset(););\n             if (err != OsclErrNone)\n             {\n@@ -1807,10 +1772,6 @@ PVMFStatus PVMediaOutputNode::SendMioRequest(PVMediaOutputNodeCmd& aCmd, EMioReq\n                 aCmd.iEventCode = PVMFMoutNodeErr_MediaIOReset;\n                 status = PVMFFailure;\n             }\n-            else\n-            {\n-                status = PVMFPending;\n-            }\n         }\n         break;\n \n""}","bug, test 
"
17232,Channagoud Kadabi,Close cursor to avoid excessive JNI references,['src/com/android/browser/BrowserActivity.java'],"Close cursor to avoid excessive JNI references

- Add fix to avoid cursor leak which caused excessive
Jni global references

Change-Id: I0460f9ac2be83a642da196556a7118814fabd6a9",https://android-review.googlesource.com/c/17232,"bug 
",bug,Bug;,"{""BrowserActivity.java"": ""@@ -2248,6 +2248,10 @@ public class BrowserActivity extends Activity\n                                         getString(\n                                         R.string.choosertitle_sharevia));\n                             }\n+                            // close the cursor after its used\n+                            if (c != null) {\n+                                c.close();\n+                            }\n                             break;\n                         case R.id.copy_link_context_menu_id:\n                             copy(url);\n""}","bug, refactor 
"
14479,Mike Lockwood,Fixing spelling errors in adb docs,"['adb/OVERVIEW.TXT', 'adb/SERVICES.TXT']","Fixing spelling errors in adb docs

Change-Id: I9376717165a01e207034f84a31f85335d3740f18",https://android-review.googlesource.com/c/14479,"resource
",resource,Bug;Resource;,"{""OVERVIEW.TXT"": ""@@ -35,7 +35,7 @@ As a whole, everything works through the following components:\n     (through USB for devices, through TCP for emulators) and provide a\n     few services for clients that run on the host.\n \n-    The ADB server considers that a device is ONLINE when it has succesfully\n+    The ADB server considers that a device is ONLINE when it has successfully\n     connected to the adbd program within it. Otherwise, the device is OFFLINE,\n     meaning that the ADB server detected a new device/emulator, but could not\n     connect to the adbd daemon.\n"", ""SERVICES.TXT"": ""@@ -74,7 +74,7 @@ host-usb:<request>\n \n host-local:<request>\n     A variant of host-serial used to target the single emulator instance\n-    running on the host. This will fail if therre is none or more than one.\n+    running on the host. This will fail if there is none or more than one.\n \n host:<request>\n     When asking for information related to a device, 'host:' can also be\n@@ -146,7 +146,7 @@ remount:\n dev:<path>\n     Opens a device file and connects the client directly to it for\n     read/write purposes. Useful for debugging, but may require special\n-    priviledges and thus may not run on all devices. <path> is a full\n+    privileges and thus may not run on all devices. <path> is a full\n     path from the root of the filesystem.\n \n tcp:<port>\n@@ -173,7 +173,7 @@ log:<name>\n \n framebuffer:\n     This service is used to send snapshots of the framebuffer to a client.\n-    It requires sufficient priviledges but works as follow:\n+    It requires sufficient privileges but works as follow:\n \n       After the OKAY, the service sends 16-byte binary structure\n       containing the following fields (little-endian format):\n@@ -190,14 +190,14 @@ framebuffer:\n       one byte through the channel, which will trigger the service\n       to send it 'size' bytes of framebuffer data.\n \n-      If the adbd daemon doesn't have sufficient priviledges to open\n+      If the adbd daemon doesn't have sufficient privileges to open\n       the framebuffer device, the connection is simply closed immediately.\n \n dns:<server-name>\n     This service is an exception because it only runs within the ADB server.\n     It is used to implement USB networking, i.e. to provide a network connection\n     to the device through the host machine (note: this is the exact opposite of\n-    network thetering).\n+    network tethering).\n \n     It is used to perform a gethostbyname(<address>) on the host and return\n     the corresponding IP address as a 4-byte string.\n@@ -209,7 +209,7 @@ recover:<size>\n \n        - creating a file named /tmp/update\n        - reading 'size' bytes from the client and writing them to /tmp/update\n-       - when everything is read succesfully, create a file named /tmp/update.start\n+       - when everything is read successfully, create a file named /tmp/update.start\n \n     This service can only work when the device is in recovery mode. Otherwise,\n     the /tmp directory doesn't exist and the connection will be closed immediately.\n""}","**bug** 
"
21226,Rich Cannings,Add user mode networking restrictions: a firewall,"['slirp-android/slirp.c', 'slirp-android/socket.c', 'qemu-options.hx', 'slirp-android/udp.c', 'slirp-android/tcp_subr.c', 'vl-android.c', 'slirp-android/libslirp.h', 'slirp-android/udp.h']","Add user mode networking restrictions: a firewall

Command line options added and code is supported for:

  QEMU_OPTION_drop_udp
  QEMU_OPTION_drop_tcp
  QEMU_OPTION_allow_tcp
  QEMU_OPTION_drop_log
  QEMU_OPTION_net_forward
  QEMU_OPTION_max_dns_conns
  QEMU_OPTION_allow_udp
  QEMU_OPTION_dns_log

Also, this change makes the default max DNS connections unlimited.

Change-Id: I887213149956dda155ef514418365bd80d8f1236",https://android-review.googlesource.com/c/21226,"feature 
",feature,Feature;,"{""qemu-options.hx"": ""@@ -1440,6 +1440,95 @@ Set the initial date of the real time clock. Valid formats for\n @code{2006-06-17}. The default value is @code{now}.\n ETEXI\n \n+/* Start user mode network stack restrictions */\n+DEF(\""drop-udp\"", 0, QEMU_OPTION_drop_udp, \\\n+    \""-drop-udp       starts filtering all UDP packets\\n\"")\n+STEXI\n+\n+@item -drop-udp\n+Enable dropping of all UDP packets. \n+ETEXI\n+\n+\n+DEF(\""drop-tcp\"", 0, QEMU_OPTION_drop_tcp, \\\n+    \""-drop-tcp       starts filtering all TCP packets\\n\"")\n+STEXI\n+\n+@item -drop-tcp\n+Enable dropping of all TCP packets. \n+ETEXI\n+\n+\n+DEF(\""allow-tcp\"", HAS_ARG, QEMU_OPTION_allow_tcp, \\\n+    \""-allow-tcp      Only allows TCP packets for host:port\\n\"")\n+STEXI\n+\n+@item -allow-tcp @var{host}:@var{port}\n+Allows communication with the host named @code{host} and with\n+the port @code{port}. \n+ETEXI\n+\n+\n+DEF(\""drop-log\"", 0, QEMU_OPTION_drop_log, \\\n+    \""-drop-log       Creates a log for dropped connections\\n\"")\n+STEXI\n+\n+@item -drop-log @var{file}\n+Creates a log for dropped connections in the file @code{file}.\n+ETEXI\n+\n+/* Additional network restriction options */\n+\n+DEF(\""max-dns-conns\"", HAS_ARG, QEMU_OPTION_max_dns_conns, \\\n+    \""-max-dns-conns limit \\n\""\n+    \""                Limits the maximum DNS connections\\n\"")\n+STEXI\n+@item -max-dns-conns @var{limit}\n+Limits the maximum DNS connections to @var{limit}.\n+ETEXI\n+\n+DEF(\""allow-udp\"", HAS_ARG, QEMU_OPTION_allow_udp, \\\n+    \""-allow-udp host:port \\n\""\n+    \""                Allows udp connections to go through to host:port\\n\"")\n+STEXI\n+@item -allow-udp @var{host}:@var{port}\n+Allows udp connections to go through to @var{host}:@var{port}.\n+ETEXI\n+\n+DEF(\""dns-log\"", HAS_ARG, QEMU_OPTION_dns_log, \\\n+    \""-dns-log file   Creates a log of DNS lookups\\n\"")\n+STEXI\n+@item -dns-log @var{file}\n+Creates a log of DNS lookups as @var{file}.\n+ETEXI\n+\n+\n+DEF(\""net-forward\"", HAS_ARG, QEMU_OPTION_net_forward, \\\n+\""-net-forward dst_net:dst_mask:dst_port:redirect_ip:redirect_port:\\n\""\n+\""                Forwards guest network traffic sent to dst_net(dst_mask):dst_port\\n\""\n+\""                to redirect_ip:redirect_port\\n\"")\n+\n+STEXI\n+@item -net-forward @var{settings}\n+Forwards network traffic using the settings @code{settings}.\n+ETEXI\n+\n+\n+DEF(\""net-forward-tcp2sink\"", HAS_ARG, QEMU_OPTION_net_forward_tcp2sink, \\\n+\""-net-forward-tcp2sink sink_ip:sink_port\\n\""\n+\""                Forwards all dropped and non-forwarded guest network traffic\\n\"" \n+\""                to specified ip:port. \\n\"")\n+\n+STEXI\n+@item -net-forward-tcp2sink @var{settings}\n+Forwards all dropped and non-forwarded network traffic to sink ip:port. \n+ETEXI\n+\n+\n+\n+/* End User mode network stack restrictions */\n+\n+\n DEF(\""icount\"", HAS_ARG, QEMU_OPTION_icount, \\\n     \""-icount [N|auto]\\n\"" \\\n     \""                enable virtual instruction counter with 2^N clock ticks per\\n\"" \\\n"", ""libslirp.h"": ""@@ -2,7 +2,9 @@\n #define _LIBSLIRP_H\n \n #include <stdint.h>\n+#include <stdio.h>\n #include \""sockets.h\""\n+#include \""slirp.h\""\n #ifdef _WIN32\n #  define WIN32_LEAN_AND_MEAN\n #  define socket_close  winsock2_socket_close3\n@@ -16,6 +18,8 @@\n extern \""C\"" {\n #endif\n \n+struct mbuf;\n+\n int    inet_strtoip(const char*  str, uint32_t  *ip);\n char*  inet_iptostr(uint32_t  ip);\n \n@@ -32,6 +36,59 @@ void slirp_input(const uint8_t *pkt, int pkt_len);\n int slirp_can_output(void);\n void slirp_output(const uint8_t *pkt, int pkt_len);\n \n+/* ---------------------------------------------------*/\n+/* User mode network stack restrictions */\n+void slirp_drop_udp();\n+void slirp_drop_tcp();\n+void slirp_add_allow(unsigned long dst_addr, int dst_lport,\n+                     int dst_hport, u_int8_t proto);\n+void slirp_drop_log_fd(FILE* fd);\n+int slirp_should_drop(unsigned long dst_addr,\n+                      int dst_port,\n+                      u_int8_t proto);\n+int slirp_drop_log(const char* format, ...);\n+\n+/* for network forwards */\n+void slirp_add_net_forward(unsigned long dest_ip, unsigned long dest_mask,\n+                           int dest_lport, int dest_hport,\n+                           unsigned long redirect_ip, int redirect_port);\n+\n+int slirp_should_net_forward(unsigned long remote_ip, int remote_port,\n+                             unsigned long *redirect_ip, int *redirect_port);\n+/* ---------------------------------------------------*/\n+\n+/**\n+ * Additional network stack modifications, aiming to detect and log\n+ * any network activity initiated by any binary outisde the context of\n+ * the running browser.\n+ */\n+\n+void slirp_dns_log_fd(FILE* fd);\n+/** Logs the DNS name in DNS query issued by the VM. */\n+int slirp_log_dns(struct mbuf* m, int dropped);\n+/** IP packet dump of DNS queris and responses. */\n+int slirp_dump_dns(struct mbuf* m);\n+/** Sets an upper limit for the number of allowed DNS requests from\n+ * the VM.\n+ */\n+void slirp_set_max_dns_conns(int max_dns_conns);\n+/* Returns the max number of allowed DNS requests.*/\n+int slirp_get_max_dns_conns();\n+\n+/**\n+ * Modifications for implementing \""-net-forward-tcp2sink' option.\n+ */\n+\n+void slirp_forward_dropped_tcp2sink(unsigned long sink_ip,  int sink_port);\n+int slirp_should_forward_dropped_tcp2sink();\n+unsigned long slirp_get_tcp_sink_ip();\n+int slirp_get_tcp_sink_port();\n+\n+\n+\n+\n+/* ---------------------------------------------------*/\n+\n void slirp_redir_loop(void (*func)(void *opaque, int is_udp,\n                                    const SockAddress *laddr,\n                                    const SockAddress *faddr),\n"", ""slirp.c"": ""@@ -32,6 +32,12 @@\n #include \""android/android.h\""\n #include \""sockets.h\""\n \n+#include <sys/queue.h>\n+\n+/* proto types */\n+static void slirp_net_forward_init(void);\n+\n+\n #define  D(...)   VERBOSE_PRINT(slirp,__VA_ARGS__)\n #define  DN(...)  do { if (VERBOSE_CHECK(slirp)) dprintn(__VA_ARGS__); } while (0)\n \n@@ -259,6 +265,8 @@ void slirp_init(int restricted, const char *special_ip)\n     alias_addr_ip = special_addr_ip | CTL_ALIAS;\n     getouraddr();\n     register_savevm(\""slirp\"", 0, 1, slirp_state_save, slirp_state_load, NULL);\n+\n+    slirp_net_forward_init();\n }\n \n #define CONN_CANFSEND(so) (((so)->so_state & (SS_FCANTSENDMORE|SS_ISFCONNECTED)) == SS_ISFCONNECTED)\n@@ -819,6 +827,298 @@ void if_encap(const uint8_t *ip_data, int ip_data_len)\n     }\n }\n \n+\n+/*---------------------------------------------------*/\n+/* User mode network stack restrictions */\n+struct fw_allow_entry {\n+    struct fw_allow_entry* next;\n+    unsigned long dst_addr;   /* host byte order */\n+    /* Allowed port range. dst_lport should be the same as dst_hport for a\n+     * single port. */\n+    unsigned short dst_lport; /* host byte order */\n+    unsigned short dst_hport; /* host byte order */\n+};\n+\n+static int drop_udp = 0;\n+static int drop_tcp = 0;\n+static struct fw_allow_entry* allow_tcp_entries = NULL;\n+static struct fw_allow_entry* allow_udp_entries = NULL;\n+static FILE* drop_log_fd = NULL;\n+static FILE* dns_log_fd = NULL;\n+static int max_dns_conns = -1;   /* unlimited max DNS connections by default */\n+static int slirp_net_forward_inited = 0;\n+\n+void slirp_drop_udp() {\n+    drop_udp = 1;\n+}\n+\n+void slirp_drop_tcp() {\n+    drop_tcp = 1;\n+}\n+\n+/* TCP traffic forwarding to a sink - If enabled, all TCP traffic to any\n+ * ip/port that is not explicitly forwared using '-net-forward', and which would\n+ * otherwise be dropped if '-drop-tcp' has been specified, is redirected to the\n+ * specified ip:port\n+ */\n+int forward_dropped_tcp2sink = 0;\n+static unsigned long tcp_sink_ip;\n+int tcp_sink_port;\n+\n+void slirp_forward_dropped_tcp2sink(unsigned long sink_ip, int sink_port) {\n+    tcp_sink_ip = sink_ip;\n+    tcp_sink_port = sink_port;\n+    forward_dropped_tcp2sink = 1;\n+}\n+\n+int slirp_should_forward_dropped_tcp2sink() {\n+    return forward_dropped_tcp2sink;\n+}\n+\n+unsigned long slirp_get_tcp_sink_ip() {\n+    return tcp_sink_ip;\n+}\n+int slirp_get_tcp_sink_port() {\n+    return tcp_sink_port;\n+}\n+\n+/* Fill in the firewall rules. dst_lport and dst_hport are in host byte order */\n+void slirp_add_allow(unsigned long dst_addr,\n+                     int dst_lport, int dst_hport,\n+                     u_int8_t proto) {\n+\n+    struct fw_allow_entry** ate;\n+    switch (proto) {\n+      case IPPROTO_TCP:\n+          ate = &allow_tcp_entries;\n+          break;\n+      case IPPROTO_UDP:\n+          ate = &allow_udp_entries;\n+          break;\n+      default:\n+          return; // unknown protocol for the FW\n+    }\n+\n+    while(*ate != NULL)\n+        ate = &(*ate)->next;\n+\n+    *ate = malloc(sizeof(**ate));\n+    if (*ate == NULL) {\n+        DEBUG_MISC((dfd,\n+                    \""Unable to create new firewall record, malloc failed\\n\""));\n+        exit(-1);\n+    }\n+\n+    (*ate)->next = NULL;\n+    (*ate)->dst_addr = dst_addr;\n+    (*ate)->dst_lport = dst_lport;\n+    (*ate)->dst_hport = dst_hport;\n+}\n+\n+void slirp_drop_log_fd(FILE* fd) {\n+    drop_log_fd = fd;\n+}\n+\n+void slirp_dns_log_fd(FILE* fd) {\n+    dns_log_fd = fd;\n+}\n+\n+/* Address and ports are in host byte order */\n+int slirp_should_drop(unsigned long dst_addr,\n+                      int dst_port,\n+                      u_int8_t proto) {\n+\n+    struct fw_allow_entry* ate;\n+\n+    switch (proto) {\n+        case IPPROTO_TCP:\n+            if (drop_tcp != 0)\n+                ate = allow_tcp_entries;\n+            else\n+                return 0;\n+            break;\n+        case IPPROTO_UDP:\n+            if (drop_udp != 0)\n+                ate = allow_udp_entries;\n+            else\n+                return 0;\n+            break;\n+        default:\n+            return 1;  // unknown protocol for the FW\n+    }\n+\n+    while(ate) {\n+        if ((ate->dst_lport <= dst_port) && (dst_port <= ate->dst_hport)) {\n+            // allow any destination if 0\n+            if (ate->dst_addr == 0 || ate->dst_addr == dst_addr)\n+                return 0;\n+        }\n+        ate = ate->next;\n+    }\n+\n+    return 1;\n+}\n+\n+/*\n+ * log DNS requests in a separate log\n+ */\n+int\n+slirp_log_dns(struct mbuf* m, int dropped) {\n+    char dns_query[256];  // max allowable dns name size\n+    int c = 0;\n+    int i= 0;\n+    int index = 0;\n+    int offset = 40 + 1;  // udp/ip headers length + 1;\n+    int trim_bytes = 4;\n+\n+    if (!dns_log_fd)\n+        return -1;\n+\n+    /* We assume one DNS name per query: 300 = 255 (max dns name length)\n+     * + 40 (udp/ip hdr) + 1 byte DNS peamble + 4 bytes DNS suffix\n+     */\n+    if (m->m_len < offset || m->m_len > 300) {\n+        DEBUG_MISC((dfd,\""Malformed DNS qeury, length %d \\n\"", (int)m->m_len));\n+        return -1;\n+    }\n+    for (i = offset; i < m->m_len - trim_bytes && index < sizeof(dns_query); i++, index++) {\n+        c = m->m_data[i];\n+        if (c < ' ' || c > '~')\n+            c = '.';\n+\n+        dns_query[index] = (char)c;\n+    }\n+    dns_query[index] = '\\0';\n+    if (!dropped) {\n+        fprintf(dns_log_fd, \""Sent DNS query for, %s\\n\"" , dns_query);\n+    } else {\n+        fprintf(dns_log_fd, \""Dropped DNS query for, %s\\n\"" , dns_query);\n+    }\n+    fflush(dns_log_fd);\n+    return 1;\n+}\n+\n+/*\n+ * log DNS requests in a separate log\n+ */\n+int\n+slirp_dump_dns(struct mbuf* m) {\n+\n+    if (!dns_log_fd)\n+        return 0;\n+    // first we write the length of the record then the record (IP packet)\n+    if (!fwrite(&(m->m_len), sizeof(int), 1, dns_log_fd) ||\n+        !fwrite(m->m_data, m->m_len, 1, dns_log_fd)) {\n+        return 0;\n+    }\n+\n+    fflush(dns_log_fd);\n+    return 1;\n+}\n+\n+/* Log dropped/accepted packet info */\n+int slirp_drop_log(const char* format, ...) {\n+    va_list args;\n+\n+    if (!drop_log_fd)\n+        return 0;\n+\n+    va_start(args, format);\n+    vfprintf(drop_log_fd, format, args);\n+    va_end(args);\n+\n+    fflush(drop_log_fd);\n+\n+    return 1;\n+}\n+\n+\n+/* Set max DNS requests allowed to be issued from the VM */\n+void slirp_set_max_dns_conns(int num_conns) {\n+    max_dns_conns = num_conns;\n+}\n+\n+int slirp_get_max_dns_conns() {\n+    return max_dns_conns;\n+}\n+\n+/* generic guest network redirection functionality for ipv4 */\n+struct net_forward_entry {\n+    QTAILQ_ENTRY(net_forward_entry) next;\n+    /* ip addresses are also in host byte order */\n+    unsigned long dest_ip;            /* the destination address they try to contact */\n+    unsigned long dest_mask;          /* the mask to apply to the address for matching */\n+    /* Range of ports they were trying to contact. In case of a single port,\n+     * dest_lport should be the same as dest_hport */\n+    int dest_lport; /* Host byte order */\n+    int dest_hport; /* Host byte order */\n+\n+    unsigned long  redirect_ip;\n+    int redirect_port; /* Host byte order */\n+};\n+\n+static QTAILQ_HEAD(net_forwardq, net_forward_entry) net_forwards;\n+\n+static void slirp_net_forward_init(void)\n+{\n+    if (!slirp_net_forward_inited) {\n+      QTAILQ_INIT(&net_forwards);\n+      slirp_net_forward_inited = 1;\n+    }\n+}\n+\n+/* all addresses and ports ae in host byte order */\n+void slirp_add_net_forward(unsigned long dest_ip, unsigned long dest_mask,\n+                           int dest_lport, int dest_hport,\n+                           unsigned long redirect_ip, int redirect_port)\n+{\n+    slirp_net_forward_init();\n+\n+    struct net_forward_entry *entry = malloc(sizeof(*entry));\n+    if (entry == NULL) {\n+        DEBUG_MISC((dfd, \""Unable to create new forwarding entry, malloc failed\\n\""));\n+        exit(-1);\n+    }\n+\n+    entry->dest_ip = dest_ip;\n+    entry->dest_mask = dest_mask;\n+    entry->dest_lport = dest_lport;\n+    entry->dest_hport = dest_hport;\n+    entry->redirect_ip = redirect_ip;\n+    entry->redirect_port = redirect_port;\n+\n+    QTAILQ_INSERT_TAIL(&net_forwards, entry, next);\n+}\n+\n+/* remote_port and redir_port arguments\n+ * are in network byte order (tcp_subr.c) */\n+int slirp_should_net_forward(unsigned long remote_ip, int remote_port,\n+                             unsigned long *redirect_ip, int *redirect_port)\n+{\n+    struct net_forward_entry *entry;\n+\n+    for (entry = net_forwards.tqh_first;\n+         entry != NULL; entry = entry->next.tqe_next) {\n+\n+        if ((entry->dest_lport <= remote_port)\n+            && (remote_port <= entry->dest_hport)) {\n+            if ((entry->dest_ip & entry->dest_mask)\n+                == (remote_ip & entry->dest_mask)) {\n+              *redirect_ip = entry->redirect_ip;\n+              *redirect_port = entry->redirect_port;\n+              return 1;\n+            }\n+        }\n+    }\n+\n+    return 0;\n+}\n+\n+/*---------------------------------------------------*/\n+\n+\n+\n+\n static void _slirp_redir_loop(void (*func)(void *opaque, int is_udp,\n                                            const SockAddress *laddr,\n                                            const SockAddress *faddr),\n"", ""socket.c"": ""@@ -570,6 +570,26 @@ sosendto(struct socket *so, struct mbuf *m)\n \n \taddr_port = so->so_faddr_port;\n \n+\t/*\n+\t * test for generic forwarding; this function replaces the arguments\n+\t * only on success\n+\t */\n+\tunsigned long faddr = addr_ip;\n+        int fport = addr_port;\n+\n+\tif (slirp_should_net_forward(faddr, fport, &faddr, &fport)) {\n+\t    slirp_drop_log(\n+\t       \""Redirected UDP: src: 0x%08lx:0x%04x org dst: 0x%08lx:0x%04x \""\n+\t       \""new dst: 0x%08lx:0x%04x\\n\"",\n+\t        so->so_laddr_ip, so->so_laddr_port,\n+\t        addr_ip, addr_port,\n+\t        faddr, fport\n+\t    );\n+\t}\n+\taddr_ip = faddr;\n+\taddr_port = fport;\n+\n+\n         sock_address_init_inet(&addr, addr_ip, addr_port);\n \n \tDEBUG_MISC((dfd, \"" sendto()ing, addr.sin_port=%d, addr.sin_addr.s_addr=%08x\\n\"", addr_port, addr_ip));\n@@ -779,4 +799,3 @@ sofwdrain(struct socket *so)\n \telse\n \t\tsofcantsendmore(so);\n }\n-\n"", ""tcp_subr.c"": ""@@ -377,6 +377,29 @@ tcp_proxy_event( struct socket*  so,\n     tcp_input(NULL, sizeof(struct ip), so);\n }\n \n+\n+/* Tests if an IP address corresponds to a special Qemu service (eg, the DNS\n+ * server or the gateway - see ctl.h) and if so, rewrites it with the real\n+ * address of the service.\n+ */\n+int is_qemu_special_address(unsigned long dst_addr, unsigned long *redir_addr)\n+{\n+  if ((dst_addr & htonl(0xffffff00)) == special_addr_ip) {\n+    /* It's an alias */\n+\n+    int  last_byte = dst_addr & 0xff;\n+\n+    if (CTL_IS_DNS(last_byte))\n+      *redir_addr = dns_addr[last_byte - CTL_DNS];\n+    else\n+      *redir_addr = loopback_addr_ip;\n+\n+    return 1;\n+  }\n+  return 0;\n+}\n+\n+\n /*\n  * Connect to a host on the Internet\n  * Called by tcp_input\n@@ -390,41 +413,56 @@ tcp_proxy_event( struct socket*  so,\n int tcp_fconnect(struct socket *so)\n {\n   int ret=0;\n-    int try_proxy = 1;\n     SockAddress    sockaddr;\n-    uint32_t       sock_ip;\n-    uint16_t       sock_port;\n+    unsigned long       sock_ip;\n+    int                 sock_port;\n \n     DEBUG_CALL(\""tcp_fconnect\"");\n     DEBUG_ARG(\""so = %lx\"", (long )so);\n \n-    sock_ip   = so->so_faddr_ip;\n-    sock_port = so->so_faddr_port;\n-\n-    if ((sock_ip & 0xffffff00) == special_addr_ip) {\n-      /* It's an alias */\n-      int  last_byte = sock_ip & 0xff;\n-\n-      if (CTL_IS_DNS(last_byte))\n-        sock_ip = dns_addr[last_byte - CTL_DNS];\n-      else\n-        sock_ip = loopback_addr_ip;\n-      try_proxy = 0;\n-    }\n-\n-    sock_address_init_inet( &sockaddr, sock_ip, sock_port );\n-\n-    DEBUG_MISC((dfd, \"" connect()ing, addr=%s, proxy=%d\\n\"",\n-                sock_address_to_string(&sockaddr), try_proxy));\n-\n-    if (try_proxy) {\n-        if (!proxy_manager_add(&sockaddr, SOCKET_STREAM, (ProxyEventFunc) tcp_proxy_event, so)) {\n-            soisfconnecting(so);\n-            so->s         = -1;\n-            so->so_state |= SS_PROXIFIED;\n-            return 0;\n-        }\n+    /* when true, a connection that otherwise would be dropped will instead be\n+     * redirected to the sink ('-net-forward-tcp2sink') */\n+    int forward_dropped_to_sink = 0;\n+\n+\n+    /*-------------------------------------------------------------*/\n+    /* User mode network stack restrictions */\n+    if (slirp_should_drop(so->so_faddr_ip, so->so_faddr_port, IPPROTO_TCP)) {\n+\n+      /* If forwarding to sink is enabled, don't actually drop it */\n+      if (slirp_should_forward_dropped_tcp2sink()) {\n+        slirp_drop_log(\n+            \""About to be dropped TCP forwarded to sink: \""\n+            \""src: 0x%08lx:0x%04x dst: 0x%08lx:0x%04x\\n\"",\n+              so->so_laddr_ip,\n+              so->so_laddr_port,\n+              so->so_faddr_ip,\n+              so->so_faddr_port\n+        );\n+        forward_dropped_to_sink = 1;\n+      }\n+      else {\n+        slirp_drop_log(\n+            \""Dropped TCP: src: 0x%08lx:0x%04x dst: 0x%08lx:0x%04x\\n\"",\n+            so->so_laddr_ip,\n+            so->so_laddr_port,\n+            so->so_faddr_ip,\n+            so->so_faddr_port\n+        );\n+        //errno = ENETUNREACH;\n+        errno = ECONNREFUSED;\n+        return -1;\n+      }\n+    } else {\n+      slirp_drop_log(\n+          \""Allowed TCP: src: 0x%08lx:0x%04x dst: 0x%08lx:0x%04x\\n\"",\n+          so->so_laddr_ip,\n+          so->so_laddr_port,\n+          so->so_faddr_ip,\n+          so->so_faddr_port\n+      );\n     }\n+    /*-------------------------------------------------------------*/\n \n     if ((ret=so->s=socket_create_inet(SOCKET_STREAM)) >= 0) \n     {\n@@ -434,6 +472,79 @@ int tcp_fconnect(struct socket *so)\n         socket_set_xreuseaddr(s);\n         socket_set_oobinline(s);\n \n+\n+        if (forward_dropped_to_sink) {\n+\n+          /* This connection would normally be dropped, but since forwarding of\n+           * dropped connections is enabled, redirect it to the sink */\n+          sock_ip = slirp_get_tcp_sink_ip();\n+          sock_port= slirp_get_tcp_sink_port();\n+          slirp_drop_log(\n+              \""Redirected would-be dropped TCP to sink: \""\n+                \""src: 0x%08lx:0x%04x org dst: 0x%08lx:0x%04x \""\n+              \""new dst: 0x%08lx:0x%04x\\n\"",\n+              so->so_laddr_ip, so->so_laddr_port,\n+              so->so_faddr_ip, so->so_faddr_port,\n+              sock_ip, sock_port\n+            );\n+        }\n+        else {   /* An allowed connection */\n+\n+          unsigned long faddr;\n+          int fport;\n+\n+          /* Determine if the connection should be redirected\n+           * due to a -net-forward rule */\n+          /* faddr and fport are modified only on success */\n+          if (slirp_should_net_forward(so->so_faddr_ip, so->so_faddr_port,\n+                                       &faddr, &fport)) {\n+            slirp_drop_log(\n+                \""Redirected TCP: src: 0x%08lx:0x%04x org dst: 0x%08lx:0x%04x \""\n+                \""new dst: 0x%08lx:0x%04x\\n\"",\n+                so->so_laddr_ip, so->so_laddr_port,\n+                so->so_faddr_ip, so->so_faddr_port,\n+                faddr, fport\n+            );\n+            sock_ip = faddr;              /* forced dst addr */\n+            sock_port= fport;                 /* forced dst port */\n+          }\n+          /* Determine if this is a connection to a special qemu service,\n+           * and change the destination address accordingly.\n+           * 'faddr' is modified only onsuccess  */\n+          else if (is_qemu_special_address(so->so_faddr_ip, &faddr)) {\n+\n+          /* We keep the original destination port. If a special service\n+           * listens on a different port than the standard, then appropriate\n+           * forwarding should be set up using -net-forward, e.g., as it is\n+           * the case with Mawler's DNS traffic, which is redirected to the\n+           * special DNS port:\n+           * -net-forward 0.0.0.0:0.0.0.0:53:127.0.0.1:21737 */\n+\n+            sock_ip = faddr;         /* real DNS/gateway addr */\n+            sock_port= so->so_faddr_port;/* original dst port */\n+\n+          }\n+          /* A normal connection - keep the original destination addr/port */\n+          else {\n+\n+            if (!proxy_manager_add(&sockaddr, SOCKET_STREAM,\n+                                   (ProxyEventFunc) tcp_proxy_event, so)) {\n+                soisfconnecting(so);\n+                so->s         = -1;\n+                so->so_state |= SS_PROXIFIED;\n+                return 0;\n+            }\n+\n+            sock_ip = so->so_faddr_ip;  /* original dst addr */\n+            sock_port= so->so_faddr_port;   /* original dst port */\n+          }\n+        }\n+\n+        DEBUG_MISC((dfd, \"" connect()ing, addr=%s, proxy=%d\\n\"",\n+                    sock_address_to_string(&sockaddr), try_proxy));\n+\n+        sock_address_init_inet( &sockaddr, sock_ip, sock_port );\n+\n         /* We don't care what port we get */\n         socket_connect(s, &sockaddr);\n \n"", ""udp.c"": ""@@ -47,6 +47,10 @@\n struct udpstat udpstat;\n #endif\n \n+/* Keeps track of the number of DNS requests.  Used to implement the firewall\n+ * option that restricts the number of DNS requests (-max_dns_conns). */\n+u_int dns_num_conns;\n+\n struct socket udb;\n \n static u_int8_t udp_tos(struct socket *so);\n@@ -68,6 +72,7 @@ void\n udp_init(void)\n {\n \tudb.so_next = udb.so_prev = &udb;\n+\tdns_num_conns = 0;\n }\n /* m->m_data  points at ip packet header\n  * m->m_len   length ip packet\n@@ -121,6 +126,33 @@ udp_input(register struct mbuf *m, int iphlen)\n \t\tip->ip_len = len;\n \t}\n \n+\t/* ------------------------------------------------------*/\n+\t/* User mode network stack restrictions */\n+\t/* slirp_should_drop requires host byte ordering in arguments */\n+\tif (slirp_should_drop(ntohl(ip->ip_dst.addr), ntohs(uh->uh_dport.port),\n+\t                      IPPROTO_UDP)) {\n+\t  slirp_drop_log(\n+\t    \""Dropped UDP: src: 0x%08lx:0x%04x dst: 0x%08lx:0x%04x\\n\"",\n+\t    ip->ip_src.addr,\n+\t    uh->uh_sport.port,\n+\t    ip->ip_dst.addr,\n+\t    uh->uh_dport.port\n+\t  );\n+\t  goto bad; /* drop the packet */\n+\t}\n+\telse {\n+\t  slirp_drop_log(\n+\t    \""Allowed UDP: src: 0x%08lx:0x%04x dst: 0x%08lx:0x%04x\\n\"",\n+\t    ip->ip_src.addr,\n+\t    uh->uh_sport.port,\n+\t    ip->ip_dst.addr,\n+\t    uh->uh_dport.port\n+\t  );\n+\t}\n+  /* ------------------------------------------------------*/\n+\n+\n+\n \t/*\n \t * Save a copy of the IP header in case we want restore it\n \t * for sending an ICMP error message in response.\n@@ -164,6 +196,18 @@ udp_input(register struct mbuf *m, int iphlen)\n             goto bad;\n         }\n \n+        // DNS logging and FW rules\n+        if (ntohs(uh->uh_dport.port) == 53) {\n+            if (!slirp_dump_dns(m)) {\n+                DEBUG_MISC((dfd,\""Error logging DNS packet\""));\n+            }\n+            dns_num_conns++;\n+            if (slirp_get_max_dns_conns() != -1 &&\n+                dns_num_conns > slirp_get_max_dns_conns())\n+                goto bad;\n+        }\n+\n+\n \t/*\n \t * Locate pcb for datagram.\n \t */\n@@ -309,6 +353,13 @@ int udp_output2_(struct socket *so, struct mbuf *m,\n \n \tSTAT(udpstat.udps_opackets++);\n \n+\t//  DNS logging\n+\tif (so != NULL && so->so_faddr_port == htons(53)) {\n+\t  if (!slirp_dump_dns(m)) {\n+\t    DEBUG_MISC((dfd,\""Error logging DNS packet\""));\n+\t  }\n+\t}\n+\n \terror = ip_output(so, m);\n \n \treturn (error);\n"", ""udp.h"": ""@@ -69,7 +69,6 @@ struct udpiphdr {\n #define ui_ulen         ui_u.uh_ulen\n #define ui_sum          ui_u.uh_sum\n \n-#ifdef LOG_ENABLED\n struct udpstat {\n \t                                /* input statistics: */\n \t        u_long  udps_ipackets;          /* total input packets */\n@@ -83,7 +82,6 @@ struct udpstat {\n \t                                /* output statistics: */\n \t        u_long  udps_opackets;          /* total output packets */\n };\n-#endif\n \n /*\n  * Names for UDP sysctl objects\n@@ -91,9 +89,7 @@ struct udpstat {\n #define UDPCTL_CHECKSUM         1       /* checksum UDP packets */\n #define UDPCTL_MAXID            2\n \n-#ifdef LOG_ENABLED\n extern struct udpstat udpstat;\n-#endif\n \n extern struct socket udb;\n struct mbuf;\n"", ""vl-android.c"": ""@@ -3620,6 +3620,164 @@ append_param(char* param_str, const char* arg, int size)\n     }\n }\n \n+/* Parses an integer\n+ * Pararm:\n+ *  str      String containing a number to be parsed.\n+ *  result   Passes the parsed integer in this argument\n+ *  returns  0 if ok, -1 if failed\n+ */\n+int\n+parse_int(const char *str, int *result)\n+{\n+    char* r;\n+    *result = strtol(str, &r, 0);\n+    if (r == NULL || *r != '\\0')\n+      return -1;\n+\n+    return 0;\n+}\n+\n+\n+/* parses a null-terminated string specifying a network port (e.g., \""80\"") or\n+ * port range (e.g., \""[6666-7000]\""). In case of a single port, lport and hport\n+ * are the same. Returns 0 on success, -1 on error. */\n+\n+int parse_port_range(const char *str, unsigned short *lport,\n+                     unsigned short *hport) {\n+\n+  unsigned int low = 0, high = 0;\n+  char *p, *arg = strdup(str);\n+\n+  if ((*arg == '[') && ((p = strrchr(arg, ']')) != NULL)) {\n+    p = arg + 1;   /* skip '[' */\n+    low  = atoi(strtok(p, \""-\""));\n+    high = atoi(p);\n+    if ((low > 0) && (high > 0) && (low < high) && (high < 65535)) {\n+      *lport = low;\n+      *hport = high;\n+    }\n+  }\n+  else {\n+    low = atoi(arg);\n+    if ((0 < low) && (low < 65535)) {\n+      *lport = low;\n+      *hport = low;\n+    }\n+  }\n+  free(arg);\n+  if (low != 0)\n+    return 0;\n+  return -1;\n+}\n+\n+/*\n+ * Implements the generic port forwarding option\n+ */\n+void\n+net_slirp_forward(const char *optarg)\n+{\n+    /*\n+     * we expect the following format:\n+     * dst_net:dst_mask:dst_port:redirect_ip:redirect_port OR\n+     * dst_net:dst_mask:[dp_range_start-dp_range_end]:redirect_ip:redirect_port\n+     */\n+    char *argument = strdup(optarg), *p = argument;\n+    char *dst_net, *dst_mask, *dst_port;\n+    char *redirect_ip, *redirect_port;\n+    uint32_t dnet, dmask, rip;\n+    unsigned short dlport, dhport, rport;\n+\n+\n+    dst_net = strtok(p, \"":\"");\n+    dst_mask = strtok(NULL, \"":\"");\n+    dst_port = strtok(NULL, \"":\"");\n+    redirect_ip = strtok(NULL, \"":\"");\n+    redirect_port = strtok(NULL, \"":\"");\n+\n+    if (dst_net == NULL || dst_mask == NULL || dst_port == NULL ||\n+        redirect_ip == NULL || redirect_port == NULL) {\n+        fprintf(stderr,\n+                \""Invalid argument for -net-forward, we expect \""\n+                \""dst_net:dst_mask:dst_port:redirect_ip:redirect_port or \""\n+                \""dst_net:dst_mask:[dp_range_start-dp_range_end]\""\n+                \"":redirect_ip:redirect_port: %s\\n\"",\n+                optarg);\n+        exit(1);\n+    }\n+\n+    /* inet_strtoip converts dotted address to host byte order */\n+    if (inet_strtoip(dst_net, &dnet) == -1) {\n+        fprintf(stderr, \""Invalid destination IP net: %s\\n\"", dst_net);\n+        exit(1);\n+    }\n+    if (inet_strtoip(dst_mask, &dmask) == -1) {\n+        fprintf(stderr, \""Invalid destination IP mask: %s\\n\"", dst_mask);\n+        exit(1);\n+    }\n+    if (inet_strtoip(redirect_ip, &rip) == -1) {\n+        fprintf(stderr, \""Invalid redirect IP address: %s\\n\"", redirect_ip);\n+        exit(1);\n+    }\n+\n+    if (parse_port_range(dst_port, &dlport, &dhport) == -1) {\n+        fprintf(stderr, \""Invalid destination port or port range\\n\"");\n+        exit(1);\n+    }\n+\n+    rport = atoi(redirect_port);\n+    if (!rport) {\n+        fprintf(stderr, \""Invalid redirect port: %s\\n\"", redirect_port);\n+        exit(1);\n+    }\n+\n+    dnet &= dmask;\n+\n+    slirp_add_net_forward(dnet, dmask, dlport, dhport,\n+                          rip, rport);\n+\n+    free(argument);\n+}\n+\n+\n+/* Parses an -allow-tcp or -allow-udp argument and inserts a corresponding\n+ * entry in the allows list */\n+void\n+slirp_allow(const char *optarg, u_int8_t proto)\n+{\n+  /*\n+   * we expect the following format:\n+   * dst_ip:dst_port OR dst_ip:[dst_lport-dst_hport]\n+   */\n+  char *argument = strdup(optarg), *p = argument;\n+  char *dst_ip_str, *dst_port_str;\n+  uint32_t dst_ip;\n+  unsigned short dst_lport, dst_hport;\n+\n+  dst_ip_str = strtok(p, \"":\"");\n+  dst_port_str = strtok(NULL, \"":\"");\n+\n+  if (dst_ip_str == NULL || dst_port_str == NULL) {\n+    fprintf(stderr,\n+            \""Invalid argument %s for -allow. We expect \""\n+            \""dst_ip:dst_port or dst_ip:[dst_lport-dst_hport]\\n\"",\n+            optarg);\n+    exit(1);\n+  }\n+\n+  if (inet_strtoip(dst_ip_str, &dst_ip) == -1) {\n+    fprintf(stderr, \""Invalid destination IP address: %s\\n\"", dst_ip_str);\n+    exit(1);\n+  }\n+  if (parse_port_range(dst_port_str, &dst_lport, &dst_hport) == -1) {\n+    fprintf(stderr, \""Invalid destination port or port range\\n\"");\n+    exit(1);\n+  }\n+\n+  slirp_add_allow(dst_ip, dst_lport, dst_hport, proto);\n+\n+  free(argument);\n+}\n+\n int main(int argc, char **argv, char **envp)\n {\n     const char *gdbstub_dev = NULL;\n@@ -4375,6 +4533,89 @@ int main(int argc, char **argv, char **envp)\n                     }\n                 }\n                 break;\n+\n+            /* -------------------------------------------------------*/\n+            /* User mode network stack restrictions */\n+            case QEMU_OPTION_drop_udp:\n+                slirp_drop_udp();\n+                break;\n+            case QEMU_OPTION_drop_tcp:\n+                slirp_drop_tcp();\n+                break;\n+            case QEMU_OPTION_allow_tcp:\n+                slirp_allow(optarg, IPPROTO_TCP);\n+                break;\n+            case QEMU_OPTION_allow_udp:\n+                slirp_allow(optarg, IPPROTO_UDP);\n+                break;\n+             case QEMU_OPTION_drop_log:\n+                {\n+                    FILE* drop_log_fd;\n+                    drop_log_fd = fopen(optarg, \""w\"");\n+\n+                    if (!drop_log_fd) {\n+                        fprintf(stderr, \""Cannot open drop log: %s\\n\"", optarg);\n+                        exit(1);\n+                    }\n+\n+                    slirp_drop_log_fd(drop_log_fd);\n+                }\n+                break;\n+\n+            case QEMU_OPTION_dns_log:\n+                {\n+                    FILE* dns_log_fd;\n+                    dns_log_fd = fopen(optarg, \""wb\"");\n+\n+                    if (dns_log_fd == NULL) {\n+                        fprintf(stderr, \""Cannot open dns log: %s\\n\"", optarg);\n+                        exit(1);\n+                    }\n+\n+                    slirp_dns_log_fd(dns_log_fd);\n+                }\n+                break;\n+\n+\n+            case QEMU_OPTION_max_dns_conns:\n+                {\n+                    int max_dns_conns = 0;\n+                    if (parse_int(optarg, &max_dns_conns)) {\n+                      fprintf(stderr,\n+                              \""qemu: syntax: -max-dns-conns max_connections\\n\"");\n+                      exit(1);\n+                    }\n+                    if (max_dns_conns <= 0 ||  max_dns_conns == LONG_MAX) {\n+                      fprintf(stderr,\n+                              \""Invalid arg for max dns connections: %s\\n\"",\n+                              optarg);\n+                      exit(1);\n+                    }\n+                    slirp_set_max_dns_conns(max_dns_conns);\n+                }\n+                break;\n+\n+            case QEMU_OPTION_net_forward:\n+                net_slirp_forward(optarg);\n+                break;\n+            case QEMU_OPTION_net_forward_tcp2sink:\n+                {\n+                    SockAddress saddr;\n+\n+                    if (parse_host_port(&saddr, optarg)) {\n+                        fprintf(stderr,\n+                                \""Invalid ip/port %s for \""\n+                                \""-forward-dropped-tcp2sink. \""\n+                                \""We expect 'sink_ip:sink_port'\\n\"",\n+                                optarg);\n+                        exit(1);\n+                    }\n+                    slirp_forward_dropped_tcp2sink(saddr.u.inet.address,\n+                                                   saddr.u.inet.port);\n+                }\n+                break;\n+            /* -------------------------------------------------------*/\n+\n             case QEMU_OPTION_tb_size:\n                 tb_size = strtol(optarg, NULL, 0);\n                 if (tb_size < 0)\n""}","feature 
"
20218,Tor Norbye,Replace Sdk.makeRelativeTo(),"['eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/sdk/Sdk.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/LayoutCanvas.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/xml/Hyperlinks.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/properties/LibraryProperties.java', 'eclipse/dictionary.txt']","Replace Sdk.makeRelativeTo()

IPath#makeRelativeTo(IPath) was not supported on Eclipse 3.4, so we
had a local version of it in our sourcebase, as
Sdk#makeRelativeTo(IPath,IPath). However, our version only works
correctly for directories, not plain files, but I had been using it
for files as well.

Now that we no longer need to support Eclipse 3.4, remove our local
version and use the builtin path conversion method.

(Fixed some invalid javadoc too)

Change-Id: I233875e1ecc758eb1ed333686b319b138eb47c4a",https://android-review.googlesource.com/c/20218,"refactor,deprecate 
","bug,deprecat",Bug;Deprecat;,"{""dictionary.txt"": ""@@ -173,6 +173,7 @@ stateless\n stderr\n stdout\n stretchiness\n+struct\n subclassing\n submenu\n supertype\n"", ""LayoutCanvas.java"": ""@@ -33,7 +33,6 @@ import com.android.ide.eclipse.adt.internal.editors.layout.gre.RulesEngine;\n import com.android.ide.eclipse.adt.internal.editors.layout.uimodel.UiViewElementNode;\n import com.android.ide.eclipse.adt.internal.editors.uimodel.UiDocumentNode;\n import com.android.ide.eclipse.adt.internal.editors.uimodel.UiElementNode;\n-import com.android.ide.eclipse.adt.internal.sdk.Sdk;\n import com.android.sdklib.SdkConstants;\n \n import org.eclipse.core.filesystem.EFS;\n@@ -732,7 +731,7 @@ public class LayoutCanvas extends Canvas {\n         IPath workspacePath = workspace.getLocation();\n         IEditorSite editorSite = graphicalEditor.getEditorSite();\n         if (workspacePath.isPrefixOf(filePath)) {\n-            IPath relativePath = Sdk.makeRelativeTo(filePath, workspacePath);\n+            IPath relativePath = filePath.makeRelativeTo(workspacePath);\n             IResource xmlFile = workspace.findMember(relativePath);\n             if (xmlFile != null) {\n                 IFile leavingFile = graphicalEditor.getEditedFile();\n"", ""Hyperlinks.java"": ""@@ -432,7 +432,7 @@ public class Hyperlinks {\n         IPath workspacePath = workspace.getLocation();\n         IEditorSite editorSite = sourceEditor.getEditorSite();\n         if (workspacePath.isPrefixOf(filePath)) {\n-            IPath relativePath = Sdk.makeRelativeTo(filePath, workspacePath);\n+            IPath relativePath = filePath.makeRelativeTo(workspacePath);\n             IResource file = workspace.findMember(relativePath);\n             if (file instanceof IFile) {\n                 try {\n"", ""LibraryProperties.java"": ""@@ -167,8 +167,8 @@ final class LibraryProperties {\n                         \""Please select a library project\"");\n                 if (javaProject != null) {\n                     IProject iProject = javaProject.getProject();\n-                    IPath relativePath = Sdk.makeRelativeTo(\n-                            iProject.getLocation(), mState.getProject().getLocation());\n+                    IPath relativePath = iProject.getLocation().makeRelativeTo(\n+                            mState.getProject().getLocation());\n \n                     addItem(relativePath.toString(), iProject, -1);\n                     resetEnabled();\n@@ -267,11 +267,11 @@ final class LibraryProperties {\n \n     /**\n      * Saves the state of the UI into the {@link ProjectProperties} object that was returned by\n-     * {@link #setContent(ProjectState)}.\n+     * {@link #setContent}.\n      * <p/>This does not update the {@link ProjectState} object that was provided, nor does it save\n      * the new properties on disk. Saving the properties on disk, via\n-     * {@link ProjectProperties#save()}, and updating the {@link ProjectState} instance, via\n-     * {@link ProjectState#reloadProperties()} must be done by the caller.\n+     * {@link ProjectPropertiesWorkingCopy#save()}, and updating the {@link ProjectState} instance,\n+     * via {@link ProjectState#reloadProperties()} must be done by the caller.\n      * @return <code>true</code> if there was actually new data saved in the project state, false\n      * otherwise.\n      */\n"", ""Sdk.java"": ""@@ -917,10 +917,10 @@ public final class Sdk  {\n                 synchronized (sLock) {\n                     for (ProjectState projectState : sProjectStateMap.values()) {\n                         if (projectState != renamedState && projectState.isMissingLibraries()) {\n-                            IPath oldRelativePath = makeRelativeTo(from,\n+                            IPath oldRelativePath = from.makeRelativeTo(\n                                     projectState.getProject().getFullPath());\n \n-                            IPath newRelativePath = makeRelativeTo(project.getFullPath(),\n+                            IPath newRelativePath = project.getFullPath().makeRelativeTo(\n                                     projectState.getProject().getFullPath());\n \n                             // get the current libraries\n@@ -1682,38 +1682,5 @@ public final class Sdk  {\n         // for this libraries, to update the project there were depending on.\n         updateProjectsWithNewLibraries(updatedLibraries);\n     }\n-\n-    /**\n-     * Computes a new IPath targeting a given target, but relative to a given base.\n-     * <p/>{@link IPath#makeRelativeTo(IPath)} is only available in 3.5 and later.\n-     * <p/>This is based on the implementation {@link Path#makeRelativeTo(IPath)}.\n-     * @param target the target of the IPath\n-     * @param base the IPath to base the relative path on.\n-     * @return the relative IPath\n-     */\n-    public static IPath makeRelativeTo(IPath target, IPath base) {\n-        //can't make relative if devices are not equal\n-        if (target.getDevice() != base.getDevice() && (target.getDevice() == null ||\n-                !target.getDevice().equalsIgnoreCase(base.getDevice())))\n-            return target;\n-        int commonLength = target.matchingFirstSegments(base);\n-        final int differenceLength = base.segmentCount() - commonLength;\n-        final int newSegmentLength = differenceLength + target.segmentCount() - commonLength;\n-        if (newSegmentLength == 0)\n-            return Path.EMPTY;\n-        String[] newSegments = new String[newSegmentLength];\n-        //add parent references for each segment different from the base\n-        Arrays.fill(newSegments, 0, differenceLength, \""..\""); //$NON-NLS-1$\n-        //append the segments of this path not in common with the base\n-        System.arraycopy(target.segments(), commonLength, newSegments,\n-                differenceLength, newSegmentLength - differenceLength);\n-\n-        StringBuilder sb = new StringBuilder();\n-        for (String s : newSegments) {\n-            sb.append(s).append('/');\n-        }\n-\n-        return new Path(null, sb.toString());\n-    }\n }\n \n""}","bug, refactor 
"
18782,Rebecca Zavin,video: tegra: nvmap: Move debug info to debugfs,['drivers/video/tegra/nvmap/nvmap_dev.c'],"video: tegra: nvmap: Move debug info to debugfs

Moves the file tracking clients to debugfs
Add a debugfs file to track the list of allocations per client

Change-Id: I2bb683e3ac0599fa05d962c79ef0b7cbd0007d75
Signed-off-by: Rebecca Schultz Zavin <rebecca@android.com>",https://android-review.googlesource.com/c/18782,"**feature**, **debug** 
",feature,Bug;,"{""nvmap_dev.c"": ""@@ -22,10 +22,12 @@\n \n #include <linux/backing-dev.h>\n #include <linux/bitmap.h>\n+#include <linux/debugfs.h>\n #include <linux/kernel.h>\n #include <linux/miscdevice.h>\n #include <linux/mm.h>\n #include <linux/platform_device.h>\n+#include <linux/seq_file.h>\n #include <linux/slab.h>\n #include <linux/spinlock.h>\n #include <linux/uaccess.h>\n@@ -737,46 +739,105 @@ static ssize_t attr_show_usage(struct device *dev,\n \treturn sprintf(buf, \""%08x\\n\"", node->heap_bit);\n }\n \n-static ssize_t attr_show_clients(struct device *dev,\n-\t\t\t\t struct device_attribute *attr, char *buf)\n+static struct device_attribute heap_attr_show_usage =\n+\t__ATTR(usage, S_IRUGO, attr_show_usage, NULL);\n+\n+static struct attribute *heap_extra_attrs[] = {\n+\t&heap_attr_show_usage.attr,\n+\tNULL,\n+};\n+\n+static struct attribute_group heap_extra_attr_group = {\n+\t.attrs = heap_extra_attrs,\n+};\n+\n+static void client_stringify(struct nvmap_client *client, struct seq_file *s)\n {\n-\tstruct nvmap_carveout_node *node = nvmap_heap_device_to_arg(dev);\n+\tchar task_comm[sizeof(client->task->comm)];\n+\tget_task_comm(task_comm, client->task);\n+\tseq_printf(s, \""%16s %8u\"", task_comm, client->task->pid);\n+}\n+\n+static void allocations_stringify(struct nvmap_client *client,\n+\t\t\t\t  struct seq_file *s) \n+{\n+\tstruct rb_node *n = client->handle_refs.rb_node;\n+\n+\tfor (; n != NULL; n = rb_next(n)) {\n+\t\tstruct nvmap_handle_ref *ref =\n+\t\t\trb_entry(n, struct nvmap_handle_ref, node);\n+\t\tstruct nvmap_handle *handle = ref->handle;\n+\t\tif (!handle->heap_pgalloc)\n+\t\t\tseq_printf(s, \"" %8u@%8lx \"", handle->size,\n+\t\t\t\t   handle->carveout->base);\n+\t}\n+\tseq_printf(s, \""\\n\"");\n+}\n+\n+static int nvmap_debug_allocations_show(struct seq_file *s, void *unused)\n+{\n+\tstruct nvmap_carveout_node *node = s->private;\n \tstruct nvmap_carveout_commit *commit;\n-\tchar *orig_buf = buf;\n \n \tmutex_lock(&node->clients_mutex);\n \tlist_for_each_entry(commit, &node->clients, list) {\n \t\tstruct nvmap_client *client =\n \t\t\tget_client_from_carveout_commit(node, commit);\n-\t\tchar task_comm[sizeof(client->task->comm)];\n-\t\tget_task_comm(task_comm, client->task);\n-\t\tbuf += sprintf(buf, \""%16s %8u %8u\\n\"", task_comm,\n-\t\t\t       client->task->pid, commit->commit);\n+\t\tclient_stringify(client, s);\n+\t\tallocations_stringify(client, s);\n \t}\n \tmutex_unlock(&node->clients_mutex);\n-\treturn buf - orig_buf;\n-}\n \n-static struct device_attribute heap_attr_show_usage =\n-\t__ATTR(usage, S_IRUGO, attr_show_usage, NULL);\n+\treturn 0;\n+}\n \n-static struct device_attribute heap_attr_show_clients =\n-\t__ATTR(clients, S_IRUGO, attr_show_clients, NULL);\n+static int nvmap_debug_allocations_open(struct inode *inode, struct file *file)\n+{\n+\treturn single_open(file, nvmap_debug_allocations_show,\n+\t\t\t   inode->i_private);\n+}\n \n-static struct attribute *heap_extra_attrs[] = {\n-\t&heap_attr_show_usage.attr,\n-\t&heap_attr_show_clients.attr,\n-\tNULL,\n+static struct file_operations debug_allocations_fops = {\n+\t.open = nvmap_debug_allocations_open,\n+\t.read = seq_read,\n+\t.llseek = seq_lseek,\n+\t.release = single_release,\n };\n \n-static struct attribute_group heap_extra_attr_group = {\n-\t.attrs = heap_extra_attrs,\n+static int nvmap_debug_clients_show(struct seq_file *s, void *unused)\n+{\n+\tstruct nvmap_carveout_node *node = s->private;\n+\tstruct nvmap_carveout_commit *commit;\n+\n+\tmutex_lock(&node->clients_mutex);\n+\tlist_for_each_entry(commit, &node->clients, list) {\n+\t\tstruct nvmap_client *client =\n+\t\t\tget_client_from_carveout_commit(node, commit);\n+\t\tclient_stringify(client, s);\n+\t\tseq_printf(s, \""%8u\\n\"", commit->commit);\n+\t}\n+\tmutex_unlock(&node->clients_mutex);\n+\n+\treturn 0;\n+}\n+\n+static int nvmap_debug_clients_open(struct inode *inode, struct file *file)\n+{\n+\treturn single_open(file, nvmap_debug_clients_show, inode->i_private);\n+}\n+\n+static struct file_operations debug_clients_fops = {\n+\t.open = nvmap_debug_clients_open,\n+\t.read = seq_read,\n+\t.llseek = seq_lseek,\n+\t.release = single_release,\n };\n \n static int nvmap_probe(struct platform_device *pdev)\n {\n \tstruct nvmap_platform_data *plat = pdev->dev.platform_data;\n \tstruct nvmap_device *dev;\n+\tstruct dentry *nvmap_debug_root;\n \tunsigned int i;\n \tint e;\n \n@@ -885,6 +946,10 @@ static int nvmap_probe(struct platform_device *pdev)\n \t\tgoto fail;\n \t}\n \n+\tnvmap_debug_root = debugfs_create_dir(\""nvmap\"", NULL);\n+\tif (IS_ERR_OR_NULL(nvmap_debug_root))\n+\t\tdev_err(&pdev->dev, \""couldn't create debug files\\n\"");\n+\n \tfor (i = 0; i < plat->nr_carveouts; i++) {\n \t\tstruct nvmap_carveout_node *node = &dev->heaps[i];\n \t\tconst struct nvmap_platform_carveout *co = &plat->carveouts[i];\n@@ -907,7 +972,19 @@ static int nvmap_probe(struct platform_device *pdev)\n \n \t\tdev_info(&pdev->dev, \""created carveout %s (%uKiB)\\n\"",\n \t\t\t co->name, co->size / 1024);\n+\n+\t\tif (nvmap_debug_root) {\n+\t\t\tstruct dentry *heap_root =\n+\t\t\t\tdebugfs_create_dir(co->name, nvmap_debug_root);\n+\t\t\tif (heap_root) {\n+\t\t\t\tdebugfs_create_file(\""clients\"", 0664, heap_root,\n+\t\t\t\t    node, &debug_clients_fops);\n+\t\t\t\tdebugfs_create_file(\""allocations\"", 0664,\n+\t\t\t\t    heap_root, node, &debug_allocations_fops);\n+\t\t\t}\n+\t\t}\n \t}\n+\n \tplatform_set_drvdata(pdev, dev);\n \tnvmap_dev = dev;\n \treturn 0;\n""}","bug, refactor 
"
18621,Tor Norbye,Add dictionary to codebase,"['eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/AndroidXmlEditor.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/AndroidContentAssist.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/wizards/newxmlfile/NewXmlFileCreationPage.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/AdtPlugin.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/build/builders/PreCompilerBuilder.java', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/layout/gle2/GraphicalEditorPart.java', 'eclipse/dictionary.txt', 'eclipse/plugins/com.android.ide.eclipse.adt/src/com/android/ide/eclipse/adt/internal/editors/uimodel/UiElementNode.java']","Add dictionary to codebase

Eclipse	has the	ability	to spellcheck comments, and it	ships with an
English dictionary. However, many valid terms in our codebase is not
in this dictionary. This checkin adds a dictionary file which contains
many of the valid spelling words used in our codebase.

(Unfortunately,	Eclipse	does not support ""project dictionaries""	like
some other IDEs where individual user dictionaries are merged with
shared project dictionaries. However, this new dictionary should be
useful for developers who use a dedicated workspace for Android
development.)

This changeset also fixes some typos.

Change-Id: Ied6647f6cb550460c0087498f8c94fa6624e3b4e",https://android-review.googlesource.com/c/18621,"resource, bug
",feature;bug,Feature;,"{""dictionary.txt"": ""@@ -0,0 +1,122 @@\n+aapt\n+adb\n+adt\n+aidl\n+alt\n+android\n+antialias\n+apache\n+api\n+apk\n+app\n+apps\n+avd\n+avds\n+basename\n+bitmask\n+breadcrumb\n+callback\n+callbacks\n+checkbox\n+classpath\n+clipboard\n+codebase\n+codename\n+codenames\n+combo\n+config\n+ddms\n+debuggable\n+deprecated\n+deselect\n+deselects\n+dev\n+dex\n+dexified\n+diff\n+dirs\n+dpi\n+editable\n+exec\n+foo\n+fqcn\n+gen\n+groovy\n+hardcoded\n+href\n+http\n+ids\n+ie\n+iff\n+img\n+infos\n+init\n+inline\n+instanceof\n+int\n+javadoc\n+layoutlib\n+lifecycle\n+linestyle\n+linux\n+locale\n+logo\n+mac\n+macs\n+marquee\n+min\n+multi\n+namespace\n+namespaces\n+num\n+ok\n+os\n+palette\n+params\n+pings\n+plugin\n+pre\n+precompiler\n+pref\n+printf\n+programmatically\n+proguard\n+proxies\n+proxy\n+recompilation\n+redo\n+regexp\n+registry\n+reparse\n+reparses\n+residual\n+scrollbar\n+scrollbars\n+sdk\n+se\n+settable\n+spec\n+standalone\n+stateless\n+stderr\n+stdout\n+supertype\n+syncs\n+themed\n+tmp\n+tooltip\n+traceview\n+ui\n+undescribed\n+uninstall\n+uninstallation\n+uninstalling\n+uri\n+url\n+validator\n+verbosity\n+webtools\n+workflow\n+xml\n+xmlns\n+zipalign\n"", ""AdtPlugin.java"": ""@@ -187,7 +187,7 @@ public class AdtPlugin extends AbstractUIPlugin {\n         mAndroidConsoleErrorStream = mAndroidConsole.newMessageStream();\n         mRed = new Color(display, 0xFF, 0x00, 0x00);\n \n-        // because this can be run, in some cases, by a non ui thread, and beccause\n+        // because this can be run, in some cases, by a non ui thread, and because\n         // changing the console properties update the ui, we need to make this change\n         // in the ui thread.\n         display.asyncExec(new Runnable() {\n"", ""PreCompilerBuilder.java"": ""@@ -90,7 +90,7 @@ public class PreCompilerBuilder extends BaseBuilder {\n     private static Pattern sAidlPattern1 = Pattern.compile(\""^(.+?):(\\\\d+):?\\\\s(.+)$\""); //$NON-NLS-1$\n \n     /**\n-     * Data to temporarly store aidl source file information\n+     * Data to temporarily store aidl source file information\n      */\n     static class AidlData {\n         IFile aidlFile;\n@@ -146,7 +146,7 @@ public class PreCompilerBuilder extends BaseBuilder {\n     /**\n      * Progress monitor waiting the end of the process to set a persistent value\n      * in a file. This is typically used in conjunction with <code>IResource.refresh()</code>,\n-     * since this call is asysnchronous, and we need to wait for it to finish for the file\n+     * since this call is asynchronous, and we need to wait for it to finish for the file\n      * to be known by eclipse, before we can call <code>resource.setPersistentProperty</code> on\n      * a new file.\n      */\n@@ -658,7 +658,7 @@ public class PreCompilerBuilder extends BaseBuilder {\n      * @param osResPath the OS path to the res folder for the main project\n      * @param osManifestPath the OS path to the manifest of the main project\n      * @param packageFolder the IFolder that will contain the generated file. Unlike\n-     * <var>osOutputPath</var> this is the direct parent of the geenerated files.\n+     * <var>osOutputPath</var> this is the direct parent of the generated files.\n      * If <var>customJavaPackage</var> is not null, this must match the new destination triggered\n      * by its value.\n      * @param libResFolders the list of res folders for the library.\n@@ -857,7 +857,7 @@ public class PreCompilerBuilder extends BaseBuilder {\n      * created from aidl files that are now gone.\n      * @param projectTarget Target of the project\n      * @param sourceFolders the list of source folders, relative to the workspace.\n-     * @param monitor the projess monitor\n+     * @param monitor the progress monitor\n      * @returns true if it did something\n      * @throws CoreException\n      */\n@@ -950,7 +950,7 @@ public class PreCompilerBuilder extends BaseBuilder {\n     }\n \n     /**\n-     * Returns the {@link IFile} handle to the destination file for a given aild source file\n+     * Returns the {@link IFile} handle to the destination file for a given aidl source file\n      * ({@link AidlData}).\n      * @param aidlData the data for the aidl source file.\n      * @param createFolders whether or not the parent folder of the destination should be created\n@@ -1032,7 +1032,7 @@ public class PreCompilerBuilder extends BaseBuilder {\n             boolean error = parseAidlOutput(results, file);\n \n             // If the process failed and we couldn't parse the output\n-            // we pring a message, mark the project and exit\n+            // we print a message, mark the project and exit\n             if (result != 0 && error == true) {\n                 // display the message in the console.\n                 AdtPlugin.printErrorToConsole(getProject(), results.toArray());\n"", ""AndroidContentAssist.java"": ""@@ -588,7 +588,7 @@ public abstract class AndroidContentAssist implements IContentAssistProcessor {\n      * offset backwards that forms a potential XML element name, attribute name or\n      * attribute value.\n      *\n-     * The part were we access the docment was extracted from\n+     * The part were we access the document was extracted from\n      * org.eclipse.jface.text.templatesTemplateCompletionProcessor and adapted to our needs.\n      *\n      * @param viewer the viewer\n"", ""AndroidXmlEditor.java"": ""@@ -789,7 +789,7 @@ public abstract class AndroidXmlEditor extends FormEditor implements IResourceCh\n      *\n      * @param label The label for the undo operation. Can be null but we should really try to put\n      *              something meaningful if possible.\n-     * @return True if the undo recording actually started, false if any kind of error occured.\n+     * @return True if the undo recording actually started, false if any kind of error occurred.\n      *         {@link #endUndoRecording()} should only be called if True is returned.\n      */\n     private boolean beginUndoRecording(String label) {\n@@ -924,7 +924,7 @@ public abstract class AndroidXmlEditor extends FormEditor implements IResourceCh\n \n         /**\n          * A model has been renamed or copied (as in saveAs..). In the renamed\n-         * case, the two paramenters are the same instance, and only contain the\n+         * case, the two parameters are the same instance, and only contain the\n          * new info for id and base location.\n          * <p/>\n          * This AndroidXmlEditor implementation of IModelChangedListener is empty.\n"", ""GraphicalEditorPart.java"": ""@@ -1385,7 +1385,7 @@ public class GraphicalEditorPart extends EditorPart\n     // ---- Error handling ----\n \n     /**\n-     * Switches the shash to display the error label.\n+     * Switches the sash to display the error label.\n      *\n      * @param errorFormat The new error to display if not null.\n      * @param parameters String.format parameters for the error format.\n@@ -1406,7 +1406,7 @@ public class GraphicalEditorPart extends EditorPart\n     }\n \n     /**\n-     * Switches the shash to display the error label to show a list of\n+     * Switches the sash to display the error label to show a list of\n      * missing classes and give options to create them.\n      */\n     private void displayMissingClasses(Set<String> missingClasses) {\n"", ""UiElementNode.java"": ""@@ -341,7 +341,7 @@ public class UiElementNode implements IPropertySource {\n      * Returns the {@link ElementDescriptor} for this node. This is never null.\n      * <p/>\n      * Do not use this to call getDescriptor().getAttributes(), instead call\n-     * getAttributeDescriptors() which can be overriden by derived classes.\n+     * getAttributeDescriptors() which can be overridden by derived classes.\n      */\n     public ElementDescriptor getDescriptor() {\n         return mDescriptor;\n@@ -864,7 +864,7 @@ public class UiElementNode implements IPropertySource {\n      * Removes the XML node corresponding to this UI node if it exists\n      * and also removes all mirrored information in this UI node (i.e. children, attributes)\n      *\n-     * @return The removed node or null if it didn't exist in the firtst place.\n+     * @return The removed node or null if it didn't exist in the first place.\n      */\n     public Node deleteXmlNode() {\n         if (mXmlNode == null) {\n@@ -1104,7 +1104,7 @@ public class UiElementNode implements IPropertySource {\n      * For each attribute declared in this {@link UiElementNode}, get\n      * the corresponding XML attribute. It may not exist, in which case the\n      * value will be null. We don't really know if a value has changed, so\n-     * the updateValue() is called on the UI sattribute in all cases.\n+     * the updateValue() is called on the UI attribute in all cases.\n      *\n      * @param xmlNode The XML node to mirror\n      */\n"", ""NewXmlFileCreationPage.java"": ""@@ -508,7 +508,7 @@ class NewXmlFileCreationPage extends WizardPage {\n     /**\n      * Creates the project & filename fields.\n      * <p/>\n-     * The parent must be a GridLayout with NUM_COL colums.\n+     * The parent must be a GridLayout with NUM_COL columns.\n      */\n     private void createProjectGroup(Composite parent) {\n         int col = 0;\n@@ -567,7 +567,7 @@ class NewXmlFileCreationPage extends WizardPage {\n     /**\n      * Creates the type field, {@link ConfigurationSelector} and the folder field.\n      * <p/>\n-     * The parent must be a GridLayout with NUM_COL colums.\n+     * The parent must be a GridLayout with NUM_COL columns.\n      */\n     private void createTypeGroup(Composite parent) {\n         // separator\n@@ -648,7 +648,7 @@ class NewXmlFileCreationPage extends WizardPage {\n     /**\n      * Creates the root element combo.\n      * <p/>\n-     * The parent must be a GridLayout with NUM_COL colums.\n+     * The parent must be a GridLayout with NUM_COL columns.\n      */\n     private void createRootGroup(Composite parent) {\n         // separator\n""}","bug, resource 
"
12325,Alexey Tarasov,FreeBSD support for usb-connected devices in adb,"['adb/Android.mk', 'adb/usb_libusb.c', 'adb/get_my_path_freebsd.c']","FreeBSD support for usb-connected devices in adb

FreeBSD (and other systems as well) may use libusb to work with USB devices.
libusb is integrated in FreeBSD base system in recent builds (8.0+),
however in other systems it may need include libusb.h like <libusb/libusb.h>
and install library from devel/libusb port or other repository.

Submitted change not supports events (attach/detach) as libusb 1.0 lacks
such functionality and in order to make code more portable I've not used
workarounds as in earlier changeset.

Code was tested on FreeBSD 8.0-RC1, HTC Hero (1.0.0.A6288, Android 1.5)",https://android-review.googlesource.com/c/12325,"feature 
",feature,Merge;Test;,"{""Android.mk"": ""@@ -25,6 +25,12 @@ ifeq ($(HOST_OS),darwin)\n   LOCAL_LDLIBS += -lpthread -framework CoreFoundation -framework IOKit -framework Carbon\n endif\n \n+ifeq ($(HOST_OS),freebsd)\n+  USB_SRCS := usb_libusb.c\n+  EXTRA_SRCS := get_my_path_freebsd.c\n+  LOCAL_LDLIBS += -lpthread -lusb\n+endif\n+\n ifeq ($(HOST_OS),windows)\n   USB_SRCS := usb_windows.c\n   EXTRA_SRCS := get_my_path_windows.c\n"", ""get_my_path_freebsd.c"": ""@@ -0,0 +1,36 @@\n+/*\n+ * Copyright (C) 2009 bsdroid project\n+ *               Alexey Tarasov <tarasov@dodologics.com>\n+ *\n+ * Copyright (C) 2007 The Android Open Source Project\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+#include <sys/types.h>\n+#include <unistd.h>\n+#include <limits.h>\n+#include <stdio.h>\n+\n+void\n+get_my_path(char *exe, size_t maxLen)\n+{\n+    char proc[64];\n+\n+    snprintf(proc, sizeof(proc), \""/proc/%d/file\"", getpid());\n+\n+    int err = readlink(proc, exe, maxLen - 1);\n+\n+    exe[err > 0 ? err : 0] = '\\0';\n+}\n+\n"", ""usb_libusb.c"": ""@@ -0,0 +1,657 @@\n+/* \n+ * Copyright (C) 2009 bsdroid project\n+ *               Alexey Tarasov <tarasov@dodologics.com>\n+ *   \n+ * Copyright (C) 2007 The Android Open Source Project\n+ * \n+ * Licensed under the Apache License, Version 2.0 (the \""License\"");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \""AS IS\"" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+#include <sys/endian.h>\n+#include <sys/ioctl.h>\n+#include <sys/types.h>\n+#include <sys/uio.h>\n+\n+#include <err.h>\n+#include <errno.h>\n+#include <poll.h>\n+#include <stdio.h>\n+#include <stdlib.h>\n+#include <strings.h>\n+#include <string.h>\n+#include <sysexits.h>\n+#include <unistd.h>\n+#include <libusb.h>\n+#include \""sysdeps.h\""\n+\n+#define   TRACE_TAG  TRACE_USB\n+#include \""adb.h\""\n+\n+static adb_mutex_t usb_lock = ADB_MUTEX_INITIALIZER;\n+static libusb_context *ctx = NULL;\n+\n+struct usb_handle\n+{\n+    usb_handle            *prev;\n+    usb_handle            *next;\n+\n+    libusb_device         *dev;\n+    libusb_device_handle  *devh;\n+    int                   interface;\n+    uint8_t               dev_bus;\n+    uint8_t               dev_addr;\n+\t\n+    int                   zero_mask;\n+    unsigned char         end_point_address[2];\n+    char                  serial[128];\n+    \n+    adb_cond_t            notify;\n+    adb_mutex_t           lock;\n+};\n+\n+static struct usb_handle handle_list = {\n+        .prev = &handle_list,\n+        .next = &handle_list,\n+};\n+\n+void\n+usb_cleanup()\n+{\n+\tlibusb_exit(ctx);\n+}\n+\n+void\n+report_bulk_libusb_error(int r)\n+{\n+    switch (r) {\n+    case LIBUSB_ERROR_TIMEOUT:\n+        D(\""Transfer timeout\\n\"");\n+        break;\n+\n+    case LIBUSB_ERROR_PIPE:\n+        D(\""Control request is not supported\\n\"");\n+        break;\n+\n+    case LIBUSB_ERROR_OVERFLOW:\n+        D(\""Device offered more data\\n\"");\n+        break;\n+\n+    case LIBUSB_ERROR_NO_DEVICE :\n+        D(\""Device was disconnected\\n\"");\n+        break;\n+\n+    default:\n+        D(\""Error %d during transfer\\n\"", r);\n+        break;\n+    };\n+}\n+\n+static int\n+usb_bulk_write(usb_handle *uh, const void *data, int len)\n+{\n+    int r = 0;\n+    int transferred = 0;\n+\n+    r = libusb_bulk_transfer(uh->devh, uh->end_point_address[1], (void *)data, len,\n+                             &transferred, 0);\n+   \n+    if (r != 0) {\n+        D(\""usb_bulk_write(): \"");\n+        report_bulk_libusb_error(r);\n+        return r;\n+    }\n+   \n+    return (transferred);\n+}\n+\n+static int\n+usb_bulk_read(usb_handle *uh, void *data, int len)\n+{\n+    int r = 0;\n+    int transferred = 0;\n+\n+    r = libusb_bulk_transfer(uh->devh, uh->end_point_address[0], data, len,\n+                             &transferred, 0);\n+\n+    if (r != 0) {\n+        D(\""usb_bulk_read(): \"");\n+        report_bulk_libusb_error(r);\n+        return r;\n+    }\n+   \n+    return (transferred);\n+}\n+\n+int\n+usb_write(struct usb_handle *uh, const void *_data, int len)\n+{\n+    unsigned char *data = (unsigned char*) _data;\n+    int n;\n+    int need_zero = 0;\n+\n+    if (uh->zero_mask == 1) {\n+        if (!(len & uh->zero_mask)) {\n+            need_zero = 1;\n+        }\n+    }\n+\n+    D(\""usb_write(): %p:%d -> transport %p\\n\"", _data, len, uh);\n+    \n+    while (len > 0) {\n+        int xfer = (len > 4096) ? 4096 : len;\n+\n+        n = usb_bulk_write(uh, data, xfer);\n+        \n+        if (n != xfer) {\n+            D(\""usb_write(): failed for transport %p (%d bytes left)\\n\"", uh, len);\n+            return -1;\n+        }\n+\n+        len -= xfer;\n+        data += xfer;\n+    }\n+\n+    if (need_zero){\n+        n = usb_bulk_write(uh, _data, 0);\n+        \n+        if (n < 0) {\n+            D(\""usb_write(): failed to finish operation for transport %p\\n\"", uh);\n+        }\n+        return n;\n+    }\n+\n+    return 0;\n+}\n+\n+int\n+usb_read(struct usb_handle *uh, void *_data, int len)\n+{\n+    unsigned char *data = (unsigned char*) _data;\n+    int n;\n+\n+    D(\""usb_read(): %p:%d <- transport %p\\n\"", _data, len, uh);\n+    \n+    while (len > 0) {\n+        int xfer = (len > 4096) ? 4096 : len;\n+\n+        n = usb_bulk_read(uh, data, xfer);\n+        \n+        if (n != xfer) {\n+            if (n > 0) {\n+                data += n;\n+                len -= n;\n+                continue;\n+            }\n+            \n+            D(\""usb_read(): failed for transport %p (%d bytes left)\\n\"", uh, len);\n+            return -1;\n+        }\n+\n+        len -= xfer;\n+        data += xfer;\n+    }\n+\n+    return 0;\n+ }\n+\n+int\n+usb_close(struct usb_handle *h)\n+{\n+    D(\""usb_close(): closing transport %p\\n\"", h);\n+    adb_mutex_lock(&usb_lock);\n+    \n+    h->next->prev = h->prev;\n+    h->prev->next = h->next;\n+    h->prev = NULL;\n+    h->next = NULL;\n+\n+    libusb_release_interface(h->devh, h->interface);\n+    libusb_close(h->devh);\n+    libusb_unref_device(h->dev);\n+    \n+    adb_mutex_unlock(&usb_lock);\n+\n+    free(h);\n+\n+    return (0);\n+}\n+\n+void usb_kick(struct usb_handle *h)\n+{\n+    D(\""usb_cick(): kicking transport %p\\n\"", h);\n+    \n+    adb_mutex_lock(&h->lock);\n+    unregister_usb_transport(h);\n+    adb_mutex_unlock(&h->lock);\n+    \n+    h->next->prev = h->prev;\n+    h->prev->next = h->next;\n+    h->prev = NULL;\n+    h->next = NULL;\n+\n+    libusb_release_interface(h->devh, h->interface);\n+    libusb_close(h->devh);\n+    libusb_unref_device(h->dev);\n+    free(h);\n+}\n+\n+int\n+check_usb_interface(libusb_interface *interface,\n+                    libusb_device_descriptor *desc,\n+                    struct usb_handle *uh)\n+{    \n+    int e;\n+    \n+    if (interface->num_altsetting == 0) {\n+        D(\""check_usb_interface(): No interface settings\\n\"");\n+        return -1;\n+    }\n+    \n+    libusb_interface_descriptor *idesc = &interface->altsetting[0];\n+    \n+    if (idesc->bNumEndpoints != 2) {\n+        D(\""check_usb_interface(): Interface have not 2 endpoints, ignoring\\n\"");\n+        return -1;\n+    }\n+\n+    for (e = 0; e < idesc->bNumEndpoints; e++) {\n+        libusb_endpoint_descriptor *edesc = &idesc->endpoint[e];\n+        \n+        if (edesc->bmAttributes != LIBUSB_TRANSFER_TYPE_BULK) {\n+            D(\""check_usb_interface(): Endpoint (%u) is not bulk (%u), ignoring\\n\"",\n+                    edesc->bmAttributes, LIBUSB_TRANSFER_TYPE_BULK);\n+            return -1;\n+        }\n+        \n+        if (edesc->bEndpointAddress & LIBUSB_ENDPOINT_IN)\n+            uh->end_point_address[0] = edesc->bEndpointAddress;\n+        else\n+            uh->end_point_address[1] = edesc->bEndpointAddress;\n+        \n+            /* aproto 01 needs 0 termination */\n+        if (idesc->bInterfaceProtocol == 0x01) {\n+            uh->zero_mask = edesc->wMaxPacketSize - 1;\n+            D(\""check_usb_interface(): Forced Android interface protocol v.1\\n\"");\n+        }\n+    }\n+\n+    D(\""check_usb_interface(): Device: %04x:%04x \""\n+      \""iclass: %x, isclass: %x, iproto: %x ep: %x/%x-> \"",\n+        desc->idVendor, desc->idProduct, idesc->bInterfaceClass,\n+\tidesc->bInterfaceSubClass, idesc->bInterfaceProtocol,\n+\tuh->end_point_address[0], uh->end_point_address[1]);\n+    \n+    if (!is_adb_interface(desc->idVendor, desc->idProduct,\n+            idesc->bInterfaceClass, idesc->bInterfaceSubClass,\n+            idesc->bInterfaceProtocol))\n+    {\n+        D(\""not matches\\n\"");\n+        return -1;\n+    }\n+\n+    D(\""matches\\n\"");\n+    return 1;\n+}\n+\n+int\n+check_usb_interfaces(libusb_config_descriptor *config,\n+                     libusb_device_descriptor *desc, struct usb_handle *uh)\n+{  \n+    int i;\n+    \n+    for (i = 0; i < config->bNumInterfaces; ++i) {\n+        if (check_usb_interface(&config->interface[i], desc, uh) != -1) {\n+            /* found some interface and saved information about it */\n+            D(\""check_usb_interfaces(): Interface %d of %04x:%04x \""\n+              \""matches Android device\\n\"", i, desc->idVendor,\n+\t      desc->idProduct);\n+            \n+            return  i;\n+        }\n+    }\n+    \n+    return -1;\n+}\n+\n+int\n+register_device(struct usb_handle *uh, const char *serial)\n+{\n+    D(\""register_device(): Registering %p [%s] as USB transport\\n\"",\n+       uh, serial);\n+\n+    struct usb_handle *usb= NULL;\n+\n+    usb = calloc(1, sizeof(struct usb_handle));\n+    memcpy(usb, uh, sizeof(struct usb_handle));\n+    strcpy(usb->serial, uh->serial);\n+\n+    adb_cond_init(&usb->notify, 0);\n+    adb_mutex_init(&usb->lock, 0);\n+\n+    adb_mutex_lock(&usb_lock);\n+    \n+    usb->next = &handle_list;\n+    usb->prev = handle_list.prev;\n+    usb->prev->next = usb;\n+    usb->next->prev = usb;\n+\n+    adb_mutex_unlock(&usb_lock);\n+\n+    register_usb_transport(usb, serial, 1); \n+\n+    return (1);\n+}\n+\n+int\n+already_registered(usb_handle *uh)\n+{\n+    struct usb_handle *usb= NULL;\n+    int exists = 0;\n+    \n+    adb_mutex_lock(&usb_lock);\n+\n+    for (usb = handle_list.next; usb != &handle_list; usb = usb->next) {\n+        if ((usb->dev_bus == uh->dev_bus) &&\n+            (usb->dev_addr == uh->dev_addr))\n+        {\n+            exists = 1;\n+            break;\n+        }\n+    }\n+\n+    adb_mutex_unlock(&usb_lock);\n+\n+    return exists;\n+}\n+\n+void\n+check_device(libusb_device *dev) \n+{\n+    struct usb_handle uh;\n+    int i = 0;\n+    int found = -1;\n+    char serial[256] = {0};\n+\n+    libusb_device_descriptor desc;\n+    libusb_config_descriptor *config = NULL;\n+    \n+    int r = libusb_get_device_descriptor(dev, &desc);\n+\n+    if (r != LIBUSB_SUCCESS) {\n+        D(\""check_device(): Failed to get device descriptor\\n\"");\n+        return;\n+    }\n+    \n+    if ((desc.idVendor == 0) && (desc.idProduct == 0))\n+        return;\n+    \n+    D(\""check_device(): Probing usb device %04x:%04x\\n\"",\n+        desc.idVendor, desc.idProduct);\n+    \n+    if (!is_adb_interface (desc.idVendor, desc.idProduct,\n+                           ADB_CLASS, ADB_SUBCLASS, ADB_PROTOCOL))\n+    {\n+        D(\""check_device(): Ignored due unknown vendor id\\n\"");\n+        return;\n+    }\n+    \n+    uh.dev_bus = libusb_get_bus_number(dev);\n+    uh.dev_addr = libusb_get_device_address(dev);\n+    \n+    if (already_registered(&uh)) {\n+        D(\""check_device(): Device (bus: %d, address: %d) \""\n+          \""is already registered\\n\"", uh.dev_bus, uh.dev_addr);\n+        return;\n+    }\n+    \n+    D(\""check_device(): Device bus: %d, address: %d\\n\"",\n+        uh.dev_bus, uh.dev_addr);\n+\n+    r = libusb_get_active_config_descriptor(dev, &config);\n+    \n+    if (r != 0) {\n+        if (r == LIBUSB_ERROR_NOT_FOUND) {\n+            D(\""check_device(): Device %4x:%4x is unconfigured\\n\"", \n+                desc.idVendor, desc.idProduct);\n+            return;\n+        }\n+        \n+        D(\""check_device(): Failed to get configuration for %4x:%4x\\n\"",\n+            desc.idVendor, desc.idProduct);\n+        return;\n+    }\n+    \n+    if (config == NULL) {\n+        D(\""check_device(): Sanity check failed after \""\n+          \""getting active config\\n\"");\n+        return;\n+    }\n+    \n+    if (config->interface != NULL) {\n+        found = check_usb_interfaces(config, &desc, &uh);\n+    }\n+    \n+    /* not needed anymore */\n+    libusb_free_config_descriptor(config);\n+    \n+    r = libusb_open(dev, &uh.devh);\n+    uh.dev = dev;\n+\n+    if (r != 0) {\n+        switch (r) {\n+            case LIBUSB_ERROR_NO_MEM:\n+                D(\""check_device(): Memory allocation problem\\n\"");\n+                break;\n+                \n+            case LIBUSB_ERROR_ACCESS:\n+                D(\""check_device(): Permissions problem, \""\n+                  \""current user priveleges are messed up?\\n\"");\n+                break;\n+                \n+            case LIBUSB_ERROR_NO_DEVICE:\n+                D(\""check_device(): Device disconected, bad cable?\\n\"");\n+                break;\n+            \n+            default:\n+                D(\""check_device(): libusb triggered error %d\\n\"", r);\n+        }\n+        // skip rest\n+        found = -1;\n+    }\n+    \n+    if (found >= 0) {\n+        D(\""check_device(): Device matches Android interface\\n\"");\n+        // read the device's serial number\n+        memset(serial, 0, sizeof(serial));\n+        uh.interface = found;\n+        \n+        r = libusb_claim_interface(uh.devh, uh.interface);\n+        \n+        if (r < 0) {\n+            D(\""check_device(): Failed to claim interface %d\\n\"",\n+                uh.interface);\n+\n+            goto fail;\n+        }\n+\n+        if (desc.iSerialNumber) {\n+            // reading serial\n+            uint16_t    buffer[128] = {0};\n+            uint16_t    languages[128] = {0};\n+            int languageCount = 0;\n+\n+            memset(languages, 0, sizeof(languages));\n+            r = libusb_control_transfer(uh.devh, \n+                LIBUSB_ENDPOINT_IN |  LIBUSB_REQUEST_TYPE_STANDARD | LIBUSB_RECIPIENT_DEVICE,\n+                LIBUSB_REQUEST_GET_DESCRIPTOR, LIBUSB_DT_STRING << 8,\n+\t\t0, (uint8_t *)languages, sizeof(languages), 0);\n+\n+            if (r <= 0) {\n+                D(\""check_device(): Failed to get languages count\\n\"");\n+                goto fail;\n+            } \n+            \n+            languageCount = (r - 2) / 2;\n+            \n+            for (i = 1; i <= languageCount; ++i) {\n+                memset(buffer, 0, sizeof(buffer));\n+\n+                r = libusb_control_transfer(uh.devh, \n+                    LIBUSB_ENDPOINT_IN |  LIBUSB_REQUEST_TYPE_STANDARD | LIBUSB_RECIPIENT_DEVICE,\n+                    LIBUSB_REQUEST_GET_DESCRIPTOR, (LIBUSB_DT_STRING << 8) | desc.iSerialNumber,\n+\t\t    languages[i], (uint8_t *)buffer, sizeof(buffer), 0);\n+            \n+                if (r > 0) { /* converting serial */\n+                    int j = 0;\n+                    r /= 2;\n+                \n+                    for (j = 1; j < r; ++j)\n+                        serial[j - 1] = buffer[j];\n+                \n+                    serial[j - 1] = '\\0';\n+                    break; /* languagesCount cycle */\n+                }\n+            }\n+            \n+            if (register_device(&uh, serial) == 0) {\n+                D(\""check_device(): Failed to register device\\n\"");\n+                goto fail_interface;\n+            }\n+            \n+            libusb_ref_device(dev);\n+        }\n+    }\n+    \n+    return;\n+\n+fail_interface:\n+    libusb_release_interface(uh.devh, uh.interface);\n+\n+fail:\n+    libusb_close(uh.devh);\n+    uh.devh = NULL;\n+}\n+\n+int\n+check_device_connected(struct usb_handle *uh)\n+{\n+    int r = libusb_kernel_driver_active(uh->devh, uh->interface);\n+    \n+    if (r == LIBUSB_ERROR_NO_DEVICE)\n+        return 0;\n+    \n+    if (r < 0)\n+        return -1;\n+    \n+    return 1;\n+}\n+\n+void\n+kick_disconnected()\n+{\n+    struct usb_handle *usb= NULL;\n+    \n+    adb_mutex_lock(&usb_lock);\n+\n+    for (usb = handle_list.next; usb != &handle_list; usb = usb->next) {\n+        \n+        if (check_device_connected(usb) == 0) {\n+            D(\""kick_disconnected(): Transport %p is not online anymore\\n\"",\n+                usb);\n+\n+            usb_kick(usb);\n+        }\n+    }\n+    \n+    adb_mutex_unlock(&usb_lock);\n+}\n+\n+void\n+scan_usb_devices()\n+{\n+    D(\""scan_usb_devices(): started\\n\"");\n+    \n+    libusb_device **devs= NULL;\n+    libusb_device *dev= NULL;\n+    ssize_t cnt = libusb_get_device_list(ctx, &devs);\n+\n+    if (cnt < 0) {\n+        D(\""scan_usb_devices(): Failed to get device list (error: %d)\\n\"",\n+            cnt);\n+\n+        return;\n+    }\n+    \n+    int i = 0;\n+\n+    while ((dev = devs[i++]) != NULL) {\n+        check_device(dev);\n+    }\n+\n+    libusb_free_device_list(devs, 1);\n+}\n+\n+void *\n+device_poll_thread(void* unused)\n+{\n+    D(\""device_poll_thread(): Created USB scan thread\\n\"");\n+    \n+    for (;;) {\n+        sleep(5);\n+        kick_disconnected();\n+        scan_usb_devices();\n+    }\n+\n+    /* never reaching this point */\n+    return (NULL);\n+}\n+\n+static void\n+sigalrm_handler(int signo)\n+{\n+    /* nothing */\n+}\n+\n+void\n+usb_init()\n+{\n+    D(\""usb_init(): started\\n\"");\n+    adb_thread_t        tid;\n+    struct sigaction actions;\n+\n+    int r = libusb_init(&ctx);\n+\n+    if (r != LIBUSB_SUCCESS) {\n+        err(EX_IOERR, \""Failed to init libusb\\n\"");\n+    }\n+\n+    memset(&actions, 0, sizeof(actions));\n+    \n+    sigemptyset(&actions.sa_mask);\n+    \n+    actions.sa_flags = 0;\n+    actions.sa_handler = sigalrm_handler;\n+    \n+    sigaction(SIGALRM, &actions, NULL);\n+\n+\t/* initial device scan */\n+\tscan_usb_devices();\n+\t\n+\t/* starting USB event polling thread */\n+    if (adb_thread_create(&tid, device_poll_thread, NULL)) {\n+            err(EX_IOERR, \""cannot create USB scan thread\\n\"");\n+    }\n+    \n+    D(\""usb_init(): finished\\n\"");\n+}\n+\n""}","bug,feature 
"
18989,David Turner,Introduce asynchronous operation helpers.,"['android/async-console.h', 'android/async-utils.h', 'android/async-console.c', 'Makefile.android', 'android/async-utils.c']","Introduce asynchronous operation helpers.

<android/async-utils.h> contains generic helpers to read, write
and connect to sockets.

<android/async-console.h> contains a helper class to connect
to Android console port asynchronously.

Change-Id: I5d0a49a770ad974c5d4382438d75e9eb624368d1",https://android-review.googlesource.com/c/18989,"feature
",feature,Others;,"{""Makefile.android"": ""@@ -754,6 +754,8 @@ UI_AND_CORE_SOURCES = \\\n                       sockets.c \\\n                       android/keycode-array.c \\\n                       android/charmap.c \\\n+                      android/async-utils.c \\\n+                      android/async-console.c \\\n                       android/utils/assert.c \\\n                       android/utils/bufprint.c \\\n                       android/utils/debug.c \\\n"", ""async-console.c"": ""@@ -0,0 +1,133 @@\n+#include \""android/async-console.h\""\n+#include <string.h>\n+\n+/*\n+ * State diagram, ommitting the ERROR state\n+ *\n+ *  INITIAL -->--+\n+ *     |        |\n+ *     |     CONNECTING\n+ *     |       |\n+ *     |<-----+\n+ *     v\n+ *  READ_BANNER_1\n+ *     |\n+ *     v\n+ *  READ_BANNER_2\n+ *     |\n+ *     v\n+ *  COMPLETE\n+ */\n+\n+enum {\n+    STATE_INITIAL,\n+    STATE_CONNECTING,\n+    STATE_ERROR,\n+    STATE_READ_BANNER_1,\n+    STATE_READ_BANNER_2,\n+    STATE_COMPLETE\n+};\n+\n+/* A helper function to prepare the line reader and switch to a new state */\n+static AsyncStatus\n+_acc_prepareLineReader(AsyncConsoleConnector* acc, LoopIo* io, int newState)\n+{\n+    acc->state = newState;\n+    asyncLineReader_init(acc->lreader, acc->lbuff, sizeof(acc->lbuff), io);\n+    return ASYNC_NEED_MORE;\n+}\n+\n+AsyncStatus\n+asyncConsoleConnector_connect(AsyncConsoleConnector* acc,\n+                              const SockAddress*     address,\n+                              LoopIo*                io)\n+{\n+    acc->state = STATE_INITIAL;\n+    acc->address = address[0];\n+    return asyncConsoleConnector_run(acc, io, 0);\n+}\n+\n+\n+AsyncStatus\n+asyncConsoleConnector_run(AsyncConsoleConnector* acc,\n+                          LoopIo*                io,\n+                          unsigned               events)\n+{\n+    AsyncStatus  status = ASYNC_NEED_MORE;\n+\n+    for (;;) {\n+        switch (acc->state)\n+        {\n+        case STATE_ERROR: /* reporting previous error */\n+            errno = acc->error;\n+            return ASYNC_ERROR;\n+\n+        case STATE_INITIAL: /* initial connection attempt */\n+            acc->state = STATE_CONNECTING;\n+            status = asyncConnector_init(acc->connector, &acc->address, io);\n+            if (status == ASYNC_ERROR)\n+                goto SET_ERROR;\n+\n+            if (status == ASYNC_COMPLETE) { /* immediate connection */\n+                _acc_prepareLineReader(acc, io, STATE_READ_BANNER_1);\n+                continue;\n+            }\n+            break;\n+\n+        case STATE_CONNECTING: /* still trying to connect */\n+            status = asyncConnector_run(acc->connector, io, events);\n+            if (status == ASYNC_ERROR)\n+                goto SET_ERROR;\n+\n+            if (status == ASYNC_COMPLETE) {\n+                _acc_prepareLineReader(acc, io, STATE_READ_BANNER_1);\n+                continue;\n+            }\n+            break;\n+\n+        case STATE_READ_BANNER_1: /* reading the first banner line */\n+            status = asyncLineReader_read(acc->lreader, io, events);\n+            if (status == ASYNC_ERROR)\n+                goto SET_ERROR;\n+\n+            if (status == ASYNC_COMPLETE) {\n+                /* Check that first line starts with \""Android Console:\"",\n+                 * otherwise we're not talking to the right program. */\n+                const char* line = asyncLineReader_getLine(acc->lreader);\n+                if (line == NULL || memcmp(line, \""Android Console:\"", 16)) {\n+                    goto BAD_BANNER;\n+                }\n+                /* ok, fine, prepare for the next banner line then */\n+                _acc_prepareLineReader(acc, io, STATE_READ_BANNER_2);\n+                continue;\n+            }\n+            break;\n+\n+        case STATE_READ_BANNER_2: /* reading the second banner line */\n+            status = asyncLineReader_read(acc->lreader, io, events);\n+            if (status == ASYNC_ERROR)\n+                goto SET_ERROR;\n+\n+            if (status == ASYNC_COMPLETE) {\n+                const char* line = asyncLineReader_getLine(acc->lreader);\n+                if (line == NULL) {\n+                    goto BAD_BANNER;\n+                }\n+                /* ok, we're done !*/\n+                acc->state = STATE_COMPLETE;\n+                return ASYNC_COMPLETE;\n+            }\n+            break;\n+\n+        case STATE_COMPLETE:\n+            status = ASYNC_COMPLETE;\n+        }\n+        return status;\n+    }\n+BAD_BANNER:\n+    errno = ENOPROTOOPT;\n+SET_ERROR:\n+    acc->state = STATE_ERROR;\n+    acc->error = errno;\n+    return ASYNC_ERROR;\n+}\n"", ""async-console.h"": ""@@ -0,0 +1,49 @@\n+#ifndef ANDROID_ASYNC_CONSOLE_H\n+#define ANDROID_ASYNC_CONSOLE_H\n+\n+#include \""android/async-utils.h\""\n+\n+/* An AsyncConsoleConnector allows you to asynchronously connect to an\n+ * Android console port.\n+ */\n+typedef struct {\n+    int              state;\n+    int              error;\n+    LoopIo*          io;\n+    SockAddress      address;\n+    AsyncConnector   connector[1];\n+    AsyncLineReader  lreader[1];\n+    uint8_t          lbuff[128];\n+} AsyncConsoleConnector;\n+\n+/* Initialize the console connector. This attempts to connect to the address\n+ * provided through 'io'. Use asyncConsoleConnect_run() after that.\n+ */\n+AsyncStatus\n+asyncConsoleConnector_connect(AsyncConsoleConnector* acc,\n+                              const SockAddress*     address,\n+                              LoopIo*                io);\n+\n+/* Asynchronous console connection management. Returns:\n+ *\n+ * ASYNC_COMPLETE:\n+ *    Connection was complete, and the console banner was properly read/eaten.\n+ *    you can now send/write commands through the console with 'io'.\n+ *\n+ * ASYNC_ERROR:\n+ *    An error occured, either during the connection itself, or when\n+ *    reading the content. This sets errno to ENOPROTOOPT if the connector\n+ *    detects that you're not connected to a proper Android emulator console\n+ *    port (i.e. if the banner was incorrect). Other errors are possible\n+ *    (e.g. in case of early connection termination).\n+ *\n+ * ASYNC_NEED_MORE:\n+ *     Not enough data was exchanged, call this function later.\n+ */\n+AsyncStatus\n+asyncConsoleConnector_run(AsyncConsoleConnector* acc,\n+                          LoopIo*                io,\n+                          unsigned               events);\n+\n+\n+#endif /* ANDROID_ASYNC_CONSOLE_H */\n"", ""async-utils.c"": ""@@ -0,0 +1,268 @@\n+#include \""android/async-utils.h\""\n+#include \""unistd.h\""\n+\n+void\n+asyncReader_init(AsyncReader* ar,\n+                 void*        buffer,\n+                 size_t       buffsize,\n+                 LoopIo*      io)\n+{\n+    ar->buffer   = buffer;\n+    ar->buffsize = buffsize;\n+    ar->pos      = 0;\n+    if (buffsize > 0)\n+        loopIo_wantRead(io);\n+}\n+\n+AsyncStatus\n+asyncReader_read(AsyncReader*  ar,\n+                 LoopIo*       io,\n+                 unsigned      events)\n+{\n+    int  ret;\n+\n+    if (ar->pos >= ar->buffsize) {\n+        return ASYNC_COMPLETE;\n+    }\n+\n+    if ((events & LOOP_IO_READ) == 0)\n+        return ASYNC_NEED_MORE;\n+\n+    do {\n+        ret = read(io->fd, ar->buffer + ar->pos, ar->buffsize - ar->pos);\n+        if (ret == 0) {\n+            /* disconnection ! */\n+            errno = ECONNRESET;\n+            return ASYNC_ERROR;\n+        }\n+        if (ret < 0) {\n+            if (errno == EINTR) /* loop on EINTR */\n+                continue;\n+            if (errno == EWOULDBLOCK || errno == EAGAIN) {\n+                loopIo_wantRead(io);\n+                return ASYNC_NEED_MORE;\n+            }\n+            return ASYNC_ERROR;\n+        }\n+        ar->pos += ret;\n+\n+    } while (ar->pos < ar->buffsize);\n+\n+    loopIo_dontWantRead(io);\n+    return ASYNC_COMPLETE;\n+}\n+\n+void\n+asyncWriter_init(AsyncWriter*  aw,\n+                 const void*   buffer,\n+                 size_t        buffsize,\n+                 LoopIo*       io)\n+{\n+    aw->buffer   = buffer;\n+    aw->buffsize = buffsize;\n+    aw->pos      = 0;\n+    if (buffsize > 0)\n+        loopIo_wantWrite(io);\n+}\n+\n+AsyncStatus\n+asyncWriter_write(AsyncWriter* aw,\n+                  LoopIo*      io,\n+                  unsigned     events)\n+{\n+    int  ret;\n+\n+    if (aw->pos >= aw->buffsize) {\n+        return ASYNC_COMPLETE;\n+    }\n+\n+    if ((events & LOOP_IO_WRITE) == 0)\n+        return ASYNC_NEED_MORE;\n+\n+    do {\n+        ret = write(io->fd, aw->buffer + aw->pos, aw->buffsize - aw->pos);\n+        if (ret == 0) {\n+            /* disconnection ! */\n+            errno = ECONNRESET;\n+            return ASYNC_ERROR;\n+        }\n+        if (ret < 0) {\n+            if (errno == EINTR) /* loop on EINTR */\n+                continue;\n+            if (errno == EWOULDBLOCK || errno == EAGAIN) {\n+                return ASYNC_NEED_MORE;\n+            }\n+            return ASYNC_ERROR;\n+        }\n+        aw->pos += ret;\n+\n+    } while (aw->pos < aw->buffsize);\n+\n+    loopIo_dontWantWrite(io);\n+    return ASYNC_COMPLETE;\n+}\n+\n+\n+void\n+asyncLineReader_init(AsyncLineReader* alr,\n+                     void*            buffer,\n+                     size_t           buffsize,\n+                     LoopIo*          io)\n+{\n+    alr->buffer   = buffer;\n+    alr->buffsize = buffsize;\n+    alr->pos      = 0;\n+    if (buffsize > 0)\n+        loopIo_wantRead(io);\n+}\n+\n+AsyncStatus\n+asyncLineReader_read(AsyncLineReader* alr,\n+                     LoopIo*          io,\n+                     unsigned         events)\n+{\n+    int  ret;\n+\n+    if (alr->pos >= alr->buffsize) {\n+        errno = ENOMEM;\n+        return ASYNC_ERROR;\n+    }\n+\n+    /* only when read events are available */\n+    if ((events & LOOP_IO_READ) == 0)\n+        return ASYNC_NEED_MORE;\n+\n+    do {\n+        char ch;\n+        ret = read(io->fd, &ch, 1);\n+        if (ret == 0) {\n+            /* disconnection ! */\n+            errno = ECONNRESET;\n+            return ASYNC_ERROR;\n+        }\n+        if (ret < 0) {\n+            if (errno == EINTR) /* loop on EINTR */\n+                continue;\n+            if (errno == EWOULDBLOCK || errno == EAGAIN) {\n+                loopIo_wantRead(io);\n+                return ASYNC_NEED_MORE;\n+            }\n+            return ASYNC_ERROR;\n+        }\n+        alr->buffer[alr->pos++] = (uint8_t)ch;\n+        if (ch == '\\n') {\n+            loopIo_dontWantRead(io);\n+            return ASYNC_COMPLETE;\n+        }\n+    } while (alr->pos < alr->buffsize);\n+\n+    /* Not enough room in the input buffer!*/\n+    loopIo_dontWantRead(io);\n+    errno = ENOMEM;\n+    return ASYNC_ERROR;\n+}\n+\n+const char*\n+asyncLineReader_getLineRaw(AsyncLineReader* alr, int *pLength)\n+{\n+    if (alr->pos == 0 || alr->pos > alr->buffsize)\n+        return NULL;\n+\n+    if (pLength != 0)\n+        *pLength = alr->pos;\n+\n+    return (const char*) alr->buffer;\n+}\n+\n+const char*\n+asyncLineReader_getLine(AsyncLineReader* alr)\n+{\n+    /* Strip trailing \\n if any */\n+    size_t  pos = alr->pos;\n+    char*   buffer = (char*) alr->buffer;\n+\n+    if (pos == 0 || pos > alr->buffsize)\n+        return NULL;\n+\n+    pos--;\n+\n+    /* Check that we have a proper terminator, and replace it with 0 */\n+    if (buffer[pos] != '\\n')\n+        return NULL;\n+\n+    buffer[pos] = '\\0';\n+\n+    /* Also strip \\r\\n */\n+    if (pos > 0 && buffer[--pos] == '\\r') {\n+        buffer[pos] = '\\0';\n+    }\n+\n+    return (const char*) buffer;\n+}\n+\n+\n+enum {\n+    CONNECT_ERROR = 0,\n+    CONNECT_CONNECTING,\n+    CONNECT_COMPLETED\n+};\n+\n+AsyncStatus\n+asyncConnector_init(AsyncConnector*    ac,\n+                    const SockAddress* address,\n+                    LoopIo*            io)\n+{\n+    int ret;\n+    ac->error = 0;\n+    ret = socket_connect(io->fd, address);\n+    if (ret == 0) {\n+        ac->state = CONNECT_COMPLETED;\n+        return ASYNC_COMPLETE;\n+    }\n+    if (errno == EINPROGRESS || errno == EWOULDBLOCK || errno == EAGAIN) {\n+        ac->state = CONNECT_CONNECTING;\n+        /* The socket will be marked writable for select() when the\n+         * connection is established, or when it is definitely\n+         * refused / timed-out, for any reason. */\n+        loopIo_wantWrite(io);\n+        return ASYNC_NEED_MORE;\n+    }\n+    ac->error = errno;\n+    ac->state = CONNECT_ERROR;\n+    return ASYNC_ERROR;\n+}\n+\n+AsyncStatus\n+asyncConnector_run(AsyncConnector* ac, LoopIo* io, unsigned events)\n+{\n+    switch (ac->state) {\n+    case CONNECT_ERROR:\n+        errno = ac->error;\n+        return ASYNC_ERROR;\n+\n+    case CONNECT_CONNECTING:\n+        loopIo_dontWantWrite(io);\n+        if ((events & LOOP_IO_WRITE) != 0) {\n+            /* We need to read the socket error to determine if\n+             * the connection was really succesful or not. This\n+             * is optional, because in case of error a future\n+             * read() or write() will fail anyway, but this\n+             * allows us to get a better error value as soon as\n+             * possible.\n+             */\n+            ac->error = socket_get_error(io->fd);\n+            if (ac->error == 0) {\n+                ac->state = CONNECT_COMPLETED;\n+                return ASYNC_COMPLETE;\n+            }\n+            ac->state = CONNECT_ERROR;\n+            errno = ac->error;\n+            return ASYNC_ERROR;\n+        }\n+        break;\n+\n+    default:\n+        return ASYNC_COMPLETE;\n+    }\n+    return ASYNC_NEED_MORE;\n+}\n"", ""async-utils.h"": ""@@ -0,0 +1,175 @@\n+#ifndef ANDROID_ASYNC_UTILS_H\n+#define ANDROID_ASYNC_UTILS_H\n+\n+#include \""android/looper.h\""\n+#include \""sockets.h\""\n+\n+/* A set of useful data types to perform asynchronous operations.\n+ *\n+ * IMPORTANT NOTE:\n+ *    In case of network disconnection, read() and write() just return 0\n+ *    the first time they are called. As a convenience, these functions\n+ *    will return ASYNC_ERROR and set 'errno' to ECONNRESET instead.\n+ */\n+typedef enum {\n+    ASYNC_COMPLETE = 0,   /* asynchronous operation completed */\n+    ASYNC_ERROR,          /* an error occurred, look at errno */\n+    ASYNC_NEED_MORE       /* more data is needed, try again later */\n+} AsyncStatus;\n+\n+/* An AsyncReader makes it easier to read a given number of bytes into\n+ * a target buffer asynchronously. Usage is the following:\n+ *\n+ * 1/ setup the reader with asyncReader_init(ar, buffer, buffsize,io);\n+ * 2/ call asyncReader_read(ar, io), where 'io' is a LoopIo whenever\n+ *    you can receive data, i.e. just after the init() or in your\n+ *    own callback.\n+ */\n+typedef struct {\n+    uint8_t*  buffer;\n+    size_t    buffsize;\n+    size_t    pos;\n+} AsyncReader;\n+\n+/* Setup an ASyncReader, by giving the address of the read buffer,\n+ * and the number of bytes we want to read.\n+ *\n+ * This also calls loopIo_wantRead(io) for you.\n+ */\n+void asyncReader_init(AsyncReader* ar,\n+                      void*        buffer,\n+                      size_t       buffsize,\n+                      LoopIo*      io);\n+\n+/* Try to read data from 'io' and return the state of the read operation.\n+ *\n+ * Returns:\n+ *    ASYNC_COMPLETE: If the read operation was complete. This will also\n+ *                    call loopIo_dontWantRead(io) for you.\n+ *\n+ *    ASYNC_ERROR: If an error occured (see errno). The error will be\n+ *                 ECONNRESET in case of disconnection.\n+ *\n+ *    ASYNC_NEED_MORE: If there was not enough incoming data to complete\n+ *                     the read (or if 'events' doesn't contain LOOP_IO_READ).\n+ */\n+AsyncStatus  asyncReader_read(AsyncReader*  ar,\n+                              LoopIo*       io,\n+                              unsigned      events);\n+\n+/* An AsyncWriter is the counterpart of an AsyncReader, but for writing\n+ * data to a file descriptor asynchronously.\n+ */\n+typedef struct {\n+    const uint8_t* buffer;\n+    size_t         buffsize;\n+    size_t         pos;\n+} AsyncWriter;\n+\n+/* Setup an ASyncReader, by giving the address of the read buffer,\n+ * and the number of bytes we want to read.\n+ *\n+ * This also calls loopIo_wantWrite(io) for you.\n+ */\n+void asyncWriter_init(AsyncWriter*  aw,\n+                      const void*   buffer,\n+                      size_t        buffsize,\n+                      LoopIo*       io);\n+\n+/* Try to write data to 'io' and return the state of the write operation.\n+ *\n+ * Returns:\n+ *    ASYNC_COMPLETE: If the write operation was complete. This will also\n+ *                    call loopIo_dontWantWrite(io) for you.\n+ *\n+ *    ASYNC_ERROR: If an error occured (see errno). The error will be\n+ *                 ECONNRESET in case of disconnection.\n+ *\n+ *    ASYNC_NEED_MORE: If not all bytes could be sent yet (or if 'events'\n+ *                     doesn't contain LOOP_IO_READ).\n+ */\n+AsyncStatus asyncWriter_write(AsyncWriter* aw,\n+                              LoopIo*      io,\n+                              unsigned     events);\n+\n+\n+/* An AsyncLineReader allows you to read one line of text asynchronously.\n+ * The biggest difference with AsyncReader is that you don't know the line\n+ * size in advance, so the object will read data byte-by-byte until it\n+ * encounters a '\\n'.\n+ */\n+typedef struct {\n+    uint8_t*  buffer;\n+    size_t    buffsize;\n+    size_t    pos;\n+} AsyncLineReader;\n+\n+/* Setup an AsyncLineReader to read at most 'buffsize' characters (bytes)\n+ * into 'buffer'. The reader will stop when it finds a '\\n' which will be\n+ * part of the buffer by default.\n+ *\n+ * NOTE: buffsize must be > 0. If not, asyncLineReader_getLine will return\n+ *       ASYNC_ERROR with errno == ENOMEM.\n+ *\n+ *        buffsize must also sufficiently big to hold the final '\\n'.\n+ *\n+ * Also calls loopIo_wantRead(io) for you.\n+ */\n+void asyncLineReader_init(AsyncLineReader* alr,\n+                          void*            buffer,\n+                          size_t           buffsize,\n+                          LoopIo*          io);\n+\n+/* Try to read line characters from 'io'.\n+ * Returns:\n+ *    ASYNC_COMPLETE: An end-of-line was detected, call asyncLineReader_getLine\n+ *                    to extract the line content.\n+ *\n+ *    ASYNC_ERROR: An error occured. Note that in case of disconnection,\n+ *                 errno will be set to ECONNRESET, but you should be able\n+ *                 to call asyncLineReader_getLine to read the partial line\n+ *                 that was read.\n+ *\n+ *                 In case of overflow, errno will be set to ENOMEM.\n+ *\n+ *    ASYNC_NEED_MORE: If there was not enough incoming data (or events\n+ *                     does not contain LOOP_IO_READ).\n+ */\n+AsyncStatus asyncLineReader_read(AsyncLineReader* alr,\n+                                 LoopIo*          io,\n+                                 unsigned         events);\n+\n+/* Return a pointer to the NON-ZERO-TERMINATED line characters, if any.\n+ * If 'pLength\"" is not NULL, the function sets '*pLength' to the length\n+ * in bytes of the line.\n+ *\n+ * Returns:\n+ *    NULL if 'buffsize' was initially 0, otherwise, a pointer to 'buffer'\n+ *    as passed in asyncLineReader_setup().\n+ *\n+ *    NOTE: The data is *not* zero terminated, but its last character\n+ *           should be '\\n' unless an error occured.\n+ */\n+const char* asyncLineReader_getLineRaw(AsyncLineReader* alr, int *pLength);\n+\n+/* Return a pointer to the ZERO-TERMINATED line, with final '\\n' or '\\r\\n'\n+ * stripped. This will be NULL in case of error though.\n+ */\n+const char* asyncLineReader_getLine(AsyncLineReader* alr);\n+\n+/* Asynchronous connection to a socket\n+ */\n+typedef struct {\n+    int  error;\n+    int  state;\n+} AsyncConnector;\n+\n+AsyncStatus\n+asyncConnector_init(AsyncConnector*    ac,\n+                    const SockAddress* address,\n+                    LoopIo*            io);\n+\n+AsyncStatus\n+asyncConnector_run(AsyncConnector* ac, LoopIo* io, unsigned events);\n+\n+#endif /* ANDROID_ASYNC_UTILS_H */\n""}","feature, refactor 
"
13053,Mike Lockwood,"adb: fix -d and -e options for ""adb forward"" command.",['adb/commandline.c'],"adb: fix -d and -e options for ""adb forward"" command.

Change-Id: I9166572a1c398ce5ef1423d19a30895385118ee5
Signed-off-by: Mike Lockwood <lockwood@android.com>",https://android-review.googlesource.com/c/13053,"bug 
",bug,Bug;,"{""commandline.c"": ""@@ -990,9 +990,13 @@ top:\n     if(!strcmp(argv[0], \""forward\"")) {\n         if(argc != 3) return usage();\n         if (serial) {\n-            snprintf(buf, sizeof buf, \""host-serial:%s:forward:%s;%s\"",serial,argv[1],argv[2]);\n+            snprintf(buf, sizeof buf, \""host-serial:%s:forward:%s;%s\"",serial, argv[1], argv[2]);\n+        } else if (ttype == kTransportUsb) {\n+            snprintf(buf, sizeof buf, \""host-usb:forward:%s;%s\"", argv[1], argv[2]);\n+        } else if (ttype == kTransportLocal) {\n+            snprintf(buf, sizeof buf, \""host-local:forward:%s;%s\"", argv[1], argv[2]);\n         } else {\n-            snprintf(buf, sizeof buf, \""host:forward:%s;%s\"",argv[1],argv[2]);\n+            snprintf(buf, sizeof buf, \""host:forward:%s;%s\"", argv[1], argv[2]);\n         }\n         if(adb_command(buf)) {\n             fprintf(stderr,\""error: %s\\n\"", adb_error());\n""}","feature 
"
18560,RaphaÃ«l Moll,SDK Windows: Package customized proguard.bat scripts.,"['build/tools/make_windows_sdk.sh', 'build/tools/patch_windows_sdk.sh']","SDK Windows: Package customized proguard.bat scripts.

Requires Change: Ic1dc74cb3ff4dec9b419e2753290c361dffce48e
in platform/sdk.

Change-Id: Ieb2e308c0e9e655b2c047554563d753ac4cbb852",https://android-review.googlesource.com/c/18560,"resource
",resource,Others;,"{""make_windows_sdk.sh"": ""@@ -172,7 +172,6 @@ function package() {\n     cp -v prebuilt/windows/swt/swt.jar         \""$LIB\""/x86/\n     mkdir -pv \""$LIB\""/x86_64\n     cp -v prebuilt/windows-x86_64/swt/swt.jar  \""$LIB\""/x86_64/\n-    cp -v external/proguard/bin/*.bat          \""$TOOLS\""/proguard/bin/\n \n     # Copy the SDK Manager (aka sdklauncher) to the root of the SDK (it was copied in tools above)\n     # and move it also in SDK/tools/lib (so that tools updates can update the root one too)\n@@ -196,6 +195,7 @@ function package() {\n     cp -v sdk/draw9patch/etc/draw9patch.bat                \""$TOOLS\""/\n     cp -v sdk/sdkmanager/app/etc/android.bat               \""$TOOLS\""/\n     cp -v sdk/monkeyrunner/etc/monkeyrunner.bat            \""$TOOLS\""/\n+    cp -v sdk/files/proguard/bin/*.bat                     \""$TOOLS\""/proguard/bin/\n \n     # Put the JetCreator tools, content and docs (not available in the linux SDK)\n     JET=\""$TOOLS/Jet\""\n"", ""patch_windows_sdk.sh"": ""@@ -38,7 +38,6 @@ mkdir -pv $LIB/x86\n cp $V ${TOPDIR}prebuilt/windows/swt/swt.jar         $LIB/x86/\n mkdir -pv $LIB/x86_64\n cp $V ${TOPDIR}prebuilt/windows-x86_64/swt/swt.jar  $LIB/x86_64/\n-cp $V ${TOPDIR}external/proguard/bin/*.bat          $TOOLS/proguard/bin/\n \n # Copy the SDK Manager (aka sdklauncher) to the root of the SDK (it was copied in tools above)\n # and move it also in SDK/tools/lib (so that tools updates can update the root one too)\n@@ -62,6 +61,7 @@ cp $V ${TOPDIR}sdk/layoutopt/app/etc/layoutopt.bat              $TOOLS/\n cp $V ${TOPDIR}sdk/draw9patch/etc/draw9patch.bat                $TOOLS/\n cp $V ${TOPDIR}sdk/sdkmanager/app/etc/android.bat               $TOOLS/\n cp $V ${TOPDIR}sdk/monkeyrunner/etc/monkeyrunner.bat            $TOOLS/\n+cp $V ${TOPDIR}sdk/files/proguard/bin/*.bat                     $TOOLS/proguard/bin/\n \n # Put the JetCreator tools, content and docs (not available in the linux SDK)\n JET=$TOOLS/Jet\n""}","refactor 
"
20865,Keiji Ariyama,"Line Wrapping General settings Set ""Never join already wrapped lines"" to true.",['ide/eclipse/android-formatting.xml'],"Line Wrapping General settings
Set ""Never join already wrapped lines"" to true.

Change-Id: Ia7d3f3efd1b5cf4715c4738db1e56e2512ef4d27",https://android-review.googlesource.com/c/20865,"**resource** 
",resource,Resource;,"{""android-formatting.xml"": ""@@ -247,5 +247,6 @@\n <setting id=\""org.eclipse.jdt.core.formatter.tabulation.char\"" value=\""space\""/>\n <setting id=\""org.eclipse.jdt.core.formatter.tabulation.size\"" value=\""4\""/>\n <setting id=\""org.eclipse.jdt.core.formatter.use_tabs_only_for_leading_indentations\"" value=\""false\""/>\n+<setting id=\""org.eclipse.jdt.core.formatter.join_wrapped_lines\"" value=\""false\""/>\n </profile>\n </profiles>\n""}","bug, refactor 
"
